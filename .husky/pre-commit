#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Run linter
echo "ğŸ“‹ Linting code..."
npm run lint --quiet
if [ $? -ne 0 ]; then
  echo "âŒ ESLint failed. Please fix errors before committing."
  exit 1
fi

# Run type check
echo "ğŸ”· Type checking..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found. Please fix before committing."
  exit 1
fi

# Check for HTML nesting violations (from hydration fixes)
echo "ğŸ” Checking for HTML nesting violations..."
if grep -rn "<p[^>]*>.*<div" src/ 2>/dev/null; then
  echo "âŒ Error: Found <div> inside <p> tags (causes hydration errors)"
  echo "See HYDRATION_FIX_QUICK_GUIDE.md for fixes"
  exit 1
fi

# Check for unqualified table names (schema compliance)
echo "ğŸ—„ï¸ Checking database schema compliance..."
if grep -rn "FROM suppliers[^_]" src/app/api/ 2>/dev/null || \
   grep -rn "FROM inventory_items" src/app/api/ 2>/dev/null; then
  echo "âŒ Error: Found unqualified table names. Use 'core.supplier' instead of 'suppliers'"
  exit 1
fi

# Optional: Git MCP validation placeholder
if command -v npx > /dev/null 2>&1; then
  echo "ğŸ“ (Optional) Validate commit with Git MCP..."
  # npx git-mcp validate || true
fi

echo "âœ… Pre-commit checks passed!"
exit 0

