ExtractionWorker - Data Flow Diagram

FILE UPLOAD
    |
    v
[Check Cache] --yes--> CACHED RESULT
    |
   no
    |
    v
[Load File from Storage]
    |
    v
[Parse by Type]
    |
    +---> CSV ---> [Auto-Detect Delimiter]
    |               - Read first 1KB
    |               - Count: , ; TAB
    |               - Pick winner
    |
    +---> XLSX/XLS ---> [Read workbook]
    |
    +---> JSON ---> [Parse JSON]
    |
    v
[Raw Data Rows]
    |
    v
[Detect Header Row]
    - Scan first 80 rows
    - Look for SKU + (Description OR Price)
    |
    v
[Build Column Map]
    For each header:
    1. Normalize (lowercase, remove special chars)
    2. Match against aliases
    3. Map to standard field
    
    Example:
    "Stock Code"     -> sku
    "Product Name"   -> description
    "Unit Price"     -> price
    "Price Incl VAT" -> priceIncVat
    "Brand"          -> brand
    |
    v
[Extract Products] (Chunked Processing)
    For each row:
    1. Map columns using column map
    2. Parse numbers
    3. Sanitize text
    4. Apply business logic
    
    Special handling:
    - priceIncVat -> price = value / 1.15
    - priceExVat  -> price = value
    - dealer/retail -> price = value
    - stock/qty   -> pack_size = value
    |
    v
[Validate Products]
    Required:
    - SKU (supplier_sku)
    - Name
    - Price > 0
    - UOM (default EA)
    
    Warnings:
    - Missing brand
    - Missing category
    - Duplicate SKUs
    
    Database Check:
    - Query existing products
    - Mark as new/existing
    |
    v
[Calculate Stats]
    - Total rows
    - Valid products
    - Products with warnings
    - Invalid products
    - New vs existing
    - Duplicates
    - Processing time
    |
    v
[Cache Result]
    - Store in memory
    - 24hr expiration
    - Update database reference
    |
    v
RESULT
    - products[]
    - stats{}
    - warnings[]
    - errors[]

PROGRESS EVENTS:
  0% - Start
  5% - Loading file metadata
 10% - Reading file content
 20% - Parsing file
       "Auto-detected CSV delimiter: ,"
 30% - Extracting products
       "Auto-detected 8 columns: sku='Stock Code', ..."
 50% - Processed 500/1000 rows
 70% - Processed 1000/1000 rows
 85% - Validating products
 95% - Caching results
100% - Extraction completed

COLUMN DETECTION LOGIC:

Input Header: "Stock Code"
    |
    v
Normalize: "stockcode"
    |
    v
Match Aliases:
    sku: ['sku', 'stockcode', 'itemcode', ...]
    Match found: 'stockcode'
    |
    v
Add to Map:
    { field: 'sku', index: 0, header: 'Stock Code' }

REAL-WORLD EXAMPLES:

Example 1: Standard Pricelist
Stock Code | Product Name | Unit Price | Brand
ABC123     | Widget Pro   | 99.99      | ACME
DEF456     | Gadget Elite | 149.99     | TechCo

Detected columns:
- Stock Code -> sku
- Product Name -> description
- Unit Price -> price
- Brand -> brand

Example 2: Inc-VAT Pricing
SKU    | Description | Price Incl. VAT
ABC123 | Widget Pro  | 114.99

Detected columns:
- SKU -> sku
- Description -> description
- Price Incl. VAT -> priceIncVat

Processing:
- price = 114.99 / 1.15 = 99.99

Example 3: Excel with Metadata
Row 1: Supplier Pricelist - January 2025
Row 2: [blank]
Row 3: Item Code | Product | Cost Price | Manufacturer  <-- HEADER DETECTED
Row 4: ABC123    | Widget  | 99.99      | ACME
Row 5: DEF456    | Gadget  | 149.99     | TechCo

Example 4: Tab-Separated
Stock Code[TAB]Description[TAB]Retail
ABC123[TAB]Widget Pro[TAB]99.99

Auto-detected delimiter: TAB

ERROR HANDLING:

Invalid Row (missing SKU and price):
[blank] | Widget Pro | [blank]
    -> SKIPPED (missing required fields)

Duplicate SKUs:
ABC123 | Widget Pro   | 99.99   (Row 10)
ABC123 | Widget Elite | 149.99  (Row 15)
    -> Both included with validation warning
    -> Warning: "Duplicate SKU found in rows: 10, 15"

File Too Large:
150MB file
    -> Error: FILE_TOO_LARGE (Max: 100MB)

Column Aliases Reference:

SKU: sku, stockcode, itemcode, productcode, productid, 
     part, partno, itemno, model, catalog, catalogue, material

Description: description, product, itemdescription, 
             longdescription, details, desc, name

Brand: brand, manufacturer, manuf, suppliername, vendor, make

Price: dealer, costprice, nett, netprice, buy, purchase, wholesale,
       unitcost, baseprice, import, landed, selling, retail, rrp,
       listprice, unitprice, sellprice, priceincl, priceinc, price, cost

Price Ex-VAT: priceex, exvat, exclusive, priceexc, excl

Price Inc-VAT: priceinc, inclvat, inclusive, grossprice, incl

Stock: quantity, qty, stockqty, stockonhand, qtyavailable,
       qtyavail, available, balance, stock

UOM: uom, unit, unitofmeasure, packsize

Barcode: barcode, ean, upc, gtin
