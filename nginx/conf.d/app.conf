# Production application configuration
server {
    listen 80;
    server_name _;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ${DOMAIN_NAME};

    # SSL Certificate configuration
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_dhparam /etc/nginx/ssl/dhparam.pem;

    # Security and performance
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Rate limiting
    limit_req zone=general burst=20 nodelay;
    limit_conn addr 10;

    # Root directory for static files
    root /var/www;

    # File upload handling
    location /uploads {
        alias /var/www/uploads;

        # Security for uploads
        location ~* \.(php|jsp|asp|sh|pl|py|exe|bat)$ {
            deny all;
        }

        # Cache control for uploads
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;

        # Rate limiting for uploads
        limit_req zone=uploads burst=5 nodelay;
    }

    # API routes with enhanced security
    location /api/ {
        # Rate limiting for API
        limit_req zone=api burst=20 nodelay;

        # Authentication endpoints
        location /api/auth/ {
            limit_req zone=login burst=5 nodelay;
            proxy_pass http://app_backend;
            include /etc/nginx/conf.d/proxy.conf;
        }

        # File upload endpoints
        location /api/upload {
            limit_req zone=uploads burst=3 nodelay;
            client_max_body_size 10M;
            proxy_pass http://app_backend;
            include /etc/nginx/conf.d/proxy.conf;
        }

        # General API endpoints
        proxy_pass http://app_backend;
        include /etc/nginx/conf.d/proxy.conf;
    }

    # Next.js static files
    location /_next/static/ {
        alias /var/www/_next/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Static assets
    location /static/ {
        alias /var/www/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Favicon and robots.txt
    location = /favicon.ico {
        access_log off;
        log_not_found off;
        expires 1y;
    }

    location = /robots.txt {
        access_log off;
        log_not_found off;
        expires 1d;
    }

    # Security.txt
    location = /.well-known/security.txt {
        alias /var/www/security.txt;
        add_header Content-Type text/plain;
    }

    # Health check (internal only)
    location /health {
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        allow 172.20.0.0/16;
        deny all;

        proxy_pass http://app_backend/api/health;
        include /etc/nginx/conf.d/proxy.conf;
    }

    # Monitoring endpoints (restricted)
    location /metrics {
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        allow 172.20.0.0/16;
        deny all;

        proxy_pass http://app_backend/api/metrics;
        include /etc/nginx/conf.d/proxy.conf;
    }

    # All other requests to Next.js app
    location / {
        # Security headers for pages
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;

        proxy_pass http://app_backend;
        include /etc/nginx/conf.d/proxy.conf;
    }

    # Block common exploits
    location ~* /(wp-admin|wp-login|admin|administrator|phpmyadmin) {
        deny all;
        access_log off;
        log_not_found off;
        return 444;
    }

    # Block file extensions
    location ~* \.(env|log|sql|bak|old|tmp|config)$ {
        deny all;
        access_log off;
        log_not_found off;
        return 444;
    }

    # Block hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
        return 444;
    }
}