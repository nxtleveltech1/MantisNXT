[{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\api\\suppliers\\pricelists\\promote\\route.deprecated.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":256,"column":42,"nodeType":"TemplateLiteral","endLine":265,"endColumn":14},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":303,"column":34,"nodeType":"TemplateLiteral","endLine":316,"endColumn":12}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { query, withTransaction } from '@/lib/database'\r\nimport { z } from 'zod'\r\n\r\n/**\r\n * ⚠️ DEPRECATED ENDPOINT ⚠️\r\n *\r\n * This endpoint is deprecated and will be removed in a future version.\r\n * Please use the NXT-SPP workflow instead:\r\n *\r\n * 1. Upload: POST /api/spp/upload\r\n * 2. Validate: POST /api/spp/validate?upload_id={id}\r\n * 3. Merge: POST /api/spp/merge?upload_id={id}\r\n * 4. Select: POST /api/core/selections/workflow\r\n *\r\n * Migration Guide: See docs/NXT-SPP-MIGRATION.md\r\n *\r\n * Backward compatibility maintained until Q2 2025\r\n */\r\n\r\nconst DEPRECATION_MESSAGE = `\r\n⚠️ DEPRECATED: This endpoint will be removed in Q2 2025.\r\nPlease migrate to the NXT-SPP workflow:\r\n- POST /api/spp/upload (upload pricelist)\r\n- POST /api/spp/validate?upload_id={id} (validate)\r\n- POST /api/spp/merge?upload_id={id} (merge to CORE)\r\n- POST /api/core/selections/workflow (select products)\r\n\r\nSee: docs/NXT-SPP-MIGRATION.md\r\n`\r\n\r\n// Schema for promoting pricelist items to Product table\r\nconst PromoteItemsSchema = z.object({\r\n  pricelistId: z.string().min(1, 'Pricelist ID is required'),\r\n  supplierId: z.string().min(1, 'Supplier ID is required'),\r\n  itemSelections: z.array(z.object({\r\n    pricelistItemId: z.string().min(1, 'Pricelist item ID is required'),\r\n    sku: z.string().min(1, 'SKU is required'),\r\n    name: z.string().min(1, 'Product name is required'),\r\n    description: z.string().optional(),\r\n    category: z.enum([\r\n      'raw_materials',\r\n      'components',\r\n      'finished_goods',\r\n      'consumables',\r\n      'services',\r\n      'packaging',\r\n      'tools',\r\n      'safety_equipment'\r\n    ]),\r\n    unitPrice: z.number().positive('Unit price must be positive'),\r\n    currency: z.string().default('ZAR'),\r\n    active: z.boolean().default(true),\r\n    overwriteExisting: z.boolean().default(false)\r\n  })).min(1, 'At least one item must be selected')\r\n})\r\n\r\nfunction addDeprecationHeaders(response: NextResponse): NextResponse {\r\n  response.headers.set('X-API-Deprecated', 'true')\r\n  response.headers.set('X-API-Deprecation-Date', '2025-06-01')\r\n  response.headers.set('X-API-Sunset', '2025-06-01')\r\n  response.headers.set('X-API-Migration-Guide', '/docs/NXT-SPP-MIGRATION.md')\r\n  response.headers.set('X-API-Alternative', 'POST /api/spp/upload')\r\n  return response\r\n}\r\n\r\n// GET /api/suppliers/pricelists/promote - Get pricelist items available for promotion\r\nexport async function GET(request: NextRequest) {\r\n  console.warn(DEPRECATION_MESSAGE)\r\n\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const pricelistId = searchParams.get('pricelistId')\r\n    const supplierId = searchParams.get('supplierId')\r\n\r\n    if (!pricelistId || !supplierId) {\r\n      const response = NextResponse.json({\r\n        success: false,\r\n        error: 'Pricelist ID and Supplier ID are required',\r\n        deprecation_notice: DEPRECATION_MESSAGE\r\n      }, { status: 400 })\r\n      return addDeprecationHeaders(response)\r\n    }\r\n\r\n    // In a real implementation, this would query the pricelist and pricelist_items tables\r\n    // For now, I'll create a mock response based on the existing pricelist structure\r\n    const mockPricelistItems = [\r\n      {\r\n        id: 'item_001',\r\n        pricelistId: pricelistId,\r\n        sku: 'ALPHA-PWR-001',\r\n        supplierSku: 'PWR-SUPPLY-500W',\r\n        name: '500W Power Supply Unit',\r\n        description: 'High-efficiency 80+ Gold certified power supply',\r\n        category: 'components',\r\n        unitPrice: 89.99,\r\n        currency: 'ZAR',\r\n        minimumQuantity: 1,\r\n        leadTimeDays: 14,\r\n        inProductTable: false, // Not yet promoted to Product table\r\n        existingProductId: null,\r\n        notes: 'Includes 5-year warranty'\r\n      },\r\n      {\r\n        id: 'item_002',\r\n        pricelistId: pricelistId,\r\n        sku: 'ALPHA-CAB-001',\r\n        supplierSku: 'CAT6-CABLE-100M',\r\n        name: 'CAT6 Network Cable 100m',\r\n        description: 'High-speed ethernet cable for network infrastructure',\r\n        category: 'components',\r\n        unitPrice: 125.50,\r\n        currency: 'ZAR',\r\n        minimumQuantity: 1,\r\n        leadTimeDays: 7,\r\n        inProductTable: false,\r\n        existingProductId: null,\r\n        notes: 'Bulk pricing available'\r\n      },\r\n      {\r\n        id: 'item_003',\r\n        pricelistId: pricelistId,\r\n        sku: 'ALPHA-MON-001',\r\n        supplierSku: 'LED-MONITOR-24',\r\n        name: '24\" LED Monitor',\r\n        description: 'Full HD LED monitor with HDMI and VGA inputs',\r\n        category: 'finished_goods',\r\n        unitPrice: 2450.00,\r\n        currency: 'ZAR',\r\n        minimumQuantity: 1,\r\n        leadTimeDays: 10,\r\n        inProductTable: true, // Already promoted\r\n        existingProductId: 'prod_001',\r\n        notes: 'Popular item - high demand'\r\n      }\r\n    ]\r\n\r\n    // Check which items already exist in the Product table\r\n    const skusToCheck = mockPricelistItems.map(item => item.sku)\r\n    let existingProducts = []\r\n\r\n    if (skusToCheck.length > 0) {\r\n      const existingQuery = `\r\n        SELECT id, sku, name, active\r\n        FROM \"Product\"\r\n        WHERE sku = ANY($1) AND \"supplierId\"::text = $2\r\n      `\r\n      const existingResult = await query(existingQuery, [skusToCheck, supplierId])\r\n      existingProducts = existingResult.rows\r\n    }\r\n\r\n    // Update items with existing product information\r\n    const itemsWithStatus = mockPricelistItems.map(item => {\r\n      const existingProduct = existingProducts.find(p => p.sku === item.sku)\r\n      return {\r\n        ...item,\r\n        inProductTable: !!existingProduct,\r\n        existingProductId: existingProduct?.id || null,\r\n        existingProductActive: existingProduct?.active || false\r\n      }\r\n    })\r\n\r\n    // Calculate summary statistics\r\n    const summary = {\r\n      totalItems: itemsWithStatus.length,\r\n      availableForPromotion: itemsWithStatus.filter(item => !item.inProductTable).length,\r\n      alreadyPromoted: itemsWithStatus.filter(item => item.inProductTable).length,\r\n      totalValue: itemsWithStatus.reduce((sum, item) => sum + item.unitPrice, 0),\r\n      categories: [...new Set(itemsWithStatus.map(item => item.category))],\r\n      averagePrice: itemsWithStatus.length > 0 ?\r\n        itemsWithStatus.reduce((sum, item) => sum + item.unitPrice, 0) / itemsWithStatus.length : 0\r\n    }\r\n\r\n    const response = NextResponse.json({\r\n      success: true,\r\n      data: {\r\n        pricelistId,\r\n        supplierId,\r\n        items: itemsWithStatus,\r\n        summary\r\n      },\r\n      deprecation_notice: DEPRECATION_MESSAGE\r\n    })\r\n\r\n    return addDeprecationHeaders(response)\r\n\r\n  } catch (error) {\r\n    console.error('Error fetching pricelist items for promotion:', error)\r\n    const response = NextResponse.json({\r\n      success: false,\r\n      error: 'Failed to fetch pricelist items',\r\n      details: error instanceof Error ? error.message : 'Unknown error',\r\n      deprecation_notice: DEPRECATION_MESSAGE\r\n    }, { status: 500 })\r\n    return addDeprecationHeaders(response)\r\n  }\r\n}\r\n\r\n// POST /api/suppliers/pricelists/promote - Promote selected items to Product table\r\nexport async function POST(request: NextRequest) {\r\n  console.warn(DEPRECATION_MESSAGE)\r\n\r\n  return await withTransaction(async (client) => {\r\n    const body = await request.json()\r\n    const validatedData = PromoteItemsSchema.parse(body)\r\n\r\n    // within transaction\r\n\r\n    const results = {\r\n      created: 0,\r\n      updated: 0,\r\n      skipped: 0,\r\n      errors: [] as string[]\r\n    }\r\n\r\n    for (const item of validatedData.itemSelections) {\r\n      try {\r\n        // Check if product already exists\r\n        const existingQuery = `\r\n          SELECT id, active FROM \"Product\"\r\n          WHERE sku = $1 AND \"supplierId\"::text = $2\r\n        `\r\n        const existingResult = await client.query(existingQuery, [item.sku, validatedData.supplierId])\r\n\r\n        if (existingResult.rows.length > 0) {\r\n          const existingProduct = existingResult.rows[0]\r\n\r\n          if (item.overwriteExisting) {\r\n            // Update existing product\r\n            const updateQuery = `\r\n              UPDATE \"Product\"\r\n              SET\r\n                name = $1,\r\n                description = $2,\r\n                \"categoryId\" = $3,\r\n                \"basePrice\" = $4,\r\n                currency = $5,\r\n                active = $6,\r\n                \"updatedAt\" = NOW()\r\n              WHERE id = $7\r\n              RETURNING id\r\n            `\r\n            await client.query(updateQuery, [\r\n              item.name,\r\n              item.description,\r\n              item.category,\r\n              item.unitPrice,\r\n              item.currency,\r\n              item.active,\r\n              existingProduct.id\r\n            ])\r\n\r\n            results.updated++\r\n\r\n            // Update inventory_items if exists\r\n            const inventoryUpdateQuery = `\r\n              UPDATE inventory_items\r\n              SET\r\n                name = $1,\r\n                description = $2,\r\n                category = $3,\r\n                cost_price = $4,\r\n                updated_at = NOW()\r\n              WHERE sku = $5\r\n            `\r\n            await client.query(inventoryUpdateQuery, [\r\n              item.name,\r\n              item.description,\r\n              item.category,\r\n              item.unitPrice,\r\n              item.sku\r\n            ])\r\n\r\n          } else {\r\n            results.skipped++\r\n            results.errors.push(`SKU ${item.sku} already exists (use overwriteExisting to update)`)\r\n            continue\r\n          }\r\n        } else {\r\n          // Create new product\r\n          const insertQuery = `\r\n            INSERT INTO \"Product\" (\r\n              \"supplierId\", name, description, \"categoryId\", sku, \"basePrice\",\r\n              currency, active, \"createdAt\", \"updatedAt\"\r\n            ) VALUES (\r\n              $1, $2, $3, $4, $5, $6, $7, $8, NOW(), NOW()\r\n            ) RETURNING id\r\n          `\r\n          const insertResult = await client.query(insertQuery, [\r\n            validatedData.supplierId,\r\n            item.name,\r\n            item.description,\r\n            item.category,\r\n            item.sku,\r\n            item.unitPrice,\r\n            item.currency,\r\n            item.active\r\n          ])\r\n\r\n          results.created++\r\n\r\n          // Create corresponding inventory_items entry\r\n          const inventoryQuery = `\r\n            INSERT INTO inventory_items (\r\n              sku, name, description, category, cost_price, stock_qty,\r\n              reserved_qty, reorder_point, status, location, created_at, updated_at\r\n            ) VALUES (\r\n              $1, $2, $3, $4, $5, 0, 0, 10, 'active', 'Main Warehouse', NOW(), NOW()\r\n            )\r\n            ON CONFLICT (sku) DO UPDATE SET\r\n              name = EXCLUDED.name,\r\n              description = EXCLUDED.description,\r\n              category = EXCLUDED.category,\r\n              cost_price = EXCLUDED.cost_price,\r\n              updated_at = NOW()\r\n          `\r\n          await client.query(inventoryQuery, [\r\n            item.sku,\r\n            item.name,\r\n            item.description,\r\n            item.category,\r\n            item.unitPrice\r\n          ])\r\n        }\r\n\r\n      } catch (itemError) {\r\n        results.skipped++\r\n        results.errors.push(`Error processing ${item.sku}: ${itemError instanceof Error ? itemError.message : 'Unknown error'}`)\r\n      }\r\n    }\r\n\r\n    const response = NextResponse.json({\r\n      success: true,\r\n      data: {\r\n        pricelistId: validatedData.pricelistId,\r\n        supplierId: validatedData.supplierId,\r\n        results\r\n      },\r\n      message: `Promotion completed. ${results.created} items created, ${results.updated} items updated, ${results.skipped} items skipped.`,\r\n      deprecation_notice: DEPRECATION_MESSAGE\r\n    })\r\n\r\n    return addDeprecationHeaders(response)\r\n  })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\api\\suppliers\\pricelists\\upload\\live-route.ts","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":848,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":848,"endColumn":74,"suggestions":[{"messageId":"addBrackets","fix":{"range":[25742,26613],"text":"{ const spSku = row.mappedData.supplier_sku || row.mappedData.sku\n          await upsertSupplierProduct({ supplierId, sku: spSku, name: row.mappedData.name })\n          await setStock({\n            supplierId,\n            sku: spSku,\n            quantity: row.mappedData.stock_qty || 0,\n            unitCost: row.mappedData.cost_price,\n            reason: `Upload session: ${row.id}`\n          })\n\n          created++\n          totalValue += (row.mappedData.cost_price || 0) * (row.mappedData.stock_qty || 0)\n\n          // Track new categories and brands\n          if (row.mappedData.category && !existingCategories.has(row.mappedData.category)) {\n            newCategories.add(row.mappedData.category)\n          }\n          if (row.mappedData.brand && !existingBrands.has(row.mappedData.brand)) {\n            newBrands.add(row.mappedData.brand)\n          }\n          break }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":871,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":871,"endColumn":77,"suggestions":[{"messageId":"addBrackets","fix":{"range":[26648,27075],"text":"{ const spSkuUpd = row.mappedData.supplier_sku || row.mappedData.sku\n          if (row.mappedData.stock_qty !== undefined) {\n            await setStock({\n              supplierId,\n              sku: spSkuUpd,\n              quantity: row.mappedData.stock_qty,\n              unitCost: row.mappedData.cost_price,\n              reason: `Upload session update: ${row.id}`\n            })\n          }\n          updated++\n          break }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Live Database XLSX Upload Route\n * Real-time integration with PostgreSQL for supplier price lists\n */\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport * as XLSX from 'xlsx'\nimport { query, withTransaction } from '@/lib/database'\nimport { upsertSupplierProduct, setStock } from '@/services/ssot/inventoryService'\n\ntype InventorySummaryRow = {\n  sku: string;\n  id: string;\n  name: string;\n  cost_price: number | null;\n  stock_qty: number | null;\n};\n\ntype CategoryRow = { category: string | null };\ntype BrandRow = { brand: string | null };\n\n// Enhanced validation schemas\nconst UploadSessionSchema = z.object({\n  sessionId: z.string().min(1),\n  supplierId: z.string().uuid(),\n  filename: z.string().min(1),\n  fileSize: z.number().min(1),\n  totalRows: z.number().min(1)\n})\n\nconst FieldMappingSchema = z.object({\n  sku: z.string().min(1, 'SKU mapping is required'),\n  name: z.string().min(1, 'Product name mapping is required'),\n  description: z.string().optional(),\n  category: z.string().min(1, 'Category mapping is required'),\n  brand: z.string().optional(),\n  supplier_sku: z.string().optional(),\n  cost_price: z.string().min(1, 'Cost price mapping is required'),\n  sale_price: z.string().optional(),\n  currency: z.string().optional(),\n  stock_qty: z.string().min(1, 'Stock quantity mapping is required'),\n  reorder_point: z.string().optional(),\n  max_stock: z.string().optional(),\n  unit: z.string().optional(),\n  weight: z.string().optional(),\n  barcode: z.string().optional(),\n  location: z.string().optional(),\n  tags: z.string().optional(),\n  notes: z.string().optional()\n})\n\nconst ProcessUploadSchema = z.object({\n  sessionId: z.string().min(1),\n  supplierId: z.string().uuid(),\n  fieldMappings: FieldMappingSchema,\n  conflictResolution: z.object({\n    strategy: z.enum(['skip', 'update', 'merge', 'create_variant']),\n    updateFields: z.array(z.string()).default([]),\n    preserveFields: z.array(z.string()).default([])\n  }),\n  validationOptions: z.object({\n    skipEmptyRows: z.boolean().default(true),\n    validateSkus: z.boolean().default(true),\n    checkDuplicates: z.boolean().default(true),\n    validatePrices: z.boolean().default(true),\n    normalizeText: z.boolean().default(true),\n    createBackup: z.boolean().default(true)\n  }).default({}),\n  dryRun: z.boolean().default(false)\n})\n\ninterface UploadSession {\n  id: string\n  supplierId: string\n  supplierName: string\n  filename: string\n  fileSize: number\n  totalRows: number\n  processedRows: number\n  validRows: number\n  errorRows: number\n  warningRows: number\n  skippedRows: number\n  status: 'uploading' | 'mapping' | 'validating' | 'importing' | 'completed' | 'failed' | 'rollback'\n  progress: number\n  createdAt: Date\n  updatedAt: Date\n  completedAt?: Date\n  backupId?: string\n  fieldMappings?: Record<string, string>\n  validationResults?: ValidationResult\n  importResults?: ImportResult\n}\n\ninterface ValidationIssue {\n  row: number\n  field: string\n  value: any\n  severity: 'error' | 'warning' | 'info'\n  message: string\n  suggestion?: string\n  autoFixAvailable?: boolean\n}\n\ninterface ProcessedRow {\n  id: string\n  rowNumber: number\n  originalData: Record<string, any>\n  mappedData: Record<string, any>\n  status: 'valid' | 'warning' | 'error' | 'skipped'\n  issues: ValidationIssue[]\n  action: 'create' | 'update' | 'skip'\n  existingRecord?: any\n  resolvedConflicts?: string[]\n}\n\ninterface ValidationResult {\n  isValid: boolean\n  summary: {\n    totalRows: number\n    validRows: number\n    errorRows: number\n    warningRows: number\n    skippedRows: number\n    duplicatesFound: number\n    conflictsResolved: number\n    estimatedValue: number\n    categories: Set<string>\n    brands: Set<string>\n  }\n  issues: ValidationIssue[]\n  processedRows: ProcessedRow[]\n  recommendations: string[]\n}\n\ninterface ImportResult {\n  created: number\n  updated: number\n  skipped: number\n  errors: string[]\n  backupId?: string\n  summary: {\n    totalValue: number\n    newCategories: number\n    newBrands: number\n    affectedSuppliers: number\n  }\n}\n\n// GET /api/suppliers/pricelists/upload/live-route - Get upload session status\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const sessionId = searchParams.get('sessionId')\n\n    if (!sessionId) {\n      return NextResponse.json({\n        success: false,\n        error: 'Session ID is required'\n      }, { status: 400 })\n    }\n\n    // Get session from database\n    const sessionResult = await query(`\n      SELECT * FROM upload_sessions WHERE id = $1\n    `, [sessionId])\n\n    if (sessionResult.rows.length === 0) {\n      return NextResponse.json({\n        success: false,\n        error: 'Upload session not found'\n      }, { status: 404 })\n    }\n\n    const session = sessionResult.rows[0]\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        ...session,\n        fieldMappings: session.field_mappings,\n        validationResults: session.validation_results,\n        importResults: session.import_results\n      }\n    })\n\n  } catch (error) {\n    console.error('Error retrieving upload session:', error)\n    return NextResponse.json({\n      success: false,\n      error: 'Internal server error'\n    }, { status: 500 })\n  }\n}\n\n// POST /api/suppliers/pricelists/upload/live-route - Create upload session or process upload\nexport async function POST(request: NextRequest) {\n  try {\n    const contentType = request.headers.get('content-type')\n\n    // Handle file upload (multipart/form-data)\n    if (contentType?.includes('multipart/form-data')) {\n      return handleFileUpload(request)\n    }\n\n    // Handle upload processing (application/json)\n    return handleUploadProcessing(request)\n\n  } catch (error) {\n    console.error('Error in upload handler:', error)\n    return NextResponse.json({\n      success: false,\n      error: 'Upload operation failed',\n      details: error instanceof Error ? error.message : 'Unknown error'\n    }, { status: 500 })\n  }\n}\n\n// Handle file upload and create session\nasync function handleFileUpload(request: NextRequest): Promise<NextResponse> {\n  const formData = await request.formData()\n  const file = formData.get('file') as File\n  const supplierId = formData.get('supplierId') as string\n\n  if (!file || !supplierId) {\n    return NextResponse.json({\n      success: false,\n      error: 'File and supplier ID are required'\n    }, { status: 400 })\n  }\n\n  // Validate file type and size\n  const allowedTypes = [\n    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n    'application/vnd.ms-excel',\n    'text/csv'\n  ]\n\n  if (!allowedTypes.includes(file.type)) {\n    return NextResponse.json({\n      success: false,\n      error: 'Invalid file type. Please upload Excel (.xlsx, .xls) or CSV files only'\n    }, { status: 400 })\n  }\n\n  const maxSize = 25 * 1024 * 1024 // 25MB\n  if (file.size > maxSize) {\n    return NextResponse.json({\n      success: false,\n      error: 'File size exceeds 25MB limit'\n    }, { status: 400 })\n  }\n\n  try {\n    // Get supplier information\n    const supplierResult = await query(\n      'SELECT name, email FROM public.suppliers WHERE id = $1',\n      [supplierId]\n    )\n\n    if (supplierResult.rows.length === 0) {\n      return NextResponse.json({\n        success: false,\n        error: 'Supplier not found'\n      }, { status: 404 })\n    }\n\n    const supplier = supplierResult.rows[0]\n\n    // Process file\n    const arrayBuffer = await file.arrayBuffer()\n    let data: any[][]\n    let headers: string[]\n\n    if (file.type === 'text/csv') {\n      // Handle CSV\n      const text = new TextDecoder().decode(arrayBuffer)\n      const lines = text.split('\\n').filter(line => line.trim())\n      data = lines.map(line =>\n        line.split(',').map(cell => cell.trim().replace(/^[\"']|[\"']$/g, ''))\n      )\n      headers = data[0]\n      data = data.slice(1)\n    } else {\n      // Handle Excel\n      const workbook = XLSX.read(arrayBuffer, { type: 'array' })\n      const worksheet = workbook.Sheets[workbook.SheetNames[0]]\n      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 })\n\n      if (jsonData.length < 2) {\n        return NextResponse.json({\n          success: false,\n          error: 'File must contain at least a header row and one data row'\n        }, { status: 400 })\n      }\n\n      headers = jsonData[0] as string[]\n      data = jsonData\n        .slice(1)\n        .filter((row): row is any[] => Array.isArray(row) && row.some(cell => cell !== null && cell !== undefined && cell !== ''))\n        .map(row => row as any[])\n    }\n\n    // Create upload session in database\n    const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n\n    await query(`\n      INSERT INTO upload_sessions (\n        id, supplier_id, supplier_name, filename, file_size, total_rows,\n        status, progress, headers, sample_data, created_at, updated_at\n      ) VALUES ($1, $2, $3, $4, $5, $6, 'uploading', 100, $7, $8, NOW(), NOW())\n    `, [\n      sessionId,\n      supplierId,\n      supplier.name,\n      file.name,\n      file.size,\n      data.length,\n      JSON.stringify(headers),\n      JSON.stringify(data.slice(0, 5)) // First 5 rows for preview\n    ])\n\n    // Store complete file data temporarily\n    await query(`\n      INSERT INTO upload_temp_data (session_id, data, created_at)\n      VALUES ($1, $2, NOW())\n    `, [sessionId, JSON.stringify({ headers, data })])\n\n    // Generate automatic field mappings\n    const autoMappings = generateAutoMappings(headers)\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        sessionId,\n        supplier: {\n          id: supplierId,\n          name: supplier.name,\n          email: supplier.email\n        },\n        file: {\n          name: file.name,\n          size: file.size,\n          totalRows: data.length\n        },\n        headers,\n        sampleData: data.slice(0, 5),\n        autoMappings,\n        mappingConfidence: calculateMappingConfidence(autoMappings, headers)\n      },\n      message: 'File uploaded successfully'\n    })\n\n  } catch (error) {\n    console.error('File processing error:', error)\n    return NextResponse.json({\n      success: false,\n      error: 'Failed to process file',\n      details: error instanceof Error ? error.message : 'Unknown error'\n    }, { status: 400 })\n  }\n}\n\n// Handle upload processing with validation and conflict resolution\nasync function handleUploadProcessing(request: NextRequest): Promise<NextResponse> {\n  const body = await request.json()\n  const validatedData = ProcessUploadSchema.parse(body)\n\n  return await withTransaction(async (client) => {\n    // Get session from database\n    const sessionResult = await client.query(\n      'SELECT * FROM upload_sessions WHERE id = $1',\n      [validatedData.sessionId]\n    )\n\n    if (sessionResult.rows.length === 0) {\n      throw new Error('Upload session not found')\n    }\n\n    const session = sessionResult.rows[0]\n\n    // Get file data\n    const fileDataResult = await client.query(\n      'SELECT data FROM upload_temp_data WHERE session_id = $1',\n      [validatedData.sessionId]\n    )\n\n    if (fileDataResult.rows.length === 0) {\n      throw new Error('File data not found')\n    }\n\n    const fileData = JSON.parse(fileDataResult.rows[0].data)\n\n    // Update session status\n    await client.query(`\n      UPDATE upload_sessions\n      SET status = 'validating', progress = 10, field_mappings = $2, updated_at = NOW()\n      WHERE id = $1\n    `, [validatedData.sessionId, JSON.stringify(validatedData.fieldMappings)])\n\n    // Process and validate data\n    const validationResult = await processAndValidateData(\n      fileData.data,\n      fileData.headers,\n      validatedData.fieldMappings,\n      validatedData.conflictResolution,\n      validatedData.validationOptions,\n      client\n    )\n\n    // Update session with validation results\n    await client.query(`\n      UPDATE upload_sessions\n      SET validation_results = $2, valid_rows = $3, error_rows = $4,\n          warning_rows = $5, skipped_rows = $6, progress = 75, status = 'importing', updated_at = NOW()\n      WHERE id = $1\n    `, [\n      validatedData.sessionId,\n      JSON.stringify(validationResult),\n      validationResult.summary.validRows,\n      validationResult.summary.errorRows,\n      validationResult.summary.warningRows,\n      validationResult.summary.skippedRows\n    ])\n\n    // If dry run, return validation results without importing\n    if (validatedData.dryRun) {\n      await client.query(`\n        UPDATE upload_sessions SET status = 'validating', progress = 50, updated_at = NOW() WHERE id = $1\n      `, [validatedData.sessionId])\n\n      return NextResponse.json({\n        success: true,\n        data: {\n          sessionId: validatedData.sessionId,\n          validationResult,\n          dryRun: true\n        },\n        message: 'Validation completed (dry run)'\n      })\n    }\n\n    // Create backup before importing\n    let backupId: string | undefined\n    if (validatedData.validationOptions.createBackup) {\n      backupId = await createBackup(client, validatedData.sessionId, validationResult.processedRows)\n    }\n\n    // Import data to inventory\n    const importResult = await importToInventory(\n      client,\n      validationResult.processedRows,\n      validatedData.conflictResolution,\n      validatedData.supplierId\n    )\n\n    // Update session completion\n    await client.query(`\n      UPDATE upload_sessions\n      SET status = 'completed', progress = 100, completed_at = NOW(),\n          backup_id = $2, import_results = $3, updated_at = NOW()\n      WHERE id = $1\n    `, [\n      validatedData.sessionId,\n      backupId,\n      JSON.stringify(importResult)\n    ])\n\n    // Clean up temporary data\n    await client.query('DELETE FROM upload_temp_data WHERE session_id = $1', [validatedData.sessionId])\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        sessionId: validatedData.sessionId,\n        validationResult,\n        importResult,\n        backupId\n      },\n      message: `Import completed successfully. ${importResult.created} items created, ${importResult.updated} items updated.`\n    })\n  })\n}\n\n// Helper functions for processing and validation\nfunction generateAutoMappings(headers: string[]): Record<string, string> {\n  const mappings: Record<string, string> = {}\n  const normalizedHeaders = headers.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, '_'))\n\n  const fieldPatterns = {\n    sku: ['sku', 'item_code', 'product_code', 'part_number', 'part_no'],\n    name: ['name', 'product_name', 'item_name', 'description', 'product_description'],\n    description: ['description', 'details', 'product_details', 'long_description'],\n    category: ['category', 'type', 'group', 'class', 'product_type'],\n    brand: ['brand', 'make', 'manufacturer', 'vendor'],\n    supplier_sku: ['supplier_sku', 'vendor_sku', 'supplier_code', 'vendor_code'],\n    cost_price: ['cost', 'price', 'cost_price', 'unit_price', 'wholesale_price'],\n    sale_price: ['sale_price', 'retail_price', 'selling_price', 'list_price'],\n    stock_qty: ['stock', 'quantity', 'qty', 'inventory', 'on_hand'],\n    reorder_point: ['reorder', 'min_stock', 'minimum', 'reorder_point'],\n    max_stock: ['max_stock', 'maximum', 'max_quantity', 'max_qty'],\n    unit: ['unit', 'uom', 'unit_of_measure'],\n    weight: ['weight', 'mass', 'kg', 'grams'],\n    barcode: ['barcode', 'ean', 'upc', 'gtin'],\n    location: ['location', 'bin', 'warehouse', 'shelf'],\n    currency: ['currency', 'curr']\n  }\n\n  for (const [field, patterns] of Object.entries(fieldPatterns)) {\n    let bestMatch = { header: '', confidence: 0 }\n\n    normalizedHeaders.forEach((header, index) => {\n      for (const pattern of patterns) {\n        if (header.includes(pattern)) {\n          const confidence = pattern.length / header.length\n          if (confidence > bestMatch.confidence) {\n            bestMatch = { header: headers[index], confidence }\n          }\n        }\n      }\n    })\n\n    if (bestMatch.confidence > 0.4) {\n      mappings[field] = bestMatch.header\n    }\n  }\n\n  return mappings\n}\n\nfunction calculateMappingConfidence(mappings: Record<string, string>, headers: string[]): number {\n  const requiredFields = ['sku', 'name', 'category', 'cost_price', 'stock_qty']\n  const mappedRequired = requiredFields.filter(field => mappings[field])\n  return mappedRequired.length / requiredFields.length\n}\n\nasync function processAndValidateData(\n  data: any[][],\n  headers: string[],\n  fieldMappings: Record<string, string>,\n  conflictResolution: any,\n  validationOptions: any,\n  client: any\n): Promise<ValidationResult> {\n  const issues: ValidationIssue[] = []\n  const processedRows: ProcessedRow[] = []\n  const categories = new Set<string>()\n  const brands = new Set<string>()\n  let totalValue = 0\n  let conflictsResolved = 0\n\n  // Get existing inventory for conflict detection\n  const existingInventoryResult = await client.query(`\n    SELECT sku, id, name, cost_price, stock_qty FROM public.inventory_items\n  `)\n  const existingInventory = new Map<string, InventorySummaryRow>(\n    existingInventoryResult.rows.map((item: InventorySummaryRow) => [item.sku, item])\n  )\n\n  for (let i = 0; i < data.length; i++) {\n    const row = data[i]\n    const rowNumber = i + 2 // Account for header row and 1-based indexing\n\n    // Skip empty rows if configured\n    if (validationOptions.skipEmptyRows &&\n        row.every((cell: any) => !cell || cell.toString().trim() === '')) {\n      continue\n    }\n\n    const processedRow: ProcessedRow = {\n      id: `row_${i}`,\n      rowNumber,\n      originalData: {},\n      mappedData: {},\n      status: 'valid',\n      issues: [],\n      action: 'create'\n    }\n\n    // Build original data object\n    headers.forEach((header, index) => {\n      processedRow.originalData[header] = row[index]\n    })\n\n    // Apply field mappings and validate\n    for (const [targetField, sourceField] of Object.entries(fieldMappings)) {\n      if (!sourceField || !headers.includes(sourceField)) continue\n\n      const sourceIndex = headers.indexOf(sourceField)\n      const value = row[sourceIndex]\n\n      processedRow.mappedData[targetField] = transformAndValidateField(\n        targetField,\n        value,\n        processedRow.issues,\n        rowNumber,\n        validationOptions\n      )\n    }\n\n    // Check for existing records and handle conflicts\n    if (processedRow.mappedData.sku) {\n      const existingRecord = existingInventory.get(processedRow.mappedData.sku)\n      if (existingRecord) {\n        processedRow.existingRecord = existingRecord\n        const conflictResult = resolveConflict(processedRow, existingRecord, conflictResolution)\n        processedRow.action = conflictResult.action\n        processedRow.resolvedConflicts = conflictResult.resolvedFields\n\n        if (conflictResult.action !== 'skip') {\n          conflictsResolved++\n        }\n      }\n    }\n\n    // Set final status based on issues\n    if (processedRow.issues.some(issue => issue.severity === 'error')) {\n      processedRow.status = 'error'\n    } else if (processedRow.issues.length > 0) {\n      processedRow.status = 'warning'\n    }\n\n    // Update statistics\n    if (processedRow.mappedData.category) categories.add(processedRow.mappedData.category)\n    if (processedRow.mappedData.brand) brands.add(processedRow.mappedData.brand)\n    if (processedRow.mappedData.cost_price) {\n      totalValue += (parseFloat(processedRow.mappedData.cost_price) || 0) *\n                   (parseInt(processedRow.mappedData.stock_qty) || 0)\n    }\n\n    processedRows.push(processedRow)\n  }\n\n  // Calculate summary statistics\n  const summary = {\n    totalRows: processedRows.length,\n    validRows: processedRows.filter(r => r.status === 'valid').length,\n    errorRows: processedRows.filter(r => r.status === 'error').length,\n    warningRows: processedRows.filter(r => r.status === 'warning').length,\n    skippedRows: processedRows.filter(r => r.action === 'skip').length,\n    duplicatesFound: processedRows.filter(r => r.existingRecord).length,\n    conflictsResolved,\n    estimatedValue: totalValue,\n    categories,\n    brands\n  }\n\n  // Generate recommendations\n  const recommendations = generateRecommendations(summary, processedRows)\n\n  return {\n    isValid: summary.errorRows === 0,\n    summary,\n    issues,\n    processedRows,\n    recommendations\n  }\n}\n\nfunction transformAndValidateField(\n  fieldName: string,\n  value: any,\n  issues: ValidationIssue[],\n  rowNumber: number,\n  validationOptions: any\n): any {\n  if (value === null || value === undefined || value === '') {\n    // Check if field is required\n    const requiredFields = ['sku', 'name', 'category', 'cost_price', 'stock_qty']\n    if (requiredFields.includes(fieldName)) {\n      issues.push({\n        row: rowNumber,\n        field: fieldName,\n        value,\n        severity: 'error',\n        message: `Required field '${fieldName}' is empty`\n      })\n    }\n    return null\n  }\n\n  switch (fieldName) {\n    case 'sku': {\n      const sku = value.toString().trim().toUpperCase()\n      if (validationOptions.validateSkus && !/^[A-Z0-9-_]+$/i.test(sku)) {\n        issues.push({\n          row: rowNumber,\n          field: fieldName,\n          value,\n          severity: 'warning',\n          message: 'SKU contains special characters',\n          suggestion: 'Use only alphanumeric characters, hyphens, and underscores'\n        })\n      }\n      return sku\n    }\n\n    case 'cost_price':\n    case 'sale_price': {\n      const price = parseFloat(value.toString().replace(/[^\\d.-]/g, ''))\n      if (isNaN(price) || price < 0) {\n        issues.push({\n          row: rowNumber,\n          field: fieldName,\n          value,\n          severity: 'error',\n          message: `Invalid ${fieldName} value`\n        })\n        return null\n      }\n      return price\n    }\n\n    case 'stock_qty':\n    case 'reorder_point':\n    case 'max_stock': {\n      const quantity = parseInt(value.toString())\n      if (isNaN(quantity) || quantity < 0) {\n        issues.push({\n          row: rowNumber,\n          field: fieldName,\n          value,\n          severity: 'warning',\n          message: `Invalid ${fieldName} value, using 0`,\n          autoFixAvailable: true\n        })\n        return 0\n      }\n      return quantity\n    }\n\n    case 'weight': {\n      const weight = parseFloat(value.toString())\n      return isNaN(weight) ? null : weight\n    }\n\n    default: {\n      const stringValue = value.toString().trim()\n      if (validationOptions.normalizeText) {\n        return stringValue.toLowerCase().replace(/\\s+/g, ' ');\n      }\n      return stringValue\n    }\n  }\n}\n\nfunction resolveConflict(\n  processedRow: ProcessedRow,\n  existingRecord: any,\n  conflictResolution: any\n): { action: 'create' | 'update' | 'skip', resolvedFields: string[] } {\n  const resolvedFields: string[] = []\n\n  switch (conflictResolution.strategy) {\n    case 'skip':\n      return { action: 'skip', resolvedFields: [] }\n\n    case 'update':\n      return { action: 'update', resolvedFields: Object.keys(processedRow.mappedData) }\n\n    case 'merge': {\n      const mergeFields = Object.keys(processedRow.mappedData).filter(field => {\n        const newValue = processedRow.mappedData[field]\n        return newValue !== null && newValue !== undefined && newValue !== ''\n      })\n      return { action: 'update', resolvedFields: mergeFields }\n    }\n\n    case 'create_variant':\n      processedRow.mappedData.sku = `${processedRow.mappedData.sku}-V${Date.now()}`\n      return { action: 'create', resolvedFields: ['sku'] }\n\n    default:\n      return { action: 'skip', resolvedFields: [] }\n  }\n}\n\nasync function createBackup(client: any, sessionId: string, processedRows: ProcessedRow[]): Promise<string> {\n  const backupId = `backup_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n\n  // Get existing records that will be affected\n  const affectedSkus = processedRows\n    .filter(row => row.action !== 'skip' && row.existingRecord)\n    .map(row => row.mappedData.sku)\n    .filter((sku): sku is string => typeof sku === 'string' && sku.length > 0)\n\n  if (affectedSkus.length > 0) {\n    const affectedRecordsResult = await client.query(`\n      SELECT * FROM public.inventory_items WHERE sku = ANY($1)\n    `, [affectedSkus])\n\n    // Store backup\n    await client.query(`\n      INSERT INTO upload_backups (\n        id, session_id, affected_records, original_data, created_at\n      ) VALUES ($1, $2, $3, $4, NOW())\n    `, [\n      backupId,\n      sessionId,\n      JSON.stringify(affectedSkus),\n      JSON.stringify(affectedRecordsResult.rows)\n    ])\n  }\n\n  return backupId\n}\n\nasync function importToInventory(\n  client: any,\n  processedRows: ProcessedRow[],\n  conflictResolution: any,\n  supplierId: string\n): Promise<ImportResult> {\n  let created = 0\n  let updated = 0\n  let skipped = 0\n  const errors: string[] = []\n  let totalValue = 0\n  const newCategories = new Set<string>()\n  const newBrands = new Set<string>()\n\n  // Get existing categories and brands\n  const existingCategoriesResult = await client.query('SELECT DISTINCT category FROM public.inventory_items')\n  const existingBrandsResult = await client.query('SELECT DISTINCT brand FROM public.inventory_items WHERE brand IS NOT NULL')\n\n  const existingCategories = new Set<string>(\n    existingCategoriesResult.rows\n      .map((r: CategoryRow) => r.category)\n      .filter((value: string | null): value is string => typeof value === 'string' && value.length > 0)\n  )\n  const existingBrands = new Set<string>(\n    existingBrandsResult.rows\n      .map((r: BrandRow) => r.brand)\n      .filter((value: string | null): value is string => typeof value === 'string' && value.length > 0)\n  )\n\n  for (const row of processedRows) {\n    if (row.status === 'error') {\n      skipped++\n      continue\n    }\n\n    try {\n      switch (row.action) {\n        case 'create':\n          // Create new inventory item\n          const spSku = row.mappedData.supplier_sku || row.mappedData.sku\n          await upsertSupplierProduct({ supplierId, sku: spSku, name: row.mappedData.name })\n          await setStock({\n            supplierId,\n            sku: spSku,\n            quantity: row.mappedData.stock_qty || 0,\n            unitCost: row.mappedData.cost_price,\n            reason: `Upload session: ${row.id}`\n          })\n\n          created++\n          totalValue += (row.mappedData.cost_price || 0) * (row.mappedData.stock_qty || 0)\n\n          // Track new categories and brands\n          if (row.mappedData.category && !existingCategories.has(row.mappedData.category)) {\n            newCategories.add(row.mappedData.category)\n          }\n          if (row.mappedData.brand && !existingBrands.has(row.mappedData.brand)) {\n            newBrands.add(row.mappedData.brand)\n          }\n          break\n\n        case 'update':\n          const spSkuUpd = row.mappedData.supplier_sku || row.mappedData.sku\n          if (row.mappedData.stock_qty !== undefined) {\n            await setStock({\n              supplierId,\n              sku: spSkuUpd,\n              quantity: row.mappedData.stock_qty,\n              unitCost: row.mappedData.cost_price,\n              reason: `Upload session update: ${row.id}`\n            })\n          }\n          updated++\n          break\n\n        case 'skip':\n          skipped++\n          break\n      }\n    } catch (error) {\n      errors.push(`Row ${row.rowNumber}: ${error instanceof Error ? error.message : 'Unknown error'}`)\n      skipped++\n    }\n  }\n\n  return {\n    created,\n    updated,\n    skipped,\n    errors,\n    summary: {\n      totalValue,\n      newCategories: newCategories.size,\n      newBrands: newBrands.size,\n      affectedSuppliers: 1\n    }\n  }\n}\n\nfunction generateRecommendations(summary: any, processedRows: ProcessedRow[]): string[] {\n  const recommendations: string[] = []\n\n  if (summary.errorRows > 0) {\n    recommendations.push(`${summary.errorRows} rows have errors that need to be resolved before import`)\n  }\n\n  if (summary.warningRows > summary.validRows * 0.2) {\n    recommendations.push('High number of warnings detected - review data quality')\n  }\n\n  if (summary.duplicatesFound > 0) {\n    recommendations.push(`${summary.duplicatesFound} duplicate SKUs found - consider conflict resolution strategy`)\n  }\n\n  if (summary.categories.size > 20) {\n    recommendations.push('Large number of categories - consider standardization')\n  }\n\n  if (summary.estimatedValue > 1000000) {\n    recommendations.push('High-value import detected - ensure pricing accuracy before proceeding')\n  }\n\n  return recommendations\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\api\\v1\\integrations\\sync\\preview\\route.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'atob' is not defined.","line":90,"column":36,"nodeType":"Identifier","messageId":"undef","endLine":90,"endColumn":40}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Sync Preview API Route\n *\n * Endpoint: /api/v1/integrations/sync/preview\n *\n * GET /api/v1/integrations/sync/preview?sync_type=woocommerce&entity_type=customers\n *   - Fetch preview snapshot with delta detection\n *   - Returns cached result if available (1 hour TTL)\n *   - Query params: sync_type (woocommerce|odoo), entity_type (customers|products|orders)\n *\n * POST /api/v1/integrations/sync/preview?action=fetch\n *   - Force recompute delta (invalidate cache)\n *   - Same query params as GET\n *\n * POST /api/v1/integrations/sync/preview?action=select&entity_type=customers\n *   - Apply selective sync configuration\n *   - Body: { includeNew: boolean, includeUpdated: boolean, includeDeleted: boolean }\n *\n * Authentication: Requires organization_id in request context\n * Rate Limit: 10 requests/min per org (via middleware)\n * Error Codes: 400 (invalid params), 401 (auth), 500 (service error)\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { query } from '@/lib/database';\nimport { DeltaDetectionService, SyncType, EntityType } from '@/lib/services/DeltaDetectionService';\n\ninterface SelectiveSyncPayload {\n  includeNew: boolean;\n  includeUpdated: boolean;\n  includeDeleted: boolean;\n}\n\n/**\n * Validate query parameters\n */\nfunction validateQueryParams(\n  syncType: string | null,\n  entityType: string | null\n): { valid: boolean; error?: string } {\n  const validSyncTypes: SyncType[] = ['woocommerce', 'odoo'];\n  const validEntityTypes: EntityType[] = ['customers', 'products', 'orders'];\n\n  if (!syncType || !validSyncTypes.includes(syncType as SyncType)) {\n    return {\n      valid: false,\n      error: `Invalid sync_type. Must be one of: ${validSyncTypes.join(', ')}`,\n    };\n  }\n\n  if (!entityType || !validEntityTypes.includes(entityType as EntityType)) {\n    return {\n      valid: false,\n      error: `Invalid entity_type. Must be one of: ${validEntityTypes.join(', ')}`,\n    };\n  }\n\n  return { valid: true };\n}\n\n/**\n * Extract organization ID from request context\n */\nfunction getOrgIdFromRequest(request: NextRequest, body?: any): string | null {\n  // Try to get from request body first (for POST requests)\n  if (body?.orgId) {\n    return body.orgId;\n  }\n\n  // Try to get from custom header (set by auth middleware)\n  const orgId = request.headers.get('x-org-id') || request.headers.get('x-organization-id');\n  if (orgId) {\n    return orgId;\n  }\n\n  // Try query parameter\n  const url = new URL(request.url);\n  const queryOrgId = url.searchParams.get('orgId');\n  if (queryOrgId) {\n    return queryOrgId;\n  }\n\n  // Alternative: Get from Authorization header (if JWT contains org_id)\n  const auth = request.headers.get('authorization');\n  if (auth?.startsWith('Bearer ')) {\n    try {\n      const token = auth.substring(7);\n      const parts = token.split('.');\n      if (parts.length === 3) {\n        const payload = JSON.parse(atob(parts[1]));\n        if (payload.org_id || payload.organization_id) {\n          return payload.org_id || payload.organization_id;\n        }\n      }\n    } catch {\n      // Invalid token format\n    }\n  }\n\n  // Default fallback for development/testing\n  return 'org-default';\n}\n\n/**\n * GET - Fetch preview snapshot\n */\nexport async function GET(request: NextRequest) {\n  const startTime = Date.now();\n  const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n  try {\n    const url = new URL(request.url);\n    const syncType = url.searchParams.get('sync_type');\n    const entityType = url.searchParams.get('entity_type');\n\n    // Validate parameters\n    const validation = validateQueryParams(syncType, entityType);\n    if (!validation.valid) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: validation.error,\n          details: { requestId },\n        },\n        { status: 400 }\n      );\n    }\n\n    // Get organization ID\n    const orgId = getOrgIdFromRequest(request);\n    if (!orgId) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Unauthorized: Missing organization context. Please provide orgId in query params, headers, or request body.',\n          details: { requestId },\n        },\n        { status: 401 }\n      );\n    }\n\n    // Verify org exists and user has access (skip if using default org)\n    if (orgId !== 'org-default') {\n      const orgCheck = await query(\n        `SELECT id FROM organizations WHERE id = $1 LIMIT 1`,\n        [orgId]\n      );\n\n      if (!orgCheck.rows.length) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: 'Unauthorized: Invalid organization',\n            details: { requestId },\n          },\n          { status: 401 }\n        );\n      }\n    }\n\n    // Get preview snapshot\n    const result = await DeltaDetectionService.getPreviewSnapshot(\n      orgId,\n      syncType as SyncType,\n      entityType as EntityType,\n      false\n    );\n\n    // Log successful operation\n    await logRequest(orgId, 'sync_preview_fetch', 'success', {\n      syncType,\n      entityType,\n      cacheHit: result.cacheHit,\n      processingTime: Date.now() - startTime,\n    });\n\n    return NextResponse.json(\n      {\n        success: true,\n        data: result,\n        meta: {\n          timestamp: new Date().toISOString(),\n          requestId,\n          processingTime: Date.now() - startTime,\n        },\n      },\n      {\n        status: 200,\n        headers: {\n          'X-Request-ID': requestId,\n          'Cache-Control': result.cacheHit ? 'private, max-age=300' : 'no-cache',\n        },\n      }\n    );\n  } catch (error: any) {\n    console.error(`[Sync Preview] GET error:`, error);\n\n    const orgId = getOrgIdFromRequest(request);\n    if (orgId) {\n      await logRequest(orgId, 'sync_preview_fetch', 'failed', {\n        error: error.message,\n        processingTime: Date.now() - startTime,\n      });\n    }\n\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message || 'Failed to fetch sync preview',\n        details: { requestId },\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST - Force refresh or apply selective sync\n */\nexport async function POST(request: NextRequest) {\n  const startTime = Date.now();\n  const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n  try {\n    const url = new URL(request.url);\n    const action = url.searchParams.get('action');\n    const syncType = url.searchParams.get('sync_type');\n    const entityType = url.searchParams.get('entity_type');\n\n    // Get organization ID\n    let body: any = {};\n    try {\n      body = await request.json();\n    } catch {\n      // No body, continue\n    }\n\n    const orgId = getOrgIdFromRequest(request, body);\n    if (!orgId) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Unauthorized: Missing organization context. Please provide orgId in query params, headers, or request body.',\n          details: { requestId },\n        },\n        { status: 401 }\n      );\n    }\n\n    // Verify org exists (skip if using default org)\n    if (orgId !== 'org-default') {\n      const orgCheck = await query(\n        `SELECT id FROM organizations WHERE id = $1 LIMIT 1`,\n        [orgId]\n      );\n\n      if (!orgCheck.rows.length) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: 'Unauthorized: Invalid organization',\n            details: { requestId },\n          },\n          { status: 401 }\n        );\n      }\n    }\n\n    // Handle 'fetch' action - force refresh\n    if (action === 'fetch') {\n      const validation = validateQueryParams(syncType, entityType);\n      if (!validation.valid) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: validation.error,\n            details: { requestId },\n          },\n          { status: 400 }\n        );\n      }\n\n      // Invalidate cache and get fresh snapshot\n      await DeltaDetectionService.invalidatePreviewCache(\n        orgId,\n        syncType as SyncType,\n        entityType as EntityType\n      );\n\n      const result = await DeltaDetectionService.getPreviewSnapshot(\n        orgId,\n        syncType as SyncType,\n        entityType as EntityType,\n        true\n      );\n\n      await logRequest(orgId, 'sync_preview_refresh', 'success', {\n        syncType,\n        entityType,\n        processingTime: Date.now() - startTime,\n      });\n\n      return NextResponse.json(\n        {\n          success: true,\n          data: result,\n          message: 'Preview refreshed',\n          meta: {\n            timestamp: new Date().toISOString(),\n            requestId,\n            processingTime: Date.now() - startTime,\n          },\n        },\n        {\n          status: 200,\n          headers: {\n            'X-Request-ID': requestId,\n            'Cache-Control': 'no-cache',\n          },\n        }\n      );\n    }\n\n    // Handle 'select' action - apply selective sync\n    if (action === 'select') {\n      if (!entityType) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: 'entity_type is required for select action',\n            details: { requestId },\n          },\n          { status: 400 }\n        );\n      }\n\n      const payload: SelectiveSyncPayload = await request.json();\n\n      // Validate payload\n      if (\n        typeof payload.includeNew !== 'boolean' ||\n        typeof payload.includeUpdated !== 'boolean' ||\n        typeof payload.includeDeleted !== 'boolean'\n      ) {\n        return NextResponse.json(\n          {\n            success: false,\n            error: 'Invalid payload. Expected: { includeNew: boolean, includeUpdated: boolean, includeDeleted: boolean }',\n            details: { requestId },\n          },\n          { status: 400 }\n        );\n      }\n\n      // Store selective sync configuration\n      const configId = `sync-config-${orgId}-${entityType}-${Date.now()}`;\n      await query(\n        `INSERT INTO sync_selective_config (id, org_id, entity_type, config)\n         VALUES ($1, $2, $3, $4::jsonb)\n         ON CONFLICT (org_id, entity_type) DO UPDATE\n         SET config = $4::jsonb, updated_at = NOW()`,\n        [\n          configId,\n          orgId,\n          entityType,\n          JSON.stringify({\n            includeNew: payload.includeNew,\n            includeUpdated: payload.includeUpdated,\n            includeDeleted: payload.includeDeleted,\n            appliedAt: new Date().toISOString(),\n          }),\n        ]\n      );\n\n      await logRequest(orgId, 'sync_selective_config', 'success', {\n        entityType,\n        config: payload,\n      });\n\n      return NextResponse.json(\n        {\n          success: true,\n          data: {\n            entityType,\n            selectiveSyncConfig: payload,\n            appliedAt: new Date().toISOString(),\n          },\n          message: 'Selective sync configuration applied',\n          meta: {\n            timestamp: new Date().toISOString(),\n            requestId,\n            processingTime: Date.now() - startTime,\n          },\n        },\n        {\n          status: 200,\n          headers: {\n            'X-Request-ID': requestId,\n          },\n        }\n      );\n    }\n\n    // Invalid action\n    return NextResponse.json(\n      {\n        success: false,\n        error: 'Invalid action. Must be one of: fetch, select',\n        details: { requestId },\n      },\n      { status: 400 }\n    );\n  } catch (error: any) {\n    console.error(`[Sync Preview] POST error:`, error);\n\n    const orgId = getOrgIdFromRequest(request);\n    if (orgId) {\n      const action = new URL(request.url).searchParams.get('action');\n      await logRequest(orgId, `sync_${action || 'unknown'}`, 'failed', {\n        error: error.message,\n        processingTime: Date.now() - startTime,\n      });\n    }\n\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message || 'Failed to process sync preview request',\n        details: { requestId },\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Log request to activity table\n */\nasync function logRequest(\n  orgId: string,\n  activityType: string,\n  status: string,\n  details?: Record<string, any>\n): Promise<void> {\n  try {\n    await query(\n      `INSERT INTO sync_activity_log (org_id, activity_type, status, details)\n       VALUES ($1, $2, $3, $4::jsonb)`,\n      [orgId, activityType, status, JSON.stringify(details || {})]\n    );\n  } catch (error: any) {\n    // Handle missing table gracefully - this is non-fatal\n    if (error.message?.includes('does not exist') || \n        error.message?.includes('relation') ||\n        error.code === '42P01') {\n      console.warn('[Sync Preview] Activity log table does not exist, skipping log:', activityType);\n      return;\n    }\n    console.error('[Sync Preview] Error logging request:', error);\n    // Non-fatal error - don't throw\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\api\\v1\\integrations\\woocommerce\\sync\\customers\\route.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'setImmediate' is not defined.","line":190,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":190,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * WooCommerce Customer Sync API (Queue-Based)\n *\n * Production-grade customer synchronization using queue state machine pattern.\n * Based on Odoo data_queue_mixin_ept production implementation.\n *\n * Features:\n * - Queue-based processing with state tracking\n * - Batch processing with configurable size and delay\n * - Idempotent retry logic with exponential backoff\n * - Activity logging and audit trails\n * - Safe resumption of interrupted syncs\n *\n * Author: Claude Code\n * Date: 2025-11-05\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { WooCommerceService } from '@/lib/services/WooCommerceService';\nimport { CustomerSyncService } from '@/lib/services/CustomerSyncService';\nimport { WooCommerceSyncQueue } from '@/lib/services/WooCommerceSyncQueue';\n\ninterface WooCommerceConfig {\n  url: string;\n  consumerKey: string;\n  consumerSecret: string;\n}\n\ninterface SyncRequest {\n  config: WooCommerceConfig;\n  org_id: string;\n  user_id?: string;\n  options?: {\n    limit?: number;\n    email?: string;\n    wooCustomerId?: number;\n    batchSize?: number;\n    batchDelayMs?: number;\n    maxRetries?: number;\n    initialBackoffMs?: number;\n  };\n  action?: 'start' | 'status' | 'retry' | 'force-done';\n  queue_id?: string;\n}\n\n/**\n * POST /api/v1/integrations/woocommerce/sync/customers\n * Start a new customer sync or manage existing sync\n */\nexport async function POST(request: NextRequest) {\n  try {\n    let body: SyncRequest;\n    try {\n      body = await request.json();\n    } catch (error) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Invalid JSON in request body',\n        },\n        { status: 400 }\n      );\n    }\n\n    const { config, org_id, user_id = 'system', options = {}, action = 'start', queue_id } = body;\n\n    // Validate config\n    if (!config || !config.url || !config.consumerKey || !config.consumerSecret) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'WooCommerce configuration is required (url, consumerKey, consumerSecret)',\n        },\n        { status: 400 }\n      );\n    }\n\n    // Validate org_id\n    if (!org_id) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'org_id is required',\n        },\n        { status: 400 }\n      );\n    }\n\n    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n    if (!uuidRegex.test(org_id)) {\n      console.error(`Invalid org_id format: \"${org_id}\"`);\n      return NextResponse.json(\n        {\n          success: false,\n          error: `Invalid organization ID format. Must be a valid UUID.`,\n        },\n        { status: 400 }\n      );\n    }\n\n    // Initialize WooCommerce service\n    const wooService = new WooCommerceService(config);\n\n    // Test connection\n    const connected = await wooService.testConnection();\n    if (!connected) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: 'Failed to connect to WooCommerce store',\n        },\n        { status: 500 }\n      );\n    }\n\n    // Handle different actions\n    if (action === 'status' && queue_id) {\n      // Get status of existing queue\n      const status = await CustomerSyncService.getStatus(queue_id);\n      return NextResponse.json({\n        success: true,\n        data: status,\n      });\n    }\n\n    if (action === 'retry' && queue_id) {\n      // Retry failed items in queue\n      const progress = await CustomerSyncService.retryFailed(\n        wooService,\n        queue_id,\n        org_id,\n        {\n          batchSize: options.batchSize || 50,\n          batchDelayMs: options.batchDelayMs || 2000,\n          maxRetries: options.maxRetries || 3,\n          initialBackoffMs: options.initialBackoffMs || 1000,\n        }\n      );\n\n      return NextResponse.json({\n        success: true,\n        data: progress,\n        message: 'Retry processing completed',\n      });\n    }\n\n    if (action === 'force-done' && queue_id) {\n      // Force complete queue\n      const progress = await CustomerSyncService.forceDone(queue_id);\n      return NextResponse.json({\n        success: true,\n        data: progress,\n        message: 'Queue forced to completion',\n      });\n    }\n\n    // Default: Start new sync\n    if (action !== 'start') {\n      return NextResponse.json(\n        {\n          success: false,\n          error: `Unknown action: ${action}. Valid actions are: start, status, retry, force-done`,\n        },\n        { status: 400 }\n      );\n    }\n\n    // Start new sync\n    console.log(`Starting customer sync for org ${org_id}`);\n\n    const queueId = await CustomerSyncService.startSync(\n      wooService,\n      org_id,\n      user_id,\n      {\n        batchSize: options.batchSize || 50,\n        batchDelayMs: options.batchDelayMs || 2000,\n        maxRetries: options.maxRetries || 3,\n        backoffMultiplier: 2,\n        initialBackoffMs: options.initialBackoffMs || 1000,\n      },\n      {\n        email: options.email,\n        wooCustomerId: options.wooCustomerId,\n      }\n    );\n\n    // Process queue (non-blocking - fires off async task)\n    // In production, this would be queued to a background job processor\n    setImmediate(async () => {\n      try {\n        await CustomerSyncService.processQueue(wooService, queueId, org_id, {\n          batchSize: options.batchSize || 50,\n          batchDelayMs: options.batchDelayMs || 2000,\n          maxRetries: options.maxRetries || 3,\n        });\n\n        console.log(`Sync completed for queue ${queueId}`);\n      } catch (error: any) {\n        console.error(`Error processing queue ${queueId}:`, error);\n        // Mark queue for manual intervention\n        await WooCommerceSyncQueue.logActivity(\n          queueId,\n          null,\n          'sync_error',\n          'failed',\n          `Async processing error: ${error.message}`,\n          { error: error.message }\n        );\n      }\n    });\n\n    // Return queue info for client\n    const queueStatus = await CustomerSyncService.getStatus(queueId);\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        ...queueStatus,\n        message: 'Sync queue created and processing started',\n      },\n    });\n  } catch (error: any) {\n    console.error('Error in customer sync API:', error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message || 'Failed to sync customers',\n      },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\customers\\[id]\\page.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":140,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":140,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useState, useEffect } from \"react\";\nimport { useParams, useRouter } from \"next/navigation\";\nimport {\n  User,\n  Mail,\n  Phone,\n  Building2,\n  MapPin,\n  Calendar,\n  TrendingUp,\n  Award,\n  CreditCard,\n  ArrowLeft,\n  Edit,\n  Trash2,\n  History,\n  Users,\n  DollarSign,\n  Activity,\n  Tag,\n} from \"lucide-react\";\nimport AppLayout from \"@/components/layout/AppLayout\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { formatDate, formatDateTime } from \"@/lib/utils\";\n\ninterface Customer {\n  id: string;\n  org_id: string;\n  name: string;\n  email: string | null;\n  phone: string | null;\n  company: string | null;\n  segment: 'enterprise' | 'mid_market' | 'smb' | 'startup' | 'individual' | null;\n  status: 'active' | 'inactive' | 'prospect' | 'churned' | 'suspended' | null;\n  lifetime_value: number | null;\n  acquisition_date: string | null;\n  last_interaction_date: string | null;\n  address: {\n    street?: string;\n    city?: string;\n    state?: string;\n    postal_code?: string;\n    country?: string;\n  } | null;\n  metadata: Record<string, any> | null;\n  tags: string[] | null;\n  created_at: string;\n  updated_at: string;\n}\n\ninterface CustomerLoyalty {\n  id: string;\n  customer_id: string;\n  program_id: string | null;\n  current_tier: 'bronze' | 'silver' | 'gold' | 'platinum' | 'diamond' | null;\n  total_points_earned: number;\n  total_points_redeemed: number;\n  points_balance: number;\n  tier_qualified_date: string | null;\n  lifetime_value: number | null;\n  referral_count: number;\n  created_at: string;\n  updated_at: string;\n}\n\ninterface LoyaltyTransaction {\n  id: string;\n  customer_id: string;\n  transaction_type: 'earn' | 'redeem' | 'expire' | 'adjust' | 'bonus';\n  points_amount: number;\n  reference_type: string | null;\n  reference_id: string | null;\n  description: string | null;\n  expires_at: string | null;\n  created_by: string | null;\n  created_at: string;\n}\n\nexport default function CustomerDetailsPage() {\n  const params = useParams();\n  const router = useRouter();\n  const { toast } = useToast();\n  const rawId = params && 'id' in params ? params.id : undefined;\n  const customerId = Array.isArray(rawId) ? rawId[0] : rawId ?? '';\n\n  const [customer, setCustomer] = useState<Customer | null>(null);\n  const [loyalty, setLoyalty] = useState<CustomerLoyalty | null>(null);\n  const [transactions, setTransactions] = useState<LoyaltyTransaction[]>([]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    if (customerId) {\n      fetchCustomerDetails();\n    }\n  }, [customerId]);\n\n  const fetchCustomerDetails = async () => {\n    try {\n      setLoading(true);\n\n      const customerResponse = await fetch(`/api/v1/customers/${customerId}`);\n      const customerData = await customerResponse.json();\n\n      if (customerData.success) {\n        setCustomer(customerData.data);\n      }\n\n      const loyaltyResponse = await fetch(`/api/v1/customers/${customerId}/loyalty`);\n      const loyaltyData = await loyaltyResponse.json();\n\n      if (loyaltyData.success && loyaltyData.data) {\n        setLoyalty(loyaltyData.data);\n      }\n\n      const transactionsResponse = await fetch(`/api/v1/customers/${customerId}/loyalty/transactions`);\n      const transactionsData = await transactionsResponse.json();\n\n      if (transactionsData.success) {\n        setTransactions(transactionsData.data || []);\n      }\n    } catch (error) {\n      console.error('Error fetching customer details:', error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to load customer details\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleDeleteCustomer = async () => {\n    if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {\n      return;\n    }\n\n    try {\n      const response = await fetch(`/api/v1/customers/${customerId}`, {\n        method: 'DELETE',\n      });\n\n      const data = await response.json();\n\n      if (data.success) {\n        toast({\n          title: \"Customer Deleted\",\n          description: \"Customer has been deleted successfully\",\n        });\n        router.push('/customers');\n      } else {\n        throw new Error(data.error);\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete customer\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const getSegmentColor = (segment: string | null) => {\n    const colors: Record<string, string> = {\n      enterprise: 'bg-purple-100 text-purple-800',\n      mid_market: 'bg-blue-100 text-blue-800',\n      smb: 'bg-green-100 text-green-800',\n      startup: 'bg-orange-100 text-orange-800',\n      individual: 'bg-gray-100 text-gray-800',\n    };\n    return segment ? colors[segment] || 'bg-gray-100 text-gray-800' : 'bg-gray-100 text-gray-800';\n  };\n\n  const getStatusColor = (status: string | null) => {\n    const colors: Record<string, string> = {\n      active: 'bg-green-100 text-green-800',\n      inactive: 'bg-gray-100 text-gray-800',\n      prospect: 'bg-blue-100 text-blue-800',\n      churned: 'bg-red-100 text-red-800',\n      suspended: 'bg-yellow-100 text-yellow-800',\n    };\n    return status ? colors[status] || 'bg-gray-100 text-gray-800' : 'bg-gray-100 text-gray-800';\n  };\n\n  const getTierColor = (tier: string | null) => {\n    const colors: Record<string, string> = {\n      bronze: 'bg-orange-100 text-orange-800',\n      silver: 'bg-gray-100 text-gray-800',\n      gold: 'bg-yellow-100 text-yellow-800',\n      platinum: 'bg-blue-100 text-blue-800',\n      diamond: 'bg-purple-100 text-purple-800',\n    };\n    return tier ? colors[tier] || 'bg-gray-100 text-gray-800' : 'bg-gray-100 text-gray-800';\n  };\n\n  const getTransactionTypeColor = (type: string) => {\n    const colors: Record<string, string> = {\n      earn: 'bg-green-100 text-green-800',\n      redeem: 'bg-blue-100 text-blue-800',\n      expire: 'bg-red-100 text-red-800',\n      adjust: 'bg-orange-100 text-orange-800',\n      bonus: 'bg-purple-100 text-purple-800',\n    };\n    return colors[type] || 'bg-gray-100 text-gray-800';\n  };\n\n\n\n  const formatCurrency = (value: number | null) => {\n    if (value === null || value === undefined) return 'N/A';\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD',\n    }).format(value);\n  };\n\n  const formatNumber = (value: number | null | undefined) => {\n    if (value === null || value === undefined || typeof value !== 'number') return '0';\n    if (isNaN(value)) return '0';\n    return value.toLocaleString('en-US');\n  };\n\n  if (loading) {\n    return (\n      <AppLayout\n        title=\"Customer Details\"\n        breadcrumbs={[\n          { label: \"Customers\", href: \"/customers\" },\n          { label: \"Details\" },\n        ]}\n      >\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900\"></div>\n        </div>\n      </AppLayout>\n    );\n  }\n\n  if (!customer) {\n    return (\n      <AppLayout\n        title=\"Customer Details\"\n        breadcrumbs={[\n          { label: \"Customers\", href: \"/customers\" },\n          { label: \"Details\" },\n        ]}\n      >\n        <div className=\"flex flex-col items-center justify-center h-64 gap-4\">\n          <p className=\"text-muted-foreground\">Customer not found</p>\n          <Button onClick={() => router.push('/customers')}>\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\n            Back to Customers\n          </Button>\n        </div>\n      </AppLayout>\n    );\n  }\n\n  return (\n    <AppLayout\n      title={customer.name}\n      breadcrumbs={[\n        { label: \"Customers\", href: \"/customers\" },\n        { label: customer.name },\n      ]}\n    >\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-4\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => router.push('/customers')}\n            >\n              <ArrowLeft className=\"h-4 w-4\" />\n            </Button>\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10\">\n                <User className=\"h-6 w-6\" />\n              </div>\n              <div className=\"flex gap-2\">\n                <Badge className={getStatusColor(customer.status)}>\n                  {customer.status || 'Unknown'}\n                </Badge>\n                {customer.segment && (\n                  <Badge className={getSegmentColor(customer.segment)}>\n                    {customer.segment}\n                  </Badge>\n                )}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => router.push(`/customers/${customerId}/edit`)}\n            >\n              <Edit className=\"mr-2 h-4 w-4\" />\n              Edit\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={handleDeleteCustomer}\n            >\n              <Trash2 className=\"mr-2 h-4 w-4\" />\n              Delete\n            </Button>\n          </div>\n        </div>\n\n        <div className=\"grid gap-4 md:grid-cols-4\">\n          <Card className=\"border-border\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Lifetime Value</CardTitle>\n              <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-3xl font-bold\">{formatCurrency(customer.lifetime_value)}</div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-border\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Loyalty Points</CardTitle>\n              <Award className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-3xl font-bold\">{formatNumber(loyalty?.points_balance)}</div>\n              {loyalty?.current_tier && (\n                <Badge className={`mt-2 ${getTierColor(loyalty.current_tier)}`}>\n                  {loyalty.current_tier}\n                </Badge>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-border\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Referrals</CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-3xl font-bold\">{loyalty?.referral_count || 0}</div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-border\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Last Interaction</CardTitle>\n              <Activity className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-sm font-medium\">{formatDate(customer.last_interaction_date)}</div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Tabs defaultValue=\"details\" className=\"space-y-4\">\n          <TabsList>\n            <TabsTrigger value=\"details\">Details</TabsTrigger>\n            <TabsTrigger value=\"loyalty\">Loyalty Program</TabsTrigger>\n            <TabsTrigger value=\"transactions\">Transaction History</TabsTrigger>\n            <TabsTrigger value=\"analytics\">Analytics</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"details\" className=\"space-y-4\">\n            <Card className=\"border-border\">\n              <CardHeader>\n                <CardTitle>Contact Information</CardTitle>\n                <CardDescription>Customer contact details and communication preferences</CardDescription>\n              </CardHeader>\n              <CardContent className=\"grid gap-4 md:grid-cols-2\">\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium\">Email</p>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{customer.email || 'N/A'}</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium\">Phone</p>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{customer.phone || 'N/A'}</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium\">Company</p>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{customer.company || 'N/A'}</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium\">Segment</p>\n                  </div>\n                  <Badge className={getSegmentColor(customer.segment)}>\n                    {customer.segment || 'Unassigned'}\n                  </Badge>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-border\">\n              <CardHeader>\n                <CardTitle>Address</CardTitle>\n                <CardDescription>Customer location and billing information</CardDescription>\n              </CardHeader>\n              <CardContent>\n                {customer.address ? (\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-start gap-2\">\n                      <MapPin className=\"h-4 w-4 text-muted-foreground mt-1\" />\n                      <div className=\"space-y-1\">\n                        {customer.address.street && <p className=\"text-sm\">{customer.address.street}</p>}\n                        <p className=\"text-sm\">\n                          {[\n                            customer.address.city,\n                            customer.address.state,\n                            customer.address.postal_code,\n                          ]\n                            .filter(Boolean)\n                            .join(', ')}\n                        </p>\n                        {customer.address.country && <p className=\"text-sm\">{customer.address.country}</p>}\n                      </div>\n                    </div>\n                  </div>\n                ) : (\n                  <p className=\"text-sm text-muted-foreground\">No address on file</p>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-border\">\n              <CardHeader>\n                <CardTitle>Timeline</CardTitle>\n                <CardDescription>Key dates and milestones</CardDescription>\n              </CardHeader>\n              <CardContent className=\"grid gap-4 md:grid-cols-2\">\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium\">Acquisition Date</p>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{formatDate(customer.acquisition_date)}</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Activity className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium\">Last Interaction</p>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{formatDate(customer.last_interaction_date)}</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium\">Created At</p>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{formatDate(customer.created_at)}</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                    <p className=\"text-sm font-medium\">Last Updated</p>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">{formatDate(customer.updated_at)}</p>\n                </div>\n              </CardContent>\n            </Card>\n\n            {customer.tags && customer.tags.length > 0 && (\n              <Card className=\"border-border\">\n                <CardHeader>\n                  <CardTitle>Tags</CardTitle>\n                  <CardDescription>Customer classifications and labels</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {customer.tags.map((tag, index) => (\n                      <Badge key={index} variant=\"secondary\">\n                        <Tag className=\"mr-1 h-3 w-3\" />\n                        {tag}\n                      </Badge>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            {customer.metadata && Object.keys(customer.metadata).length > 0 && (\n              <Card className=\"border-border\">\n                <CardHeader>\n                  <CardTitle>Additional Information</CardTitle>\n                  <CardDescription>Custom metadata and properties</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid gap-4 md:grid-cols-2\">\n                    {Object.entries(customer.metadata).map(([key, value]) => (\n                      <div key={key} className=\"space-y-1\">\n                        <p className=\"text-sm font-medium capitalize\">{key.replace(/_/g, ' ')}</p>\n                        <p className=\"text-sm text-muted-foreground\">\n                          {typeof value === 'object' ? JSON.stringify(value) : String(value)}\n                        </p>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"loyalty\" className=\"space-y-4\">\n            {loyalty ? (\n              <>\n                <Card className=\"border-border\">\n                  <CardHeader>\n                    <CardTitle>Loyalty Tier Status</CardTitle>\n                    <CardDescription>Current tier and qualification details</CardDescription>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"space-y-1\">\n                        <p className=\"text-sm font-medium\">Current Tier</p>\n                        <Badge className={`text-lg ${getTierColor(loyalty.current_tier)}`}>\n                          {loyalty.current_tier ? loyalty.current_tier.toUpperCase() : 'NO TIER'}\n                        </Badge>\n                      </div>\n                      <Award className=\"h-12 w-12 text-muted-foreground\" />\n                    </div>\n                    {loyalty.tier_qualified_date && (\n                      <div className=\"space-y-1\">\n                        <p className=\"text-sm font-medium\">Qualified Since</p>\n                        <p className=\"text-sm text-muted-foreground\">{formatDate(loyalty.tier_qualified_date)}</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card className=\"border-border\">\n                  <CardHeader>\n                    <CardTitle>Points Summary</CardTitle>\n                    <CardDescription>Lifetime points activity and current balance</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"grid gap-4 md:grid-cols-3\">\n                      <div className=\"space-y-2\">\n                        <p className=\"text-sm font-medium\">Total Earned</p>\n                        <p className=\"text-2xl font-bold text-green-600\">\n                          +{formatNumber(loyalty.total_points_earned)}\n                        </p>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <p className=\"text-sm font-medium\">Total Redeemed</p>\n                        <p className=\"text-2xl font-bold text-blue-600\">\n                          -{formatNumber(loyalty.total_points_redeemed)}\n                        </p>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <p className=\"text-sm font-medium\">Current Balance</p>\n                        <p className=\"text-2xl font-bold\">{formatNumber(loyalty.points_balance)}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"border-border\">\n                  <CardHeader>\n                    <CardTitle>Referral Activity</CardTitle>\n                    <CardDescription>Customer referral performance</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex items-center gap-4\">\n                      <Users className=\"h-8 w-8 text-muted-foreground\" />\n                      <div>\n                        <p className=\"text-sm font-medium\">Total Referrals</p>\n                        <p className=\"text-2xl font-bold\">{loyalty.referral_count}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                {loyalty.lifetime_value !== null && (\n                  <Card className=\"border-border\">\n                    <CardHeader>\n                      <CardTitle>Loyalty Lifetime Value</CardTitle>\n                      <CardDescription>Total value from loyalty program participation</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"flex items-center gap-4\">\n                        <DollarSign className=\"h-8 w-8 text-muted-foreground\" />\n                        <div>\n                          <p className=\"text-sm font-medium\">Lifetime Value</p>\n                          <p className=\"text-2xl font-bold\">{formatCurrency(loyalty.lifetime_value)}</p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n              </>\n            ) : (\n              <Card className=\"border-border\">\n                <CardContent className=\"pt-6\">\n                  <div className=\"text-center space-y-2\">\n                    <Award className=\"h-12 w-12 text-muted-foreground mx-auto\" />\n                    <p className=\"text-muted-foreground\">This customer is not enrolled in any loyalty program</p>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"transactions\" className=\"space-y-4\">\n            <Card className=\"border-border\">\n              <CardHeader>\n                <CardTitle>Loyalty Transactions</CardTitle>\n                <CardDescription>\n                  {transactions.length > 0\n                    ? `Showing ${transactions.length} transaction${transactions.length !== 1 ? 's' : ''}`\n                    : 'No transactions found'}\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                {transactions.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {transactions.map((transaction) => (\n                      <div key={transaction.id} className=\"flex items-start justify-between border-b pb-4 last:border-0\">\n                        <div className=\"space-y-1\">\n                          <div className=\"flex items-center gap-2\">\n                            <Badge className={getTransactionTypeColor(transaction.transaction_type)}>\n                              {transaction.transaction_type}\n                            </Badge>\n                            <span className=\"text-sm font-medium\">\n                              {transaction.points_amount > 0 ? '+' : ''}\n                              {formatNumber(transaction.points_amount)} points\n                            </span>\n                          </div>\n                          {transaction.description && (\n                            <p className=\"text-sm text-muted-foreground\">{transaction.description}</p>\n                          )}\n                          {transaction.reference_type && transaction.reference_id && (\n                            <p className=\"text-xs text-muted-foreground\">\n                              Ref: {transaction.reference_type} #{transaction.reference_id}\n                            </p>\n                          )}\n                          {transaction.expires_at && (\n                            <p className=\"text-xs text-muted-foreground\">\n                              Expires: {formatDate(transaction.expires_at)}\n                            </p>\n                          )}\n                        </div>\n                        <div className=\"text-right space-y-1\">\n                          <p className=\"text-sm text-muted-foreground\">{formatDateTime(transaction.created_at)}</p>\n                          {transaction.created_by && (\n                            <p className=\"text-xs text-muted-foreground\">By: {transaction.created_by}</p>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 space-y-2\">\n                    <History className=\"h-12 w-12 text-muted-foreground mx-auto\" />\n                    <p className=\"text-muted-foreground\">No transactions recorded yet</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"analytics\" className=\"space-y-4\">\n            <Card className=\"border-border\">\n              <CardHeader>\n                <CardTitle>Customer Insights</CardTitle>\n                <CardDescription>Key metrics and performance indicators</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid gap-4 md:grid-cols-2\">\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n                      <p className=\"text-sm font-medium\">Lifetime Value</p>\n                    </div>\n                    <p className=\"text-2xl font-bold\">{formatCurrency(customer.lifetime_value)}</p>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <Activity className=\"h-4 w-4 text-muted-foreground\" />\n                      <p className=\"text-sm font-medium\">Status</p>\n                    </div>\n                    <Badge className={getStatusColor(customer.status)}>\n                      {customer.status || 'Unknown'}\n                    </Badge>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                      <p className=\"text-sm font-medium\">Segment</p>\n                    </div>\n                    <Badge className={getSegmentColor(customer.segment)}>\n                      {customer.segment || 'Unassigned'}\n                    </Badge>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                      <p className=\"text-sm font-medium\">Days Since Acquisition</p>\n                    </div>\n                    <p className=\"text-2xl font-bold\">\n                      {customer.acquisition_date\n                        ? Math.floor(\n                            (new Date().getTime() - new Date(customer.acquisition_date).getTime()) /\n                              (1000 * 60 * 60 * 24)\n                          )\n                        : 'N/A'}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {loyalty && (\n              <Card className=\"border-border\">\n                <CardHeader>\n                  <CardTitle>Loyalty Metrics</CardTitle>\n                  <CardDescription>Engagement and rewards performance</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid gap-4 md:grid-cols-2\">\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <Award className=\"h-4 w-4 text-muted-foreground\" />\n                        <p className=\"text-sm font-medium\">Redemption Rate</p>\n                      </div>\n                      <p className=\"text-2xl font-bold\">\n                        {loyalty.total_points_earned > 0\n                          ? `${((loyalty.total_points_redeemed / loyalty.total_points_earned) * 100).toFixed(1)}%`\n                          : '0%'}\n                      </p>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <Users className=\"h-4 w-4 text-muted-foreground\" />\n                        <p className=\"text-sm font-medium\">Referral Count</p>\n                      </div>\n                      <p className=\"text-2xl font-bold\">{loyalty.referral_count}</p>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <CreditCard className=\"h-4 w-4 text-muted-foreground\" />\n                        <p className=\"text-sm font-medium\">Available Points</p>\n                      </div>\n                      <p className=\"text-2xl font-bold\">{formatNumber(loyalty.points_balance)}</p>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <Award className=\"h-4 w-4 text-muted-foreground\" />\n                        <p className=\"text-sm font-medium\">Current Tier</p>\n                      </div>\n                      <Badge className={getTierColor(loyalty.current_tier)}>\n                        {loyalty.current_tier || 'No Tier'}\n                      </Badge>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            <Card className=\"border-border\">\n              <CardHeader>\n                <CardTitle>Activity Summary</CardTitle>\n                <CardDescription>Recent customer activity overview</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <History className=\"h-4 w-4 text-muted-foreground\" />\n                      <p className=\"text-sm font-medium\">Total Transactions</p>\n                    </div>\n                    <p className=\"text-lg font-bold\">{transactions.length}</p>\n                  </div>\n                  {transactions.length > 0 && (\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2\">\n                        <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                        <p className=\"text-sm font-medium\">Last Transaction</p>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {formatDate(transactions[0].created_at)}\n                      </p>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n      </div>\n    </AppLayout>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\customers\\new\\page.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":81,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":81,"endColumn":14},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":85,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":85,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'HTMLSelectElement' is not defined.","line":91,"column":87,"nodeType":"Identifier","messageId":"undef","endLine":91,"endColumn":104}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { ArrowLeft, Save, Plus, X } from 'lucide-react';\nimport AppLayout from '@/components/layout/AppLayout';\n\nexport default function NewCustomerPage() {\n  const router = useRouter();\n  const [loading, setLoading] = useState(false);\n  const [formData, setFormData] = useState({\n    name: '',\n    email: '',\n    phone: '',\n    company: '',\n    segment: 'individual',\n    status: 'active',\n    lifetime_value: '',\n    acquisition_date: '',\n    last_interaction_date: '',\n    address: {\n      street: '',\n      city: '',\n      state: '',\n      postal_code: '',\n      country: ''\n    },\n    tags: [] as string[],\n    metadata: {} as Record<string, any>,\n    notes: ''\n  });\n\n  const [tagInput, setTagInput] = useState('');\n  const [metadataKey, setMetadataKey] = useState('');\n  const [metadataValue, setMetadataValue] = useState('');\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setLoading(true);\n\n    try {\n      // Clean up address - only send if at least one field is filled\n      const hasAddress = Object.values(formData.address).some(v => v !== '');\n      const address = hasAddress ? formData.address : null;\n\n      // Clean up metadata - only send if there are entries\n      const metadata = Object.keys(formData.metadata).length > 0 ? formData.metadata : null;\n\n      // Clean up tags - only send if there are entries\n      const tags = formData.tags.length > 0 ? formData.tags : null;\n\n      const payload = {\n        name: formData.name,\n        email: formData.email || null,\n        phone: formData.phone || null,\n        company: formData.company || null,\n        segment: formData.segment,\n        status: formData.status,\n        lifetime_value: formData.lifetime_value ? parseFloat(formData.lifetime_value) : null,\n        acquisition_date: formData.acquisition_date || null,\n        last_interaction_date: formData.last_interaction_date || null,\n        address,\n        tags,\n        metadata,\n        notes: formData.notes || null\n      };\n\n      const response = await fetch('/api/v1/customers', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        router.push('/customers');\n      } else {\n        alert('Error: ' + result.error);\n      }\n    } catch (error) {\n      console.error('Error creating customer:', error);\n      alert('Failed to create customer');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {\n    const { name, value } = e.target;\n    setFormData(prev => ({\n      ...prev,\n      [name]: value\n    }));\n  };\n\n  const handleAddressChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const { name, value } = e.target;\n    setFormData(prev => ({\n      ...prev,\n      address: {\n        ...prev.address,\n        [name]: value\n      }\n    }));\n  };\n\n  const handleAddTag = () => {\n    if (tagInput.trim() && !formData.tags.includes(tagInput.trim())) {\n      setFormData(prev => ({\n        ...prev,\n        tags: [...prev.tags, tagInput.trim()]\n      }));\n      setTagInput('');\n    }\n  };\n\n  const handleRemoveTag = (tagToRemove: string) => {\n    setFormData(prev => ({\n      ...prev,\n      tags: prev.tags.filter(tag => tag !== tagToRemove)\n    }));\n  };\n\n  const handleAddMetadata = () => {\n    if (metadataKey.trim() && metadataValue.trim()) {\n      setFormData(prev => ({\n        ...prev,\n        metadata: {\n          ...prev.metadata,\n          [metadataKey.trim()]: metadataValue.trim()\n        }\n      }));\n      setMetadataKey('');\n      setMetadataValue('');\n    }\n  };\n\n  const handleRemoveMetadata = (keyToRemove: string) => {\n    setFormData(prev => {\n      const newMetadata = { ...prev.metadata };\n      delete newMetadata[keyToRemove];\n      return {\n        ...prev,\n        metadata: newMetadata\n      };\n    });\n  };\n\n  return (\n    <AppLayout\n      title=\"Add New Customer\"\n      breadcrumbs={[\n        { label: 'Customers', href: '/customers' },\n        { label: 'New Customer' },\n      ]}\n    >\n      <div>\n        <p className=\"text-gray-600 mb-6\">Create a new customer record with complete information</p>\n\n        <div className=\"max-w-4xl\">\n          <form onSubmit={handleSubmit} className=\"bg-white rounded-lg shadow p-6 space-y-8\">\n\n            {/* Basic Information Section */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4 pb-2 border-b\">Basic Information</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <label htmlFor=\"name\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Customer Name <span className=\"text-red-500\">*</span>\n                  </label>\n                  <input\n                    type=\"text\"\n                    id=\"name\"\n                    name=\"name\"\n                    value={formData.name}\n                    onChange={handleChange}\n                    required\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"John Doe\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"email\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Email <span className=\"text-red-500\">*</span>\n                  </label>\n                  <input\n                    type=\"email\"\n                    id=\"email\"\n                    name=\"email\"\n                    value={formData.email}\n                    onChange={handleChange}\n                    required\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"john@example.com\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"phone\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Phone\n                  </label>\n                  <input\n                    type=\"tel\"\n                    id=\"phone\"\n                    name=\"phone\"\n                    value={formData.phone}\n                    onChange={handleChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"+1 (555) 123-4567\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"company\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Company\n                  </label>\n                  <input\n                    type=\"text\"\n                    id=\"company\"\n                    name=\"company\"\n                    value={formData.company}\n                    onChange={handleChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"Acme Corp\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            {/* Classification Section */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4 pb-2 border-b\">Classification</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <label htmlFor=\"segment\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Customer Segment\n                  </label>\n                  <select\n                    id=\"segment\"\n                    name=\"segment\"\n                    value={formData.segment}\n                    onChange={handleChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  >\n                    <option value=\"individual\">Individual</option>\n                    <option value=\"startup\">Startup</option>\n                    <option value=\"smb\">SMB (Small/Medium Business)</option>\n                    <option value=\"mid_market\">Mid Market</option>\n                    <option value=\"enterprise\">Enterprise</option>\n                  </select>\n                </div>\n\n                <div>\n                  <label htmlFor=\"status\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Status\n                  </label>\n                  <select\n                    id=\"status\"\n                    name=\"status\"\n                    value={formData.status}\n                    onChange={handleChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  >\n                    <option value=\"prospect\">Prospect</option>\n                    <option value=\"active\">Active</option>\n                    <option value=\"inactive\">Inactive</option>\n                    <option value=\"churned\">Churned</option>\n                    <option value=\"suspended\">Suspended</option>\n                  </select>\n                </div>\n              </div>\n            </div>\n\n            {/* Financial & Timeline Section */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4 pb-2 border-b\">Financial & Timeline</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div>\n                  <label htmlFor=\"lifetime_value\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Lifetime Value ($)\n                  </label>\n                  <input\n                    type=\"number\"\n                    id=\"lifetime_value\"\n                    name=\"lifetime_value\"\n                    value={formData.lifetime_value}\n                    onChange={handleChange}\n                    min=\"0\"\n                    step=\"0.01\"\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"0.00\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"acquisition_date\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Acquisition Date\n                  </label>\n                  <input\n                    type=\"date\"\n                    id=\"acquisition_date\"\n                    name=\"acquisition_date\"\n                    value={formData.acquisition_date}\n                    onChange={handleChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"last_interaction_date\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Last Interaction Date\n                  </label>\n                  <input\n                    type=\"date\"\n                    id=\"last_interaction_date\"\n                    name=\"last_interaction_date\"\n                    value={formData.last_interaction_date}\n                    onChange={handleChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            {/* Address Section */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4 pb-2 border-b\">Address</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"md:col-span-2\">\n                  <label htmlFor=\"street\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Street Address\n                  </label>\n                  <input\n                    type=\"text\"\n                    id=\"street\"\n                    name=\"street\"\n                    value={formData.address.street}\n                    onChange={handleAddressChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"123 Main Street\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"city\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    City\n                  </label>\n                  <input\n                    type=\"text\"\n                    id=\"city\"\n                    name=\"city\"\n                    value={formData.address.city}\n                    onChange={handleAddressChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"New York\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"state\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    State/Province\n                  </label>\n                  <input\n                    type=\"text\"\n                    id=\"state\"\n                    name=\"state\"\n                    value={formData.address.state}\n                    onChange={handleAddressChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"NY\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"postal_code\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Postal Code\n                  </label>\n                  <input\n                    type=\"text\"\n                    id=\"postal_code\"\n                    name=\"postal_code\"\n                    value={formData.address.postal_code}\n                    onChange={handleAddressChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"10001\"\n                  />\n                </div>\n\n                <div>\n                  <label htmlFor=\"country\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Country\n                  </label>\n                  <input\n                    type=\"text\"\n                    id=\"country\"\n                    name=\"country\"\n                    value={formData.address.country}\n                    onChange={handleAddressChange}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"United States\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            {/* Tags Section */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4 pb-2 border-b\">Tags</h3>\n              <div className=\"space-y-3\">\n                <div className=\"flex gap-2\">\n                  <input\n                    type=\"text\"\n                    value={tagInput}\n                    onChange={(e) => setTagInput(e.target.value)}\n                    onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddTag())}\n                    className=\"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"Add a tag (e.g., vip, high-value, referral)\"\n                  />\n                  <button\n                    type=\"button\"\n                    onClick={handleAddTag}\n                    className=\"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2\"\n                  >\n                    <Plus className=\"h-4 w-4\" />\n                    Add Tag\n                  </button>\n                </div>\n                {formData.tags.length > 0 && (\n                  <div className=\"flex flex-wrap gap-2\">\n                    {formData.tags.map((tag, index) => (\n                      <span\n                        key={index}\n                        className=\"inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm\"\n                      >\n                        {tag}\n                        <button\n                          type=\"button\"\n                          onClick={() => handleRemoveTag(tag)}\n                          className=\"hover:text-blue-900\"\n                        >\n                          <X className=\"h-3 w-3\" />\n                        </button>\n                      </span>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* Metadata Section */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4 pb-2 border-b\">Custom Metadata</h3>\n              <div className=\"space-y-3\">\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2\">\n                  <input\n                    type=\"text\"\n                    value={metadataKey}\n                    onChange={(e) => setMetadataKey(e.target.value)}\n                    className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"Key (e.g., referral_source)\"\n                  />\n                  <input\n                    type=\"text\"\n                    value={metadataValue}\n                    onChange={(e) => setMetadataValue(e.target.value)}\n                    onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddMetadata())}\n                    className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                    placeholder=\"Value (e.g., google_ads)\"\n                  />\n                  <button\n                    type=\"button\"\n                    onClick={handleAddMetadata}\n                    className=\"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2\"\n                  >\n                    <Plus className=\"h-4 w-4\" />\n                    Add Metadata\n                  </button>\n                </div>\n                {Object.keys(formData.metadata).length > 0 && (\n                  <div className=\"space-y-2\">\n                    {Object.entries(formData.metadata).map(([key, value]) => (\n                      <div\n                        key={key}\n                        className=\"flex items-center justify-between px-3 py-2 bg-gray-50 rounded-lg border border-gray-200\"\n                      >\n                        <div className=\"flex-1\">\n                          <span className=\"font-medium text-gray-700\">{key}:</span>{' '}\n                          <span className=\"text-gray-600\">{String(value)}</span>\n                        </div>\n                        <button\n                          type=\"button\"\n                          onClick={() => handleRemoveMetadata(key)}\n                          className=\"text-red-600 hover:text-red-800\"\n                        >\n                          <X className=\"h-4 w-4\" />\n                        </button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {/* Notes Section */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-gray-900 mb-4 pb-2 border-b\">Additional Notes</h3>\n              <div>\n                <label htmlFor=\"notes\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Notes\n                </label>\n                <textarea\n                  id=\"notes\"\n                  name=\"notes\"\n                  value={formData.notes}\n                  onChange={handleChange}\n                  rows={4}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                  placeholder=\"Additional information about the customer...\"\n                />\n              </div>\n            </div>\n\n            {/* Form Actions */}\n            <div className=\"flex items-center gap-4 pt-4 border-t\">\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-blue-400 disabled:cursor-not-allowed\"\n              >\n                {loading ? (\n                  <>\n                    <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white\"></div>\n                    Creating...\n                  </>\n                ) : (\n                  <>\n                    <Save className=\"h-5 w-5\" />\n                    Create Customer\n                  </>\n                )}\n              </button>\n\n              <button\n                type=\"button\"\n                onClick={() => router.back()}\n                className=\"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors\"\n              >\n                Cancel\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </AppLayout>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\customers\\page.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":91,"column":19,"nodeType":"Identifier","messageId":"undef","endLine":91,"endColumn":31},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":103,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":103,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useMemo } from 'react';\nimport { useRouter } from 'next/navigation';\nimport {\n  Plus,\n  Search,\n  Download,\n  RefreshCw,\n  Users,\n  TrendingUp,\n  DollarSign,\n  Activity,\n  X,\n} from 'lucide-react';\nimport AppLayout from '@/components/layout/AppLayout';\nimport { CustomerTable } from '@/components/customers/CustomerTable';\nimport { ColumnSelector, ColumnDefinition } from '@/components/customers/ColumnSelector';\nimport { FilterPanel, FilterValue } from '@/components/customers/FilterPanel';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { ExportUtils, ExportColumn } from '@/lib/utils/export';\nimport { toast } from 'sonner';\n\ninterface Customer {\n  id: string;\n  name: string;\n  email: string | null;\n  phone: string | null;\n  company: string | null;\n  segment: string | null;\n  status: string | null;\n  lifetime_value: number | null;\n  acquisition_date: string | null;\n  last_interaction_date: string | null;\n  tags: string[] | null;\n  created_at: string;\n}\n\nconst COLUMN_DEFINITIONS: ColumnDefinition[] = [\n  { id: 'name', label: 'Name', defaultVisible: true },\n  { id: 'email', label: 'Email', defaultVisible: true },\n  { id: 'phone', label: 'Phone', defaultVisible: false },\n  { id: 'company', label: 'Company', defaultVisible: true },\n  { id: 'segment', label: 'Segment', defaultVisible: true },\n  { id: 'status', label: 'Status', defaultVisible: true },\n  { id: 'lifetime_value', label: 'Lifetime Value', defaultVisible: true },\n  { id: 'acquisition_date', label: 'Acquisition Date', defaultVisible: false },\n  { id: 'last_interaction_date', label: 'Last Interaction', defaultVisible: true },\n  { id: 'tags', label: 'Tags', defaultVisible: false },\n];\n\nconst QUICK_FILTERS = [\n  { id: 'active', label: 'Active Customers', filter: { status: ['active'] } },\n  { id: 'high_value', label: 'High Value (>$20k)', filter: { lifetimeValueMin: 20000 } },\n  { id: 'recent', label: 'Recent Activity (30 days)', filter: {} },\n];\n\n/**\n * Customers Page\n *\n * Completely redesigned customer management interface\n * Features:\n * - Advanced data table with TanStack Table\n * - Column show/hide and reordering\n * - Multi-column sorting\n * - Advanced filtering (segment, status, value, dates)\n * - Global search with debouncing\n * - Quick filter pills\n * - Summary statistics with visual indicators\n * - Export to CSV/Excel\n * - Pagination with size selector\n * - Responsive design (mobile/tablet/desktop)\n * - Loading states and error handling\n * - Optimistic UI updates\n */\nexport default function CustomersPage() {\n  const router = useRouter();\n  const [customers, setCustomers] = useState<Customer[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [debouncedSearch, setDebouncedSearch] = useState('');\n  const [filters, setFilters] = useState<FilterValue>({});\n  const [visibleColumns, setVisibleColumns] = useState<string[]>(\n    COLUMN_DEFINITIONS.filter(col => col.defaultVisible).map(col => col.id)\n  );\n  const [refreshing, setRefreshing] = useState(false);\n\n  // Load column preferences from localStorage\n  useEffect(() => {\n    const saved = localStorage.getItem('customerListColumns');\n    if (saved) {\n      try {\n        setVisibleColumns(JSON.parse(saved));\n      } catch (e) {\n        console.error('Failed to parse saved columns:', e);\n      }\n    }\n  }, []);\n\n  // Save column preferences to localStorage\n  useEffect(() => {\n    localStorage.setItem('customerListColumns', JSON.stringify(visibleColumns));\n  }, [visibleColumns]);\n\n  // Debounce search term\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setDebouncedSearch(searchTerm);\n    }, 300);\n\n    return () => clearTimeout(timer);\n  }, [searchTerm]);\n\n  // Fetch customers\n  useEffect(() => {\n    fetchCustomers();\n  }, []);\n\n  const fetchCustomers = async () => {\n    try {\n      setLoading(true);\n      const response = await fetch('/api/v1/customers?limit=1000');\n      const result = await response.json();\n\n      if (result.success) {\n        setCustomers(result.data);\n      } else {\n        toast.error('Failed to fetch customers');\n      }\n    } catch (error) {\n      console.error('Error fetching customers:', error);\n      toast.error('Error loading customers');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleRefresh = async () => {\n    setRefreshing(true);\n    await fetchCustomers();\n    setRefreshing(false);\n    toast.success('Customers refreshed');\n  };\n\n  const handleDeleteCustomer = async (id: string) => {\n    try {\n      const response = await fetch(`/api/v1/customers/${id}`, {\n        method: 'DELETE',\n      });\n\n      if (response.ok) {\n        setCustomers(prev => prev.filter(c => c.id !== id));\n        toast.success('Customer deleted successfully');\n      } else {\n        toast.error('Failed to delete customer');\n      }\n    } catch (error) {\n      console.error('Error deleting customer:', error);\n      toast.error('Error deleting customer');\n    }\n  };\n\n  // Apply filters and search\n  const filteredCustomers = useMemo(() => {\n    let result = [...customers];\n\n    // Apply search\n    if (debouncedSearch) {\n      const search = debouncedSearch.toLowerCase();\n      result = result.filter(\n        c =>\n          c.name.toLowerCase().includes(search) ||\n          c.email?.toLowerCase().includes(search) ||\n          c.company?.toLowerCase().includes(search) ||\n          c.phone?.toLowerCase().includes(search)\n      );\n    }\n\n    // Apply segment filter\n    if (filters.segment && filters.segment.length > 0) {\n      result = result.filter(c => c.segment && filters.segment!.includes(c.segment));\n    }\n\n    // Apply status filter\n    if (filters.status && filters.status.length > 0) {\n      result = result.filter(c => c.status && filters.status!.includes(c.status));\n    }\n\n    // Apply lifetime value range\n    if (filters.lifetimeValueMin !== undefined) {\n      result = result.filter(c => (c.lifetime_value || 0) >= filters.lifetimeValueMin!);\n    }\n    if (filters.lifetimeValueMax !== undefined) {\n      result = result.filter(c => (c.lifetime_value || 0) <= filters.lifetimeValueMax!);\n    }\n\n    // Apply acquisition date range\n    if (filters.acquisitionDateFrom) {\n      result = result.filter(\n        c => c.acquisition_date && new Date(c.acquisition_date) >= new Date(filters.acquisitionDateFrom!)\n      );\n    }\n    if (filters.acquisitionDateTo) {\n      result = result.filter(\n        c => c.acquisition_date && new Date(c.acquisition_date) <= new Date(filters.acquisitionDateTo!)\n      );\n    }\n\n    // Apply last interaction date range\n    if (filters.lastInteractionFrom) {\n      result = result.filter(\n        c =>\n          c.last_interaction_date &&\n          new Date(c.last_interaction_date) >= new Date(filters.lastInteractionFrom!)\n      );\n    }\n    if (filters.lastInteractionTo) {\n      result = result.filter(\n        c =>\n          c.last_interaction_date &&\n          new Date(c.last_interaction_date) <= new Date(filters.lastInteractionTo!)\n      );\n    }\n\n    return result;\n  }, [customers, debouncedSearch, filters]);\n\n  // Calculate statistics\n  const stats = useMemo(() => {\n    const total = customers.length;\n    const active = customers.filter(c => c.status === 'active').length;\n    const totalValue = customers.reduce((sum, c) => sum + (c.lifetime_value || 0), 0);\n    const avgValue = total > 0 ? totalValue / total : 0;\n\n    const segments = customers.reduce((acc, c) => {\n      const seg = c.segment || 'unknown';\n      acc[seg] = (acc[seg] || 0) + 1;\n      return acc;\n    }, {} as Record<string, number>);\n\n    return {\n      total,\n      active,\n      activePercentage: total > 0 ? Math.round((active / total) * 100) : 0,\n      totalValue,\n      avgValue,\n      segments,\n    };\n  }, [customers]);\n\n  // Export handlers\n  const handleExportCSV = () => {\n    const exportColumns: ExportColumn[] = [\n      { key: 'name', label: 'Name' },\n      { key: 'email', label: 'Email' },\n      { key: 'phone', label: 'Phone' },\n      { key: 'company', label: 'Company' },\n      { key: 'segment', label: 'Segment' },\n      { key: 'status', label: 'Status' },\n      {\n        key: 'lifetime_value',\n        label: 'Lifetime Value',\n        format: (v) => ExportUtils.formatCurrency(v),\n      },\n      {\n        key: 'acquisition_date',\n        label: 'Acquisition Date',\n        format: (v) => ExportUtils.formatDate(v),\n      },\n      {\n        key: 'last_interaction_date',\n        label: 'Last Interaction',\n        format: (v) => ExportUtils.formatDate(v),\n      },\n      {\n        key: 'tags',\n        label: 'Tags',\n        format: (v) => ExportUtils.formatArray(v),\n      },\n    ];\n\n    ExportUtils.exportToCSV(filteredCustomers, exportColumns, 'customers');\n    toast.success('Customers exported to CSV');\n  };\n\n  const handleExportExcel = () => {\n    const exportColumns: ExportColumn[] = [\n      { key: 'name', label: 'Name' },\n      { key: 'email', label: 'Email' },\n      { key: 'phone', label: 'Phone' },\n      { key: 'company', label: 'Company' },\n      { key: 'segment', label: 'Segment' },\n      { key: 'status', label: 'Status' },\n      {\n        key: 'lifetime_value',\n        label: 'Lifetime Value',\n        format: (v) => ExportUtils.formatCurrency(v),\n      },\n      {\n        key: 'acquisition_date',\n        label: 'Acquisition Date',\n        format: (v) => ExportUtils.formatDate(v),\n      },\n      {\n        key: 'last_interaction_date',\n        label: 'Last Interaction',\n        format: (v) => ExportUtils.formatDate(v),\n      },\n      {\n        key: 'tags',\n        label: 'Tags',\n        format: (v) => ExportUtils.formatArray(v),\n      },\n    ];\n\n    ExportUtils.exportToExcel(filteredCustomers, exportColumns, 'customers', 'Customers');\n    toast.success('Customers exported to Excel');\n  };\n\n  const handleQuickFilter = (quickFilter: typeof QUICK_FILTERS[0]) => {\n    setFilters(quickFilter.filter);\n  };\n\n  const activeFiltersCount = Object.values(filters).filter(\n    v => v !== undefined && v !== null && (Array.isArray(v) ? v.length > 0 : true)\n  ).length;\n\n  if (loading) {\n    return (\n      <AppLayout title=\"Customers\" breadcrumbs={[{ label: 'Customers' }]}>\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"text-center\">\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\n            <p className=\"text-gray-600\">Loading customers...</p>\n          </div>\n        </div>\n      </AppLayout>\n    );\n  }\n\n  return (\n    <AppLayout\n      title=\"Customers\"\n      breadcrumbs={[{ label: 'Customer Engagement', href: '/' }, { label: 'Customers' }]}\n    >\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900\">Customer Management</h1>\n            <p className=\"text-gray-600 mt-2\">\n              Manage and analyze your customer relationships\n            </p>\n          </div>\n          <Button onClick={() => router.push('/customers/new')} size=\"lg\" className=\"gap-2\">\n            <Plus className=\"h-5 w-5\" />\n            Add Customer\n          </Button>\n        </div>\n\n        {/* Summary Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          <div className=\"bg-background rounded-lg border border-border p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Total Customers</p>\n                <p className=\"text-3xl font-bold mt-2\">{stats.total}</p>\n              </div>\n              <div className=\"h-12 w-12 bg-chart-1/10 rounded-lg flex items-center justify-center\">\n                <Users className=\"h-6 w-6 text-chart-1\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-background rounded-lg border border-border p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Active Customers</p>\n                <p className=\"text-3xl font-bold text-chart-2 mt-2\">{stats.activePercentage}%</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">{stats.active} active</p>\n              </div>\n              <div className=\"h-12 w-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                <Activity className=\"h-6 w-6 text-chart-2\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-background rounded-lg border border-border p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Total Lifetime Value</p>\n                <p className=\"text-2xl font-bold text-chart-3 mt-2\">\n                  {new Intl.NumberFormat('en-US', {\n                    style: 'currency',\n                    currency: 'USD',\n                    notation: 'compact',\n                    maximumFractionDigits: 1,\n                  }).format(stats.totalValue)}\n                </p>\n              </div>\n              <div className=\"h-12 w-12 bg-chart-3/10 rounded-lg flex items-center justify-center\">\n                <DollarSign className=\"h-6 w-6 text-chart-3\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"bg-background rounded-lg border border-border p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Avg Lifetime Value</p>\n                <p className=\"text-2xl font-bold text-chart-4 mt-2\">\n                  {new Intl.NumberFormat('en-US', {\n                    style: 'currency',\n                    currency: 'USD',\n                    notation: 'compact',\n                    maximumFractionDigits: 1,\n                  }).format(stats.avgValue)}\n                </p>\n              </div>\n              <div className=\"h-12 w-12 bg-chart-4/10 rounded-lg flex items-center justify-center\">\n                <TrendingUp className=\"h-6 w-6 text-chart-4\" />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Segment Breakdown */}\n        <div className=\"bg-background rounded-lg border border-border p-6\">\n          <h3 className=\"text-lg font-semibold mb-4\">Customer Segments</h3>\n          <div className=\"flex flex-wrap gap-3\">\n            {Object.entries(stats.segments).map(([segment, count]) => {\n              return (\n                <Badge key={segment} variant=\"secondary\" className=\"px-4 py-2 text-sm font-medium\">\n                  {segment}: {count}\n                </Badge>\n              );\n            })}\n          </div>\n        </div>\n\n        {/* Search, Filters, and Actions */}\n        <div className=\"flex flex-col lg:flex-row gap-4\">\n          {/* Search */}\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-5 w-5\" />\n            <input\n              type=\"text\"\n              placeholder=\"Search customers by name, email, company, or phone...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"w-full pl-10 pr-10 py-2.5 border border-border rounded-lg bg-background focus:ring-2 focus:ring-ring focus:border-transparent\"\n            />\n            {searchTerm && (\n              <button\n                onClick={() => setSearchTerm('')}\n                className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n              >\n                <X className=\"h-5 w-5\" />\n              </button>\n            )}\n          </div>\n\n          {/* Actions */}\n          <div className=\"flex gap-2\">\n            <ColumnSelector\n              columns={COLUMN_DEFINITIONS}\n              visibleColumns={visibleColumns}\n              onVisibilityChange={setVisibleColumns}\n            />\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handleRefresh}\n              disabled={refreshing}\n              className=\"gap-2\"\n            >\n              <RefreshCw className={`h-4 w-4 ${refreshing ? 'animate-spin' : ''}`} />\n              Refresh\n            </Button>\n            <div className=\"relative\">\n              <Button variant=\"outline\" size=\"sm\" className=\"gap-2\" asChild>\n                <div className=\"relative\">\n                  <Download className=\"h-4 w-4\" />\n                  Export\n                  <select\n                    onChange={(e) => {\n                      if (e.target.value === 'csv') handleExportCSV();\n                      if (e.target.value === 'excel') handleExportExcel();\n                      e.target.value = '';\n                    }}\n                    className=\"absolute inset-0 w-full opacity-0 cursor-pointer\"\n                  >\n                    <option value=\"\">Select format</option>\n                    <option value=\"csv\">Export as CSV</option>\n                    <option value=\"excel\">Export as Excel</option>\n                  </select>\n                </div>\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Quick Filters */}\n        <div className=\"flex flex-wrap gap-2\">\n          <span className=\"text-sm font-medium text-gray-700 flex items-center\">\n            Quick Filters:\n          </span>\n          {QUICK_FILTERS.map(qf => (\n            <Button\n              key={qf.id}\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => handleQuickFilter(qf)}\n              className=\"gap-2\"\n            >\n              {qf.label}\n            </Button>\n          ))}\n          {activeFiltersCount > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setFilters({})}\n              className=\"text-red-600 hover:text-red-700\"\n            >\n              Clear Filters ({activeFiltersCount})\n            </Button>\n          )}\n        </div>\n\n        {/* Advanced Filters Panel */}\n        <FilterPanel\n          filters={filters}\n          onFiltersChange={setFilters}\n          onClearFilters={() => setFilters({})}\n        />\n\n        {/* Results Summary */}\n        <div className=\"flex items-center justify-between\">\n          <p className=\"text-sm text-muted-foreground\">\n            Showing <span className=\"font-semibold text-foreground\">{filteredCustomers.length}</span> of{' '}\n            <span className=\"font-semibold text-foreground\">{customers.length}</span> customers\n            {debouncedSearch && (\n              <span className=\"text-muted-foreground\"> matching &quot;{debouncedSearch}&quot;</span>\n            )}\n          </p>\n        </div>\n\n        {/* Customer Table */}\n        <CustomerTable\n          customers={filteredCustomers}\n          visibleColumns={visibleColumns}\n          onDeleteCustomer={handleDeleteCustomer}\n          onRefresh={handleRefresh}\n        />\n      </div>\n    </AppLayout>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\directories\\suppliers\\page.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":222,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":222,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":282,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":282,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":328,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":328,"endColumn":12}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport React, { useState, useEffect } from 'react'\nimport AppLayout from '@/components/layout/AppLayout'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Input } from '@/components/ui/input'\nimport { Badge } from '@/components/ui/badge'\nimport { Button } from '@/components/ui/button'\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from '@/components/ui/dialog'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from '@/components/ui/form'\nimport { useForm } from 'react-hook-form'\nimport type { Resolver } from 'react-hook-form'\nimport * as z from 'zod'\nimport { zodResolver } from '@hookform/resolvers/zod'\nimport {\n  Building2,\n  Search,\n  Plus,\n  Edit,\n  Trash2,\n  MoreVertical,\n  Download,\n  Mail,\n  Phone,\n  User,\n  Save,\n  Loader2,\n} from 'lucide-react'\nimport type { SupplierContact } from '@/types/supplier'\n\ninterface ContactWithSupplier extends SupplierContact {\n  supplierId: string\n  supplierName: string\n  supplierCode: string\n}\n\nconst contactFormSchema = z.object({\n  name: z.string().min(1, 'Name is required'),\n  email: z.string().email('Invalid email').optional().or(z.literal('')),\n  phone: z.string().optional(),\n  mobile: z.string().optional(),\n  title: z.string().optional(),\n  department: z.string().optional(),\n  type: z.enum(['primary', 'billing', 'technical', 'sales', 'support']),\n  isPrimary: z.boolean().default(false),\n  isActive: z.boolean().default(true),\n})\n\ntype ContactFormData = z.infer<typeof contactFormSchema>\n\nexport default function SupplierContactsDirectoryPage() {\n  const [contacts, setContacts] = useState<ContactWithSupplier[]>([])\n  const [suppliers, setSuppliers] = useState<Array<{ id: string; name: string; code: string }>>([])\n  const [loading, setLoading] = useState(true)\n  const [searchQuery, setSearchQuery] = useState('')\n  const [supplierFilter, setSupplierFilter] = useState<string>('all')\n  const [typeFilter, setTypeFilter] = useState<string>('all')\n  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false)\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false)\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false)\n  const [editingContact, setEditingContact] = useState<ContactWithSupplier | null>(null)\n  const [deletingContact, setDeletingContact] = useState<ContactWithSupplier | null>(null)\n  const [submitting, setSubmitting] = useState(false)\n\n  const form = useForm<ContactFormData & { supplierId: string }, any, ContactFormData & { supplierId: string }>({\n    resolver: zodResolver(contactFormSchema.extend({\n      supplierId: z.string().min(1, 'Supplier is required'),\n    })) as Resolver<ContactFormData & { supplierId: string }, any, ContactFormData & { supplierId: string }>,\n    defaultValues: {\n      name: '',\n      email: '',\n      phone: '',\n      mobile: '',\n      title: '',\n      department: '',\n      type: 'primary',\n      isPrimary: false,\n      isActive: true,\n      supplierId: '',\n    },\n  })\n\n  useEffect(() => {\n    fetchData()\n  }, [])\n\n  useEffect(() => {\n    if (editingContact && isEditDialogOpen) {\n      form.reset({\n        name: editingContact.name,\n        email: editingContact.email || '',\n        phone: editingContact.phone || '',\n        mobile: editingContact.mobile || '',\n        title: editingContact.title || '',\n        department: editingContact.department || '',\n        type: editingContact.type || 'primary',\n        isPrimary: editingContact.isPrimary,\n        isActive: editingContact.isActive,\n        supplierId: editingContact.supplierId,\n      })\n    }\n  }, [editingContact, isEditDialogOpen, form])\n\n  const fetchData = async () => {\n    try {\n      setLoading(true)\n      \n      // Fetch suppliers for dropdown\n      const suppliersResponse = await fetch('/api/directories/suppliers')\n      if (!suppliersResponse.ok) throw new Error('Failed to fetch suppliers')\n      const suppliersData = await suppliersResponse.json()\n      \n      if (suppliersData.success) {\n        const suppliersList = (suppliersData.data || []).map((s: any) => ({\n          id: s.id,\n          name: s.name,\n          code: s.code,\n        }))\n        setSuppliers(suppliersList)\n        \n        // Flatten contacts with supplier info\n        const allContacts: ContactWithSupplier[] = []\n        suppliersData.data.forEach((supplier: any) => {\n          (supplier.contacts || []).forEach((contact: SupplierContact) => {\n            allContacts.push({\n              ...contact,\n              supplierId: supplier.id,\n              supplierName: supplier.name,\n              supplierCode: supplier.code,\n            })\n          })\n        })\n        setContacts(allContacts)\n      }\n    } catch (error) {\n      console.error('Error fetching contacts:', error)\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handleAdd = async (data: ContactFormData & { supplierId: string }) => {\n    try {\n      setSubmitting(true)\n      \n      // Get supplier to update\n      const supplierResponse = await fetch(`/api/suppliers/v3/${data.supplierId}`)\n      if (!supplierResponse.ok) throw new Error('Failed to fetch supplier')\n      const supplierData = await supplierResponse.json()\n      \n      if (!supplierData.success) throw new Error('Supplier not found')\n      \n      const supplier = supplierData.data\n      const existingContacts = supplier.contacts || []\n      \n      // Add new contact\n      const newContact = {\n        type: data.type,\n        name: data.name,\n        title: data.title || '',\n        email: data.email || '',\n        phone: data.phone || '',\n        mobile: data.mobile || '',\n        department: data.department || '',\n        isPrimary: data.isPrimary,\n        isActive: data.isActive,\n      }\n      \n      // Update supplier with new contact\n      const updateResponse = await fetch(`/api/suppliers/v3/${data.supplierId}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          contacts: [...existingContacts, newContact],\n        }),\n      })\n\n      if (!updateResponse.ok) throw new Error('Failed to add contact')\n      \n      await fetchData()\n      setIsAddDialogOpen(false)\n      form.reset()\n    } catch (error) {\n      console.error('Error adding contact:', error)\n      alert('Failed to add contact')\n    } finally {\n      setSubmitting(false)\n    }\n  }\n\n  const handleEdit = async (data: ContactFormData & { supplierId: string }) => {\n    if (!editingContact) return\n    \n    try {\n      setSubmitting(true)\n      \n      // Get supplier to update\n      const supplierResponse = await fetch(`/api/suppliers/v3/${data.supplierId}`)\n      if (!supplierResponse.ok) throw new Error('Failed to fetch supplier')\n      const supplierData = await supplierResponse.json()\n      \n      if (!supplierData.success) throw new Error('Supplier not found')\n      \n      const supplier = supplierData.data\n      const existingContacts = (supplier.contacts || []).map((c: any) => ({\n        ...c,\n        id: c.id || editingContact.id,\n      }))\n      \n      // Update the contact\n      const updatedContacts = existingContacts.map((c: any) => \n        String(c.id) === String(editingContact.id)\n          ? {\n              ...c,\n              type: data.type,\n              name: data.name,\n              title: data.title || '',\n              email: data.email || '',\n              phone: data.phone || '',\n              mobile: data.mobile || '',\n              department: data.department || '',\n              isPrimary: data.isPrimary,\n              isActive: data.isActive,\n            }\n          : c\n      )\n      \n      // Update supplier\n      const updateResponse = await fetch(`/api/suppliers/v3/${data.supplierId}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          contacts: updatedContacts,\n        }),\n      })\n\n      if (!updateResponse.ok) throw new Error('Failed to update contact')\n      \n      await fetchData()\n      setIsEditDialogOpen(false)\n      setEditingContact(null)\n      form.reset()\n    } catch (error) {\n      console.error('Error updating contact:', error)\n      alert('Failed to update contact')\n    } finally {\n      setSubmitting(false)\n    }\n  }\n\n  const handleDelete = async () => {\n    if (!deletingContact) return\n    \n    try {\n      setSubmitting(true)\n      \n      // Get supplier to update\n      const supplierResponse = await fetch(`/api/suppliers/v3/${deletingContact.supplierId}`)\n      if (!supplierResponse.ok) throw new Error('Failed to fetch supplier')\n      const supplierData = await supplierResponse.json()\n      \n      if (!supplierData.success) throw new Error('Supplier not found')\n      \n      const supplier = supplierData.data\n      const existingContacts = supplier.contacts || []\n      \n      // Remove the contact (set inactive or remove from array)\n      const updatedContacts = existingContacts\n        .filter((c: any) => String(c.id) !== String(deletingContact.id))\n        .map((c: any) => ({\n          ...c,\n          id: c.id,\n        }))\n      \n      // Update supplier\n      const updateResponse = await fetch(`/api/suppliers/v3/${deletingContact.supplierId}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          contacts: updatedContacts,\n        }),\n      })\n\n      if (!updateResponse.ok) throw new Error('Failed to delete contact')\n      \n      await fetchData()\n      setIsDeleteDialogOpen(false)\n      setDeletingContact(null)\n    } catch (error) {\n      console.error('Error deleting contact:', error)\n      alert('Failed to delete contact')\n    } finally {\n      setSubmitting(false)\n    }\n  }\n\n  const filteredContacts = contacts.filter(contact => {\n    const matchesSearch = !searchQuery || \n      contact.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      contact.email?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      contact.phone?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      contact.supplierName.toLowerCase().includes(searchQuery.toLowerCase())\n    \n    const matchesSupplier = supplierFilter === 'all' || contact.supplierId === supplierFilter\n    const matchesType = typeFilter === 'all' || contact.type === typeFilter\n    \n    return matchesSearch && matchesSupplier && matchesType\n  })\n\n  const activeContacts = contacts.filter(c => c.isActive).length\n  const primaryContacts = contacts.filter(c => c.isPrimary).length\n\n  return (\n    <AppLayout\n      title=\"Supplier Contacts Directory\"\n      breadcrumbs={[\n        { label: 'Business Directories', href: '/directories' },\n        { label: 'Supplier Contacts' },\n      ]}\n    >\n      <div className=\"space-y-6\">\n        {/* Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Contacts</p>\n                  <p className=\"text-2xl font-bold\">{contacts.length}</p>\n                </div>\n                <User className=\"h-8 w-8 text-primary\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Active Contacts</p>\n                  <p className=\"text-2xl font-bold\">{activeContacts}</p>\n                </div>\n                <User className=\"h-8 w-8 text-green-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Primary Contacts</p>\n                  <p className=\"text-2xl font-bold\">{primaryContacts}</p>\n                </div>\n                <User className=\"h-8 w-8 text-purple-500\" />\n              </div>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Suppliers</p>\n                  <p className=\"text-2xl font-bold\">{suppliers.length}</p>\n                </div>\n                <Building2 className=\"h-8 w-8 text-indigo-500\" />\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Filters and Actions */}\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-col md:flex-row gap-4 items-start md:items-center justify-between\">\n              <div className=\"flex flex-1 gap-4 items-center\">\n                <div className=\"relative flex-1 max-w-md\">\n                  <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search contacts...\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    className=\"pl-9\"\n                  />\n                </div>\n                <Select value={supplierFilter} onValueChange={setSupplierFilter}>\n                  <SelectTrigger className=\"w-[200px]\">\n                    <SelectValue placeholder=\"Supplier\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Suppliers</SelectItem>\n                    {suppliers.map(s => (\n                      <SelectItem key={s.id} value={s.id}>\n                        {s.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <Select value={typeFilter} onValueChange={setTypeFilter}>\n                  <SelectTrigger className=\"w-[150px]\">\n                    <SelectValue placeholder=\"Type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Types</SelectItem>\n                    <SelectItem value=\"primary\">Primary</SelectItem>\n                    <SelectItem value=\"billing\">Billing</SelectItem>\n                    <SelectItem value=\"technical\">Technical</SelectItem>\n                    <SelectItem value=\"sales\">Sales</SelectItem>\n                    <SelectItem value=\"support\">Support</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button variant=\"outline\" size=\"sm\">\n                  <Download className=\"h-4 w-4 mr-2\" />\n                  Export\n                </Button>\n                <Button onClick={() => setIsAddDialogOpen(true)}>\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Add Contact\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Table */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Contacts ({filteredContacts.length})</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {loading ? (\n              <div className=\"text-center py-8\">\n                <Loader2 className=\"h-6 w-6 animate-spin mx-auto mb-2\" />\n                <p className=\"text-muted-foreground\">Loading contacts...</p>\n              </div>\n            ) : filteredContacts.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <User className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">No contacts found</h3>\n                <p className=\"text-muted-foreground mb-4\">\n                  {searchQuery || supplierFilter !== 'all' || typeFilter !== 'all'\n                    ? 'Try adjusting your filters'\n                    : 'Get started by adding your first contact'}\n                </p>\n                {!searchQuery && supplierFilter === 'all' && typeFilter === 'all' && (\n                  <Button onClick={() => setIsAddDialogOpen(true)}>\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Add Contact\n                  </Button>\n                )}\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Contact</TableHead>\n                    <TableHead>Supplier</TableHead>\n                    <TableHead>Title</TableHead>\n                    <TableHead>Email</TableHead>\n                    <TableHead>Phone</TableHead>\n                    <TableHead>Type</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredContacts.map((contact) => (\n                    <TableRow key={`${contact.supplierId}-${contact.id}`}>\n                      <TableCell>\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                            <User className=\"h-5 w-5 text-primary\" />\n                          </div>\n                          <div>\n                            <div className=\"font-medium\">{contact.name}</div>\n                            {contact.department && (\n                              <div className=\"text-sm text-muted-foreground\">{contact.department}</div>\n                            )}\n                          </div>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <div>\n                          <div className=\"font-medium\">{contact.supplierName}</div>\n                          <code className=\"text-xs bg-secondary px-1 py-0.5 rounded\">{contact.supplierCode}</code>\n                        </div>\n                      </TableCell>\n                      <TableCell>{contact.title || 'N/A'}</TableCell>\n                      <TableCell>\n                        {contact.email ? (\n                          <div className=\"flex items-center gap-2\">\n                            <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                            {contact.email}\n                          </div>\n                        ) : (\n                          'N/A'\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        {contact.phone ? (\n                          <div className=\"flex items-center gap-2\">\n                            <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                            {contact.phone}\n                          </div>\n                        ) : (\n                          'N/A'\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">{contact.type || 'primary'}</Badge>\n                        {contact.isPrimary && (\n                          <Badge variant=\"outline\" className=\"ml-2 text-xs\">Primary</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell>\n                        <Badge\n                          className={\n                            contact.isActive\n                              ? 'bg-success/10 text-success border-success/20'\n                              : 'bg-secondary text-secondary-foreground border-border'\n                          }\n                          variant=\"outline\"\n                        >\n                          {contact.isActive ? 'Active' : 'Inactive'}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <Button variant=\"ghost\" size=\"sm\">\n                              <MoreVertical className=\"h-4 w-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuLabel>Actions</DropdownMenuLabel>\n                            <DropdownMenuSeparator />\n                            <DropdownMenuItem\n                              onClick={() => {\n                                setEditingContact(contact)\n                                setIsEditDialogOpen(true)\n                              }}\n                            >\n                              <Edit className=\"h-4 w-4 mr-2\" />\n                              Edit\n                            </DropdownMenuItem>\n                            <DropdownMenuSeparator />\n                            <DropdownMenuItem\n                              className=\"text-red-600\"\n                              onClick={() => {\n                                setDeletingContact(contact)\n                                setIsDeleteDialogOpen(true)\n                              }}\n                            >\n                              <Trash2 className=\"h-4 w-4 mr-2\" />\n                              Delete\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Add Contact Dialog */}\n      <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Add New Contact</DialogTitle>\n            <DialogDescription>\n              Add a new contact to a supplier\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(handleAdd)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"supplierId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Supplier *</FormLabel>\n                    <Select onValueChange={field.onChange} defaultValue={field.value}>\n                      <FormControl>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Select supplier\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {suppliers.map(s => (\n                          <SelectItem key={s.id} value={s.id}>\n                            {s.name} ({s.code})\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Name *</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"John Doe\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"email\" placeholder=\"john@example.com\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"phone\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Phone</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"+1 234 567 8900\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Title</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"Manager\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"department\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Department</FormLabel>\n                      <FormControl>\n                        <Input {...field} placeholder=\"Sales\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"type\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Contact Type</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Select type\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"primary\">Primary</SelectItem>\n                          <SelectItem value=\"billing\">Billing</SelectItem>\n                          <SelectItem value=\"technical\">Technical</SelectItem>\n                          <SelectItem value=\"sales\">Sales</SelectItem>\n                          <SelectItem value=\"support\">Support</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"isPrimary\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-col justify-end\">\n                      <div className=\"flex items-center space-x-2 pt-2\">\n                        <input\n                          type=\"checkbox\"\n                          checked={field.value}\n                          onChange={field.onChange}\n                          className=\"rounded border-gray-300\"\n                        />\n                        <FormLabel className=\"!mt-0\">Primary Contact</FormLabel>\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsAddDialogOpen(false)\n                    form.reset()\n                  }}\n                >\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={submitting}>\n                  {submitting ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Saving...\n                    </>\n                  ) : (\n                    <>\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Add Contact\n                    </>\n                  )}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Contact Dialog */}\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Edit Contact</DialogTitle>\n            <DialogDescription>\n              Update contact information\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(handleEdit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"supplierId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Supplier *</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Select supplier\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {suppliers.map(s => (\n                          <SelectItem key={s.id} value={s.id}>\n                            {s.name} ({s.code})\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Name *</FormLabel>\n                    <FormControl>\n                      <Input {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"email\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"phone\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Phone</FormLabel>\n                      <FormControl>\n                        <Input {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"title\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Title</FormLabel>\n                      <FormControl>\n                        <Input {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"department\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Department</FormLabel>\n                      <FormControl>\n                        <Input {...field} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"type\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Contact Type</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value}>\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"Select type\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"primary\">Primary</SelectItem>\n                          <SelectItem value=\"billing\">Billing</SelectItem>\n                          <SelectItem value=\"technical\">Technical</SelectItem>\n                          <SelectItem value=\"sales\">Sales</SelectItem>\n                          <SelectItem value=\"support\">Support</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={form.control}\n                  name=\"isPrimary\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-col justify-end\">\n                      <div className=\"flex items-center space-x-2 pt-2\">\n                        <input\n                          type=\"checkbox\"\n                          checked={field.value}\n                          onChange={field.onChange}\n                          className=\"rounded border-gray-300\"\n                        />\n                        <FormLabel className=\"!mt-0\">Primary Contact</FormLabel>\n                      </div>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsEditDialogOpen(false)\n                    setEditingContact(null)\n                    form.reset()\n                  }}\n                >\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={submitting}>\n                  {submitting ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Saving...\n                    </>\n                  ) : (\n                    <>\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Save Changes\n                    </>\n                  )}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation */}\n      <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Contact</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete contact \"{deletingContact?.name}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setIsDeleteDialogOpen(false)\n                setDeletingContact(null)\n              }}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleDelete}\n              variant=\"destructive\"\n              disabled={submitting}\n            >\n              {submitting ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Deleting...\n                </>\n              ) : (\n                <>\n                  <Trash2 className=\"h-4 w-4 mr-2\" />\n                  Delete\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </AppLayout>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\integrations\\woocommerce\\page.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":113,"column":52,"nodeType":"Identifier","messageId":"undef","endLine":113,"endColumn":64},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":140,"column":22,"nodeType":"Identifier","messageId":"undef","endLine":140,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":152,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":152,"endColumn":17}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useState, useEffect } from \"react\";\nimport { ShoppingBag, RefreshCw, Settings, AlertCircle, CheckCircle2, Package, ShoppingCart, Users, Save, TestTube2, Clock, XCircle, Loader2, Play, Square, Eye } from \"lucide-react\";\nimport AppLayout from '@/components/layout/AppLayout';\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport SyncPreview from \"@/components/integrations/SyncPreview\";\nimport ProgressTracker from \"@/components/integrations/ProgressTracker\";\nimport ActivityLog from \"@/components/integrations/ActivityLog\";\nimport { useSyncManager } from \"@/hooks/useSyncManager\";\nimport { useAuth } from '@/lib/auth/auth-context'\n\ninterface WooCommerceConfig {\n  id?: string;\n  name: string;\n  store_url: string;\n  consumer_key: string;\n  consumer_secret: string;\n  status: 'active' | 'inactive' | 'error';\n  auto_sync_products: boolean;\n  auto_import_orders: boolean;\n  sync_customers: boolean;\n  sync_frequency: number;\n}\n\ninterface SyncProgress {\n  entityType: 'products' | 'orders' | 'customers';\n  status: 'idle' | 'syncing' | 'completed' | 'error';\n  processed: number;\n  total: number;\n  created: number;\n  updated: number;\n  failed: number;\n  startTime?: number;\n  endTime?: number;\n  error?: string;\n}\n\ninterface SyncHistoryEntry {\n  id: string;\n  entityType: 'products' | 'orders' | 'customers';\n  status: 'success' | 'partial' | 'failed';\n  timestamp: string;\n  processed: number;\n  created: number;\n  updated: number;\n  failed: number;\n  duration: number;\n  error?: string;\n}\n\nconst ENTITY_ICONS = {\n  products: Package,\n  orders: ShoppingCart,\n  customers: Users,\n};\n\nconst ENTITY_LABELS = {\n  products: 'Products',\n  orders: 'Orders',\n  customers: 'Customers',\n};\n\nexport default function WooCommercePage() {\n  const { toast } = useToast();\n  const [config, setConfig] = useState<WooCommerceConfig>({\n    name: 'WooCommerce Store',\n    store_url: '',\n    consumer_key: '',\n    consumer_secret: '',\n    status: 'inactive',\n    auto_sync_products: true,\n    auto_import_orders: true,\n    sync_customers: false,\n    sync_frequency: 60,\n  });\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [testing, setTesting] = useState(false);\n\n  // Real-time sync state\n  const [syncProgress, setSyncProgress] = useState<Record<string, SyncProgress>>({\n    products: { entityType: 'products', status: 'idle', processed: 0, total: 0, created: 0, updated: 0, failed: 0 },\n    orders: { entityType: 'orders', status: 'idle', processed: 0, total: 0, created: 0, updated: 0, failed: 0 },\n    customers: { entityType: 'customers', status: 'idle', processed: 0, total: 0, created: 0, updated: 0, failed: 0 },\n  });\n\n  const [syncHistory, setSyncHistory] = useState<SyncHistoryEntry[]>([]);\n  const [syncAllInProgress, setSyncAllInProgress] = useState(false);\n\n  // Sync preview and progress management\n  const syncManager = useSyncManager();\n  const { user, isLoading } = useAuth()\n  const [orgId, setOrgId] = useState<string | null>(null)\n\n  useEffect(() => {\n    if (isLoading) return\n    if (user?.org_id) {\n      setOrgId(user.org_id)\n      return\n    }\n    // Fallback: use default org or stored org to avoid 404/HTML parse\n    const stored = typeof window !== 'undefined' ? localStorage.getItem('orgId') : null\n    setOrgId(stored || 'org-default')\n  }, [user, isLoading])\n\n  useEffect(() => {\n    fetchConfiguration();\n    loadSyncHistory();\n  }, []);\n\n  const fetchConfiguration = async () => {\n    try {\n      const response = await fetch('/api/v1/integrations/woocommerce');\n      const data = await response.json();\n\n      if (data.success && data.data) {\n        setConfig(data.data);\n      }\n    } catch (error) {\n      console.error('Error fetching configuration:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadSyncHistory = () => {\n    // Load from localStorage for now (can be replaced with API call)\n    try {\n      const stored = localStorage.getItem('woo_sync_history');\n      if (stored) {\n        setSyncHistory(JSON.parse(stored));\n      }\n    } catch (error) {\n      console.error('Error loading sync history:', error);\n    }\n  };\n\n  const saveSyncHistory = (entry: SyncHistoryEntry) => {\n    const updated = [entry, ...syncHistory].slice(0, 50); // Keep last 50 entries\n    setSyncHistory(updated);\n    localStorage.setItem('woo_sync_history', JSON.stringify(updated));\n  };\n\n  const handleSaveConfiguration = async () => {\n    setSaving(true);\n    try {\n      const response = await fetch('/api/v1/integrations/woocommerce', {\n        method: config.id ? 'PUT' : 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(config),\n      });\n\n      const data = await response.json();\n\n      if (data.success) {\n        setConfig(data.data);\n        toast({\n          title: \"Configuration Saved\",\n          description: \"WooCommerce integration settings have been updated successfully.\",\n        });\n      } else {\n        throw new Error(data.error || 'Failed to save configuration');\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleTestConnection = async () => {\n    setTesting(true);\n    try {\n      const response = await fetch('/api/v1/integrations/woocommerce/test', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          store_url: config.store_url,\n          consumer_key: config.consumer_key,\n          consumer_secret: config.consumer_secret,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (data.success) {\n        toast({\n          title: \"Connection Successful\",\n          description: \"Successfully connected to WooCommerce store.\",\n        });\n        setConfig(prev => ({ ...prev, status: 'active' }));\n      } else {\n        throw new Error(data.error || 'Connection test failed');\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Connection Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      setConfig(prev => ({ ...prev, status: 'error' }));\n    } finally {\n      setTesting(false);\n    }\n  };\n\n  const handleSync = async (entityType: 'products' | 'orders' | 'customers') => {\n    try {\n      // Validate configuration exists\n      if (!config.id || !config.store_url || !config.consumer_key || !config.consumer_secret) {\n        toast({\n          title: \"Configuration Missing\",\n          description: \"Please save your WooCommerce configuration before syncing.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      // Get organization ID\n      let orgId: string;\n      try {\n        const orgResponse = await fetch('/api/v1/organizations/current');\n        const orgData = await orgResponse.json();\n\n        if (!orgData.success || !orgData.data?.id) {\n          throw new Error('Failed to get organization ID');\n        }\n\n        orgId = orgData.data.id;\n      } catch (error) {\n        toast({\n          title: \"Organization Error\",\n          description: \"Could not determine your organization. Please contact support.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n\n      // Initialize sync progress\n      const startTime = Date.now();\n      setSyncProgress(prev => ({\n        ...prev,\n        [entityType]: {\n          entityType,\n          status: 'syncing',\n          processed: 0,\n          total: 0,\n          created: 0,\n          updated: 0,\n          failed: 0,\n          startTime,\n        }\n      }));\n\n      // Prepare the request payload\n      const payload = {\n        config: {\n          url: config.store_url,\n          consumerKey: config.consumer_key,\n          consumerSecret: config.consumer_secret,\n        },\n        org_id: orgId,\n        options: {\n          limit: 100,\n        },\n      };\n\n      const response = await fetch(`/api/v1/integrations/woocommerce/sync/${entityType}`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(payload),\n      });\n\n      const data = await response.json();\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n\n      if (data.success) {\n        // Update sync progress\n        setSyncProgress(prev => ({\n          ...prev,\n          [entityType]: {\n            entityType,\n            status: 'completed',\n            processed: data.data.customersProcessed || data.data.productsProcessed || data.data.ordersProcessed || 0,\n            total: data.data.customersProcessed || data.data.productsProcessed || data.data.ordersProcessed || 0,\n            created: data.data.customersCreated || data.data.productsCreated || data.data.ordersCreated || 0,\n            updated: data.data.customersUpdated || data.data.productsUpdated || data.data.ordersUpdated || 0,\n            failed: data.data.errors?.length || 0,\n            startTime,\n            endTime,\n          }\n        }));\n\n        // Save to history\n        const historyEntry: SyncHistoryEntry = {\n          id: `${entityType}-${Date.now()}`,\n          entityType,\n          status: data.data.errors?.length > 0 ? 'partial' : 'success',\n          timestamp: new Date().toISOString(),\n          processed: data.data.customersProcessed || data.data.productsProcessed || data.data.ordersProcessed || 0,\n          created: data.data.customersCreated || data.data.productsCreated || data.data.ordersCreated || 0,\n          updated: data.data.customersUpdated || data.data.productsUpdated || data.data.ordersUpdated || 0,\n          failed: data.data.errors?.length || 0,\n          duration,\n          error: data.data.errors?.length > 0 ? `${data.data.errors.length} errors occurred` : undefined,\n        };\n        saveSyncHistory(historyEntry);\n\n        toast({\n          title: \"Sync Completed\",\n          description: data.message || `${entityType} sync has been completed successfully.`,\n        });\n      } else {\n        throw new Error(data.error);\n      }\n    } catch (error: any) {\n      const endTime = Date.now();\n      const startTime = syncProgress[entityType].startTime || endTime;\n\n      setSyncProgress(prev => ({\n        ...prev,\n        [entityType]: {\n          ...prev[entityType],\n          status: 'error',\n          error: error.message,\n          endTime,\n        }\n      }));\n\n      // Save error to history\n      const historyEntry: SyncHistoryEntry = {\n        id: `${entityType}-${Date.now()}`,\n        entityType,\n        status: 'failed',\n        timestamp: new Date().toISOString(),\n        processed: 0,\n        created: 0,\n        updated: 0,\n        failed: 0,\n        duration: endTime - startTime,\n        error: error.message,\n      };\n      saveSyncHistory(historyEntry);\n\n      toast({\n        title: \"Sync Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleSyncAll = async () => {\n    setSyncAllInProgress(true);\n    try {\n      await handleSync('products');\n      await handleSync('orders');\n      await handleSync('customers');\n\n      toast({\n        title: \"All Syncs Completed\",\n        description: \"All entities have been synced successfully.\",\n      });\n    } catch (error: any) {\n      toast({\n        title: \"Sync Error\",\n        description: \"Some syncs may have failed. Check sync history for details.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSyncAllInProgress(false);\n    }\n  };\n\n  const handlePreviewSync = (entityType: string) => {\n    syncManager.openPreview('woocommerce', entityType);\n  };\n\n  const handleSyncConfirmed = async (config: any) => {\n    syncManager.closePreview();\n    // Generate job ID and start progress tracking\n    const jobId = `sync_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    syncManager.startProgress(jobId, 'woocommerce', config.entityType || 'unknown');\n\n    // Trigger actual sync\n    try {\n      // Call sync API with job ID\n      const response = await fetch('/api/v1/integrations/sync/orchestrate', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          jobId,\n          syncType: 'woocommerce',\n          entityType: config.entityType,\n          includeNew: config.includeNew,\n          includeUpdated: config.includeUpdated,\n          includeDeleted: config.includeDeleted,\n          selectedIds: config.selectedIds,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to start sync');\n      }\n    } catch (error) {\n      toast({\n        title: 'Sync Error',\n        description: error instanceof Error ? error.message : 'Failed to start sync',\n        variant: 'destructive',\n      });\n      syncManager.resetSync();\n    }\n  };\n\n  const calculateProgress = (progress: SyncProgress): number => {\n    if (progress.total === 0) return 0;\n    return Math.round((progress.processed / progress.total) * 100);\n  };\n\n  const calculateEstimatedTime = (progress: SyncProgress): string => {\n    if (!progress.startTime || progress.processed === 0) return 'Calculating...';\n\n    const elapsed = Date.now() - progress.startTime;\n    const avgTimePerItem = elapsed / progress.processed;\n    const remaining = (progress.total - progress.processed) * avgTimePerItem;\n\n    const seconds = Math.ceil(remaining / 1000);\n    if (seconds < 60) return `${seconds}s`;\n    const minutes = Math.floor(seconds / 60);\n    return `${minutes}m ${seconds % 60}s`;\n  };\n\n  const formatDuration = (ms: number): string => {\n    const seconds = Math.floor(ms / 1000);\n    if (seconds < 60) return `${seconds}s`;\n    const minutes = Math.floor(seconds / 60);\n    return `${minutes}m ${seconds % 60}s`;\n  };\n\n  const formatTimestamp = (timestamp: string): string => {\n    const date = new Date(timestamp);\n    return date.toLocaleString();\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'success':\n        return <Badge variant=\"default\" className=\"bg-green-500\"><CheckCircle2 className=\"h-3 w-3 mr-1\" />Success</Badge>;\n      case 'partial':\n        return <Badge variant=\"secondary\"><AlertCircle className=\"h-3 w-3 mr-1\" />Partial</Badge>;\n      case 'failed':\n        return <Badge variant=\"destructive\"><XCircle className=\"h-3 w-3 mr-1\" />Failed</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  if (loading) {\n    return (\n      <AppLayout\n        title=\"WooCommerce Integration\"\n        breadcrumbs={[\n          { label: \"Integrations\", href: \"/integrations\" },\n          { label: \"WooCommerce\" },\n        ]}\n      >\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900\"></div>\n        </div>\n      </AppLayout>\n    );\n  }\n\n  return (\n    <AppLayout\n      title=\"WooCommerce Integration\"\n      breadcrumbs={[\n        { label: \"Integrations\", href: \"/integrations\" },\n        { label: \"WooCommerce\" },\n      ]}\n    >\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"bg-gradient-to-r from-primary to-primary/80 dark:from-primary dark:to-primary/90 rounded-xl p-6 shadow-lg\">\n          <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"flex h-16 w-16 items-center justify-center rounded-xl bg-white/20 backdrop-blur-sm shadow-lg\">\n                <ShoppingBag className=\"h-8 w-8 text-white\" />\n              </div>\n              <div>\n                <h2 className=\"text-2xl font-bold text-white\">WooCommerce Store</h2>\n                <p className=\"text-white/90 text-sm mt-1\">\n                  {config.store_url || 'Not configured'}\n                </p>\n              </div>\n            </div>\n\n            <Badge\n              variant={config.status === 'active' ? 'default' : config.status === 'error' ? 'destructive' : 'secondary'}\n              className={`text-sm px-4 py-2 ${\n                config.status === 'active'\n                  ? 'bg-success hover:bg-success/90 text-success-foreground shadow-md'\n                  : config.status === 'error'\n                  ? 'bg-destructive hover:bg-destructive/90 text-destructive-foreground shadow-md'\n                  : 'bg-warning hover:bg-warning/90 text-warning-foreground shadow-md'\n              }`}\n            >\n              {config.status === 'active' ? (\n                <>\n                  <CheckCircle2 className=\"mr-2 h-4 w-4\" />\n                  Connected\n                </>\n              ) : config.status === 'error' ? (\n                <>\n                  <AlertCircle className=\"mr-2 h-4 w-4\" />\n                  Connection Error\n                </>\n              ) : (\n                <>\n                  <AlertCircle className=\"mr-2 h-4 w-4\" />\n                  Not Connected\n                </>\n              )}\n            </Badge>\n          </div>\n        </div>\n\n        {/* Tabs */}\n        <Tabs defaultValue=\"sync\" className=\"space-y-6\">\n          <TabsList>\n            <TabsTrigger value=\"sync\">Sync & Operations</TabsTrigger>\n            <TabsTrigger value=\"configuration\">Configuration</TabsTrigger>\n            <TabsTrigger value=\"settings\">Settings</TabsTrigger>\n            <TabsTrigger value=\"history\">Sync History</TabsTrigger>\n          </TabsList>\n\n          {/* Sync Tab - ENHANCED */}\n          <TabsContent value=\"sync\" className=\"space-y-6\">\n            {/* Sync All Button */}\n            <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-gradient-to-r from-accent/20 to-accent/10 dark:from-accent/10 dark:to-accent/5 p-6 rounded-lg border border-accent/30 dark:border-accent/20\">\n              <div className=\"flex-1\">\n                <h3 className=\"text-xl font-bold text-foreground\">Data Synchronization</h3>\n                <p className=\"text-sm text-muted-foreground mt-1\">Sync data between WooCommerce and MantisNXT in real-time</p>\n              </div>\n              <Button\n                onClick={handleSyncAll}\n                disabled={config.status !== 'active' || syncAllInProgress}\n                size=\"lg\"\n                className=\"bg-gradient-to-r from-primary to-primary/90 hover:from-primary/90 hover:to-primary/80 text-primary-foreground shadow-lg hover:shadow-xl transition-all duration-200\"\n              >\n                {syncAllInProgress ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Syncing All...\n                  </>\n                ) : (\n                  <>\n                    <Play className=\"mr-2 h-4 w-4\" />\n                    Sync All Entities\n                  </>\n                )}\n              </Button>\n            </div>\n\n            {/* Enhanced Sync Cards */}\n            <div className=\"grid gap-6 md:grid-cols-3\">\n              {(['products', 'orders', 'customers'] as const).map((entityType) => {\n                const progress = syncProgress[entityType];\n                const Icon = ENTITY_ICONS[entityType];\n                const label = ENTITY_LABELS[entityType];\n                const percentage = calculateProgress(progress);\n\n                return (\n                  <Card key={entityType} className=\"overflow-hidden border-2 hover:border-primary/50 transition-all duration-200 hover:shadow-lg\">\n                    <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-3 bg-gradient-to-br from-secondary/50 to-secondary/30 dark:from-secondary/20 dark:to-secondary/10\">\n                      <CardTitle className=\"text-base font-bold\">{label}</CardTitle>\n                      <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                        <Icon className=\"h-5 w-5 text-primary\" />\n                      </div>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4 pt-6\">\n                      {progress.status === 'syncing' ? (\n                        <>\n                          <div className=\"space-y-3\">\n                            <div className=\"flex justify-between text-xs font-semibold\">\n                              <span className=\"text-primary\">Syncing...</span>\n                              <span className=\"text-2xl font-bold text-primary\">{percentage}%</span>\n                            </div>\n                            <Progress value={percentage} className=\"h-3 bg-primary/10\" />\n                            <div className=\"flex justify-between text-xs\">\n                              <span className=\"font-medium text-foreground\">\n                                {progress.processed.toLocaleString()} / {progress.total > 0 ? progress.total.toLocaleString() : '...'}\n                              </span>\n                              <span className=\"font-medium text-muted-foreground\">\n                                <Clock className=\"h-3 w-3 inline mr-1\" />\n                                {calculateEstimatedTime(progress)}\n                              </span>\n                            </div>\n                          </div>\n\n                          <div className=\"grid grid-cols-3 gap-3 pt-2\">\n                            <div className=\"text-center p-2 bg-success/10 rounded-lg\">\n                              <div className=\"text-xs text-success font-medium\">Created</div>\n                              <div className=\"text-lg font-bold text-success\">{progress.created}</div>\n                            </div>\n                            <div className=\"text-center p-2 bg-primary/10 rounded-lg\">\n                              <div className=\"text-xs text-primary font-medium\">Updated</div>\n                              <div className=\"text-lg font-bold text-primary\">{progress.updated}</div>\n                            </div>\n                            <div className=\"text-center p-2 bg-destructive/10 rounded-lg\">\n                              <div className=\"text-xs text-destructive font-medium\">Failed</div>\n                              <div className=\"text-lg font-bold text-destructive\">{progress.failed}</div>\n                            </div>\n                          </div>\n\n                          <div className=\"flex items-center justify-center gap-2 text-sm font-medium text-primary bg-primary/10 py-2 rounded-lg\">\n                            <Loader2 className=\"h-4 w-4 animate-spin\" />\n                            Processing {label.toLowerCase()}...\n                          </div>\n                        </>\n                      ) : progress.status === 'completed' ? (\n                        <>\n                          <div className=\"text-center py-3 bg-success/10 rounded-lg\">\n                            <CheckCircle2 className=\"h-12 w-12 text-success mx-auto mb-2 animate-pulse\" />\n                            <p className=\"text-base font-bold text-success\">Sync Completed</p>\n                            <p className=\"text-xs text-success/80 mt-1 font-medium\">\n                              <Clock className=\"h-3 w-3 inline mr-1\" />\n                              {formatDuration((progress.endTime || 0) - (progress.startTime || 0))}\n                            </p>\n                          </div>\n\n                          <div className=\"grid grid-cols-3 gap-3\">\n                            <div className=\"text-center p-2 bg-success/10 rounded-lg border border-success/20\">\n                              <div className=\"text-xs text-success font-medium\">Created</div>\n                              <div className=\"text-xl font-bold text-success\">{progress.created}</div>\n                            </div>\n                            <div className=\"text-center p-2 bg-primary/10 rounded-lg border border-primary/20\">\n                              <div className=\"text-xs text-primary font-medium\">Updated</div>\n                              <div className=\"text-xl font-bold text-primary\">{progress.updated}</div>\n                            </div>\n                            <div className=\"text-center p-2 bg-destructive/10 rounded-lg border border-destructive/20\">\n                              <div className=\"text-xs text-destructive font-medium\">Failed</div>\n                              <div className=\"text-xl font-bold text-destructive\">{progress.failed}</div>\n                            </div>\n                          </div>\n                        </>\n                      ) : progress.status === 'error' ? (\n                        <>\n                          <div className=\"text-center py-3 bg-destructive/10 rounded-lg\">\n                            <XCircle className=\"h-12 w-12 text-destructive mx-auto mb-2\" />\n                            <p className=\"text-base font-bold text-destructive\">Sync Failed</p>\n                            <p className=\"text-xs text-destructive/80 mt-2 px-2 leading-relaxed\">\n                              {progress.error}\n                            </p>\n                          </div>\n                        </>\n                      ) : (\n                        <>\n                          <div className=\"text-center py-6\">\n                            <div className=\"relative mx-auto w-20 h-20 mb-3\">\n                              <div className=\"absolute inset-0 rounded-full bg-gradient-to-br from-secondary to-secondary/80 flex items-center justify-center\">\n                                <Icon className=\"h-10 w-10 text-muted-foreground\" />\n                              </div>\n                            </div>\n                            <p className=\"text-sm font-semibold text-foreground\">Ready to Sync</p>\n                            <p className=\"text-xs text-muted-foreground mt-1\">\n                              Click below to start synchronization\n                            </p>\n                          </div>\n                        </>\n                      )}\n\n                      <div className=\"flex gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          className=\"flex-1\"\n                          onClick={() => handlePreviewSync(entityType)}\n                          disabled={config.status !== 'active' || progress.status === 'syncing'}\n                        >\n                          <Eye className=\"mr-2 h-4 w-4\" />\n                          Preview\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          className={`flex-1 font-semibold transition-all duration-200 ${\n                            progress.status === 'syncing'\n                              ? 'bg-primary hover:bg-primary/90'\n                              : progress.status === 'completed'\n                              ? 'bg-success hover:bg-success/90'\n                              : progress.status === 'error'\n                              ? 'bg-destructive hover:bg-destructive/90'\n                              : 'bg-primary hover:bg-primary/90'\n                          }`}\n                          onClick={() => handleSync(entityType)}\n                          disabled={config.status !== 'active' || progress.status === 'syncing'}\n                        >\n                        {progress.status === 'syncing' ? (\n                          <>\n                            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                            Syncing...\n                          </>\n                        ) : progress.status === 'completed' ? (\n                          <>\n                            <CheckCircle2 className=\"mr-2 h-4 w-4\" />\n                            Sync Again\n                          </>\n                        ) : progress.status === 'error' ? (\n                          <>\n                            <RefreshCw className=\"mr-2 h-4 w-4\" />\n                            Retry Sync\n                          </>\n                        ) : (\n                          <>\n                            <Play className=\"mr-2 h-4 w-4\" />\n                            Start Sync\n                          </>\n                        )}\n                        </Button>\n                      </div>\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n\n            {config.status !== 'active' && (\n              <Card className=\"border-warning/30 bg-gradient-to-r from-warning/10 to-warning/5 shadow-md\">\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"flex-shrink-0\">\n                      <AlertCircle className=\"h-6 w-6 text-warning\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <p className=\"text-sm font-semibold text-warning\">Connection Required</p>\n                      <p className=\"text-sm text-warning/80 mt-1\">\n                        Please configure and test your WooCommerce connection in the Configuration tab before syncing data.\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n\n          {/* Configuration Tab */}\n          <TabsContent value=\"configuration\" className=\"space-y-6\">\n            <Card className=\"border-2\">\n              <CardHeader className=\"bg-gradient-to-r from-accent/20 to-accent/10\">\n                <CardTitle className=\"text-xl flex items-center gap-2\">\n                  <Settings className=\"h-5 w-5 text-primary\" />\n                  Connection Details\n                </CardTitle>\n                <CardDescription className=\"mt-1\">\n                  Configure your WooCommerce store connection settings and credentials\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-6 pt-6\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Integration Name</Label>\n                  <Input\n                    id=\"name\"\n                    value={config.name}\n                    onChange={(e) => setConfig(prev => ({ ...prev, name: e.target.value }))}\n                    placeholder=\"My WooCommerce Store\"\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"store_url\">Store URL</Label>\n                  <Input\n                    id=\"store_url\"\n                    value={config.store_url}\n                    onChange={(e) => setConfig(prev => ({ ...prev, store_url: e.target.value }))}\n                    placeholder=\"https://your-store.com\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Your WooCommerce store URL (e.g., https://example.com)\n                  </p>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"consumer_key\">Consumer Key</Label>\n                  <Input\n                    id=\"consumer_key\"\n                    type=\"password\"\n                    value={config.consumer_key}\n                    onChange={(e) => setConfig(prev => ({ ...prev, consumer_key: e.target.value }))}\n                    placeholder=\"ck_********************************\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Generated from WooCommerce → Settings → Advanced → REST API\n                  </p>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"consumer_secret\">Consumer Secret</Label>\n                  <Input\n                    id=\"consumer_secret\"\n                    type=\"password\"\n                    value={config.consumer_secret}\n                    onChange={(e) => setConfig(prev => ({ ...prev, consumer_secret: e.target.value }))}\n                    placeholder=\"cs_********************************\"\n                  />\n                </div>\n\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-6 border-t-2\">\n                  <Button\n                    onClick={handleTestConnection}\n                    disabled={!config.store_url || !config.consumer_key || !config.consumer_secret || testing}\n                    variant=\"outline\"\n                    className=\"flex-1 h-11 font-semibold border-2\"\n                    size=\"lg\"\n                  >\n                    {testing ? (\n                      <>\n                        <RefreshCw className=\"mr-2 h-5 w-5 animate-spin\" />\n                        Testing Connection...\n                      </>\n                    ) : (\n                      <>\n                        <TestTube2 className=\"mr-2 h-5 w-5\" />\n                        Test Connection\n                      </>\n                    )}\n                  </Button>\n                  <Button\n                    onClick={handleSaveConfiguration}\n                    disabled={saving}\n                    className=\"flex-1 h-11 font-semibold bg-gradient-to-r from-primary to-primary/90 hover:from-primary/90 hover:to-primary/80\"\n                    size=\"lg\"\n                  >\n                    {saving ? (\n                      <>\n                        <RefreshCw className=\"mr-2 h-5 w-5 animate-spin\" />\n                        Saving...\n                      </>\n                    ) : (\n                      <>\n                        <Save className=\"mr-2 h-5 w-5\" />\n                        Save Configuration\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* Settings Tab */}\n          <TabsContent value=\"settings\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Sync Configuration</CardTitle>\n                <CardDescription>Configure how data syncs between MantisNXT and WooCommerce</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"space-y-0.5\">\n                      <Label>Auto Sync Products</Label>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Automatically sync products when they are updated\n                      </p>\n                    </div>\n                    <Switch\n                      checked={config.auto_sync_products}\n                      onCheckedChange={(checked) => setConfig(prev => ({ ...prev, auto_sync_products: checked }))}\n                    />\n                  </div>\n\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"space-y-0.5\">\n                      <Label>Import Orders</Label>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Automatically import new orders from WooCommerce\n                      </p>\n                    </div>\n                    <Switch\n                      checked={config.auto_import_orders}\n                      onCheckedChange={(checked) => setConfig(prev => ({ ...prev, auto_import_orders: checked }))}\n                    />\n                  </div>\n\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"space-y-0.5\">\n                      <Label>Sync Customers</Label>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Keep customer data synchronized bi-directionally\n                      </p>\n                    </div>\n                    <Switch\n                      checked={config.sync_customers}\n                      onCheckedChange={(checked) => setConfig(prev => ({ ...prev, sync_customers: checked }))}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Sync Frequency</Label>\n                  <Select\n                    value={config.sync_frequency.toString()}\n                    onValueChange={(value) => setConfig(prev => ({ ...prev, sync_frequency: parseInt(value) }))}\n                  >\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"15\">Every 15 minutes</SelectItem>\n                      <SelectItem value=\"30\">Every 30 minutes</SelectItem>\n                      <SelectItem value=\"60\">Every hour</SelectItem>\n                      <SelectItem value=\"120\">Every 2 hours</SelectItem>\n                      <SelectItem value=\"1440\">Daily</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"flex justify-end gap-2 pt-4 border-t\">\n                  <Button variant=\"outline\">Cancel</Button>\n                  <Button onClick={handleSaveConfiguration} disabled={saving}>\n                    {saving ? 'Saving...' : 'Save Settings'}\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* Sync History Tab - ENHANCED */}\n          <TabsContent value=\"history\" className=\"space-y-6\">\n            <Card>\n              <CardHeader className=\"bg-gradient-to-r from-secondary/30 to-secondary/20\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"text-xl\">Sync History</CardTitle>\n                    <CardDescription className=\"mt-1\">Complete log of all synchronization operations</CardDescription>\n                  </div>\n                  {syncHistory.length > 0 && (\n                    <Badge variant=\"secondary\" className=\"text-sm\">\n                      {syncHistory.length} {syncHistory.length === 1 ? 'entry' : 'entries'}\n                    </Badge>\n                  )}\n                </div>\n              </CardHeader>\n              <CardContent className=\"pt-6\">\n                {syncHistory.length === 0 ? (\n                  <div className=\"text-center py-12 bg-gradient-to-br from-secondary/30 to-secondary/20 rounded-lg border-2 border-dashed border-border\">\n                    <div className=\"relative mx-auto w-24 h-24 mb-4\">\n                      <div className=\"absolute inset-0 rounded-full bg-gradient-to-br from-secondary to-secondary/80 flex items-center justify-center\">\n                        <Clock className=\"h-12 w-12 text-muted-foreground\" />\n                      </div>\n                    </div>\n                    <p className=\"text-base font-semibold text-foreground\">No Sync History Yet</p>\n                    <p className=\"text-sm text-muted-foreground mt-2 max-w-md mx-auto\">\n                      Your synchronization history will appear here once you perform your first sync operation.\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"border rounded-lg overflow-hidden shadow-sm\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow className=\"bg-secondary/50\">\n                          <TableHead className=\"font-bold\">Entity</TableHead>\n                          <TableHead className=\"font-bold\">Status</TableHead>\n                          <TableHead className=\"font-bold\">Timestamp</TableHead>\n                          <TableHead className=\"text-right font-bold\">Processed</TableHead>\n                          <TableHead className=\"text-right font-bold\">Created</TableHead>\n                          <TableHead className=\"text-right font-bold\">Updated</TableHead>\n                          <TableHead className=\"text-right font-bold\">Failed</TableHead>\n                          <TableHead className=\"text-right font-bold\">Duration</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {syncHistory.map((entry) => {\n                          const Icon = ENTITY_ICONS[entry.entityType];\n                          return (\n                            <TableRow key={entry.id} className=\"hover:bg-secondary/50 transition-colors\">\n                              <TableCell>\n                                <div className=\"flex items-center gap-2\">\n                                  <div className=\"h-8 w-8 rounded-lg bg-primary/10 flex items-center justify-center\">\n                                    <Icon className=\"h-4 w-4 text-primary\" />\n                                  </div>\n                                  <span className=\"font-semibold\">{ENTITY_LABELS[entry.entityType]}</span>\n                                </div>\n                              </TableCell>\n                              <TableCell>{getStatusBadge(entry.status)}</TableCell>\n                              <TableCell className=\"text-sm font-medium text-foreground\">\n                                {formatTimestamp(entry.timestamp)}\n                              </TableCell>\n                              <TableCell className=\"text-right font-mono font-semibold text-foreground\">\n                                {entry.processed.toLocaleString()}\n                              </TableCell>\n                              <TableCell className=\"text-right font-mono font-semibold text-success\">\n                                {entry.created.toLocaleString()}\n                              </TableCell>\n                              <TableCell className=\"text-right font-mono font-semibold text-primary\">\n                                {entry.updated.toLocaleString()}\n                              </TableCell>\n                              <TableCell className=\"text-right font-mono font-semibold text-destructive\">\n                                {entry.failed.toLocaleString()}\n                              </TableCell>\n                              <TableCell className=\"text-right text-sm font-medium text-muted-foreground\">\n                                <Clock className=\"h-3 w-3 inline mr-1\" />\n                                {formatDuration(entry.duration)}\n                              </TableCell>\n                            </TableRow>\n                          );\n                        })}\n                      </TableBody>\n                    </Table>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n\n        {/* Activity Log Tab */}\n        <Tabs defaultValue=\"activity\" className=\"space-y-6 mt-6\">\n          <TabsList>\n            <TabsTrigger value=\"activity\">Activity Log</TabsTrigger>\n          </TabsList>\n          <TabsContent value=\"activity\">\n            <ActivityLog orgId={orgId || 'org-default'} entityType=\"woocommerce\" />\n          </TabsContent>\n        </Tabs>\n      </div>\n\n      {/* Sync Preview Modal */}\n      <SyncPreview\n        isOpen={syncManager.state.isPreviewOpen}\n        syncType=\"woocommerce\"\n        entityType={syncManager.state.currentEntityType || ''}\n        onConfirm={(config) => handleSyncConfirmed({ ...config, entityType: syncManager.state.currentEntityType })}\n        onCancel={() => syncManager.closePreview()}\n      />\n\n      {/* Progress Tracker */}\n      {syncManager.state.jobId && (\n        <ProgressTracker\n          jobId={syncManager.state.jobId}\n          syncType=\"woocommerce\"\n          entityType={syncManager.state.currentEntityType || ''}\n          isVisible={syncManager.state.isProgressVisible}\n          onComplete={(status) => {\n            syncManager.hideProgress();\n            toast({\n              title: status === 'completed' ? 'Sync Completed' : 'Sync Failed',\n              description: status === 'completed' ? 'All items synced successfully' : 'Check the error details above',\n            });\n          }}\n          onCancel={() => syncManager.hideProgress()}\n        />\n      )}\n    </AppLayout>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\invoices\\page.tsx","messages":[{"ruleId":"no-redeclare","severity":2,"message":"'InvoiceFilters' is already defined.","line":1102,"column":10,"nodeType":"Identifier","messageId":"redeclared","endLine":1102,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useMemo } from \"react\"\r\nimport AppLayout from '@/components/layout/AppLayout'\r\nimport {\r\n  Search,\r\n  Filter,\r\n  Download,\r\n  Upload,\r\n  Plus,\r\n  Eye,\r\n  Edit,\r\n  Trash2,\r\n  FileText,\r\n  DollarSign,\r\n  Clock,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  XCircle,\r\n  MoreHorizontal,\r\n  ArrowUpDown,\r\n  ArrowUp,\r\n  ArrowDown,\r\n  Calendar,\r\n  CreditCard,\r\n  Receipt,\r\n  Target,\r\n  TrendingUp,\r\n  AlertCircle,\r\n  Users,\r\n  RefreshCw,\r\n  Settings,\r\n  Mail,\r\n  Phone,\r\n  Globe,\r\n  MapPin,\r\n  Building2,\r\n  Banknote,\r\n  Percent,\r\n  FileCheck,\r\n  FileX,\r\n  Zap,\r\n  BarChart3,\r\n  PieChart,\r\n  Activity,\r\n  BookOpen,\r\n  Paperclip,\r\n  MessageSquare,\r\n  History,\r\n  UserCheck,\r\n  Send,\r\n  Ban,\r\n  Copy,\r\n  ExternalLink\r\n} from \"lucide-react\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow\r\n} from \"@/components/ui/table\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n  DropdownMenuCheckboxItem,\r\n  DropdownMenuRadioGroup,\r\n  DropdownMenuRadioItem\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger\r\n} from \"@/components/ui/dialog\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\"\r\n\r\nimport { formatCurrency, formatDate, formatDateTime, getStatusColor, cn } from \"@/lib/utils\"\r\nimport type {\r\n  Invoice,\r\n  InvoiceStatus,\r\n  PaymentStatus,\r\n  ApprovalStatus,\r\n  InvoiceFilters,\r\n  InvoiceMetrics,\r\n  ThreeWayMatchStatus,\r\n  BulkInvoiceOperation\r\n} from \"@/types/invoice\"\r\n\r\n// Mock data - in real app this would come from API\r\nconst mockInvoices: Invoice[] = [\r\n  {\r\n    id: \"INV-001\",\r\n    number: \"INV-2024-001\",\r\n    supplierId: \"SUP-001\",\r\n    supplierName: \"TechCorp Solutions\",\r\n    supplierCode: \"TECH001\",\r\n    purchaseOrderId: \"PO-001\",\r\n    purchaseOrderNumber: \"PO-2024-001\",\r\n    receiptId: \"REC-001\",\r\n    receiptNumber: \"REC-2024-001\",\r\n    invoiceDate: \"2024-01-15\",\r\n    dueDate: \"2024-02-15\",\r\n    paymentTerms: \"Net 30\",\r\n    currency: \"ZAR\",\r\n    subtotal: 10000,\r\n    taxAmount: 800,\r\n    discountAmount: 500,\r\n    shippingAmount: 200,\r\n    totalAmount: 10500,\r\n    paidAmount: 0,\r\n    remainingAmount: 10500,\r\n    status: \"under_review\",\r\n    approvalStatus: \"pending\",\r\n    paymentStatus: \"pending\",\r\n    matchingStatus: \"matched\",\r\n    taxCompliant: true,\r\n    auditTrail: [],\r\n    documents: [],\r\n    receivedDate: \"2024-01-15T09:00:00Z\",\r\n    ocrProcessed: true,\r\n    ocrConfidence: 95,\r\n    manualReview: false,\r\n    disputed: false,\r\n    lineItems: [],\r\n    createdAt: \"2024-01-15T09:00:00Z\",\r\n    updatedAt: \"2024-01-15T09:00:00Z\",\r\n    createdBy: \"user1\",\r\n    updatedBy: \"user1\",\r\n    earlyPaymentDiscount: {\r\n      percentage: 2,\r\n      daysEarly: 10,\r\n      discountAmount: 210,\r\n      eligibleUntil: \"2024-02-05\"\r\n    }\r\n  },\r\n  {\r\n    id: \"INV-002\",\r\n    number: \"INV-2024-002\",\r\n    supplierId: \"SUP-002\",\r\n    supplierName: \"Global Supplies Inc\",\r\n    supplierCode: \"GLOB002\",\r\n    invoiceDate: \"2024-01-20\",\r\n    dueDate: \"2024-02-20\",\r\n    paymentTerms: \"Net 30\",\r\n    currency: \"ZAR\",\r\n    subtotal: 5000,\r\n    taxAmount: 400,\r\n    discountAmount: 0,\r\n    shippingAmount: 100,\r\n    totalAmount: 5500,\r\n    paidAmount: 5500,\r\n    remainingAmount: 0,\r\n    status: \"paid\",\r\n    approvalStatus: \"approved\",\r\n    paymentStatus: \"paid\",\r\n    matchingStatus: \"exceptions\",\r\n    taxCompliant: true,\r\n    auditTrail: [],\r\n    documents: [],\r\n    receivedDate: \"2024-01-20T10:30:00Z\",\r\n    processedDate: \"2024-01-21T14:15:00Z\",\r\n    approvedDate: \"2024-01-22T16:45:00Z\",\r\n    paidDate: \"2024-01-25T11:20:00Z\",\r\n    ocrProcessed: true,\r\n    ocrConfidence: 88,\r\n    manualReview: true,\r\n    disputed: false,\r\n    lineItems: [],\r\n    createdAt: \"2024-01-20T10:30:00Z\",\r\n    updatedAt: \"2024-01-25T11:20:00Z\",\r\n    createdBy: \"user1\",\r\n    updatedBy: \"user2\"\r\n  },\r\n  {\r\n    id: \"INV-003\",\r\n    number: \"INV-2024-003\",\r\n    supplierId: \"SUP-003\",\r\n    supplierName: \"Regional Manufacturing\",\r\n    supplierCode: \"REGI003\",\r\n    invoiceDate: \"2024-01-25\",\r\n    dueDate: \"2024-02-10\",\r\n    paymentTerms: \"Net 15\",\r\n    currency: \"ZAR\",\r\n    subtotal: 15000,\r\n    taxAmount: 1200,\r\n    discountAmount: 750,\r\n    shippingAmount: 300,\r\n    totalAmount: 15750,\r\n    paidAmount: 0,\r\n    remainingAmount: 15750,\r\n    status: \"overdue\",\r\n    approvalStatus: \"approved\",\r\n    paymentStatus: \"overdue\",\r\n    matchingStatus: \"manual_review\",\r\n    taxCompliant: false,\r\n    auditTrail: [],\r\n    documents: [],\r\n    receivedDate: \"2024-01-25T08:45:00Z\",\r\n    processedDate: \"2024-01-26T12:30:00Z\",\r\n    approvedDate: \"2024-01-27T10:15:00Z\",\r\n    ocrProcessed: false,\r\n    manualReview: true,\r\n    disputed: true,\r\n    disputeReason: \"Price variance exceeds tolerance\",\r\n    disputeDate: \"2024-02-01\",\r\n    lineItems: [],\r\n    createdAt: \"2024-01-25T08:45:00Z\",\r\n    updatedAt: \"2024-02-01T14:20:00Z\",\r\n    createdBy: \"user1\",\r\n    updatedBy: \"user3\"\r\n  }\r\n]\r\n\r\nconst mockMetrics: InvoiceMetrics = {\r\n  totalInvoices: 156,\r\n  totalValue: 2450000,\r\n  averageProcessingTime: 2.5,\r\n  approvalRate: 94.2,\r\n  disputeRate: 3.8,\r\n  onTimePaymentRate: 89.1,\r\n  earlyPaymentSavings: 48500,\r\n  exceptionRate: 12.5,\r\n  automationRate: 87.3\r\n}\r\n\r\nconst getMatchingStatusIcon = (status: ThreeWayMatchStatus) => {\r\n  switch (status) {\r\n    case \"matched\":\r\n      return <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n    case \"exceptions\":\r\n      return <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\r\n    case \"manual_review\":\r\n      return <Eye className=\"h-4 w-4 text-blue-600\" />\r\n    case \"failed\":\r\n      return <XCircle className=\"h-4 w-4 text-red-600\" />\r\n    case \"in_progress\":\r\n      return <Clock className=\"h-4 w-4 text-yellow-500\" />\r\n    case \"not_started\":\r\n      return <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n    default:\r\n      return <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n  }\r\n}\r\n\r\nexport default function InvoicesPage() {\r\n  const [invoices, setInvoices] = useState<Invoice[]>(mockInvoices)\r\n  const [filteredInvoices, setFilteredInvoices] = useState<Invoice[]>(mockInvoices)\r\n  const [selectedInvoices, setSelectedInvoices] = useState<string[]>([])\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n  const [filters, setFilters] = useState<InvoiceFilters>({})\r\n  const [sortField, setSortField] = useState<keyof Invoice>(\"invoiceDate\")\r\n  const [sortDirection, setSortDirection] = useState<\"asc\" | \"desc\">(\"desc\")\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const [itemsPerPage, setItemsPerPage] = useState(25)\r\n  const [showCreateDialog, setShowCreateDialog] = useState(false)\r\n  const [showBulkActions, setShowBulkActions] = useState(false)\r\n  const [selectedInvoice, setSelectedInvoice] = useState<Invoice | null>(null)\r\n  const [showInvoiceDetail, setShowInvoiceDetail] = useState(false)\r\n  const [activeTab, setActiveTab] = useState(\"all\")\r\n\r\n  // Filter and sort invoices\r\n  useEffect(() => {\r\n    let filtered = invoices.filter(invoice => {\r\n      const matchesSearch = searchQuery === \"\" ||\r\n        invoice.number.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        invoice.supplierName.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        invoice.supplierCode.toLowerCase().includes(searchQuery.toLowerCase())\r\n\r\n      const matchesStatus = !filters.status?.length ||\r\n        filters.status.includes(invoice.status)\r\n\r\n      const matchesPaymentStatus = !filters.paymentStatus?.length ||\r\n        filters.paymentStatus.includes(invoice.paymentStatus)\r\n\r\n      const matchesApprovalStatus = !filters.approvalStatus?.length ||\r\n        filters.approvalStatus.includes(invoice.approvalStatus)\r\n\r\n      const matchesSupplier = !filters.supplierId?.length ||\r\n        filters.supplierId.includes(invoice.supplierId)\r\n\r\n      const matchesCurrency = !filters.currency?.length ||\r\n        filters.currency.includes(invoice.currency)\r\n\r\n      const matchesAmount = !filters.amountRange ||\r\n        (invoice.totalAmount >= filters.amountRange.min &&\r\n         invoice.totalAmount <= filters.amountRange.max)\r\n\r\n      return matchesSearch && matchesStatus && matchesPaymentStatus &&\r\n             matchesApprovalStatus && matchesSupplier && matchesCurrency &&\r\n             matchesAmount\r\n    })\r\n\r\n    // Apply tab-based filtering\r\n    if (activeTab !== \"all\") {\r\n      switch (activeTab) {\r\n        case \"pending\":\r\n          filtered = filtered.filter(inv =>\r\n            inv.approvalStatus === \"pending\" || inv.status === \"under_review\"\r\n          )\r\n          break\r\n        case \"approved\":\r\n          filtered = filtered.filter(inv => inv.approvalStatus === \"approved\")\r\n          break\r\n        case \"paid\":\r\n          filtered = filtered.filter(inv => inv.paymentStatus === \"paid\")\r\n          break\r\n        case \"overdue\":\r\n          filtered = filtered.filter(inv =>\r\n            inv.status === \"overdue\" || inv.paymentStatus === \"overdue\"\r\n          )\r\n          break\r\n        case \"disputed\":\r\n          filtered = filtered.filter(inv => inv.disputed)\r\n          break\r\n        case \"exceptions\":\r\n          filtered = filtered.filter(inv =>\r\n            inv.matchingStatus === \"exceptions\" || inv.matchingStatus === \"manual_review\"\r\n          )\r\n          break\r\n      }\r\n    }\r\n\r\n    // Sort\r\n    filtered.sort((a, b) => {\r\n      const aValue = a[sortField]\r\n      const bValue = b[sortField]\r\n\r\n      if (typeof aValue === \"string\" && typeof bValue === \"string\") {\r\n        return sortDirection === \"asc\"\r\n          ? aValue.localeCompare(bValue)\r\n          : bValue.localeCompare(aValue)\r\n      }\r\n\r\n      if (typeof aValue === \"number\" && typeof bValue === \"number\") {\r\n        return sortDirection === \"asc\" ? aValue - bValue : bValue - aValue\r\n      }\r\n\r\n      return 0\r\n    })\r\n\r\n    setFilteredInvoices(filtered)\r\n    setCurrentPage(1)\r\n  }, [invoices, searchQuery, filters, sortField, sortDirection, activeTab])\r\n\r\n  const paginatedInvoices = useMemo(() => {\r\n    const startIndex = (currentPage - 1) * itemsPerPage\r\n    return filteredInvoices.slice(startIndex, startIndex + itemsPerPage)\r\n  }, [filteredInvoices, currentPage, itemsPerPage])\r\n\r\n  const totalPages = Math.ceil(filteredInvoices.length / itemsPerPage)\r\n\r\n  const handleSort = (field: keyof Invoice) => {\r\n    if (field === sortField) {\r\n      setSortDirection(sortDirection === \"asc\" ? \"desc\" : \"asc\")\r\n    } else {\r\n      setSortField(field)\r\n      setSortDirection(\"asc\")\r\n    }\r\n  }\r\n\r\n  const handleSelectInvoice = (invoiceId: string) => {\r\n    setSelectedInvoices(prev =>\r\n      prev.includes(invoiceId)\r\n        ? prev.filter(id => id !== invoiceId)\r\n        : [...prev, invoiceId]\r\n    )\r\n  }\r\n\r\n  const handleSelectAll = () => {\r\n    setSelectedInvoices(\r\n      selectedInvoices.length === paginatedInvoices.length\r\n        ? []\r\n        : paginatedInvoices.map(invoice => invoice.id)\r\n    )\r\n  }\r\n\r\n  const getStatusBadge = (status: InvoiceStatus) => {\r\n    const colors = getStatusColor(status)\r\n    return (\r\n      <Badge className={colors}>\r\n        {status.replace(\"_\", \" \").toUpperCase()}\r\n      </Badge>\r\n    )\r\n  }\r\n\r\n  const getPaymentStatusBadge = (status: PaymentStatus) => {\r\n    const colors = getStatusColor(status)\r\n    return (\r\n      <Badge className={colors}>\r\n        {status.replace(\"_\", \" \").toUpperCase()}\r\n      </Badge>\r\n    )\r\n  }\r\n\r\n  const handleBulkApprove = async () => {\r\n    // Implement bulk approval logic\r\n    console.log(\"Bulk approve:\", selectedInvoices)\r\n  }\r\n\r\n  const handleBulkReject = async () => {\r\n    // Implement bulk rejection logic\r\n    console.log(\"Bulk reject:\", selectedInvoices)\r\n  }\r\n\r\n  const handleBulkExport = async () => {\r\n    // Implement bulk export logic\r\n    console.log(\"Bulk export:\", selectedInvoices)\r\n  }\r\n\r\n  const handleOCRProcess = async (invoiceId: string) => {\r\n    // Implement OCR processing logic\r\n    console.log(\"OCR process:\", invoiceId)\r\n  }\r\n\r\n  const handleThreeWayMatch = async (invoiceId: string) => {\r\n    // Implement three-way matching logic\r\n    console.log(\"Three-way match:\", invoiceId)\r\n  }\r\n\r\n  const TabCountBadge = ({ count }: { count: number }) => (\r\n    <Badge variant=\"secondary\" className=\"ml-2 text-xs\">\r\n      {count}\r\n    </Badge>\r\n  )\r\n\r\n  return (\r\n    <AppLayout title=\"Invoices\" breadcrumbs={[{ label: \"Invoice Management\" }]}>\r\n      <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h2 className=\"text-3xl font-bold tracking-tight\">Invoice Management</h2>\r\n          <p className=\"text-muted-foreground\">\r\n            Comprehensive invoice processing, approval, and payment management\r\n          </p>\r\n        </div>\r\n        <div className=\"flex items-center space-x-2\">\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <Download className=\"mr-2 h-4 w-4\" />\r\n            Export\r\n          </Button>\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <Upload className=\"mr-2 h-4 w-4\" />\r\n            Import\r\n          </Button>\r\n          <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\r\n            <DialogTrigger asChild>\r\n              <Button>\r\n                <Plus className=\"mr-2 h-4 w-4\" />\r\n                Create Invoice\r\n              </Button>\r\n            </DialogTrigger>\r\n            <DialogContent className=\"max-w-4xl\">\r\n              <DialogHeader>\r\n                <DialogTitle>Create New Invoice</DialogTitle>\r\n                <DialogDescription>\r\n                  Create a new invoice or upload invoice documents for processing\r\n                </DialogDescription>\r\n              </DialogHeader>\r\n              <InvoiceCreationForm onClose={() => setShowCreateDialog(false)} />\r\n            </DialogContent>\r\n          </Dialog>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Metrics Dashboard */}\r\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Invoices</CardTitle>\r\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{mockMetrics.totalInvoices}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {formatCurrency(mockMetrics.totalValue)} total value\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Processing Time</CardTitle>\r\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{mockMetrics.averageProcessingTime} days</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {mockMetrics.automationRate}% automated\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Approval Rate</CardTitle>\r\n            <CheckCircle className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{mockMetrics.approvalRate}%</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {mockMetrics.disputeRate}% dispute rate\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Early Payment Savings</CardTitle>\r\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">\r\n              {formatCurrency(mockMetrics.earlyPaymentSavings)}\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {mockMetrics.onTimePaymentRate}% on-time payments\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Filters and Search */}\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <CardTitle>Invoice Overview</CardTitle>\r\n              <CardDescription>\r\n                Manage and track all invoice processing activities\r\n              </CardDescription>\r\n            </div>\r\n            <div className=\"flex items-center space-x-2\">\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  placeholder=\"Search invoices...\"\r\n                  value={searchQuery}\r\n                  onChange={(e) => setSearchQuery(e.target.value)}\r\n                  className=\"pl-8 w-80\"\r\n                />\r\n              </div>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button variant=\"outline\" size=\"sm\">\r\n                    <Filter className=\"mr-2 h-4 w-4\" />\r\n                    Filters\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent className=\"w-80\">\r\n                  <DropdownMenuLabel>Filter Options</DropdownMenuLabel>\r\n                  <DropdownMenuSeparator />\r\n                  <InvoiceFilters\r\n                    filters={filters}\r\n                    onFiltersChange={setFilters}\r\n                  />\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <Settings className=\"mr-2 h-4 w-4\" />\r\n                View Options\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {/* Tabs for different invoice views */}\r\n          <Tabs value={activeTab} onValueChange={setActiveTab} className=\"mb-6\">\r\n            <TabsList className=\"grid w-full grid-cols-7\">\r\n              <TabsTrigger value=\"all\">\r\n                All\r\n                <TabCountBadge count={filteredInvoices.length} />\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"pending\">\r\n                Pending\r\n                <TabCountBadge count={\r\n                  invoices.filter(inv =>\r\n                    inv.approvalStatus === \"pending\" || inv.status === \"under_review\"\r\n                  ).length\r\n                } />\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"approved\">\r\n                Approved\r\n                <TabCountBadge count={\r\n                  invoices.filter(inv => inv.approvalStatus === \"approved\").length\r\n                } />\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"paid\">\r\n                Paid\r\n                <TabCountBadge count={\r\n                  invoices.filter(inv => inv.paymentStatus === \"paid\").length\r\n                } />\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"overdue\">\r\n                Overdue\r\n                <TabCountBadge count={\r\n                  invoices.filter(inv =>\r\n                    inv.status === \"overdue\" || inv.paymentStatus === \"overdue\"\r\n                  ).length\r\n                } />\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"disputed\">\r\n                Disputed\r\n                <TabCountBadge count={\r\n                  invoices.filter(inv => inv.disputed).length\r\n                } />\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"exceptions\">\r\n                Exceptions\r\n                <TabCountBadge count={\r\n                  invoices.filter(inv =>\r\n                    inv.matchingStatus === \"exceptions\" ||\r\n                    inv.matchingStatus === \"manual_review\"\r\n                  ).length\r\n                } />\r\n              </TabsTrigger>\r\n            </TabsList>\r\n          </Tabs>\r\n\r\n          {/* Bulk Actions */}\r\n          {selectedInvoices.length > 0 && (\r\n            <div className=\"mb-4 p-3 bg-muted rounded-lg flex items-center justify-between\">\r\n              <span className=\"text-sm font-medium\">\r\n                {selectedInvoices.length} invoice(s) selected\r\n              </span>\r\n              <div className=\"flex items-center space-x-2\">\r\n                <Button size=\"sm\" onClick={handleBulkApprove}>\r\n                  <UserCheck className=\"mr-2 h-4 w-4\" />\r\n                  Approve\r\n                </Button>\r\n                <Button size=\"sm\" variant=\"destructive\" onClick={handleBulkReject}>\r\n                  <Ban className=\"mr-2 h-4 w-4\" />\r\n                  Reject\r\n                </Button>\r\n                <Button size=\"sm\" variant=\"outline\" onClick={handleBulkExport}>\r\n                  <Download className=\"mr-2 h-4 w-4\" />\r\n                  Export\r\n                </Button>\r\n                <Button size=\"sm\" variant=\"outline\">\r\n                  <Send className=\"mr-2 h-4 w-4\" />\r\n                  Send for Payment\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Invoice Table */}\r\n          <div className=\"rounded-md border\">\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead className=\"w-12\">\r\n                    <Checkbox\r\n                      checked={selectedInvoices.length === paginatedInvoices.length}\r\n                      onCheckedChange={handleSelectAll}\r\n                    />\r\n                  </TableHead>\r\n                  <TableHead\r\n                    className=\"cursor-pointer\"\r\n                    onClick={() => handleSort(\"number\")}\r\n                  >\r\n                    <div className=\"flex items-center\">\r\n                      Invoice #\r\n                      {sortField === \"number\" && (\r\n                        sortDirection === \"asc\" ?\r\n                        <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                        <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                      )}\r\n                    </div>\r\n                  </TableHead>\r\n                  <TableHead\r\n                    className=\"cursor-pointer\"\r\n                    onClick={() => handleSort(\"supplierName\")}\r\n                  >\r\n                    <div className=\"flex items-center\">\r\n                      Supplier\r\n                      {sortField === \"supplierName\" && (\r\n                        sortDirection === \"asc\" ?\r\n                        <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                        <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                      )}\r\n                    </div>\r\n                  </TableHead>\r\n                  <TableHead\r\n                    className=\"cursor-pointer\"\r\n                    onClick={() => handleSort(\"invoiceDate\")}\r\n                  >\r\n                    <div className=\"flex items-center\">\r\n                      Date\r\n                      {sortField === \"invoiceDate\" && (\r\n                        sortDirection === \"asc\" ?\r\n                        <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                        <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                      )}\r\n                    </div>\r\n                  </TableHead>\r\n                  <TableHead\r\n                    className=\"cursor-pointer\"\r\n                    onClick={() => handleSort(\"dueDate\")}\r\n                  >\r\n                    <div className=\"flex items-center\">\r\n                      Due Date\r\n                      {sortField === \"dueDate\" && (\r\n                        sortDirection === \"asc\" ?\r\n                        <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                        <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                      )}\r\n                    </div>\r\n                  </TableHead>\r\n                  <TableHead\r\n                    className=\"cursor-pointer text-right\"\r\n                    onClick={() => handleSort(\"totalAmount\")}\r\n                  >\r\n                    <div className=\"flex items-center justify-end\">\r\n                      Amount\r\n                      {sortField === \"totalAmount\" && (\r\n                        sortDirection === \"asc\" ?\r\n                        <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                        <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                      )}\r\n                    </div>\r\n                  </TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                  <TableHead>Payment</TableHead>\r\n                  <TableHead>3-Way Match</TableHead>\r\n                  <TableHead>Actions</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {paginatedInvoices.map((invoice) => (\r\n                  <TableRow key={invoice.id}>\r\n                    <TableCell>\r\n                      <Checkbox\r\n                        checked={selectedInvoices.includes(invoice.id)}\r\n                        onCheckedChange={() => handleSelectInvoice(invoice.id)}\r\n                      />\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex flex-col\">\r\n                        <span className=\"font-medium\">{invoice.number}</span>\r\n                        {invoice.purchaseOrderNumber && (\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            PO: {invoice.purchaseOrderNumber}\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex flex-col\">\r\n                        <span className=\"font-medium\">{invoice.supplierName}</span>\r\n                        <span className=\"text-xs text-muted-foreground\">\r\n                          {invoice.supplierCode}\r\n                        </span>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>{formatDate(invoice.invoiceDate)}</TableCell>\r\n                    <TableCell>\r\n                      <div\r\n                        className={cn(\r\n                          \"font-medium\",\r\n                          new Date(invoice.dueDate) < new Date() &&\r\n                            invoice.paymentStatus !== \"paid\" &&\r\n                            \"text-red-600\"\r\n                        )}\r\n                      >\r\n                        {formatDate(invoice.dueDate)}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell className=\"text-right\">\r\n                      <div className=\"flex flex-col items-end\">\r\n                        <span className=\"font-medium\">\r\n                          {formatCurrency(invoice.totalAmount, invoice.currency)}\r\n                        </span>\r\n                        {invoice.remainingAmount > 0 && (\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            Remaining: {formatCurrency(invoice.remainingAmount, invoice.currency)}\r\n                          </span>\r\n                        )}\r\n                        {invoice.earlyPaymentDiscount &&\r\n                         new Date(invoice.earlyPaymentDiscount.eligibleUntil) > new Date() && (\r\n                          <span className=\"text-xs text-green-600\">\r\n                            Early discount available\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex flex-col space-y-1\">\r\n                        {getStatusBadge(invoice.status)}\r\n                        {invoice.disputed && (\r\n                          <Badge variant=\"destructive\" className=\"text-xs\">\r\n                            Disputed\r\n                          </Badge>\r\n                        )}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      {getPaymentStatusBadge(invoice.paymentStatus)}\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Tooltip>\r\n                        <TooltipTrigger>\r\n                          {getMatchingStatusIcon(invoice.matchingStatus)}\r\n                        </TooltipTrigger>\r\n                        <TooltipContent>\r\n                          <p>{invoice.matchingStatus.replace(\"_\", \" \")}</p>\r\n                        </TooltipContent>\r\n                      </Tooltip>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <DropdownMenu>\r\n                        <DropdownMenuTrigger asChild>\r\n                          <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\r\n                            <MoreHorizontal className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </DropdownMenuTrigger>\r\n                        <DropdownMenuContent align=\"end\">\r\n                          <DropdownMenuItem\r\n                            onClick={() => {\r\n                              setSelectedInvoice(invoice)\r\n                              setShowInvoiceDetail(true)\r\n                            }}\r\n                          >\r\n                            <Eye className=\"mr-2 h-4 w-4\" />\r\n                            View Details\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <Edit className=\"mr-2 h-4 w-4\" />\r\n                            Edit Invoice\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <Copy className=\"mr-2 h-4 w-4\" />\r\n                            Duplicate\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          {invoice.matchingStatus !== \"matched\" && (\r\n                            <DropdownMenuItem\r\n                              onClick={() => handleThreeWayMatch(invoice.id)}\r\n                            >\r\n                              <Target className=\"mr-2 h-4 w-4\" />\r\n                              3-Way Match\r\n                            </DropdownMenuItem>\r\n                          )}\r\n                          {!invoice.ocrProcessed && (\r\n                            <DropdownMenuItem\r\n                              onClick={() => handleOCRProcess(invoice.id)}\r\n                            >\r\n                              <Zap className=\"mr-2 h-4 w-4\" />\r\n                              Process OCR\r\n                            </DropdownMenuItem>\r\n                          )}\r\n                          <DropdownMenuItem>\r\n                            <Send className=\"mr-2 h-4 w-4\" />\r\n                            Send for Approval\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <Download className=\"mr-2 h-4 w-4\" />\r\n                            Download PDF\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          <DropdownMenuItem>\r\n                            <MessageSquare className=\"mr-2 h-4 w-4\" />\r\n                            Add Comment\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <History className=\"mr-2 h-4 w-4\" />\r\n                            View History\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          <DropdownMenuItem className=\"text-red-600\">\r\n                            <Trash2 className=\"mr-2 h-4 w-4\" />\r\n                            Delete\r\n                          </DropdownMenuItem>\r\n                        </DropdownMenuContent>\r\n                      </DropdownMenu>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n\r\n          {/* Pagination */}\r\n          <div className=\"flex items-center justify-between px-2 py-4\">\r\n            <div className=\"flex items-center space-x-2\">\r\n              <p className=\"text-sm text-muted-foreground\">\r\n                Showing {((currentPage - 1) * itemsPerPage) + 1} to {Math.min(currentPage * itemsPerPage, filteredInvoices.length)} of {filteredInvoices.length} invoices\r\n              </p>\r\n            </div>\r\n            <div className=\"flex items-center space-x-6 lg:space-x-8\">\r\n              <div className=\"flex items-center space-x-2\">\r\n                <p className=\"text-sm font-medium\">Rows per page</p>\r\n                <Select\r\n                  value={`${itemsPerPage}`}\r\n                  onValueChange={(value) => setItemsPerPage(Number(value))}\r\n                >\r\n                  <SelectTrigger className=\"h-8 w-[70px]\">\r\n                    <SelectValue placeholder={itemsPerPage} />\r\n                  </SelectTrigger>\r\n                  <SelectContent side=\"top\">\r\n                    {[10, 20, 30, 40, 50].map((pageSize) => (\r\n                      <SelectItem key={pageSize} value={`${pageSize}`}>\r\n                        {pageSize}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"flex w-[100px] items-center justify-center text-sm font-medium\">\r\n                Page {currentPage} of {totalPages}\r\n              </div>\r\n              <div className=\"flex items-center space-x-2\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"hidden h-8 w-8 p-0 lg:flex\"\r\n                  onClick={() => setCurrentPage(1)}\r\n                  disabled={currentPage === 1}\r\n                >\r\n                  <span className=\"sr-only\">Go to first page</span>\r\n                  <ArrowUp className=\"h-4 w-4 rotate-180\" />\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"h-8 w-8 p-0\"\r\n                  onClick={() => setCurrentPage(currentPage - 1)}\r\n                  disabled={currentPage === 1}\r\n                >\r\n                  <span className=\"sr-only\">Go to previous page</span>\r\n                  <ArrowUp className=\"h-4 w-4 rotate-90\" />\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"h-8 w-8 p-0\"\r\n                  onClick={() => setCurrentPage(currentPage + 1)}\r\n                  disabled={currentPage === totalPages}\r\n                >\r\n                  <span className=\"sr-only\">Go to next page</span>\r\n                  <ArrowUp className=\"h-4 w-4 -rotate-90\" />\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"hidden h-8 w-8 p-0 lg:flex\"\r\n                  onClick={() => setCurrentPage(totalPages)}\r\n                  disabled={currentPage === totalPages}\r\n                >\r\n                  <span className=\"sr-only\">Go to last page</span>\r\n                  <ArrowUp className=\"h-4 w-4\" />\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Invoice Detail Dialog */}\r\n      <Dialog open={showInvoiceDetail} onOpenChange={setShowInvoiceDetail}>\r\n        <DialogContent className=\"max-w-6xl\">\r\n          <DialogHeader>\r\n            <DialogTitle>Invoice Details</DialogTitle>\r\n            <DialogDescription>\r\n              Complete invoice information and processing history\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          {selectedInvoice && (\r\n            <InvoiceDetailView\r\n              invoice={selectedInvoice}\r\n              onClose={() => setShowInvoiceDetail(false)}\r\n            />\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n      </div>\r\n    </AppLayout>\r\n  )\r\n}\r\n\r\n// Invoice Creation Form Component\r\nfunction InvoiceCreationForm({ onClose }: { onClose: () => void }) {\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Tabs defaultValue=\"manual\" className=\"w-full\">\r\n        <TabsList className=\"grid w-full grid-cols-3\">\r\n          <TabsTrigger value=\"manual\">Manual Entry</TabsTrigger>\r\n          <TabsTrigger value=\"upload\">Upload Document</TabsTrigger>\r\n          <TabsTrigger value=\"ocr\">OCR Processing</TabsTrigger>\r\n        </TabsList>\r\n\r\n        <TabsContent value=\"manual\" className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"supplier\">Supplier</Label>\r\n              <Select>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Select supplier\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"tech001\">TechCorp Solutions</SelectItem>\r\n                  <SelectItem value=\"glob002\">Global Supplies Inc</SelectItem>\r\n                  <SelectItem value=\"regi003\">Regional Manufacturing</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"invoiceNumber\">Invoice Number</Label>\r\n              <Input id=\"invoiceNumber\" placeholder=\"INV-2024-001\" />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"invoiceDate\">Invoice Date</Label>\r\n              <Input id=\"invoiceDate\" type=\"date\" />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"dueDate\">Due Date</Label>\r\n              <Input id=\"dueDate\" type=\"date\" />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"amount\">Total Amount</Label>\r\n              <Input id=\"amount\" type=\"number\" placeholder=\"0.00\" />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"currency\">Currency</Label>\r\n              <Select>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Select currency\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"ZAR\">ZAR</SelectItem>\r\n                  <SelectItem value=\"EUR\">EUR</SelectItem>\r\n                  <SelectItem value=\"GBP\">GBP</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"upload\" className=\"space-y-4\">\r\n          <div className=\"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center\">\r\n            <Upload className=\"mx-auto h-12 w-12 text-gray-400\" />\r\n            <div className=\"mt-4\">\r\n              <p className=\"text-sm text-gray-600\">\r\n                Drop your invoice files here, or click to browse\r\n              </p>\r\n              <p className=\"text-xs text-gray-500 mt-1\">\r\n                Supports PDF, PNG, JPG files up to 10MB\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"ocr\" className=\"space-y-4\">\r\n          <div className=\"text-center py-8\">\r\n            <Zap className=\"mx-auto h-12 w-12 text-blue-500\" />\r\n            <h3 className=\"mt-4 text-lg font-medium\">OCR Processing</h3>\r\n            <p className=\"text-sm text-gray-600 mt-2\">\r\n              Upload invoice documents for automatic data extraction using OCR technology\r\n            </p>\r\n            <Button className=\"mt-4\">\r\n              <Upload className=\"mr-2 h-4 w-4\" />\r\n              Upload for OCR\r\n            </Button>\r\n          </div>\r\n        </TabsContent>\r\n      </Tabs>\r\n\r\n      <DialogFooter>\r\n        <Button variant=\"outline\" onClick={onClose}>\r\n          Cancel\r\n        </Button>\r\n        <Button>\r\n          Create Invoice\r\n        </Button>\r\n      </DialogFooter>\r\n    </div>\r\n  )\r\n}\r\n\r\n// Invoice Filters Component\r\nfunction InvoiceFilters({\r\n  filters,\r\n  onFiltersChange\r\n}: {\r\n  filters: InvoiceFilters\r\n  onFiltersChange: (filters: InvoiceFilters) => void\r\n}) {\r\n  return (\r\n    <div className=\"space-y-4 p-4\">\r\n      <div>\r\n        <Label className=\"text-sm font-medium\">Status</Label>\r\n        <div className=\"mt-2 space-y-2\">\r\n          {[\"draft\", \"submitted\", \"under_review\", \"approved\", \"rejected\", \"paid\", \"overdue\"].map((status) => (\r\n            <div key={status} className=\"flex items-center space-x-2\">\r\n              <Checkbox\r\n                id={status}\r\n                checked={filters.status?.includes(status as InvoiceStatus)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentStatuses = filters.status || []\r\n                  const newStatuses = checked\r\n                    ? [...currentStatuses, status as InvoiceStatus]\r\n                    : currentStatuses.filter(s => s !== status)\r\n                  onFiltersChange({\r\n                    ...filters,\r\n                    status: newStatuses.length > 0 ? newStatuses : undefined\r\n                  })\r\n                }}\r\n              />\r\n              <Label htmlFor={status} className=\"text-sm capitalize\">\r\n                {status.replace(\"_\", \" \")}\r\n              </Label>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      <Separator />\r\n\r\n      <div>\r\n        <Label className=\"text-sm font-medium\">Payment Status</Label>\r\n        <div className=\"mt-2 space-y-2\">\r\n          {[\"pending\", \"paid\", \"partially_paid\", \"overdue\", \"failed\"].map((status) => (\r\n            <div key={status} className=\"flex items-center space-x-2\">\r\n              <Checkbox\r\n                id={`payment-${status}`}\r\n                checked={filters.paymentStatus?.includes(status as PaymentStatus)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentStatuses = filters.paymentStatus || []\r\n                  const newStatuses = checked\r\n                    ? [...currentStatuses, status as PaymentStatus]\r\n                    : currentStatuses.filter(s => s !== status)\r\n                  onFiltersChange({\r\n                    ...filters,\r\n                    paymentStatus: newStatuses.length > 0 ? newStatuses : undefined\r\n                  })\r\n                }}\r\n              />\r\n              <Label htmlFor={`payment-${status}`} className=\"text-sm capitalize\">\r\n                {status.replace(\"_\", \" \")}\r\n              </Label>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      <Separator />\r\n\r\n      <div>\r\n        <Label className=\"text-sm font-medium\">Amount Range</Label>\r\n        <div className=\"mt-2 grid grid-cols-2 gap-2\">\r\n          <Input\r\n            placeholder=\"Min amount\"\r\n            type=\"number\"\r\n            value={filters.amountRange?.min || \"\"}\r\n            onChange={(e) => {\r\n              const min = parseFloat(e.target.value) || 0\r\n              onFiltersChange({\r\n                ...filters,\r\n                amountRange: {\r\n                  min,\r\n                  max: filters.amountRange?.max || 999999\r\n                }\r\n              })\r\n            }}\r\n          />\r\n          <Input\r\n            placeholder=\"Max amount\"\r\n            type=\"number\"\r\n            value={filters.amountRange?.max || \"\"}\r\n            onChange={(e) => {\r\n              const max = parseFloat(e.target.value) || 999999\r\n              onFiltersChange({\r\n                ...filters,\r\n                amountRange: {\r\n                  min: filters.amountRange?.min || 0,\r\n                  max\r\n                }\r\n              })\r\n            }}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex justify-end space-x-2 pt-4\">\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={() => onFiltersChange({})}\r\n        >\r\n          Clear Filters\r\n        </Button>\r\n        <Button size=\"sm\">\r\n          Apply Filters\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// Invoice Detail View Component\r\nfunction InvoiceDetailView({\r\n  invoice,\r\n  onClose\r\n}: {\r\n  invoice: Invoice\r\n  onClose: () => void\r\n}) {\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Tabs defaultValue=\"overview\" className=\"w-full\">\r\n        <TabsList className=\"grid w-full grid-cols-6\">\r\n          <TabsTrigger value=\"overview\">Overview</TabsTrigger>\r\n          <TabsTrigger value=\"approval\">Approval</TabsTrigger>\r\n          <TabsTrigger value=\"matching\">3-Way Match</TabsTrigger>\r\n          <TabsTrigger value=\"payment\">Payment</TabsTrigger>\r\n          <TabsTrigger value=\"documents\">Documents</TabsTrigger>\r\n          <TabsTrigger value=\"history\">History</TabsTrigger>\r\n        </TabsList>\r\n\r\n        <TabsContent value=\"overview\" className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-2 gap-6\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg\">Invoice Information</CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Invoice Number</Label>\r\n                    <p className=\"font-medium\">{invoice.number}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Status</Label>\r\n                    <div className=\"mt-1\">\r\n                      <Badge className={getStatusColor(invoice.status)}>\r\n                        {invoice.status.replace(\"_\", \" \").toUpperCase()}\r\n                      </Badge>\r\n                    </div>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Invoice Date</Label>\r\n                    <p className=\"font-medium\">{formatDate(invoice.invoiceDate)}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Due Date</Label>\r\n                    <p className=\"font-medium\">{formatDate(invoice.dueDate)}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Payment Terms</Label>\r\n                    <p className=\"font-medium\">{invoice.paymentTerms}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Currency</Label>\r\n                    <p className=\"font-medium\">{invoice.currency}</p>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg\">Supplier Information</CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div className=\"space-y-3 text-sm\">\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Supplier Name</Label>\r\n                    <p className=\"font-medium\">{invoice.supplierName}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Supplier Code</Label>\r\n                    <p className=\"font-medium\">{invoice.supplierCode}</p>\r\n                  </div>\r\n                  {invoice.purchaseOrderNumber && (\r\n                    <div>\r\n                      <Label className=\"text-muted-foreground\">Purchase Order</Label>\r\n                      <p className=\"font-medium\">{invoice.purchaseOrderNumber}</p>\r\n                    </div>\r\n                  )}\r\n                  {invoice.receiptNumber && (\r\n                    <div>\r\n                      <Label className=\"text-muted-foreground\">Receipt Number</Label>\r\n                      <p className=\"font-medium\">{invoice.receiptNumber}</p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"text-lg\">Financial Summary</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"grid grid-cols-4 gap-4\">\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {formatCurrency(invoice.subtotal, invoice.currency)}\r\n                  </p>\r\n                  <p className=\"text-sm text-muted-foreground\">Subtotal</p>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {formatCurrency(invoice.taxAmount, invoice.currency)}\r\n                  </p>\r\n                  <p className=\"text-sm text-muted-foreground\">Tax</p>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {formatCurrency(invoice.totalAmount, invoice.currency)}\r\n                  </p>\r\n                  <p className=\"text-sm text-muted-foreground\">Total</p>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {formatCurrency(invoice.remainingAmount, invoice.currency)}\r\n                  </p>\r\n                  <p className=\"text-sm text-muted-foreground\">Remaining</p>\r\n                </div>\r\n              </div>\r\n\r\n              {invoice.earlyPaymentDiscount && (\r\n                <div className=\"mt-4 p-3 bg-green-50 rounded-lg border border-green-200\">\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <Percent className=\"h-4 w-4 text-green-600\" />\r\n                    <span className=\"font-medium text-green-800\">\r\n                      Early Payment Discount Available\r\n                    </span>\r\n                  </div>\r\n                  <p className=\"text-sm text-green-700 mt-1\">\r\n                    Save {formatCurrency(invoice.earlyPaymentDiscount.discountAmount, invoice.currency)}\r\n                    ({invoice.earlyPaymentDiscount.percentage}%) if paid by{\" \"}\r\n                    {formatDate(invoice.earlyPaymentDiscount.eligibleUntil)}\r\n                  </p>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"approval\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Approval Workflow</CardTitle>\r\n              <CardDescription>\r\n                Track the approval process and current status\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span>Current Status</span>\r\n                  <Badge className={getStatusColor(invoice.approvalStatus)}>\r\n                    {invoice.approvalStatus.replace(\"_\", \" \").toUpperCase()}\r\n                  </Badge>\r\n                </div>\r\n\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex items-center space-x-3\">\r\n                    <div className=\"w-2 h-2 bg-green-500 rounded-full\"></div>\r\n                    <div className=\"flex-1\">\r\n                      <p className=\"font-medium\">Document Received</p>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        {formatDateTime(invoice.receivedDate)}\r\n                      </p>\r\n                    </div>\r\n                    <CheckCircle className=\"h-5 w-5 text-green-500\" />\r\n                  </div>\r\n\r\n                  {invoice.processedDate && (\r\n                    <div className=\"flex items-center space-x-3\">\r\n                      <div className=\"w-2 h-2 bg-green-500 rounded-full\"></div>\r\n                      <div className=\"flex-1\">\r\n                        <p className=\"font-medium\">Document Processed</p>\r\n                        <p className=\"text-sm text-muted-foreground\">\r\n                          {formatDateTime(invoice.processedDate)}\r\n                        </p>\r\n                      </div>\r\n                      <CheckCircle className=\"h-5 w-5 text-green-500\" />\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"flex items-center space-x-3\">\r\n                    <div className={cn(\r\n                      \"w-2 h-2 rounded-full\",\r\n                      invoice.approvalStatus === \"approved\" ? \"bg-green-500\" : \"bg-yellow-500\"\r\n                    )}></div>\r\n                    <div className=\"flex-1\">\r\n                      <p className=\"font-medium\">Approval Review</p>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        {invoice.approvedDate ?\r\n                          formatDateTime(invoice.approvedDate) :\r\n                          \"Pending approval\"\r\n                        }\r\n                      </p>\r\n                    </div>\r\n                    {invoice.approvedDate ? (\r\n                      <CheckCircle className=\"h-5 w-5 text-green-500\" />\r\n                    ) : (\r\n                      <Clock className=\"h-5 w-5 text-yellow-500\" />\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"matching\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Three-Way Matching</CardTitle>\r\n              <CardDescription>\r\n                Compare invoice, purchase order, and receipt data\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span>Matching Status</span>\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    {getMatchingStatusIcon(invoice.matchingStatus)}\r\n                    <Badge className={getStatusColor(invoice.matchingStatus)}>\r\n                      {invoice.matchingStatus.replace(\"_\", \" \").toUpperCase()}\r\n                    </Badge>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm\">Invoice</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-2 text-sm\">\r\n                        <div className=\"flex justify-between\">\r\n                          <span>Amount</span>\r\n                          <span className=\"font-medium\">\r\n                            {formatCurrency(invoice.totalAmount, invoice.currency)}\r\n                          </span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                          <span>Date</span>\r\n                          <span>{formatDate(invoice.invoiceDate)}</span>\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm\">Purchase Order</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      {invoice.purchaseOrderNumber ? (\r\n                        <div className=\"space-y-2 text-sm\">\r\n                          <div className=\"flex justify-between\">\r\n                            <span>Amount</span>\r\n                            <span className=\"font-medium\">\r\n                              {formatCurrency(invoice.totalAmount, invoice.currency)}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"flex justify-between\">\r\n                            <span>PO #</span>\r\n                            <span>{invoice.purchaseOrderNumber}</span>\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        <p className=\"text-sm text-muted-foreground\">No PO linked</p>\r\n                      )}\r\n                    </CardContent>\r\n                  </Card>\r\n\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm\">Receipt</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      {invoice.receiptNumber ? (\r\n                        <div className=\"space-y-2 text-sm\">\r\n                          <div className=\"flex justify-between\">\r\n                            <span>Receipt #</span>\r\n                            <span>{invoice.receiptNumber}</span>\r\n                          </div>\r\n                          <div className=\"flex justify-between\">\r\n                            <span>Status</span>\r\n                            <span className=\"text-green-600\">Matched</span>\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        <p className=\"text-sm text-muted-foreground\">No receipt linked</p>\r\n                      )}\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>\r\n\r\n                {invoice.matchingStatus === \"exceptions\" && (\r\n                  <Card className=\"border-yellow-200 bg-yellow-50\">\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-sm text-yellow-800\">\r\n                        Matching Exceptions\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-2\">\r\n                        <div className=\"flex items-center space-x-2 text-sm\">\r\n                          <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\r\n                          <span>Price variance exceeds tolerance (5%)</span>\r\n                        </div>\r\n                        <div className=\"flex items-center space-x-2 text-sm\">\r\n                          <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\r\n                          <span>Quantity discrepancy found</span>\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"payment\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Payment Information</CardTitle>\r\n              <CardDescription>\r\n                Payment status, schedule, and transaction details\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-6\">\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Payment Status</Label>\r\n                    <div className=\"mt-1\">\r\n                      <Badge className={getStatusColor(invoice.paymentStatus)}>\r\n                        {invoice.paymentStatus.replace(\"_\", \" \").toUpperCase()}\r\n                      </Badge>\r\n                    </div>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Payment Method</Label>\r\n                    <p className=\"font-medium\">Electronic Transfer</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Amount Paid</Label>\r\n                    <p className=\"font-medium\">\r\n                      {formatCurrency(invoice.paidAmount, invoice.currency)}\r\n                    </p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Remaining</Label>\r\n                    <p className=\"font-medium\">\r\n                      {formatCurrency(invoice.remainingAmount, invoice.currency)}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n\r\n                {invoice.remainingAmount > 0 && (\r\n                  <div className=\"flex space-x-2\">\r\n                    <Button>\r\n                      <CreditCard className=\"mr-2 h-4 w-4\" />\r\n                      Schedule Payment\r\n                    </Button>\r\n                    <Button variant=\"outline\">\r\n                      <Send className=\"mr-2 h-4 w-4\" />\r\n                      Send to Payments\r\n                    </Button>\r\n                  </div>\r\n                )}\r\n\r\n                {invoice.paidDate && (\r\n                  <div className=\"p-3 bg-green-50 rounded-lg border border-green-200\">\r\n                    <div className=\"flex items-center space-x-2\">\r\n                      <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n                      <span className=\"font-medium text-green-800\">\r\n                        Payment Completed\r\n                      </span>\r\n                    </div>\r\n                    <p className=\"text-sm text-green-700 mt-1\">\r\n                      Paid on {formatDateTime(invoice.paidDate)}\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"documents\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Attached Documents</CardTitle>\r\n              <CardDescription>\r\n                View and manage invoice documents and attachments\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                <Button variant=\"outline\">\r\n                  <Paperclip className=\"mr-2 h-4 w-4\" />\r\n                  Add Document\r\n                </Button>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                    <div className=\"flex items-center space-x-3\">\r\n                      <FileText className=\"h-5 w-5 text-blue-500\" />\r\n                      <div>\r\n                        <p className=\"font-medium\">Original Invoice.pdf</p>\r\n                        <p className=\"text-sm text-muted-foreground\">Uploaded 2 hours ago</p>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"flex items-center space-x-2\">\r\n                      <Button variant=\"ghost\" size=\"sm\">\r\n                        <Eye className=\"h-4 w-4\" />\r\n                      </Button>\r\n                      <Button variant=\"ghost\" size=\"sm\">\r\n                        <Download className=\"h-4 w-4\" />\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                    <div className=\"flex items-center space-x-3\">\r\n                      <Receipt className=\"h-5 w-5 text-green-500\" />\r\n                      <div>\r\n                        <p className=\"font-medium\">Delivery Receipt.pdf</p>\r\n                        <p className=\"text-sm text-muted-foreground\">Uploaded 1 day ago</p>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"flex items-center space-x-2\">\r\n                      <Button variant=\"ghost\" size=\"sm\">\r\n                        <Eye className=\"h-4 w-4\" />\r\n                      </Button>\r\n                      <Button variant=\"ghost\" size=\"sm\">\r\n                        <Download className=\"h-4 w-4\" />\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"history\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Audit Trail</CardTitle>\r\n              <CardDescription>\r\n                Complete history of invoice processing and changes\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-start space-x-3\">\r\n                  <div className=\"w-2 h-2 bg-blue-500 rounded-full mt-2\"></div>\r\n                  <div className=\"flex-1\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <p className=\"font-medium\">Invoice created</p>\r\n                      <span className=\"text-sm text-muted-foreground\">\r\n                        {formatDateTime(invoice.createdAt)}\r\n                      </span>\r\n                    </div>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Created by {invoice.createdBy}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n\r\n                {invoice.processedDate && (\r\n                  <div className=\"flex items-start space-x-3\">\r\n                    <div className=\"w-2 h-2 bg-green-500 rounded-full mt-2\"></div>\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <p className=\"font-medium\">OCR processing completed</p>\r\n                        <span className=\"text-sm text-muted-foreground\">\r\n                          {formatDateTime(invoice.processedDate)}\r\n                        </span>\r\n                      </div>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        Confidence: {invoice.ocrConfidence}%\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {invoice.approvedDate && (\r\n                  <div className=\"flex items-start space-x-3\">\r\n                    <div className=\"w-2 h-2 bg-green-500 rounded-full mt-2\"></div>\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <p className=\"font-medium\">Invoice approved</p>\r\n                        <span className=\"text-sm text-muted-foreground\">\r\n                          {formatDateTime(invoice.approvedDate)}\r\n                        </span>\r\n                      </div>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        Approved by finance team\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {invoice.paidDate && (\r\n                  <div className=\"flex items-start space-x-3\">\r\n                    <div className=\"w-2 h-2 bg-green-500 rounded-full mt-2\"></div>\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <p className=\"font-medium\">Payment processed</p>\r\n                        <span className=\"text-sm text-muted-foreground\">\r\n                          {formatDateTime(invoice.paidDate)}\r\n                        </span>\r\n                      </div>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        {formatCurrency(invoice.totalAmount, invoice.currency)} paid\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {invoice.disputed && (\r\n                  <div className=\"flex items-start space-x-3\">\r\n                    <div className=\"w-2 h-2 bg-red-500 rounded-full mt-2\"></div>\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <p className=\"font-medium\">Dispute raised</p>\r\n                        <span className=\"text-sm text-muted-foreground\">\r\n                          {formatDateTime(invoice.disputeDate!)}\r\n                        </span>\r\n                      </div>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        Reason: {invoice.disputeReason}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n      </Tabs>\r\n\r\n      <DialogFooter>\r\n        <Button variant=\"outline\" onClick={onClose}>\r\n          Close\r\n        </Button>\r\n        <Button>\r\n          <Edit className=\"mr-2 h-4 w-4\" />\r\n          Edit Invoice\r\n        </Button>\r\n      </DialogFooter>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\messages\\page.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":429,"column":33,"nodeType":"Identifier","messageId":"undef","endLine":429,"endColumn":47}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useRef, useEffect } from \"react\"\r\nimport AppLayout from \"@/components/layout/AppLayout\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { Tooltip } from \"@/components/ui/tooltip\"\r\nimport {\r\n  Search,\r\n  Send,\r\n  Paperclip,\r\n  Phone,\r\n  Video,\r\n  MoreVertical,\r\n  Archive,\r\n  Star,\r\n  Filter,\r\n  MessageSquare,\r\n  Users,\r\n  Circle,\r\n  Clock,\r\n  Check,\r\n  CheckCheck,\r\n  AlertTriangle,\r\n  FileText,\r\n  Image as ImageIcon,\r\n  Download,\r\n  X,\r\n  Smile,\r\n  Plus\r\n} from \"lucide-react\"\r\n\r\n// Types\r\ninterface Message {\r\n  id: string\r\n  content: string\r\n  timestamp: Date\r\n  sender: {\r\n    id: string\r\n    name: string\r\n    avatar?: string\r\n    initials: string\r\n  }\r\n  isOwn: boolean\r\n  status: \"sent\" | \"delivered\" | \"read\"\r\n  attachments?: Array<{\r\n    id: string\r\n    name: string\r\n    type: \"image\" | \"document\" | \"other\"\r\n    size: string\r\n    url: string\r\n  }>\r\n}\r\n\r\ninterface Conversation {\r\n  id: string\r\n  name: string\r\n  avatar?: string\r\n  initials: string\r\n  lastMessage: string\r\n  timestamp: Date\r\n  unreadCount: number\r\n  isOnline: boolean\r\n  isTyping: boolean\r\n  isPinned: boolean\r\n  type: \"direct\" | \"group\"\r\n  participants?: string[]\r\n}\r\n\r\n// Mock data\r\nconst mockConversations: Conversation[] = [\r\n  {\r\n    id: \"1\",\r\n    name: \"Sarah Chen\",\r\n    initials: \"SC\",\r\n    lastMessage: \"The contract documents are ready for review\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 15),\r\n    unreadCount: 2,\r\n    isOnline: true,\r\n    isTyping: false,\r\n    isPinned: true,\r\n    type: \"direct\"\r\n  },\r\n  {\r\n    id: \"2\",\r\n    name: \"TechCorp Team\",\r\n    initials: \"TC\",\r\n    lastMessage: \"Meeting scheduled for tomorrow at 2 PM\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 45),\r\n    unreadCount: 0,\r\n    isOnline: false,\r\n    isTyping: true,\r\n    isPinned: false,\r\n    type: \"group\",\r\n    participants: [\"John Doe\", \"Sarah Chen\", \"Mike Johnson\"]\r\n  },\r\n  {\r\n    id: \"3\",\r\n    name: \"Global Manufacturing\",\r\n    initials: \"GM\",\r\n    lastMessage: \"Invoice #INV-2024-003 has been processed\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2),\r\n    unreadCount: 1,\r\n    isOnline: true,\r\n    isTyping: false,\r\n    isPinned: false,\r\n    type: \"direct\"\r\n  },\r\n  {\r\n    id: \"4\",\r\n    name: \"Procurement Team\",\r\n    initials: \"PT\",\r\n    lastMessage: \"Budget approval needed for Q1 purchases\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 4),\r\n    unreadCount: 0,\r\n    isOnline: false,\r\n    isTyping: false,\r\n    isPinned: true,\r\n    type: \"group\",\r\n    participants: [\"Alice Wilson\", \"Bob Smith\", \"Carol Brown\"]\r\n  }\r\n]\r\n\r\nconst mockMessages: Message[] = [\r\n  {\r\n    id: \"1\",\r\n    content: \"Hi! I've reviewed the latest supplier contracts and have some questions about the terms.\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 60),\r\n    sender: {\r\n      id: \"sarah\",\r\n      name: \"Sarah Chen\",\r\n      initials: \"SC\"\r\n    },\r\n    isOwn: false,\r\n    status: \"read\"\r\n  },\r\n  {\r\n    id: \"2\",\r\n    content: \"Sure, I'd be happy to clarify. Which specific terms are you concerned about?\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 45),\r\n    sender: {\r\n      id: \"me\",\r\n      name: \"John Doe\",\r\n      initials: \"JD\"\r\n    },\r\n    isOwn: true,\r\n    status: \"delivered\"\r\n  },\r\n  {\r\n    id: \"3\",\r\n    content: \"The payment terms seem quite aggressive - 15 days instead of our usual 30. Also, the delivery penalties look steep.\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 30),\r\n    sender: {\r\n      id: \"sarah\",\r\n      name: \"Sarah Chen\",\r\n      initials: \"SC\"\r\n    },\r\n    isOwn: false,\r\n    status: \"read\"\r\n  },\r\n  {\r\n    id: \"4\",\r\n    content: \"I've attached the contract analysis document with highlighted sections that need attention.\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 25),\r\n    sender: {\r\n      id: \"sarah\",\r\n      name: \"Sarah Chen\",\r\n      initials: \"SC\"\r\n    },\r\n    isOwn: false,\r\n    status: \"read\",\r\n    attachments: [\r\n      {\r\n        id: \"att1\",\r\n        name: \"Contract_Analysis_TechCorp_2024.pdf\",\r\n        type: \"document\",\r\n        size: \"2.4 MB\",\r\n        url: \"#\"\r\n      }\r\n    ]\r\n  },\r\n  {\r\n    id: \"5\",\r\n    content: \"Thanks for the detailed analysis. Let me review this and get back to you by end of day.\",\r\n    timestamp: new Date(Date.now() - 1000 * 60 * 15),\r\n    sender: {\r\n      id: \"me\",\r\n      name: \"John Doe\",\r\n      initials: \"JD\"\r\n    },\r\n    isOwn: true,\r\n    status: \"read\"\r\n  }\r\n]\r\n\r\n// Utility functions\r\nconst formatTime = (date: Date) => {\r\n  const now = new Date()\r\n  const diff = now.getTime() - date.getTime()\r\n  const minutes = Math.floor(diff / (1000 * 60))\r\n  const hours = Math.floor(diff / (1000 * 60 * 60))\r\n  const days = Math.floor(diff / (1000 * 60 * 60 * 24))\r\n\r\n  if (minutes < 1) return \"now\"\r\n  if (minutes < 60) return `${minutes}m`\r\n  if (hours < 24) return `${hours}h`\r\n  if (days < 7) return `${days}d`\r\n  return date.toLocaleDateString()\r\n}\r\n\r\nconst formatMessageTime = (date: Date) => {\r\n  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })\r\n}\r\n\r\n// Components\r\nconst ConversationList: React.FC<{\r\n  conversations: Conversation[]\r\n  selectedId?: string\r\n  onSelect: (id: string) => void\r\n  searchQuery: string\r\n  onSearchChange: (query: string) => void\r\n}> = ({ conversations, selectedId, onSelect, searchQuery, onSearchChange }) => {\r\n  const [filter, setFilter] = useState<\"all\" | \"unread\" | \"pinned\">(\"all\")\r\n\r\n  const filteredConversations = conversations.filter(conv => {\r\n    const matchesSearch = conv.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n                         conv.lastMessage.toLowerCase().includes(searchQuery.toLowerCase())\r\n\r\n    if (!matchesSearch) return false\r\n\r\n    switch (filter) {\r\n      case \"unread\": return conv.unreadCount > 0\r\n      case \"pinned\": return conv.isPinned\r\n      default: return true\r\n    }\r\n  }).sort((a, b) => {\r\n    // Sort pinned first, then by timestamp\r\n    if (a.isPinned && !b.isPinned) return -1\r\n    if (!a.isPinned && b.isPinned) return 1\r\n    return b.timestamp.getTime() - a.timestamp.getTime()\r\n  })\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-full\">\r\n      {/* Header */}\r\n      <div className=\"p-4 border-b\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <h2 className=\"text-lg font-semibold\">Messages</h2>\r\n          <Button size=\"icon\" variant=\"outline\" className=\"h-8 w-8\">\r\n            <Plus className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">New conversation</span>\r\n          </Button>\r\n        </div>\r\n\r\n        {/* Search */}\r\n        <div className=\"relative mb-3\">\r\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n          <Input\r\n            placeholder=\"Search conversations...\"\r\n            value={searchQuery}\r\n            onChange={(e) => onSearchChange(e.target.value)}\r\n            className=\"pl-9\"\r\n            aria-label=\"Search conversations\"\r\n          />\r\n        </div>\r\n\r\n        {/* Filter Tabs */}\r\n        <Tabs value={filter} onValueChange={(v) => setFilter(v as typeof filter)}>\r\n          <TabsList className=\"grid w-full grid-cols-3\">\r\n            <TabsTrigger value=\"all\" className=\"text-xs\">All</TabsTrigger>\r\n            <TabsTrigger value=\"unread\" className=\"text-xs\">Unread</TabsTrigger>\r\n            <TabsTrigger value=\"pinned\" className=\"text-xs\">Pinned</TabsTrigger>\r\n          </TabsList>\r\n        </Tabs>\r\n      </div>\r\n\r\n      {/* Conversations */}\r\n      <ScrollArea className=\"flex-1\">\r\n        <div className=\"space-y-1 p-2\">\r\n          {filteredConversations.map((conversation) => (\r\n            <div\r\n              key={conversation.id}\r\n              onClick={() => onSelect(conversation.id)}\r\n              className={`p-3 rounded-lg cursor-pointer transition-colors hover:bg-muted/50 ${\r\n                selectedId === conversation.id ? \"bg-muted\" : \"\"\r\n              }`}\r\n              role=\"button\"\r\n              tabIndex={0}\r\n              onKeyDown={(e) => {\r\n                if (e.key === \"Enter\" || e.key === \" \") {\r\n                  e.preventDefault()\r\n                  onSelect(conversation.id)\r\n                }\r\n              }}\r\n              aria-label={`Conversation with ${conversation.name}`}\r\n            >\r\n              <div className=\"flex items-start gap-3\">\r\n                <div className=\"relative\">\r\n                  <Avatar className=\"h-10 w-10\">\r\n                    {conversation.avatar && (\r\n                      <AvatarImage src={conversation.avatar} alt={conversation.name} />\r\n                    )}\r\n                    <AvatarFallback>{conversation.initials}</AvatarFallback>\r\n                  </Avatar>\r\n                  {conversation.isOnline && (\r\n                    <Circle className=\"absolute -bottom-0.5 -right-0.5 h-3 w-3 fill-green-500 text-green-500\" />\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"flex-1 min-w-0\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <p className=\"text-sm font-medium truncate\">{conversation.name}</p>\r\n                      {conversation.isPinned && (\r\n                        <Star className=\"h-3 w-3 fill-yellow-400 text-yellow-400\" />\r\n                      )}\r\n                      {conversation.type === \"group\" && (\r\n                        <Users className=\"h-3 w-3 text-muted-foreground\" />\r\n                      )}\r\n                    </div>\r\n                    <span className=\"text-xs text-muted-foreground\">\r\n                      {formatTime(conversation.timestamp)}\r\n                    </span>\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center justify-between mt-1\">\r\n                    <p className=\"text-sm text-muted-foreground truncate\">\r\n                      {conversation.isTyping ? (\r\n                        <span className=\"text-primary\">Typing...</span>\r\n                      ) : (\r\n                        conversation.lastMessage\r\n                      )}\r\n                    </p>\r\n                    {conversation.unreadCount > 0 && (\r\n                      <Badge variant=\"default\" className=\"h-5 w-5 p-0 text-xs flex items-center justify-center\">\r\n                        {conversation.unreadCount > 9 ? \"9+\" : conversation.unreadCount}\r\n                      </Badge>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </ScrollArea>\r\n    </div>\r\n  )\r\n}\r\n\r\ntype MessageAttachment = Message['attachments'] extends Array<infer A> ? A : never\r\n\r\nconst MessageBubble: React.FC<{ message: Message }> = ({ message }) => {\r\n  const renderAttachment = (attachment: MessageAttachment) => (\r\n    <div key={attachment.id} className=\"flex items-center gap-2 p-2 border rounded-lg bg-muted/50 mt-2\">\r\n      {attachment.type === \"document\" ? (\r\n        <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n      ) : (\r\n        <ImageIcon className=\"h-4 w-4 text-muted-foreground\" />\r\n      )}\r\n      <div className=\"flex-1 min-w-0\">\r\n        <p className=\"text-sm font-medium truncate\">{attachment.name}</p>\r\n        <p className=\"text-xs text-muted-foreground\">{attachment.size}</p>\r\n      </div>\r\n      <Button size=\"icon\" variant=\"ghost\" className=\"h-6 w-6\">\r\n        <Download className=\"h-3 w-3\" />\r\n        <span className=\"sr-only\">Download {attachment.name}</span>\r\n      </Button>\r\n    </div>\r\n  )\r\n\r\n  const StatusIcon = () => {\r\n    switch (message.status) {\r\n      case \"sent\": return <Check className=\"h-3 w-3\" />\r\n      case \"delivered\": return <CheckCheck className=\"h-3 w-3\" />\r\n      case \"read\": return <CheckCheck className=\"h-3 w-3 text-blue-500\" />\r\n      default: return null\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className={`flex gap-3 group ${message.isOwn ? \"flex-row-reverse\" : \"\"}`}>\r\n      {!message.isOwn && (\r\n        <Avatar className=\"h-8 w-8\">\r\n          {message.sender.avatar && (\r\n            <AvatarImage src={message.sender.avatar} alt={message.sender.name} />\r\n          )}\r\n          <AvatarFallback>{message.sender.initials}</AvatarFallback>\r\n        </Avatar>\r\n      )}\r\n\r\n      <div className={`flex flex-col ${message.isOwn ? \"items-end\" : \"items-start\"} max-w-[70%]`}>\r\n        <div\r\n          className={`rounded-lg px-3 py-2 ${\r\n            message.isOwn\r\n              ? \"bg-primary text-primary-foreground\"\r\n              : \"bg-muted\"\r\n          }`}\r\n        >\r\n          <p className=\"text-sm\">{message.content}</p>\r\n          {message.attachments?.map(renderAttachment)}\r\n        </div>\r\n\r\n        <div className={`flex items-center gap-1 mt-1 ${message.isOwn ? \"flex-row-reverse\" : \"\"}`}>\r\n          <span className=\"text-xs text-muted-foreground\">\r\n            {formatMessageTime(message.timestamp)}\r\n          </span>\r\n          {message.isOwn && <StatusIcon />}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nconst MessageThread: React.FC<{\r\n  conversation?: Conversation\r\n  messages: Message[]\r\n  onSendMessage: (content: string, attachments?: File[]) => void\r\n}> = ({ conversation, messages, onSendMessage }) => {\r\n  const [messageInput, setMessageInput] = useState(\"\")\r\n  const [attachments, setAttachments] = useState<File[]>([])\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n  const messagesEndRef = useRef<HTMLDivElement>(null)\r\n\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\r\n  }, [messages])\r\n\r\n  const handleSend = () => {\r\n    if (messageInput.trim() || attachments.length > 0) {\r\n      onSendMessage(messageInput.trim(), attachments)\r\n      setMessageInput(\"\")\r\n      setAttachments([])\r\n    }\r\n  }\r\n\r\n  const handleKeyPress = (e: React.KeyboardEvent) => {\r\n    if (e.key === \"Enter\" && !e.shiftKey) {\r\n      e.preventDefault()\r\n      handleSend()\r\n    }\r\n  }\r\n\r\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const files = Array.from(e.target.files || [])\r\n    setAttachments(prev => [...prev, ...files])\r\n  }\r\n\r\n  const removeAttachment = (index: number) => {\r\n    setAttachments(prev => prev.filter((_, i) => i !== index))\r\n  }\r\n\r\n  if (!conversation) {\r\n    return (\r\n      <div className=\"flex-1 flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <MessageSquare className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-medium\">Select a conversation</h3>\r\n          <p className=\"text-muted-foreground\">Choose a conversation from the sidebar to start messaging</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-full\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between p-4 border-b\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <div className=\"relative\">\r\n            <Avatar className=\"h-10 w-10\">\r\n              {conversation.avatar && (\r\n                <AvatarImage src={conversation.avatar} alt={conversation.name} />\r\n              )}\r\n              <AvatarFallback>{conversation.initials}</AvatarFallback>\r\n            </Avatar>\r\n            {conversation.isOnline && (\r\n              <Circle className=\"absolute -bottom-0.5 -right-0.5 h-3 w-3 fill-green-500 text-green-500\" />\r\n            )}\r\n          </div>\r\n          <div>\r\n            <h3 className=\"font-medium\">{conversation.name}</h3>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              {conversation.isTyping ? (\r\n                \"Typing...\"\r\n              ) : conversation.isOnline ? (\r\n                \"Online\"\r\n              ) : (\r\n                `Last seen ${formatTime(conversation.timestamp)}`\r\n              )}\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button size=\"icon\" variant=\"outline\" className=\"h-8 w-8\">\r\n            <Phone className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">Start voice call</span>\r\n          </Button>\r\n          <Button size=\"icon\" variant=\"outline\" className=\"h-8 w-8\">\r\n            <Video className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">Start video call</span>\r\n          </Button>\r\n          <Button size=\"icon\" variant=\"outline\" className=\"h-8 w-8\">\r\n            <MoreVertical className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">More options</span>\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Messages */}\r\n      <ScrollArea className=\"flex-1 p-4\">\r\n        <div className=\"space-y-4\">\r\n          {messages.map((message) => (\r\n            <MessageBubble key={message.id} message={message} />\r\n          ))}\r\n          {conversation.isTyping && (\r\n            <div className=\"flex gap-3\">\r\n              <Avatar className=\"h-8 w-8\">\r\n                <AvatarFallback>{conversation.initials}</AvatarFallback>\r\n              </Avatar>\r\n              <div className=\"bg-muted rounded-lg px-3 py-2\">\r\n                <div className=\"flex gap-1\">\r\n                  <div className=\"w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce [animation-delay:-0.3s]\" />\r\n                  <div className=\"w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce [animation-delay:-0.15s]\" />\r\n                  <div className=\"w-2 h-2 bg-muted-foreground/60 rounded-full animate-bounce\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n          <div ref={messagesEndRef} />\r\n        </div>\r\n      </ScrollArea>\r\n\r\n      {/* Input */}\r\n      <div className=\"p-4 border-t\">\r\n        {/* Attachments Preview */}\r\n        {attachments.length > 0 && (\r\n          <div className=\"mb-3 space-y-2\">\r\n            {attachments.map((file, index) => (\r\n              <div key={index} className=\"flex items-center gap-2 p-2 bg-muted rounded-lg\">\r\n                <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n                <span className=\"text-sm flex-1 truncate\">{file.name}</span>\r\n                <Button\r\n                  size=\"icon\"\r\n                  variant=\"ghost\"\r\n                  className=\"h-6 w-6\"\r\n                  onClick={() => removeAttachment(index)}\r\n                >\r\n                  <X className=\"h-3 w-3\" />\r\n                  <span className=\"sr-only\">Remove {file.name}</span>\r\n                </Button>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"flex items-end gap-2\">\r\n          <Button\r\n            size=\"icon\"\r\n            variant=\"outline\"\r\n            onClick={() => fileInputRef.current?.click()}\r\n            className=\"h-10 w-10\"\r\n          >\r\n            <Paperclip className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">Attach file</span>\r\n          </Button>\r\n\r\n          <div className=\"flex-1\">\r\n            <Textarea\r\n              value={messageInput}\r\n              onChange={(e) => setMessageInput(e.target.value)}\r\n              onKeyDown={handleKeyPress}\r\n              placeholder=\"Type a message...\"\r\n              className=\"min-h-[40px] max-h-32 resize-none\"\r\n              aria-label=\"Message input\"\r\n            />\r\n          </div>\r\n\r\n          <Button\r\n            onClick={handleSend}\r\n            disabled={!messageInput.trim() && attachments.length === 0}\r\n            className=\"h-10 w-10\"\r\n            size=\"icon\"\r\n          >\r\n            <Send className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">Send message</span>\r\n          </Button>\r\n        </div>\r\n\r\n        <input\r\n          ref={fileInputRef}\r\n          type=\"file\"\r\n          multiple\r\n          className=\"hidden\"\r\n          onChange={handleFileSelect}\r\n          aria-label=\"File input\"\r\n        />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default function MessagesPage() {\r\n  const [selectedConversationId, setSelectedConversationId] = useState<string>()\r\n  const [conversations, setConversations] = useState(mockConversations)\r\n  const [messages, setMessages] = useState(mockMessages)\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n\r\n  const selectedConversation = conversations.find(c => c.id === selectedConversationId)\r\n\r\n  const handleSendMessage = (content: string, attachments?: File[]) => {\r\n    const newMessage: Message = {\r\n      id: Date.now().toString(),\r\n      content,\r\n      timestamp: new Date(),\r\n      sender: {\r\n        id: \"me\",\r\n        name: \"John Doe\",\r\n        initials: \"JD\"\r\n      },\r\n      isOwn: true,\r\n      status: \"sent\",\r\n      attachments: attachments?.map(file => ({\r\n        id: Date.now().toString(),\r\n        name: file.name,\r\n        type: file.type.startsWith(\"image/\") ? \"image\" : \"document\",\r\n        size: `${(file.size / 1024 / 1024).toFixed(1)} MB`,\r\n        url: URL.createObjectURL(file)\r\n      }))\r\n    }\r\n\r\n    setMessages(prev => [...prev, newMessage])\r\n\r\n    // Update conversation last message\r\n    if (selectedConversationId) {\r\n      setConversations(prev => prev.map(conv =>\r\n        conv.id === selectedConversationId\r\n          ? { ...conv, lastMessage: content || \"📎 Attachment\", timestamp: new Date() }\r\n          : conv\r\n      ))\r\n    }\r\n  }\r\n\r\n  const breadcrumbs = [\r\n    { label: \"Messages\" }\r\n  ]\r\n\r\n  return (\r\n    <AppLayout title=\"Messages\" breadcrumbs={breadcrumbs}>\r\n      <Card className=\"h-[calc(100vh-12rem)]\">\r\n        <div className=\"flex h-full\">\r\n          {/* Conversation List */}\r\n          <div className=\"w-80 border-r\">\r\n            <ConversationList\r\n              conversations={conversations}\r\n              selectedId={selectedConversationId}\r\n              onSelect={setSelectedConversationId}\r\n              searchQuery={searchQuery}\r\n              onSearchChange={setSearchQuery}\r\n            />\r\n          </div>\r\n\r\n          {/* Message Thread */}\r\n          <div className=\"flex-1\">\r\n            <MessageThread\r\n              conversation={selectedConversation}\r\n              messages={messages}\r\n              onSendMessage={handleSendMessage}\r\n            />\r\n          </div>\r\n        </div>\r\n      </Card>\r\n    </AppLayout>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\purchase-orders\\page.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'getThreeWayMatchIcon' is not defined.","line":2156,"column":22,"nodeType":"Identifier","messageId":"undef","endLine":2156,"endColumn":42}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useMemo } from \"react\"\r\nimport AppLayout from '@/components/layout/AppLayout'\r\nimport {\r\n  Search,\r\n  Filter,\r\n  Download,\r\n  Upload,\r\n  Plus,\r\n  Eye,\r\n  Edit,\r\n  Trash2,\r\n  FileText,\r\n  DollarSign,\r\n  Clock,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  XCircle,\r\n  MoreHorizontal,\r\n  ArrowUpDown,\r\n  ArrowUp,\r\n  ArrowDown,\r\n  Calendar,\r\n  Package,\r\n  Truck,\r\n  Target,\r\n  TrendingUp,\r\n  AlertCircle,\r\n  Users,\r\n  RefreshCw,\r\n  Settings,\r\n  Mail,\r\n  Phone,\r\n  Globe,\r\n  MapPin,\r\n  Building2,\r\n  Banknote,\r\n  Percent,\r\n  FileCheck,\r\n  FileX,\r\n  Zap,\r\n  BarChart3,\r\n  PieChart,\r\n  Activity,\r\n  BookOpen,\r\n  Paperclip,\r\n  MessageSquare,\r\n  History,\r\n  UserCheck,\r\n  Send,\r\n  Ban,\r\n  Copy,\r\n  ExternalLink,\r\n  Shield,\r\n  Star,\r\n  Receipt,\r\n  CreditCard,\r\n  ShoppingCart,\r\n  Package2,\r\n  Warehouse,\r\n  ClipboardCheck,\r\n  Calculator,\r\n  List,\r\n  Grid3X3,\r\n  SortAsc,\r\n  SortDesc\r\n} from \"lucide-react\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow\r\n} from \"@/components/ui/table\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n  DropdownMenuCheckboxItem,\r\n  DropdownMenuRadioGroup,\r\n  DropdownMenuRadioItem\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger\r\n} from \"@/components/ui/dialog\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Tooltip, TooltipContent, TooltipTrigger, TooltipProvider } from \"@/components/ui/tooltip\"\r\nimport { Calendar as CalendarComponent } from \"@/components/ui/calendar\"\r\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\n\r\nimport { formatCurrency, formatDate, formatDateTime, getStatusColor, cn } from \"@/lib/utils\"\r\nimport type {\r\n  PurchaseOrder,\r\n  POFilters,\r\n  PODashboardMetrics,\r\n  POAnalytics,\r\n  BulkOperation,\r\n  POTemplate,\r\n  ReorderPoint\r\n} from \"@/types/purchase-order\"\r\n\r\n// Mock data - in real app this would come from API\r\nconst mockPurchaseOrders: PurchaseOrder[] = [\r\n  {\r\n    id: \"PO-001\",\r\n    poNumber: \"PO-2024-001\",\r\n    supplierId: \"SUP-001\",\r\n    supplierName: \"TechCorp Solutions\",\r\n    supplierCode: \"TECH001\",\r\n    status: \"approved\",\r\n    priority: \"high\",\r\n    createdDate: new Date(\"2024-01-15\"),\r\n    requestedDeliveryDate: new Date(\"2024-02-15\"),\r\n    confirmedDeliveryDate: new Date(\"2024-02-20\"),\r\n    approvedDate: new Date(\"2024-01-18\"),\r\n    items: [\r\n      {\r\n        id: \"item-1\",\r\n        lineNumber: 1,\r\n        productCode: \"LAPTOP-001\",\r\n        description: \"Dell Latitude 7420 Laptop\",\r\n        specifications: \"Intel i7, 16GB RAM, 512GB SSD\",\r\n        category: \"Hardware\",\r\n        subcategory: \"Laptops\",\r\n        quantity: 10,\r\n        receivedQuantity: 8,\r\n        remainingQuantity: 2,\r\n        unit: \"EA\",\r\n        unitPrice: 1200,\r\n        totalPrice: 12000,\r\n        discountPercentage: 5,\r\n        taxPercentage: 8,\r\n        requestedDate: new Date(\"2024-02-15\"),\r\n        confirmedDate: new Date(\"2024-02-20\"),\r\n        status: \"partially_received\",\r\n        qualityRequirements: [\"Manufacturer Warranty\", \"QA Testing\"],\r\n        inspectionRequired: true,\r\n        reorderPointTriggered: false\r\n      }\r\n    ],\r\n    subtotal: 12000,\r\n    taxAmount: 960,\r\n    discountAmount: 600,\r\n    shippingCost: 150,\r\n    totalAmount: 12510,\r\n    currency: \"USD\",\r\n    exchangeRate: 1,\r\n    budgetCode: \"IT-2024-Q1\",\r\n    budgetAllocated: 50000,\r\n    budgetRemaining: 37490,\r\n    department: \"IT\",\r\n    costCenter: \"CC-001\",\r\n    approvalWorkflow: [\r\n      {\r\n        id: \"step-1\",\r\n        stepNumber: 1,\r\n        approverRole: \"Department Manager\",\r\n        approverName: \"Jane Smith\",\r\n        approverEmail: \"jane.smith@company.com\",\r\n        status: \"approved\",\r\n        approvalThreshold: 10000,\r\n        required: true,\r\n        approvedDate: new Date(\"2024-01-17\"),\r\n        comments: \"Approved for urgent business needs\"\r\n      },\r\n      {\r\n        id: \"step-2\",\r\n        stepNumber: 2,\r\n        approverRole: \"Finance Director\",\r\n        approverName: \"Bob Johnson\",\r\n        approverEmail: \"bob.johnson@company.com\",\r\n        status: \"approved\",\r\n        approvalThreshold: 50000,\r\n        required: true,\r\n        approvedDate: new Date(\"2024-01-18\"),\r\n        comments: \"Budget verified and approved\"\r\n      }\r\n    ],\r\n    currentApprovalStep: 2,\r\n    requestedBy: \"john.doe\",\r\n    requestedByName: \"John Doe\",\r\n    approvedBy: \"bob.johnson\",\r\n    approvedByName: \"Bob Johnson\",\r\n    paymentTerms: \"Net 30\",\r\n    deliveryTerms: \"FOB Destination\",\r\n    warrantyTerms: \"1 Year Standard Warranty\",\r\n    deliveryAddress: {\r\n      id: \"addr-1\",\r\n      name: \"Main Office\",\r\n      street: \"123 Business St\",\r\n      city: \"New York\",\r\n      state: \"NY\",\r\n      zipCode: \"10001\",\r\n      country: \"USA\",\r\n      isDefault: true,\r\n      contactName: \"Receiving Department\",\r\n      contactPhone: \"+1-555-0123\",\r\n      contactEmail: \"receiving@company.com\"\r\n    },\r\n    billingAddress: {\r\n      id: \"addr-2\",\r\n      name: \"Corporate Headquarters\",\r\n      street: \"123 Business St\",\r\n      city: \"New York\",\r\n      state: \"NY\",\r\n      zipCode: \"10001\",\r\n      country: \"USA\",\r\n      isDefault: true,\r\n      contactName: \"Accounts Payable\",\r\n      contactPhone: \"+1-555-0124\",\r\n      contactEmail: \"ap@company.com\"\r\n    },\r\n    notes: \"Urgent requirement for new hires. Please expedite delivery.\",\r\n    internalNotes: \"Coordinate with HR for setup schedule\",\r\n    attachments: [\r\n      {\r\n        id: \"att-1\",\r\n        fileName: \"laptop-specs.pdf\",\r\n        originalName: \"Dell_Latitude_7420_Specifications.pdf\",\r\n        fileType: \"application/pdf\",\r\n        fileSize: 2048000,\r\n        uploadDate: new Date(\"2024-01-15\"),\r\n        uploadedBy: \"john.doe\",\r\n        category: \"specification\",\r\n        url: \"/documents/laptop-specs.pdf\",\r\n        description: \"Detailed technical specifications\"\r\n      }\r\n    ],\r\n    trackingNumber: \"TRK-789456123\",\r\n    carrier: \"FedEx\",\r\n    receipts: [\r\n      {\r\n        id: \"rcpt-1\",\r\n        receiptNumber: \"RCP-2024-001\",\r\n        receivedDate: new Date(\"2024-02-18\"),\r\n        receivedBy: \"warehouse.team\",\r\n        items: [\r\n          {\r\n            id: \"rcpt-item-1\",\r\n            poItemId: \"item-1\",\r\n            receivedQuantity: 8,\r\n            acceptedQuantity: 8,\r\n            rejectedQuantity: 0,\r\n            damagedQuantity: 0,\r\n            location: \"WH-A-01-B3\",\r\n            batchNumber: \"BT-2024-0218\",\r\n            qualityGrade: \"A\",\r\n            notes: \"All items received in good condition\"\r\n          }\r\n        ],\r\n        status: \"completed\",\r\n        qualityInspection: {\r\n          id: \"qi-1\",\r\n          inspectorName: \"Quality Control Team\",\r\n          inspectionDate: new Date(\"2024-02-19\"),\r\n          status: \"passed\",\r\n          criteria: [\r\n            {\r\n              id: \"crit-1\",\r\n              criterion: \"Physical Condition\",\r\n              required: true,\r\n              result: \"pass\",\r\n              notes: \"No visible damage\"\r\n            },\r\n            {\r\n              id: \"crit-2\",\r\n              criterion: \"Functionality Test\",\r\n              required: true,\r\n              result: \"pass\",\r\n              notes: \"All systems operational\"\r\n            }\r\n          ],\r\n          overallScore: 95,\r\n          certificateNumber: \"QC-2024-001\"\r\n        },\r\n        attachments: []\r\n      }\r\n    ],\r\n    invoices: [\r\n      {\r\n        id: \"inv-1\",\r\n        invoiceNumber: \"INV-TC-2024-001\",\r\n        supplierInvoiceNumber: \"TC-789456\",\r\n        invoiceDate: new Date(\"2024-02-20\"),\r\n        amount: 12510,\r\n        currency: \"USD\",\r\n        status: \"matched\",\r\n        matchingResults: [\r\n          {\r\n            field: \"Amount\",\r\n            poValue: 12510,\r\n            invoiceValue: 12510,\r\n            matched: true,\r\n            variance: 0,\r\n            toleranceExceeded: false\r\n          },\r\n          {\r\n            field: \"Quantity\",\r\n            poValue: 10,\r\n            invoiceValue: 10,\r\n            receiptValue: 8,\r\n            matched: false,\r\n            variance: 2,\r\n            toleranceExceeded: false,\r\n            notes: \"Partial delivery - remaining items on backorder\"\r\n          }\r\n        ]\r\n      }\r\n    ],\r\n    threeWayMatchStatus: \"exceptions\",\r\n    changeOrders: [],\r\n    riskScore: 15,\r\n    complianceChecks: [\r\n      {\r\n        id: \"comp-1\",\r\n        checkType: \"budget\",\r\n        status: \"compliant\",\r\n        description: \"Budget allocation verified\",\r\n        details: \"Order amount within approved budget limits\"\r\n      },\r\n      {\r\n        id: \"comp-2\",\r\n        checkType: \"contract\",\r\n        status: \"compliant\",\r\n        description: \"Contract terms verified\",\r\n        details: \"Supplier has active master service agreement\"\r\n      }\r\n    ],\r\n    performanceMetrics: {\r\n      onTimeDeliveryScore: 85,\r\n      qualityScore: 95,\r\n      priceVariancePercentage: 0,\r\n      cycleTimeHours: 72,\r\n      supplierResponseTimeHours: 4,\r\n      changeOrderCount: 0,\r\n      budgetVariancePercentage: 0,\r\n      complianceScore: 100\r\n    },\r\n    createdAt: new Date(\"2024-01-15T09:00:00Z\"),\r\n    updatedAt: new Date(\"2024-02-20T15:30:00Z\"),\r\n    version: 3,\r\n    auditTrail: [\r\n      {\r\n        id: \"audit-1\",\r\n        timestamp: new Date(\"2024-01-15T09:00:00Z\"),\r\n        userId: \"john.doe\",\r\n        userName: \"John Doe\",\r\n        action: \"created\",\r\n        details: \"Purchase order created\",\r\n        ipAddress: \"192.168.1.100\"\r\n      },\r\n      {\r\n        id: \"audit-2\",\r\n        timestamp: new Date(\"2024-01-18T14:30:00Z\"),\r\n        userId: \"bob.johnson\",\r\n        userName: \"Bob Johnson\",\r\n        action: \"approved\",\r\n        details: \"Purchase order approved by Finance Director\",\r\n        ipAddress: \"192.168.1.101\"\r\n      }\r\n    ]\r\n  },\r\n  // Add more mock data...\r\n  {\r\n    id: \"PO-002\",\r\n    poNumber: \"PO-2024-002\",\r\n    supplierId: \"SUP-002\",\r\n    supplierName: \"Global Supplies Inc\",\r\n    supplierCode: \"GLOB002\",\r\n    status: \"pending_approval\",\r\n    priority: \"medium\",\r\n    createdDate: new Date(\"2024-01-20\"),\r\n    requestedDeliveryDate: new Date(\"2024-03-01\"),\r\n    items: [\r\n      {\r\n        id: \"item-2\",\r\n        lineNumber: 1,\r\n        productCode: \"OFFICE-001\",\r\n        description: \"Office Supplies Bundle\",\r\n        category: \"Office Supplies\",\r\n        quantity: 50,\r\n        receivedQuantity: 0,\r\n        remainingQuantity: 50,\r\n        unit: \"SET\",\r\n        unitPrice: 45,\r\n        totalPrice: 2250,\r\n        discountPercentage: 10,\r\n        taxPercentage: 8,\r\n        requestedDate: new Date(\"2024-03-01\"),\r\n        status: \"pending\",\r\n        inspectionRequired: false,\r\n        reorderPointTriggered: true\r\n      }\r\n    ],\r\n    subtotal: 2250,\r\n    taxAmount: 180,\r\n    discountAmount: 225,\r\n    shippingCost: 75,\r\n    totalAmount: 2280,\r\n    currency: \"USD\",\r\n    exchangeRate: 1,\r\n    budgetCode: \"OPS-2024-Q1\",\r\n    budgetAllocated: 25000,\r\n    budgetRemaining: 22720,\r\n    department: \"Operations\",\r\n    costCenter: \"CC-002\",\r\n    approvalWorkflow: [\r\n      {\r\n        id: \"step-1\",\r\n        stepNumber: 1,\r\n        approverRole: \"Department Manager\",\r\n        approverName: \"Sarah Wilson\",\r\n        approverEmail: \"sarah.wilson@company.com\",\r\n        status: \"pending\",\r\n        approvalThreshold: 5000,\r\n        required: true\r\n      }\r\n    ],\r\n    currentApprovalStep: 1,\r\n    requestedBy: \"mike.chen\",\r\n    requestedByName: \"Mike Chen\",\r\n    paymentTerms: \"Net 15\",\r\n    deliveryTerms: \"FOB Origin\",\r\n    warrantyTerms: \"30 Days\",\r\n    deliveryAddress: {\r\n      id: \"addr-1\",\r\n      name: \"Main Office\",\r\n      street: \"123 Business St\",\r\n      city: \"New York\",\r\n      state: \"NY\",\r\n      zipCode: \"10001\",\r\n      country: \"USA\",\r\n      isDefault: true,\r\n      contactName: \"Receiving Department\",\r\n      contactPhone: \"+1-555-0123\",\r\n      contactEmail: \"receiving@company.com\"\r\n    },\r\n    billingAddress: {\r\n      id: \"addr-2\",\r\n      name: \"Corporate Headquarters\",\r\n      street: \"123 Business St\",\r\n      city: \"New York\",\r\n      state: \"NY\",\r\n      zipCode: \"10001\",\r\n      country: \"USA\",\r\n      isDefault: true,\r\n      contactName: \"Accounts Payable\",\r\n      contactPhone: \"+1-555-0124\",\r\n      contactEmail: \"ap@company.com\"\r\n    },\r\n    notes: \"Regular office supplies reorder\",\r\n    attachments: [],\r\n    receipts: [],\r\n    invoices: [],\r\n    threeWayMatchStatus: \"pending\",\r\n    changeOrders: [],\r\n    riskScore: 5,\r\n    complianceChecks: [\r\n      {\r\n        id: \"comp-3\",\r\n        checkType: \"budget\",\r\n        status: \"compliant\",\r\n        description: \"Budget allocation verified\"\r\n      }\r\n    ],\r\n    performanceMetrics: {\r\n      onTimeDeliveryScore: 0,\r\n      qualityScore: 0,\r\n      priceVariancePercentage: 0,\r\n      cycleTimeHours: 0,\r\n      supplierResponseTimeHours: 0,\r\n      changeOrderCount: 0,\r\n      budgetVariancePercentage: 0,\r\n      complianceScore: 100\r\n    },\r\n    createdAt: new Date(\"2024-01-20T10:00:00Z\"),\r\n    updatedAt: new Date(\"2024-01-20T10:00:00Z\"),\r\n    version: 1,\r\n    auditTrail: [\r\n      {\r\n        id: \"audit-3\",\r\n        timestamp: new Date(\"2024-01-20T10:00:00Z\"),\r\n        userId: \"mike.chen\",\r\n        userName: \"Mike Chen\",\r\n        action: \"created\",\r\n        details: \"Purchase order created\",\r\n        ipAddress: \"192.168.1.102\"\r\n      }\r\n    ]\r\n  }\r\n]\r\n\r\nconst mockMetrics: PODashboardMetrics = {\r\n  totalOrders: 156,\r\n  pendingApprovals: 12,\r\n  inProgress: 34,\r\n  overdueDeliveries: 5,\r\n  totalValue: 2450000,\r\n  budgetUtilization: 68.5,\r\n  averageCycleTime: 72,\r\n  onTimeDeliveryRate: 89.2,\r\n  qualityScore: 94.5,\r\n  costSavings: 125000,\r\n  contractCompliance: 96.8,\r\n  supplierPerformance: 91.3\r\n}\r\n\r\nexport default function PurchaseOrdersPage() {\r\n  const [purchaseOrders, setPurchaseOrders] = useState<PurchaseOrder[]>(mockPurchaseOrders)\r\n  const [filteredOrders, setFilteredOrders] = useState<PurchaseOrder[]>(mockPurchaseOrders)\r\n  const [selectedOrders, setSelectedOrders] = useState<string[]>([])\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n  const [filters, setFilters] = useState<POFilters>({})\r\n  const [sortField, setSortField] = useState<keyof PurchaseOrder>(\"createdDate\")\r\n  const [sortDirection, setSortDirection] = useState<\"asc\" | \"desc\">(\"desc\")\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const [itemsPerPage, setItemsPerPage] = useState(25)\r\n  const [viewMode, setViewMode] = useState<\"table\" | \"grid\">(\"table\")\r\n  const [showCreateDialog, setShowCreateDialog] = useState(false)\r\n  const [showBulkActions, setShowBulkActions] = useState(false)\r\n  const [selectedOrder, setSelectedOrder] = useState<PurchaseOrder | null>(null)\r\n  const [showOrderDetail, setShowOrderDetail] = useState(false)\r\n  const [activeTab, setActiveTab] = useState(\"all\")\r\n\r\n  // Filter and sort orders\r\n  useEffect(() => {\r\n    let filtered = purchaseOrders.filter(order => {\r\n      const matchesSearch = searchQuery === \"\" ||\r\n        order.poNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        order.supplierName.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        order.supplierCode.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        order.department.toLowerCase().includes(searchQuery.toLowerCase())\r\n\r\n      const matchesStatus = !filters.status?.length ||\r\n        filters.status.includes(order.status)\r\n\r\n      const matchesPriority = !filters.priority?.length ||\r\n        filters.priority.includes(order.priority)\r\n\r\n      const matchesDepartment = !filters.department?.length ||\r\n        filters.department.includes(order.department)\r\n\r\n      const matchesSupplier = !filters.supplier?.length ||\r\n        filters.supplier.includes(order.supplierId)\r\n\r\n      const matchesAmount = !filters.amountRange ||\r\n        (order.totalAmount >= filters.amountRange.min &&\r\n         order.totalAmount <= filters.amountRange.max)\r\n\r\n      return matchesSearch && matchesStatus && matchesPriority &&\r\n             matchesDepartment && matchesSupplier && matchesAmount\r\n    })\r\n\r\n    // Apply tab-based filtering\r\n    if (activeTab !== \"all\") {\r\n      switch (activeTab) {\r\n        case \"pending\":\r\n          filtered = filtered.filter(order =>\r\n            [\"draft\", \"pending_approval\"].includes(order.status)\r\n          )\r\n          break\r\n        case \"approved\":\r\n          filtered = filtered.filter(order => order.status === \"approved\")\r\n          break\r\n        case \"in_progress\":\r\n          filtered = filtered.filter(order =>\r\n            [\"sent\", \"acknowledged\", \"in_progress\", \"shipped\"].includes(order.status)\r\n          )\r\n          break\r\n        case \"received\":\r\n          filtered = filtered.filter(order =>\r\n            [\"received\", \"completed\"].includes(order.status)\r\n          )\r\n          break\r\n        case \"exceptions\":\r\n          filtered = filtered.filter(order =>\r\n            order.threeWayMatchStatus === \"exceptions\" ||\r\n            order.complianceChecks.some(check => check.status === \"non_compliant\") ||\r\n            order.riskScore > 50\r\n          )\r\n          break\r\n        case \"overdue\":\r\n          filtered = filtered.filter(order => {\r\n            const today = new Date()\r\n            return order.requestedDeliveryDate < today &&\r\n                   ![\"received\", \"completed\", \"cancelled\"].includes(order.status)\r\n          })\r\n          break\r\n      }\r\n    }\r\n\r\n    // Sort\r\n    filtered.sort((a, b) => {\r\n      const aValue = a[sortField]\r\n      const bValue = b[sortField]\r\n\r\n      if (typeof aValue === \"string\" && typeof bValue === \"string\") {\r\n        return sortDirection === \"asc\"\r\n          ? aValue.localeCompare(bValue)\r\n          : bValue.localeCompare(aValue)\r\n      }\r\n\r\n      if (typeof aValue === \"number\" && typeof bValue === \"number\") {\r\n        return sortDirection === \"asc\" ? aValue - bValue : bValue - aValue\r\n      }\r\n\r\n      if (aValue instanceof Date && bValue instanceof Date) {\r\n        return sortDirection === \"asc\"\r\n          ? aValue.getTime() - bValue.getTime()\r\n          : bValue.getTime() - aValue.getTime()\r\n      }\r\n\r\n      return 0\r\n    })\r\n\r\n    setFilteredOrders(filtered)\r\n    setCurrentPage(1)\r\n  }, [purchaseOrders, searchQuery, filters, sortField, sortDirection, activeTab])\r\n\r\n  const paginatedOrders = useMemo(() => {\r\n    const startIndex = (currentPage - 1) * itemsPerPage\r\n    return filteredOrders.slice(startIndex, startIndex + itemsPerPage)\r\n  }, [filteredOrders, currentPage, itemsPerPage])\r\n\r\n  const totalPages = Math.ceil(filteredOrders.length / itemsPerPage)\r\n\r\n  const handleSort = (field: keyof PurchaseOrder) => {\r\n    if (field === sortField) {\r\n      setSortDirection(sortDirection === \"asc\" ? \"desc\" : \"asc\")\r\n    } else {\r\n      setSortField(field)\r\n      setSortDirection(\"asc\")\r\n    }\r\n  }\r\n\r\n  const handleSelectOrder = (orderId: string) => {\r\n    setSelectedOrders(prev =>\r\n      prev.includes(orderId)\r\n        ? prev.filter(id => id !== orderId)\r\n        : [...prev, orderId]\r\n    )\r\n  }\r\n\r\n  const handleSelectAll = () => {\r\n    setSelectedOrders(\r\n      selectedOrders.length === paginatedOrders.length\r\n        ? []\r\n        : paginatedOrders.map(order => order.id)\r\n    )\r\n  }\r\n\r\n  const getStatusBadge = (status: PurchaseOrder[\"status\"]) => {\r\n    const colors = getStatusColor(status)\r\n    return (\r\n      <Badge className={colors}>\r\n        {status.replace(\"_\", \" \").toUpperCase()}\r\n      </Badge>\r\n    )\r\n  }\r\n\r\n  const getPriorityBadge = (priority: PurchaseOrder[\"priority\"]) => {\r\n    const colorMap: Record<string, string> = {\r\n      low: \"bg-gray-100 text-gray-800 border-gray-200\",\r\n      medium: \"bg-blue-100 text-blue-800 border-blue-200\",\r\n      high: \"bg-orange-100 text-orange-800 border-orange-200\",\r\n      urgent: \"bg-red-100 text-red-800 border-red-200\"\r\n    }\r\n\r\n    return (\r\n      <Badge className={colorMap[priority]}>\r\n        {priority.toUpperCase()}\r\n      </Badge>\r\n    )\r\n  }\r\n\r\n  const getRiskBadge = (riskScore: number) => {\r\n    let level = \"Low\"\r\n    let color = \"bg-green-100 text-green-800 border-green-200\"\r\n\r\n    if (riskScore > 70) {\r\n      level = \"High\"\r\n      color = \"bg-red-100 text-red-800 border-red-200\"\r\n    } else if (riskScore > 40) {\r\n      level = \"Medium\"\r\n      color = \"bg-yellow-100 text-yellow-800 border-yellow-200\"\r\n    }\r\n\r\n    return <Badge className={color}>{level} Risk</Badge>\r\n  }\r\n\r\n  const getOrderProgress = (order: PurchaseOrder): number => {\r\n    const statusProgress: Record<string, number> = {\r\n      'draft': 10,\r\n      'pending_approval': 20,\r\n      'approved': 40,\r\n      'sent': 50,\r\n      'acknowledged': 60,\r\n      'in_progress': 70,\r\n      'shipped': 80,\r\n      'received': 90,\r\n      'completed': 100,\r\n      'cancelled': 0\r\n    }\r\n    return statusProgress[order.status] || 0\r\n  }\r\n\r\n  const getThreeWayMatchIcon = (status: PurchaseOrder[\"threeWayMatchStatus\"]) => {\r\n    switch (status) {\r\n      case \"matched\":\r\n        return <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n      case \"exceptions\":\r\n        return <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\r\n      case \"manual_review\":\r\n        return <Eye className=\"h-4 w-4 text-blue-600\" />\r\n      default:\r\n        return <Clock className=\"h-4 w-4 text-gray-600\" />\r\n    }\r\n  }\r\n\r\n  const TabCountBadge = ({ count }: { count: number }) => (\r\n    <Badge variant=\"secondary\" className=\"ml-2 text-xs\">\r\n      {count}\r\n    </Badge>\r\n  )\r\n\r\n  return (\r\n    <AppLayout title=\"Purchase Orders\" breadcrumbs={[{ label: \"Purchase Order Management\" }]}>\r\n      <TooltipProvider>\r\n        <div className=\"space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h2 className=\"text-3xl font-bold tracking-tight\">Purchase Orders Management</h2>\r\n            <p className=\"text-muted-foreground\">\r\n              Complete PO lifecycle management with approval workflows, receiving, and analytics\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center space-x-2\">\r\n            <Button variant=\"outline\" size=\"sm\">\r\n              <Download className=\"mr-2 h-4 w-4\" />\r\n              Export\r\n            </Button>\r\n            <Button variant=\"outline\" size=\"sm\">\r\n              <Upload className=\"mr-2 h-4 w-4\" />\r\n              Import\r\n            </Button>\r\n            <DropdownMenu>\r\n              <DropdownMenuTrigger asChild>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <Star className=\"mr-2 h-4 w-4\" />\r\n                  Templates\r\n                </Button>\r\n              </DropdownMenuTrigger>\r\n              <DropdownMenuContent>\r\n                <DropdownMenuItem>\r\n                  <FileText className=\"mr-2 h-4 w-4\" />\r\n                  IT Equipment\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem>\r\n                  <Package className=\"mr-2 h-4 w-4\" />\r\n                  Office Supplies\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem>\r\n                  <Building2 className=\"mr-2 h-4 w-4\" />\r\n                  Services\r\n                </DropdownMenuItem>\r\n                <DropdownMenuSeparator />\r\n                <DropdownMenuItem>\r\n                  <Plus className=\"mr-2 h-4 w-4\" />\r\n                  Create Template\r\n                </DropdownMenuItem>\r\n              </DropdownMenuContent>\r\n            </DropdownMenu>\r\n            <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\r\n              <DialogTrigger asChild>\r\n                <Button>\r\n                  <Plus className=\"mr-2 h-4 w-4\" />\r\n                  Create PO\r\n                </Button>\r\n              </DialogTrigger>\r\n              <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\r\n                <DialogHeader>\r\n                  <DialogTitle>Create Purchase Order</DialogTitle>\r\n                  <DialogDescription>\r\n                    Create a new purchase order with multi-step approval workflow\r\n                  </DialogDescription>\r\n                </DialogHeader>\r\n                <PurchaseOrderCreationForm onClose={() => setShowCreateDialog(false)} />\r\n              </DialogContent>\r\n            </Dialog>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Metrics Dashboard */}\r\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">Total Orders</CardTitle>\r\n              <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{mockMetrics.totalOrders}</div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                {formatCurrency(mockMetrics.totalValue)} total value\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">Pending Approvals</CardTitle>\r\n              <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{mockMetrics.pendingApprovals}</div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Requires attention\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">Budget Utilization</CardTitle>\r\n              <Calculator className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{mockMetrics.budgetUtilization}%</div>\r\n              <div className=\"mt-1\">\r\n                <Progress value={mockMetrics.budgetUtilization} className=\"h-2\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">On-Time Delivery</CardTitle>\r\n              <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{mockMetrics.onTimeDeliveryRate}%</div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Last 30 days\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Advanced Metrics */}\r\n        <div className=\"grid gap-4 md:grid-cols-3 lg:grid-cols-6\">\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"text-sm\">Quality Score</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-xl font-bold\">{mockMetrics.qualityScore}%</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"text-sm\">Cost Savings</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-xl font-bold\">{formatCurrency(mockMetrics.costSavings)}</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"text-sm\">Avg Cycle Time</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-xl font-bold\">{mockMetrics.averageCycleTime}h</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"text-sm\">Contract Compliance</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-xl font-bold\">{mockMetrics.contractCompliance}%</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"text-sm\">Supplier Performance</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-xl font-bold\">{mockMetrics.supplierPerformance}%</div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"pb-2\">\r\n              <CardTitle className=\"text-sm\">Overdue Deliveries</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-xl font-bold text-red-600\">{mockMetrics.overdueDeliveries}</div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Filters and Search */}\r\n        <Card>\r\n          <CardHeader>\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <CardTitle>Purchase Order Overview</CardTitle>\r\n                <CardDescription>\r\n                  Manage purchase orders with comprehensive workflow controls\r\n                </CardDescription>\r\n              </div>\r\n              <div className=\"flex items-center space-x-2\">\r\n                <div className=\"relative\">\r\n                  <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n                  <Input\r\n                    placeholder=\"Search orders...\"\r\n                    value={searchQuery}\r\n                    onChange={(e) => setSearchQuery(e.target.value)}\r\n                    className=\"pl-8 w-80\"\r\n                  />\r\n                </div>\r\n                <DropdownMenu>\r\n                  <DropdownMenuTrigger asChild>\r\n                    <Button variant=\"outline\" size=\"sm\">\r\n                      <Filter className=\"mr-2 h-4 w-4\" />\r\n                      Filters\r\n                    </Button>\r\n                  </DropdownMenuTrigger>\r\n                  <DropdownMenuContent className=\"w-80\">\r\n                    <DropdownMenuLabel>Filter Options</DropdownMenuLabel>\r\n                    <DropdownMenuSeparator />\r\n                    <PurchaseOrderFilters\r\n                      filters={filters}\r\n                      onFiltersChange={setFilters}\r\n                    />\r\n                  </DropdownMenuContent>\r\n                </DropdownMenu>\r\n                <DropdownMenu>\r\n                  <DropdownMenuTrigger asChild>\r\n                    <Button variant=\"outline\" size=\"sm\">\r\n                      <Grid3X3 className=\"mr-2 h-4 w-4\" />\r\n                      View\r\n                    </Button>\r\n                  </DropdownMenuTrigger>\r\n                  <DropdownMenuContent>\r\n                    <DropdownMenuRadioGroup value={viewMode} onValueChange={(value) => setViewMode(value as \"table\" | \"grid\")}>\r\n                      <DropdownMenuRadioItem value=\"table\">\r\n                        <List className=\"mr-2 h-4 w-4\" />\r\n                        Table View\r\n                      </DropdownMenuRadioItem>\r\n                      <DropdownMenuRadioItem value=\"grid\">\r\n                        <Grid3X3 className=\"mr-2 h-4 w-4\" />\r\n                        Grid View\r\n                      </DropdownMenuRadioItem>\r\n                    </DropdownMenuRadioGroup>\r\n                  </DropdownMenuContent>\r\n                </DropdownMenu>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <Settings className=\"mr-2 h-4 w-4\" />\r\n                  Columns\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {/* Tabs for different order views */}\r\n            <Tabs value={activeTab} onValueChange={setActiveTab} className=\"mb-6\">\r\n              <TabsList className=\"grid w-full grid-cols-7\">\r\n                <TabsTrigger value=\"all\">\r\n                  All\r\n                  <TabCountBadge count={filteredOrders.length} />\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"pending\">\r\n                  Pending\r\n                  <TabCountBadge count={\r\n                    purchaseOrders.filter(order =>\r\n                      [\"draft\", \"pending_approval\"].includes(order.status)\r\n                    ).length\r\n                  } />\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"approved\">\r\n                  Approved\r\n                  <TabCountBadge count={\r\n                    purchaseOrders.filter(order => order.status === \"approved\").length\r\n                  } />\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"in_progress\">\r\n                  In Progress\r\n                  <TabCountBadge count={\r\n                    purchaseOrders.filter(order =>\r\n                      [\"sent\", \"acknowledged\", \"in_progress\", \"shipped\"].includes(order.status)\r\n                    ).length\r\n                  } />\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"received\">\r\n                  Received\r\n                  <TabCountBadge count={\r\n                    purchaseOrders.filter(order =>\r\n                      [\"received\", \"completed\"].includes(order.status)\r\n                    ).length\r\n                  } />\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"exceptions\">\r\n                  Exceptions\r\n                  <TabCountBadge count={\r\n                    purchaseOrders.filter(order =>\r\n                      order.threeWayMatchStatus === \"exceptions\" ||\r\n                      order.complianceChecks.some(check => check.status === \"non_compliant\")\r\n                    ).length\r\n                  } />\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"overdue\">\r\n                  Overdue\r\n                  <TabCountBadge count={\r\n                    purchaseOrders.filter(order => {\r\n                      const today = new Date()\r\n                      return order.requestedDeliveryDate < today &&\r\n                             ![\"received\", \"completed\", \"cancelled\"].includes(order.status)\r\n                    }).length\r\n                  } />\r\n                </TabsTrigger>\r\n              </TabsList>\r\n            </Tabs>\r\n\r\n            {/* Bulk Actions */}\r\n            {selectedOrders.length > 0 && (\r\n              <div className=\"mb-4 p-3 bg-muted rounded-lg flex items-center justify-between\">\r\n                <span className=\"text-sm font-medium\">\r\n                  {selectedOrders.length} order(s) selected\r\n                </span>\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <Button size=\"sm\">\r\n                    <UserCheck className=\"mr-2 h-4 w-4\" />\r\n                    Bulk Approve\r\n                  </Button>\r\n                  <Button size=\"sm\" variant=\"outline\">\r\n                    <Send className=\"mr-2 h-4 w-4\" />\r\n                    Send to Suppliers\r\n                  </Button>\r\n                  <Button size=\"sm\" variant=\"outline\">\r\n                    <Download className=\"mr-2 h-4 w-4\" />\r\n                    Export Selected\r\n                  </Button>\r\n                  <DropdownMenu>\r\n                    <DropdownMenuTrigger asChild>\r\n                      <Button size=\"sm\" variant=\"outline\">\r\n                        <MoreHorizontal className=\"h-4 w-4\" />\r\n                      </Button>\r\n                    </DropdownMenuTrigger>\r\n                    <DropdownMenuContent>\r\n                      <DropdownMenuItem>\r\n                        <Edit className=\"mr-2 h-4 w-4\" />\r\n                        Bulk Edit\r\n                      </DropdownMenuItem>\r\n                      <DropdownMenuItem>\r\n                        <Copy className=\"mr-2 h-4 w-4\" />\r\n                        Duplicate Orders\r\n                      </DropdownMenuItem>\r\n                      <DropdownMenuSeparator />\r\n                      <DropdownMenuItem>\r\n                        <Calculator className=\"mr-2 h-4 w-4\" />\r\n                        Budget Analysis\r\n                      </DropdownMenuItem>\r\n                      <DropdownMenuItem>\r\n                        <BarChart3 className=\"mr-2 h-4 w-4\" />\r\n                        Performance Report\r\n                      </DropdownMenuItem>\r\n                      <DropdownMenuSeparator />\r\n                      <DropdownMenuItem className=\"text-red-600\">\r\n                        <Ban className=\"mr-2 h-4 w-4\" />\r\n                        Cancel Selected\r\n                      </DropdownMenuItem>\r\n                    </DropdownMenuContent>\r\n                  </DropdownMenu>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Purchase Orders Table */}\r\n            <div className=\"rounded-md border\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead className=\"w-12\">\r\n                      <Checkbox\r\n                        checked={selectedOrders.length === paginatedOrders.length}\r\n                        onCheckedChange={handleSelectAll}\r\n                      />\r\n                    </TableHead>\r\n                    <TableHead\r\n                      className=\"cursor-pointer\"\r\n                      onClick={() => handleSort(\"poNumber\")}\r\n                    >\r\n                      <div className=\"flex items-center\">\r\n                        PO Number\r\n                        {sortField === \"poNumber\" && (\r\n                          sortDirection === \"asc\" ?\r\n                          <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                          <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                        )}\r\n                      </div>\r\n                    </TableHead>\r\n                    <TableHead\r\n                      className=\"cursor-pointer\"\r\n                      onClick={() => handleSort(\"supplierName\")}\r\n                    >\r\n                      <div className=\"flex items-center\">\r\n                        Supplier\r\n                        {sortField === \"supplierName\" && (\r\n                          sortDirection === \"asc\" ?\r\n                          <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                          <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                        )}\r\n                      </div>\r\n                    </TableHead>\r\n                    <TableHead>Status</TableHead>\r\n                    <TableHead>Priority</TableHead>\r\n                    <TableHead\r\n                      className=\"cursor-pointer text-right\"\r\n                      onClick={() => handleSort(\"totalAmount\")}\r\n                    >\r\n                      <div className=\"flex items-center justify-end\">\r\n                        Amount\r\n                        {sortField === \"totalAmount\" && (\r\n                          sortDirection === \"asc\" ?\r\n                          <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                          <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                        )}\r\n                      </div>\r\n                    </TableHead>\r\n                    <TableHead>Department</TableHead>\r\n                    <TableHead\r\n                      className=\"cursor-pointer\"\r\n                      onClick={() => handleSort(\"requestedDeliveryDate\")}\r\n                    >\r\n                      <div className=\"flex items-center\">\r\n                        Delivery Date\r\n                        {sortField === \"requestedDeliveryDate\" && (\r\n                          sortDirection === \"asc\" ?\r\n                          <ArrowUp className=\"ml-2 h-4 w-4\" /> :\r\n                          <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n                        )}\r\n                      </div>\r\n                    </TableHead>\r\n                    <TableHead>Progress</TableHead>\r\n                    <TableHead>Risk</TableHead>\r\n                    <TableHead>3-Way Match</TableHead>\r\n                    <TableHead>Actions</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {paginatedOrders.map((order) => (\r\n                    <TableRow key={order.id}>\r\n                      <TableCell>\r\n                        <Checkbox\r\n                          checked={selectedOrders.includes(order.id)}\r\n                          onCheckedChange={() => handleSelectOrder(order.id)}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col\">\r\n                          <span className=\"font-medium\">{order.poNumber}</span>\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            by {order.requestedByName}\r\n                          </span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col\">\r\n                          <span className=\"font-medium\">{order.supplierName}</span>\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            {order.supplierCode} • {order.items.length} item(s)\r\n                          </span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col space-y-1\">\r\n                          {getStatusBadge(order.status)}\r\n                          {order.status === \"pending_approval\" && (\r\n                            <Badge variant=\"outline\" className=\"text-xs\">\r\n                              Step {order.currentApprovalStep}\r\n                            </Badge>\r\n                          )}\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {getPriorityBadge(order.priority)}\r\n                      </TableCell>\r\n                      <TableCell className=\"text-right\">\r\n                        <div className=\"flex flex-col items-end\">\r\n                          <span className=\"font-medium\">\r\n                            {formatCurrency(order.totalAmount, order.currency)}\r\n                          </span>\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            Budget: {order.budgetCode}\r\n                          </span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant=\"secondary\">{order.department}</Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className={cn(\r\n                          \"text-sm\",\r\n                          new Date(order.requestedDeliveryDate) < new Date() &&\r\n                          ![\"received\", \"completed\", \"cancelled\"].includes(order.status) &&\r\n                          \"text-red-600 font-medium\"\r\n                        )}>\r\n                          {formatDate(order.requestedDeliveryDate)}\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col gap-1\">\r\n                          <Progress value={getOrderProgress(order)} className=\"w-20\" />\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            {getOrderProgress(order)}%\r\n                          </span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {getRiskBadge(order.riskScore)}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Tooltip>\r\n                          <TooltipTrigger>\r\n                            {getThreeWayMatchIcon(order.threeWayMatchStatus)}\r\n                          </TooltipTrigger>\r\n                          <TooltipContent>\r\n                            <p>{order.threeWayMatchStatus.replace(\"_\", \" \")}</p>\r\n                          </TooltipContent>\r\n                        </Tooltip>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <DropdownMenu>\r\n                          <DropdownMenuTrigger asChild>\r\n                            <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\r\n                              <MoreHorizontal className=\"h-4 w-4\" />\r\n                            </Button>\r\n                          </DropdownMenuTrigger>\r\n                          <DropdownMenuContent align=\"end\">\r\n                            <DropdownMenuItem\r\n                              onClick={() => {\r\n                                setSelectedOrder(order)\r\n                                setShowOrderDetail(true)\r\n                              }}\r\n                            >\r\n                              <Eye className=\"mr-2 h-4 w-4\" />\r\n                              View Details\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Edit className=\"mr-2 h-4 w-4\" />\r\n                              Edit Order\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Copy className=\"mr-2 h-4 w-4\" />\r\n                              Duplicate\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuSeparator />\r\n                            {order.status === \"pending_approval\" && (\r\n                              <DropdownMenuItem>\r\n                                <UserCheck className=\"mr-2 h-4 w-4\" />\r\n                                Approve\r\n                              </DropdownMenuItem>\r\n                            )}\r\n                            {order.status === \"approved\" && (\r\n                              <DropdownMenuItem>\r\n                                <Send className=\"mr-2 h-4 w-4\" />\r\n                                Send to Supplier\r\n                              </DropdownMenuItem>\r\n                            )}\r\n                            <DropdownMenuItem>\r\n                              <Receipt className=\"mr-2 h-4 w-4\" />\r\n                              Receiving\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Target className=\"mr-2 h-4 w-4\" />\r\n                              3-Way Match\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuSeparator />\r\n                            <DropdownMenuItem>\r\n                              <Download className=\"mr-2 h-4 w-4\" />\r\n                              Export PDF\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Mail className=\"mr-2 h-4 w-4\" />\r\n                              Email\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuSeparator />\r\n                            <DropdownMenuItem>\r\n                              <MessageSquare className=\"mr-2 h-4 w-4\" />\r\n                              Add Note\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <History className=\"mr-2 h-4 w-4\" />\r\n                              Audit Trail\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuSeparator />\r\n                            <DropdownMenuItem className=\"text-red-600\">\r\n                              <Trash2 className=\"mr-2 h-4 w-4\" />\r\n                              Cancel Order\r\n                            </DropdownMenuItem>\r\n                          </DropdownMenuContent>\r\n                        </DropdownMenu>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n\r\n            {/* Pagination */}\r\n            <div className=\"flex items-center justify-between px-2 py-4\">\r\n              <div className=\"flex items-center space-x-2\">\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  Showing {((currentPage - 1) * itemsPerPage) + 1} to {Math.min(currentPage * itemsPerPage, filteredOrders.length)} of {filteredOrders.length} orders\r\n                </p>\r\n              </div>\r\n              <div className=\"flex items-center space-x-6 lg:space-x-8\">\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <p className=\"text-sm font-medium\">Rows per page</p>\r\n                  <Select\r\n                    value={`${itemsPerPage}`}\r\n                    onValueChange={(value) => setItemsPerPage(Number(value))}\r\n                  >\r\n                    <SelectTrigger className=\"h-8 w-[70px]\">\r\n                      <SelectValue placeholder={itemsPerPage} />\r\n                    </SelectTrigger>\r\n                    <SelectContent side=\"top\">\r\n                      {[10, 20, 30, 40, 50].map((pageSize) => (\r\n                        <SelectItem key={pageSize} value={`${pageSize}`}>\r\n                          {pageSize}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n                <div className=\"flex w-[100px] items-center justify-center text-sm font-medium\">\r\n                  Page {currentPage} of {totalPages}\r\n                </div>\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    className=\"hidden h-8 w-8 p-0 lg:flex\"\r\n                    onClick={() => setCurrentPage(1)}\r\n                    disabled={currentPage === 1}\r\n                  >\r\n                    <span className=\"sr-only\">Go to first page</span>\r\n                    <ArrowUp className=\"h-4 w-4 rotate-180\" />\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    className=\"h-8 w-8 p-0\"\r\n                    onClick={() => setCurrentPage(currentPage - 1)}\r\n                    disabled={currentPage === 1}\r\n                  >\r\n                    <span className=\"sr-only\">Go to previous page</span>\r\n                    <ArrowUp className=\"h-4 w-4 rotate-90\" />\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    className=\"h-8 w-8 p-0\"\r\n                    onClick={() => setCurrentPage(currentPage + 1)}\r\n                    disabled={currentPage === totalPages}\r\n                  >\r\n                    <span className=\"sr-only\">Go to next page</span>\r\n                    <ArrowUp className=\"h-4 w-4 -rotate-90\" />\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    className=\"hidden h-8 w-8 p-0 lg:flex\"\r\n                    onClick={() => setCurrentPage(totalPages)}\r\n                    disabled={currentPage === totalPages}\r\n                  >\r\n                    <span className=\"sr-only\">Go to last page</span>\r\n                    <ArrowUp className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Purchase Order Detail Dialog */}\r\n        <Dialog open={showOrderDetail} onOpenChange={setShowOrderDetail}>\r\n          <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-y-auto\">\r\n            <DialogHeader>\r\n              <DialogTitle>Purchase Order Details</DialogTitle>\r\n              <DialogDescription>\r\n                Complete purchase order information and workflow status\r\n              </DialogDescription>\r\n            </DialogHeader>\r\n            {selectedOrder && (\r\n              <PurchaseOrderDetailView\r\n                order={selectedOrder}\r\n                onClose={() => setShowOrderDetail(false)}\r\n              />\r\n            )}\r\n          </DialogContent>\r\n        </Dialog>\r\n        </div>\r\n      </TooltipProvider>\r\n    </AppLayout>\r\n  )\r\n}\r\n\r\n// Purchase Order Creation Form Component\r\nfunction PurchaseOrderCreationForm({ onClose }: { onClose: () => void }) {\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Tabs defaultValue=\"general\" className=\"w-full\">\r\n        <TabsList className=\"grid w-full grid-cols-5\">\r\n          <TabsTrigger value=\"general\">General</TabsTrigger>\r\n          <TabsTrigger value=\"items\">Line Items</TabsTrigger>\r\n          <TabsTrigger value=\"delivery\">Delivery</TabsTrigger>\r\n          <TabsTrigger value=\"approval\">Approval</TabsTrigger>\r\n          <TabsTrigger value=\"review\">Review</TabsTrigger>\r\n        </TabsList>\r\n\r\n        <TabsContent value=\"general\" className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"supplier\">Supplier</Label>\r\n              <Select>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Select supplier\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"tech001\">TechCorp Solutions</SelectItem>\r\n                  <SelectItem value=\"glob002\">Global Supplies Inc</SelectItem>\r\n                  <SelectItem value=\"regi003\">Regional Manufacturing</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"department\">Department</Label>\r\n              <Select>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Select department\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"it\">IT</SelectItem>\r\n                  <SelectItem value=\"finance\">Finance</SelectItem>\r\n                  <SelectItem value=\"operations\">Operations</SelectItem>\r\n                  <SelectItem value=\"marketing\">Marketing</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"budgetCode\">Budget Code</Label>\r\n              <Input id=\"budgetCode\" placeholder=\"e.g., IT-2024-Q1\" />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"priority\">Priority</Label>\r\n              <Select>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Select priority\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"low\">Low</SelectItem>\r\n                  <SelectItem value=\"medium\">Medium</SelectItem>\r\n                  <SelectItem value=\"high\">High</SelectItem>\r\n                  <SelectItem value=\"urgent\">Urgent</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"deliveryDate\">Requested Delivery Date</Label>\r\n              <Popover>\r\n                <PopoverTrigger asChild>\r\n                  <Button variant=\"outline\" className=\"w-full justify-start text-left font-normal\">\r\n                    <Calendar className=\"mr-2 h-4 w-4\" />\r\n                    Select date\r\n                  </Button>\r\n                </PopoverTrigger>\r\n                <PopoverContent className=\"w-auto p-0\">\r\n                  <CalendarComponent mode=\"single\" />\r\n                </PopoverContent>\r\n              </Popover>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"paymentTerms\">Payment Terms</Label>\r\n              <Select>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Select payment terms\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"net30\">Net 30</SelectItem>\r\n                  <SelectItem value=\"net15\">Net 15</SelectItem>\r\n                  <SelectItem value=\"net60\">Net 60</SelectItem>\r\n                  <SelectItem value=\"2/10net30\">2/10 Net 30</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            <div className=\"col-span-2 space-y-2\">\r\n              <Label htmlFor=\"notes\">Notes</Label>\r\n              <Textarea id=\"notes\" placeholder=\"Additional notes or requirements...\" />\r\n            </div>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"items\" className=\"space-y-4\">\r\n          <div className=\"text-center py-8\">\r\n            <Package className=\"mx-auto h-12 w-12 text-muted-foreground\" />\r\n            <h3 className=\"mt-4 text-lg font-medium\">Add Line Items</h3>\r\n            <p className=\"text-sm text-muted-foreground mt-2\">\r\n              Add products or services to this purchase order\r\n            </p>\r\n            <Button className=\"mt-4\">\r\n              <Plus className=\"mr-2 h-4 w-4\" />\r\n              Add Item\r\n            </Button>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"delivery\" className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-2 gap-6\">\r\n            <div>\r\n              <h3 className=\"text-lg font-medium mb-4\">Delivery Address</h3>\r\n              <div className=\"space-y-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"deliveryName\">Address Name</Label>\r\n                  <Input id=\"deliveryName\" placeholder=\"e.g., Main Office\" />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"deliveryStreet\">Street Address</Label>\r\n                  <Input id=\"deliveryStreet\" placeholder=\"123 Business St\" />\r\n                </div>\r\n                <div className=\"grid grid-cols-2 gap-2\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"deliveryCity\">City</Label>\r\n                    <Input id=\"deliveryCity\" placeholder=\"New York\" />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"deliveryState\">State</Label>\r\n                    <Input id=\"deliveryState\" placeholder=\"NY\" />\r\n                  </div>\r\n                </div>\r\n                <div className=\"grid grid-cols-2 gap-2\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"deliveryZip\">ZIP Code</Label>\r\n                    <Input id=\"deliveryZip\" placeholder=\"10001\" />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"deliveryCountry\">Country</Label>\r\n                    <Input id=\"deliveryCountry\" placeholder=\"USA\" />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div>\r\n              <h3 className=\"text-lg font-medium mb-4\">Billing Address</h3>\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <Checkbox id=\"sameAsDelivery\" />\r\n                  <Label htmlFor=\"sameAsDelivery\">Same as delivery address</Label>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"billingName\">Address Name</Label>\r\n                  <Input id=\"billingName\" placeholder=\"e.g., Corporate HQ\" />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor=\"billingStreet\">Street Address</Label>\r\n                  <Input id=\"billingStreet\" placeholder=\"123 Business St\" />\r\n                </div>\r\n                <div className=\"grid grid-cols-2 gap-2\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"billingCity\">City</Label>\r\n                    <Input id=\"billingCity\" placeholder=\"New York\" />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"billingState\">State</Label>\r\n                    <Input id=\"billingState\" placeholder=\"NY\" />\r\n                  </div>\r\n                </div>\r\n                <div className=\"grid grid-cols-2 gap-2\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"billingZip\">ZIP Code</Label>\r\n                    <Input id=\"billingZip\" placeholder=\"10001\" />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"billingCountry\">Country</Label>\r\n                    <Input id=\"billingCountry\" placeholder=\"USA\" />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"approval\" className=\"space-y-4\">\r\n          <div className=\"text-center py-8\">\r\n            <UserCheck className=\"mx-auto h-12 w-12 text-blue-500\" />\r\n            <h3 className=\"mt-4 text-lg font-medium\">Approval Workflow</h3>\r\n            <p className=\"text-sm text-muted-foreground mt-2\">\r\n              Configure the approval process for this purchase order\r\n            </p>\r\n            <div className=\"mt-4 space-y-2\">\r\n              <div className=\"flex items-center justify-between p-3 border rounded\">\r\n                <div className=\"flex items-center space-x-3\">\r\n                  <div className=\"h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center\">\r\n                    <span className=\"text-sm font-medium\">1</span>\r\n                  </div>\r\n                  <div>\r\n                    <p className=\"font-medium\">Department Manager</p>\r\n                    <p className=\"text-sm text-muted-foreground\">Up to $10,000</p>\r\n                  </div>\r\n                </div>\r\n                <Badge variant=\"outline\">Required</Badge>\r\n              </div>\r\n              <div className=\"flex items-center justify-between p-3 border rounded\">\r\n                <div className=\"flex items-center space-x-3\">\r\n                  <div className=\"h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center\">\r\n                    <span className=\"text-sm font-medium\">2</span>\r\n                  </div>\r\n                  <div>\r\n                    <p className=\"font-medium\">Finance Director</p>\r\n                    <p className=\"text-sm text-muted-foreground\">Above $10,000</p>\r\n                  </div>\r\n                </div>\r\n                <Badge variant=\"outline\">Auto-triggered</Badge>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"review\" className=\"space-y-4\">\r\n          <div className=\"text-center py-8\">\r\n            <ClipboardCheck className=\"mx-auto h-12 w-12 text-green-500\" />\r\n            <h3 className=\"mt-4 text-lg font-medium\">Review & Submit</h3>\r\n            <p className=\"text-sm text-muted-foreground mt-2\">\r\n              Review all details before submitting for approval\r\n            </p>\r\n          </div>\r\n        </TabsContent>\r\n      </Tabs>\r\n\r\n      <DialogFooter>\r\n        <Button variant=\"outline\" onClick={onClose}>\r\n          Cancel\r\n        </Button>\r\n        <Button variant=\"outline\">\r\n          Save as Draft\r\n        </Button>\r\n        <Button>\r\n          Submit for Approval\r\n        </Button>\r\n      </DialogFooter>\r\n    </div>\r\n  )\r\n}\r\n\r\n// Purchase Order Filters Component\r\nfunction PurchaseOrderFilters({\r\n  filters,\r\n  onFiltersChange\r\n}: {\r\n  filters: POFilters\r\n  onFiltersChange: (filters: POFilters) => void\r\n}) {\r\n  return (\r\n    <div className=\"space-y-4 p-4\">\r\n      <div>\r\n        <Label className=\"text-sm font-medium\">Status</Label>\r\n        <div className=\"mt-2 space-y-2\">\r\n          {[\"draft\", \"pending_approval\", \"approved\", \"sent\", \"in_progress\", \"received\", \"completed\", \"cancelled\"].map((status) => (\r\n            <div key={status} className=\"flex items-center space-x-2\">\r\n              <Checkbox\r\n                id={status}\r\n                checked={filters.status?.includes(status)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentStatuses = filters.status || []\r\n                  const newStatuses = checked\r\n                    ? [...currentStatuses, status]\r\n                    : currentStatuses.filter(s => s !== status)\r\n                  onFiltersChange({\r\n                    ...filters,\r\n                    status: newStatuses.length > 0 ? newStatuses : undefined\r\n                  })\r\n                }}\r\n              />\r\n              <Label htmlFor={status} className=\"text-sm capitalize\">\r\n                {status.replace(\"_\", \" \")}\r\n              </Label>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      <Separator />\r\n\r\n      <div>\r\n        <Label className=\"text-sm font-medium\">Priority</Label>\r\n        <div className=\"mt-2 space-y-2\">\r\n          {[\"low\", \"medium\", \"high\", \"urgent\"].map((priority) => (\r\n            <div key={priority} className=\"flex items-center space-x-2\">\r\n              <Checkbox\r\n                id={`priority-${priority}`}\r\n                checked={filters.priority?.includes(priority)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentPriorities = filters.priority || []\r\n                  const newPriorities = checked\r\n                    ? [...currentPriorities, priority]\r\n                    : currentPriorities.filter(p => p !== priority)\r\n                  onFiltersChange({\r\n                    ...filters,\r\n                    priority: newPriorities.length > 0 ? newPriorities : undefined\r\n                  })\r\n                }}\r\n              />\r\n              <Label htmlFor={`priority-${priority}`} className=\"text-sm capitalize\">\r\n                {priority}\r\n              </Label>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      <Separator />\r\n\r\n      <div>\r\n        <Label className=\"text-sm font-medium\">Amount Range</Label>\r\n        <div className=\"mt-2 grid grid-cols-2 gap-2\">\r\n          <Input\r\n            placeholder=\"Min amount\"\r\n            type=\"number\"\r\n            value={filters.amountRange?.min || \"\"}\r\n            onChange={(e) => {\r\n              const min = parseFloat(e.target.value) || 0\r\n              onFiltersChange({\r\n                ...filters,\r\n                amountRange: {\r\n                  min,\r\n                  max: filters.amountRange?.max || 999999\r\n                }\r\n              })\r\n            }}\r\n          />\r\n          <Input\r\n            placeholder=\"Max amount\"\r\n            type=\"number\"\r\n            value={filters.amountRange?.max || \"\"}\r\n            onChange={(e) => {\r\n              const max = parseFloat(e.target.value) || 999999\r\n              onFiltersChange({\r\n                ...filters,\r\n                amountRange: {\r\n                  min: filters.amountRange?.min || 0,\r\n                  max\r\n                }\r\n              })\r\n            }}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex justify-end space-x-2 pt-4\">\r\n        <Button\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={() => onFiltersChange({})}\r\n        >\r\n          Clear Filters\r\n        </Button>\r\n        <Button size=\"sm\">\r\n          Apply Filters\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// Purchase Order Detail View Component\r\nfunction PurchaseOrderDetailView({\r\n  order,\r\n  onClose\r\n}: {\r\n  order: PurchaseOrder\r\n  onClose: () => void\r\n}) {\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Tabs defaultValue=\"overview\" className=\"w-full\">\r\n        <TabsList className=\"grid w-full grid-cols-7\">\r\n          <TabsTrigger value=\"overview\">Overview</TabsTrigger>\r\n          <TabsTrigger value=\"items\">Line Items</TabsTrigger>\r\n          <TabsTrigger value=\"approval\">Approval</TabsTrigger>\r\n          <TabsTrigger value=\"receiving\">Receiving</TabsTrigger>\r\n          <TabsTrigger value=\"matching\">3-Way Match</TabsTrigger>\r\n          <TabsTrigger value=\"documents\">Documents</TabsTrigger>\r\n          <TabsTrigger value=\"history\">History</TabsTrigger>\r\n        </TabsList>\r\n\r\n        <TabsContent value=\"overview\" className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-2 gap-6\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg\">Order Information</CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">PO Number</Label>\r\n                    <p className=\"font-medium\">{order.poNumber}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Status</Label>\r\n                    <div className=\"mt-1\">\r\n                      <Badge className={getStatusColor(order.status)}>\r\n                        {order.status.replace(\"_\", \" \").toUpperCase()}\r\n                      </Badge>\r\n                    </div>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Priority</Label>\r\n                    <p className=\"font-medium capitalize\">{order.priority}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Department</Label>\r\n                    <p className=\"font-medium\">{order.department}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Budget Code</Label>\r\n                    <p className=\"font-medium\">{order.budgetCode}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Risk Score</Label>\r\n                    <p className=\"font-medium\">{order.riskScore}%</p>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"text-lg\">Supplier Information</CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div className=\"space-y-3 text-sm\">\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Supplier Name</Label>\r\n                    <p className=\"font-medium\">{order.supplierName}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Supplier Code</Label>\r\n                    <p className=\"font-medium\">{order.supplierCode}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Payment Terms</Label>\r\n                    <p className=\"font-medium\">{order.paymentTerms}</p>\r\n                  </div>\r\n                  <div>\r\n                    <Label className=\"text-muted-foreground\">Delivery Terms</Label>\r\n                    <p className=\"font-medium\">{order.deliveryTerms}</p>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"text-lg\">Financial Summary</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"grid grid-cols-4 gap-4\">\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {formatCurrency(order.subtotal, order.currency)}\r\n                  </p>\r\n                  <p className=\"text-sm text-muted-foreground\">Subtotal</p>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {formatCurrency(order.taxAmount, order.currency)}\r\n                  </p>\r\n                  <p className=\"text-sm text-muted-foreground\">Tax</p>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {formatCurrency(order.shippingCost, order.currency)}\r\n                  </p>\r\n                  <p className=\"text-sm text-muted-foreground\">Shipping</p>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {formatCurrency(order.totalAmount, order.currency)}\r\n                  </p>\r\n                  <p className=\"text-sm text-muted-foreground\">Total</p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200\">\r\n                <div className=\"flex items-center space-x-2\">\r\n                  <Calculator className=\"h-4 w-4 text-blue-600\" />\r\n                  <span className=\"font-medium text-blue-800\">\r\n                    Budget Utilization\r\n                  </span>\r\n                </div>\r\n                <p className=\"text-sm text-blue-700 mt-1\">\r\n                  Budget: {order.budgetCode} •\r\n                  Remaining: {formatCurrency(order.budgetRemaining, order.currency)}\r\n                </p>\r\n                <div className=\"mt-2\">\r\n                  <Progress\r\n                    value={((order.budgetAllocated - order.budgetRemaining) / order.budgetAllocated) * 100}\r\n                    className=\"h-2\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"items\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Line Items ({order.items.length})</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                {order.items.map((item, index) => (\r\n                  <div key={item.id} className=\"border rounded-lg p-4\">\r\n                    <div className=\"flex items-start justify-between\">\r\n                      <div className=\"flex-1\">\r\n                        <div className=\"flex items-center space-x-2\">\r\n                          <Badge variant=\"outline\">#{item.lineNumber}</Badge>\r\n                          <span className=\"font-medium\">{item.productCode}</span>\r\n                        </div>\r\n                        <p className=\"text-sm text-muted-foreground mt-1\">\r\n                          {item.description}\r\n                        </p>\r\n                        {item.specifications && (\r\n                          <p className=\"text-xs text-muted-foreground mt-1\">\r\n                            Specs: {item.specifications}\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"text-right\">\r\n                        <p className=\"font-medium\">\r\n                          {formatCurrency(item.totalPrice, order.currency)}\r\n                        </p>\r\n                        <p className=\"text-sm text-muted-foreground\">\r\n                          {item.quantity} {item.unit} × {formatCurrency(item.unitPrice, order.currency)}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"mt-3 grid grid-cols-3 gap-4 text-sm\">\r\n                      <div>\r\n                        <Label className=\"text-muted-foreground\">Status</Label>\r\n                        <div className=\"mt-1\">\r\n                          <Badge className={getStatusColor(item.status)}>\r\n                            {item.status.replace(\"_\", \" \").toUpperCase()}\r\n                          </Badge>\r\n                        </div>\r\n                      </div>\r\n                      <div>\r\n                        <Label className=\"text-muted-foreground\">Received</Label>\r\n                        <p>{item.receivedQuantity} / {item.quantity} {item.unit}</p>\r\n                      </div>\r\n                      <div>\r\n                        <Label className=\"text-muted-foreground\">Delivery Date</Label>\r\n                        <p>{formatDate(item.requestedDate)}</p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {item.qualityRequirements && item.qualityRequirements.length > 0 && (\r\n                      <div className=\"mt-3\">\r\n                        <Label className=\"text-muted-foreground text-xs\">Quality Requirements</Label>\r\n                        <div className=\"flex flex-wrap gap-1 mt-1\">\r\n                          {item.qualityRequirements.map((req, idx) => (\r\n                            <Badge key={idx} variant=\"outline\" className=\"text-xs\">\r\n                              {req}\r\n                            </Badge>\r\n                          ))}\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"approval\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Approval Workflow</CardTitle>\r\n              <CardDescription>\r\n                Track the approval process and current status\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                {order.approvalWorkflow.map((step, index) => (\r\n                  <div key={step.id} className=\"flex items-center space-x-3\">\r\n                    <div className={cn(\r\n                      \"w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium\",\r\n                      step.status === \"approved\" ? \"bg-green-100 text-green-700\" :\r\n                      step.status === \"pending\" ? \"bg-yellow-100 text-yellow-700\" :\r\n                      step.status === \"rejected\" ? \"bg-red-100 text-red-700\" :\r\n                      \"bg-gray-100 text-gray-700\"\r\n                    )}>\r\n                      {step.stepNumber}\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <div>\r\n                          <p className=\"font-medium\">{step.approverRole}</p>\r\n                          <p className=\"text-sm text-muted-foreground\">{step.approverName}</p>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                          <Badge className={getStatusColor(step.status)}>\r\n                            {step.status.toUpperCase()}\r\n                          </Badge>\r\n                          {step.approvedDate && (\r\n                            <p className=\"text-xs text-muted-foreground mt-1\">\r\n                              {formatDateTime(step.approvedDate)}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                      {step.comments && (\r\n                        <p className=\"text-sm text-muted-foreground mt-1\">\r\n                          \"{step.comments}\"\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"receiving\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Receiving History</CardTitle>\r\n              <CardDescription>\r\n                Track received quantities and quality inspections\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              {order.receipts.length > 0 ? (\r\n                <div className=\"space-y-4\">\r\n                  {order.receipts.map((receipt) => (\r\n                    <div key={receipt.id} className=\"border rounded-lg p-4\">\r\n                      <div className=\"flex items-center justify-between mb-3\">\r\n                        <div>\r\n                          <p className=\"font-medium\">{receipt.receiptNumber}</p>\r\n                          <p className=\"text-sm text-muted-foreground\">\r\n                            Received on {formatDate(receipt.receivedDate)} by {receipt.receivedBy}\r\n                          </p>\r\n                        </div>\r\n                        <Badge className={getStatusColor(receipt.status)}>\r\n                          {receipt.status.toUpperCase()}\r\n                        </Badge>\r\n                      </div>\r\n\r\n                      {receipt.qualityInspection && (\r\n                        <div className=\"bg-green-50 border border-green-200 rounded p-3 mb-3\">\r\n                          <div className=\"flex items-center space-x-2\">\r\n                            <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n                            <span className=\"font-medium text-green-800\">\r\n                              Quality Inspection Passed\r\n                            </span>\r\n                          </div>\r\n                          <p className=\"text-sm text-green-700 mt-1\">\r\n                            Score: {receipt.qualityInspection.overallScore}% •\r\n                            Inspector: {receipt.qualityInspection.inspectorName}\r\n                          </p>\r\n                        </div>\r\n                      )}\r\n\r\n                      <div className=\"space-y-2\">\r\n                        {receipt.items.map((item) => (\r\n                          <div key={item.id} className=\"flex items-center justify-between text-sm\">\r\n                            <span>Line {item.poItemId}</span>\r\n                            <div className=\"text-right\">\r\n                              <span className=\"font-medium\">{item.receivedQuantity} received</span>\r\n                              <span className=\"text-muted-foreground ml-2\">\r\n                                ({item.acceptedQuantity} accepted, {item.rejectedQuantity} rejected)\r\n                              </span>\r\n                            </div>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              ) : (\r\n                <div className=\"text-center py-8\">\r\n                  <Package className=\"mx-auto h-12 w-12 text-muted-foreground\" />\r\n                  <h3 className=\"mt-4 text-lg font-medium\">No Receipts Yet</h3>\r\n                  <p className=\"text-sm text-muted-foreground mt-2\">\r\n                    Items will appear here once they are received\r\n                  </p>\r\n                  <Button className=\"mt-4\">\r\n                    <Receipt className=\"mr-2 h-4 w-4\" />\r\n                    Record Receipt\r\n                  </Button>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"matching\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Three-Way Matching</CardTitle>\r\n              <CardDescription>\r\n                Compare purchase order, receipt, and invoice data\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span>Matching Status</span>\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    {getThreeWayMatchIcon(order.threeWayMatchStatus)}\r\n                    <Badge className={getStatusColor(order.threeWayMatchStatus)}>\r\n                      {order.threeWayMatchStatus.replace(\"_\", \" \").toUpperCase()}\r\n                    </Badge>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm\">Purchase Order</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-2 text-sm\">\r\n                        <div className=\"flex justify-between\">\r\n                          <span>Amount</span>\r\n                          <span className=\"font-medium\">\r\n                            {formatCurrency(order.totalAmount, order.currency)}\r\n                          </span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                          <span>Items</span>\r\n                          <span>{order.items.reduce((sum, item) => sum + item.quantity, 0)}</span>\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm\">Receipt</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      {order.receipts.length > 0 ? (\r\n                        <div className=\"space-y-2 text-sm\">\r\n                          <div className=\"flex justify-between\">\r\n                            <span>Received</span>\r\n                            <span>{order.items.reduce((sum, item) => sum + item.receivedQuantity, 0)}</span>\r\n                          </div>\r\n                          <div className=\"flex justify-between\">\r\n                            <span>Status</span>\r\n                            <span className=\"text-green-600\">Partial</span>\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        <p className=\"text-sm text-muted-foreground\">No receipts</p>\r\n                      )}\r\n                    </CardContent>\r\n                  </Card>\r\n\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm\">Invoice</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      {order.invoices.length > 0 ? (\r\n                        <div className=\"space-y-2 text-sm\">\r\n                          <div className=\"flex justify-between\">\r\n                            <span>Amount</span>\r\n                            <span className=\"font-medium\">\r\n                              {formatCurrency(order.invoices[0].amount, order.invoices[0].currency)}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"flex justify-between\">\r\n                            <span>Status</span>\r\n                            <span className=\"text-green-600\">Matched</span>\r\n                          </div>\r\n                        </div>\r\n                      ) : (\r\n                        <p className=\"text-sm text-muted-foreground\">No invoices</p>\r\n                      )}\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>\r\n\r\n                {order.threeWayMatchStatus === \"exceptions\" && order.invoices.length > 0 && (\r\n                  <Card className=\"border-yellow-200 bg-yellow-50\">\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-sm text-yellow-800\">\r\n                        Matching Exceptions\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-2\">\r\n                        {order.invoices[0].matchingResults\r\n                          .filter(result => !result.matched)\r\n                          .map((result, index) => (\r\n                            <div key={index} className=\"flex items-center space-x-2 text-sm\">\r\n                              <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\r\n                              <span>\r\n                                {result.field}: Expected {result.poValue},\r\n                                Invoice shows {result.invoiceValue}\r\n                                {result.receiptValue && `, Receipt shows ${result.receiptValue}`}\r\n                              </span>\r\n                            </div>\r\n                          ))}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"documents\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Attached Documents</CardTitle>\r\n              <CardDescription>\r\n                View and manage purchase order documents and attachments\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                <Button variant=\"outline\">\r\n                  <Paperclip className=\"mr-2 h-4 w-4\" />\r\n                  Add Document\r\n                </Button>\r\n\r\n                {order.attachments.length > 0 ? (\r\n                  <div className=\"space-y-2\">\r\n                    {order.attachments.map((attachment) => (\r\n                      <div key={attachment.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                        <div className=\"flex items-center space-x-3\">\r\n                          <FileText className=\"h-5 w-5 text-blue-500\" />\r\n                          <div>\r\n                            <p className=\"font-medium\">{attachment.originalName}</p>\r\n                            <p className=\"text-sm text-muted-foreground\">\r\n                              {Math.round(attachment.fileSize / 1024)} KB •\r\n                              Uploaded {formatDate(attachment.uploadDate)}\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex items-center space-x-2\">\r\n                          <Button variant=\"ghost\" size=\"sm\">\r\n                            <Eye className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button variant=\"ghost\" size=\"sm\">\r\n                            <Download className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"text-center py-8\">\r\n                    <FileText className=\"mx-auto h-12 w-12 text-muted-foreground\" />\r\n                    <h3 className=\"mt-4 text-lg font-medium\">No Documents</h3>\r\n                    <p className=\"text-sm text-muted-foreground mt-2\">\r\n                      No documents have been attached to this order\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"history\" className=\"space-y-4\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Audit Trail</CardTitle>\r\n              <CardDescription>\r\n                Complete history of purchase order changes and activities\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                {order.auditTrail.map((entry) => (\r\n                  <div key={entry.id} className=\"flex items-start space-x-3\">\r\n                    <div className=\"w-2 h-2 bg-blue-500 rounded-full mt-2\"></div>\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <p className=\"font-medium\">{entry.action}</p>\r\n                        <span className=\"text-sm text-muted-foreground\">\r\n                          {formatDateTime(entry.timestamp)}\r\n                        </span>\r\n                      </div>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        {entry.details} by {entry.userName}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n      </Tabs>\r\n\r\n      <DialogFooter>\r\n        <Button variant=\"outline\" onClick={onClose}>\r\n          Close\r\n        </Button>\r\n        <Button>\r\n          <Edit className=\"mr-2 h-4 w-4\" />\r\n          Edit Order\r\n        </Button>\r\n      </DialogFooter>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\app\\suppliers\\pricelist-upload\\page.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":39,"column":17,"nodeType":"Identifier","messageId":"undef","endLine":39,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport React from 'react'\r\nimport AppLayout from '@/components/layout/AppLayout'\r\nimport SupplierPricelistUpload from '@/components/suppliers/SupplierPricelistUpload'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Info } from 'lucide-react'\r\n\r\nexport default function PricelistUploadPage() {\r\n  const breadcrumbs = [\r\n    { label: \"Suppliers\", href: \"/suppliers\" },\r\n    { label: \"Pricelist Upload\" }\r\n  ]\r\n\r\n  return (\r\n    <AppLayout\r\n      title=\"Supplier Pricelist Upload\"\r\n      breadcrumbs={breadcrumbs}\r\n    >\r\n      <div className=\"space-y-6\">\r\n        <Alert className=\"border-blue-200 bg-blue-50\">\r\n          <Info className=\"h-4 w-4 text-blue-600\" />\r\n          <AlertDescription className=\"text-blue-900\">\r\n            <strong>Pricelist Upload:</strong> Upload supplier pricelists in Excel or CSV format. \r\n            The system will automatically validate and process the data.\r\n          </AlertDescription>\r\n        </Alert>\r\n\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Upload Supplier Pricelist</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <SupplierPricelistUpload\r\n              supplierId={undefined}\r\n              onUploadComplete={(pricelist) => {\r\n                console.log('Pricelist uploaded:', pricelist)\r\n                alert('Pricelist uploaded successfully!')\r\n              }}\r\n              onCancel={() => {\r\n                console.log('Upload cancelled')\r\n                window.history.back()\r\n              }}\r\n            />\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </AppLayout>\r\n  )\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\ChatInterface.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":144,"column":33,"nodeType":"Identifier","messageId":"undef","endLine":144,"endColumn":47}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useEffect, useRef, useCallback } from \"react\"\r\nimport { motion, AnimatePresence } from \"framer-motion\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\"\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n  Brain,\r\n  MessageCircle,\r\n  Send,\r\n  Mic,\r\n  MicOff,\r\n  Paperclip,\r\n  Sparkles,\r\n  User,\r\n  Bot,\r\n  ThumbsUp,\r\n  ThumbsDown,\r\n  Copy,\r\n  Share,\r\n  MoreHorizontal,\r\n  Loader2,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Building2,\r\n  TrendingUp,\r\n  DollarSign,\r\n  Package,\r\n  BarChart3,\r\n  Lightbulb,\r\n  Search,\r\n  Filter,\r\n  Download,\r\n  FileText,\r\n  Zap,\r\n  Target,\r\n  Star,\r\n  Clock,\r\n  Globe,\r\n  ArrowRight,\r\n  RefreshCw,\r\n  Maximize2,\r\n  Minimize2,\r\n  Settings,\r\n  HelpCircle,\r\n  BookOpen,\r\n  Database,\r\n  ShieldCheck,\r\n  Award\r\n} from \"lucide-react\"\r\n\r\n// Types for AI Chat System\r\ninterface ChatMessage {\r\n  id: string\r\n  content: string\r\n  type: 'user' | 'ai' | 'system'\r\n  timestamp: Date\r\n  metadata?: {\r\n    confidence?: number\r\n    sources?: string[]\r\n    actions?: ChatAction[]\r\n    suggestions?: string[]\r\n    context?: any\r\n  }\r\n  reactions?: {\r\n    helpful?: boolean\r\n    accurate?: boolean\r\n  }\r\n}\r\n\r\ninterface ChatAction {\r\n  id: string\r\n  label: string\r\n  icon: React.ComponentType<{ className?: string }>\r\n  action: string\r\n  data?: any\r\n  variant?: 'default' | 'primary' | 'secondary' | 'destructive'\r\n}\r\n\r\ninterface QuickPrompt {\r\n  id: string\r\n  text: string\r\n  category: string\r\n  icon: React.ComponentType<{ className?: string }>\r\n  description: string\r\n}\r\n\r\ninterface AIContext {\r\n  currentProject?: string\r\n  recentQueries?: string[]\r\n  userPreferences?: {\r\n    verbosity: 'concise' | 'detailed' | 'comprehensive'\r\n    focusAreas: string[]\r\n    alertThreshold: number\r\n  }\r\n  sessionData?: any\r\n}\r\n\r\ninterface AIChatInterfaceProps {\r\n  onActionTrigger?: (action: ChatAction) => void\r\n  initialContext?: AIContext\r\n  compactMode?: boolean\r\n  enableVoice?: boolean\r\n  enableFileUpload?: boolean\r\n}\r\n\r\nconst AIChatInterface: React.FC<AIChatInterfaceProps> = ({\r\n  onActionTrigger,\r\n  initialContext,\r\n  compactMode = false,\r\n  enableVoice = true,\r\n  enableFileUpload = true\r\n}) => {\r\n  // State Management\r\n  const [messages, setMessages] = useState<ChatMessage[]>([])\r\n  const [inputMessage, setInputMessage] = useState(\"\")\r\n  const [isProcessing, setIsProcessing] = useState(false)\r\n  const [isListening, setIsListening] = useState(false)\r\n  const [context, setContext] = useState<AIContext>(initialContext || {})\r\n  const [isExpanded, setIsExpanded] = useState(!compactMode)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [typingIndicator, setTypingIndicator] = useState(false)\r\n\r\n  // Refs\r\n  const messagesEndRef = useRef<HTMLDivElement>(null)\r\n  const inputRef = useRef<HTMLInputElement>(null)\r\n  const speechRecognition = useRef<any>(null)\r\n\r\n  // Quick prompts for common queries\r\n  const quickPrompts: QuickPrompt[] = [\r\n    {\r\n      id: 'supplier_analysis',\r\n      text: 'Analyze our top suppliers performance',\r\n      category: 'Analysis',\r\n      icon: BarChart3,\r\n      description: 'Get comprehensive supplier performance analytics'\r\n    },\r\n    {\r\n      id: 'cost_optimization',\r\n      text: 'Find cost optimization opportunities',\r\n      category: 'Optimization',\r\n      icon: DollarSign,\r\n      description: 'Identify potential savings in procurement'\r\n    },\r\n    {\r\n      id: 'risk_assessment',\r\n      text: 'Show current supply chain risks',\r\n      category: 'Risk',\r\n      icon: AlertTriangle,\r\n      description: 'Review and assess supply chain vulnerabilities'\r\n    },\r\n    {\r\n      id: 'market_trends',\r\n      text: 'What are the latest market trends?',\r\n      category: 'Intelligence',\r\n      icon: TrendingUp,\r\n      description: 'Get current market intelligence and trends'\r\n    },\r\n    {\r\n      id: 'supplier_recommendation',\r\n      text: 'Recommend new suppliers for technology products',\r\n      category: 'Discovery',\r\n      icon: Building2,\r\n      description: 'AI-powered supplier discovery and recommendations'\r\n    },\r\n    {\r\n      id: 'compliance_check',\r\n      text: 'Check compliance status across suppliers',\r\n      category: 'Compliance',\r\n      icon: ShieldCheck,\r\n      description: 'Review supplier compliance and certifications'\r\n    }\r\n  ]\r\n\r\n  // Initialize chat with welcome message\r\n  useEffect(() => {\r\n    if (messages.length === 0) {\r\n      const welcomeMessage: ChatMessage = {\r\n        id: 'welcome',\r\n        content: `Hello! I'm your AI procurement assistant. I can help you with supplier analysis, cost optimization, market intelligence, and much more.\r\n\r\nHow can I assist you today?`,\r\n        type: 'ai',\r\n        timestamp: new Date(),\r\n        metadata: {\r\n          confidence: 100,\r\n          suggestions: [\r\n            \"Analyze supplier performance\",\r\n            \"Find cost savings opportunities\",\r\n            \"Check supply chain risks\",\r\n            \"Discover new suppliers\"\r\n          ]\r\n        }\r\n      }\r\n      setMessages([welcomeMessage])\r\n    }\r\n  }, [messages.length])\r\n\r\n  // Auto-scroll to bottom of messages\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\r\n  }, [messages, typingIndicator])\r\n\r\n  // Initialize speech recognition\r\n  useEffect(() => {\r\n    if (enableVoice && 'webkitSpeechRecognition' in window) {\r\n      speechRecognition.current = new (window as any).webkitSpeechRecognition()\r\n      speechRecognition.current.continuous = false\r\n      speechRecognition.current.interimResults = false\r\n      speechRecognition.current.lang = 'en-US'\r\n\r\n      speechRecognition.current.onresult = (event: any) => {\r\n        const transcript = event.results[0][0].transcript\r\n        setInputMessage(transcript)\r\n        setIsListening(false)\r\n      }\r\n\r\n      speechRecognition.current.onerror = () => {\r\n        setIsListening(false)\r\n        setError(\"Voice recognition error. Please try again.\")\r\n      }\r\n    }\r\n  }, [enableVoice])\r\n\r\n  // Process AI message with simulated AI responses\r\n  const processAIMessage = useCallback(async (userMessage: string) => {\r\n    setIsProcessing(true)\r\n    setTypingIndicator(true)\r\n    setError(null)\r\n\r\n    try {\r\n      // Simulate AI processing delay\r\n      await new Promise(resolve => setTimeout(resolve, 1500))\r\n\r\n      // Generate contextual AI response based on user input\r\n      let aiResponse = \"\"\r\n      let actions: ChatAction[] = []\r\n      let suggestions: string[] = []\r\n      const confidence = 85\r\n\r\n      // Analyze user intent and generate appropriate response\r\n      if (userMessage.toLowerCase().includes('supplier') && userMessage.toLowerCase().includes('performance')) {\r\n        aiResponse = `I've analyzed your supplier performance data. Here's what I found:\r\n\r\n**Top Performing Suppliers:**\r\n• TechFlow Solutions - 94% performance score, 98.2% on-time delivery\r\n• Global Component Systems - 87% performance score, excellent quality rating\r\n\r\n**Key Insights:**\r\n• Overall supplier performance has improved 12% over the last quarter\r\n• On-time delivery rates are averaging 95.2% across all suppliers\r\n• Quality scores show consistent upward trend\r\n\r\n**Recommendations:**\r\n• Consider expanding relationship with TechFlow Solutions\r\n• Review underperforming suppliers for potential replacement\r\n• Implement performance-based incentives`\r\n\r\n        actions = [\r\n          {\r\n            id: 'view_full_report',\r\n            label: 'View Full Report',\r\n            icon: FileText,\r\n            action: 'open_supplier_report',\r\n            variant: 'primary'\r\n          },\r\n          {\r\n            id: 'export_data',\r\n            label: 'Export Data',\r\n            icon: Download,\r\n            action: 'export_performance_data',\r\n            variant: 'secondary'\r\n          }\r\n        ]\r\n\r\n        suggestions = [\r\n          \"Show me risk analysis for these suppliers\",\r\n          \"Compare costs with market benchmarks\",\r\n          \"Find alternative suppliers\"\r\n        ]\r\n\r\n      } else if (userMessage.toLowerCase().includes('cost') && userMessage.toLowerCase().includes('optimization')) {\r\n        aiResponse = `I've identified several cost optimization opportunities:\r\n\r\n**Immediate Opportunities:**\r\n💰 **Supplier Consolidation** - Save $180,000 annually\r\n   - Consolidate 3 technology suppliers into 2\r\n   - Volume discount potential: 12-15%\r\n\r\n💰 **Contract Renegotiation** - Save $95,000 annually\r\n   - 5 contracts up for renewal in Q1\r\n   - Market rates have decreased 8% on average\r\n\r\n💰 **Inventory Optimization** - Save $67,000 annually\r\n   - Reduce safety stock by 15% using demand forecasting\r\n   - Optimize reorder points for top 50 SKUs\r\n\r\n**Total Potential Savings: $342,000**`\r\n\r\n        actions = [\r\n          {\r\n            id: 'create_action_plan',\r\n            label: 'Create Action Plan',\r\n            icon: Target,\r\n            action: 'create_optimization_plan',\r\n            variant: 'primary'\r\n          },\r\n          {\r\n            id: 'schedule_meetings',\r\n            label: 'Schedule Negotiations',\r\n            icon: Clock,\r\n            action: 'schedule_supplier_meetings',\r\n            variant: 'secondary'\r\n          }\r\n        ]\r\n\r\n        suggestions = [\r\n          \"Show me detailed savings breakdown\",\r\n          \"Create implementation timeline\",\r\n          \"Analyze risk of consolidation\"\r\n        ]\r\n\r\n      } else if (userMessage.toLowerCase().includes('risk')) {\r\n        aiResponse = `**Supply Chain Risk Analysis:**\r\n\r\n🚨 **High Priority Risks:**\r\n• Single source dependency for critical components (3 suppliers)\r\n• Geographic concentration in Southeast Asia (65% of suppliers)\r\n• 2 suppliers with credit rating downgrades\r\n\r\n⚠️ **Medium Priority Risks:**\r\n• Currency exposure (EUR/USD fluctuations affecting 12 suppliers)\r\n• Regulatory compliance gaps (2 suppliers pending certifications)\r\n\r\n✅ **Low Risk Areas:**\r\n• Supplier financial stability overall good\r\n• Strong backup supplier network for 80% of categories\r\n• Excellent compliance track record\r\n\r\n**Risk Score: Medium (6.2/10)**`\r\n\r\n        actions = [\r\n          {\r\n            id: 'create_mitigation_plan',\r\n            label: 'Create Mitigation Plan',\r\n            icon: ShieldCheck,\r\n            action: 'create_risk_plan',\r\n            variant: 'primary'\r\n          },\r\n          {\r\n            id: 'assess_alternatives',\r\n            label: 'Find Alternative Suppliers',\r\n            icon: Search,\r\n            action: 'search_alternative_suppliers',\r\n            variant: 'secondary'\r\n          }\r\n        ]\r\n\r\n        suggestions = [\r\n          \"Show detailed risk scores by category\",\r\n          \"Create supplier diversification plan\",\r\n          \"Set up risk monitoring alerts\"\r\n        ]\r\n\r\n      } else {\r\n        // Generic helpful response\r\n        aiResponse = `I understand you're looking for assistance with procurement and supplier management. I can help you with:\r\n\r\n• **Supplier Analysis** - Performance metrics, ratings, and comparisons\r\n• **Cost Optimization** - Identify savings opportunities and negotiate better terms\r\n• **Risk Management** - Assess and mitigate supply chain risks\r\n• **Market Intelligence** - Latest trends, pricing, and supplier insights\r\n• **Procurement Planning** - Strategic sourcing and supplier discovery\r\n\r\nWhat specific area would you like me to focus on?`\r\n\r\n        suggestions = [\r\n          \"Analyze supplier performance\",\r\n          \"Find cost savings opportunities\",\r\n          \"Check supply chain risks\",\r\n          \"Discover new suppliers\"\r\n        ]\r\n      }\r\n\r\n      const aiMessage: ChatMessage = {\r\n        id: Date.now().toString(),\r\n        content: aiResponse,\r\n        type: 'ai',\r\n        timestamp: new Date(),\r\n        metadata: {\r\n          confidence,\r\n          actions,\r\n          suggestions\r\n        }\r\n      }\r\n\r\n      setMessages(prev => [...prev, aiMessage])\r\n\r\n    } catch (err) {\r\n      setError(\"I encountered an error processing your request. Please try again.\")\r\n      console.error(\"AI processing error:\", err)\r\n    } finally {\r\n      setIsProcessing(false)\r\n      setTypingIndicator(false)\r\n    }\r\n  }, [])\r\n\r\n  // Send message handler\r\n  const sendMessage = useCallback(async () => {\r\n    if (!inputMessage.trim() || isProcessing) return\r\n\r\n    const userMessage: ChatMessage = {\r\n      id: Date.now().toString(),\r\n      content: inputMessage.trim(),\r\n      type: 'user',\r\n      timestamp: new Date()\r\n    }\r\n\r\n    setMessages(prev => [...prev, userMessage])\r\n    setInputMessage(\"\")\r\n\r\n    // Process AI response\r\n    await processAIMessage(userMessage.content)\r\n  }, [inputMessage, isProcessing, processAIMessage])\r\n\r\n  // Handle quick prompt selection\r\n  const handleQuickPrompt = (prompt: QuickPrompt) => {\r\n    setInputMessage(prompt.text)\r\n    inputRef.current?.focus()\r\n  }\r\n\r\n  // Handle voice input\r\n  const toggleVoiceInput = () => {\r\n    if (!speechRecognition.current) return\r\n\r\n    if (isListening) {\r\n      speechRecognition.current.stop()\r\n      setIsListening(false)\r\n    } else {\r\n      speechRecognition.current.start()\r\n      setIsListening(true)\r\n    }\r\n  }\r\n\r\n  // Handle message reactions\r\n  const handleReaction = (messageId: string, reaction: 'helpful' | 'accurate') => {\r\n    setMessages(prev => prev.map(msg =>\r\n      msg.id === messageId\r\n        ? {\r\n            ...msg,\r\n            reactions: {\r\n              ...msg.reactions,\r\n              [reaction]: !msg.reactions?.[reaction]\r\n            }\r\n          }\r\n        : msg\r\n    ))\r\n  }\r\n\r\n  // Handle action triggers\r\n  const handleActionTrigger = (action: ChatAction) => {\r\n    onActionTrigger?.(action)\r\n\r\n    // Add system message for action\r\n    const systemMessage: ChatMessage = {\r\n      id: Date.now().toString(),\r\n      content: `Action triggered: ${action.label}`,\r\n      type: 'system',\r\n      timestamp: new Date()\r\n    }\r\n    setMessages(prev => [...prev, systemMessage])\r\n  }\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <div className={`flex flex-col ${isExpanded ? 'h-[600px]' : 'h-96'} bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden`}>\r\n        {/* Header */}\r\n        <div className=\"bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <motion.div\r\n                animate={{ rotate: [0, 360] }}\r\n                transition={{ duration: 20, repeat: Infinity, ease: \"linear\" }}\r\n                className=\"p-2 bg-white/20 rounded-lg backdrop-blur-sm\"\r\n              >\r\n                <Brain className=\"h-5 w-5\" />\r\n              </motion.div>\r\n              <div>\r\n                <h2 className=\"font-bold text-lg\">AI Assistant</h2>\r\n                <p className=\"text-indigo-100 text-sm\">Procurement Intelligence</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Badge variant=\"secondary\" className=\"bg-white/20 text-white border-white/30\">\r\n                <Sparkles className=\"h-3 w-3 mr-1\" />\r\n                Online\r\n              </Badge>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setIsExpanded(!isExpanded)}\r\n                className=\"text-white hover:bg-white/20\"\r\n              >\r\n                {isExpanded ? <Minimize2 className=\"h-4 w-4\" /> : <Maximize2 className=\"h-4 w-4\" />}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Error Alert */}\r\n        {error && (\r\n          <Alert className=\"m-4 border-red-200 bg-red-50\">\r\n            <AlertTriangle className=\"h-4 w-4 text-red-600\" />\r\n            <AlertDescription className=\"text-red-800\">\r\n              <div className=\"font-semibold mb-1\">Error</div>\r\n              <div>{error}</div>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"mt-2\"\r\n                onClick={() => setError(null)}\r\n              >\r\n                Dismiss\r\n              </Button>\r\n            </AlertDescription>\r\n          </Alert>\r\n        )}\r\n\r\n        {/* Messages Area */}\r\n        <div className=\"flex-1 flex flex-col overflow-hidden\">\r\n          <ScrollArea className=\"flex-1 p-4\">\r\n            <div className=\"space-y-4\">\r\n              <AnimatePresence>\r\n                {messages.map((message, index) => (\r\n                  <motion.div\r\n                    key={message.id}\r\n                    initial={{ opacity: 0, y: 20 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    exit={{ opacity: 0, y: -20 }}\r\n                    transition={{ delay: index * 0.1 }}\r\n                    className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}\r\n                  >\r\n                    <div className={`max-w-[80%] ${\r\n                      message.type === 'user'\r\n                        ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl rounded-tr-sm'\r\n                        : message.type === 'system'\r\n                        ? 'bg-gray-100 text-gray-600 rounded-lg text-center text-sm py-2'\r\n                        : 'bg-gray-50 text-gray-800 rounded-2xl rounded-tl-sm'\r\n                    } p-4 shadow-lg`}>\r\n                      {/* Message Header */}\r\n                      <div className=\"flex items-center gap-2 mb-2\">\r\n                        {message.type === 'user' ? (\r\n                          <User className=\"h-4 w-4\" />\r\n                        ) : message.type === 'ai' ? (\r\n                          <Bot className=\"h-4 w-4 text-indigo-600\" />\r\n                        ) : null}\r\n                        <span className=\"text-xs opacity-70\">\r\n                          {message.timestamp.toLocaleTimeString()}\r\n                        </span>\r\n                        {message.metadata?.confidence && (\r\n                          <Badge variant=\"outline\" className=\"text-xs\">\r\n                            {message.metadata.confidence}% confident\r\n                          </Badge>\r\n                        )}\r\n                      </div>\r\n\r\n                      {/* Message Content */}\r\n                      <div className=\"whitespace-pre-wrap text-sm leading-relaxed\">\r\n                        {message.content}\r\n                      </div>\r\n\r\n                      {/* AI Message Actions */}\r\n                      {message.type === 'ai' && message.metadata?.actions && message.metadata.actions.length > 0 && (\r\n                        <div className=\"flex flex-wrap gap-2 mt-4\">\r\n                          {message.metadata.actions.map((action) => (\r\n                            <Button\r\n                              key={action.id}\r\n                              variant={action.variant || \"outline\"}\r\n                              size=\"sm\"\r\n                              onClick={() => handleActionTrigger(action)}\r\n                              className=\"text-xs\"\r\n                            >\r\n                              <action.icon className=\"h-3 w-3 mr-1\" />\r\n                              {action.label}\r\n                            </Button>\r\n                          ))}\r\n                        </div>\r\n                      )}\r\n\r\n                      {/* Suggestions */}\r\n                      {message.type === 'ai' && message.metadata?.suggestions && message.metadata.suggestions.length > 0 && (\r\n                        <div className=\"mt-4 pt-3 border-t border-gray-200\">\r\n                          <p className=\"text-xs text-gray-600 mb-2\">You might also ask:</p>\r\n                          <div className=\"flex flex-wrap gap-1\">\r\n                            {message.metadata.suggestions.map((suggestion, i) => (\r\n                              <Button\r\n                                key={i}\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => setInputMessage(suggestion)}\r\n                                className=\"text-xs h-auto py-1 px-2 text-gray-600 hover:text-gray-800\"\r\n                              >\r\n                                \"{suggestion}\"\r\n                              </Button>\r\n                            ))}\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n\r\n                      {/* Message Actions */}\r\n                      {message.type === 'ai' && (\r\n                        <div className=\"flex items-center gap-2 mt-3 pt-3 border-t border-gray-200\">\r\n                          <div className=\"flex gap-1\">\r\n                            <Tooltip>\r\n                              <TooltipTrigger asChild>\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  onClick={() => handleReaction(message.id, 'helpful')}\r\n                                  className={`h-6 w-6 p-0 ${message.reactions?.helpful ? 'text-green-600' : 'text-gray-400'}`}\r\n                                >\r\n                                  <ThumbsUp className=\"h-3 w-3\" />\r\n                                </Button>\r\n                              </TooltipTrigger>\r\n                              <TooltipContent>Helpful</TooltipContent>\r\n                            </Tooltip>\r\n\r\n                            <Tooltip>\r\n                              <TooltipTrigger asChild>\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  onClick={() => handleReaction(message.id, 'accurate')}\r\n                                  className={`h-6 w-6 p-0 ${message.reactions?.accurate ? 'text-red-600' : 'text-gray-400'}`}\r\n                                >\r\n                                  <ThumbsDown className=\"h-3 w-3\" />\r\n                                </Button>\r\n                              </TooltipTrigger>\r\n                              <TooltipContent>Not helpful</TooltipContent>\r\n                            </Tooltip>\r\n\r\n                            <Tooltip>\r\n                              <TooltipTrigger asChild>\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  onClick={() => navigator.clipboard.writeText(message.content)}\r\n                                  className=\"h-6 w-6 p-0 text-gray-400 hover:text-gray-600\"\r\n                                >\r\n                                  <Copy className=\"h-3 w-3\" />\r\n                                </Button>\r\n                              </TooltipTrigger>\r\n                              <TooltipContent>Copy</TooltipContent>\r\n                            </Tooltip>\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </motion.div>\r\n                ))}\r\n              </AnimatePresence>\r\n\r\n              {/* Typing Indicator */}\r\n              <AnimatePresence>\r\n                {typingIndicator && (\r\n                  <motion.div\r\n                    initial={{ opacity: 0, y: 10 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    exit={{ opacity: 0, y: -10 }}\r\n                    className=\"flex justify-start\"\r\n                  >\r\n                    <div className=\"bg-gray-100 rounded-2xl rounded-tl-sm p-4 shadow-lg\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Bot className=\"h-4 w-4 text-indigo-600\" />\r\n                        <div className=\"flex gap-1\">\r\n                          {[0, 1, 2].map((i) => (\r\n                            <motion.div\r\n                              key={i}\r\n                              animate={{ scale: [1, 1.2, 1] }}\r\n                              transition={{\r\n                                duration: 1,\r\n                                repeat: Infinity,\r\n                                delay: i * 0.2\r\n                              }}\r\n                              className=\"w-2 h-2 bg-indigo-400 rounded-full\"\r\n                            />\r\n                          ))}\r\n                        </div>\r\n                        <span className=\"text-sm text-gray-600\">AI is thinking...</span>\r\n                      </div>\r\n                    </div>\r\n                  </motion.div>\r\n                )}\r\n              </AnimatePresence>\r\n\r\n              <div ref={messagesEndRef} />\r\n            </div>\r\n          </ScrollArea>\r\n\r\n          {/* Quick Prompts (when no conversation yet) */}\r\n          {messages.length <= 1 && (\r\n            <div className=\"p-4 border-t\">\r\n              <h3 className=\"text-sm font-medium text-gray-700 mb-3\">Quick Start:</h3>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\r\n                {quickPrompts.slice(0, 4).map((prompt) => (\r\n                  <Button\r\n                    key={prompt.id}\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => handleQuickPrompt(prompt)}\r\n                    className=\"justify-start text-left h-auto py-2\"\r\n                  >\r\n                    <prompt.icon className=\"h-4 w-4 mr-2 flex-shrink-0\" />\r\n                    <div>\r\n                      <div className=\"font-medium text-xs\">{prompt.text}</div>\r\n                      <div className=\"text-xs text-gray-500\">{prompt.description}</div>\r\n                    </div>\r\n                  </Button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Input Area */}\r\n          <div className=\"p-4 border-t bg-gray-50\">\r\n            <div className=\"flex gap-2\">\r\n              <div className=\"flex-1 relative\">\r\n                <Input\r\n                  ref={inputRef}\r\n                  placeholder=\"Ask me anything about procurement, suppliers, or analytics...\"\r\n                  value={inputMessage}\r\n                  onChange={(e) => setInputMessage(e.target.value)}\r\n                  onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && sendMessage()}\r\n                  disabled={isProcessing}\r\n                  className=\"pr-20 py-6 text-sm border-2 border-gray-200 focus:border-indigo-400 rounded-xl\"\r\n                  aria-label=\"Chat message input\"\r\n                />\r\n                <div className=\"absolute right-2 top-1/2 transform -translate-y-1/2 flex gap-1\">\r\n                  {enableVoice && (\r\n                    <Tooltip>\r\n                      <TooltipTrigger asChild>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          onClick={toggleVoiceInput}\r\n                          disabled={isProcessing}\r\n                          className={`h-8 w-8 p-0 ${isListening ? 'text-red-500' : 'text-gray-400'}`}\r\n                        >\r\n                          {isListening ? <MicOff className=\"h-4 w-4\" /> : <Mic className=\"h-4 w-4\" />}\r\n                        </Button>\r\n                      </TooltipTrigger>\r\n                      <TooltipContent>Voice input</TooltipContent>\r\n                    </Tooltip>\r\n                  )}\r\n                  {enableFileUpload && (\r\n                    <Tooltip>\r\n                      <TooltipTrigger asChild>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          disabled={isProcessing}\r\n                          className=\"h-8 w-8 p-0 text-gray-400 hover:text-gray-600\"\r\n                        >\r\n                          <Paperclip className=\"h-4 w-4\" />\r\n                        </Button>\r\n                      </TooltipTrigger>\r\n                      <TooltipContent>Attach file</TooltipContent>\r\n                    </Tooltip>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              <Button\r\n                onClick={sendMessage}\r\n                disabled={!inputMessage.trim() || isProcessing}\r\n                className=\"px-6 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-xl\"\r\n              >\r\n                {isProcessing ? (\r\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                ) : (\r\n                  <Send className=\"h-4 w-4\" />\r\n                )}\r\n              </Button>\r\n            </div>\r\n            <p className=\"text-xs text-gray-500 mt-2 text-center\">\r\n              AI assistant may make mistakes. Verify important information.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </TooltipProvider>\r\n  )\r\n}\r\n\r\nexport default AIChatInterface","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\ChatInterfaceV5.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":116,"column":33,"nodeType":"Identifier","messageId":"undef","endLine":116,"endColumn":47}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n/**\r\n * AI Chat Interface - Vercel AI SDK v5 Integration\r\n *\r\n * Features:\r\n * - Real-time streaming with useChat hook\r\n * - Message history persistence\r\n * - Action buttons and suggestions\r\n * - Voice input support\r\n * - File attachment capabilities\r\n * - Responsive design with accessibility\r\n */\r\n\r\nimport React, { useState, useEffect, useRef } from \"react\"\r\nimport { useChat } from 'ai/react'\r\nimport { motion, AnimatePresence } from \"framer-motion\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\"\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\"\r\nimport {\r\n  Brain,\r\n  Send,\r\n  Mic,\r\n  MicOff,\r\n  Paperclip,\r\n  Sparkles,\r\n  User,\r\n  Bot,\r\n  ThumbsUp,\r\n  ThumbsDown,\r\n  Copy,\r\n  Loader2,\r\n  AlertTriangle,\r\n  Building2,\r\n  TrendingUp,\r\n  DollarSign,\r\n  BarChart3,\r\n  ShieldCheck,\r\n  Maximize2,\r\n  Minimize2,\r\n  FileText,\r\n  Download,\r\n  Target,\r\n} from \"lucide-react\"\r\n\r\n// Types\r\ninterface ChatAction {\r\n  id: string\r\n  label: string\r\n  icon: React.ComponentType<{ className?: string }>\r\n  action: string\r\n  data?: any\r\n  variant?: 'default' | 'primary' | 'secondary' | 'destructive'\r\n}\r\n\r\ninterface QuickPrompt {\r\n  id: string\r\n  text: string\r\n  category: string\r\n  icon: React.ComponentType<{ className?: string }>\r\n  description: string\r\n}\r\n\r\ninterface AIChatInterfaceV5Props {\r\n  onActionTrigger?: (action: ChatAction) => void\r\n  compactMode?: boolean\r\n  enableVoice?: boolean\r\n  enableFileUpload?: boolean\r\n  apiEndpoint?: string\r\n  conversationId?: string\r\n}\r\n\r\nconst AIChatInterfaceV5: React.FC<AIChatInterfaceV5Props> = ({\r\n  onActionTrigger,\r\n  compactMode = false,\r\n  enableVoice = true,\r\n  enableFileUpload = true,\r\n  apiEndpoint = '/api/ai/chat',\r\n  conversationId,\r\n}) => {\r\n  // Vercel AI SDK v5 useChat hook\r\n  const {\r\n    messages,\r\n    input,\r\n    handleInputChange,\r\n    handleSubmit,\r\n    isLoading,\r\n    error: chatError,\r\n    reload,\r\n    stop,\r\n  } = useChat({\r\n    api: apiEndpoint,\r\n    id: conversationId,\r\n    onError: (error) => {\r\n      console.error('Chat error:', error)\r\n      setError(error.message)\r\n    },\r\n  })\r\n\r\n  // Local state\r\n  const [isExpanded, setIsExpanded] = useState(!compactMode)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [isListening, setIsListening] = useState(false)\r\n\r\n  // Refs\r\n  const messagesEndRef = useRef<HTMLDivElement>(null)\r\n  const inputRef = useRef<HTMLInputElement>(null)\r\n  const speechRecognition = useRef<any>(null)\r\n\r\n  // Quick prompts for common queries\r\n  const quickPrompts: QuickPrompt[] = [\r\n    {\r\n      id: 'supplier_analysis',\r\n      text: 'Analyze our top suppliers performance',\r\n      category: 'Analysis',\r\n      icon: BarChart3,\r\n      description: 'Get comprehensive supplier performance analytics'\r\n    },\r\n    {\r\n      id: 'cost_optimization',\r\n      text: 'Find cost optimization opportunities',\r\n      category: 'Optimization',\r\n      icon: DollarSign,\r\n      description: 'Identify potential savings in procurement'\r\n    },\r\n    {\r\n      id: 'risk_assessment',\r\n      text: 'Show current supply chain risks',\r\n      category: 'Risk',\r\n      icon: AlertTriangle,\r\n      description: 'Review and assess supply chain vulnerabilities'\r\n    },\r\n    {\r\n      id: 'market_trends',\r\n      text: 'What are the latest market trends?',\r\n      category: 'Intelligence',\r\n      icon: TrendingUp,\r\n      description: 'Get current market intelligence and trends'\r\n    },\r\n    {\r\n      id: 'supplier_recommendation',\r\n      text: 'Recommend new suppliers for technology products',\r\n      category: 'Discovery',\r\n      icon: Building2,\r\n      description: 'AI-powered supplier discovery and recommendations'\r\n    },\r\n    {\r\n      id: 'compliance_check',\r\n      text: 'Check compliance status across suppliers',\r\n      category: 'Compliance',\r\n      icon: ShieldCheck,\r\n      description: 'Review supplier compliance and certifications'\r\n    }\r\n  ]\r\n\r\n  // Auto-scroll to bottom of messages\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\r\n  }, [messages])\r\n\r\n  // Initialize speech recognition\r\n  useEffect(() => {\r\n    if (enableVoice && 'webkitSpeechRecognition' in window) {\r\n      speechRecognition.current = new (window as any).webkitSpeechRecognition()\r\n      speechRecognition.current.continuous = false\r\n      speechRecognition.current.interimResults = false\r\n      speechRecognition.current.lang = 'en-US'\r\n\r\n      speechRecognition.current.onresult = (event: any) => {\r\n        const transcript = event.results[0][0].transcript\r\n        handleInputChange({ target: { value: transcript } } as any)\r\n        setIsListening(false)\r\n      }\r\n\r\n      speechRecognition.current.onerror = () => {\r\n        setIsListening(false)\r\n        setError(\"Voice recognition error. Please try again.\")\r\n      }\r\n    }\r\n  }, [enableVoice, handleInputChange])\r\n\r\n  // Clear error after chat error is resolved\r\n  useEffect(() => {\r\n    if (chatError) {\r\n      setError(chatError.message)\r\n    }\r\n  }, [chatError])\r\n\r\n  // Handle quick prompt selection\r\n  const handleQuickPrompt = (prompt: QuickPrompt) => {\r\n    handleInputChange({ target: { value: prompt.text } } as any)\r\n    inputRef.current?.focus()\r\n  }\r\n\r\n  // Handle voice input\r\n  const toggleVoiceInput = () => {\r\n    if (!speechRecognition.current) return\r\n\r\n    if (isListening) {\r\n      speechRecognition.current.stop()\r\n      setIsListening(false)\r\n    } else {\r\n      speechRecognition.current.start()\r\n      setIsListening(true)\r\n    }\r\n  }\r\n\r\n  // Handle message reactions (feedback)\r\n  const handleReaction = (messageId: string, reaction: 'helpful' | 'notHelpful') => {\r\n    // Send feedback to analytics endpoint\r\n    fetch('/api/ai/feedback', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        messageId,\r\n        reaction,\r\n        conversationId,\r\n      }),\r\n    }).catch(err => console.error('Failed to submit feedback:', err))\r\n  }\r\n\r\n  // Copy message to clipboard\r\n  const copyToClipboard = (text: string) => {\r\n    navigator.clipboard.writeText(text)\r\n      .then(() => {\r\n        // Could show toast notification here\r\n        console.log('Copied to clipboard')\r\n      })\r\n      .catch(err => console.error('Failed to copy:', err))\r\n  }\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <div className={`flex flex-col ${isExpanded ? 'h-[600px]' : 'h-96'} bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden`}>\r\n        {/* Header */}\r\n        <div className=\"bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <motion.div\r\n                animate={{ rotate: [0, 360] }}\r\n                transition={{ duration: 20, repeat: Infinity, ease: \"linear\" }}\r\n                className=\"p-2 bg-white/20 rounded-lg backdrop-blur-sm\"\r\n              >\r\n                <Brain className=\"h-5 w-5\" />\r\n              </motion.div>\r\n              <div>\r\n                <h2 className=\"font-bold text-lg\">AI Assistant</h2>\r\n                <p className=\"text-indigo-100 text-sm\">Procurement Intelligence</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Badge variant=\"secondary\" className=\"bg-white/20 text-white border-white/30\">\r\n                <Sparkles className=\"h-3 w-3 mr-1\" />\r\n                {isLoading ? 'Thinking...' : 'Online'}\r\n              </Badge>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setIsExpanded(!isExpanded)}\r\n                className=\"text-white hover:bg-white/20\"\r\n                aria-label={isExpanded ? 'Minimize chat' : 'Expand chat'}\r\n              >\r\n                {isExpanded ? <Minimize2 className=\"h-4 w-4\" /> : <Maximize2 className=\"h-4 w-4\" />}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Error Alert */}\r\n        {error && (\r\n          <Alert className=\"m-4 border-red-200 bg-red-50 dark:bg-red-900/20 dark:border-red-800\">\r\n            <AlertTriangle className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\r\n            <AlertDescription className=\"text-red-800 dark:text-red-300\">\r\n              <div className=\"font-semibold mb-1\">Error</div>\r\n              <div>{error}</div>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"mt-2\"\r\n                onClick={() => {\r\n                  setError(null)\r\n                  reload()\r\n                }}\r\n              >\r\n                Retry\r\n              </Button>\r\n            </AlertDescription>\r\n          </Alert>\r\n        )}\r\n\r\n        {/* Messages Area */}\r\n        <div className=\"flex-1 flex flex-col overflow-hidden\">\r\n          <ScrollArea className=\"flex-1 p-4\">\r\n            <div className=\"space-y-4\">\r\n              {messages.length === 0 && (\r\n                <motion.div\r\n                  initial={{ opacity: 0, y: 20 }}\r\n                  animate={{ opacity: 1, y: 0 }}\r\n                  className=\"text-center py-8\"\r\n                >\r\n                  <div className=\"mx-auto w-16 h-16 bg-gradient-to-r from-purple-100 to-indigo-100 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-full flex items-center justify-center mb-4\">\r\n                    <Brain className=\"h-8 w-8 text-purple-600 dark:text-purple-400\" />\r\n                  </div>\r\n                  <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-2\">\r\n                    Hello! I'm your AI procurement assistant.\r\n                  </h3>\r\n                  <p className=\"text-gray-600 dark:text-gray-400\">\r\n                    I can help you with supplier analysis, cost optimization, market intelligence, and much more.\r\n                  </p>\r\n                </motion.div>\r\n              )}\r\n\r\n              <AnimatePresence>\r\n                {messages.map((message, index) => (\r\n                  <motion.div\r\n                    key={message.id}\r\n                    initial={{ opacity: 0, y: 20 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    exit={{ opacity: 0, y: -20 }}\r\n                    transition={{ delay: index * 0.05 }}\r\n                    className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}\r\n                  >\r\n                    <div className={`max-w-[80%] ${\r\n                      message.role === 'user'\r\n                        ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl rounded-tr-sm'\r\n                        : 'bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-gray-100 rounded-2xl rounded-tl-sm'\r\n                    } p-4 shadow-lg`}>\r\n                      {/* Message Header */}\r\n                      <div className=\"flex items-center gap-2 mb-2\">\r\n                        {message.role === 'user' ? (\r\n                          <User className=\"h-4 w-4\" />\r\n                        ) : (\r\n                          <Bot className=\"h-4 w-4 text-indigo-600 dark:text-indigo-400\" />\r\n                        )}\r\n                        <span className=\"text-xs opacity-70\">\r\n                          {new Date(message.createdAt || Date.now()).toLocaleTimeString()}\r\n                        </span>\r\n                      </div>\r\n\r\n                      {/* Message Content */}\r\n                      <div className=\"whitespace-pre-wrap text-sm leading-relaxed\">\r\n                        {message.content}\r\n                      </div>\r\n\r\n                      {/* Message Actions (AI messages only) */}\r\n                      {message.role === 'assistant' && (\r\n                        <div className=\"flex items-center gap-2 mt-3 pt-3 border-t border-gray-200 dark:border-gray-700\">\r\n                          <div className=\"flex gap-1\">\r\n                            <Tooltip>\r\n                              <TooltipTrigger asChild>\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  onClick={() => handleReaction(message.id, 'helpful')}\r\n                                  className=\"h-6 w-6 p-0 text-gray-400 hover:text-green-600 dark:text-gray-500 dark:hover:text-green-400\"\r\n                                  aria-label=\"Mark as helpful\"\r\n                                >\r\n                                  <ThumbsUp className=\"h-3 w-3\" />\r\n                                </Button>\r\n                              </TooltipTrigger>\r\n                              <TooltipContent>Helpful</TooltipContent>\r\n                            </Tooltip>\r\n\r\n                            <Tooltip>\r\n                              <TooltipTrigger asChild>\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  onClick={() => handleReaction(message.id, 'notHelpful')}\r\n                                  className=\"h-6 w-6 p-0 text-gray-400 hover:text-red-600 dark:text-gray-500 dark:hover:text-red-400\"\r\n                                  aria-label=\"Mark as not helpful\"\r\n                                >\r\n                                  <ThumbsDown className=\"h-3 w-3\" />\r\n                                </Button>\r\n                              </TooltipTrigger>\r\n                              <TooltipContent>Not helpful</TooltipContent>\r\n                            </Tooltip>\r\n\r\n                            <Tooltip>\r\n                              <TooltipTrigger asChild>\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  onClick={() => copyToClipboard(message.content)}\r\n                                  className=\"h-6 w-6 p-0 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300\"\r\n                                  aria-label=\"Copy message\"\r\n                                >\r\n                                  <Copy className=\"h-3 w-3\" />\r\n                                </Button>\r\n                              </TooltipTrigger>\r\n                              <TooltipContent>Copy</TooltipContent>\r\n                            </Tooltip>\r\n                          </div>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </motion.div>\r\n                ))}\r\n              </AnimatePresence>\r\n\r\n              {/* Loading Indicator */}\r\n              <AnimatePresence>\r\n                {isLoading && (\r\n                  <motion.div\r\n                    initial={{ opacity: 0, y: 10 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    exit={{ opacity: 0, y: -10 }}\r\n                    className=\"flex justify-start\"\r\n                  >\r\n                    <div className=\"bg-gray-100 dark:bg-gray-800 rounded-2xl rounded-tl-sm p-4 shadow-lg\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Bot className=\"h-4 w-4 text-indigo-600 dark:text-indigo-400\" />\r\n                        <div className=\"flex gap-1\">\r\n                          {[0, 1, 2].map((i) => (\r\n                            <motion.div\r\n                              key={i}\r\n                              animate={{ scale: [1, 1.2, 1] }}\r\n                              transition={{\r\n                                duration: 1,\r\n                                repeat: Infinity,\r\n                                delay: i * 0.2\r\n                              }}\r\n                              className=\"w-2 h-2 bg-indigo-400 dark:bg-indigo-500 rounded-full\"\r\n                            />\r\n                          ))}\r\n                        </div>\r\n                        <span className=\"text-sm text-gray-600 dark:text-gray-400\">AI is thinking...</span>\r\n                      </div>\r\n                    </div>\r\n                  </motion.div>\r\n                )}\r\n              </AnimatePresence>\r\n\r\n              <div ref={messagesEndRef} />\r\n            </div>\r\n          </ScrollArea>\r\n\r\n          {/* Quick Prompts (when no conversation yet) */}\r\n          {messages.length === 0 && (\r\n            <div className=\"p-4 border-t dark:border-gray-700\">\r\n              <h3 className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3\">Quick Start:</h3>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\r\n                {quickPrompts.slice(0, 4).map((prompt) => (\r\n                  <Button\r\n                    key={prompt.id}\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => handleQuickPrompt(prompt)}\r\n                    className=\"justify-start text-left h-auto py-2 dark:bg-gray-800 dark:hover:bg-gray-700 dark:border-gray-600\"\r\n                  >\r\n                    <prompt.icon className=\"h-4 w-4 mr-2 flex-shrink-0\" />\r\n                    <div>\r\n                      <div className=\"font-medium text-xs\">{prompt.text}</div>\r\n                      <div className=\"text-xs text-gray-500 dark:text-gray-400\">{prompt.description}</div>\r\n                    </div>\r\n                  </Button>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Input Area */}\r\n          <div className=\"p-4 border-t bg-gray-50 dark:bg-gray-800 dark:border-gray-700\">\r\n            <form onSubmit={handleSubmit} className=\"flex gap-2\">\r\n              <div className=\"flex-1 relative\">\r\n                <Input\r\n                  ref={inputRef}\r\n                  placeholder=\"Ask me anything about procurement, suppliers, or analytics...\"\r\n                  value={input}\r\n                  onChange={handleInputChange}\r\n                  disabled={isLoading}\r\n                  className=\"pr-20 py-6 text-sm border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-indigo-400 dark:focus:border-indigo-500 rounded-xl\"\r\n                  aria-label=\"Chat message input\"\r\n                />\r\n                <div className=\"absolute right-2 top-1/2 transform -translate-y-1/2 flex gap-1\">\r\n                  {enableVoice && (\r\n                    <Tooltip>\r\n                      <TooltipTrigger asChild>\r\n                        <Button\r\n                          type=\"button\"\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          onClick={toggleVoiceInput}\r\n                          disabled={isLoading}\r\n                          className={`h-8 w-8 p-0 ${isListening ? 'text-red-500' : 'text-gray-400 dark:text-gray-500'}`}\r\n                          aria-label=\"Voice input\"\r\n                        >\r\n                          {isListening ? <MicOff className=\"h-4 w-4\" /> : <Mic className=\"h-4 w-4\" />}\r\n                        </Button>\r\n                      </TooltipTrigger>\r\n                      <TooltipContent>Voice input</TooltipContent>\r\n                    </Tooltip>\r\n                  )}\r\n                  {enableFileUpload && (\r\n                    <Tooltip>\r\n                      <TooltipTrigger asChild>\r\n                        <Button\r\n                          type=\"button\"\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          disabled={isLoading}\r\n                          className=\"h-8 w-8 p-0 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300\"\r\n                          aria-label=\"Attach file\"\r\n                        >\r\n                          <Paperclip className=\"h-4 w-4\" />\r\n                        </Button>\r\n                      </TooltipTrigger>\r\n                      <TooltipContent>Attach file</TooltipContent>\r\n                    </Tooltip>\r\n                  )}\r\n                </div>\r\n              </div>\r\n              <Button\r\n                type=\"submit\"\r\n                disabled={!input.trim() || isLoading}\r\n                className=\"px-6 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-xl disabled:opacity-50\"\r\n                aria-label=\"Send message\"\r\n              >\r\n                {isLoading ? (\r\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                ) : (\r\n                  <Send className=\"h-4 w-4\" />\r\n                )}\r\n              </Button>\r\n            </form>\r\n            <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-2 text-center\">\r\n              AI assistant may make mistakes. Verify important information.\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </TooltipProvider>\r\n  )\r\n}\r\n\r\nexport default AIChatInterfaceV5\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\InsightCards.tsx","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":462,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":462,"endColumn":76,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13667,13803],"text":"{ const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 }\n          return priorityOrder[a.priority] - priorityOrder[b.priority] }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport React, { useState, useEffect, useMemo } from \"react\"\nimport { motion, AnimatePresence } from \"framer-motion\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Progress } from \"@/components/ui/progress\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\nimport { Separator } from \"@/components/ui/separator\"\nimport { Alert, AlertDescription } from \"@/components/ui/alert\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\"\nimport {\n  Brain,\n  Sparkles,\n  TrendingUp,\n  TrendingDown,\n  DollarSign,\n  AlertTriangle,\n  CheckCircle,\n  Target,\n  Lightbulb,\n  BarChart3,\n  Zap,\n  Star,\n  Award,\n  ShieldCheck,\n  Clock,\n  ArrowRight,\n  ArrowUp,\n  ArrowDown,\n  MoreHorizontal,\n  RefreshCw,\n  Filter,\n  Eye,\n  Bookmark,\n  BookmarkCheck,\n  Share,\n  Download,\n  Bell,\n  X,\n  Plus,\n  Gauge,\n  Activity,\n  Building2,\n  Package,\n  Users,\n  Globe,\n  Calculator,\n  Database,\n  PieChart,\n  FileText,\n  Crown,\n  Loader2,\n  Info,\n  ExternalLink,\n  ThumbsUp,\n  ThumbsDown\n} from \"lucide-react\"\n\n// Enhanced AI Insight Types\nexport interface AIInsight {\n  id: string\n  type: 'opportunity' | 'risk' | 'trend' | 'anomaly' | 'prediction' | 'recommendation'\n  priority: 'critical' | 'high' | 'medium' | 'low'\n  title: string\n  description: string\n  summary: string\n  impact: {\n    financial: number\n    operational: string\n    timeline: string\n    probability: number\n  }\n  confidence: number\n  dataPoints: number\n  sources: string[]\n  category: string\n  subcategory?: string\n  tags: string[]\n  actions: {\n    primary: ActionItem\n    secondary: ActionItem[]\n  }\n  metrics: {\n    [key: string]: {\n      current: number\n      target?: number\n      trend: 'up' | 'down' | 'stable'\n      unit: string\n      formatted?: string\n    }\n  }\n  visualization?: {\n    type: 'chart' | 'gauge' | 'progress' | 'comparison'\n    data: any\n    config?: any\n  }\n  relatedInsights: string[]\n  createdAt: string\n  updatedAt: string\n  expiresAt?: string\n  status: 'new' | 'viewed' | 'bookmarked' | 'actioned' | 'dismissed'\n  aiModel: string\n  version: string\n}\n\ninterface ActionItem {\n  id: string\n  label: string\n  description: string\n  icon: React.ComponentType<{ className?: string }>\n  action: string\n  data?: any\n  urgency: 'immediate' | 'this_week' | 'this_month' | 'planned'\n  estimatedEffort: 'low' | 'medium' | 'high'\n  estimatedValue: number\n}\n\ninterface AIInsightCardsProps {\n  insights?: AIInsight[]\n  onInsightAction?: (insightId: string, action: ActionItem) => void\n  onInsightStatusChange?: (insightId: string, status: AIInsight['status']) => void\n  onRefresh?: () => void\n  compactMode?: boolean\n  maxCards?: number\n  filterBy?: {\n    type?: AIInsight['type'][]\n    priority?: AIInsight['priority'][]\n    category?: string[]\n  }\n}\n\nconst AIInsightCards: React.FC<AIInsightCardsProps> = ({\n  insights = [],\n  onInsightAction,\n  onInsightStatusChange,\n  onRefresh,\n  compactMode = false,\n  maxCards,\n  filterBy\n}) => {\n  // State Management\n  const [loading, setLoading] = useState(false)\n  const [selectedInsights, setSelectedInsights] = useState<string[]>([])\n  const [sortBy, setSortBy] = useState<'priority' | 'confidence' | 'impact' | 'date'>('priority')\n  const [viewMode, setViewMode] = useState<'cards' | 'list'>('cards')\n  const [error, setError] = useState<string | null>(null)\n\n  // Mock insights data for demonstration\n  const mockInsights: AIInsight[] = [\n    {\n      id: 'insight_001',\n      type: 'opportunity',\n      priority: 'high',\n      title: 'Supplier Consolidation Opportunity',\n      description: 'AI analysis identifies potential 18% cost reduction through strategic supplier consolidation in technology category.',\n      summary: 'Consolidate 5 technology suppliers into 2 primary partners for significant volume discounts and reduced management overhead.',\n      impact: {\n        financial: 275000,\n        operational: 'Reduced vendor management complexity by 60%',\n        timeline: '6 months',\n        probability: 87\n      },\n      confidence: 91,\n      dataPoints: 124,\n      sources: ['Purchase Orders 2024', 'Supplier Performance Data', 'Market Price Analysis'],\n      category: 'Cost Optimization',\n      subcategory: 'Vendor Management',\n      tags: ['cost-reduction', 'vendor-consolidation', 'technology'],\n      actions: {\n        primary: {\n          id: 'create_consolidation_plan',\n          label: 'Create Consolidation Plan',\n          description: 'Generate detailed supplier consolidation strategy',\n          icon: Target,\n          action: 'create_plan',\n          urgency: 'this_week',\n          estimatedEffort: 'medium',\n          estimatedValue: 275000\n        },\n        secondary: [\n          {\n            id: 'analyze_suppliers',\n            label: 'Analyze Current Suppliers',\n            description: 'Deep dive into current supplier performance',\n            icon: BarChart3,\n            action: 'analyze_suppliers',\n            urgency: 'immediate',\n            estimatedEffort: 'low',\n            estimatedValue: 0\n          },\n          {\n            id: 'market_research',\n            label: 'Market Research',\n            description: 'Research alternative suppliers and pricing',\n            icon: Globe,\n            action: 'market_research',\n            urgency: 'this_week',\n            estimatedEffort: 'high',\n            estimatedValue: 50000\n          }\n        ]\n      },\n      metrics: {\n        currentSuppliers: {\n          current: 5,\n          target: 2,\n          trend: 'down',\n          unit: 'suppliers',\n          formatted: '5 → 2 suppliers'\n        },\n        potentialSavings: {\n          current: 275000,\n          trend: 'up',\n          unit: 'USD',\n          formatted: '$275K annually'\n        },\n        managementReduction: {\n          current: 60,\n          trend: 'up',\n          unit: '%',\n          formatted: '60% reduction'\n        }\n      },\n      visualization: {\n        type: 'chart',\n        data: [\n          { category: 'Current Cost', value: 1500000 },\n          { category: 'Optimized Cost', value: 1225000 },\n          { category: 'Savings', value: 275000 }\n        ]\n      },\n      relatedInsights: ['insight_002', 'insight_005'],\n      createdAt: new Date().toISOString(),\n      updatedAt: new Date().toISOString(),\n      expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),\n      status: 'new',\n      aiModel: 'Claude-3.5-Sonnet',\n      version: '1.0'\n    },\n    {\n      id: 'insight_002',\n      type: 'risk',\n      priority: 'critical',\n      title: 'Single Source Dependency Risk',\n      description: 'Critical risk identified: 3 essential components have single supplier dependency, creating potential supply chain vulnerability.',\n      summary: '65% of critical components sourced from single suppliers in Southeast Asia region.',\n      impact: {\n        financial: 150000,\n        operational: 'Potential 2-week production halt risk',\n        timeline: 'Immediate action required',\n        probability: 73\n      },\n      confidence: 88,\n      dataPoints: 89,\n      sources: ['Supplier Database', 'Risk Assessment Report', 'Geographic Analysis'],\n      category: 'Supply Chain Risk',\n      subcategory: 'Dependency Risk',\n      tags: ['single-source', 'critical-components', 'geographic-risk'],\n      actions: {\n        primary: {\n          id: 'diversify_suppliers',\n          label: 'Diversify Supplier Base',\n          description: 'Identify and qualify alternative suppliers',\n          icon: ShieldCheck,\n          action: 'diversify_suppliers',\n          urgency: 'immediate',\n          estimatedEffort: 'high',\n          estimatedValue: 150000\n        },\n        secondary: [\n          {\n            id: 'risk_assessment',\n            label: 'Detailed Risk Assessment',\n            description: 'Comprehensive supply chain risk analysis',\n            icon: AlertTriangle,\n            action: 'risk_assessment',\n            urgency: 'immediate',\n            estimatedEffort: 'medium',\n            estimatedValue: 25000\n          },\n          {\n            id: 'contingency_plan',\n            label: 'Create Contingency Plan',\n            description: 'Develop emergency sourcing procedures',\n            icon: FileText,\n            action: 'contingency_plan',\n            urgency: 'this_week',\n            estimatedEffort: 'medium',\n            estimatedValue: 75000\n          }\n        ]\n      },\n      metrics: {\n        riskScore: {\n          current: 8.2,\n          target: 4.0,\n          trend: 'down',\n          unit: '/10',\n          formatted: '8.2/10 High Risk'\n        },\n        singleSourceItems: {\n          current: 3,\n          target: 0,\n          trend: 'stable',\n          unit: 'items',\n          formatted: '3 critical items'\n        },\n        geographicConcentration: {\n          current: 65,\n          target: 30,\n          trend: 'stable',\n          unit: '%',\n          formatted: '65% concentration'\n        }\n      },\n      visualization: {\n        type: 'gauge',\n        data: { value: 82, max: 100, zones: [{ min: 0, max: 40, color: 'green' }, { min: 40, max: 70, color: 'yellow' }, { min: 70, max: 100, color: 'red' }] }\n      },\n      relatedInsights: ['insight_001', 'insight_003'],\n      createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),\n      updatedAt: new Date().toISOString(),\n      status: 'new',\n      aiModel: 'Claude-3.5-Sonnet',\n      version: '1.0'\n    },\n    {\n      id: 'insight_003',\n      type: 'prediction',\n      priority: 'medium',\n      title: 'Price Increase Forecast',\n      description: 'AI predicts 12-15% price increase in semiconductor components over next 6 months based on market trends and supplier communications.',\n      summary: 'Global supply constraints and increased demand driving significant price pressures in electronics category.',\n      impact: {\n        financial: 89000,\n        operational: 'Budget planning adjustment needed',\n        timeline: '3-6 months',\n        probability: 79\n      },\n      confidence: 84,\n      dataPoints: 156,\n      sources: ['Market Intelligence', 'Supplier Communications', 'Industry Reports'],\n      category: 'Market Intelligence',\n      subcategory: 'Price Forecasting',\n      tags: ['price-increase', 'semiconductors', 'market-trends'],\n      actions: {\n        primary: {\n          id: 'strategic_buying',\n          label: 'Strategic Forward Buying',\n          description: 'Secure inventory before price increases',\n          icon: Package,\n          action: 'forward_buying',\n          urgency: 'this_month',\n          estimatedEffort: 'medium',\n          estimatedValue: 45000\n        },\n        secondary: [\n          {\n            id: 'contract_negotiation',\n            label: 'Negotiate Fixed Pricing',\n            description: 'Lock in current prices with suppliers',\n            icon: FileText,\n            action: 'negotiate_contracts',\n            urgency: 'this_week',\n            estimatedEffort: 'high',\n            estimatedValue: 89000\n          },\n          {\n            id: 'alternative_suppliers',\n            label: 'Find Alternative Suppliers',\n            description: 'Source competitive alternatives',\n            icon: Building2,\n            action: 'find_alternatives',\n            urgency: 'this_month',\n            estimatedEffort: 'high',\n            estimatedValue: 35000\n          }\n        ]\n      },\n      metrics: {\n        predictedIncrease: {\n          current: 13.5,\n          trend: 'up',\n          unit: '%',\n          formatted: '13.5% increase'\n        },\n        timelineMonths: {\n          current: 4.5,\n          trend: 'stable',\n          unit: 'months',\n          formatted: '4.5 months'\n        },\n        affectedSpend: {\n          current: 680000,\n          trend: 'up',\n          unit: 'USD',\n          formatted: '$680K annual spend'\n        }\n      },\n      visualization: {\n        type: 'chart',\n        data: [\n          { month: 'Current', price: 100 },\n          { month: 'Month 1', price: 102 },\n          { month: 'Month 2', price: 105 },\n          { month: 'Month 3', price: 108 },\n          { month: 'Month 4', price: 112 },\n          { month: 'Month 5', price: 115 }\n        ]\n      },\n      relatedInsights: ['insight_002', 'insight_004'],\n      createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(),\n      updatedAt: new Date().toISOString(),\n      status: 'viewed',\n      aiModel: 'Claude-3.5-Sonnet',\n      version: '1.0'\n    }\n  ]\n\n  // Use provided insights or mock data\n  const workingInsights = insights.length > 0 ? insights : mockInsights\n\n  // Filter insights based on filterBy prop\n  const filteredInsights = useMemo(() => {\n    let filtered = workingInsights\n\n    if (filterBy?.type && filterBy.type.length > 0) {\n      filtered = filtered.filter(insight => filterBy.type!.includes(insight.type))\n    }\n\n    if (filterBy?.priority && filterBy.priority.length > 0) {\n      filtered = filtered.filter(insight => filterBy.priority!.includes(insight.priority))\n    }\n\n    if (filterBy?.category && filterBy.category.length > 0) {\n      filtered = filtered.filter(insight => filterBy.category!.includes(insight.category))\n    }\n\n    return filtered\n  }, [workingInsights, filterBy])\n\n  // Sort insights\n  const sortedInsights = useMemo(() => {\n    return [...filteredInsights].sort((a, b) => {\n      switch (sortBy) {\n        case 'priority':\n          const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 }\n          return priorityOrder[a.priority] - priorityOrder[b.priority]\n        case 'confidence':\n          return b.confidence - a.confidence\n        case 'impact':\n          return b.impact.financial - a.impact.financial\n        case 'date':\n          return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n        default:\n          return 0\n      }\n    })\n  }, [filteredInsights, sortBy])\n\n  // Apply max cards limit\n  const displayInsights = maxCards ? sortedInsights.slice(0, maxCards) : sortedInsights\n\n  // Get insight type icon and color\n  const getInsightTypeIcon = (type: AIInsight['type']) => {\n    switch (type) {\n      case 'opportunity':\n        return { icon: Lightbulb, color: 'from-green-500 to-emerald-600' }\n      case 'risk':\n        return { icon: AlertTriangle, color: 'from-red-500 to-rose-600' }\n      case 'trend':\n        return { icon: TrendingUp, color: 'from-blue-500 to-indigo-600' }\n      case 'anomaly':\n        return { icon: Activity, color: 'from-yellow-500 to-amber-600' }\n      case 'prediction':\n        return { icon: Brain, color: 'from-purple-500 to-violet-600' }\n      case 'recommendation':\n        return { icon: Target, color: 'from-indigo-500 to-blue-600' }\n      default:\n        return { icon: Info, color: 'from-gray-500 to-slate-600' }\n    }\n  }\n\n  // Get priority color\n  const getPriorityColor = (priority: AIInsight['priority']) => {\n    switch (priority) {\n      case 'critical':\n        return 'bg-red-100 text-red-800 border-red-300'\n      case 'high':\n        return 'bg-orange-100 text-orange-800 border-orange-300'\n      case 'medium':\n        return 'bg-yellow-100 text-yellow-800 border-yellow-300'\n      case 'low':\n        return 'bg-green-100 text-green-800 border-green-300'\n      default:\n        return 'bg-gray-100 text-gray-800 border-gray-300'\n    }\n  }\n\n  // Handle insight action\n  const handleInsightAction = (insight: AIInsight, action: ActionItem) => {\n    onInsightAction?.(insight.id, action)\n\n    // Update insight status to actioned\n    onInsightStatusChange?.(insight.id, 'actioned')\n  }\n\n  // Handle insight status change\n  const handleStatusChange = (insightId: string, status: AIInsight['status']) => {\n    onInsightStatusChange?.(insightId, status)\n  }\n\n  // Format financial impact\n  const formatFinancialImpact = (amount: number): string => {\n    if (amount >= 1000000) {\n      return `$${(amount / 1000000).toFixed(1)}M`\n    } else if (amount >= 1000) {\n      return `$${(amount / 1000).toFixed(0)}K`\n    } else {\n      return `$${amount.toLocaleString()}`\n    }\n  }\n\n  // Refresh insights\n  const handleRefresh = async () => {\n    setLoading(true)\n    try {\n      await onRefresh?.()\n      // Simulate loading delay\n      await new Promise(resolve => setTimeout(resolve, 1000))\n    } catch (err) {\n      setError(\"Failed to refresh insights. Please try again.\")\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <TooltipProvider>\n      <div className=\"space-y-6\">\n        {/* Header with Controls */}\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n          <div>\n            <h2 className=\"text-2xl font-bold text-gray-900 flex items-center gap-2\">\n              <Sparkles className=\"h-6 w-6 text-purple-600\" />\n              AI Insights\n            </h2>\n            <p className=\"text-gray-600\">\n              {displayInsights.length} insights • Updated {new Date().toLocaleTimeString()}\n            </p>\n          </div>\n\n          <div className=\"flex items-center gap-2\">\n            {/* Sort Dropdown */}\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"outline\" size=\"sm\" className=\"flex items-center gap-2\">\n                  <Filter className=\"h-4 w-4\" />\n                  Sort by {sortBy}\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent>\n                <DropdownMenuLabel>Sort Options</DropdownMenuLabel>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem onClick={() => setSortBy('priority')}>\n                  <AlertTriangle className=\"h-4 w-4 mr-2\" />\n                  Priority\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => setSortBy('confidence')}>\n                  <Star className=\"h-4 w-4 mr-2\" />\n                  Confidence\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => setSortBy('impact')}>\n                  <DollarSign className=\"h-4 w-4 mr-2\" />\n                  Financial Impact\n                </DropdownMenuItem>\n                <DropdownMenuItem onClick={() => setSortBy('date')}>\n                  <Clock className=\"h-4 w-4 mr-2\" />\n                  Date Created\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n\n            {/* Refresh Button */}\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handleRefresh}\n              disabled={loading}\n              className=\"flex items-center gap-2\"\n            >\n              <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />\n              {loading ? 'Loading...' : 'Refresh'}\n            </Button>\n          </div>\n        </div>\n\n        {/* Error Alert */}\n        {error && (\n          <Alert className=\"border-red-200 bg-red-50\">\n            <AlertTriangle className=\"h-4 w-4 text-red-600\" />\n            <AlertDescription className=\"text-red-800\">\n              <div className=\"font-semibold mb-1\">Error</div>\n              <div>{error}</div>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"mt-2\"\n                onClick={() => setError(null)}\n              >\n                Dismiss\n              </Button>\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {/* Insights Grid */}\n        <div className={`grid gap-6 ${\n          compactMode\n            ? 'grid-cols-1 lg:grid-cols-2'\n            : 'grid-cols-1 lg:grid-cols-2 xl:grid-cols-3'\n        }`}>\n          <AnimatePresence>\n            {displayInsights.map((insight, index) => {\n              const { icon: TypeIcon, color } = getInsightTypeIcon(insight.type)\n\n              return (\n                <motion.div\n                  key={insight.id}\n                  initial={{ opacity: 0, y: 20 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  exit={{ opacity: 0, y: -20 }}\n                  transition={{ delay: index * 0.05 }}\n                  className=\"group\"\n                >\n                  <Card className={`border-0 shadow-lg hover:shadow-xl transition-all duration-300 ${\n                    insight.priority === 'critical' ? 'ring-2 ring-red-200' : ''\n                  }`}>\n                    <CardHeader className=\"pb-3\">\n                      <div className=\"flex items-start justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className={`p-3 rounded-xl bg-gradient-to-r ${color} text-white shadow-lg`}>\n                            <TypeIcon className=\"h-5 w-5\" />\n                          </div>\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <Badge\n                                variant=\"outline\"\n                                className={`text-xs font-medium ${getPriorityColor(insight.priority)}`}\n                              >\n                                {insight.priority.toUpperCase()}\n                              </Badge>\n                              <Badge variant=\"secondary\" className=\"text-xs\">\n                                {insight.confidence}% confident\n                              </Badge>\n                            </div>\n                            <CardTitle className=\"text-lg leading-tight\">\n                              {insight.title}\n                            </CardTitle>\n                          </div>\n                        </div>\n\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <Button variant=\"ghost\" size=\"sm\" className=\"opacity-0 group-hover:opacity-100 transition-opacity\">\n                              <MoreHorizontal className=\"h-4 w-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuItem onClick={() => handleStatusChange(insight.id, 'bookmarked')}>\n                              <Bookmark className=\"h-4 w-4 mr-2\" />\n                              Bookmark\n                            </DropdownMenuItem>\n                            <DropdownMenuItem>\n                              <Share className=\"h-4 w-4 mr-2\" />\n                              Share\n                            </DropdownMenuItem>\n                            <DropdownMenuItem>\n                              <Download className=\"h-4 w-4 mr-2\" />\n                              Export\n                            </DropdownMenuItem>\n                            <DropdownMenuSeparator />\n                            <DropdownMenuItem onClick={() => handleStatusChange(insight.id, 'dismissed')}>\n                              <X className=\"h-4 w-4 mr-2\" />\n                              Dismiss\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </div>\n                    </CardHeader>\n\n                    <CardContent className=\"space-y-4\">\n                      {/* Description */}\n                      <p className=\"text-sm text-gray-700 leading-relaxed\">\n                        {insight.summary}\n                      </p>\n\n                      {/* Key Metrics */}\n                      <div className=\"space-y-3\">\n                        {Object.entries(insight.metrics).slice(0, 2).map(([key, metric]) => (\n                          <div key={key} className=\"flex items-center justify-between\">\n                            <span className=\"text-sm text-gray-600 capitalize\">\n                              {key.replace(/([A-Z])/g, ' $1').trim()}\n                            </span>\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"font-medium text-sm\">\n                                {metric.formatted || `${metric.current}${metric.unit}`}\n                              </span>\n                              {metric.trend === 'up' && <ArrowUp className=\"h-3 w-3 text-green-500\" />}\n                              {metric.trend === 'down' && <ArrowDown className=\"h-3 w-3 text-red-500\" />}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n\n                      {/* Impact Summary */}\n                      <div className=\"p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg\">\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <span className=\"text-sm font-medium text-blue-800\">Impact</span>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {insight.impact.probability}% likely\n                          </Badge>\n                        </div>\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-sm\">\n                            <span className=\"text-blue-700\">Financial</span>\n                            <span className=\"font-bold text-blue-900\">\n                              {formatFinancialImpact(insight.impact.financial)}\n                            </span>\n                          </div>\n                          <div className=\"flex justify-between text-sm\">\n                            <span className=\"text-blue-700\">Timeline</span>\n                            <span className=\"font-medium text-blue-800\">\n                              {insight.impact.timeline}\n                            </span>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Confidence Progress */}\n                      <div className=\"space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"text-gray-600\">AI Confidence</span>\n                          <span className=\"font-medium\">{insight.confidence}%</span>\n                        </div>\n                        <Progress value={insight.confidence} className=\"h-2\" />\n                        <div className=\"flex justify-between text-xs text-gray-500\">\n                          <span>{insight.dataPoints} data points</span>\n                          <span>{insight.sources.length} sources</span>\n                        </div>\n                      </div>\n\n                      {/* Tags */}\n                      <div className=\"flex flex-wrap gap-1\">\n                        {insight.tags.slice(0, 3).map((tag, i) => (\n                          <Badge key={i} variant=\"outline\" className=\"text-xs\">\n                            {tag}\n                          </Badge>\n                        ))}\n                        {insight.tags.length > 3 && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            +{insight.tags.length - 3}\n                          </Badge>\n                        )}\n                      </div>\n\n                      {/* Action Buttons */}\n                      <div className=\"flex flex-col gap-2 pt-2\">\n                        <Button\n                          onClick={() => handleInsightAction(insight, insight.actions.primary)}\n                          className={`w-full bg-gradient-to-r ${color} hover:opacity-90 text-white`}\n                        >\n                          {React.createElement(insight.actions.primary.icon, { className: \"h-4 w-4 mr-2\" })}\n                          {insight.actions.primary.label}\n                        </Button>\n\n                        {insight.actions.secondary.length > 0 && (\n                          <div className=\"flex gap-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => handleInsightAction(insight, insight.actions.secondary[0])}\n                              className=\"flex-1\"\n                            >\n                              {React.createElement(insight.actions.secondary[0].icon, { className: \"h-3 w-3 mr-1\" })}\n                              {insight.actions.secondary[0].label}\n                            </Button>\n                            {insight.actions.secondary.length > 1 && (\n                              <DropdownMenu>\n                                <DropdownMenuTrigger asChild>\n                                  <Button variant=\"outline\" size=\"sm\">\n                                    <Plus className=\"h-3 w-3\" />\n                                  </Button>\n                                </DropdownMenuTrigger>\n                                <DropdownMenuContent>\n                                  {insight.actions.secondary.slice(1).map((action) => (\n                                    <DropdownMenuItem\n                                      key={action.id}\n                                      onClick={() => handleInsightAction(insight, action)}\n                                    >\n                                      {React.createElement(action.icon, { className: \"h-4 w-4 mr-2\" })}\n                                      {action.label}\n                                    </DropdownMenuItem>\n                                  ))}\n                                </DropdownMenuContent>\n                              </DropdownMenu>\n                            )}\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Footer */}\n                      <div className=\"flex items-center justify-between text-xs text-gray-500 pt-2 border-t\">\n                        <div className=\"flex items-center gap-2\">\n                          <Brain className=\"h-3 w-3\" />\n                          <span>{insight.aiModel}</span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Clock className=\"h-3 w-3\" />\n                          <span>{new Date(insight.createdAt).toLocaleDateString()}</span>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </motion.div>\n              );\n            })}\n          </AnimatePresence>\n        </div>\n\n        {/* Empty State */}\n        {displayInsights.length === 0 && (\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"text-center py-12\"\n          >\n            <div className=\"mx-auto w-24 h-24 bg-gradient-to-r from-purple-100 to-indigo-100 rounded-full flex items-center justify-center mb-4\">\n              <Sparkles className=\"h-12 w-12 text-purple-600\" />\n            </div>\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">No Insights Available</h3>\n            <p className=\"text-gray-600 mb-4\">\n              {loading ? 'Loading AI insights...' : 'No insights match your current filters.'}\n            </p>\n            {!loading && (\n              <Button onClick={handleRefresh} className=\"bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700\">\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\n                Refresh Insights\n              </Button>\n            )}\n          </motion.div>\n        )}\n      </div>\n    </TooltipProvider>\n  );\n}\n\nexport default AIInsightCards","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\MobileAIInterface.tsx","messages":[{"ruleId":"react/no-unknown-property","severity":2,"message":"Unknown property 'jsx' found","line":366,"column":14,"nodeType":"JSXAttribute","messageId":"unknownProp","endLine":366,"endColumn":17},{"ruleId":"react/no-unknown-property","severity":2,"message":"Unknown property 'global' found","line":366,"column":18,"nodeType":"JSXAttribute","messageId":"unknownProp","endLine":366,"endColumn":24}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useEffect } from \"react\"\r\nimport { motion, AnimatePresence } from \"framer-motion\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Sheet, SheetContent, SheetDescription, SheetHeader, SheetTitle, SheetTrigger } from \"@/components/ui/sheet\"\r\nimport {\r\n  Brain,\r\n  MessageSquare,\r\n  BarChart3,\r\n  Building2,\r\n  Sparkles,\r\n  TrendingUp,\r\n  DollarSign,\r\n  AlertTriangle,\r\n  Menu,\r\n  X,\r\n  Maximize2,\r\n  Minimize2,\r\n  ChevronUp,\r\n  ChevronDown,\r\n  Activity,\r\n  Zap,\r\n  Target,\r\n  Search,\r\n  Filter\r\n} from \"lucide-react\"\r\nimport AIChatInterface from \"./ChatInterface\"\r\nimport AIInsightCards from \"./InsightCards\"\r\nimport PredictiveCharts from \"../analytics/PredictiveCharts\"\r\nimport dynamic from 'next/dynamic'\r\nconst AISupplierDiscovery = dynamic(\r\n  () => import('../suppliers/AISupplierDiscovery'),\r\n  {\r\n    loading: () => <div className=\"animate-pulse h-96 bg-gray-100 rounded-lg\" />,\r\n    ssr: false\r\n  }\r\n)\r\n\r\ninterface MobileAIInterfaceProps {\r\n  compactMode?: boolean\r\n  enableSwipeGestures?: boolean\r\n}\r\n\r\nconst MobileAIInterface: React.FC<MobileAIInterfaceProps> = ({\r\n  compactMode = false,\r\n  enableSwipeGestures = true\r\n}) => {\r\n  const [activeSection, setActiveSection] = useState<'chat' | 'insights' | 'charts' | 'discovery'>('chat')\r\n  const [isExpanded, setIsExpanded] = useState(false)\r\n  const [showQuickActions, setShowQuickActions] = useState(false)\r\n  const [touchStartX, setTouchStartX] = useState(0)\r\n  const [touchStartY, setTouchStartY] = useState(0)\r\n\r\n  // Touch gesture handling for mobile swipe navigation\r\n  const handleTouchStart = (e: React.TouchEvent) => {\r\n    setTouchStartX(e.touches[0].clientX)\r\n    setTouchStartY(e.touches[0].clientY)\r\n  }\r\n\r\n  const handleTouchEnd = (e: React.TouchEvent) => {\r\n    if (!enableSwipeGestures) return\r\n\r\n    const touchEndX = e.changedTouches[0].clientX\r\n    const touchEndY = e.changedTouches[0].clientY\r\n    const deltaX = touchEndX - touchStartX\r\n    const deltaY = touchEndY - touchStartY\r\n\r\n    // Only process horizontal swipes (ignore vertical scrolling)\r\n    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {\r\n      const sections = ['chat', 'insights', 'charts', 'discovery'] as const\r\n      const currentIndex = sections.indexOf(activeSection)\r\n\r\n      if (deltaX > 0 && currentIndex > 0) {\r\n        // Swipe right - go to previous section\r\n        setActiveSection(sections[currentIndex - 1])\r\n      } else if (deltaX < 0 && currentIndex < sections.length - 1) {\r\n        // Swipe left - go to next section\r\n        setActiveSection(sections[currentIndex + 1])\r\n      }\r\n    }\r\n  }\r\n\r\n  // Quick action items for mobile\r\n  const quickActions = [\r\n    {\r\n      id: 'ask_ai',\r\n      label: 'Ask AI',\r\n      icon: Brain,\r\n      color: 'bg-purple-500',\r\n      action: () => setActiveSection('chat')\r\n    },\r\n    {\r\n      id: 'view_insights',\r\n      label: 'Insights',\r\n      icon: Sparkles,\r\n      color: 'bg-green-500',\r\n      action: () => setActiveSection('insights')\r\n    },\r\n    {\r\n      id: 'predictions',\r\n      label: 'Forecasts',\r\n      icon: TrendingUp,\r\n      color: 'bg-blue-500',\r\n      action: () => setActiveSection('charts')\r\n    },\r\n    {\r\n      id: 'find_suppliers',\r\n      label: 'Find Suppliers',\r\n      icon: Building2,\r\n      color: 'bg-orange-500',\r\n      action: () => setActiveSection('discovery')\r\n    }\r\n  ]\r\n\r\n  // Section navigation tabs\r\n  const navigationTabs = [\r\n    {\r\n      id: 'chat' as const,\r\n      label: 'AI Chat',\r\n      icon: MessageSquare,\r\n      color: 'text-purple-600',\r\n      activeColor: 'bg-purple-500 text-white'\r\n    },\r\n    {\r\n      id: 'insights' as const,\r\n      label: 'Insights',\r\n      icon: Sparkles,\r\n      color: 'text-green-600',\r\n      activeColor: 'bg-green-500 text-white'\r\n    },\r\n    {\r\n      id: 'charts' as const,\r\n      label: 'Charts',\r\n      icon: BarChart3,\r\n      color: 'text-blue-600',\r\n      activeColor: 'bg-blue-500 text-white'\r\n    },\r\n    {\r\n      id: 'discovery' as const,\r\n      label: 'Discovery',\r\n      icon: Building2,\r\n      color: 'text-orange-600',\r\n      activeColor: 'bg-orange-500 text-white'\r\n    }\r\n  ]\r\n\r\n  return (\r\n    <div className=\"h-screen flex flex-col bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100 relative\">\r\n      {/* Mobile Header */}\r\n      <div className=\"bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm sticky top-0 z-40\">\r\n        <div className=\"px-4 py-3\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <motion.div\r\n                animate={{ rotate: [0, 360] }}\r\n                transition={{ duration: 20, repeat: Infinity, ease: \"linear\" }}\r\n                className=\"p-2 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl text-white\"\r\n              >\r\n                <Brain className=\"h-5 w-5\" />\r\n              </motion.div>\r\n              <div>\r\n                <h1 className=\"text-lg font-bold text-gray-900\">AI Assistant</h1>\r\n                <p className=\"text-xs text-gray-600\">Procurement Intelligence</p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-2\">\r\n              <Badge variant=\"outline\" className=\"bg-green-100 text-green-800 border-green-300 text-xs\">\r\n                <Activity className=\"h-3 w-3 mr-1\" />\r\n                Live\r\n              </Badge>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setIsExpanded(!isExpanded)}\r\n                className=\"md:hidden\"\r\n                aria-label={isExpanded ? \"Minimize interface\" : \"Expand interface\"}\r\n              >\r\n                {isExpanded ? <Minimize2 className=\"h-4 w-4\" /> : <Maximize2 className=\"h-4 w-4\" />}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Mobile Navigation Tabs */}\r\n        <div className=\"px-2 pb-2\">\r\n          <div className=\"flex bg-gray-100 rounded-lg p-1 gap-1\">\r\n            {navigationTabs.map((tab) => {\r\n              const Icon = tab.icon\r\n              const isActive = activeSection === tab.id\r\n\r\n              return (\r\n                <button\r\n                  key={tab.id}\r\n                  onClick={() => setActiveSection(tab.id)}\r\n                  className={`flex-1 flex flex-col items-center gap-1 py-2 px-1 rounded-md transition-all duration-200 ${\r\n                    isActive ? tab.activeColor : 'text-gray-600 hover:bg-white/50'\r\n                  }`}\r\n                  aria-label={`Switch to ${tab.label}`}\r\n                  role=\"tab\"\r\n                  aria-selected={isActive}\r\n                >\r\n                  <Icon className=\"h-4 w-4\" />\r\n                  <span className=\"text-xs font-medium\">{tab.label}</span>\r\n                </button>\r\n              )\r\n            })}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main Content Area */}\r\n      <div\r\n        className=\"flex-1 overflow-hidden\"\r\n        onTouchStart={handleTouchStart}\r\n        onTouchEnd={handleTouchEnd}\r\n      >\r\n        <AnimatePresence mode=\"wait\">\r\n          <motion.div\r\n            key={activeSection}\r\n            initial={{ opacity: 0, x: 50 }}\r\n            animate={{ opacity: 1, x: 0 }}\r\n            exit={{ opacity: 0, x: -50 }}\r\n            transition={{ duration: 0.2 }}\r\n            className=\"h-full\"\r\n          >\r\n            {activeSection === 'chat' && (\r\n              <div className=\"h-full p-4\">\r\n                <AIChatInterface\r\n                  compactMode={compactMode}\r\n                  enableVoice={true}\r\n                  enableFileUpload={false} // Disabled for mobile\r\n                  onActionTrigger={(action) => {\r\n                    console.log('Mobile chat action:', action)\r\n                    // Handle navigation to other sections based on chat actions\r\n                    if (action.action === 'view_insights') setActiveSection('insights')\r\n                    if (action.action === 'view_charts') setActiveSection('charts')\r\n                    if (action.action === 'find_suppliers') setActiveSection('discovery')\r\n                  }}\r\n                />\r\n              </div>\r\n            )}\r\n\r\n            {activeSection === 'insights' && (\r\n              <div className=\"h-full p-4 overflow-y-auto\">\r\n                <AIInsightCards\r\n                  compactMode={true}\r\n                  maxCards={compactMode ? 3 : 6}\r\n                  onInsightAction={(insightId, action) => {\r\n                    console.log('Mobile insight action:', insightId, action)\r\n                  }}\r\n                  onInsightStatusChange={(id, status) => {\r\n                    console.log('Mobile insight status:', id, status)\r\n                  }}\r\n                />\r\n              </div>\r\n            )}\r\n\r\n            {activeSection === 'charts' && (\r\n              <div className=\"h-full p-4 overflow-y-auto\">\r\n                <PredictiveCharts\r\n                  compactMode={true}\r\n                  onChartSelect={(chartId) => console.log('Mobile chart selected:', chartId)}\r\n                  onAnomalyClick={(anomaly) => console.log('Mobile anomaly clicked:', anomaly)}\r\n                  realTimeUpdate={true}\r\n                />\r\n              </div>\r\n            )}\r\n\r\n            {activeSection === 'discovery' && (\r\n              <div className=\"h-full p-4 overflow-y-auto\">\r\n                <AISupplierDiscovery\r\n                  compactMode={true}\r\n                  onSupplierSelect={(supplier) => {\r\n                    console.log('Mobile supplier selected:', supplier)\r\n                  }}\r\n                  onSupplierBookmark={(id) => {\r\n                    console.log('Mobile supplier bookmarked:', id)\r\n                  }}\r\n                />\r\n              </div>\r\n            )}\r\n          </motion.div>\r\n        </AnimatePresence>\r\n      </div>\r\n\r\n      {/* Floating Quick Actions Button */}\r\n      <div className=\"fixed bottom-6 right-6 z-50\">\r\n        <AnimatePresence>\r\n          {showQuickActions && (\r\n            <motion.div\r\n              initial={{ opacity: 0, scale: 0.8, y: 20 }}\r\n              animate={{ opacity: 1, scale: 1, y: 0 }}\r\n              exit={{ opacity: 0, scale: 0.8, y: 20 }}\r\n              className=\"absolute bottom-16 right-0 space-y-3\"\r\n            >\r\n              {quickActions.map((action, index) => {\r\n                const Icon = action.icon\r\n                return (\r\n                  <motion.button\r\n                    key={action.id}\r\n                    initial={{ opacity: 0, x: 50 }}\r\n                    animate={{ opacity: 1, x: 0 }}\r\n                    exit={{ opacity: 0, x: 50 }}\r\n                    transition={{ delay: index * 0.1 }}\r\n                    onClick={() => {\r\n                      action.action()\r\n                      setShowQuickActions(false)\r\n                    }}\r\n                    className={`flex items-center gap-3 px-4 py-3 ${action.color} text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200`}\r\n                    aria-label={action.label}\r\n                  >\r\n                    <Icon className=\"h-5 w-5\" />\r\n                    <span className=\"text-sm font-medium whitespace-nowrap\">\r\n                      {action.label}\r\n                    </span>\r\n                  </motion.button>\r\n                )\r\n              })}\r\n            </motion.div>\r\n          )}\r\n        </AnimatePresence>\r\n\r\n        <Button\r\n          onClick={() => setShowQuickActions(!showQuickActions)}\r\n          className=\"w-14 h-14 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg hover:shadow-xl transition-all duration-200\"\r\n          aria-label=\"Quick actions menu\"\r\n        >\r\n          <motion.div\r\n            animate={{ rotate: showQuickActions ? 45 : 0 }}\r\n            transition={{ duration: 0.2 }}\r\n          >\r\n            {showQuickActions ? <X className=\"h-6 w-6\" /> : <Zap className=\"h-6 w-6\" />}\r\n          </motion.div>\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Mobile Gesture Indicators */}\r\n      {enableSwipeGestures && (\r\n        <div className=\"fixed bottom-20 left-1/2 transform -translate-x-1/2 z-30\">\r\n          <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            className=\"bg-black/50 text-white px-3 py-1 rounded-full text-xs backdrop-blur-sm\"\r\n          >\r\n            ← Swipe to navigate →\r\n          </motion.div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Accessibility Enhancements */}\r\n      <div className=\"sr-only\">\r\n        <div role=\"tabpanel\" aria-labelledby={`${activeSection}-tab`}>\r\n          Current section: {navigationTabs.find(t => t.id === activeSection)?.label}\r\n        </div>\r\n        <div aria-live=\"polite\" aria-atomic=\"true\">\r\n          {/* Screen reader announcements for section changes */}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Mobile-specific styles and interactions */}\r\n      <style jsx global>{`\r\n        /* Disable text selection on touch interfaces */\r\n        @media (hover: none) {\r\n          .mobile-ai-interface * {\r\n            -webkit-touch-callout: none;\r\n            -webkit-user-select: none;\r\n            -khtml-user-select: none;\r\n            -moz-user-select: none;\r\n            -ms-user-select: none;\r\n            user-select: none;\r\n          }\r\n\r\n          /* Enable selection for input fields */\r\n          .mobile-ai-interface input,\r\n          .mobile-ai-interface textarea {\r\n            -webkit-user-select: text;\r\n            -moz-user-select: text;\r\n            -ms-user-select: text;\r\n            user-select: text;\r\n          }\r\n        }\r\n\r\n        /* Smooth scrolling */\r\n        .mobile-ai-interface {\r\n          -webkit-overflow-scrolling: touch;\r\n          scroll-behavior: smooth;\r\n        }\r\n\r\n        /* Touch-friendly tap targets */\r\n        .mobile-ai-interface button,\r\n        .mobile-ai-interface [role=\"button\"] {\r\n          min-height: 44px;\r\n          min-width: 44px;\r\n        }\r\n\r\n        /* Reduce motion for accessibility */\r\n        @media (prefers-reduced-motion: reduce) {\r\n          .mobile-ai-interface * {\r\n            animation-duration: 0.01ms !important;\r\n            animation-iteration-count: 1 !important;\r\n            transition-duration: 0.01ms !important;\r\n          }\r\n        }\r\n      `}</style>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default MobileAIInterface","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\MobileAIInterfaceV5.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":70,"column":33,"nodeType":"Identifier","messageId":"undef","endLine":70,"endColumn":47}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n/**\r\n * Mobile AI Interface - Optimized for mobile devices\r\n *\r\n * Features:\r\n * - Compact chat interface\r\n * - Swipeable insights\r\n * - Quick actions\r\n * - Touch-optimized UI\r\n * - Bottom sheet design\r\n */\r\n\r\nimport React, { useState, useEffect, useRef } from 'react'\r\nimport { useChat } from 'ai/react'\r\nimport { motion, AnimatePresence, PanInfo } from 'framer-motion'\r\nimport { Card, CardContent } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Input } from '@/components/ui/input'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport {\r\n  Brain,\r\n  Send,\r\n  Mic,\r\n  X,\r\n  Sparkles,\r\n  User,\r\n  Bot,\r\n  ChevronDown,\r\n  ChevronUp,\r\n  Loader2,\r\n  TrendingUp,\r\n  AlertTriangle,\r\n  Lightbulb,\r\n  DollarSign,\r\n  MessageCircle,\r\n  Zap,\r\n} from 'lucide-react'\r\n\r\ninterface MobileAIInterfaceV5Props {\r\n  onClose?: () => void\r\n  apiEndpoint?: string\r\n  startMinimized?: boolean\r\n}\r\n\r\nconst MobileAIInterfaceV5: React.FC<MobileAIInterfaceV5Props> = ({\r\n  onClose,\r\n  apiEndpoint = '/api/ai/chat',\r\n  startMinimized = false,\r\n}) => {\r\n  // Vercel AI SDK v5 useChat hook\r\n  const {\r\n    messages,\r\n    input,\r\n    handleInputChange,\r\n    handleSubmit,\r\n    isLoading,\r\n  } = useChat({\r\n    api: apiEndpoint,\r\n  })\r\n\r\n  // State\r\n  const [isMinimized, setIsMinimized] = useState(startMinimized)\r\n  const [isListening, setIsListening] = useState(false)\r\n  const [insights, setInsights] = useState<any[]>([])\r\n  const [activeTab, setActiveTab] = useState<'chat' | 'insights'>('chat')\r\n\r\n  // Refs\r\n  const messagesEndRef = useRef<HTMLDivElement>(null)\r\n  const inputRef = useRef<HTMLInputElement>(null)\r\n\r\n  // Auto-scroll to bottom\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })\r\n  }, [messages])\r\n\r\n  // Load quick insights\r\n  useEffect(() => {\r\n    loadQuickInsights()\r\n  }, [])\r\n\r\n  const loadQuickInsights = async () => {\r\n    try {\r\n      const response = await fetch('/api/ai/insights/generate', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          context: { type: 'portfolio' },\r\n          focusAreas: ['cost', 'risk', 'performance'],\r\n          timeFrame: {\r\n            start: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),\r\n            end: new Date().toISOString(),\r\n          },\r\n          includeActions: false,\r\n        }),\r\n      })\r\n\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        if (data.success) {\r\n          setInsights((data.data.insights || []).slice(0, 3))\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load insights:', error)\r\n    }\r\n  }\r\n\r\n  // Handle drag to minimize\r\n  const handleDragEnd = (_event: any, info: PanInfo) => {\r\n    if (info.offset.y > 100) {\r\n      setIsMinimized(true)\r\n    } else if (info.offset.y < -100) {\r\n      setIsMinimized(false)\r\n    }\r\n  }\r\n\r\n  // Quick prompts for mobile\r\n  const quickActions = [\r\n    { id: 1, label: 'Supplier Analysis', icon: TrendingUp },\r\n    { id: 2, label: 'Cost Savings', icon: DollarSign },\r\n    { id: 3, label: 'Risk Check', icon: AlertTriangle },\r\n    { id: 4, label: 'New Ideas', icon: Lightbulb },\r\n  ]\r\n\r\n  // Get insight icon\r\n  const getInsightIcon = (type: string) => {\r\n    switch (type) {\r\n      case 'opportunity':\r\n        return <Lightbulb className=\"h-4 w-4 text-green-600\" />\r\n      case 'risk':\r\n        return <AlertTriangle className=\"h-4 w-4 text-red-600\" />\r\n      case 'trend':\r\n        return <TrendingUp className=\"h-4 w-4 text-blue-600\" />\r\n      default:\r\n        return <Sparkles className=\"h-4 w-4 text-purple-600\" />\r\n    }\r\n  }\r\n\r\n  return (\r\n    <AnimatePresence>\r\n      {!isMinimized && (\r\n        <motion.div\r\n          initial={{ y: '100%' }}\r\n          animate={{ y: 0 }}\r\n          exit={{ y: '100%' }}\r\n          drag=\"y\"\r\n          dragConstraints={{ top: 0, bottom: 0 }}\r\n          dragElastic={0.2}\r\n          onDragEnd={handleDragEnd}\r\n          className=\"fixed inset-x-0 bottom-0 z-50 h-[85vh] bg-white dark:bg-gray-900 rounded-t-3xl shadow-2xl flex flex-col\"\r\n        >\r\n          {/* Drag Handle */}\r\n          <div className=\"flex items-center justify-center py-2 border-b border-gray-200 dark:border-gray-700\">\r\n            <div className=\"w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full\" />\r\n          </div>\r\n\r\n          {/* Header */}\r\n          <div className=\"flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-purple-600 to-indigo-600 text-white\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Brain className=\"h-5 w-5\" />\r\n              <span className=\"font-semibold\">AI Assistant</span>\r\n              {isLoading && (\r\n                <Badge variant=\"secondary\" className=\"text-xs bg-white/20 text-white border-white/30\">\r\n                  <Loader2 className=\"h-3 w-3 mr-1 animate-spin\" />\r\n                  Thinking\r\n                </Badge>\r\n              )}\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={() => setIsMinimized(true)}\r\n                className=\"h-8 w-8 p-0 text-white hover:bg-white/20\"\r\n                aria-label=\"Minimize\"\r\n              >\r\n                <ChevronDown className=\"h-5 w-5\" />\r\n              </Button>\r\n              {onClose && (\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={onClose}\r\n                  className=\"h-8 w-8 p-0 text-white hover:bg-white/20\"\r\n                  aria-label=\"Close\"\r\n                >\r\n                  <X className=\"h-5 w-5\" />\r\n                </Button>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Tabs */}\r\n          <div className=\"flex border-b border-gray-200 dark:border-gray-700\">\r\n            <button\r\n              onClick={() => setActiveTab('chat')}\r\n              className={`flex-1 px-4 py-3 text-sm font-medium transition-colors ${\r\n                activeTab === 'chat'\r\n                  ? 'text-purple-600 dark:text-purple-400 border-b-2 border-purple-600 dark:border-purple-400'\r\n                  : 'text-gray-500 dark:text-gray-400'\r\n              }`}\r\n            >\r\n              <MessageCircle className=\"h-4 w-4 inline mr-2\" />\r\n              Chat\r\n            </button>\r\n            <button\r\n              onClick={() => setActiveTab('insights')}\r\n              className={`flex-1 px-4 py-3 text-sm font-medium transition-colors ${\r\n                activeTab === 'insights'\r\n                  ? 'text-purple-600 dark:text-purple-400 border-b-2 border-purple-600 dark:border-purple-400'\r\n                  : 'text-gray-500 dark:text-gray-400'\r\n              }`}\r\n            >\r\n              <Zap className=\"h-4 w-4 inline mr-2\" />\r\n              Insights\r\n            </button>\r\n          </div>\r\n\r\n          {/* Content */}\r\n          <div className=\"flex-1 overflow-hidden\">\r\n            {activeTab === 'chat' ? (\r\n              <div className=\"flex flex-col h-full\">\r\n                {/* Messages */}\r\n                <ScrollArea className=\"flex-1 px-4 py-3\">\r\n                  <div className=\"space-y-3\">\r\n                    {messages.length === 0 && (\r\n                      <div className=\"text-center py-8\">\r\n                        <Brain className=\"h-12 w-12 text-purple-600 dark:text-purple-400 mx-auto mb-3\" />\r\n                        <p className=\"text-sm text-gray-600 dark:text-gray-400\">\r\n                          Hi! Ask me anything about procurement.\r\n                        </p>\r\n                      </div>\r\n                    )}\r\n\r\n                    {messages.map((message, index) => (\r\n                      <motion.div\r\n                        key={message.id}\r\n                        initial={{ opacity: 0, y: 10 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        transition={{ delay: index * 0.05 }}\r\n                        className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}\r\n                      >\r\n                        <div\r\n                          className={`max-w-[80%] px-4 py-2 rounded-2xl ${\r\n                            message.role === 'user'\r\n                              ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-tr-sm'\r\n                              : 'bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white rounded-tl-sm'\r\n                          }`}\r\n                        >\r\n                          <div className=\"text-sm leading-relaxed whitespace-pre-wrap\">\r\n                            {message.content}\r\n                          </div>\r\n                          <div className=\"text-xs opacity-70 mt-1\">\r\n                            {new Date(message.createdAt || Date.now()).toLocaleTimeString([], {\r\n                              hour: '2-digit',\r\n                              minute: '2-digit',\r\n                            })}\r\n                          </div>\r\n                        </div>\r\n                      </motion.div>\r\n                    ))}\r\n\r\n                    {isLoading && (\r\n                      <motion.div\r\n                        initial={{ opacity: 0 }}\r\n                        animate={{ opacity: 1 }}\r\n                        className=\"flex justify-start\"\r\n                      >\r\n                        <div className=\"bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded-2xl rounded-tl-sm\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <div className=\"flex gap-1\">\r\n                              {[0, 1, 2].map(i => (\r\n                                <motion.div\r\n                                  key={i}\r\n                                  animate={{ scale: [1, 1.2, 1] }}\r\n                                  transition={{ duration: 1, repeat: Infinity, delay: i * 0.2 }}\r\n                                  className=\"w-2 h-2 bg-purple-600 dark:bg-purple-400 rounded-full\"\r\n                                />\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </motion.div>\r\n                    )}\r\n\r\n                    <div ref={messagesEndRef} />\r\n                  </div>\r\n                </ScrollArea>\r\n\r\n                {/* Quick Actions */}\r\n                {messages.length === 0 && (\r\n                  <div className=\"px-4 py-2 border-t border-gray-200 dark:border-gray-700\">\r\n                    <div className=\"flex gap-2 overflow-x-auto pb-2\">\r\n                      {quickActions.map(action => (\r\n                        <Button\r\n                          key={action.id}\r\n                          variant=\"outline\"\r\n                          size=\"sm\"\r\n                          onClick={() => {\r\n                            handleInputChange({ target: { value: action.label } } as any)\r\n                            inputRef.current?.focus()\r\n                          }}\r\n                          className=\"flex-shrink-0 text-xs\"\r\n                        >\r\n                          <action.icon className=\"h-3 w-3 mr-1\" />\r\n                          {action.label}\r\n                        </Button>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Input */}\r\n                <div className=\"p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800\">\r\n                  <form onSubmit={handleSubmit} className=\"flex gap-2\">\r\n                    <Input\r\n                      ref={inputRef}\r\n                      value={input}\r\n                      onChange={handleInputChange}\r\n                      placeholder=\"Type your message...\"\r\n                      disabled={isLoading}\r\n                      className=\"flex-1 text-sm dark:bg-gray-700 dark:border-gray-600\"\r\n                    />\r\n                    <Button\r\n                      type=\"submit\"\r\n                      disabled={!input.trim() || isLoading}\r\n                      className=\"bg-gradient-to-r from-purple-600 to-indigo-600\"\r\n                    >\r\n                      {isLoading ? (\r\n                        <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                      ) : (\r\n                        <Send className=\"h-4 w-4\" />\r\n                      )}\r\n                    </Button>\r\n                  </form>\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              // Insights Tab\r\n              (<ScrollArea className=\"h-full px-4 py-3\">\r\n                <div className=\"space-y-3\">\r\n                  {insights.length === 0 ? (\r\n                    <div className=\"text-center py-8\">\r\n                      <Sparkles className=\"h-12 w-12 text-purple-600 dark:text-purple-400 mx-auto mb-3\" />\r\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400\">\r\n                        No insights available\r\n                      </p>\r\n                    </div>\r\n                  ) : (\r\n                    insights.map((insight, index) => (\r\n                      <motion.div\r\n                        key={insight.id}\r\n                        initial={{ opacity: 0, x: -20 }}\r\n                        animate={{ opacity: 1, x: 0 }}\r\n                        transition={{ delay: index * 0.1 }}\r\n                      >\r\n                        <Card className=\"border-0 shadow-md\">\r\n                          <CardContent className=\"p-4\">\r\n                            <div className=\"flex items-start gap-3\">\r\n                              {getInsightIcon(insight.type)}\r\n                              <div className=\"flex-1 min-w-0\">\r\n                                <Badge\r\n                                  variant={insight.type === 'opportunity' ? 'default' : 'destructive'}\r\n                                  className=\"text-xs mb-2\"\r\n                                >\r\n                                  {insight.type.toUpperCase()}\r\n                                </Badge>\r\n                                <h4 className=\"font-semibold text-sm text-gray-900 dark:text-white mb-1\">\r\n                                  {insight.title}\r\n                                </h4>\r\n                                <p className=\"text-xs text-gray-600 dark:text-gray-400 line-clamp-2\">\r\n                                  {insight.summary}\r\n                                </p>\r\n                                {insight.impact?.financial > 0 && (\r\n                                  <div className=\"flex items-center gap-1 mt-2\">\r\n                                    <DollarSign className=\"h-3 w-3 text-blue-600\" />\r\n                                    <span className=\"text-xs font-medium text-blue-600\">\r\n                                      ${(insight.impact.financial / 1000).toFixed(0)}K\r\n                                    </span>\r\n                                  </div>\r\n                                )}\r\n                              </div>\r\n                            </div>\r\n                          </CardContent>\r\n                        </Card>\r\n                      </motion.div>\r\n                    ))\r\n                  )}\r\n                </div>\r\n              </ScrollArea>)\r\n            )}\r\n          </div>\r\n        </motion.div>\r\n      )}\r\n      {/* Minimized FAB */}\r\n      {isMinimized && (\r\n        <motion.button\r\n          initial={{ scale: 0 }}\r\n          animate={{ scale: 1 }}\r\n          exit={{ scale: 0 }}\r\n          onClick={() => setIsMinimized(false)}\r\n          className=\"fixed bottom-4 right-4 z-50 w-14 h-14 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center\"\r\n        >\r\n          <Brain className=\"h-6 w-6\" />\r\n          {isLoading && (\r\n            <span className=\"absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse\" />\r\n          )}\r\n        </motion.button>\r\n      )}\r\n    </AnimatePresence>\r\n  );\r\n}\r\n\r\nexport default MobileAIInterfaceV5\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\admin\\AIServiceConfiguration.tsx","messages":[{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":291,"column":83,"nodeType":"BlockStatement","messageId":"unexpected","endLine":291,"endColumn":85,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[12088,12088],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":293,"column":13,"nodeType":"BlockStatement","messageId":"unexpected","endLine":293,"endColumn":15,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[12113,12113],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":696,"column":80,"nodeType":"BlockStatement","messageId":"unexpected","endLine":696,"endColumn":82,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[30549,30549],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":770,"column":101,"nodeType":"BlockStatement","messageId":"unexpected","endLine":770,"endColumn":103,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[34504,34504],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState, useRef } from 'react';\r\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Switch } from '@/components/ui/switch';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Separator } from '@/components/ui/separator';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select';\r\nimport { Checkbox } from '@/components/ui/checkbox';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from '@/components/ui/dialog';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Settings, TestTube, Save, CheckCircle, XCircle, Loader2, Globe, Plus, Trash2 } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { getSupportedModels } from '@/lib/ai/model-utils';\r\nimport ProviderRegistryPanel from '@/components/ai/admin/providers/ProviderRegistryPanel';\r\nimport CustomServicesPanel from '@/components/ai/admin/providers/CustomServicesPanel';\r\nimport UnifiedServicePanel from '@/components/ai/admin/UnifiedServicePanel';\r\n\r\ninterface AIServiceConfig {\r\n  id: string;\r\n  service_type: 'demand_forecasting' | 'anomaly_detection' | 'supplier_scoring' | 'assistant' | 'supplier_discovery';\r\n  config: {\r\n    provider?: string;\r\n    model?: string;\r\n    apiKey?: string;\r\n    baseUrl?: string;\r\n    rateLimit?: number;\r\n    activeProvider?: 'openai' | 'anthropic' | 'openai_compatible';\r\n    enableMultipleProviders?: boolean;\r\n    providers?: {\r\n      openai?: { enabled?: boolean; apiKey?: string; baseUrl?: string; model?: string };\r\n      anthropic?: { enabled?: boolean; apiKey?: string; baseUrl?: string; model?: string };\r\n      openai_compatible?: { enabled?: boolean; apiKey?: string; baseUrl?: string; model?: string };\r\n    };\r\n    // Web Search API Keys\r\n    webSearch?: {\r\n      serperApiKey?: string;\r\n      tavilyApiKey?: string;\r\n      googleSearchApiKey?: string;\r\n      googleSearchEngineId?: string;\r\n      // Custom providers - dynamic key-value pairs\r\n      customProviders?: Record<string, {\r\n        apiKey: string;\r\n        apiUrl?: string;\r\n        model?: string;\r\n        description?: string;\r\n        enabled?: boolean;\r\n      }>;\r\n    };\r\n    [key: string]: any;\r\n  };\r\n  enabled: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nconst SERVICE_INFO = {\r\n  demand_forecasting: {\r\n    name: 'Demand Forecasting',\r\n    description: 'Predict future product demand using historical data',\r\n    icon: '📊',\r\n    providers: ['openai', 'anthropic', 'custom'],\r\n    defaultModel: 'gpt-4.1-mini',\r\n  },\r\n  anomaly_detection: {\r\n    name: 'Anomaly Detection',\r\n    description: 'Detect unusual patterns in sales and inventory',\r\n    icon: '🔍',\r\n    providers: ['openai', 'anthropic', 'custom'],\r\n    defaultModel: 'claude-3-haiku',\r\n  },\r\n  supplier_scoring: {\r\n    name: 'Supplier Scoring',\r\n    description: 'Evaluate supplier performance and reliability',\r\n    icon: '⭐',\r\n    providers: ['openai', 'anthropic', 'custom'],\r\n    defaultModel: 'gpt-4.1',\r\n  },\r\n  assistant: {\r\n    name: 'AI Assistant',\r\n    description: 'Conversational AI for business insights',\r\n    icon: '💬',\r\n    providers: ['openai', 'anthropic'],\r\n    defaultModel: 'claude-3-5-sonnet',\r\n  },\r\n  supplier_discovery: {\r\n    name: 'Supplier Discovery',\r\n    description: 'AI-powered web search and data extraction for supplier information',\r\n    icon: '🌐',\r\n    providers: ['openai', 'anthropic', 'openai_compatible'],\r\n    defaultModel: 'claude-3-5-sonnet',\r\n  },\r\n};\r\n\r\nconst MODEL_OPTIONS: Record<string, string[]> = {\r\n  openai: ['gpt-4.1', 'gpt-4.1-preview', 'gpt-4.1-mini', 'o1-preview', 'o1-mini', 'o3-mini'],\r\n  anthropic: ['claude-3-5-sonnet-20241022', 'claude-3-haiku-20240307', 'claude-3-opus-20240229'],\r\n  openai_compatible: ['gpt-4.1', 'gpt-4.1-mini', 'o1-preview', 'o1-mini', 'llama-3.1-70b-instruct', 'mistral-large-latest'],\r\n};\r\n\r\nconst dedupeModels = (list: string[] = []): string[] => Array.from(new Set(list.filter(Boolean)));\r\n\r\nconst OPENROUTER_FREE_MODELS = [\r\n  'deepseek/deepseek-chat',\r\n  'gryphe/mythomax-l2-13b',\r\n  'meta-llama/llama-3.1-8b-instruct',\r\n  'meta-llama/llama-3-8b-instruct',\r\n  'meta-llama/llama-3.1-70b-instruct',\r\n  'mistralai/mistral-7b-instruct',\r\n  'mistralai/mixtral-8x7b-instruct',\r\n  'nousresearch/hermes-3-llama-3.1-8b',\r\n  'openrouter/auto',\r\n  'qwen/qwen2.5-7b-instruct',\r\n  'qwen/qwen2.5-14b-instruct',\r\n  'qwen/qwen2-72b-instruct',\r\n  'google/gemma-2-9b-it',\r\n  'google/gemma-2-27b-it',\r\n]\r\n\r\nconst OPENROUTER_FREE_MODEL_SET = new Set(OPENROUTER_FREE_MODELS.map((item) => item.toLowerCase()))\r\n\r\nconst getOpenRouterFilterKey = (serviceType: string, providerId: string) => `${serviceType}:${providerId}:openrouterFreeOnly`\r\n\r\nconst isOpenRouterProvider = (providerId: string, section: any, rootConfig?: AIServiceConfig): boolean => {\r\n  const normalized = (providerId || '').toLowerCase()\r\n  if (normalized === 'openrouter') return true\r\n  if (normalized !== 'openai_compatible' && !normalized.includes('openrouter')) return false\r\n  const candidates = [\r\n    section?.baseUrl,\r\n    rootConfig?.config?.baseUrl,\r\n    rootConfig?.config?.providers?.[providerId]?.baseUrl,\r\n  ]\r\n  return candidates.some((value) => typeof value === 'string' && value.toLowerCase().includes('openrouter'))\r\n}\r\n\r\nconst filterOpenRouterModels = (models: string[], enabled: boolean): string[] => {\r\n  if (!enabled) return models\r\n  return models.filter((model) => {\r\n    const lower = model.toLowerCase()\r\n    if (lower.includes('free')) return true\r\n    return OPENROUTER_FREE_MODEL_SET.has(lower)\r\n  })\r\n}\r\n\r\nexport default function AIServiceConfiguration() {\r\n  const queryClient = useQueryClient();\r\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\r\n  const [createForm, setCreateForm] = useState<{ displayName: string; provider: 'openai' | 'anthropic' | 'openai_compatible'; baseUrl: string; apiKey: string; model: string }>({\r\n    displayName: '',\r\n    provider: 'openai',\r\n    baseUrl: '',\r\n    apiKey: '',\r\n    model: '',\r\n  });\r\n  // Org-wide provider presets\r\n  const { data: providerPresets = [] } = useQuery<{ id: string; name: string; provider_type: string; base_url?: string; default_model?: string }[]>({\r\n    queryKey: ['ai-provider-registry'],\r\n    queryFn: async () => {\r\n      try {\r\n        const res = await fetch('/api/v1/ai/providers');\r\n        const data = await res.json().catch(() => ({}));\r\n        return data?.data || [];\r\n      } catch {\r\n        return [];\r\n      }\r\n    },\r\n  });\r\n\r\n  const createConfigMutation = useMutation({\r\n    mutationFn: async () => {\r\n      if (!createForm.displayName?.trim()) {\r\n        throw new Error('Service Label is required');\r\n      }\r\n      console.log('[Create Service] Starting with:', { label: createForm.displayName, provider: createForm.provider });\r\n      \r\n      // 1) Create a custom service with label\r\n      const serviceRes = await fetch('/api/v1/ai/services', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ label: createForm.displayName.trim() }),\r\n      });\r\n      \r\n      if (!serviceRes.ok) {\r\n        const errorText = await serviceRes.text();\r\n        console.error('[Create Service] Failed to create service:', errorText);\r\n        throw new Error(`Failed to create service: ${errorText}`);\r\n      }\r\n      \r\n      const serviceData = await serviceRes.json();\r\n      console.log('[Create Service] Service created:', serviceData);\r\n      const serviceId = serviceData?.data?.id;\r\n      if (!serviceId) {\r\n        console.error('[Create Service] No service ID returned:', serviceData);\r\n        throw new Error('Service created without id');\r\n      }\r\n\r\n      // 2) Attach initial provider config\r\n      const prov = createForm.provider;\r\n      const config: any = {\r\n        provider: prov,\r\n        activeProvider: prov,\r\n        ...(createForm.baseUrl ? { baseUrl: createForm.baseUrl } : {}),\r\n        ...(createForm.apiKey ? { apiKey: createForm.apiKey } : {}),\r\n        ...(createForm.model ? { model: createForm.model } : {}),\r\n        providers: { [prov]: { enabled: true, ...(createForm.baseUrl ? { baseUrl: createForm.baseUrl } : {}), ...(createForm.apiKey ? { apiKey: createForm.apiKey } : {}), ...(createForm.model ? { model: createForm.model } : {}) } },\r\n      };\r\n      \r\n      console.log('[Create Service] Saving config for service:', serviceId, config);\r\n      const cfgRes = await fetch(`/api/v1/ai/services/${serviceId}/config`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ config, enabled: true }),\r\n      });\r\n      \r\n      if (!cfgRes.ok) {\r\n        const errorText = await cfgRes.text();\r\n        console.error('[Create Service] Failed to save config:', errorText);\r\n        throw new Error(`Failed to save configuration: ${errorText}`);\r\n      }\r\n      \r\n      const cfgData = await cfgRes.json();\r\n      console.log('[Create Service] Config saved:', cfgData);\r\n      return cfgData;\r\n    },\r\n    onSuccess: () => {\r\n      console.log('[Create Service] Success - refreshing queries');\r\n      toast.success('AI service created');\r\n      setIsCreateOpen(false);\r\n      setCreateForm({ displayName: '', provider: 'openai', baseUrl: '', apiKey: '', model: '' });\r\n      // Refresh any service/config queries the page might use\r\n      queryClient.invalidateQueries({ queryKey: ['ai-provider-registry'] });\r\n      queryClient.invalidateQueries({ queryKey: ['ai-configs'] });\r\n      queryClient.invalidateQueries({ queryKey: ['ai-services'] });\r\n    },\r\n    onError: (e: any) => {\r\n      console.error('[Create Service] Error:', e);\r\n      toast.error(e?.message || 'Failed to create service');\r\n    },\r\n  });\r\n  const [selectedService, setSelectedService] = useState<string | null>(null);\r\n  const [dynamicModels, setDynamicModels] = useState<Record<string, string[]>>({});\r\n  const [testResult, setTestResult] = useState<{ success: boolean; message: string } | null>(null);\r\n  const [isTestDialogOpen, setIsTestDialogOpen] = useState(false);\r\n  const [pendingAdvanced, setPendingAdvanced] = useState<Record<string, string>>({});\r\n  const [openRouterFilters, setOpenRouterFilters] = useState<Record<string, boolean>>({});\r\n  // Local state for custom providers to enable immediate UI updates\r\n  const [customProvidersLocal, setCustomProvidersLocal] = useState<Record<string, Record<string, any>>>({});\r\n  // Local state for web search API keys to enable immediate UI updates\r\n  const [webSearchKeysLocal, setWebSearchKeysLocal] = useState<Record<string, {\r\n    serperApiKey?: string;\r\n    tavilyApiKey?: string;\r\n    googleSearchApiKey?: string;\r\n    googleSearchEngineId?: string;\r\n  }>>({});\r\n  // Refs to track debounce timeouts for each input field\r\n  const debounceTimeouts = useRef<Record<string, NodeJS.Timeout>>({});\r\n\r\n  // Helper: fetch models for a service/provider combination and cache locally\r\n  async function fetchModelsFor(service: string, cfg: any) {\r\n    try {\r\n      const res = await fetch(`/api/v1/ai/config/${service}/models`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ config: cfg || {} })\r\n      })\r\n      const data = await res.json().catch(() => ({}))\r\n      const list: string[] = data?.data?.models || []\r\n      const prov: string = cfg?.activeProvider || cfg?.provider || 'openai'\r\n      const uniqueModels = dedupeModels(Array.isArray(list) ? list : [])\r\n      if (uniqueModels.length) {\r\n        const dynKey = `${service}:${prov}`\r\n        setDynamicModels(prev => ({ ...prev, [dynKey]: uniqueModels }))\r\n        // maintain fallback options too\r\n        MODEL_OPTIONS[prov] = uniqueModels\r\n        try { queryClient.invalidateQueries({ queryKey: ['ai-configs'] }) } catch {}\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  // Fetch all configurations\r\n  const { data: configs = [], isLoading } = useQuery<AIServiceConfig[]>({\r\n    queryKey: ['ai-configs'],\r\n    queryFn: async () => {\r\n      const response = await fetch('/api/v1/ai/config');\r\n      if (!response.ok) throw new Error('Failed to fetch configurations');\r\n      const data = await response.json();\r\n      return data.data || [];\r\n    },\r\n  });\r\n\r\n  // Sync local web search keys state with server data (only on initial load)\r\n  useEffect(() => {\r\n    // Only initialize if we don't have local state yet\r\n    if (Object.keys(webSearchKeysLocal).length > 0) return;\r\n    \r\n    const newLocalState: Record<string, {\r\n      serperApiKey?: string;\r\n      tavilyApiKey?: string;\r\n      googleSearchApiKey?: string;\r\n      googleSearchEngineId?: string;\r\n    }> = {};\r\n    configs.forEach((c) => {\r\n      if (c.service_type === 'supplier_discovery' && c.config?.webSearch) {\r\n        newLocalState[c.service_type] = {\r\n          serperApiKey: c.config.webSearch.serperApiKey || '',\r\n          tavilyApiKey: c.config.webSearch.tavilyApiKey || '',\r\n          googleSearchApiKey: c.config.webSearch.googleSearchApiKey || '',\r\n          googleSearchEngineId: c.config.webSearch.googleSearchEngineId || '',\r\n        };\r\n      }\r\n    });\r\n    if (Object.keys(newLocalState).length > 0) {\r\n      setWebSearchKeysLocal(newLocalState);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [configs.length]); // Only run when configs first loads\r\n\r\n  // Sync local custom providers state with server data (only on initial load)\r\n  useEffect(() => {\r\n    // Only initialize if we don't have local state yet\r\n    if (Object.keys(customProvidersLocal).length > 0) return;\r\n    \r\n    const newLocalState: Record<string, Record<string, any>> = {};\r\n    configs.forEach((c) => {\r\n      if (c.config?.webSearch?.customProviders) {\r\n        newLocalState[c.service_type] = c.config.webSearch.customProviders;\r\n      }\r\n    });\r\n    if (Object.keys(newLocalState).length > 0) {\r\n      setCustomProvidersLocal(newLocalState);\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [configs.length]); // Only run when configs first loads\r\n\r\n  // On initial load, try to pre-populate model lists for configured providers\r\n  useEffect(() => {\r\n    if (!configs?.length) return\r\n    configs.forEach((c) => {\r\n      const service = c.service_type\r\n      const provider = (c.config?.activeProvider || c.config?.provider || 'openai') as string\r\n      const dynKey = `${service}:${provider}`\r\n      if (dynamicModels[dynKey]?.length) return\r\n      const section = (c.config?.providers?.[provider] || {}) as any\r\n      const baseUrl = section.baseUrl || c.config?.baseUrl\r\n      const apiKey = section.apiKey || c.config?.apiKey\r\n      if (baseUrl && apiKey) {\r\n        void fetchModelsFor(service, { ...c.config, provider, activeProvider: provider, baseUrl, apiKey })\r\n      }\r\n    })\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [configs])\r\n\r\n  // Update configuration\r\n  const updateConfigMutation = useMutation({\r\n    mutationFn: async ({\r\n      service,\r\n      updates,\r\n    }: {\r\n      service: string;\r\n      updates: Partial<AIServiceConfig>;\r\n    }) => {\r\n      const response = await fetch(`/api/v1/ai/config/${service}`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) throw new Error('Failed to update configuration');\r\n      return response.json();\r\n    },\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: ['ai-configs'] });\r\n      toast.success('Configuration updated successfully');\r\n    },\r\n    onError: (error: Error) => {\r\n      toast.error(`Failed to update: ${error.message}`);\r\n    },\r\n  });\r\n\r\n  // Test connection\r\n  const testConnectionMutation = useMutation({\r\n    mutationFn: async ({ service, config }: { service: string; config: any }) => {\r\n      const response = await fetch(`/api/v1/ai/config/${service}/test`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ config }),\r\n      });\r\n      if (!response.ok) throw new Error(await response.text());\r\n      return response.json();\r\n    },\r\n    onSuccess: (data: any) => {\r\n      setTestResult({ success: true, message: data?.data?.message || 'Connection successful!' });\r\n      setIsTestDialogOpen(true);\r\n    },\r\n    onError: (error: any) => {\r\n      setTestResult({ success: false, message: error?.message || 'Connection test failed' });\r\n      setIsTestDialogOpen(true);\r\n    },\r\n  });\r\n\r\n  // Toggle service enabled/disabled\r\n  const handleToggleService = (service: string, enabled: boolean) => {\r\n    updateConfigMutation.mutate({\r\n      service,\r\n      updates: { enabled },\r\n    });\r\n  };\r\n\r\n  // Get config for specific service\r\n  const getServiceConfig = (serviceType: string): AIServiceConfig | undefined => {\r\n    return configs.find((c) => c.service_type === serviceType);\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center p-12\">\r\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Section heading removed to avoid duplication with page title */}\r\n\r\n      {/* Add New AI Service */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\r\n          <DialogTrigger asChild>\r\n            <Button>\r\n              <Plus className=\"mr-2 h-4 w-4\" />\r\n              Add New AI Service\r\n            </Button>\r\n          </DialogTrigger>\r\n          <DialogContent className=\"max-w-2xl\">\r\n            <DialogHeader>\r\n              <DialogTitle>Add AI Service</DialogTitle>\r\n              <DialogDescription>Create and configure a new AI service with provider, endpoint, API key, and model.</DialogDescription>\r\n            </DialogHeader>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2 md:col-span-2\">\r\n                <Label>Service Label <span className=\"text-red-500\">*</span></Label>\r\n                <Input\r\n                  placeholder=\"e.g. Demand Forecasting\"\r\n                  value={createForm.displayName}\r\n                  onChange={(e) => setCreateForm((p) => ({ ...p, displayName: e.target.value }))}\r\n                  required\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Provider</Label>\r\n                <Select value={createForm.provider} onValueChange={(v) => setCreateForm((p) => ({ ...p, provider: v as any }))}>\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {['openai','anthropic','openai_compatible'].map((p) => (\r\n                      <SelectItem key={p} value={p}>{p.replace('_',' ').replace(/\\b\\w/g,(c)=>c.toUpperCase())}</SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2 md:col-span-2\">\r\n                <Label>Import from Preset</Label>\r\n                <Select onValueChange={(presetId) => {\r\n                  const preset: any = providerPresets.find((x:any) => x.id === presetId);\r\n                  if (!preset) return;\r\n                  const prov = preset.provider_type === 'openai' || preset.provider_type === 'anthropic' ? preset.provider_type : 'openai_compatible';\r\n                  setCreateForm((p) => ({\r\n                    ...p,\r\n                    provider: prov,\r\n                    baseUrl: preset.base_url || p.baseUrl,\r\n                    model: preset.default_model || p.model,\r\n                  }));\r\n                  toast.success(`Imported preset \"${preset.name}\"`);\r\n                }}>\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder={providerPresets.length ? 'Choose preset…' : 'No presets available'} />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {providerPresets.map((p:any) => (\r\n                      <SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Endpoint URL</Label>\r\n                <Input\r\n                  placeholder={createForm.provider === 'openai' ? 'https://api.openai.com/v1' : createForm.provider === 'anthropic' ? 'https://api.anthropic.com' : 'https://your-compatible-base/v1'}\r\n                  value={createForm.baseUrl}\r\n                  onChange={(e) => setCreateForm((p) => ({ ...p, baseUrl: e.target.value }))}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>API Key</Label>\r\n                <Input\r\n                  type=\"password\"\r\n                  placeholder={`Enter ${createForm.provider.replace('_',' ')} API key`}\r\n                  value={createForm.apiKey}\r\n                  onChange={(e) => setCreateForm((p) => ({ ...p, apiKey: e.target.value }))}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2 md:col-span-2\">\r\n                <Label>Model</Label>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Select value={createForm.model} onValueChange={(v) => setCreateForm((p) => ({ ...p, model: v }))}>\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Select model\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent className=\"max-h-64 overflow-auto\">\r\n                      {(dynamicModels[`assistant:${createForm.provider}`] || MODEL_OPTIONS[createForm.provider] || []).map((m: any) => (\r\n                        <SelectItem key={m} value={m}>{m}</SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={async () => {\r\n                      const cfg = { provider: createForm.provider, activeProvider: createForm.provider, baseUrl: createForm.baseUrl, apiKey: createForm.apiKey } as any;\r\n                      await fetchModelsFor('assistant', cfg);\r\n                      toast.success('Loaded models');\r\n                    }}\r\n                  >\r\n                    Load models\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex justify-end gap-2\">\r\n              <Button variant=\"outline\" onClick={() => setIsCreateOpen(false)}>Cancel</Button>\r\n              <Button disabled={createConfigMutation.isPending || !createForm.displayName.trim() || !createForm.provider} onClick={() => createConfigMutation.mutate()}>\r\n                <Save className=\"mr-2 h-4 w-4\" />\r\n                Save\r\n              </Button>\r\n            </div>\r\n          </DialogContent>\r\n        </Dialog>\r\n      </div>\r\n\r\n      {/* Org-wide Provider Registry */}\r\n      <ProviderRegistryPanel />\r\n\r\n      <Separator />\r\n\r\n      {/* Built-in AI Services */}\r\n      <div>\r\n        <h2 className=\"text-xl font-semibold mb-4\">Built-in AI Services</h2>\r\n        <UnifiedServicePanel />\r\n      </div>\r\n\r\n      <Separator />\r\n\r\n      {/* Custom Services (named) */}\r\n      <CustomServicesPanel />\r\n\r\n      <div className=\"grid gap-6 grid-cols-1\" style={{ display: 'none' }}>\r\n        {Object.entries(SERVICE_INFO).map(([serviceType, info]) => {\r\n          const config = getServiceConfig(serviceType);\r\n          const isEnabled = config?.enabled || false;\r\n          const activeProv = config?.config?.activeProvider || config?.config?.provider || 'openai'\r\n          const dynKey = `${serviceType}:${activeProv}`\r\n          const supportedModels = getSupportedModels(activeProv)\r\n          const providerSection = (config?.config?.providers?.[activeProv] || {}) as any\r\n          const openRouterFilterKey = getOpenRouterFilterKey(serviceType, activeProv)\r\n          const isActiveOpenRouter = isOpenRouterProvider(activeProv, providerSection, config)\r\n          const showOpenRouterFreeOnly = isActiveOpenRouter ? !!openRouterFilters[openRouterFilterKey] : false\r\n          const rawModels = dynamicModels[dynKey] || MODEL_OPTIONS[activeProv] || []\r\n          const uniqueRaw = dedupeModels(Array.isArray(rawModels) ? rawModels : [])\r\n          const filteredByProvider = supportedModels && supportedModels.length > 0\r\n            ? uniqueRaw.filter((model) => supportedModels.includes(model))\r\n            : uniqueRaw\r\n          const availableModels = isActiveOpenRouter\r\n            ? filterOpenRouterModels(filteredByProvider, showOpenRouterFreeOnly)\r\n            : filteredByProvider\r\n\r\n          return (\r\n            <Card key={serviceType} className=\"relative\">\r\n              <CardHeader>\r\n                <div className=\"flex items-start justify-between\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <span className=\"text-3xl\">{info.icon}</span>\r\n                    <div>\r\n                      <CardTitle className=\"text-xl\">{info.name}</CardTitle>\r\n                      <CardDescription className=\"mt-1\">{info.description}</CardDescription>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Label htmlFor={`${serviceType}-enabled`} className=\"text-sm\">\r\n                      {isEnabled ? 'Enabled' : 'Disabled'}\r\n                    </Label>\r\n                    <Switch\r\n                      id={`${serviceType}-enabled`}\r\n                      checked={isEnabled}\r\n                      onCheckedChange={(checked) => handleToggleService(serviceType, checked)}\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </CardHeader>\r\n\r\n              <CardContent className=\"space-y-4\">\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor={`${serviceType}-provider`}>Provider</Label>\r\n                  <Select\r\n                    value={config?.config?.provider || info.providers[0]}\r\n                    onValueChange={async (value) => {\r\n                      updateConfigMutation.mutate({\r\n                        service: serviceType,\r\n                        updates: {\r\n                          config: {\r\n                            ...config?.config,\r\n                            provider: value,\r\n                            activeProvider: value as any,\r\n                          },\r\n                        },\r\n                      });\r\n                      const nextCfg = { ...(config?.config || {}), provider: value, activeProvider: value }\r\n                      await fetchModelsFor(serviceType, nextCfg)\r\n                    }}\r\n                  >\r\n                    <SelectTrigger id={`${serviceType}-provider`}>\r\n                      <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {info.providers.map((provider) => (\r\n                        <SelectItem key={provider} value={provider}>\r\n                          {provider.charAt(0).toUpperCase() + provider.slice(1)}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                {/* Active provider + multi-provider toggle */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor={`${serviceType}-active-provider`}>Active Provider</Label>\r\n                    <Select\r\n                      value={config?.config?.activeProvider || config?.config?.provider || ''}\r\n                      onValueChange={async (value) => {\r\n                        updateConfigMutation.mutate({\r\n                          service: serviceType,\r\n                          updates: {\r\n                            config: {\r\n                              ...config?.config,\r\n                              activeProvider: value as any,\r\n                              provider: value,\r\n                            },\r\n                          },\r\n                        });\r\n                        const nextCfg = { ...(config?.config || {}), provider: value, activeProvider: value }\r\n                        await fetchModelsFor(serviceType, nextCfg)\r\n                      }}\r\n                    >\r\n                      <SelectTrigger id={`${serviceType}-active-provider`}>\r\n                        <SelectValue placeholder=\"Select provider\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {['openai', 'anthropic', 'openai_compatible'].map((p) => (\r\n                          <SelectItem key={p} value={p}>{p.replace('_',' ').replace(/\\b\\w/g, (c) => c.toUpperCase())}</SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                  {/* Import defaults from Registry preset */}\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Import from Preset</Label>\r\n                    <Select onValueChange={async (presetId) => {\r\n                      const preset = providerPresets.find((p:any) => p.id === presetId);\r\n                      if (!preset) return;\r\n                      const prov = preset.provider_type === 'openai' || preset.provider_type === 'anthropic' ? preset.provider_type : 'openai_compatible';\r\n                      const nextCfg: any = {\r\n                        ...config?.config,\r\n                        provider: prov,\r\n                        activeProvider: prov,\r\n                        baseUrl: preset.base_url || config?.config?.baseUrl,\r\n                        model: preset.default_model || config?.config?.model,\r\n                      };\r\n                      updateConfigMutation.mutate({ service: serviceType, updates: { config: nextCfg } });\r\n                      try { await fetchModelsFor(serviceType, nextCfg) } catch {}\r\n                      toast.success(`Imported preset \"${preset.name}\"`);\r\n                    }}>\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder={providerPresets.length ? 'Choose preset…' : 'No presets available'} />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {providerPresets.map((p:any) => (\r\n                          <SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-3 pt-6\">\r\n                    <Switch\r\n                      id={`${serviceType}-multi`}\r\n                      checked={!!config?.config?.enableMultipleProviders}\r\n                      onCheckedChange={(checked) =>\r\n                        updateConfigMutation.mutate({\r\n                          service: serviceType,\r\n                          updates: { config: { ...config?.config, enableMultipleProviders: checked } },\r\n                        })\r\n                      }\r\n                    />\r\n                    <Label htmlFor={`${serviceType}-multi`}>Enable multiple providers</Label>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor={`${serviceType}-model`}>Model</Label>\r\n                  <div className=\"flex items-center gap-2\">\r\n                  <Select\r\n                    value={config?.config?.model || ''}\r\n                    onValueChange={(value) =>\r\n                      updateConfigMutation.mutate({\r\n                        service: serviceType,\r\n                        updates: { config: { ...config?.config, model: value } },\r\n                      })\r\n                    }\r\n                  >\r\n                    <SelectTrigger id={`${serviceType}-model`}>\r\n                      <SelectValue placeholder={info.defaultModel} />\r\n                    </SelectTrigger>\r\n                    <SelectContent className=\"max-h-64 overflow-auto\">\r\n                      {availableModels.length > 0 ? (\r\n                        availableModels.map((m) => (\r\n                          <SelectItem key={m} value={m}>{m}</SelectItem>\r\n                        ))\r\n                      ) : (\r\n                        <div className=\"px-3 py-2 text-sm text-muted-foreground\">\r\n                          No supported models detected for this provider.\r\n                        </div>\r\n                      )}\r\n                    </SelectContent>\r\n                  </Select>\r\n                  <Button\r\n                    type=\"button\"\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={async () => {\r\n                      try {\r\n                        const res = await fetch(`/api/v1/ai/config/${serviceType}/models`, {\r\n                          method: 'POST', headers: { 'Content-Type': 'application/json' },\r\n                          body: JSON.stringify({ config: config?.config || {} })\r\n                        })\r\n                        const data = await res.json().catch(() => ({}))\r\n                        const list: string[] = data?.data?.models || []\r\n                        const uniqueModels = dedupeModels(Array.isArray(list) ? list : [])\r\n                        if (uniqueModels.length) {\r\n                          const prov = config?.config?.activeProvider || config?.config?.provider || 'openai'\r\n                          MODEL_OPTIONS[prov] = uniqueModels\r\n                          const dynKey = `${serviceType}:${prov}`\r\n                          setDynamicModels(prev => ({ ...prev, [dynKey]: uniqueModels }))\r\n                          toast.success(`Loaded ${uniqueModels.length} models`)\r\n                          try { queryClient.invalidateQueries({ queryKey: ['ai-configs'] }) } catch {}\r\n                        } else {\r\n                          toast.error('No models returned from provider')\r\n                        }\r\n                      } catch (e:any) {\r\n                        toast.error(e?.message || 'Failed to load models')\r\n                      }\r\n                    }}\r\n                  >\r\n                    Load models\r\n                  </Button>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Provider-specific configuration cards */}\r\n                {(['openai', 'anthropic', 'openai_compatible'] as const).map((p) => {\r\n                  const section = (config?.config?.providers?.[p] || {}) as any\r\n                  const providerModels = dedupeModels(dynamicModels[`${serviceType}:${p}`] || MODEL_OPTIONS[p] || [])\r\n                  const openRouterKey = getOpenRouterFilterKey(serviceType, p)\r\n                  const isSectionOpenRouter = isOpenRouterProvider(p, section, config)\r\n                  const showFreeOnly = isSectionOpenRouter ? !!openRouterFilters[openRouterKey] : false\r\n                  const models = isSectionOpenRouter\r\n                    ? filterOpenRouterModels(providerModels, showFreeOnly)\r\n                    : providerModels\r\n                  return (\r\n                    <Card key={`${serviceType}-${p}`} className=\"border border-dashed\">\r\n                      <CardHeader>\r\n                        <CardTitle className=\"text-base\">{p.replace('_',' ').replace(/\\b\\w/g, (c) => c.toUpperCase())}</CardTitle>\r\n                        <CardDescription>Endpoint, API key and model</CardDescription>\r\n                      </CardHeader>\r\n                      <CardContent className=\"space-y-3\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                          <Switch\r\n                            id={`${serviceType}-${p}-enabled`}\r\n                            checked={!!section.enabled}\r\n                            onCheckedChange={(checked) =>\r\n                              updateConfigMutation.mutate({\r\n                                service: serviceType,\r\n                                updates: { config: { ...config?.config, providers: { ...(config?.config?.providers||{}), [p]: { ...section, enabled: checked } } } },\r\n                              })\r\n                            }\r\n                          />\r\n                          <Label htmlFor={`${serviceType}-${p}-enabled`}>Enabled</Label>\r\n                        </div>\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                          <div className=\"space-y-2\">\r\n                            <Label htmlFor={`${serviceType}-${p}-endpoint`}>Endpoint URL</Label>\r\n                            <Input\r\n                              id={`${serviceType}-${p}-endpoint`}\r\n                              placeholder={p === 'openai' ? 'https://api.openai.com/v1' : p === 'anthropic' ? 'https://api.anthropic.com' : 'https://your-compatible-base/v1'}\r\n                              value={section.baseUrl || ''}\r\n                              onChange={async (e) => {\r\n                                const baseUrl = e.target.value\r\n                                const nextProviders = { ...(config?.config?.providers||{}), [p]: { ...section, baseUrl } }\r\n                                const nextCfg = { ...(config?.config||{}), providers: nextProviders }\r\n                                updateConfigMutation.mutate({\r\n                                  service: serviceType,\r\n                                  updates: { config: nextCfg },\r\n                                })\r\n                                const key = nextProviders?.[p]?.apiKey\r\n                                if (baseUrl && key) {\r\n                                  await fetchModelsFor(serviceType, { ...nextCfg, activeProvider: p, provider: p })\r\n                                }\r\n                              }}\r\n                            />\r\n                          </div>\r\n                          <div className=\"space-y-2\">\r\n                            <Label htmlFor={`${serviceType}-${p}-key`}>API Key</Label>\r\n                            <Input\r\n                              id={`${serviceType}-${p}-key`}\r\n                              type=\"password\"\r\n                              placeholder={`Enter ${p} API key`}\r\n                              value={section.apiKey || ''}\r\n                              onChange={async (e) => {\r\n                                const apiKey = e.target.value\r\n                                const nextProviders = { ...(config?.config?.providers||{}), [p]: { ...section, apiKey } }\r\n                                const nextCfg = { ...(config?.config||{}), providers: nextProviders }\r\n                                updateConfigMutation.mutate({\r\n                                  service: serviceType,\r\n                                  updates: { config: nextCfg },\r\n                                })\r\n                                const baseUrl = nextProviders?.[p]?.baseUrl\r\n                                if (baseUrl && apiKey) {\r\n                                  await fetchModelsFor(serviceType, { ...nextCfg, activeProvider: p, provider: p })\r\n                                }\r\n                              }}\r\n                            />\r\n                          </div>\r\n                          <div className=\"space-y-2\">\r\n                            <div className=\"flex items-center gap-2 justify-between\">\r\n                              <Label htmlFor={`${serviceType}-${p}-model`}>Model</Label>\r\n                              {isSectionOpenRouter && (\r\n                                <div className=\"flex items-center gap-2\">\r\n                                  <Checkbox\r\n                                    id={`${serviceType}-${p}-free-only`}\r\n                                    checked={showFreeOnly}\r\n                                    onCheckedChange={(value) =>\r\n                                      setOpenRouterFilters((prev) => ({\r\n                                        ...prev,\r\n                                        [openRouterKey]: value === true,\r\n                                      }))\r\n                                    }\r\n                                  />\r\n                                  <Label htmlFor={`${serviceType}-${p}-free-only`} className=\"text-xs font-normal\">\r\n                                    Show only free models\r\n                                  </Label>\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                            <Select\r\n                              value={section.model || ''}\r\n                              onValueChange={(value) =>\r\n                                updateConfigMutation.mutate({\r\n                                  service: serviceType,\r\n                                  updates: { config: { ...config?.config, providers: { ...(config?.config?.providers||{}), [p]: { ...section, model: value } } } },\r\n                                })\r\n                              }\r\n                            >\r\n                              <SelectTrigger id={`${serviceType}-${p}-model`}>\r\n                                <SelectValue placeholder=\"Select model\" />\r\n                              </SelectTrigger>\r\n                              <SelectContent className=\"max-h-64 overflow-auto\">\r\n                                {models.length > 0 ? (\r\n                                  models.map((m) => (\r\n                                    <SelectItem key={m} value={m}>{m}</SelectItem>\r\n                                  ))\r\n                                ) : (\r\n                                  <div className=\"px-3 py-2 text-sm text-muted-foreground\">\r\n                                    No models match the current filters. Try disabling the free-model filter or load models again.\r\n                                  </div>\r\n                                )}\r\n                              </SelectContent>\r\n                            </Select>\r\n                          </div>\r\n                        </div>\r\n                      </CardContent>\r\n                    </Card>\r\n                  )\r\n                })}\r\n\r\n                {/* Web Search API Configuration - Only for Supplier Discovery */}\r\n                {serviceType === 'supplier_discovery' && (\r\n                  <>\r\n                    {/* Model Selection for Supplier Discovery */}\r\n                    <Card className=\"border-2 border-purple-200 bg-purple-50/50\">\r\n                      <CardHeader>\r\n                        <CardTitle className=\"text-base flex items-center gap-2\">\r\n                          <Settings className=\"h-5 w-5\" />\r\n                          AI Model Configuration\r\n                        </CardTitle>\r\n                        <CardDescription>\r\n                          Configure the AI model used for data extraction and analysis\r\n                        </CardDescription>\r\n                      </CardHeader>\r\n                      <CardContent className=\"space-y-4\">\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                          <div className=\"space-y-2\">\r\n                            <Label htmlFor={`${serviceType}-ai-model`}>AI Model</Label>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Select\r\n                                value={config?.config?.model || ''}\r\n                                onValueChange={(value) =>\r\n                                  updateConfigMutation.mutate({\r\n                                    service: serviceType,\r\n                                    updates: { config: { ...config?.config, model: value } },\r\n                                  })\r\n                                }\r\n                              >\r\n                                <SelectTrigger id={`${serviceType}-ai-model`}>\r\n                                  <SelectValue placeholder=\"Select model\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent className=\"max-h-64 overflow-auto\">\r\n                                  {availableModels.length > 0 ? (\r\n                                    availableModels.map((m) => (\r\n                                      <SelectItem key={m} value={m}>{m}</SelectItem>\r\n                                    ))\r\n                                  ) : (\r\n                                    <div className=\"px-3 py-2 text-sm text-muted-foreground\">\r\n                                      No models available. Configure provider first.\r\n                                    </div>\r\n                                  )}\r\n                                </SelectContent>\r\n                              </Select>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"space-y-2\">\r\n                            <Label htmlFor={`${serviceType}-ai-model-manual`}>Or Enter Model Name</Label>\r\n                            <Input\r\n                              id={`${serviceType}-ai-model-manual`}\r\n                              type=\"text\"\r\n                              placeholder=\"e.g., gpt-4, claude-3-5-sonnet\"\r\n                              value={config?.config?.model || ''}\r\n                              onChange={(e) => {\r\n                                const newValue = e.target.value;\r\n                                updateConfigMutation.mutate({\r\n                                  service: serviceType,\r\n                                  updates: { config: { ...config?.config, model: newValue } },\r\n                                });\r\n                              }}\r\n                            />\r\n                          </div>\r\n                        </div>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                          Select a model from the dropdown or manually enter a model name. The model will be used for extracting supplier information from web content.\r\n                        </p>\r\n                      </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Web Search APIs Card */}\r\n                    <Card className=\"border-2 border-blue-200 bg-blue-50/50\">\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-base flex items-center gap-2\">\r\n                        <Globe className=\"h-5 w-5\" />\r\n                        Web Search APIs\r\n                      </CardTitle>\r\n                      <CardDescription>\r\n                        Configure web search providers for supplier discovery. At least one API key is recommended.\r\n                      </CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent className=\"space-y-4\">\r\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                        {/* Serper API */}\r\n                        <div className=\"space-y-2\">\r\n                          <Label htmlFor={`${serviceType}-serper-key`}>\r\n                            Serper API Key\r\n                            <span className=\"text-xs text-muted-foreground ml-2\">(Recommended)</span>\r\n                          </Label>\r\n                          <Input\r\n                            id={`${serviceType}-serper-key`}\r\n                            type=\"password\"\r\n                            placeholder=\"sk_xxxxxxxxxxxxxxxxxxxxx\"\r\n                            value={webSearchKeysLocal[serviceType]?.serperApiKey ?? config?.config?.webSearch?.serperApiKey ?? ''}\r\n                            onChange={(e) => {\r\n                              const newValue = e.target.value;\r\n                              \r\n                              // Update local state immediately for instant UI feedback\r\n                              setWebSearchKeysLocal(prev => ({\r\n                                ...prev,\r\n                                [serviceType]: {\r\n                                  ...(prev[serviceType] || {}),\r\n                                  serperApiKey: newValue,\r\n                                },\r\n                              }));\r\n                              \r\n                              // Debounce the mutation\r\n                              const timeoutKey = `${serviceType}-serper-key`;\r\n                              if (debounceTimeouts.current[timeoutKey]) {\r\n                                clearTimeout(debounceTimeouts.current[timeoutKey]);\r\n                              }\r\n                              debounceTimeouts.current[timeoutKey] = setTimeout(() => {\r\n                                const webSearch = {\r\n                                  ...(config?.config?.webSearch || {}),\r\n                                  serperApiKey: newValue,\r\n                                };\r\n                                updateConfigMutation.mutate({\r\n                                  service: serviceType,\r\n                                  updates: {\r\n                                    config: {\r\n                                      ...config?.config,\r\n                                      webSearch,\r\n                                    },\r\n                                  },\r\n                                });\r\n                                delete debounceTimeouts.current[timeoutKey];\r\n                              }, 500);\r\n                            }}\r\n                          />\r\n                          <p className=\"text-xs text-muted-foreground\">\r\n                            Get API key from{' '}\r\n                            <a href=\"https://serper.dev\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"underline\">\r\n                              serper.dev\r\n                            </a>\r\n                          </p>\r\n                        </div>\r\n\r\n                        {/* Tavily API */}\r\n                        <div className=\"space-y-2\">\r\n                          <Label htmlFor={`${serviceType}-tavily-key`}>Tavily API Key</Label>\r\n                          <Input\r\n                            id={`${serviceType}-tavily-key`}\r\n                            type=\"password\"\r\n                            placeholder=\"tvly-xxxxxxxxxxxxxxxxxxxxx\"\r\n                            value={webSearchKeysLocal[serviceType]?.tavilyApiKey ?? config?.config?.webSearch?.tavilyApiKey ?? ''}\r\n                            onChange={(e) => {\r\n                              const newValue = e.target.value;\r\n                              \r\n                              // Update local state immediately\r\n                              setWebSearchKeysLocal(prev => ({\r\n                                ...prev,\r\n                                [serviceType]: {\r\n                                  ...(prev[serviceType] || {}),\r\n                                  tavilyApiKey: newValue,\r\n                                },\r\n                              }));\r\n                              \r\n                              // Debounce the mutation\r\n                              const timeoutKey = `${serviceType}-tavily-key`;\r\n                              if (debounceTimeouts.current[timeoutKey]) {\r\n                                clearTimeout(debounceTimeouts.current[timeoutKey]);\r\n                              }\r\n                              debounceTimeouts.current[timeoutKey] = setTimeout(() => {\r\n                                const webSearch = {\r\n                                  ...(config?.config?.webSearch || {}),\r\n                                  tavilyApiKey: newValue,\r\n                                };\r\n                                updateConfigMutation.mutate({\r\n                                  service: serviceType,\r\n                                  updates: {\r\n                                    config: {\r\n                                      ...config?.config,\r\n                                      webSearch,\r\n                                    },\r\n                                  },\r\n                                });\r\n                                delete debounceTimeouts.current[timeoutKey];\r\n                              }, 500);\r\n                            }}\r\n                          />\r\n                          <p className=\"text-xs text-muted-foreground\">\r\n                            Get API key from{' '}\r\n                            <a href=\"https://tavily.com\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"underline\">\r\n                              tavily.com\r\n                            </a>\r\n                          </p>\r\n                        </div>\r\n\r\n                        {/* Google Search API Key */}\r\n                        <div className=\"space-y-2\">\r\n                          <Label htmlFor={`${serviceType}-google-key`}>Google Search API Key</Label>\r\n                          <Input\r\n                            id={`${serviceType}-google-key`}\r\n                            type=\"password\"\r\n                            placeholder=\"AIzaSyxxxxxxxxxxxxxxxxxxxxx\"\r\n                            value={webSearchKeysLocal[serviceType]?.googleSearchApiKey ?? config?.config?.webSearch?.googleSearchApiKey ?? ''}\r\n                            onChange={(e) => {\r\n                              const newValue = e.target.value;\r\n                              \r\n                              // Update local state immediately\r\n                              setWebSearchKeysLocal(prev => ({\r\n                                ...prev,\r\n                                [serviceType]: {\r\n                                  ...(prev[serviceType] || {}),\r\n                                  googleSearchApiKey: newValue,\r\n                                },\r\n                              }));\r\n                              \r\n                              // Debounce the mutation\r\n                              const timeoutKey = `${serviceType}-google-key`;\r\n                              if (debounceTimeouts.current[timeoutKey]) {\r\n                                clearTimeout(debounceTimeouts.current[timeoutKey]);\r\n                              }\r\n                              debounceTimeouts.current[timeoutKey] = setTimeout(() => {\r\n                                const webSearch = {\r\n                                  ...(config?.config?.webSearch || {}),\r\n                                  googleSearchApiKey: newValue,\r\n                                };\r\n                                updateConfigMutation.mutate({\r\n                                  service: serviceType,\r\n                                  updates: {\r\n                                    config: {\r\n                                      ...config?.config,\r\n                                      webSearch,\r\n                                    },\r\n                                  },\r\n                                });\r\n                                delete debounceTimeouts.current[timeoutKey];\r\n                              }, 500);\r\n                            }}\r\n                          />\r\n                        </div>\r\n\r\n                        {/* Google Search Engine ID */}\r\n                        <div className=\"space-y-2\">\r\n                          <Label htmlFor={`${serviceType}-google-cx`}>Google Search Engine ID</Label>\r\n                          <Input\r\n                            id={`${serviceType}-google-cx`}\r\n                            type=\"text\"\r\n                            placeholder=\"xxxxxxxxxxxxxxxxxxxxx\"\r\n                            value={webSearchKeysLocal[serviceType]?.googleSearchEngineId ?? config?.config?.webSearch?.googleSearchEngineId ?? ''}\r\n                            onChange={(e) => {\r\n                              const newValue = e.target.value;\r\n                              \r\n                              // Update local state immediately\r\n                              setWebSearchKeysLocal(prev => ({\r\n                                ...prev,\r\n                                [serviceType]: {\r\n                                  ...(prev[serviceType] || {}),\r\n                                  googleSearchEngineId: newValue,\r\n                                },\r\n                              }));\r\n                              \r\n                              // Debounce the mutation\r\n                              const timeoutKey = `${serviceType}-google-cx`;\r\n                              if (debounceTimeouts.current[timeoutKey]) {\r\n                                clearTimeout(debounceTimeouts.current[timeoutKey]);\r\n                              }\r\n                              debounceTimeouts.current[timeoutKey] = setTimeout(() => {\r\n                                const webSearch = {\r\n                                  ...(config?.config?.webSearch || {}),\r\n                                  googleSearchEngineId: newValue,\r\n                                };\r\n                                updateConfigMutation.mutate({\r\n                                  service: serviceType,\r\n                                  updates: {\r\n                                    config: {\r\n                                      ...config?.config,\r\n                                      webSearch,\r\n                                    },\r\n                                  },\r\n                                });\r\n                                delete debounceTimeouts.current[timeoutKey];\r\n                              }, 500);\r\n                            }}\r\n                          />\r\n                          <p className=\"text-xs text-muted-foreground\">\r\n                            Required if using Google Search API\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"rounded-md bg-blue-100 p-3 text-sm text-blue-800\">\r\n                        <strong>Note:</strong> If no API keys are configured, the system will use DuckDuckGo (free, no API key required) as a fallback.\r\n                      </div>\r\n\r\n                      {/* Custom Providers Section */}\r\n                      <Separator className=\"my-4\" />\r\n                      <div className=\"space-y-4\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <div>\r\n                            <h4 className=\"text-sm font-semibold\">Custom Service Providers</h4>\r\n                            <p className=\"text-xs text-muted-foreground\">\r\n                              Add any service provider with custom API keys\r\n                            </p>\r\n                          </div>\r\n                          <Button\r\n                            type=\"button\"\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            onClick={() => {\r\n                              const currentProviders = customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {};\r\n                              const newProviderName = `provider_${Date.now()}`;\r\n                              const newProvider = {\r\n                                apiKey: '',\r\n                                apiUrl: '',\r\n                                model: '',\r\n                                description: '',\r\n                                enabled: true,\r\n                              };\r\n                              \r\n                              // Update local state immediately\r\n                              setCustomProvidersLocal(prev => ({\r\n                                ...prev,\r\n                                [serviceType]: {\r\n                                  ...currentProviders,\r\n                                  [newProviderName]: newProvider,\r\n                                },\r\n                              }));\r\n                              \r\n                              // Then sync with server\r\n                              const webSearch = {\r\n                                ...(config?.config?.webSearch || {}),\r\n                                customProviders: {\r\n                                  ...currentProviders,\r\n                                  [newProviderName]: newProvider,\r\n                                },\r\n                              };\r\n                              updateConfigMutation.mutate({\r\n                                service: serviceType,\r\n                                updates: {\r\n                                  config: {\r\n                                    ...config?.config,\r\n                                    webSearch,\r\n                                  },\r\n                                },\r\n                              });\r\n                            }}\r\n                            disabled={updateConfigMutation.isPending}\r\n                          >\r\n                            <Plus className=\"mr-2 h-4 w-4\" />\r\n                            Add Provider\r\n                          </Button>\r\n                        </div>\r\n\r\n                        {/* List of custom providers */}\r\n                        {Object.entries(customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {}).map(([providerName, provider]: [string, any]) => {\r\n                          // Use local state if available, otherwise fall back to server data\r\n                          const localProvider = customProvidersLocal[serviceType]?.[providerName];\r\n                          const displayProvider = localProvider || provider;\r\n                          \r\n                          return (\r\n                            <Card key={providerName} className=\"border border-dashed\">\r\n                              <CardContent className=\"pt-4 space-y-3\">\r\n                                <div className=\"flex items-center justify-between\">\r\n                                  <div className=\"flex items-center gap-2 flex-1\">\r\n                                    <Input\r\n                                      placeholder=\"Provider Name (e.g., CustomSearchAPI)\"\r\n                                      value={providerName}\r\n                                      onChange={(e) => {\r\n                                        const currentProviders = customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {};\r\n                                        const newName = e.target.value.trim() || providerName;\r\n                                        if (newName !== providerName && newName) {\r\n                                          const { [providerName]: oldProvider, ...rest } = currentProviders;\r\n                                          \r\n                                          // Update local state immediately\r\n                                          setCustomProvidersLocal(prev => ({\r\n                                            ...prev,\r\n                                            [serviceType]: {\r\n                                              ...rest,\r\n                                              [newName]: oldProvider,\r\n                                            },\r\n                                          }));\r\n                                          \r\n                                          // Then sync with server\r\n                                          const webSearch = {\r\n                                            ...(config?.config?.webSearch || {}),\r\n                                            customProviders: {\r\n                                              ...rest,\r\n                                              [newName]: oldProvider,\r\n                                            },\r\n                                          };\r\n                                          updateConfigMutation.mutate({\r\n                                            service: serviceType,\r\n                                            updates: {\r\n                                              config: {\r\n                                                ...config?.config,\r\n                                                webSearch,\r\n                                              },\r\n                                            },\r\n                                          });\r\n                                        }\r\n                                      }}\r\n                                      className=\"font-semibold\"\r\n                                    />\r\n                                    <Switch\r\n                                      checked={displayProvider.enabled !== false}\r\n                                      onCheckedChange={(enabled) => {\r\n                                        const currentProviders = customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {};\r\n                                        \r\n                                        // Update local state immediately\r\n                                        setCustomProvidersLocal(prev => ({\r\n                                          ...prev,\r\n                                          [serviceType]: {\r\n                                            ...currentProviders,\r\n                                            [providerName]: {\r\n                                              ...displayProvider,\r\n                                              enabled,\r\n                                            },\r\n                                          },\r\n                                        }));\r\n                                        \r\n                                        // Then sync with server\r\n                                        const webSearch = {\r\n                                          ...(config?.config?.webSearch || {}),\r\n                                          customProviders: {\r\n                                            ...currentProviders,\r\n                                            [providerName]: {\r\n                                              ...displayProvider,\r\n                                              enabled,\r\n                                            },\r\n                                          },\r\n                                        };\r\n                                        updateConfigMutation.mutate({\r\n                                          service: serviceType,\r\n                                          updates: {\r\n                                            config: {\r\n                                              ...config?.config,\r\n                                              webSearch,\r\n                                            },\r\n                                          },\r\n                                        });\r\n                                      }}\r\n                                    />\r\n                                  </div>\r\n                                  <Button\r\n                                    type=\"button\"\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    onClick={() => {\r\n                                      const currentProviders = customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {};\r\n                                      const updatedProviders = { ...currentProviders };\r\n                                      delete updatedProviders[providerName];\r\n                                      \r\n                                      // Update local state immediately\r\n                                      setCustomProvidersLocal(prev => ({\r\n                                        ...prev,\r\n                                        [serviceType]: updatedProviders,\r\n                                      }));\r\n                                      \r\n                                      // Then sync with server\r\n                                      const webSearch = {\r\n                                        ...(config?.config?.webSearch || {}),\r\n                                        customProviders: updatedProviders,\r\n                                      };\r\n                                      updateConfigMutation.mutate({\r\n                                        service: serviceType,\r\n                                        updates: {\r\n                                          config: {\r\n                                            ...config?.config,\r\n                                            webSearch,\r\n                                          },\r\n                                        },\r\n                                      });\r\n                                    }}\r\n                                    disabled={updateConfigMutation.isPending}\r\n                                  >\r\n                                    <Trash2 className=\"h-4 w-4\" />\r\n                                  </Button>\r\n                                </div>\r\n                                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                                  <div className=\"space-y-2\">\r\n                                    <Label htmlFor={`${serviceType}-custom-${providerName}-key`}>API Key</Label>\r\n                                    <Input\r\n                                      id={`${serviceType}-custom-${providerName}-key`}\r\n                                      type=\"password\"\r\n                                      placeholder=\"Enter API key\"\r\n                                      value={displayProvider.apiKey || ''}\r\n                                      onChange={(e) => {\r\n                                        const currentProviders = customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {};\r\n                                        const newValue = e.target.value;\r\n                                        \r\n                                        // Update local state immediately for instant UI feedback\r\n                                        setCustomProvidersLocal(prev => ({\r\n                                          ...prev,\r\n                                          [serviceType]: {\r\n                                            ...currentProviders,\r\n                                            [providerName]: {\r\n                                              ...displayProvider,\r\n                                              apiKey: newValue,\r\n                                            },\r\n                                          },\r\n                                        }));\r\n                                        \r\n                                      // Debounce server sync (update after user stops typing)\r\n                                      const timeoutKey = `${serviceType}-${providerName}-apiKey`;\r\n                                      if (debounceTimeouts.current[timeoutKey]) {\r\n                                        clearTimeout(debounceTimeouts.current[timeoutKey]);\r\n                                      }\r\n                                      debounceTimeouts.current[timeoutKey] = setTimeout(() => {\r\n                                        const webSearch = {\r\n                                          ...(config?.config?.webSearch || {}),\r\n                                          customProviders: {\r\n                                            ...currentProviders,\r\n                                            [providerName]: {\r\n                                              ...displayProvider,\r\n                                              apiKey: newValue,\r\n                                            },\r\n                                          },\r\n                                        };\r\n                                        updateConfigMutation.mutate({\r\n                                          service: serviceType,\r\n                                          updates: {\r\n                                            config: {\r\n                                              ...config?.config,\r\n                                              webSearch,\r\n                                            },\r\n                                          },\r\n                                        });\r\n                                        delete debounceTimeouts.current[timeoutKey];\r\n                                      }, 500);\r\n                                      }}\r\n                                    />\r\n                                  </div>\r\n                                  <div className=\"space-y-2\">\r\n                                    <Label htmlFor={`${serviceType}-custom-${providerName}-url`}>API URL</Label>\r\n                                    <Input\r\n                                      id={`${serviceType}-custom-${providerName}-url`}\r\n                                      type=\"text\"\r\n                                      placeholder=\"https://api.example.com/v1\"\r\n                                      value={displayProvider.apiUrl || ''}\r\n                                      onChange={(e) => {\r\n                                        const currentProviders = customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {};\r\n                                        const newValue = e.target.value;\r\n                                        \r\n                                        // Update local state immediately\r\n                                        setCustomProvidersLocal(prev => ({\r\n                                          ...prev,\r\n                                          [serviceType]: {\r\n                                            ...currentProviders,\r\n                                            [providerName]: {\r\n                                              ...displayProvider,\r\n                                              apiUrl: newValue,\r\n                                            },\r\n                                          },\r\n                                        }));\r\n                                        \r\n                                      // Debounce server sync\r\n                                      const timeoutKey = `${serviceType}-${providerName}-apiUrl`;\r\n                                      if (debounceTimeouts.current[timeoutKey]) {\r\n                                        clearTimeout(debounceTimeouts.current[timeoutKey]);\r\n                                      }\r\n                                      debounceTimeouts.current[timeoutKey] = setTimeout(() => {\r\n                                        const webSearch = {\r\n                                          ...(config?.config?.webSearch || {}),\r\n                                          customProviders: {\r\n                                            ...currentProviders,\r\n                                            [providerName]: {\r\n                                              ...displayProvider,\r\n                                              apiUrl: newValue,\r\n                                            },\r\n                                          },\r\n                                        };\r\n                                        updateConfigMutation.mutate({\r\n                                          service: serviceType,\r\n                                          updates: {\r\n                                            config: {\r\n                                              ...config?.config,\r\n                                              webSearch,\r\n                                            },\r\n                                          },\r\n                                        });\r\n                                        delete debounceTimeouts.current[timeoutKey];\r\n                                      }, 500);\r\n                                      }}\r\n                                    />\r\n                                  </div>\r\n                                </div>\r\n                                <div className=\"space-y-2\">\r\n                                  <Label htmlFor={`${serviceType}-custom-${providerName}-model`}>Model</Label>\r\n                                  <Input\r\n                                    id={`${serviceType}-custom-${providerName}-model`}\r\n                                    type=\"text\"\r\n                                    placeholder=\"e.g., gpt-4, claude-3-5-sonnet, llama-3.1-70b\"\r\n                                    value={displayProvider.model || ''}\r\n                                    onChange={(e) => {\r\n                                      const currentProviders = customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {};\r\n                                      const newValue = e.target.value;\r\n                                      \r\n                                      // Update local state immediately\r\n                                      setCustomProvidersLocal(prev => ({\r\n                                        ...prev,\r\n                                        [serviceType]: {\r\n                                          ...currentProviders,\r\n                                          [providerName]: {\r\n                                            ...displayProvider,\r\n                                            model: newValue,\r\n                                          },\r\n                                        },\r\n                                      }));\r\n                                      \r\n                                      // Debounce server sync\r\n                                      const timeoutKey = `${serviceType}-${providerName}-model`;\r\n                                      if (debounceTimeouts.current[timeoutKey]) {\r\n                                        clearTimeout(debounceTimeouts.current[timeoutKey]);\r\n                                      }\r\n                                      debounceTimeouts.current[timeoutKey] = setTimeout(() => {\r\n                                        const webSearch = {\r\n                                          ...(config?.config?.webSearch || {}),\r\n                                          customProviders: {\r\n                                            ...currentProviders,\r\n                                            [providerName]: {\r\n                                              ...displayProvider,\r\n                                              model: newValue,\r\n                                            },\r\n                                          },\r\n                                        };\r\n                                        updateConfigMutation.mutate({\r\n                                          service: serviceType,\r\n                                          updates: {\r\n                                            config: {\r\n                                              ...config?.config,\r\n                                              webSearch,\r\n                                            },\r\n                                          },\r\n                                        });\r\n                                        delete debounceTimeouts.current[timeoutKey];\r\n                                      }, 500);\r\n                                    }}\r\n                                  />\r\n                                </div>\r\n                                <div className=\"space-y-2\">\r\n                                  <Label htmlFor={`${serviceType}-custom-${providerName}-desc`}>Description (Optional)</Label>\r\n                                  <Input\r\n                                    id={`${serviceType}-custom-${providerName}-desc`}\r\n                                    type=\"text\"\r\n                                    placeholder=\"Brief description of this provider\"\r\n                                    value={displayProvider.description || ''}\r\n                                    onChange={(e) => {\r\n                                      const currentProviders = customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {};\r\n                                      const newValue = e.target.value;\r\n                                      \r\n                                      // Update local state immediately\r\n                                      setCustomProvidersLocal(prev => ({\r\n                                        ...prev,\r\n                                        [serviceType]: {\r\n                                          ...currentProviders,\r\n                                          [providerName]: {\r\n                                            ...displayProvider,\r\n                                            description: newValue,\r\n                                          },\r\n                                        },\r\n                                      }));\r\n                                      \r\n                                      // Debounce server sync\r\n                                      const timeoutKey = `${serviceType}-${providerName}-description`;\r\n                                      if (debounceTimeouts.current[timeoutKey]) {\r\n                                        clearTimeout(debounceTimeouts.current[timeoutKey]);\r\n                                      }\r\n                                      debounceTimeouts.current[timeoutKey] = setTimeout(() => {\r\n                                        const webSearch = {\r\n                                          ...(config?.config?.webSearch || {}),\r\n                                          customProviders: {\r\n                                            ...currentProviders,\r\n                                            [providerName]: {\r\n                                              ...displayProvider,\r\n                                              description: newValue,\r\n                                            },\r\n                                          },\r\n                                        };\r\n                                        updateConfigMutation.mutate({\r\n                                          service: serviceType,\r\n                                          updates: {\r\n                                            config: {\r\n                                              ...config?.config,\r\n                                              webSearch,\r\n                                            },\r\n                                          },\r\n                                        });\r\n                                        delete debounceTimeouts.current[timeoutKey];\r\n                                      }, 500);\r\n                                    }}\r\n                                  />\r\n                                </div>\r\n                              </CardContent>\r\n                            </Card>\r\n                          );\r\n                        })}\r\n\r\n                        {Object.keys(customProvidersLocal[serviceType] || config?.config?.webSearch?.customProviders || {}).length === 0 && (\r\n                          <div className=\"text-center py-8 text-sm text-muted-foreground border border-dashed rounded-lg\">\r\n                            No custom providers added yet. Click \"Add Provider\" to add one.\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  </>\r\n                )}\r\n\r\n                <div className=\"space-y-2\">\r\n                  <Label htmlFor={`${serviceType}-rate-limit`}>Rate Limit (requests/min)</Label>\r\n                  <Input\r\n                    id={`${serviceType}-rate-limit`}\r\n                    type=\"number\"\r\n                    placeholder=\"60\"\r\n                    value={config?.config?.rateLimit || ''}\r\n                    onChange={(e) => {\r\n                      updateConfigMutation.mutate({\r\n                        service: serviceType,\r\n                        updates: {\r\n                          config: {\r\n                            ...config?.config,\r\n                            rateLimit: parseInt(e.target.value) || 60,\r\n                          },\r\n                        },\r\n                      });\r\n                    }}\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"flex gap-2 pt-2\">\r\n                  <Button\r\n                    size=\"sm\"\r\n                    onClick={() => {\r\n                      updateConfigMutation.mutate({\r\n                        service: serviceType,\r\n                        updates: { config: config?.config || {}, enabled: isEnabled },\r\n                      })\r\n                    }}\r\n                    disabled={updateConfigMutation.isPending}\r\n                  >\r\n                    <Save className=\"mr-2 h-4 w-4\" />\r\n                    Save\r\n                  </Button>\r\n                  <Dialog>\r\n                    <DialogTrigger asChild>\r\n                      <Button variant=\"outline\" size=\"sm\" onClick={() => setSelectedService(serviceType)}>\r\n                        <Settings className=\"mr-2 h-4 w-4\" />\r\n                        Advanced\r\n                      </Button>\r\n                    </DialogTrigger>\r\n                    <DialogContent className=\"max-w-2xl\">\r\n                      <DialogHeader>\r\n                        <DialogTitle>{info.name} - Advanced Configuration</DialogTitle>\r\n                        <DialogDescription>\r\n                          Edit the JSON configuration for advanced settings\r\n                        </DialogDescription>\r\n                      </DialogHeader>\r\n                      <div className=\"space-y-4\">\r\n                        <Textarea\r\n                          className=\"font-mono text-sm\"\r\n                          rows={12}\r\n                          value={pendingAdvanced[serviceType] ?? JSON.stringify(config?.config || {}, null, 2)}\r\n                          onChange={(e) => setPendingAdvanced((prev) => ({ ...prev, [serviceType]: e.target.value }))}\r\n                          placeholder=\"{}\"\r\n                        />\r\n                        <Button\r\n                          onClick={() => {\r\n                            try {\r\n                              const raw = pendingAdvanced[serviceType] ?? JSON.stringify(config?.config || {}, null, 2)\r\n                              const parsed = JSON.parse(raw)\r\n                              updateConfigMutation.mutate({\r\n                                service: serviceType,\r\n                                updates: { config: parsed },\r\n                              })\r\n                              toast.success('Advanced configuration saved')\r\n                            } catch (e: any) {\r\n                              toast.error(`Invalid JSON: ${e?.message || ''}`)\r\n                            }\r\n                          }}\r\n                        >\r\n                          <Save className=\"mr-2 h-4 w-4\" />\r\n                          Save Configuration\r\n                        </Button>\r\n                      </div>\r\n                    </DialogContent>\r\n                  </Dialog>\r\n\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => testConnectionMutation.mutate({ service: serviceType, config: config?.config || {} })}\r\n                    disabled={testConnectionMutation.isPending}\r\n                  >\r\n                    {testConnectionMutation.isPending ? (\r\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                    ) : (\r\n                      <TestTube className=\"mr-2 h-4 w-4\" />\r\n                    )}\r\n                    Test Connection\r\n                  </Button>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      {/* Test Result Dialog */}\r\n      <Dialog open={isTestDialogOpen} onOpenChange={setIsTestDialogOpen}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-2\">\r\n              {testResult?.success ? (\r\n                <>\r\n                  <CheckCircle className=\"h-5 w-5 text-green-600\" />\r\n                  Connection Successful\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <XCircle className=\"h-5 w-5 text-red-600\" />\r\n                  Connection Failed\r\n                </>\r\n              )}\r\n            </DialogTitle>\r\n            <DialogDescription>{testResult?.message}</DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"flex justify-end\">\r\n            <Button onClick={() => setIsTestDialogOpen(false)}>Close</Button>\r\n          </div>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\admin\\ConversationHistory.tsx","messages":[{"ruleId":"jsx-a11y/no-static-element-interactions","severity":2,"message":"Avoid non-native interactive elements. If using native HTML is not possible, add an appropriate role and support for tabbing, mouse, keyboard, and touch inputs to an interactive content element.","line":476,"column":21,"nodeType":"JSXOpeningElement","endLine":484,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useMemo, useCallback } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Separator } from '@/components/ui/separator';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport {\n  Search,\n  MessageSquare,\n  User,\n  Bot,\n  Calendar,\n  Download,\n  Trash2,\n  Filter,\n  ChevronRight,\n  MoreVertical,\n  Loader2,\n  History,\n  Copy,\n  ExternalLink,\n  X,\n} from 'lucide-react';\nimport { format, formatDistanceToNow, isToday, isYesterday, startOfDay, endOfDay } from 'date-fns';\nimport { toast } from 'sonner';\nimport { cn } from '@/lib/utils';\n\ninterface ConversationMessage {\n  id: string;\n  org_id: string;\n  user_id: string;\n  conversation_id: string;\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n  context?: Record<string, any>;\n  created_at: string;\n}\n\ninterface ConversationSummary {\n  conversation_id: string;\n  user_id: string;\n  user_email?: string;\n  message_count: number;\n  first_message: string;\n  last_message: string;\n  created_at: string;\n  last_updated: string;\n  messages?: ConversationMessage[];\n}\n\ninterface ConversationResponse {\n  conversations: ConversationSummary[];\n  total: number;\n}\n\ninterface SearchHighlight {\n  text: string;\n  highlight: boolean;\n}\n\nconst highlightSearchTerm = (text: string, searchTerm: string): SearchHighlight[] => {\n  if (!searchTerm) return [{ text, highlight: false }];\n\n  const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')})`, 'gi');\n  const parts = text.split(regex);\n\n  return parts.map((part, index) => ({\n    text: part,\n    highlight: index % 2 === 1,\n  }));\n};\n\nconst formatDate = (dateString: string): string => {\n  const date = new Date(dateString);\n\n  if (isToday(date)) {\n    return `Today at ${format(date, 'HH:mm')}`;\n  }\n\n  if (isYesterday(date)) {\n    return `Yesterday at ${format(date, 'HH:mm')}`;\n  }\n\n  return format(date, 'PPp');\n};\n\nconst formatRelativeTime = (dateString: string): string => {\n  return formatDistanceToNow(new Date(dateString), { addSuffix: true });\n};\n\nexport default function ConversationHistory() {\n  const queryClient = useQueryClient();\n  const [searchQuery, setSearchQuery] = useState('');\n  const [selectedConversation, setSelectedConversation] = useState<ConversationSummary | null>(null);\n  const [dateFilter, setDateFilter] = useState<string>('all');\n  const [userFilter, setUserFilter] = useState<string>('all');\n  const [exportFormat, setExportFormat] = useState<'json' | 'csv'>('json');\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [conversationToDelete, setConversationToDelete] = useState<string | null>(null);\n  const [expandedMessages, setExpandedMessages] = useState<Set<string>>(new Set());\n\n  // Fetch conversations\n  const { data, isLoading, error, refetch } = useQuery<ConversationResponse>({\n    queryKey: ['ai-conversations', dateFilter, userFilter, searchQuery],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n\n      if (dateFilter !== 'all') {\n        const now = new Date();\n        let fromDate: Date;\n\n        switch (dateFilter) {\n          case 'today':\n            fromDate = startOfDay(now);\n            break;\n          case 'week':\n            fromDate = new Date(now.setDate(now.getDate() - 7));\n            break;\n          case 'month':\n            fromDate = new Date(now.setMonth(now.getMonth() - 1));\n            break;\n          default:\n            fromDate = new Date(0);\n        }\n\n        params.append('fromDate', fromDate.toISOString());\n        params.append('toDate', endOfDay(new Date()).toISOString());\n      }\n\n      if (userFilter !== 'all') {\n        params.append('userId', userFilter);\n      }\n\n      if (searchQuery) {\n        params.append('search', searchQuery);\n      }\n\n      const response = await fetch(`/api/v1/ai/conversations?${params}`);\n      if (!response.ok) throw new Error('Failed to fetch conversations');\n\n      const result = await response.json();\n      return result.data || { conversations: [], total: 0 };\n    },\n    refetchInterval: 60000, // Refetch every minute\n  });\n\n  // Fetch full conversation details\n  const { data: conversationDetails, isLoading: isLoadingDetails } = useQuery<ConversationMessage[]>({\n    queryKey: ['ai-conversation-details', selectedConversation?.conversation_id],\n    queryFn: async () => {\n      if (!selectedConversation?.conversation_id) return [];\n\n      const response = await fetch(`/api/v1/ai/conversations/${selectedConversation.conversation_id}`);\n      if (!response.ok) throw new Error('Failed to fetch conversation details');\n\n      const result = await response.json();\n      return result.data || [];\n    },\n    enabled: !!selectedConversation?.conversation_id,\n  });\n\n  // Get unique users for filter\n  const uniqueUsers = useMemo(() => {\n    if (!data?.conversations) return [];\n\n    const users = new Map<string, string>();\n    data.conversations.forEach(conv => {\n      if (!users.has(conv.user_id)) {\n        users.set(conv.user_id, conv.user_email || conv.user_id);\n      }\n    });\n\n    return Array.from(users.entries()).map(([id, email]) => ({ id, email }));\n  }, [data?.conversations]);\n\n  // Delete conversation mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (conversationId: string) => {\n      const response = await fetch(`/api/v1/ai/conversations/${conversationId}`, {\n        method: 'DELETE',\n      });\n      if (!response.ok) throw new Error('Failed to delete conversation');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ai-conversations'] });\n      toast.success('Conversation deleted successfully');\n      setShowDeleteDialog(false);\n      setConversationToDelete(null);\n      if (selectedConversation?.conversation_id === conversationToDelete) {\n        setSelectedConversation(null);\n      }\n    },\n    onError: (error: Error) => {\n      toast.error(`Failed to delete: ${error.message}`);\n    },\n  });\n\n  // Export conversation\n  const handleExport = useCallback((conversation: ConversationSummary) => {\n    const exportData = {\n      conversation_id: conversation.conversation_id,\n      user_id: conversation.user_id,\n      created_at: conversation.created_at,\n      last_updated: conversation.last_updated,\n      message_count: conversation.message_count,\n      messages: conversationDetails || [],\n    };\n\n    let content: string;\n    let filename: string;\n    let mimeType: string;\n\n    if (exportFormat === 'json') {\n      content = JSON.stringify(exportData, null, 2);\n      filename = `conversation_${conversation.conversation_id}_${format(new Date(), 'yyyy-MM-dd')}.json`;\n      mimeType = 'application/json';\n    } else {\n      // CSV export\n      const csvRows = ['Timestamp,Role,Message'];\n\n      (conversationDetails || []).forEach(msg => {\n        const escapedContent = msg.content.replace(/\"/g, '\"\"');\n        csvRows.push(`\"${msg.created_at}\",\"${msg.role}\",\"${escapedContent}\"`);\n      });\n\n      content = csvRows.join('\\n');\n      filename = `conversation_${conversation.conversation_id}_${format(new Date(), 'yyyy-MM-dd')}.csv`;\n      mimeType = 'text/csv';\n    }\n\n    const blob = new Blob([content], { type: mimeType });\n    const url = URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n\n    toast.success(`Conversation exported as ${exportFormat.toUpperCase()}`);\n  }, [conversationDetails, exportFormat]);\n\n  // Copy message content\n  const handleCopyMessage = useCallback((content: string) => {\n    navigator.clipboard.writeText(content);\n    toast.success('Message copied to clipboard');\n  }, []);\n\n  // Toggle message expansion\n  const toggleMessageExpansion = useCallback((messageId: string) => {\n    setExpandedMessages(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(messageId)) {\n        newSet.delete(messageId);\n      } else {\n        newSet.add(messageId);\n      }\n      return newSet;\n    });\n  }, []);\n\n  // Filter conversations based on search\n  const filteredConversations = useMemo(() => {\n    if (!data?.conversations) return [];\n\n    if (!searchQuery) return data.conversations;\n\n    const query = searchQuery.toLowerCase();\n    return data.conversations.filter(conv =>\n      conv.first_message.toLowerCase().includes(query) ||\n      conv.last_message.toLowerCase().includes(query) ||\n      conv.conversation_id.toLowerCase().includes(query) ||\n      conv.user_email?.toLowerCase().includes(query)\n    );\n  }, [data?.conversations, searchQuery]);\n\n  if (error) {\n    return (\n      <Card>\n        <CardContent className=\"flex items-center justify-center p-12\">\n          <div className=\"text-center\">\n            <p className=\"text-destructive mb-2\">Failed to load conversations</p>\n            <Button onClick={() => refetch()}>Retry</Button>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold tracking-tight\">Conversation History</h2>\n          <p className=\"text-muted-foreground\">\n            View and manage AI conversation logs and history\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge variant=\"outline\" className=\"gap-1\">\n            <History className=\"h-3 w-3\" />\n            {data?.total || 0} Conversations\n          </Badge>\n        </div>\n      </div>\n\n      {/* Statistics */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Conversations</CardTitle>\n            <MessageSquare className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{data?.total || 0}</div>\n            <p className=\"text-xs text-muted-foreground\">All time</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Active Today</CardTitle>\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {filteredConversations.filter(c => isToday(new Date(c.last_updated))).length}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Updated today</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Unique Users</CardTitle>\n            <User className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{uniqueUsers.length}</div>\n            <p className=\"text-xs text-muted-foreground\">Active users</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Avg Messages</CardTitle>\n            <Bot className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {data?.conversations.length\n                ? Math.round(\n                    data.conversations.reduce((acc, c) => acc + c.message_count, 0) /\n                    data.conversations.length\n                  )\n                : 0}\n            </div>\n            <p className=\"text-xs text-muted-foreground\">Per conversation</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Filters and Search */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Search & Filters</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex gap-4\">\n            <div className=\"flex-1\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search conversations by content, ID, or user...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n            </div>\n\n            <Select value={dateFilter} onValueChange={setDateFilter}>\n              <SelectTrigger className=\"w-[150px]\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Time</SelectItem>\n                <SelectItem value=\"today\">Today</SelectItem>\n                <SelectItem value=\"week\">Last 7 Days</SelectItem>\n                <SelectItem value=\"month\">Last 30 Days</SelectItem>\n              </SelectContent>\n            </Select>\n\n            <Select value={userFilter} onValueChange={setUserFilter}>\n              <SelectTrigger className=\"w-[200px]\">\n                <SelectValue placeholder=\"All Users\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Users</SelectItem>\n                {uniqueUsers.map((user) => (\n                  <SelectItem key={user.id} value={user.id}>\n                    {user.email}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Conversations List and Details */}\n      <div className=\"grid gap-6 lg:grid-cols-5\">\n        {/* Conversation List */}\n        <Card className=\"lg:col-span-2\">\n          <CardHeader>\n            <CardTitle>Conversations</CardTitle>\n            <CardDescription>\n              {filteredConversations.length} conversation{filteredConversations.length !== 1 ? 's' : ''}\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            <ScrollArea className=\"h-[600px]\">\n              <div className=\"space-y-1 p-4\">\n                {filteredConversations.length === 0 ? (\n                  <div className=\"flex items-center justify-center p-8 text-muted-foreground\">\n                    <p>No conversations found</p>\n                  </div>\n                ) : (\n                  filteredConversations.map((conversation) => (\n                    <div\n                      key={conversation.conversation_id}\n                      className={cn(\n                        \"flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors\",\n                        \"hover:bg-accent\",\n                        selectedConversation?.conversation_id === conversation.conversation_id && \"bg-accent\"\n                      )}\n                      onClick={() => setSelectedConversation(conversation)}\n                    >\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <p className=\"text-sm font-medium truncate\">\n                            {conversation.user_email || conversation.user_id}\n                          </p>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {conversation.message_count} msgs\n                          </Badge>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground truncate\">\n                          {highlightSearchTerm(conversation.last_message, searchQuery).map((part, i) => (\n                            <span key={i} className={part.highlight ? \"bg-yellow-200 dark:bg-yellow-800\" : \"\"}>\n                              {part.text}\n                            </span>\n                          ))}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          {formatRelativeTime(conversation.last_updated)}\n                        </p>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\n                              <MoreVertical className=\"h-4 w-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuLabel>Actions</DropdownMenuLabel>\n                            <DropdownMenuSeparator />\n                            <DropdownMenuItem\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                setSelectedConversation(conversation);\n                              }}\n                            >\n                              <ExternalLink className=\"mr-2 h-4 w-4\" />\n                              View Details\n                            </DropdownMenuItem>\n                            <DropdownMenuItem\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                handleExport(conversation);\n                              }}\n                            >\n                              <Download className=\"mr-2 h-4 w-4\" />\n                              Export\n                            </DropdownMenuItem>\n                            <DropdownMenuItem\n                              className=\"text-destructive\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                setConversationToDelete(conversation.conversation_id);\n                                setShowDeleteDialog(true);\n                              }}\n                            >\n                              <Trash2 className=\"mr-2 h-4 w-4\" />\n                              Delete\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </div>\n                    </div>\n                  ))\n                )}\n              </div>\n            </ScrollArea>\n          </CardContent>\n        </Card>\n\n        {/* Conversation Details */}\n        <Card className=\"lg:col-span-3\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <CardTitle>Conversation Thread</CardTitle>\n                {selectedConversation && (\n                  <CardDescription>\n                    ID: {selectedConversation.conversation_id}\n                  </CardDescription>\n                )}\n              </div>\n              {selectedConversation && (\n                <div className=\"flex items-center gap-2\">\n                  <Select value={exportFormat} onValueChange={(v) => setExportFormat(v as 'json' | 'csv')}>\n                    <SelectTrigger className=\"w-[100px]\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"json\">JSON</SelectItem>\n                      <SelectItem value=\"csv\">CSV</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleExport(selectedConversation)}\n                  >\n                    <Download className=\"mr-2 h-4 w-4\" />\n                    Export\n                  </Button>\n                </div>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            {!selectedConversation ? (\n              <div className=\"flex items-center justify-center p-12 text-muted-foreground\">\n                <p>Select a conversation to view details</p>\n              </div>\n            ) : isLoadingDetails ? (\n              <div className=\"flex items-center justify-center p-12\">\n                <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n              </div>\n            ) : (\n              <ScrollArea className=\"h-[550px]\">\n                <div className=\"p-4 space-y-4\">\n                  {/* Conversation Metadata */}\n                  <div className=\"bg-muted/50 rounded-lg p-4 space-y-2\">\n                    <div className=\"grid gap-4 md:grid-cols-2\">\n                      <div>\n                        <Label className=\"text-xs text-muted-foreground\">User</Label>\n                        <p className=\"text-sm font-medium\">\n                          {selectedConversation.user_email || selectedConversation.user_id}\n                        </p>\n                      </div>\n                      <div>\n                        <Label className=\"text-xs text-muted-foreground\">Messages</Label>\n                        <p className=\"text-sm font-medium\">{selectedConversation.message_count}</p>\n                      </div>\n                      <div>\n                        <Label className=\"text-xs text-muted-foreground\">Started</Label>\n                        <p className=\"text-sm font-medium\">\n                          {formatDate(selectedConversation.created_at)}\n                        </p>\n                      </div>\n                      <div>\n                        <Label className=\"text-xs text-muted-foreground\">Last Activity</Label>\n                        <p className=\"text-sm font-medium\">\n                          {formatDate(selectedConversation.last_updated)}\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n\n                  <Separator />\n\n                  {/* Messages Timeline */}\n                  <div className=\"space-y-4\">\n                    {conversationDetails?.map((message, index) => {\n                      const isExpanded = expandedMessages.has(message.id);\n                      const isLongMessage = message.content.length > 300;\n                      const displayContent = isLongMessage && !isExpanded\n                        ? message.content.slice(0, 300) + '...'\n                        : message.content;\n\n                      return (\n                        <div\n                          key={message.id}\n                          className={cn(\n                            \"flex gap-3 p-4 rounded-lg\",\n                            message.role === 'user'\n                              ? \"bg-blue-50 dark:bg-blue-950/20\"\n                              : message.role === 'assistant'\n                              ? \"bg-green-50 dark:bg-green-950/20\"\n                              : \"bg-gray-50 dark:bg-gray-950/20\"\n                          )}\n                        >\n                          <div className=\"flex-shrink-0\">\n                            {message.role === 'user' ? (\n                              <div className=\"h-8 w-8 rounded-full bg-blue-600 flex items-center justify-center\">\n                                <User className=\"h-4 w-4 text-white\" />\n                              </div>\n                            ) : message.role === 'assistant' ? (\n                              <div className=\"h-8 w-8 rounded-full bg-green-600 flex items-center justify-center\">\n                                <Bot className=\"h-4 w-4 text-white\" />\n                              </div>\n                            ) : (\n                              <div className=\"h-8 w-8 rounded-full bg-gray-600 flex items-center justify-center\">\n                                <MessageSquare className=\"h-4 w-4 text-white\" />\n                              </div>\n                            )}\n                          </div>\n\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-start justify-between mb-2\">\n                              <div>\n                                <p className=\"text-sm font-medium capitalize\">{message.role}</p>\n                                <p className=\"text-xs text-muted-foreground\">\n                                  {formatDate(message.created_at)}\n                                </p>\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                className=\"h-6 w-6\"\n                                onClick={() => handleCopyMessage(message.content)}\n                              >\n                                <Copy className=\"h-3 w-3\" />\n                              </Button>\n                            </div>\n\n                            <div className=\"prose prose-sm max-w-none dark:prose-invert\">\n                              <p className=\"whitespace-pre-wrap break-words\">\n                                {highlightSearchTerm(displayContent, searchQuery).map((part, i) => (\n                                  <span key={i} className={part.highlight ? \"bg-yellow-200 dark:bg-yellow-800\" : \"\"}>\n                                    {part.text}\n                                  </span>\n                                ))}\n                              </p>\n\n                              {isLongMessage && (\n                                <Button\n                                  variant=\"link\"\n                                  size=\"sm\"\n                                  className=\"p-0 h-auto font-normal text-xs\"\n                                  onClick={() => toggleMessageExpansion(message.id)}\n                                >\n                                  {isExpanded ? 'Show less' : 'Show more'}\n                                </Button>\n                              )}\n                            </div>\n\n                            {message.context && Object.keys(message.context).length > 0 && (\n                              <div className=\"mt-3\">\n                                <details className=\"group\">\n                                  <summary className=\"cursor-pointer text-xs text-muted-foreground hover:text-foreground\">\n                                    View context ({Object.keys(message.context).length} items)\n                                  </summary>\n                                  <pre className=\"mt-2 p-2 bg-muted rounded text-xs overflow-auto max-h-32\">\n                                    {JSON.stringify(message.context, null, 2)}\n                                  </pre>\n                                </details>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </div>\n              </ScrollArea>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Conversation</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete this conversation? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"flex justify-end gap-2 mt-4\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowDeleteDialog(false);\n                setConversationToDelete(null);\n              }}\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => {\n                if (conversationToDelete) {\n                  deleteMutation.mutate(conversationToDelete);\n                }\n              }}\n              disabled={deleteMutation.isPending}\n            >\n              {deleteMutation.isPending && (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              )}\n              Delete\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\admin\\DashboardBuilder.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":335,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":335,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport GridLayout, { Layout } from 'react-grid-layout';\nimport 'react-grid-layout/css/styles.css';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from '@/components/ui/dialog';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport { Switch } from '@/components/ui/switch';\nimport {\n  LayoutDashboard,\n  Plus,\n  Save,\n  Share2,\n  Trash2,\n  GripVertical,\n  BarChart3,\n  TrendingUp,\n  Table as TableIcon,\n  AlertCircle,\n  Loader2,\n} from 'lucide-react';\nimport { toast } from 'sonner';\n\ninterface Dashboard {\n  id: string;\n  org_id: string;\n  name: string;\n  description?: string;\n  layout: Layout[];\n  filters?: Record<string, any>;\n  is_default: boolean;\n  is_shared: boolean;\n  created_by: string;\n  created_at: string;\n  updated_at: string;\n  widgets?: Widget[];\n}\n\ninterface Widget {\n  id: string;\n  org_id: string;\n  dashboard_id: string;\n  widget_type: string;\n  metric_type: string;\n  config: Record<string, any>;\n  query: Record<string, any>;\n  refresh_interval_seconds: number;\n  position_x: number;\n  position_y: number;\n  width: number;\n  height: number;\n  created_at: string;\n  updated_at: string;\n}\n\nconst WIDGET_LIBRARY = [\n  { type: 'metric_card', icon: TrendingUp, label: 'Metric Card', color: 'text-blue-600' },\n  { type: 'line_chart', icon: BarChart3, label: 'Line Chart', color: 'text-green-600' },\n  { type: 'bar_chart', icon: BarChart3, label: 'Bar Chart', color: 'text-purple-600' },\n  { type: 'pie_chart', icon: BarChart3, label: 'Pie Chart', color: 'text-orange-600' },\n  { type: 'table', icon: TableIcon, label: 'Data Table', color: 'text-cyan-600' },\n  { type: 'alert_list', icon: AlertCircle, label: 'Alert List', color: 'text-red-600' },\n];\n\ninterface DashboardBuilderProps {\n  dashboardId?: string;\n}\n\nexport default function DashboardBuilder({ dashboardId }: DashboardBuilderProps = {}) {\n  const queryClient = useQueryClient();\n  const [selectedDashboardId, setSelectedDashboardId] = useState<string>(dashboardId || '');\n  const [layout, setLayout] = useState<Layout[]>([]);\n  const [isCreating, setIsCreating] = useState(false);\n  const [newDashboard, setNewDashboard] = useState({\n    name: '',\n    description: '',\n    isPublic: false,\n  });\n\n  // Fetch dashboards\n  const { data: dashboardsResponse, isLoading } = useQuery<{\n    data: Dashboard[];\n    metadata: { total: number; page: number; limit: number; hasMore: boolean };\n  }>({\n    queryKey: ['ai-dashboards'],\n    queryFn: async () => {\n      const response = await fetch('/api/v1/ai/dashboards?includeWidgets=false&limit=100');\n      if (!response.ok) throw new Error('Failed to fetch dashboards');\n      return response.json();\n    },\n  });\n\n  const dashboards = dashboardsResponse?.data || [];\n\n  // Fetch widgets for selected dashboard\n  const { data: widgetsResponse } = useQuery<{\n    data: { dashboardId: string; widgets: Widget[]; totalWidgets: number };\n  }>({\n    queryKey: ['ai-widgets', selectedDashboardId],\n    queryFn: async () => {\n      if (!selectedDashboardId) return { data: { dashboardId: '', widgets: [], totalWidgets: 0 } };\n      const response = await fetch(`/api/v1/ai/widgets/dashboard/${selectedDashboardId}`);\n      if (!response.ok) throw new Error('Failed to fetch widgets');\n      return response.json();\n    },\n    enabled: !!selectedDashboardId,\n  });\n\n  const widgets = widgetsResponse?.data?.widgets || [];\n\n  // Create dashboard\n  const createDashboardMutation = useMutation({\n    mutationFn: async (data: typeof newDashboard) => {\n      const response = await fetch('/api/v1/ai/dashboards', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          name: data.name,\n          description: data.description,\n          layout: [],\n          isPublic: data.isPublic,\n        }),\n      });\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || 'Failed to create dashboard');\n      }\n      return response.json();\n    },\n    onSuccess: (responseData) => {\n      queryClient.invalidateQueries({ queryKey: ['ai-dashboards'] });\n      setSelectedDashboardId(responseData.data.id);\n      setIsCreating(false);\n      setNewDashboard({ name: '', description: '', isPublic: false });\n      toast.success('Dashboard created successfully');\n    },\n    onError: (error: Error) => {\n      toast.error(`Failed to create dashboard: ${error.message}`);\n    },\n  });\n\n  // Update dashboard (including layout)\n  const updateDashboardMutation = useMutation({\n    mutationFn: async ({ dashboardId, layout }: { dashboardId: string; layout: Layout[] }) => {\n      const response = await fetch(`/api/v1/ai/dashboards/${dashboardId}`, {\n        method: 'PATCH',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ layout }),\n      });\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || 'Failed to update dashboard');\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ai-dashboards'] });\n      queryClient.invalidateQueries({ queryKey: ['ai-widgets', selectedDashboardId] });\n      toast.success('Layout saved successfully');\n    },\n    onError: (error: Error) => {\n      toast.error(`Failed to save layout: ${error.message}`);\n    },\n  });\n\n  // Delete dashboard\n  const deleteDashboardMutation = useMutation({\n    mutationFn: async (dashboardId: string) => {\n      const response = await fetch(`/api/v1/ai/dashboards/${dashboardId}`, {\n        method: 'DELETE',\n      });\n      if (!response.ok && response.status !== 204) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || 'Failed to delete dashboard');\n      }\n      return true;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ai-dashboards'] });\n      setSelectedDashboardId('');\n      setLayout([]);\n      toast.success('Dashboard deleted successfully');\n    },\n    onError: (error: Error) => {\n      toast.error(`Failed to delete dashboard: ${error.message}`);\n    },\n  });\n\n  // Share dashboard\n  const shareDashboardMutation = useMutation({\n    mutationFn: async ({ dashboardId, makePublic }: { dashboardId: string; makePublic: boolean }) => {\n      const response = await fetch(`/api/v1/ai/dashboards/${dashboardId}/share`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ makePublic }),\n      });\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || 'Failed to share dashboard');\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ai-dashboards'] });\n      toast.success('Dashboard sharing updated successfully');\n    },\n    onError: (error: Error) => {\n      toast.error(`Failed to update sharing: ${error.message}`);\n    },\n  });\n\n  // Create widget\n  const createWidgetMutation = useMutation({\n    mutationFn: async (widgetData: {\n      dashboardId: string;\n      type: string;\n      title: string;\n      config: Record<string, any>;\n      dataSource: { type: string; params: Record<string, any> };\n      refreshInterval?: number;\n    }) => {\n      const response = await fetch('/api/v1/ai/widgets', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(widgetData),\n      });\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || 'Failed to create widget');\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ai-widgets', selectedDashboardId] });\n      queryClient.invalidateQueries({ queryKey: ['ai-dashboards'] });\n      toast.success('Widget created successfully');\n    },\n    onError: (error: Error) => {\n      toast.error(`Failed to create widget: ${error.message}`);\n    },\n  });\n\n  // Delete widget\n  const deleteWidgetMutation = useMutation({\n    mutationFn: async (widgetId: string) => {\n      const response = await fetch(`/api/v1/ai/widgets/${widgetId}`, {\n        method: 'DELETE',\n      });\n      if (!response.ok && response.status !== 204) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || 'Failed to delete widget');\n      }\n      return true;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ai-widgets', selectedDashboardId] });\n      queryClient.invalidateQueries({ queryKey: ['ai-dashboards'] });\n      toast.success('Widget deleted successfully');\n    },\n    onError: (error: Error) => {\n      toast.error(`Failed to delete widget: ${error.message}`);\n    },\n  });\n\n  // Add widget to layout\n  const handleAddWidget = (widgetType: string) => {\n    if (!selectedDashboardId) {\n      toast.error('Please select a dashboard first');\n      return;\n    }\n\n    // Calculate position\n    const x = (layout.length * 3) % 12;\n    const y = Infinity; // Will place at bottom\n\n    // Create widget via API\n    createWidgetMutation.mutate({\n      dashboardId: selectedDashboardId,\n      type: widgetType,\n      title: WIDGET_LIBRARY.find(w => w.type === widgetType)?.label || widgetType,\n      config: {\n        position: { x, y },\n        size: { w: 3, h: 2 },\n        metricType: 'operational',\n      },\n      dataSource: {\n        type: 'mock',\n        params: {},\n      },\n      refreshInterval: 300,\n    });\n\n    // Add to local layout for immediate feedback\n    const newWidget: Layout = {\n      i: `widget-${Date.now()}`,\n      x,\n      y,\n      w: 3,\n      h: 2,\n      minW: 2,\n      minH: 2,\n    };\n\n    setLayout([...layout, newWidget]);\n  };\n\n  // Save layout\n  const handleSaveLayout = () => {\n    if (!selectedDashboardId) return;\n    updateDashboardMutation.mutate({ dashboardId: selectedDashboardId, layout });\n  };\n\n  // Delete dashboard handler\n  const handleDeleteDashboard = (dashboardId: string) => {\n    if (confirm('Are you sure you want to delete this dashboard? This action cannot be undone.')) {\n      deleteDashboardMutation.mutate(dashboardId);\n    }\n  };\n\n  // Handle layout change from grid\n  const handleLayoutChange = (newLayout: Layout[]) => {\n    setLayout(newLayout);\n  };\n\n  const selectedDashboard = dashboards.find((d) => d.id === selectedDashboardId);\n\n  // Initialize layout when dashboard is selected\n  useEffect(() => {\n    if (selectedDashboard) {\n      setLayout(selectedDashboard.layout || []);\n    } else {\n      setLayout([]);\n    }\n  }, [selectedDashboard]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex h-[calc(100vh-200px)] gap-6\">\n      {/* Sidebar - Dashboard List */}\n      <div className=\"w-64 space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-lg font-semibold\">Dashboards</h3>\n          <Dialog open={isCreating} onOpenChange={setIsCreating}>\n            <DialogTrigger asChild>\n              <Button size=\"sm\">\n                <Plus className=\"h-4 w-4\" />\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Create Dashboard</DialogTitle>\n                <DialogDescription>\n                  Create a new dashboard to organize your widgets\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Name</Label>\n                  <Input\n                    id=\"name\"\n                    value={newDashboard.name}\n                    onChange={(e) => setNewDashboard({ ...newDashboard, name: e.target.value })}\n                    placeholder=\"My Dashboard\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"description\">Description</Label>\n                  <Textarea\n                    id=\"description\"\n                    value={newDashboard.description}\n                    onChange={(e) =>\n                      setNewDashboard({ ...newDashboard, description: e.target.value })\n                    }\n                    placeholder=\"Dashboard description...\"\n                    rows={3}\n                  />\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"public\">Public Dashboard</Label>\n                  <Switch\n                    id=\"public\"\n                    checked={newDashboard.isPublic}\n                    onCheckedChange={(checked) =>\n                      setNewDashboard({ ...newDashboard, isPublic: checked })\n                    }\n                  />\n                </div>\n                <Button\n                  onClick={() => createDashboardMutation.mutate(newDashboard)}\n                  disabled={!newDashboard.name || createDashboardMutation.isPending}\n                  className=\"w-full\"\n                >\n                  {createDashboardMutation.isPending && (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  )}\n                  Create Dashboard\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        <ScrollArea className=\"h-[calc(100vh-350px)]\">\n          <div className=\"space-y-2\">\n            {dashboards.length === 0 ? (\n              <p className=\"text-sm text-muted-foreground\">No dashboards yet</p>\n            ) : (\n              dashboards.map((dashboard) => (\n                <Card\n                  key={dashboard.id}\n                  className={`cursor-pointer transition-colors ${\n                    selectedDashboardId === dashboard.id\n                      ? 'border-primary bg-primary/5'\n                      : 'hover:bg-muted/50'\n                  }`}\n                  onClick={() => setSelectedDashboardId(dashboard.id)}\n                >\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <h4 className=\"font-medium\">{dashboard.name}</h4>\n                        {dashboard.description && (\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {dashboard.description}\n                          </p>\n                        )}\n                      </div>\n                      <LayoutDashboard className=\"h-4 w-4 text-muted-foreground\" />\n                    </div>\n                  </CardContent>\n                </Card>\n              ))\n            )}\n          </div>\n        </ScrollArea>\n\n        {/* Widget Library */}\n        {selectedDashboardId && (\n          <div className=\"space-y-2\">\n            <h3 className=\"text-sm font-semibold\">Widget Library</h3>\n            <ScrollArea className=\"h-64\">\n              <div className=\"space-y-2\">\n                {WIDGET_LIBRARY.map((widget) => {\n                  const Icon = widget.icon;\n                  return (\n                    <Button\n                      key={widget.type}\n                      variant=\"outline\"\n                      className=\"w-full justify-start\"\n                      onClick={() => handleAddWidget(widget.type)}\n                    >\n                      <Icon className={`mr-2 h-4 w-4 ${widget.color}`} />\n                      {widget.label}\n                    </Button>\n                  );\n                })}\n              </div>\n            </ScrollArea>\n          </div>\n        )}\n      </div>\n\n      {/* Main Canvas */}\n      <div className=\"flex-1 space-y-4\">\n        {selectedDashboard ? (\n          <>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h2 className=\"text-2xl font-bold\">{selectedDashboard.name}</h2>\n                {selectedDashboard.description && (\n                  <p className=\"text-sm text-muted-foreground\">{selectedDashboard.description}</p>\n                )}\n              </div>\n              <div className=\"flex gap-2\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() =>\n                    shareDashboardMutation.mutate({\n                      dashboardId: selectedDashboard.id,\n                      makePublic: !selectedDashboard.is_shared,\n                    })\n                  }\n                  disabled={shareDashboardMutation.isPending}\n                >\n                  <Share2 className=\"mr-2 h-4 w-4\" />\n                  {selectedDashboard.is_shared ? 'Make Private' : 'Share'}\n                </Button>\n                <Button\n                  onClick={handleSaveLayout}\n                  disabled={updateDashboardMutation.isPending}\n                >\n                  {updateDashboardMutation.isPending ? (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  ) : (\n                    <Save className=\"mr-2 h-4 w-4\" />\n                  )}\n                  Save Layout\n                </Button>\n                <Button\n                  variant=\"destructive\"\n                  onClick={() => handleDeleteDashboard(selectedDashboard.id)}\n                  disabled={deleteDashboardMutation.isPending}\n                >\n                  {deleteDashboardMutation.isPending ? (\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  ) : (\n                    <Trash2 className=\"mr-2 h-4 w-4\" />\n                  )}\n                  Delete\n                </Button>\n              </div>\n            </div>\n\n            <Card className=\"min-h-[600px]\">\n              <CardContent className=\"p-4\">\n                {layout.length === 0 ? (\n                  <div className=\"flex items-center justify-center h-[500px]\">\n                    <div className=\"text-center\">\n                      <LayoutDashboard className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                      <h3 className=\"text-lg font-medium mb-2\">Empty Dashboard</h3>\n                      <p className=\"text-sm text-muted-foreground mb-4\">\n                        Add widgets from the library to get started\n                      </p>\n                    </div>\n                  </div>\n                ) : (\n                  <GridLayout\n                    className=\"layout\"\n                    layout={layout}\n                    cols={12}\n                    rowHeight={80}\n                    width={1200}\n                    onLayoutChange={handleLayoutChange}\n                    draggableHandle=\".drag-handle\"\n                    compactType=\"vertical\"\n                  >\n                    {layout.map((item) => (\n                      <div key={item.i} className=\"bg-white border-2 border-dashed border-muted rounded-lg\">\n                        <Card className=\"h-full\">\n                          <CardHeader className=\"p-3 flex flex-row items-center justify-between space-y-0\">\n                            <div className=\"flex items-center gap-2\">\n                              <GripVertical className=\"h-4 w-4 drag-handle cursor-move text-muted-foreground\" />\n                              <CardTitle className=\"text-sm\">Widget {item.i}</CardTitle>\n                            </div>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => setLayout(layout.filter((l) => l.i !== item.i))}\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                            </Button>\n                          </CardHeader>\n                          <CardContent className=\"p-3\">\n                            <div className=\"flex items-center justify-center h-full text-muted-foreground text-sm\">\n                              Configure this widget\n                            </div>\n                          </CardContent>\n                        </Card>\n                      </div>\n                    ))}\n                  </GridLayout>\n                )}\n              </CardContent>\n            </Card>\n          </>\n        ) : (\n          <div className=\"flex items-center justify-center h-full\">\n            <div className=\"text-center\">\n              <LayoutDashboard className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n              <h3 className=\"text-xl font-medium mb-2\">No Dashboard Selected</h3>\n              <p className=\"text-muted-foreground mb-4\">\n                Select a dashboard from the sidebar or create a new one\n              </p>\n              <Button onClick={() => setIsCreating(true)}>\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Create Dashboard\n              </Button>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\admin\\UnifiedServicePanel.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":797,"column":39,"nodeType":"Identifier","messageId":"undef","endLine":797,"endColumn":46}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useState } from 'react';\r\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Switch } from '@/components/ui/switch';\r\nimport { toast } from 'sonner';\r\nimport { Trash2, Plus, Star, Edit2, CheckCircle2, XCircle } from 'lucide-react';\r\n\r\ntype ProviderKey = 'openai' | 'anthropic' | 'openai_compatible' | 'serper' | 'tavily' | 'google_search';\r\ntype ServiceType = 'demand_forecasting' | 'anomaly_detection' | 'supplier_scoring' | 'chatbot' | 'supplier_discovery';\r\n\r\ninterface AIServiceConfig {\r\n  id: string;\r\n  service_type: ServiceType;\r\n  config: any;\r\n  enabled: boolean;\r\n}\r\n\r\ninterface ProviderInstance {\r\n  id: string;\r\n  provider: ProviderKey;\r\n  baseUrl: string;\r\n  apiKey: string;\r\n  model?: string; // Optional for web search providers\r\n  enabled: boolean;\r\n  connected?: boolean;\r\n  // Web search specific fields\r\n  googleSearchEngineId?: string; // For Google Search provider\r\n}\r\n\r\nconst SERVICE_INFO: Record<ServiceType, { name: string; description: string; icon: string }> = {\r\n  demand_forecasting: {\r\n    name: 'Demand Forecasting',\r\n    description: 'Predict future product demand using historical data',\r\n    icon: '📊',\r\n  },\r\n  anomaly_detection: {\r\n    name: 'Anomaly Detection',\r\n    description: 'Detect unusual patterns in sales and inventory',\r\n    icon: '🔍',\r\n  },\r\n  supplier_scoring: {\r\n    name: 'Supplier Scoring',\r\n    description: 'Evaluate supplier performance and reliability',\r\n    icon: '⭐',\r\n  },\r\n  chatbot: {\r\n    name: 'AI Assistant',\r\n    description: 'Conversational AI for business insights',\r\n    icon: '💬',\r\n  },\r\n  supplier_discovery: {\r\n    name: 'Supplier Discovery',\r\n    description: 'Discover and analyze potential suppliers',\r\n    icon: '🌐',\r\n  },\r\n};\r\n\r\nfunction useConfigs() {\r\n  return useQuery<AIServiceConfig[]>({\r\n    queryKey: ['ai-configs'],\r\n    queryFn: async () => {\r\n      const res = await fetch('/api/v1/ai/config');\r\n      if (!res.ok) throw new Error(await res.text());\r\n      const data = await res.json();\r\n      return data.data || [];\r\n    },\r\n  });\r\n}\r\n\r\nexport default function UnifiedServicePanel() {\r\n  const queryClient = useQueryClient();\r\n  const { data: configs = [] } = useConfigs();\r\n  \r\n  // Form state for adding a new provider instance per service\r\n  const [newProviderForms, setNewProviderForms] = useState<Record<string, {\r\n    provider: ProviderKey;\r\n    baseUrl: string;\r\n    apiKey: string;\r\n    model: string;\r\n    googleSearchEngineId?: string; // For Google Search provider\r\n  }>>({});\r\n\r\n  // Edit mode state\r\n  const [editingInstance, setEditingInstance] = useState<string | null>(null);\r\n  const [editForm, setEditForm] = useState<{\r\n    provider: ProviderKey;\r\n    baseUrl: string;\r\n    apiKey: string;\r\n    model: string;\r\n    googleSearchEngineId?: string;\r\n  } | null>(null);\r\n\r\n  const updateConfig = useMutation({\r\n    mutationFn: async ({ serviceType, payload }: { serviceType: ServiceType; payload: any }) => {\r\n      const res = await fetch(`/api/v1/ai/config/${serviceType}`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!res.ok) throw new Error(await res.text());\r\n      const data = await res.json();\r\n      return { serviceType, data };\r\n    },\r\n    onSuccess: ({ data, serviceType }) => {\r\n      // Update cache with server response instead of refetching\r\n      queryClient.setQueryData(['ai-configs'], (old: AIServiceConfig[] | undefined) => {\r\n        const updatedConfig = data?.data;\r\n        if (!updatedConfig) {\r\n          console.warn('⚠️ No updated config in server response:', data);\r\n          // If server response is bad, invalidate to force refetch\r\n          queryClient.invalidateQueries({ queryKey: ['ai-configs'] });\r\n          return old || [];\r\n        }\r\n        \r\n        if (!old) {\r\n          return [updatedConfig];\r\n        }\r\n        \r\n        // Find and replace by service_type (handles both temp IDs and real IDs)\r\n        const existingIndex = old.findIndex(c => c.service_type === updatedConfig.service_type);\r\n        if (existingIndex >= 0) {\r\n          // Replace existing config with server response (server is source of truth)\r\n          return old.map(c => {\r\n            if (c.service_type === updatedConfig.service_type) {\r\n              // Use server response directly - it has the saved data with real ID\r\n              return updatedConfig;\r\n            }\r\n            return c;\r\n          });\r\n        } else {\r\n          // Add new config\r\n          return [...old, updatedConfig];\r\n        }\r\n      });\r\n    },\r\n    onError: (e: any) => toast.error(e?.message || 'Failed to save provider'),\r\n  });\r\n\r\n  // Auto-migration disabled - circuit breaker protection\r\n  // const [migrationRun, setMigrationRun] = useState(false);\r\n\r\n  const getForm = (serviceType: ServiceType) => {\r\n    const form = newProviderForms[serviceType];\r\n    if (form) return form;\r\n    \r\n    // Default form based on provider type\r\n    return {\r\n      provider: 'openai' as ProviderKey,\r\n      baseUrl: '',\r\n      apiKey: '',\r\n      model: '',\r\n      googleSearchEngineId: '',\r\n    };\r\n  };\r\n\r\n  const getDefaultBaseUrl = (provider: ProviderKey): string => {\r\n    switch (provider) {\r\n      case 'serper':\r\n        return 'https://google.serper.dev';\r\n      case 'tavily':\r\n        return 'https://api.tavily.com';\r\n      case 'google_search':\r\n        return 'https://www.googleapis.com/customsearch/v1';\r\n      case 'openai':\r\n        return 'https://api.openai.com/v1';\r\n      case 'anthropic':\r\n        return 'https://api.anthropic.com/v1';\r\n      default:\r\n        return '';\r\n    }\r\n  };\r\n\r\n  const setForm = (serviceType: ServiceType, updates: Partial<typeof newProviderForms[string]>) => {\r\n    setNewProviderForms(prev => {\r\n      const current = getForm(serviceType);\r\n      const newForm = { ...current, ...updates };\r\n      \r\n      // Auto-fill baseUrl when provider changes if it's empty\r\n      if (updates.provider && !newForm.baseUrl) {\r\n        newForm.baseUrl = getDefaultBaseUrl(updates.provider);\r\n      }\r\n      \r\n      return {\r\n        ...prev,\r\n        [serviceType]: newForm,\r\n      };\r\n    });\r\n  };\r\n\r\n  const addProviderInstance = (serviceType: ServiceType, cfg: any) => {\r\n    const form = getForm(serviceType);\r\n    const isWebSearchProvider = ['serper', 'tavily', 'google_search'].includes(form.provider);\r\n    \r\n    // Validation: model is optional for web search providers\r\n    if (!form.provider || !form.baseUrl || !form.apiKey || (!isWebSearchProvider && !form.model)) {\r\n      toast.error('Please fill in all required fields');\r\n      return;\r\n    }\r\n    \r\n    // Google Search requires engine ID\r\n    if (form.provider === 'google_search' && !form.googleSearchEngineId) {\r\n      toast.error('Google Search Engine ID is required for Google Search provider');\r\n      return;\r\n    }\r\n\r\n    // Get the current config from the configs array to ensure we have the full config\r\n    const currentConfig = configs.find(c => c.service_type === serviceType);\r\n    const fullCfg = currentConfig?.config || cfg || {};\r\n    \r\n    const instances: ProviderInstance[] = fullCfg.providerInstances || [];\r\n    \r\n    const newInstance: ProviderInstance = {\r\n      id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      provider: form.provider,\r\n      baseUrl: form.baseUrl,\r\n      apiKey: form.apiKey,\r\n      model: form.model || undefined, // Optional for web search\r\n      enabled: true,\r\n      ...(form.provider === 'google_search' && form.googleSearchEngineId\r\n        ? { googleSearchEngineId: form.googleSearchEngineId }\r\n        : {}),\r\n    };\r\n\r\n    const updatedInstances = [...instances, newInstance];\r\n    const activeId = fullCfg.activeProviderInstanceId || newInstance.id;\r\n\r\n    // Optimistically update the cache immediately\r\n    queryClient.setQueryData(['ai-configs'], (old: AIServiceConfig[] | undefined) => {\r\n      if (!old) {\r\n        // If no configs exist yet, create a new one\r\n        return [{\r\n          id: `temp-${serviceType}`,\r\n          service_type: serviceType,\r\n          config: {\r\n            ...fullCfg,\r\n            providerInstances: updatedInstances,\r\n            activeProviderInstanceId: activeId,\r\n          },\r\n          enabled: false,\r\n        }];\r\n      }\r\n      \r\n      const existingIndex = old.findIndex(c => c.service_type === serviceType);\r\n      if (existingIndex >= 0) {\r\n        // Update existing config\r\n        return old.map(c => {\r\n          if (c.service_type !== serviceType) return c;\r\n          const existingConfig = c.config || {};\r\n          return {\r\n            ...c,\r\n            config: {\r\n              ...existingConfig,\r\n              providerInstances: updatedInstances,\r\n              activeProviderInstanceId: activeId,\r\n            },\r\n          };\r\n        });\r\n      } else {\r\n        // Add new config entry\r\n        return [...old, {\r\n          id: `temp-${serviceType}`,\r\n          service_type: serviceType,\r\n          config: {\r\n            ...fullCfg,\r\n            providerInstances: updatedInstances,\r\n            activeProviderInstanceId: activeId,\r\n          },\r\n          enabled: false,\r\n        }];\r\n      }\r\n    });\r\n\r\n    updateConfig.mutate(\r\n      {\r\n        serviceType,\r\n        payload: {\r\n          config: {\r\n            ...fullCfg, // Preserve all existing config fields (webSearch, etc.)\r\n            providerInstances: updatedInstances,\r\n            activeProviderInstanceId: activeId,\r\n          },\r\n        },\r\n      },\r\n      {\r\n        onSuccess: () => {\r\n          // Cache is updated by mutation's onSuccess handler\r\n          toast.success('Provider added successfully');\r\n          // Reset form\r\n          setNewProviderForms(prev => {\r\n            const next = { ...prev };\r\n            delete next[serviceType];\r\n            return next;\r\n          });\r\n        },\r\n        onError: (error: any) => {\r\n          // Rollback optimistic update on error\r\n          queryClient.invalidateQueries({ queryKey: ['ai-configs'] });\r\n          toast.error(`Failed to add provider: ${error?.message || 'Unknown error'}`);\r\n          console.error('Failed to add provider:', error);\r\n        },\r\n      }\r\n    );\r\n  };\r\n\r\n  const deleteProviderInstance = (serviceType: ServiceType, cfg: any, instanceId: string) => {\r\n    const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n    const updatedInstances = instances.filter(i => i.id !== instanceId);\r\n    \r\n    let activeId = cfg.activeProviderInstanceId;\r\n    if (activeId === instanceId) {\r\n      activeId = updatedInstances.length > 0 ? updatedInstances[0].id : null;\r\n    }\r\n\r\n    updateConfig.mutate({\r\n      serviceType,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          providerInstances: updatedInstances,\r\n          activeProviderInstanceId: activeId,\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  const startEditingInstance = (instance: ProviderInstance) => {\r\n    setEditingInstance(instance.id);\r\n    setEditForm({\r\n      provider: instance.provider,\r\n      baseUrl: instance.baseUrl,\r\n      apiKey: instance.apiKey,\r\n      model: instance.model || '',\r\n      googleSearchEngineId: instance.googleSearchEngineId || '',\r\n    });\r\n  };\r\n\r\n  const saveEditedInstance = (serviceType: ServiceType, cfg: any, instanceId: string) => {\r\n    if (!editForm) return;\r\n\r\n    const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n    const updatedInstances = instances.map(i => \r\n      i.id === instanceId \r\n        ? { \r\n            ...i, \r\n            ...editForm, \r\n            connected: undefined,\r\n            ...(editForm.provider === 'google_search' && editForm.googleSearchEngineId\r\n              ? { googleSearchEngineId: editForm.googleSearchEngineId }\r\n              : editForm.provider !== 'google_search'\r\n              ? { googleSearchEngineId: undefined }\r\n              : {}),\r\n          }\r\n        : i\r\n    );\r\n\r\n    updateConfig.mutate({\r\n      serviceType,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          providerInstances: updatedInstances,\r\n        },\r\n      },\r\n    });\r\n\r\n    setEditingInstance(null);\r\n    setEditForm(null);\r\n  };\r\n\r\n  const testInstanceConnection = async (serviceType: ServiceType, instance: ProviderInstance) => {\r\n    try {\r\n      const testConfig = {\r\n        provider: instance.provider,\r\n        baseUrl: instance.baseUrl,\r\n        apiKey: instance.apiKey,\r\n        model: instance.model,\r\n      };\r\n      const res = await fetch(`/api/v1/ai/config/${serviceType}/test`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ config: testConfig }),\r\n      });\r\n      \r\n      if (!res.ok) throw new Error(await res.text());\r\n      toast.success('Connection successful');\r\n      \r\n      // Update connection status in cache\r\n      queryClient.setQueryData(['ai-configs'], (old: AIServiceConfig[] | undefined) => {\r\n        if (!old) return old;\r\n        return old.map(c => {\r\n          if (c.service_type !== serviceType) return c;\r\n          const instances: ProviderInstance[] = c.config.providerInstances || [];\r\n          return {\r\n            ...c,\r\n            config: {\r\n              ...c.config,\r\n              providerInstances: instances.map(i => \r\n                i.id === instance.id ? { ...i, connected: true } : i\r\n              ),\r\n            },\r\n          };\r\n        });\r\n      });\r\n    } catch (e: any) {\r\n      toast.error(e?.message || 'Connection failed');\r\n      \r\n      // Update connection status in cache\r\n      queryClient.setQueryData(['ai-configs'], (old: AIServiceConfig[] | undefined) => {\r\n        if (!old) return old;\r\n        return old.map(c => {\r\n          if (c.service_type !== serviceType) return c;\r\n          const instances: ProviderInstance[] = c.config.providerInstances || [];\r\n          return {\r\n            ...c,\r\n            config: {\r\n              ...c.config,\r\n              providerInstances: instances.map(i => \r\n                i.id === instance.id ? { ...i, connected: false } : i\r\n              ),\r\n            },\r\n          };\r\n        });\r\n      });\r\n    }\r\n  };\r\n\r\n  const toggleProviderInstance = (serviceType: ServiceType, cfg: any, instanceId: string, enabled: boolean) => {\r\n    const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n    const updatedInstances = instances.map(i => i.id === instanceId ? { ...i, enabled } : i);\r\n\r\n    updateConfig.mutate({\r\n      serviceType,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          providerInstances: updatedInstances,\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  const setActiveProvider = (serviceType: ServiceType, cfg: any, instanceId: string) => {\r\n    updateConfig.mutate({\r\n      serviceType,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          activeProviderInstanceId: instanceId,\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  const toggleService = (serviceType: ServiceType, enabled: boolean) => {\r\n    updateConfig.mutate({\r\n      serviceType,\r\n      payload: { enabled },\r\n    });\r\n  };\r\n\r\n  // Create a map of existing configs by service_type\r\n  const configsByType = new Map(configs.map(c => [c.service_type, c]));\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {(Object.keys(SERVICE_INFO) as ServiceType[]).map((serviceType) => {\r\n        const info = SERVICE_INFO[serviceType];\r\n        const config = configsByType.get(serviceType);\r\n        \r\n        // Use existing config or create default\r\n        const cfg = config?.config || {};\r\n        const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n        const activeId = cfg.activeProviderInstanceId;\r\n        const isEnabled = config?.enabled ?? false;\r\n        const form = getForm(serviceType);\r\n\r\n        return (\r\n          <Card key={serviceType} className=\"border-2\">\r\n            <CardHeader>\r\n              <div className=\"flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <span className=\"text-2xl\">{info.icon}</span>\r\n                  <div>\r\n                    <CardTitle className=\"text-lg\">{info.name}</CardTitle>\r\n                    <CardDescription>{info.description}</CardDescription>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Label htmlFor={`${serviceType}-enabled`} className=\"text-sm\">\r\n                    {isEnabled ? 'Enabled' : 'Disabled'}\r\n                  </Label>\r\n                  <Switch\r\n                    id={`${serviceType}-enabled`}\r\n                    checked={isEnabled}\r\n                    onCheckedChange={(checked) => toggleService(serviceType, checked)}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              {/* Add Provider Form */}\r\n              <div className=\"border rounded-lg p-4 space-y-4 bg-muted/30\">\r\n                <h4 className=\"font-medium text-sm\">Add New Provider</h4>\r\n                <div className={`grid grid-cols-1 md:grid-cols-4 gap-4 ${form.provider === 'google_search' ? 'md:grid-cols-5' : ''}`}>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Provider Type</Label>\r\n                    <Select\r\n                      value={form.provider}\r\n                      onValueChange={(v) => {\r\n                        const newProvider = v as ProviderKey;\r\n                        setForm(serviceType, { \r\n                          provider: newProvider,\r\n                          baseUrl: getDefaultBaseUrl(newProvider), // Auto-fill URL\r\n                        });\r\n                      }}\r\n                    >\r\n                      <SelectTrigger><SelectValue /></SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"openai\">OpenAI</SelectItem>\r\n                        <SelectItem value=\"anthropic\">Anthropic</SelectItem>\r\n                        <SelectItem value=\"openai_compatible\">OpenAI Compatible</SelectItem>\r\n                        <SelectItem value=\"serper\">Serper</SelectItem>\r\n                        <SelectItem value=\"tavily\">Tavily</SelectItem>\r\n                        <SelectItem value=\"google_search\">Google Search</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Endpoint URL</Label>\r\n                    <Input\r\n                      placeholder={getDefaultBaseUrl(form.provider) || \"https://api.example.com\"}\r\n                      value={form.baseUrl}\r\n                      onChange={(e) => setForm(serviceType, { baseUrl: e.target.value })}\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>API Key</Label>\r\n                    <Input\r\n                      type=\"password\"\r\n                      placeholder=\"sk-...\"\r\n                      value={form.apiKey}\r\n                      onChange={(e) => setForm(serviceType, { apiKey: e.target.value })}\r\n                    />\r\n                  </div>\r\n                  {form.provider !== 'google_search' && (\r\n                    <div className=\"space-y-2\">\r\n                      <Label>Model{['serper', 'tavily'].includes(form.provider) ? ' (Optional)' : ''}</Label>\r\n                      <Input\r\n                        placeholder=\"gpt-4o-mini\"\r\n                        value={form.model}\r\n                        onChange={(e) => setForm(serviceType, { model: e.target.value })}\r\n                      />\r\n                    </div>\r\n                  )}\r\n                  {form.provider === 'google_search' && (\r\n                    <>\r\n                      <div className=\"space-y-2\">\r\n                        <Label>Model (Optional)</Label>\r\n                        <Input\r\n                          placeholder=\"Not required for Google Search\"\r\n                          value={form.model}\r\n                          onChange={(e) => setForm(serviceType, { model: e.target.value })}\r\n                        />\r\n                      </div>\r\n                      <div className=\"space-y-2\">\r\n                        <Label>Google Search Engine ID *</Label>\r\n                        <Input\r\n                          placeholder=\"...\"\r\n                          value={form.googleSearchEngineId || ''}\r\n                          onChange={(e) => setForm(serviceType, { googleSearchEngineId: e.target.value })}\r\n                        />\r\n                      </div>\r\n                    </>\r\n                  )}\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                  <Button onClick={() => addProviderInstance(serviceType, cfg)} className=\"flex-1\">\r\n                    <Plus className=\"w-4 h-4 mr-2\" />\r\n                    Add Provider\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    onClick={async () => {\r\n                      const testForm = getForm(serviceType);\r\n                      if (!testForm.provider || !testForm.baseUrl || !testForm.apiKey || !testForm.model) {\r\n                        toast.error('Please fill in all fields to test connection');\r\n                        return;\r\n                      }\r\n                      try {\r\n                        const testConfig = {\r\n                          provider: testForm.provider,\r\n                          baseUrl: testForm.baseUrl,\r\n                          apiKey: testForm.apiKey,\r\n                          model: testForm.model,\r\n                        };\r\n                        const res = await fetch(`/api/v1/ai/config/${serviceType}/test`, {\r\n                          method: 'POST',\r\n                          headers: { 'Content-Type': 'application/json' },\r\n                          body: JSON.stringify({ config: testConfig }),\r\n                        });\r\n                        if (!res.ok) throw new Error(await res.text());\r\n                        toast.success('Connection test successful');\r\n                      } catch (e: any) {\r\n                        toast.error(e?.message || 'Connection test failed');\r\n                      }\r\n                    }}\r\n                  >\r\n                    Test Connection\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Provider Instances List */}\r\n              {instances.length > 0 && (\r\n                <div className=\"space-y-3\">\r\n                  <h4 className=\"font-medium text-sm\">Active Providers ({instances.length})</h4>\r\n                  {instances.map((inst) => {\r\n                    const isEditing = editingInstance === inst.id;\r\n                    return (\r\n                      <div\r\n                        key={inst.id}\r\n                        className={`border rounded-lg p-4 ${\r\n                          activeId === inst.id ? 'border-primary bg-primary/5' : ''\r\n                        }`}\r\n                      >\r\n                        {isEditing ? (\r\n                          // Edit Mode\r\n                          <div className=\"space-y-4\">\r\n                            <div className={`grid grid-cols-4 gap-4 ${editForm?.provider === 'google_search' ? 'md:grid-cols-5' : ''}`}>\r\n                              <div className=\"space-y-2\">\r\n                                <Label>Provider Type</Label>\r\n                                <Select\r\n                                  value={editForm?.provider}\r\n                                  onValueChange={(v) => setEditForm(prev => prev ? { ...prev, provider: v as ProviderKey, baseUrl: getDefaultBaseUrl(v as ProviderKey) } : null)}\r\n                                >\r\n                                  <SelectTrigger><SelectValue /></SelectTrigger>\r\n                                  <SelectContent>\r\n                                    <SelectItem value=\"openai\">OpenAI</SelectItem>\r\n                                    <SelectItem value=\"anthropic\">Anthropic</SelectItem>\r\n                                    <SelectItem value=\"openai_compatible\">OpenAI Compatible</SelectItem>\r\n                                    <SelectItem value=\"serper\">Serper</SelectItem>\r\n                                    <SelectItem value=\"tavily\">Tavily</SelectItem>\r\n                                    <SelectItem value=\"google_search\">Google Search</SelectItem>\r\n                                  </SelectContent>\r\n                                </Select>\r\n                              </div>\r\n                              <div className=\"space-y-2\">\r\n                                <Label>Endpoint URL</Label>\r\n                                <Input\r\n                                  value={editForm?.baseUrl || ''}\r\n                                  onChange={(e) => setEditForm(prev => prev ? { ...prev, baseUrl: e.target.value } : null)}\r\n                                />\r\n                              </div>\r\n                              <div className=\"space-y-2\">\r\n                                <Label>API Key</Label>\r\n                                <Input\r\n                                  type=\"password\"\r\n                                  value={editForm?.apiKey || ''}\r\n                                  onChange={(e) => setEditForm(prev => prev ? { ...prev, apiKey: e.target.value } : null)}\r\n                                />\r\n                              </div>\r\n                              {editForm?.provider !== 'google_search' && (\r\n                                <div className=\"space-y-2\">\r\n                                  <Label>Model{['serper', 'tavily'].includes(editForm?.provider || '') ? ' (Optional)' : ''}</Label>\r\n                                  <Input\r\n                                    value={editForm?.model || ''}\r\n                                    onChange={(e) => setEditForm(prev => prev ? { ...prev, model: e.target.value } : null)}\r\n                                  />\r\n                                </div>\r\n                              )}\r\n                              {editForm?.provider === 'google_search' && (\r\n                                <>\r\n                                  <div className=\"space-y-2\">\r\n                                    <Label>Model (Optional)</Label>\r\n                                    <Input\r\n                                      value={editForm?.model || ''}\r\n                                      onChange={(e) => setEditForm(prev => prev ? { ...prev, model: e.target.value } : null)}\r\n                                    />\r\n                                  </div>\r\n                                  <div className=\"space-y-2\">\r\n                                    <Label>Google Search Engine ID *</Label>\r\n                                    <Input\r\n                                      value={editForm?.googleSearchEngineId || ''}\r\n                                      onChange={(e) => setEditForm(prev => prev ? { ...prev, googleSearchEngineId: e.target.value } : null)}\r\n                                    />\r\n                                  </div>\r\n                                </>\r\n                              )}\r\n                            </div>\r\n                            <div className=\"flex gap-2 justify-end\">\r\n                              <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                onClick={() => {\r\n                                  setEditingInstance(null);\r\n                                  setEditForm(null);\r\n                                }}\r\n                              >\r\n                                Cancel\r\n                              </Button>\r\n                              <Button\r\n                                size=\"sm\"\r\n                                onClick={() => saveEditedInstance(serviceType, cfg, inst.id)}\r\n                              >\r\n                                Save Changes\r\n                              </Button>\r\n                            </div>\r\n                          </div>\r\n                        ) : (\r\n                          // View Mode\r\n                          <div className=\"flex items-center justify-between gap-4\">\r\n                            <div className=\"flex items-center gap-4 flex-1\">\r\n                              <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => setActiveProvider(serviceType, cfg, inst.id)}\r\n                                className={activeId === inst.id ? 'text-primary' : ''}\r\n                                title=\"Set as active provider\"\r\n                              >\r\n                                <Star className={`w-4 h-4 ${activeId === inst.id ? 'fill-current' : ''}`} />\r\n                              </Button>\r\n                              \r\n                              {/* Connection Status */}\r\n                              <div className=\"flex items-center gap-2\">\r\n                                {inst.connected === true && (\r\n                                  <div className=\"flex items-center gap-1 text-green-600\" title=\"Connected\">\r\n                                    <CheckCircle2 className=\"w-4 h-4\" />\r\n                                    <span className=\"text-xs font-medium\">Connected</span>\r\n                                  </div>\r\n                                )}\r\n                                {inst.connected === false && (\r\n                                  <div className=\"flex items-center gap-1 text-red-600\" title=\"Connection failed\">\r\n                                    <XCircle className=\"w-4 h-4\" />\r\n                                    <span className=\"text-xs font-medium\">Failed</span>\r\n                                  </div>\r\n                                )}\r\n                                {inst.connected === undefined && (\r\n                                  <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    onClick={() => testInstanceConnection(serviceType, inst)}\r\n                                    className=\"text-xs\"\r\n                                  >\r\n                                    Test\r\n                                  </Button>\r\n                                )}\r\n                              </div>\r\n\r\n                              <div className={`flex-1 grid gap-4 text-sm ${inst.provider === 'google_search' ? 'grid-cols-5' : 'grid-cols-4'}`}>\r\n                                <div>\r\n                                  <div className=\"font-medium\">{inst.provider.replace('_', ' ').replace(/\\b\\w/g, c => c.toUpperCase())}</div>\r\n                                </div>\r\n                                <div className=\"truncate\" title={inst.baseUrl}>\r\n                                  <span className=\"text-muted-foreground\">URL:</span> {inst.baseUrl}\r\n                                </div>\r\n                                <div className=\"truncate\">\r\n                                  <span className=\"text-muted-foreground\">Key:</span> {inst.apiKey.substring(0, 10)}...\r\n                                </div>\r\n                                <div className=\"truncate\" title={inst.model}>\r\n                                  <span className=\"text-muted-foreground\">Model:</span> {inst.model || 'N/A'}\r\n                                </div>\r\n                                {inst.provider === 'google_search' && inst.googleSearchEngineId && (\r\n                                  <div className=\"truncate\" title={inst.googleSearchEngineId}>\r\n                                    <span className=\"text-muted-foreground\">Engine ID:</span> {inst.googleSearchEngineId}\r\n                                  </div>\r\n                                )}\r\n                              </div>\r\n                              \r\n                              <div className=\"flex items-center gap-2\">\r\n                                <Switch\r\n                                  checked={inst.enabled}\r\n                                  onCheckedChange={(checked) => toggleProviderInstance(serviceType, cfg, inst.id, checked)}\r\n                                />\r\n                                <Label className=\"text-xs\">{inst.enabled ? 'On' : 'Off'}</Label>\r\n                              </div>\r\n                            </div>\r\n                            \r\n                            <div className=\"flex items-center gap-1\">\r\n                              <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => startEditingInstance(inst)}\r\n                                title=\"Edit provider\"\r\n                              >\r\n                                <Edit2 className=\"w-4 h-4\" />\r\n                              </Button>\r\n                              <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => {\r\n                                  if (confirm('Are you sure you want to delete this provider?')) {\r\n                                    deleteProviderInstance(serviceType, cfg, inst.id);\r\n                                  }\r\n                                }}\r\n                                className=\"text-destructive hover:text-destructive\"\r\n                                title=\"Delete provider\"\r\n                              >\r\n                                <Trash2 className=\"w-4 h-4\" />\r\n                              </Button>\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\admin\\providers\\CustomServicesPanel.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":578,"column":39,"nodeType":"Identifier","messageId":"undef","endLine":578,"endColumn":46}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useState } from 'react';\r\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Switch } from '@/components/ui/switch';\r\nimport { toast } from 'sonner';\r\nimport { Trash2, Plus, Star, Edit2, CheckCircle2, XCircle } from 'lucide-react';\r\n\r\ntype ProviderKey = 'openai' | 'anthropic' | 'openai_compatible';\r\n\r\ninterface AIServiceRow {\r\n  id: string;\r\n  service_key: string;\r\n  service_label: string;\r\n  is_enabled: boolean;\r\n}\r\n\r\ninterface ServiceConfigRecord {\r\n  id: string;\r\n  enabled: boolean;\r\n  config: any;\r\n}\r\n\r\ninterface ProviderInstance {\r\n  id: string;\r\n  provider: ProviderKey;\r\n  baseUrl: string;\r\n  apiKey: string;\r\n  model: string;\r\n  enabled: boolean;\r\n  connected?: boolean;\r\n}\r\n\r\nfunction useServices() {\r\n  return useQuery<AIServiceRow[]>({\r\n    queryKey: ['ai-services'],\r\n    queryFn: async () => {\r\n      const res = await fetch('/api/v1/ai/services');\r\n      if (!res.ok) throw new Error(await res.text());\r\n      const data = await res.json();\r\n      return data.data || [];\r\n    },\r\n  });\r\n}\r\n\r\nexport default function CustomServicesPanel() {\r\n  const queryClient = useQueryClient();\r\n  const { data: services = [] } = useServices();\r\n  const [configs, setConfigs] = useState<Record<string, ServiceConfigRecord | null>>({});\r\n  \r\n  // Form state for adding a new provider instance per service\r\n  const [newProviderForms, setNewProviderForms] = useState<Record<string, {\r\n    provider: ProviderKey;\r\n    baseUrl: string;\r\n    apiKey: string;\r\n    model: string;\r\n  }>>({});\r\n\r\n  // Edit mode state\r\n  const [editingInstance, setEditingInstance] = useState<string | null>(null);\r\n  const [editForm, setEditForm] = useState<{\r\n    provider: ProviderKey;\r\n    baseUrl: string;\r\n    apiKey: string;\r\n    model: string;\r\n  } | null>(null);\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      for (const s of services) {\r\n        if (configs[s.id] !== undefined) continue;\r\n        try {\r\n          const res = await fetch(`/api/v1/ai/services/${s.id}/config`);\r\n          const data = await res.json().catch(() => ({}));\r\n          setConfigs(prev => ({ ...prev, [s.id]: data?.data || { id: '', enabled: s.is_enabled, config: {} } }));\r\n        } catch {\r\n          setConfigs(prev => ({ ...prev, [s.id]: { id: '', enabled: s.is_enabled, config: {} } }));\r\n        }\r\n      }\r\n    })();\r\n  }, [services]);\r\n\r\n  const updateConfig = useMutation({\r\n    mutationFn: async ({ serviceId, payload }: { serviceId: string; payload: any }) => {\r\n      const res = await fetch(`/api/v1/ai/services/${serviceId}/config`, {\r\n        method: 'PATCH',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!res.ok) throw new Error(await res.text());\r\n      return res.json();\r\n    },\r\n    onSuccess: (_, vars) => {\r\n      toast.success('Provider saved');\r\n      queryClient.invalidateQueries({ queryKey: ['ai-services'] });\r\n      setTimeout(() => {\r\n        void fetch(`/api/v1/ai/services/${vars.serviceId}/config`).then(r => r.json()).then(d => {\r\n          setConfigs(prev => ({ ...prev, [vars.serviceId]: d?.data }));\r\n        }).catch(() => {});\r\n      }, 100);\r\n    },\r\n    onError: (e: any) => toast.error(e?.message || 'Failed to save provider'),\r\n  });\r\n\r\n  const getForm = (serviceId: string) => {\r\n    return newProviderForms[serviceId] || {\r\n      provider: 'openai' as ProviderKey,\r\n      baseUrl: '',\r\n      apiKey: '',\r\n      model: '',\r\n    };\r\n  };\r\n\r\n  const setForm = (serviceId: string, updates: Partial<typeof newProviderForms[string]>) => {\r\n    setNewProviderForms(prev => ({\r\n      ...prev,\r\n      [serviceId]: { ...getForm(serviceId), ...updates },\r\n    }));\r\n  };\r\n\r\n  const addProviderInstance = (serviceId: string) => {\r\n    const form = getForm(serviceId);\r\n    if (!form.provider || !form.baseUrl || !form.apiKey || !form.model) {\r\n      toast.error('Please fill in all fields');\r\n      return;\r\n    }\r\n\r\n    const record = configs[serviceId];\r\n    const cfg = record?.config || {};\r\n    const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n    \r\n    const newInstance: ProviderInstance = {\r\n      id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      provider: form.provider,\r\n      baseUrl: form.baseUrl,\r\n      apiKey: form.apiKey,\r\n      model: form.model,\r\n      enabled: true,\r\n    };\r\n\r\n    const updatedInstances = [...instances, newInstance];\r\n    const activeId = cfg.activeProviderInstanceId || newInstance.id;\r\n\r\n    updateConfig.mutate({\r\n      serviceId,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          providerInstances: updatedInstances,\r\n          activeProviderInstanceId: activeId,\r\n        },\r\n      },\r\n    });\r\n\r\n    // Reset form\r\n    setNewProviderForms(prev => {\r\n      const next = { ...prev };\r\n      delete next[serviceId];\r\n      return next;\r\n    });\r\n  };\r\n\r\n  const deleteProviderInstance = (serviceId: string, instanceId: string) => {\r\n    const record = configs[serviceId];\r\n    const cfg = record?.config || {};\r\n    const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n    const updatedInstances = instances.filter(i => i.id !== instanceId);\r\n    \r\n    let activeId = cfg.activeProviderInstanceId;\r\n    if (activeId === instanceId) {\r\n      activeId = updatedInstances.length > 0 ? updatedInstances[0].id : null;\r\n    }\r\n\r\n    updateConfig.mutate({\r\n      serviceId,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          providerInstances: updatedInstances,\r\n          activeProviderInstanceId: activeId,\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  const startEditingInstance = (instance: ProviderInstance) => {\r\n    setEditingInstance(instance.id);\r\n    setEditForm({\r\n      provider: instance.provider,\r\n      baseUrl: instance.baseUrl,\r\n      apiKey: instance.apiKey,\r\n      model: instance.model,\r\n    });\r\n  };\r\n\r\n  const saveEditedInstance = (serviceId: string, instanceId: string) => {\r\n    if (!editForm) return;\r\n\r\n    const record = configs[serviceId];\r\n    const cfg = record?.config || {};\r\n    const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n    const updatedInstances = instances.map(i => \r\n      i.id === instanceId \r\n        ? { ...i, ...editForm, connected: undefined } // Reset connected status after edit\r\n        : i\r\n    );\r\n\r\n    updateConfig.mutate({\r\n      serviceId,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          providerInstances: updatedInstances,\r\n        },\r\n      },\r\n    });\r\n\r\n    setEditingInstance(null);\r\n    setEditForm(null);\r\n  };\r\n\r\n  const testInstanceConnection = async (serviceId: string, instance: ProviderInstance) => {\r\n    try {\r\n      const testConfig = {\r\n        provider: instance.provider,\r\n        baseUrl: instance.baseUrl,\r\n        apiKey: instance.apiKey,\r\n        model: instance.model,\r\n      };\r\n      const res = await fetch(`/api/v1/ai/config/assistant/test`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ config: testConfig }),\r\n      });\r\n      \r\n      const record = configs[serviceId];\r\n      const cfg = record?.config || {};\r\n      const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n      const updatedInstances = instances.map(i => \r\n        i.id === instance.id ? { ...i, connected: res.ok } : i\r\n      );\r\n\r\n      // Update local state immediately\r\n      setConfigs(prev => ({\r\n        ...prev,\r\n        [serviceId]: {\r\n          ...record,\r\n          config: {\r\n            ...cfg,\r\n            providerInstances: updatedInstances,\r\n          },\r\n        },\r\n      }));\r\n\r\n      if (!res.ok) throw new Error(await res.text());\r\n      toast.success('Connection successful');\r\n    } catch (e: any) {\r\n      const record = configs[serviceId];\r\n      const cfg = record?.config || {};\r\n      const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n      const updatedInstances = instances.map(i => \r\n        i.id === instance.id ? { ...i, connected: false } : i\r\n      );\r\n\r\n      setConfigs(prev => ({\r\n        ...prev,\r\n        [serviceId]: {\r\n          ...record,\r\n          config: {\r\n            ...cfg,\r\n            providerInstances: updatedInstances,\r\n          },\r\n        },\r\n      }));\r\n      toast.error(e?.message || 'Connection failed');\r\n    }\r\n  };\r\n\r\n  const toggleProviderInstance = (serviceId: string, instanceId: string, enabled: boolean) => {\r\n    const record = configs[serviceId];\r\n    const cfg = record?.config || {};\r\n    const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n    const updatedInstances = instances.map(i => i.id === instanceId ? { ...i, enabled } : i);\r\n\r\n    updateConfig.mutate({\r\n      serviceId,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          providerInstances: updatedInstances,\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  const setActiveProvider = (serviceId: string, instanceId: string) => {\r\n    const record = configs[serviceId];\r\n    const cfg = record?.config || {};\r\n\r\n    updateConfig.mutate({\r\n      serviceId,\r\n      payload: {\r\n        config: {\r\n          ...cfg,\r\n          activeProviderInstanceId: instanceId,\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {services.length === 0 ? null : (\r\n        <div className=\"text-sm text-muted-foreground\">Custom AI Services</div>\r\n      )}\r\n      {services.map((s) => {\r\n        const record = configs[s.id] || { id: '', enabled: s.is_enabled, config: {} };\r\n        const cfg = record.config || {};\r\n        const instances: ProviderInstance[] = cfg.providerInstances || [];\r\n        const activeId = cfg.activeProviderInstanceId;\r\n        const form = getForm(s.id);\r\n\r\n        return (\r\n          <Card key={s.id} className=\"border border-dashed\">\r\n            <CardHeader>\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <CardTitle className=\"text-base\">{s.service_label}</CardTitle>\r\n                  <CardDescription>Add multiple AI providers to this service</CardDescription>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Label htmlFor={`${s.id}-enabled`} className=\"text-sm\">{record.enabled ? 'Enabled' : 'Disabled'}</Label>\r\n                  <Switch\r\n                    id={`${s.id}-enabled`}\r\n                    checked={!!record.enabled}\r\n                    onCheckedChange={(checked) => updateConfig.mutate({ serviceId: s.id, payload: { enabled: checked } })}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              {/* Add Provider Form */}\r\n              <div className=\"border rounded-lg p-4 space-y-4 bg-muted/30\">\r\n                <h4 className=\"font-medium text-sm\">Add New Provider</h4>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Provider Type</Label>\r\n                    <Select\r\n                      value={form.provider}\r\n                      onValueChange={(v) => setForm(s.id, { provider: v as ProviderKey })}\r\n                    >\r\n                      <SelectTrigger><SelectValue /></SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"openai\">OpenAI</SelectItem>\r\n                        <SelectItem value=\"anthropic\">Anthropic</SelectItem>\r\n                        <SelectItem value=\"openai_compatible\">OpenAI Compatible</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Endpoint URL</Label>\r\n                    <Input\r\n                      placeholder=\"https://api.openai.com/v1\"\r\n                      value={form.baseUrl}\r\n                      onChange={(e) => setForm(s.id, { baseUrl: e.target.value })}\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>API Key</Label>\r\n                    <Input\r\n                      type=\"password\"\r\n                      placeholder=\"sk-...\"\r\n                      value={form.apiKey}\r\n                      onChange={(e) => setForm(s.id, { apiKey: e.target.value })}\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Model</Label>\r\n                    <Input\r\n                      placeholder=\"gpt-4o-mini\"\r\n                      value={form.model}\r\n                      onChange={(e) => setForm(s.id, { model: e.target.value })}\r\n                    />\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                  <Button onClick={() => addProviderInstance(s.id)} className=\"flex-1\">\r\n                    <Plus className=\"w-4 h-4 mr-2\" />\r\n                    Add Provider\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    onClick={async () => {\r\n                      const form = getForm(s.id);\r\n                      if (!form.provider || !form.baseUrl || !form.apiKey || !form.model) {\r\n                        toast.error('Please fill in all fields to test connection');\r\n                        return;\r\n                      }\r\n                      try {\r\n                        const testConfig = {\r\n                          provider: form.provider,\r\n                          baseUrl: form.baseUrl,\r\n                          apiKey: form.apiKey,\r\n                          model: form.model,\r\n                        };\r\n                        const res = await fetch(`/api/v1/ai/config/assistant/test`, {\r\n                          method: 'POST',\r\n                          headers: { 'Content-Type': 'application/json' },\r\n                          body: JSON.stringify({ config: testConfig }),\r\n                        });\r\n                        if (!res.ok) throw new Error(await res.text());\r\n                        toast.success('Connection test successful');\r\n                      } catch (e: any) {\r\n                        toast.error(e?.message || 'Connection test failed');\r\n                      }\r\n                    }}\r\n                  >\r\n                    Test Connection\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Provider Instances List */}\r\n              {instances.length > 0 && (\r\n                <div className=\"space-y-3\">\r\n                  <h4 className=\"font-medium text-sm\">Active Providers ({instances.length})</h4>\r\n                  {instances.map((inst) => {\r\n                    const isEditing = editingInstance === inst.id;\r\n                    return (\r\n                      <div\r\n                        key={inst.id}\r\n                        className={`border rounded-lg p-4 ${\r\n                          activeId === inst.id ? 'border-primary bg-primary/5' : ''\r\n                        }`}\r\n                      >\r\n                        {isEditing ? (\r\n                          // Edit Mode\r\n                          <div className=\"space-y-4\">\r\n                            <div className=\"grid grid-cols-4 gap-4\">\r\n                              <div className=\"space-y-2\">\r\n                                <Label>Provider Type</Label>\r\n                                <Select\r\n                                  value={editForm?.provider}\r\n                                  onValueChange={(v) => setEditForm(prev => prev ? { ...prev, provider: v as ProviderKey } : null)}\r\n                                >\r\n                                  <SelectTrigger><SelectValue /></SelectTrigger>\r\n                                  <SelectContent>\r\n                                    <SelectItem value=\"openai\">OpenAI</SelectItem>\r\n                                    <SelectItem value=\"anthropic\">Anthropic</SelectItem>\r\n                                    <SelectItem value=\"openai_compatible\">OpenAI Compatible</SelectItem>\r\n                                  </SelectContent>\r\n                                </Select>\r\n                              </div>\r\n                              <div className=\"space-y-2\">\r\n                                <Label>Endpoint URL</Label>\r\n                                <Input\r\n                                  value={editForm?.baseUrl || ''}\r\n                                  onChange={(e) => setEditForm(prev => prev ? { ...prev, baseUrl: e.target.value } : null)}\r\n                                />\r\n                              </div>\r\n                              <div className=\"space-y-2\">\r\n                                <Label>API Key</Label>\r\n                                <Input\r\n                                  type=\"password\"\r\n                                  value={editForm?.apiKey || ''}\r\n                                  onChange={(e) => setEditForm(prev => prev ? { ...prev, apiKey: e.target.value } : null)}\r\n                                />\r\n                              </div>\r\n                              <div className=\"space-y-2\">\r\n                                <Label>Model</Label>\r\n                                <Input\r\n                                  value={editForm?.model || ''}\r\n                                  onChange={(e) => setEditForm(prev => prev ? { ...prev, model: e.target.value } : null)}\r\n                                />\r\n                              </div>\r\n                            </div>\r\n                            <div className=\"flex gap-2 justify-end\">\r\n                              <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                onClick={() => {\r\n                                  setEditingInstance(null);\r\n                                  setEditForm(null);\r\n                                }}\r\n                              >\r\n                                Cancel\r\n                              </Button>\r\n                              <Button\r\n                                size=\"sm\"\r\n                                onClick={() => saveEditedInstance(s.id, inst.id)}\r\n                              >\r\n                                Save Changes\r\n                              </Button>\r\n                            </div>\r\n                          </div>\r\n                        ) : (\r\n                          // View Mode\r\n                          <div className=\"flex items-center justify-between gap-4\">\r\n                            <div className=\"flex items-center gap-4 flex-1\">\r\n                              <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => setActiveProvider(s.id, inst.id)}\r\n                                className={activeId === inst.id ? 'text-primary' : ''}\r\n                                title=\"Set as active provider\"\r\n                              >\r\n                                <Star className={`w-4 h-4 ${activeId === inst.id ? 'fill-current' : ''}`} />\r\n                              </Button>\r\n                              \r\n                              {/* Connection Status */}\r\n                              <div className=\"flex items-center gap-2\">\r\n                                {inst.connected === true && (\r\n                                  <div className=\"flex items-center gap-1 text-green-600\" title=\"Connected\">\r\n                                    <CheckCircle2 className=\"w-4 h-4\" />\r\n                                    <span className=\"text-xs font-medium\">Connected</span>\r\n                                  </div>\r\n                                )}\r\n                                {inst.connected === false && (\r\n                                  <div className=\"flex items-center gap-1 text-red-600\" title=\"Connection failed\">\r\n                                    <XCircle className=\"w-4 h-4\" />\r\n                                    <span className=\"text-xs font-medium\">Failed</span>\r\n                                  </div>\r\n                                )}\r\n                                {inst.connected === undefined && (\r\n                                  <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    onClick={() => testInstanceConnection(s.id, inst)}\r\n                                    className=\"text-xs\"\r\n                                  >\r\n                                    Test\r\n                                  </Button>\r\n                                )}\r\n                              </div>\r\n\r\n                              <div className=\"flex-1 grid grid-cols-4 gap-4 text-sm\">\r\n                                <div>\r\n                                  <div className=\"font-medium\">{inst.provider.replace('_', ' ').replace(/\\b\\w/g, c => c.toUpperCase())}</div>\r\n                                </div>\r\n                                <div className=\"truncate\" title={inst.baseUrl}>\r\n                                  <span className=\"text-muted-foreground\">URL:</span> {inst.baseUrl}\r\n                                </div>\r\n                                <div className=\"truncate\">\r\n                                  <span className=\"text-muted-foreground\">Key:</span> {inst.apiKey.substring(0, 10)}...\r\n                                </div>\r\n                                <div className=\"truncate\" title={inst.model}>\r\n                                  <span className=\"text-muted-foreground\">Model:</span> {inst.model}\r\n                                </div>\r\n                              </div>\r\n                              \r\n                              <div className=\"flex items-center gap-2\">\r\n                                <Switch\r\n                                  checked={inst.enabled}\r\n                                  onCheckedChange={(checked) => toggleProviderInstance(s.id, inst.id, checked)}\r\n                                />\r\n                                <Label className=\"text-xs\">{inst.enabled ? 'On' : 'Off'}</Label>\r\n                              </div>\r\n                            </div>\r\n                            \r\n                            <div className=\"flex items-center gap-1\">\r\n                              <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => startEditingInstance(inst)}\r\n                                title=\"Edit provider\"\r\n                              >\r\n                                <Edit2 className=\"w-4 h-4\" />\r\n                              </Button>\r\n                              <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => {\r\n                                  if (confirm('Are you sure you want to delete this provider?')) {\r\n                                    deleteProviderInstance(s.id, inst.id);\r\n                                  }\r\n                                }}\r\n                                className=\"text-destructive hover:text-destructive\"\r\n                                title=\"Delete provider\"\r\n                              >\r\n                                <Trash2 className=\"w-4 h-4\" />\r\n                              </Button>\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ai\\assistant\\ChatAssistant.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":21,"column":28,"nodeType":"Identifier","messageId":"undef","endLine":21,"endColumn":42},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":42,"column":62,"nodeType":"BlockStatement","messageId":"unexpected","endLine":42,"endColumn":64,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[1623,1623],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport React, { useEffect, useRef, useState } from 'react'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { Loader2, Send, Bot, User } from 'lucide-react'\n\ntype Role = 'user' | 'assistant' | 'system'\ninterface Message { role: Role; content: string }\n\nexport default function ChatAssistant() {\n  const [conversationId, setConversationId] = useState<string | undefined>(undefined)\n  const [messages, setMessages] = useState<Message[]>([\n    { role: 'system', content: 'You are the MantisNXT AI assistant. Be concise and helpful.' },\n  ])\n  const [input, setInput] = useState('')\n  const [loading, setLoading] = useState(false)\n  const scrollRef = useRef<HTMLDivElement>(null)\n\n  useEffect(() => {\n    scrollRef.current?.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' })\n  }, [messages])\n\n  async function send() {\n    const text = input.trim()\n    if (!text) return\n    const next: Message[] = [...messages, { role: 'user', content: text }]\n    setMessages(next)\n    setInput('')\n    setLoading(true)\n    try {\n      const res = await fetch('/api/ai/chat', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ conversationId, messages: next, stream: false }),\n      })\n      const raw = await res.text()\n      let data: any = undefined\n      try { data = raw ? JSON.parse(raw) : undefined } catch {}\n\n      if (!res.ok) {\n        const errMsg = data?.error || raw || `${res.status} ${res.statusText}`\n        throw new Error(errMsg)\n      }\n      if (!data?.success) {\n        throw new Error(data?.error || 'Chat failed')\n      }\n\n      // Try multiple shapes for assistant content\n      const resp = data?.data?.response\n      const assistantText: string = resp?.data?.text || resp?.text || data?.data?.text || ''\n      if (assistantText) {\n        setMessages((prev) => [...prev, { role: 'assistant', content: assistantText }])\n      } else {\n        setMessages((prev) => [...prev, { role: 'assistant', content: 'No content returned from provider.' }])\n      }\n      if (data?.data?.conversationId) setConversationId(data.data.conversationId)\n    } catch (e: any) {\n      setMessages((prev) => [...prev, { role: 'assistant', content: `Error: ${e?.message || 'Unknown error'}` }])\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  function handleKey(e: React.KeyboardEvent<HTMLTextAreaElement>) {\n    if ((e.key === 'Enter' && (e.ctrlKey || e.metaKey)) || (e.key === 'Enter' && !e.shiftKey)) {\n      e.preventDefault()\n      void send()\n    }\n  }\n\n  return (\n    <Card className=\"w-full h-[calc(100vh-12rem)] max-h-[900px] flex flex-col\">\n      <CardHeader className=\"flex items-center justify-between\">\n        <CardTitle className=\"flex items-center gap-2\"><Bot className=\"h-5 w-5\" /> AI Assistant</CardTitle>\n        {conversationId && <Badge variant=\"secondary\">Session: {conversationId.slice(0, 8)}</Badge>}\n      </CardHeader>\n      <CardContent className=\"flex flex-col h-full\">\n        <div ref={scrollRef} className=\"flex-1 overflow-auto rounded border p-4 space-y-4 bg-background\">\n          {messages.filter(m => m.role !== 'system').map((m, idx) => (\n            <div key={idx} className={`flex items-start gap-3 ${m.role === 'assistant' ? '' : 'justify-end'}`}>\n              {m.role === 'assistant' && <Bot className=\"h-4 w-4 mt-1 text-blue-600\" />}\n              <div className={`max-w-[80%] whitespace-pre-wrap rounded-md px-3 py-2 text-sm ${m.role === 'assistant' ? 'bg-blue-50 text-blue-900' : 'bg-gray-100 text-gray-900'}`}>{m.content}</div>\n              {m.role === 'user' && <User className=\"h-4 w-4 mt-1 text-gray-600\" />}\n            </div>\n          ))}\n        </div>\n        <div className=\"mt-3 flex items-end gap-2\">\n          <Textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={handleKey} rows={2} placeholder=\"Ask something... (Enter to send, Shift+Enter for new line)\" />\n          <Button onClick={send} disabled={loading || !input.trim()}>\n            {loading ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <Send className=\"h-4 w-4\" />}\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\analytics\\ai\\AIPredictiveAnalyticsDashboard.tsx","messages":[{"ruleId":"jsx-a11y/no-static-element-interactions","severity":2,"message":"Avoid non-native interactive elements. If using native HTML is not possible, add an appropriate role and support for tabbing, mouse, keyboard, and touch inputs to an interactive content element.","line":398,"column":25,"nodeType":"JSXOpeningElement","endLine":406,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useEffect, useCallback } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport {\r\n  AreaChart,\r\n  Area,\r\n  XAxis,\r\n  YAxis,\r\n  CartesianGrid,\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  LineChart,\r\n  Line,\r\n  BarChart,\r\n  Bar,\r\n  ComposedChart,\r\n  ScatterChart,\r\n  Scatter,\r\n  Cell,\r\n  PieChart,\r\n  Pie,\r\n  ReferenceLine\r\n} from 'recharts'\r\nimport {\r\n  Brain,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  AlertTriangle,\r\n  Target,\r\n  Zap,\r\n  Activity,\r\n  Gauge,\r\n  BarChart3,\r\n  PieChart as PieChartIcon,\r\n  Clock,\r\n  Eye,\r\n  Settings,\r\n  RefreshCw,\r\n  Download,\r\n  Calendar,\r\n  Filter,\r\n  ChevronRight,\r\n  Lightbulb,\r\n  AlertCircle,\r\n  CheckCircle,\r\n  Info,\r\n  Loader2\r\n} from 'lucide-react'\r\nimport { format } from 'date-fns'\r\n\r\n// AI Analytics Types\r\ninterface AIPrediction {\r\n  id: string\r\n  type: 'demand_forecast' | 'cost_prediction' | 'risk_assessment' | 'performance_forecast'\r\n  title: string\r\n  description: string\r\n  confidence: number\r\n  timeHorizon: '1_month' | '3_months' | '6_months' | '1_year'\r\n  predictions: Array<{\r\n    period: string\r\n    value: number\r\n    confidence_interval: [number, number]\r\n    factors: string[]\r\n  }>\r\n  accuracy: number\r\n  lastUpdated: Date\r\n  actionable: boolean\r\n  recommendations: string[]\r\n}\r\n\r\ninterface AIAnomaly {\r\n  id: string\r\n  type: 'cost_spike' | 'performance_drop' | 'demand_anomaly' | 'supplier_risk'\r\n  title: string\r\n  description: string\r\n  severity: 'low' | 'medium' | 'high' | 'critical'\r\n  confidence: number\r\n  detectedAt: Date\r\n  affectedEntities: string[]\r\n  rootCause?: string\r\n  suggestedActions: string[]\r\n  status: 'new' | 'investigating' | 'resolved' | 'dismissed'\r\n  impactMetrics: {\r\n    cost?: number\r\n    performance?: number\r\n    timeline?: string\r\n  }\r\n}\r\n\r\ninterface AIInsight {\r\n  id: string\r\n  category: 'optimization' | 'risk' | 'opportunity' | 'trend'\r\n  title: string\r\n  description: string\r\n  impact: 'low' | 'medium' | 'high'\r\n  confidence: number\r\n  evidence: string[]\r\n  recommendations: string[]\r\n  potentialValue?: number\r\n  implementationComplexity: 'low' | 'medium' | 'high'\r\n  priority: number\r\n  createdAt: Date\r\n}\r\n\r\ninterface AIAnalyticsState {\r\n  predictions: AIPrediction[]\r\n  anomalies: AIAnomaly[]\r\n  insights: AIInsight[]\r\n  isLoading: boolean\r\n  lastUpdated: Date | null\r\n  selectedTimeframe: string\r\n  autoRefresh: boolean\r\n}\r\n\r\nconst COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']\r\n\r\nexport default function AIPredictiveAnalyticsDashboard() {\r\n  const [state, setState] = useState<AIAnalyticsState>({\r\n    predictions: [],\r\n    anomalies: [],\r\n    insights: [],\r\n    isLoading: true,\r\n    lastUpdated: null,\r\n    selectedTimeframe: '3_months',\r\n    autoRefresh: false\r\n  })\r\n\r\n  const [activeTab, setActiveTab] = useState('predictions')\r\n  const [selectedPrediction, setSelectedPrediction] = useState<string>('')\r\n  const [isRefreshing, setIsRefreshing] = useState(false)\r\n\r\n  // Load AI analytics data\r\n  const loadAnalyticsData = useCallback(async (timeframe?: string) => {\r\n    setIsRefreshing(true)\r\n    try {\r\n      const response = await fetch('/api/ai/analytics/predictive', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          timeframe: timeframe || state.selectedTimeframe,\r\n          includeAnomalyDetection: true,\r\n          includeInsights: true,\r\n          includePredictions: true\r\n        })\r\n      })\r\n\r\n      if (!response.ok) throw new Error('Failed to load analytics')\r\n\r\n      const data = await response.json()\r\n\r\n      setState(prev => ({\r\n        ...prev,\r\n        predictions: data.predictions || [],\r\n        anomalies: data.anomalies || [],\r\n        insights: data.insights || [],\r\n        isLoading: false,\r\n        lastUpdated: new Date()\r\n      }))\r\n    } catch (error) {\r\n      console.error('Error loading AI analytics:', error)\r\n      setState(prev => ({ ...prev, isLoading: false }))\r\n    } finally {\r\n      setIsRefreshing(false)\r\n    }\r\n  }, [state.selectedTimeframe])\r\n\r\n  // Initial load and auto-refresh\r\n  useEffect(() => {\r\n    loadAnalyticsData()\r\n\r\n    let intervalId: NodeJS.Timeout\r\n    if (state.autoRefresh) {\r\n      intervalId = setInterval(() => {\r\n        loadAnalyticsData()\r\n      }, 300000) // 5 minutes\r\n    }\r\n\r\n    return () => {\r\n      if (intervalId) clearInterval(intervalId)\r\n    }\r\n  }, [loadAnalyticsData, state.autoRefresh])\r\n\r\n  const getSeverityColor = (severity: string) => {\r\n    const colors = {\r\n      low: 'text-green-600 bg-green-50 border-green-200',\r\n      medium: 'text-orange-600 bg-orange-50 border-orange-200',\r\n      high: 'text-red-600 bg-red-50 border-red-200',\r\n      critical: 'text-red-800 bg-red-100 border-red-300'\r\n    }\r\n    return colors[severity as keyof typeof colors] || colors.medium\r\n  }\r\n\r\n  const getImpactColor = (impact: string) => {\r\n    const colors = {\r\n      low: 'text-blue-600',\r\n      medium: 'text-orange-600',\r\n      high: 'text-red-600'\r\n    }\r\n    return colors[impact as keyof typeof colors] || 'text-gray-600'\r\n  }\r\n\r\n  const getPredictionTypeIcon = (type: string) => {\r\n    const icons = {\r\n      demand_forecast: Activity,\r\n      cost_prediction: TrendingUp,\r\n      risk_assessment: AlertTriangle,\r\n      performance_forecast: Target\r\n    }\r\n    return icons[type as keyof typeof icons] || Activity\r\n  }\r\n\r\n  const formatCurrency = (amount: number) => {\r\n    return new Intl.NumberFormat('en-ZA', {\r\n      style: 'currency',\r\n      currency: 'ZAR',\r\n      minimumFractionDigits: 0\r\n    }).format(amount)\r\n  }\r\n\r\n  if (state.isLoading) {\r\n    return (\r\n      <Card>\r\n        <CardContent className=\"p-6\">\r\n          <div className=\"flex items-center justify-center h-64\">\r\n            <Loader2 className=\"h-8 w-8 animate-spin mr-2\" />\r\n            <span>Loading AI analytics...</span>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header with Controls */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-bold tracking-tight flex items-center gap-2\">\r\n            <Brain className=\"h-6 w-6 text-purple-600\" />\r\n            AI Predictive Analytics\r\n          </h2>\r\n          <p className=\"text-muted-foreground\">\r\n            Advanced AI-powered insights and predictions for your supply chain\r\n          </p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <Select\r\n            value={state.selectedTimeframe}\r\n            onValueChange={(value) => {\r\n              setState(prev => ({ ...prev, selectedTimeframe: value }))\r\n              loadAnalyticsData(value)\r\n            }}\r\n          >\r\n            <SelectTrigger className=\"w-32\">\r\n              <SelectValue />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"1_month\">1 Month</SelectItem>\r\n              <SelectItem value=\"3_months\">3 Months</SelectItem>\r\n              <SelectItem value=\"6_months\">6 Months</SelectItem>\r\n              <SelectItem value=\"1_year\">1 Year</SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => loadAnalyticsData()}\r\n            disabled={isRefreshing}\r\n          >\r\n            <RefreshCw className={`h-4 w-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />\r\n            Refresh\r\n          </Button>\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <Download className=\"h-4 w-4 mr-2\" />\r\n            Export\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Summary Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm text-muted-foreground\">Active Predictions</p>\r\n                <p className=\"text-2xl font-bold\">{state.predictions.length}</p>\r\n                <p className=\"text-xs text-green-600\">\r\n                  Avg 89% accuracy\r\n                </p>\r\n              </div>\r\n              <BarChart3 className=\"h-8 w-8 text-blue-500\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm text-muted-foreground\">Anomalies Detected</p>\r\n                <p className=\"text-2xl font-bold text-orange-600\">\r\n                  {state.anomalies.filter(a => a.status === 'new').length}\r\n                </p>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {state.anomalies.filter(a => a.severity === 'critical').length} critical\r\n                </p>\r\n              </div>\r\n              <AlertTriangle className=\"h-8 w-8 text-orange-500\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm text-muted-foreground\">AI Insights</p>\r\n                <p className=\"text-2xl font-bold\">{state.insights.length}</p>\r\n                <p className=\"text-xs text-purple-600\">\r\n                  {state.insights.filter(i => i.impact === 'high').length} high impact\r\n                </p>\r\n              </div>\r\n              <Lightbulb className=\"h-8 w-8 text-purple-500\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm text-muted-foreground\">Potential Savings</p>\r\n                <p className=\"text-2xl font-bold text-green-600\">\r\n                  {formatCurrency(\r\n                    state.insights\r\n                      .filter(i => i.potentialValue)\r\n                      .reduce((sum, i) => sum + (i.potentialValue || 0), 0)\r\n                  )}\r\n                </p>\r\n                <p className=\"text-xs text-muted-foreground\">Identified by AI</p>\r\n              </div>\r\n              <Target className=\"h-8 w-8 text-green-500\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Main Analytics Interface */}\r\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\r\n        <TabsList className=\"grid w-full grid-cols-4\">\r\n          <TabsTrigger value=\"predictions\">\r\n            <BarChart3 className=\"h-4 w-4 mr-2\" />\r\n            Predictions\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"anomalies\">\r\n            <AlertTriangle className=\"h-4 w-4 mr-2\" />\r\n            Anomalies\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"insights\">\r\n            <Lightbulb className=\"h-4 w-4 mr-2\" />\r\n            Insights\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"dashboard\">\r\n            <Gauge className=\"h-4 w-4 mr-2\" />\r\n            Dashboard\r\n          </TabsTrigger>\r\n        </TabsList>\r\n\r\n        {/* Predictions Tab */}\r\n        <TabsContent value=\"predictions\" className=\"space-y-6\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {/* Prediction List */}\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>Active Predictions</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <ScrollArea className=\"h-[400px]\">\r\n                  <div className=\"space-y-3\">\r\n                    {state.predictions.map((prediction) => {\r\n                      const Icon = getPredictionTypeIcon(prediction.type)\r\n                      return (\r\n                        <div\r\n                          key={prediction.id}\r\n                          className={`p-3 rounded-lg border cursor-pointer transition-colors ${\r\n                            selectedPrediction === prediction.id\r\n                              ? 'border-blue-500 bg-blue-50'\r\n                              : 'hover:bg-muted/50'\r\n                          }`}\r\n                          onClick={() => setSelectedPrediction(prediction.id)}\r\n                        >\r\n                          <div className=\"flex items-start justify-between\">\r\n                            <div className=\"flex items-start gap-3\">\r\n                              <Icon className=\"h-5 w-5 mt-0.5 text-blue-600\" />\r\n                              <div>\r\n                                <h4 className=\"font-medium\">{prediction.title}</h4>\r\n                                <p className=\"text-sm text-muted-foreground\">\r\n                                  {prediction.description}\r\n                                </p>\r\n                                <div className=\"flex items-center gap-2 mt-2\">\r\n                                  <Badge variant=\"outline\" className=\"text-xs\">\r\n                                    {prediction.confidence}% confidence\r\n                                  </Badge>\r\n                                  <Badge variant=\"outline\" className=\"text-xs\">\r\n                                    {prediction.timeHorizon.replace('_', ' ')}\r\n                                  </Badge>\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                            <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\r\n                          </div>\r\n                          <div className=\"mt-2\">\r\n                            <Progress value={prediction.accuracy} className=\"h-1\" />\r\n                            <p className=\"text-xs text-muted-foreground mt-1\">\r\n                              {prediction.accuracy}% historical accuracy\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n                      )\r\n                    })}\r\n                  </div>\r\n                </ScrollArea>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Prediction Details */}\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>Prediction Details</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                {selectedPrediction ? (\r\n                  (() => {\r\n                    const prediction = state.predictions.find(p => p.id === selectedPrediction)\r\n                    if (!prediction) return <div>Prediction not found</div>\r\n\r\n                    return (\r\n                      <div className=\"space-y-4\">\r\n                        <div>\r\n                          <h4 className=\"font-medium mb-2\">{prediction.title}</h4>\r\n                          <p className=\"text-sm text-muted-foreground mb-4\">\r\n                            {prediction.description}\r\n                          </p>\r\n                        </div>\r\n\r\n                        {/* Prediction Chart */}\r\n                        <div className=\"h-[250px]\">\r\n                          <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <ComposedChart data={prediction.predictions}>\r\n                              <CartesianGrid strokeDasharray=\"3 3\" />\r\n                              <XAxis dataKey=\"period\" />\r\n                              <YAxis />\r\n                              <Tooltip\r\n                                formatter={(value, name) => [\r\n                                  typeof value === 'number' ? formatCurrency(value) : value,\r\n                                  name\r\n                                ]}\r\n                              />\r\n                              <Area\r\n                                type=\"monotone\"\r\n                                dataKey=\"confidence_interval\"\r\n                                fill=\"#3b82f6\"\r\n                                fillOpacity={0.1}\r\n                                stroke=\"none\"\r\n                              />\r\n                              <Line\r\n                                type=\"monotone\"\r\n                                dataKey=\"value\"\r\n                                stroke=\"#3b82f6\"\r\n                                strokeWidth={2}\r\n                                dot={{ fill: '#3b82f6', strokeWidth: 2, r: 4 }}\r\n                              />\r\n                            </ComposedChart>\r\n                          </ResponsiveContainer>\r\n                        </div>\r\n\r\n                        {/* Recommendations */}\r\n                        {prediction.actionable && prediction.recommendations.length > 0 && (\r\n                          <div>\r\n                            <h5 className=\"font-medium mb-2\">AI Recommendations</h5>\r\n                            <div className=\"space-y-2\">\r\n                              {prediction.recommendations.map((rec, index) => (\r\n                                <div key={index} className=\"flex items-start gap-2 text-sm\">\r\n                                  <Zap className=\"h-4 w-4 text-yellow-500 mt-0.5\" />\r\n                                  <span>{rec}</span>\r\n                                </div>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    )\r\n                  })()\r\n                ) : (\r\n                  <div className=\"text-center py-8 text-muted-foreground\">\r\n                    <BarChart3 className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\r\n                    <p>Select a prediction to view details</p>\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        {/* Anomalies Tab */}\r\n        <TabsContent value=\"anomalies\" className=\"space-y-6\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n            {state.anomalies.map((anomaly) => (\r\n              <Card key={anomaly.id} className={`border-l-4 ${\r\n                anomaly.severity === 'critical' ? 'border-l-red-500' :\r\n                anomaly.severity === 'high' ? 'border-l-orange-500' :\r\n                anomaly.severity === 'medium' ? 'border-l-yellow-500' :\r\n                'border-l-green-500'\r\n              }`}>\r\n                <CardHeader className=\"pb-3\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <CardTitle className=\"text-base\">{anomaly.title}</CardTitle>\r\n                    <Badge className={getSeverityColor(anomaly.severity)}>\r\n                      {anomaly.severity.toUpperCase()}\r\n                    </Badge>\r\n                  </div>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-3\">\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    {anomaly.description}\r\n                  </p>\r\n\r\n                  <div className=\"space-y-2\">\r\n                    <div className=\"flex justify-between text-sm\">\r\n                      <span>Confidence:</span>\r\n                      <span className=\"font-medium\">{anomaly.confidence}%</span>\r\n                    </div>\r\n                    <Progress value={anomaly.confidence} className=\"h-2\" />\r\n                  </div>\r\n\r\n                  {anomaly.impactMetrics.cost && (\r\n                    <div className=\"text-sm\">\r\n                      <span className=\"text-muted-foreground\">Cost Impact: </span>\r\n                      <span className=\"font-medium text-red-600\">\r\n                        {formatCurrency(anomaly.impactMetrics.cost)}\r\n                      </span>\r\n                    </div>\r\n                  )}\r\n\r\n                  {anomaly.rootCause && (\r\n                    <div>\r\n                      <div className=\"text-sm font-medium mb-1\">Root Cause Analysis</div>\r\n                      <p className=\"text-xs text-muted-foreground bg-muted/50 p-2 rounded\">\r\n                        {anomaly.rootCause}\r\n                      </p>\r\n                    </div>\r\n                  )}\r\n\r\n                  {anomaly.suggestedActions.length > 0 && (\r\n                    <div>\r\n                      <div className=\"text-sm font-medium mb-2\">Suggested Actions</div>\r\n                      <div className=\"space-y-1\">\r\n                        {anomaly.suggestedActions.slice(0, 2).map((action, index) => (\r\n                          <Button key={index} size=\"sm\" variant=\"outline\" className=\"w-full justify-start text-xs\">\r\n                            {action}\r\n                          </Button>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"text-xs text-muted-foreground\">\r\n                    Detected: {format(new Date(anomaly.detectedAt), 'MMM dd, HH:mm')}\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        </TabsContent>\r\n\r\n        {/* Insights Tab */}\r\n        <TabsContent value=\"insights\" className=\"space-y-6\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {state.insights\r\n              .sort((a, b) => b.priority - a.priority)\r\n              .map((insight) => (\r\n                <Card key={insight.id} className=\"border-l-4 border-l-purple-500\">\r\n                  <CardHeader>\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <CardTitle className=\"text-lg\">{insight.title}</CardTitle>\r\n                      <div className=\"text-right\">\r\n                        <Badge className={getImpactColor(insight.impact)}>\r\n                          {insight.impact.toUpperCase()} IMPACT\r\n                        </Badge>\r\n                        <div className=\"text-sm text-muted-foreground mt-1\">\r\n                          {insight.confidence}% confidence\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-4\">\r\n                    <p className=\"text-muted-foreground\">{insight.description}</p>\r\n\r\n                    {insight.potentialValue && (\r\n                      <div className=\"bg-green-50 p-3 rounded-lg border border-green-200\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Target className=\"h-4 w-4 text-green-600\" />\r\n                          <span className=\"text-sm font-medium text-green-800\">\r\n                            Potential Value: {formatCurrency(insight.potentialValue)}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n\r\n                    <div>\r\n                      <div className=\"text-sm font-medium mb-2\">Supporting Evidence</div>\r\n                      <div className=\"space-y-1\">\r\n                        {insight.evidence.map((evidence, index) => (\r\n                          <div key={index} className=\"flex items-start gap-2 text-sm\">\r\n                            <CheckCircle className=\"h-3 w-3 text-green-500 mt-1\" />\r\n                            <span className=\"text-muted-foreground\">{evidence}</span>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div>\r\n                      <div className=\"text-sm font-medium mb-2\">Recommendations</div>\r\n                      <div className=\"space-y-2\">\r\n                        {insight.recommendations.map((rec, index) => (\r\n                          <Button key={index} size=\"sm\" variant=\"outline\" className=\"w-full justify-start\">\r\n                            <Zap className=\"h-3 w-3 mr-2 text-yellow-500\" />\r\n                            {rec}\r\n                          </Button>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\r\n                      <span>Complexity: {insight.implementationComplexity}</span>\r\n                      <span>Priority: {insight.priority}</span>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              ))}\r\n          </div>\r\n        </TabsContent>\r\n\r\n        {/* Dashboard Tab */}\r\n        <TabsContent value=\"dashboard\" className=\"space-y-6\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {/* AI Performance Overview */}\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>AI Model Performance</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"text-center\">\r\n                      <div className=\"text-2xl font-bold text-green-600\">94%</div>\r\n                      <div className=\"text-sm text-muted-foreground\">Prediction Accuracy</div>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                      <div className=\"text-2xl font-bold text-blue-600\">87%</div>\r\n                      <div className=\"text-sm text-muted-foreground\">Anomaly Detection</div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"h-[200px]\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                      <AreaChart data={[\r\n                        { period: 'Jan', accuracy: 91, detection: 85 },\r\n                        { period: 'Feb', accuracy: 93, detection: 86 },\r\n                        { period: 'Mar', accuracy: 94, detection: 87 },\r\n                        { period: 'Apr', accuracy: 92, detection: 88 },\r\n                        { period: 'May', accuracy: 95, detection: 89 },\r\n                        { period: 'Jun', accuracy: 94, detection: 87 }\r\n                      ]}>\r\n                        <CartesianGrid strokeDasharray=\"3 3\" />\r\n                        <XAxis dataKey=\"period\" />\r\n                        <YAxis domain={[80, 100]} />\r\n                        <Tooltip />\r\n                        <Area\r\n                          type=\"monotone\"\r\n                          dataKey=\"accuracy\"\r\n                          stackId=\"1\"\r\n                          stroke=\"#10b981\"\r\n                          fill=\"#10b981\"\r\n                          fillOpacity={0.6}\r\n                        />\r\n                        <Area\r\n                          type=\"monotone\"\r\n                          dataKey=\"detection\"\r\n                          stackId=\"2\"\r\n                          stroke=\"#3b82f6\"\r\n                          fill=\"#3b82f6\"\r\n                          fillOpacity={0.6}\r\n                        />\r\n                      </AreaChart>\r\n                    </ResponsiveContainer>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Real-time Alerts */}\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>Real-time AI Alerts</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <ScrollArea className=\"h-[300px]\">\r\n                  <div className=\"space-y-3\">\r\n                    {state.anomalies\r\n                      .filter(a => a.status === 'new')\r\n                      .slice(0, 5)\r\n                      .map((alert) => (\r\n                        <Alert key={alert.id} className={\r\n                          alert.severity === 'critical' ? 'border-red-500' : 'border-orange-500'\r\n                        }>\r\n                          <AlertTriangle className=\"h-4 w-4\" />\r\n                          <AlertDescription>\r\n                            <div className=\"flex items-center justify-between\">\r\n                              <span className=\"font-medium\">{alert.title}</span>\r\n                              <Badge className={getSeverityColor(alert.severity)}>\r\n                                {alert.severity}\r\n                              </Badge>\r\n                            </div>\r\n                            <p className=\"text-sm mt-1\">{alert.description}</p>\r\n                          </AlertDescription>\r\n                        </Alert>\r\n                      ))}\r\n                  </div>\r\n                </ScrollArea>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n        </TabsContent>\r\n      </Tabs>\r\n\r\n      {/* Last Updated */}\r\n      {state.lastUpdated && (\r\n        <div className=\"text-center text-sm text-muted-foreground\">\r\n          Last updated: {format(state.lastUpdated, 'MMM dd, yyyy HH:mm:ss')}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\auth\\OAuthButton.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLButtonElement' is not defined.","line":7,"column":63,"nodeType":"Identifier","messageId":"undef","endLine":7,"endColumn":80}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport * as React from 'react'\nimport { Button } from '@/components/ui/button'\nimport { cn } from '@/lib/utils'\n\ninterface OAuthButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {\n  provider: 'github' | 'google'\n  isLoading?: boolean\n}\n\nconst providerConfig = {\n  github: {\n    name: 'GitHub',\n    icon: (\n      <svg\n        viewBox=\"0 0 24 24\"\n        className=\"size-5\"\n        fill=\"currentColor\"\n        aria-hidden=\"true\"\n      >\n        <path\n          fillRule=\"evenodd\"\n          clipRule=\"evenodd\"\n          d=\"M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z\"\n        />\n      </svg>\n    ),\n  },\n  google: {\n    name: 'Google',\n    icon: (\n      <svg\n        viewBox=\"0 0 24 24\"\n        className=\"size-5\"\n        aria-hidden=\"true\"\n      >\n        <path\n          d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\"\n          fill=\"#4285F4\"\n        />\n        <path\n          d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\"\n          fill=\"#34A853\"\n        />\n        <path\n          d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\"\n          fill=\"#FBBC05\"\n        />\n        <path\n          d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\"\n          fill=\"#EA4335\"\n        />\n      </svg>\n    ),\n  },\n} as const\n\nexport function OAuthButton({\n  provider,\n  isLoading = false,\n  className,\n  disabled,\n  ...props\n}: OAuthButtonProps) {\n  const config = providerConfig[provider]\n\n  return (\n    <Button\n      type=\"button\"\n      variant=\"outline\"\n      disabled={isLoading || disabled}\n      className={cn(\n        'relative w-full h-11 px-4 py-2',\n        'bg-background hover:bg-accent',\n        'border border-border',\n        'text-foreground font-medium',\n        'rounded-lg',\n        'transition-all duration-200',\n        'focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',\n        'disabled:opacity-50 disabled:cursor-not-allowed',\n        className\n      )}\n      {...props}\n    >\n      <span className=\"absolute left-4 flex items-center justify-center\">\n        {config.icon}\n      </span>\n      <span className=\"flex-1 text-sm\">\n        {isLoading ? 'Connecting...' : `Continue with ${config.name}`}\n      </span>\n    </Button>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\catalog\\CatalogTable.tsx","messages":[{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":408,"column":19,"nodeType":"BlockStatement","messageId":"unexpected","endLine":408,"endColumn":21,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[18255,18255],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport React, { useEffect, useMemo, useState, useCallback } from 'react'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'\nimport { Input } from '@/components/ui/input'\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\nimport { DropdownMenu, DropdownMenuCheckboxItem, DropdownMenuContent, DropdownMenuLabel, DropdownMenuSeparator, DropdownMenuTrigger } from '@/components/ui/dropdown-menu'\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'\nimport { Badge } from '@/components/ui/badge'\nimport { RefreshCw, Package } from 'lucide-react'\nimport { Button } from '@/components/ui/button'\nimport { cn } from '@/lib/utils'\n\nfunction formatCost(value: number | undefined | null): string {\n  const n = Number(value ?? 0)\n  const fixed = n.toFixed(2)\n  const [intPart, decPart] = fixed.split('.')\n  const withSpaces = intPart.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ' ')\n  return `${withSpaces}.${decPart}`\n}\n\ntype CatalogRow = {\n  supplier_product_id: string\n  supplier_id: string\n  supplier_name: string\n  supplier_code?: string\n  supplier_sku: string\n  product_name: string\n  uom?: string\n  pack_size?: string\n  barcode?: string\n  category_id?: string\n  category_name?: string\n  is_active: boolean\n  first_seen_at?: string\n  last_seen_at?: string\n  current_price?: number\n  currency?: string\n}\n\nexport function CatalogTable() {\n  const [rows, setRows] = useState<CatalogRow[]>([])\n  const [loading, setLoading] = useState(false)\n  const [search, setSearch] = useState('')\n  const [page, setPage] = useState(1)\n  const [limit, setLimit] = useState(50)\n  const [total, setTotal] = useState(0)\n  const [suppliers, setSuppliers] = useState<{ supplier_id: string; name: string }[]>([])\n  const [categories, setCategories] = useState<Array<{ category_id?: string; id?: string; name: string }>>([])\n  const [supplierId, setSupplierId] = useState<string>('all')\n  const [categoryId, setCategoryId] = useState<string>('all')\n  const [isActive, setIsActive] = useState<'all' | 'active' | 'inactive'>('all')\n  const [priceMin, setPriceMin] = useState<string>('')\n  const [priceMax, setPriceMax] = useState<string>('')\n  const [sortBy, setSortBy] = useState<'supplier_name' | 'supplier_sku' | 'product_name' | 'category_name' | 'current_price' | 'last_seen_at'>('supplier_name')\n  const [sortDir, setSortDir] = useState<'asc' | 'desc'>('asc')\n  const [visibleCols, setVisibleCols] = useState<Record<string, boolean>>({\n    supplier: true,\n    supplier_code: false,\n    sku: true,\n    name: true,\n    brand: false,\n    uom: false,\n    pack_size: false,\n    barcode: false,\n    category: true,\n    soh: true,\n    on_order: true,\n    price: true,\n    vat: true,\n    currency: false,\n    first_seen: false,\n    last_seen: false,\n    active: false,\n  })\n  const [detailId, setDetailId] = useState<string | null>(null)\n  const [detail, setDetail] = useState<any>(null)\n  const [history, setHistory] = useState<any[]>([])\n\n  const fetchData = useCallback(async () => {\n    setLoading(true)\n    try {\n      const params = new URLSearchParams()\n      if (search) params.set('search', search)\n      if (supplierId && supplierId !== 'all') params.append('supplier_id', supplierId)\n      if (categoryId && categoryId !== 'all') {\n        if (categoryId.startsWith('raw:')) {\n          params.append('category_raw', categoryId.slice(4))\n        } else {\n          params.append('category_id', categoryId)\n        }\n      }\n      if (isActive !== 'all') params.set('is_active', String(isActive === 'active'))\n      if (priceMin) params.set('price_min', priceMin)\n      if (priceMax) params.set('price_max', priceMax)\n      params.set('sort_by', sortBy)\n      params.set('sort_dir', sortDir)\n      params.set('page', String(page))\n      params.set('limit', String(limit))\n      const res = await fetch(`/api/catalog/products?${params}`)\n      if (!res.ok) throw new Error('Failed to load catalog')\n      const data = await res.json()\n      setRows(data.data || [])\n      setTotal(data.pagination?.total || 0)\n    } catch (err) {\n      console.error('Catalog load error:', err)\n      setRows([])\n      setTotal(0)\n    } finally {\n      setLoading(false)\n    }\n  }, [search, supplierId, categoryId, isActive, priceMin, priceMax, sortBy, sortDir, page, limit])\n\n  useEffect(() => {\n    fetchData()\n  }, [fetchData])\n\n  // Load filter data\n  useEffect(() => {\n    ;(async () => {\n      try {\n        const [sres, cres] = await Promise.all([\n          fetch('/api/catalog/suppliers'),\n          fetch('/api/catalog/categories'),\n        ])\n        const sjson = await sres.json()\n        const cjson = await cres.json()\n        setSuppliers(sjson.data || [])\n        setCategories(cjson.data || [])\n      } catch (e) {\n        // ignore\n      }\n    })()\n  }, [])\n\n  const pageCount = useMemo(() => Math.max(1, Math.ceil(total / limit)), [total, limit])\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Package className=\"h-5 w-5\" />\n          Supplier Inventory Portfolio\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"flex flex-wrap items-center gap-3 mb-4\">\n          <Input\n            placeholder=\"Search by name or SKU\"\n            value={search}\n            onChange={e => setSearch(e.target.value)}\n            className=\"max-w-sm\"\n          />\n          <Select value={supplierId} onValueChange={setSupplierId}>\n            <SelectTrigger className=\"w-[220px]\"><SelectValue /></SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All suppliers</SelectItem>\n              {suppliers.filter(s => s && s.supplier_id).map(s => (\n                <SelectItem key={s.supplier_id} value={s.supplier_id}>{s.name}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Select value={categoryId} onValueChange={setCategoryId}>\n            <SelectTrigger className=\"w-[220px]\"><SelectValue /></SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All categories</SelectItem>\n              {categories.filter(c => !!c).map((c: any) => (\n                <SelectItem key={String(c.category_id ?? c.id)} value={String(c.category_id ?? c.id)}>{c.name}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Select value={isActive} onValueChange={v => setIsActive(v as any)}>\n            <SelectTrigger className=\"w-[140px]\"><SelectValue /></SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All statuses</SelectItem>\n              <SelectItem value=\"active\">Active</SelectItem>\n              <SelectItem value=\"inactive\">Inactive</SelectItem>\n            </SelectContent>\n          </Select>\n          <Input placeholder=\"Min price\" value={priceMin} onChange={e => setPriceMin(e.target.value)} className=\"w-24\" />\n          <Input placeholder=\"Max price\" value={priceMax} onChange={e => setPriceMax(e.target.value)} className=\"w-24\" />\n          <Button variant=\"outline\" onClick={() => fetchData()} disabled={loading}>\n            <RefreshCw className={cn('h-4 w-4 mr-2', loading && 'animate-spin')} />\n            Refresh\n          </Button>\n          <div className=\"ml-auto text-sm text-muted-foreground\">\n            {total.toLocaleString()} items\n          </div>\n        </div>\n\n        <div className=\"flex items-center justify-between mb-2\">\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" size=\"sm\">Columns</Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"start\">\n              <DropdownMenuLabel>Toggle columns</DropdownMenuLabel>\n              <DropdownMenuSeparator />\n              {[\n                { key: 'supplier', label: 'Supplier' },\n                { key: 'supplier_code', label: 'Supplier Code' },\n                { key: 'sku', label: 'SKU' },\n                { key: 'name', label: 'Product Name' },\n                { key: 'brand', label: 'Brand' },\n                { key: 'uom', label: 'UOM' },\n                { key: 'pack_size', label: 'Pack Size' },\n                { key: 'barcode', label: 'Barcode' },\n                { key: 'category', label: 'Category' },\n                { key: 'soh', label: 'Stock on Hand' },\n                { key: 'on_order', label: 'Stock on Order' },\n                { key: 'price', label: 'Cost Price' },\n                { key: 'vat', label: 'VAT (15%)' },\n                { key: 'currency', label: 'Currency' },\n                { key: 'first_seen', label: 'First Seen' },\n                { key: 'last_seen', label: 'Last Seen' },\n                { key: 'active', label: 'Active' },\n              ].map(c => (\n                <DropdownMenuCheckboxItem\n                  key={c.key}\n                  checked={visibleCols[c.key]}\n                  onCheckedChange={(v) => setVisibleCols(s => ({ ...s, [c.key]: !!v }))}\n                >{c.label}</DropdownMenuCheckboxItem>\n              ))}\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n\n        <div className=\"rounded-md border overflow-auto\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                {visibleCols.supplier && (\n                  <TableHead className=\"cursor-pointer\" onClick={() => { setSortBy('supplier_name'); setSortDir(d => d === 'asc' ? 'desc' : 'asc') }}>Supplier</TableHead>\n                )}\n                {visibleCols.supplier_code && (\n                  <TableHead className=\"cursor-pointer\" onClick={() => { setSortBy('supplier_name'); setSortDir(d => d === 'asc' ? 'desc' : 'asc') }}>Code</TableHead>\n                )}\n                {visibleCols.sku && (\n                  <TableHead className=\"cursor-pointer\" onClick={() => { setSortBy('supplier_sku'); setSortDir(d => d === 'asc' ? 'desc' : 'asc') }}>SKU</TableHead>\n                )}\n                {visibleCols.name && (\n                  <TableHead className=\"cursor-pointer\" onClick={() => { setSortBy('product_name'); setSortDir(d => d === 'asc' ? 'desc' : 'asc') }}>Product Name</TableHead>\n                )}\n                {visibleCols.brand && (\n                  <TableHead>Brand</TableHead>\n                )}\n                {visibleCols.uom && (\n                  <TableHead>UOM</TableHead>\n                )}\n                {visibleCols.pack_size && (\n                  <TableHead>Pack Size</TableHead>\n                )}\n                {visibleCols.barcode && (\n                  <TableHead>Barcode</TableHead>\n                )}\n                {visibleCols.category && (\n                  <TableHead className=\"cursor-pointer\" onClick={() => { setSortBy('category_name'); setSortDir(d => d === 'asc' ? 'desc' : 'asc') }}>Category</TableHead>\n                )}\n                {visibleCols.soh && (\n                  <TableHead className=\"text-right\">Stock on Hand</TableHead>\n                )}\n                {visibleCols.on_order && (\n                  <TableHead className=\"text-right\">Stock on Order</TableHead>\n                )}\n                {visibleCols.price && (\n                  <TableHead className=\"text-right cursor-pointer\" onClick={() => { setSortBy('current_price'); setSortDir(d => d === 'asc' ? 'desc' : 'asc') }}>Cost Price</TableHead>\n                )}\n                {visibleCols.vat && (\n                  <TableHead className=\"text-right\">VAT (15%)</TableHead>\n                )}\n                {visibleCols.currency && (\n                  <TableHead className=\"text-right\">Currency</TableHead>\n                )}\n                {visibleCols.first_seen && (\n                  <TableHead className=\"cursor-pointer\" onClick={() => { setSortBy('first_seen_at' as any); setSortDir(d => d === 'asc' ? 'desc' : 'asc') }}>First Seen</TableHead>\n                )}\n                {visibleCols.last_seen && (\n                  <TableHead className=\"cursor-pointer\" onClick={() => { setSortBy('last_seen_at'); setSortDir(d => d === 'asc' ? 'desc' : 'asc') }}>Last Seen</TableHead>\n                )}\n                {visibleCols.active && (\n                  <TableHead>Active</TableHead>\n                )}\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {rows.map((r) => (\n                <TableRow key={r.supplier_product_id} className=\"cursor-pointer\" onClick={() => { setDetailId(r.supplier_product_id) }}>\n                  {visibleCols.supplier && (\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"font-medium\">{r.supplier_name || 'Unknown Supplier'}</span>\n                        {!r.is_active && <Badge variant=\"secondary\">inactive</Badge>}\n                      </div>\n                    </TableCell>\n                  )}\n                  {visibleCols.supplier_code && (\n                    <TableCell className=\"text-muted-foreground\">{r.supplier_code || '-'}</TableCell>\n                  )}\n                  {visibleCols.sku && (\n                    <TableCell className=\"text-muted-foreground\">{r.supplier_sku}</TableCell>\n                  )}\n                  {visibleCols.name && (\n                    <TableCell>{r.product_name || 'Product Details Unavailable'}</TableCell>\n                  )}\n                  {visibleCols.brand && (\n                    <TableCell className=\"text-muted-foreground\">{(r as any).brand || '-'}</TableCell>\n                  )}\n                  {visibleCols.uom && (\n                    <TableCell className=\"text-muted-foreground\">{r.uom || '-'}</TableCell>\n                  )}\n                  {visibleCols.pack_size && (\n                    <TableCell className=\"text-muted-foreground\">{r.pack_size || '-'}</TableCell>\n                  )}\n                  {visibleCols.barcode && (\n                    <TableCell className=\"text-muted-foreground\">{r.barcode || '-'}</TableCell>\n                  )}\n                  {visibleCols.category && (\n                    <TableCell className=\"text-muted-foreground\">{r.category_name || '-'}</TableCell>\n                  )}\n                  {visibleCols.soh && (\n                    <TableCell className=\"text-right\">{(r as any).qty_on_hand ?? 0}</TableCell>\n                  )}\n                  {visibleCols.on_order && (\n                    <TableCell className=\"text-right\">{(r as any).qty_on_order ?? 0}</TableCell>\n                  )}\n                  {visibleCols.price && (\n                    <TableCell className=\"text-right\">{formatCost(r.current_price)}</TableCell>\n                  )}\n                  {visibleCols.vat && (\n                    <TableCell className=\"text-right\">{formatCost(((r.current_price ?? 0) as number) * 0.15)}</TableCell>\n                  )}\n                  {visibleCols.currency && (\n                    <TableCell className=\"text-right\">{r.currency || 'ZAR'}</TableCell>\n                  )}\n                  {visibleCols.first_seen && (\n                    <TableCell className=\"text-muted-foreground\">{r.first_seen_at ? new Date(r.first_seen_at).toLocaleDateString() : '-'}</TableCell>\n                  )}\n                  {visibleCols.last_seen && (\n                    <TableCell className=\"text-muted-foreground\">{r.last_seen_at ? new Date(r.last_seen_at).toLocaleDateString() : '-'}</TableCell>\n                  )}\n                  {visibleCols.active && (\n                    <TableCell className=\"text-muted-foreground\">{r.is_active ? 'Yes' : 'No'}</TableCell>\n                  )}\n                </TableRow>\n              ))}\n              {rows.length === 0 && !loading && (\n                <TableRow>\n                  <TableCell colSpan={5} className=\"text-center text-sm text-muted-foreground py-8\">\n                    No results\n                  </TableCell>\n                </TableRow>\n              )}\n            </TableBody>\n          </Table>\n        </div>\n\n        {/* Pagination */}\n        <div className=\"flex items-center justify-between mt-3 text-sm\">\n          <div>\n            Page {page} of {pageCount}\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Button variant=\"outline\" size=\"sm\" disabled={page <= 1} onClick={() => setPage((p) => Math.max(1, p - 1))}>\n              Prev\n            </Button>\n            <Select value={String(limit)} onValueChange={(v) => { setLimit(parseInt(v, 10)); setPage(1) }}>\n              <SelectTrigger className=\"w-24\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {[25, 50, 100, 200].map(n => (\n                  <SelectItem key={n} value={String(n)}>{n} / page</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <Button variant=\"outline\" size=\"sm\" disabled={page >= pageCount} onClick={() => setPage((p) => Math.min(pageCount, p + 1))}>\n              Next\n            </Button>\n          </div>\n        </div>\n      </CardContent>\n      {/* Details Modal */}\n      <Dialog open={!!detailId} onOpenChange={(o) => { if (!o) { setDetailId(null); setDetail(null); setHistory([]) } }}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Product Details</DialogTitle>\n          </DialogHeader>\n          <ProductDetailBody id={detailId} detail={detail} setDetail={setDetail} history={history} setHistory={setHistory} />\n        </DialogContent>\n      </Dialog>\n    </Card>\n  )\n}\n\nfunction ProductDetailBody({ id, detail, setDetail, history, setHistory }: { id: string | null, detail: any, setDetail: (d: any) => void, history: any[], setHistory: (h: any[]) => void }) {\n  useEffect(() => {\n    if (!id) return\n    ;(async () => {\n      try {\n        const [dres, hres] = await Promise.all([\n          fetch(`/api/catalog/products/${id}`),\n          fetch(`/api/catalog/products/${id}/price-history?limit=50`)\n        ])\n        const dj = await dres.json(); const hj = await hres.json()\n        setDetail(dj.data || null)\n        setHistory(hj.data || [])\n      } catch (e) {}\n    })()\n  }, [id])\n\n  if (!id) return null\n  return (\n    <div className=\"space-y-4\">\n      {detail ? (\n        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n          <div><span className=\"text-muted-foreground\">Supplier</span><div className=\"font-medium\">{detail.supplier_name}</div></div>\n          <div><span className=\"text-muted-foreground\">SKU</span><div className=\"font-medium\">{detail.supplier_sku}</div></div>\n          <div className=\"col-span-2\"><span className=\"text-muted-foreground\">Product Name</span><div className=\"font-medium\">{detail.name_from_supplier}</div></div>\n          <div><span className=\"text-muted-foreground\">Category</span><div className=\"font-medium\">{detail.category_name || '-'}</div></div>\n          <div><span className=\"text-muted-foreground\">Cost Price</span><div className=\"font-medium\">{formatCost(detail.current_price)}</div></div>\n        </div>\n      ) : (\n        <div className=\"text-sm text-muted-foreground\">Loading details…</div>\n      )}\n      <div>\n        <div className=\"text-sm font-medium mb-2\">Price History</div>\n        <div className=\"border rounded-md max-h-48 overflow-auto\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Valid From</TableHead>\n                <TableHead>Valid To</TableHead>\n                <TableHead className=\"text-right\">Price</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {history.map((h, i) => (\n                <TableRow key={i}>\n                  <TableCell>{new Date(h.valid_from).toLocaleString()}</TableCell>\n                  <TableCell>{h.valid_to ? new Date(h.valid_to).toLocaleString() : '-'}</TableCell>\n                  <TableCell className=\"text-right\">{formatCost(h.price)}</TableCell>\n                </TableRow>\n              ))}\n              {history.length === 0 && (\n                <TableRow>\n                  <TableCell colSpan={3} className=\"text-center text-sm text-muted-foreground py-4\">No history</TableCell>\n                </TableRow>\n              )}\n            </TableBody>\n          </Table>\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\catalog\\ai-categorization\\ProgressMonitor.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":111,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":111,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Pause, Play, X, Clock, CheckCircle2, XCircle, AlertTriangle } from \"lucide-react\"\r\nimport { toast } from \"sonner\"\r\n\r\ninterface Job {\r\n  job_id: string\r\n  job_type: string\r\n  status: string\r\n  total_products: number\r\n  processed_products: number\r\n  successful_categorizations: number\r\n  failed_categorizations: number\r\n  created_at: string\r\n  started_at: string | null\r\n}\r\n\r\ninterface JobStatus {\r\n  job: Job\r\n  progress_percentage: number\r\n  eta_seconds: number | null\r\n  current_batch_number: number\r\n  batches_completed: number\r\n  batches_remaining: number\r\n  recent_errors: string[]\r\n  performance_metrics: {\r\n    avg_products_per_second: number\r\n    avg_tokens_per_product: number\r\n    success_rate: number\r\n  }\r\n}\r\n\r\ninterface ProgressMonitorProps {\r\n  jobId: string\r\n  onJobComplete?: () => void\r\n}\r\n\r\nexport function ProgressMonitor({ jobId, onJobComplete }: ProgressMonitorProps) {\r\n  const [jobStatus, setJobStatus] = useState<JobStatus | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  useEffect(() => {\r\n    fetchJobStatus()\r\n    const interval = setInterval(fetchJobStatus, 3000) // Poll every 3 seconds\r\n\r\n    return () => clearInterval(interval)\r\n  }, [jobId])\r\n\r\n  const fetchJobStatus = async () => {\r\n    try {\r\n      const response = await fetch(`/api/category/ai-categorization/status/${jobId}`)\r\n      const data = await response.json()\r\n\r\n      if (data.success) {\r\n        setJobStatus(data.job)\r\n\r\n        // Check if job completed\r\n        if (data.job.job.status === \"completed\" && onJobComplete) {\r\n          onJobComplete()\r\n        }\r\n      }\r\n      setLoading(false)\r\n    } catch (error) {\r\n      console.error(\"Failed to fetch job status:\", error)\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const pauseJob = async () => {\r\n    try {\r\n      const response = await fetch(`/api/category/ai-categorization/pause/${jobId}`, {\r\n        method: \"POST\",\r\n      })\r\n      const data = await response.json()\r\n\r\n      if (data.success) {\r\n        toast.success(\"Job paused\")\r\n        fetchJobStatus()\r\n      } else {\r\n        toast.error(data.message || \"Failed to pause job\")\r\n      }\r\n    } catch (error) {\r\n      toast.error(\"Failed to pause job\")\r\n    }\r\n  }\r\n\r\n  const resumeJob = async () => {\r\n    try {\r\n      const response = await fetch(`/api/category/ai-categorization/resume/${jobId}`, {\r\n        method: \"POST\",\r\n      })\r\n      const data = await response.json()\r\n\r\n      if (data.success) {\r\n        toast.success(\"Job resumed\")\r\n        fetchJobStatus()\r\n      } else {\r\n        toast.error(data.message || \"Failed to resume job\")\r\n      }\r\n    } catch (error) {\r\n      toast.error(\"Failed to resume job\")\r\n    }\r\n  }\r\n\r\n  const cancelJob = async () => {\r\n    if (!confirm(\"Are you sure you want to cancel this job?\")) return\r\n\r\n    try {\r\n      const response = await fetch(`/api/category/ai-categorization/cancel/${jobId}`, {\r\n        method: \"POST\",\r\n      })\r\n      const data = await response.json()\r\n\r\n      if (data.success) {\r\n        toast.success(\"Job cancelled\")\r\n        fetchJobStatus()\r\n      } else {\r\n        toast.error(data.message || \"Failed to cancel job\")\r\n      }\r\n    } catch (error) {\r\n      toast.error(\"Failed to cancel job\")\r\n    }\r\n  }\r\n\r\n  if (loading || !jobStatus) {\r\n    return (\r\n      <Card>\r\n        <CardContent className=\"p-6\">\r\n          <p className=\"text-center text-muted-foreground\">Loading job status...</p>\r\n        </CardContent>\r\n      </Card>\r\n    )\r\n  }\r\n\r\n  const job = jobStatus.job\r\n  const progress = Number(jobStatus.progress_percentage)\r\n  const eta = jobStatus.eta_seconds ? Number(jobStatus.eta_seconds) : null\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    switch (status) {\r\n      case \"running\":\r\n        return <Badge variant=\"default\" className=\"bg-blue-500\">Running</Badge>\r\n      case \"completed\":\r\n        return <Badge variant=\"default\" className=\"bg-green-500\">Completed</Badge>\r\n      case \"paused\":\r\n        return <Badge variant=\"secondary\">Paused</Badge>\r\n      case \"failed\":\r\n        return <Badge variant=\"destructive\">Failed</Badge>\r\n      case \"cancelled\":\r\n        return <Badge variant=\"outline\">Cancelled</Badge>\r\n      default:\r\n        return <Badge variant=\"outline\">{status}</Badge>\r\n    }\r\n  }\r\n\r\n  const formatETA = (seconds: number | null) => {\r\n    if (!seconds) return \"Calculating...\"\r\n    if (seconds < 60) return `${Math.round(seconds)}s`\r\n    if (seconds < 3600) return `${Math.round(seconds / 60)}m`\r\n    return `${Math.round(seconds / 3600)}h ${Math.round((seconds % 3600) / 60)}m`\r\n  }\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              Job Progress\r\n              {getStatusBadge(job.status)}\r\n            </CardTitle>\r\n            <CardDescription>Job ID: {job.job_id}</CardDescription>\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            {job.status === \"running\" && (\r\n              <>\r\n                <Button size=\"sm\" variant=\"outline\" onClick={pauseJob}>\r\n                  <Pause className=\"h-4 w-4 mr-1\" />\r\n                  Pause\r\n                </Button>\r\n                <Button size=\"sm\" variant=\"destructive\" onClick={cancelJob}>\r\n                  <X className=\"h-4 w-4 mr-1\" />\r\n                  Cancel\r\n                </Button>\r\n              </>\r\n            )}\r\n            {job.status === \"paused\" && (\r\n              <Button size=\"sm\" onClick={resumeJob}>\r\n                <Play className=\"h-4 w-4 mr-1\" />\r\n                Resume\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-4\">\r\n        {/* Progress Bar */}\r\n        <div className=\"space-y-2\">\r\n          <div className=\"flex justify-between text-sm\">\r\n            <span>Progress: {progress.toFixed(1)}%</span>\r\n            <span>\r\n              {job.processed_products} / {job.total_products} products\r\n            </span>\r\n          </div>\r\n          <Progress value={progress} className=\"h-2\" />\r\n        </div>\r\n\r\n        {/* Stats Grid */}\r\n        <div className=\"grid gap-4 md:grid-cols-4\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\r\n            <div>\r\n              <p className=\"text-2xl font-bold\">{job.successful_categorizations}</p>\r\n              <p className=\"text-xs text-muted-foreground\">Successful</p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <XCircle className=\"h-4 w-4 text-red-500\" />\r\n            <div>\r\n              <p className=\"text-2xl font-bold\">{job.failed_categorizations}</p>\r\n              <p className=\"text-xs text-muted-foreground\">Failed</p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <Clock className=\"h-4 w-4 text-blue-500\" />\r\n            <div>\r\n              <p className=\"text-2xl font-bold\">{formatETA(eta)}</p>\r\n              <p className=\"text-xs text-muted-foreground\">ETA</p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />\r\n            <div>\r\n              <p className=\"text-2xl font-bold\">\r\n                {Number(jobStatus.performance_metrics.success_rate).toFixed(1)}%\r\n              </p>\r\n              <p className=\"text-xs text-muted-foreground\">Success Rate</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Batch Info */}\r\n        <div className=\"text-sm text-muted-foreground\">\r\n          <p>\r\n            Batch {jobStatus.current_batch_number} of{\" \"}\r\n            {jobStatus.batches_completed + jobStatus.batches_remaining}\r\n          </p>\r\n          <p>\r\n            Speed: {Number(jobStatus.performance_metrics.avg_products_per_second).toFixed(2)} products/sec\r\n          </p>\r\n        </div>\r\n\r\n        {/* Recent Errors */}\r\n        {jobStatus.recent_errors.length > 0 && (\r\n          <div className=\"space-y-2\">\r\n            <p className=\"text-sm font-medium text-red-600\">Recent Errors:</p>\r\n            <ul className=\"text-xs space-y-1 text-muted-foreground\">\r\n              {jobStatus.recent_errors.slice(0, 3).map((error, i) => (\r\n                <li key={i} className=\"truncate\">\r\n                  • {error}\r\n                </li>\r\n              ))}\r\n            </ul>\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\customers\\CustomerTable.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":456,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":456,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useMemo, useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport {\n  useReactTable,\n  getCoreRowModel,\n  getSortedRowModel,\n  getPaginationRowModel,\n  getFilteredRowModel,\n  ColumnDef,\n  SortingState,\n  flexRender,\n} from '@tanstack/react-table';\nimport {\n  ArrowUpDown,\n  ArrowUp,\n  ArrowDown,\n  Eye,\n  Pencil,\n  Trash2,\n  Mail,\n  MoreHorizontal,\n  ChevronLeft,\n  ChevronRight,\n  ChevronsLeft,\n  ChevronsRight,\n} from 'lucide-react';\nimport { formatDistanceToNow } from 'date-fns';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\n\ninterface Customer {\n  id: string;\n  name: string;\n  email: string | null;\n  phone: string | null;\n  company: string | null;\n  segment: string | null;\n  status: string | null;\n  lifetime_value: number | null;\n  acquisition_date: string | null;\n  last_interaction_date: string | null;\n  tags: string[] | null;\n  created_at: string;\n}\n\ninterface CustomerTableProps {\n  customers: Customer[];\n  visibleColumns: string[];\n  onDeleteCustomer: (id: string) => void;\n  onRefresh: () => void;\n}\n\n/**\n * CustomerTable Component\n *\n * Advanced data table with TanStack Table\n * Features:\n * - Multi-column sorting\n * - Pagination with size selector\n * - Row selection\n * - Quick actions per row\n * - Responsive design\n * - Value-based color coding\n */\nexport function CustomerTable({\n  customers,\n  visibleColumns,\n  onDeleteCustomer,\n  onRefresh,\n}: CustomerTableProps) {\n  const router = useRouter();\n  const [sorting, setSorting] = useState<SortingState>([]);\n  const [pageSize, setPageSize] = useState(25);\n\n  // Status badge configuration\n  const getStatusBadge = (status: string | null) => {\n    if (!status) return null;\n\n    const config: Record<string, { color: string; label: string }> = {\n      active: { color: 'bg-green-100 text-green-800', label: 'Active' },\n      inactive: { color: 'bg-gray-100 text-gray-800', label: 'Inactive' },\n      prospect: { color: 'bg-blue-100 text-blue-800', label: 'Prospect' },\n      churned: { color: 'bg-red-100 text-red-800', label: 'Churned' },\n    };\n\n    const { color, label } = config[status] || { color: 'bg-gray-100 text-gray-800', label: status };\n\n    return (\n      <Badge className={`${color} font-medium`}>\n        {label}\n      </Badge>\n    );\n  };\n\n  // Segment badge configuration\n  const getSegmentBadge = (segment: string | null) => {\n    if (!segment) return <span className=\"text-sm text-gray-400\">-</span>;\n\n    const config: Record<string, { color: string; label: string }> = {\n      individual: { color: 'bg-gray-100 text-gray-700', label: 'Individual' },\n      startup: { color: 'bg-yellow-100 text-yellow-800', label: 'Startup' },\n      smb: { color: 'bg-green-100 text-green-800', label: 'SMB' },\n      mid_market: { color: 'bg-blue-100 text-blue-800', label: 'Mid Market' },\n      enterprise: { color: 'bg-purple-100 text-purple-800', label: 'Enterprise' },\n    };\n\n    const { color, label } = config[segment] || { color: 'bg-gray-100 text-gray-800', label: segment };\n\n    return (\n      <Badge className={`${color} font-medium`}>\n        {label}\n      </Badge>\n    );\n  };\n\n  // Lifetime value with color coding\n  const getLifetimeValueDisplay = (value: number | null) => {\n    if (value === null || value === undefined) {\n      return <span className=\"text-sm text-gray-400\">$0.00</span>;\n    }\n\n    let colorClass = 'text-gray-600';\n    let bgClass = 'bg-gray-50';\n\n    if (value > 50000) {\n      colorClass = 'text-purple-700 font-semibold';\n      bgClass = 'bg-purple-50';\n    } else if (value > 20000) {\n      colorClass = 'text-blue-700 font-semibold';\n      bgClass = 'bg-blue-50';\n    } else if (value > 5000) {\n      colorClass = 'text-green-700 font-semibold';\n      bgClass = 'bg-green-50';\n    } else if (value > 1000) {\n      colorClass = 'text-yellow-700 font-medium';\n      bgClass = 'bg-yellow-50';\n    }\n\n    return (\n      <span className={`text-sm ${colorClass} ${bgClass} px-2 py-1 rounded`}>\n        {new Intl.NumberFormat('en-US', {\n          style: 'currency',\n          currency: 'USD',\n          minimumFractionDigits: 0,\n          maximumFractionDigits: 0,\n        }).format(value)}\n      </span>\n    );\n  };\n\n  // Relative date with tooltip\n  const getRelativeDate = (dateString: string | null) => {\n    if (!dateString) return <span className=\"text-sm text-gray-400\">-</span>;\n\n    const date = new Date(dateString);\n    const relativeTime = formatDistanceToNow(date, { addSuffix: true });\n    const absoluteDate = date.toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n    });\n\n    return (\n      <TooltipProvider>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <span className=\"text-sm text-gray-700 cursor-help\">\n              {relativeTime}\n            </span>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p>{absoluteDate}</p>\n          </TooltipContent>\n        </Tooltip>\n      </TooltipProvider>\n    );\n  };\n\n  // Column definitions\n  const columns = useMemo<ColumnDef<Customer>[]>(\n    () => [\n      {\n        id: 'name',\n        accessorKey: 'name',\n        header: ({ column }) => (\n          <button\n            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}\n            className=\"flex items-center gap-2 hover:text-gray-900 font-semibold\"\n          >\n            Name\n            {column.getIsSorted() === 'asc' ? (\n              <ArrowUp className=\"h-4 w-4\" />\n            ) : column.getIsSorted() === 'desc' ? (\n              <ArrowDown className=\"h-4 w-4\" />\n            ) : (\n              <ArrowUpDown className=\"h-4 w-4 opacity-30\" />\n            )}\n          </button>\n        ),\n        cell: ({ row }) => (\n          <div className=\"font-medium text-gray-900\">{row.original.name}</div>\n        ),\n      },\n      {\n        id: 'email',\n        accessorKey: 'email',\n        header: ({ column }) => (\n          <button\n            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}\n            className=\"flex items-center gap-2 hover:text-gray-900 font-semibold\"\n          >\n            Email\n            {column.getIsSorted() === 'asc' ? (\n              <ArrowUp className=\"h-4 w-4\" />\n            ) : column.getIsSorted() === 'desc' ? (\n              <ArrowDown className=\"h-4 w-4\" />\n            ) : (\n              <ArrowUpDown className=\"h-4 w-4 opacity-30\" />\n            )}\n          </button>\n        ),\n        cell: ({ row }) => (\n          <span className=\"text-sm text-gray-700\">\n            {row.original.email || <span className=\"text-gray-400\">-</span>}\n          </span>\n        ),\n      },\n      {\n        id: 'phone',\n        accessorKey: 'phone',\n        header: 'Phone',\n        cell: ({ row }) => (\n          <span className=\"text-sm text-gray-700\">\n            {row.original.phone || <span className=\"text-gray-400\">-</span>}\n          </span>\n        ),\n      },\n      {\n        id: 'company',\n        accessorKey: 'company',\n        header: ({ column }) => (\n          <button\n            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}\n            className=\"flex items-center gap-2 hover:text-gray-900 font-semibold\"\n          >\n            Company\n            {column.getIsSorted() === 'asc' ? (\n              <ArrowUp className=\"h-4 w-4\" />\n            ) : column.getIsSorted() === 'desc' ? (\n              <ArrowDown className=\"h-4 w-4\" />\n            ) : (\n              <ArrowUpDown className=\"h-4 w-4 opacity-30\" />\n            )}\n          </button>\n        ),\n        cell: ({ row }) => (\n          <span className=\"text-sm text-gray-700\">\n            {row.original.company || <span className=\"text-gray-400\">-</span>}\n          </span>\n        ),\n      },\n      {\n        id: 'segment',\n        accessorKey: 'segment',\n        header: ({ column }) => (\n          <button\n            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}\n            className=\"flex items-center gap-2 hover:text-gray-900 font-semibold\"\n          >\n            Segment\n            {column.getIsSorted() === 'asc' ? (\n              <ArrowUp className=\"h-4 w-4\" />\n            ) : column.getIsSorted() === 'desc' ? (\n              <ArrowDown className=\"h-4 w-4\" />\n            ) : (\n              <ArrowUpDown className=\"h-4 w-4 opacity-30\" />\n            )}\n          </button>\n        ),\n        cell: ({ row }) => getSegmentBadge(row.original.segment),\n      },\n      {\n        id: 'status',\n        accessorKey: 'status',\n        header: ({ column }) => (\n          <button\n            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}\n            className=\"flex items-center gap-2 hover:text-gray-900 font-semibold\"\n          >\n            Status\n            {column.getIsSorted() === 'asc' ? (\n              <ArrowUp className=\"h-4 w-4\" />\n            ) : column.getIsSorted() === 'desc' ? (\n              <ArrowDown className=\"h-4 w-4\" />\n            ) : (\n              <ArrowUpDown className=\"h-4 w-4 opacity-30\" />\n            )}\n          </button>\n        ),\n        cell: ({ row }) => getStatusBadge(row.original.status),\n      },\n      {\n        id: 'lifetime_value',\n        accessorKey: 'lifetime_value',\n        header: ({ column }) => (\n          <button\n            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}\n            className=\"flex items-center gap-2 hover:text-gray-900 font-semibold\"\n          >\n            Lifetime Value\n            {column.getIsSorted() === 'asc' ? (\n              <ArrowUp className=\"h-4 w-4\" />\n            ) : column.getIsSorted() === 'desc' ? (\n              <ArrowDown className=\"h-4 w-4\" />\n            ) : (\n              <ArrowUpDown className=\"h-4 w-4 opacity-30\" />\n            )}\n          </button>\n        ),\n        cell: ({ row }) => getLifetimeValueDisplay(row.original.lifetime_value),\n      },\n      {\n        id: 'acquisition_date',\n        accessorKey: 'acquisition_date',\n        header: ({ column }) => (\n          <button\n            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}\n            className=\"flex items-center gap-2 hover:text-gray-900 font-semibold\"\n          >\n            Acquired\n            {column.getIsSorted() === 'asc' ? (\n              <ArrowUp className=\"h-4 w-4\" />\n            ) : column.getIsSorted() === 'desc' ? (\n              <ArrowDown className=\"h-4 w-4\" />\n            ) : (\n              <ArrowUpDown className=\"h-4 w-4 opacity-30\" />\n            )}\n          </button>\n        ),\n        cell: ({ row }) => getRelativeDate(row.original.acquisition_date),\n      },\n      {\n        id: 'last_interaction_date',\n        accessorKey: 'last_interaction_date',\n        header: ({ column }) => (\n          <button\n            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}\n            className=\"flex items-center gap-2 hover:text-gray-900 font-semibold\"\n          >\n            Last Interaction\n            {column.getIsSorted() === 'asc' ? (\n              <ArrowUp className=\"h-4 w-4\" />\n            ) : column.getIsSorted() === 'desc' ? (\n              <ArrowDown className=\"h-4 w-4\" />\n            ) : (\n              <ArrowUpDown className=\"h-4 w-4 opacity-30\" />\n            )}\n          </button>\n        ),\n        cell: ({ row }) => getRelativeDate(row.original.last_interaction_date),\n      },\n      {\n        id: 'tags',\n        accessorKey: 'tags',\n        header: 'Tags',\n        cell: ({ row }) => {\n          const tags = row.original.tags;\n          if (!tags || tags.length === 0) {\n            return <span className=\"text-sm text-gray-400\">-</span>;\n          }\n          return (\n            <div className=\"flex flex-wrap gap-1\">\n              {tags.slice(0, 2).map((tag, i) => (\n                <Badge key={i} variant=\"outline\" className=\"text-xs\">\n                  {tag}\n                </Badge>\n              ))}\n              {tags.length > 2 && (\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  +{tags.length - 2}\n                </Badge>\n              )}\n            </div>\n          );\n        },\n      },\n      {\n        id: 'actions',\n        header: 'Actions',\n        cell: ({ row }) => (\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={(e) => {\n                e.stopPropagation();\n                router.push(`/customers/${row.original.id}`);\n              }}\n              className=\"h-8 w-8 p-0\"\n            >\n              <Eye className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={(e) => {\n                e.stopPropagation();\n                router.push(`/customers/${row.original.id}/edit`);\n              }}\n              className=\"h-8 w-8 p-0\"\n            >\n              <Pencil className=\"h-4 w-4\" />\n            </Button>\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={(e) => e.stopPropagation()}\n                  className=\"h-8 w-8 p-0\"\n                >\n                  <MoreHorizontal className=\"h-4 w-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    if (row.original.email) {\n                      window.location.href = `mailto:${row.original.email}`;\n                    }\n                  }}\n                >\n                  <Mail className=\"h-4 w-4 mr-2\" />\n                  Send Email\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    if (confirm(`Are you sure you want to delete ${row.original.name}?`)) {\n                      onDeleteCustomer(row.original.id);\n                    }\n                  }}\n                  className=\"text-red-600\"\n                >\n                  <Trash2 className=\"h-4 w-4 mr-2\" />\n                  Delete\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        ),\n      },\n    ],\n    [router, onDeleteCustomer]\n  );\n\n  // Filter columns based on visibility\n  const visibleColumnsFiltered = useMemo(\n    () => columns.filter(col => visibleColumns.includes(col.id as string) || col.id === 'actions'),\n    [columns, visibleColumns]\n  );\n\n  const table = useReactTable({\n    data: customers,\n    columns: visibleColumnsFiltered,\n    state: {\n      sorting,\n    },\n    onSortingChange: setSorting,\n    getCoreRowModel: getCoreRowModel(),\n    getSortedRowModel: getSortedRowModel(),\n    getPaginationRowModel: getPaginationRowModel(),\n    getFilteredRowModel: getFilteredRowModel(),\n    initialState: {\n      pagination: {\n        pageSize,\n      },\n    },\n  });\n\n  // Update page size when changed\n  useMemo(() => {\n    table.setPageSize(pageSize);\n  }, [pageSize, table]);\n\n  return (\n    <div className=\"bg-white rounded-lg border border-gray-200 shadow-sm\">\n      <div className=\"overflow-x-auto\">\n        <table className=\"w-full\">\n          <thead className=\"bg-gray-50 border-b border-gray-200\">\n            {table.getHeaderGroups().map(headerGroup => (\n              <tr key={headerGroup.id}>\n                {headerGroup.headers.map(header => (\n                  <th\n                    key={header.id}\n                    className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\"\n                  >\n                    {header.isPlaceholder\n                      ? null\n                      : flexRender(header.column.columnDef.header, header.getContext())}\n                  </th>\n                ))}\n              </tr>\n            ))}\n          </thead>\n          <tbody className=\"bg-white divide-y divide-gray-200\">\n            {table.getRowModel().rows.length === 0 ? (\n              <tr>\n                <td\n                  colSpan={visibleColumnsFiltered.length}\n                  className=\"px-6 py-12 text-center text-gray-500\"\n                >\n                  No customers found\n                </td>\n              </tr>\n            ) : (\n              table.getRowModel().rows.map(row => (\n                <tr\n                  key={row.id}\n                  onClick={() => router.push(`/customers/${row.original.id}`)}\n                  className=\"hover:bg-gray-50 cursor-pointer transition-colors\"\n                >\n                  {row.getVisibleCells().map(cell => (\n                    <td key={cell.id} className=\"px-6 py-4 whitespace-nowrap\">\n                      {flexRender(cell.column.columnDef.cell, cell.getContext())}\n                    </td>\n                  ))}\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      {/* Pagination */}\n      <div className=\"flex items-center justify-between px-6 py-4 border-t border-gray-200\">\n        <div className=\"flex items-center gap-4\">\n          <span className=\"text-sm text-gray-700\">\n            Showing {table.getState().pagination.pageIndex * pageSize + 1} to{' '}\n            {Math.min((table.getState().pagination.pageIndex + 1) * pageSize, customers.length)} of{' '}\n            {customers.length} customers\n          </span>\n          <select\n            value={pageSize}\n            onChange={(e) => setPageSize(Number(e.target.value))}\n            className=\"px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n          >\n            <option value={10}>10 per page</option>\n            <option value={25}>25 per page</option>\n            <option value={50}>50 per page</option>\n            <option value={100}>100 per page</option>\n          </select>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => table.setPageIndex(0)}\n            disabled={!table.getCanPreviousPage()}\n            className=\"h-8 w-8 p-0\"\n          >\n            <ChevronsLeft className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => table.previousPage()}\n            disabled={!table.getCanPreviousPage()}\n            className=\"h-8 w-8 p-0\"\n          >\n            <ChevronLeft className=\"h-4 w-4\" />\n          </Button>\n          <span className=\"text-sm text-gray-700\">\n            Page {table.getState().pagination.pageIndex + 1} of {table.getPageCount()}\n          </span>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => table.nextPage()}\n            disabled={!table.getCanNextPage()}\n            className=\"h-8 w-8 p-0\"\n          >\n            <ChevronRight className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => table.setPageIndex(table.getPageCount() - 1)}\n            disabled={!table.getCanNextPage()}\n            className=\"h-8 w-8 p-0\"\n          >\n            <ChevronsRight className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\customers\\FilterPanel.tsx","messages":[{"ruleId":"jsx-a11y/no-static-element-interactions","severity":2,"message":"Avoid non-native interactive elements. If using native HTML is not possible, add an appropriate role and support for tabbing, mouse, keyboard, and touch inputs to an interactive content element.","line":79,"column":7,"nodeType":"JSXOpeningElement","endLine":82,"endColumn":8}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { Filter, X, ChevronDown, ChevronUp } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\n\nexport interface FilterValue {\n  segment?: string[];\n  status?: string[];\n  lifetimeValueMin?: number;\n  lifetimeValueMax?: number;\n  acquisitionDateFrom?: string;\n  acquisitionDateTo?: string;\n  lastInteractionFrom?: string;\n  lastInteractionTo?: string;\n}\n\ninterface FilterPanelProps {\n  filters: FilterValue;\n  onFiltersChange: (filters: FilterValue) => void;\n  onClearFilters: () => void;\n}\n\nconst SEGMENT_OPTIONS = [\n  { value: 'individual', label: 'Individual', color: 'bg-gray-100 text-gray-800' },\n  { value: 'startup', label: 'Startup', color: 'bg-yellow-100 text-yellow-800' },\n  { value: 'smb', label: 'SMB', color: 'bg-green-100 text-green-800' },\n  { value: 'mid_market', label: 'Mid Market', color: 'bg-blue-100 text-blue-800' },\n  { value: 'enterprise', label: 'Enterprise', color: 'bg-purple-100 text-purple-800' },\n];\n\nconst STATUS_OPTIONS = [\n  { value: 'prospect', label: 'Prospect', color: 'bg-blue-100 text-blue-800' },\n  { value: 'active', label: 'Active', color: 'bg-green-100 text-green-800' },\n  { value: 'inactive', label: 'Inactive', color: 'bg-gray-100 text-gray-800' },\n  { value: 'churned', label: 'Churned', color: 'bg-red-100 text-red-800' },\n];\n\n/**\n * FilterPanel Component\n *\n * Advanced filtering panel for customer data\n * Features:\n * - Multiple filter types (segment, status, value ranges, dates)\n * - Collapsible panel\n * - Active filter badges\n * - Clear all filters\n */\nexport function FilterPanel({ filters, onFiltersChange, onClearFilters }: FilterPanelProps) {\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  const updateFilter = (key: keyof FilterValue, value: any) => {\n    onFiltersChange({ ...filters, [key]: value });\n  };\n\n  const toggleSegment = (segment: string) => {\n    const currentSegments = filters.segment || [];\n    const newSegments = currentSegments.includes(segment)\n      ? currentSegments.filter(s => s !== segment)\n      : [...currentSegments, segment];\n    updateFilter('segment', newSegments.length > 0 ? newSegments : undefined);\n  };\n\n  const toggleStatus = (status: string) => {\n    const currentStatuses = filters.status || [];\n    const newStatuses = currentStatuses.includes(status)\n      ? currentStatuses.filter(s => s !== status)\n      : [...currentStatuses, status];\n    updateFilter('status', newStatuses.length > 0 ? newStatuses : undefined);\n  };\n\n  const activeFilterCount = Object.values(filters).filter(v =>\n    v !== undefined && v !== null && (Array.isArray(v) ? v.length > 0 : true)\n  ).length;\n\n  return (\n    <div className=\"bg-white rounded-lg border border-gray-200 shadow-sm\">\n      <div\n        className=\"flex items-center justify-between p-4 cursor-pointer\"\n        onClick={() => setIsExpanded(!isExpanded)}\n      >\n        <div className=\"flex items-center gap-3\">\n          <Filter className=\"h-5 w-5 text-gray-600\" />\n          <h3 className=\"font-semibold text-gray-900\">Advanced Filters</h3>\n          {activeFilterCount > 0 && (\n            <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800\">\n              {activeFilterCount} active\n            </Badge>\n          )}\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {activeFilterCount > 0 && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={(e) => {\n                e.stopPropagation();\n                onClearFilters();\n              }}\n              className=\"text-gray-600 hover:text-gray-900\"\n            >\n              Clear all\n            </Button>\n          )}\n          {isExpanded ? (\n            <ChevronUp className=\"h-5 w-5 text-gray-600\" />\n          ) : (\n            <ChevronDown className=\"h-5 w-5 text-gray-600\" />\n          )}\n        </div>\n      </div>\n\n      {isExpanded && (\n        <div className=\"p-4 pt-0 space-y-6 border-t border-gray-200\">\n          {/* Segment Filter */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Segment\n            </label>\n            <div className=\"flex flex-wrap gap-2\">\n              {SEGMENT_OPTIONS.map(option => (\n                <button\n                  key={option.value}\n                  onClick={() => toggleSegment(option.value)}\n                  className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${\n                    filters.segment?.includes(option.value)\n                      ? option.color + ' ring-2 ring-offset-2 ring-blue-500'\n                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\n                  }`}\n                >\n                  {option.label}\n                </button>\n              ))}\n            </div>\n          </div>\n\n          {/* Status Filter */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Status\n            </label>\n            <div className=\"flex flex-wrap gap-2\">\n              {STATUS_OPTIONS.map(option => (\n                <button\n                  key={option.value}\n                  onClick={() => toggleStatus(option.value)}\n                  className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${\n                    filters.status?.includes(option.value)\n                      ? option.color + ' ring-2 ring-offset-2 ring-blue-500'\n                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\n                  }`}\n                >\n                  {option.label}\n                </button>\n              ))}\n            </div>\n          </div>\n\n          {/* Lifetime Value Range */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Lifetime Value\n            </label>\n            <div className=\"grid grid-cols-2 gap-3\">\n              <div>\n                <input\n                  type=\"number\"\n                  placeholder=\"Min ($)\"\n                  value={filters.lifetimeValueMin || ''}\n                  onChange={(e) => updateFilter('lifetimeValueMin', e.target.value ? Number(e.target.value) : undefined)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n              <div>\n                <input\n                  type=\"number\"\n                  placeholder=\"Max ($)\"\n                  value={filters.lifetimeValueMax || ''}\n                  onChange={(e) => updateFilter('lifetimeValueMax', e.target.value ? Number(e.target.value) : undefined)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Acquisition Date Range */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Acquisition Date\n            </label>\n            <div className=\"grid grid-cols-2 gap-3\">\n              <div>\n                <input\n                  type=\"date\"\n                  value={filters.acquisitionDateFrom || ''}\n                  onChange={(e) => updateFilter('acquisitionDateFrom', e.target.value || undefined)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n              <div>\n                <input\n                  type=\"date\"\n                  value={filters.acquisitionDateTo || ''}\n                  onChange={(e) => updateFilter('acquisitionDateTo', e.target.value || undefined)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Last Interaction Date Range */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Last Interaction\n            </label>\n            <div className=\"grid grid-cols-2 gap-3\">\n              <div>\n                <input\n                  type=\"date\"\n                  value={filters.lastInteractionFrom || ''}\n                  onChange={(e) => updateFilter('lastInteractionFrom', e.target.value || undefined)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n              <div>\n                <input\n                  type=\"date\"\n                  value={filters.lastInteractionTo || ''}\n                  onChange={(e) => updateFilter('lastInteractionTo', e.target.value || undefined)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\examples\\ComprehensiveSupplierUI.tsx","messages":[{"ruleId":"react/no-unknown-property","severity":2,"message":"Unknown property 'jsx' found","line":378,"column":16,"nodeType":"JSXAttribute","messageId":"unknownProp","endLine":378,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport React, { useState, useCallback, useMemo } from 'react';\r\nimport { motion } from 'framer-motion';\r\nimport { Package, Upload, Search, Filter, Eye, Settings } from 'lucide-react';\r\n\r\n// Import all our perfected components\r\nimport ProductCatalogGrid from '../products/ProductCatalogGrid';\r\nimport SupplierPricelistUpload from '../suppliers/SupplierPricelistUpload';\r\nimport EnhancedDataTable, { ColumnDef } from '../ui/data-table/EnhancedDataTable';\r\nimport { DataTableLoader } from '../ui/loading/LoadingStates';\r\nimport { AccessibilityProvider } from '../ui/accessibility/AccessibilityProvider';\r\nimport { UnifiedSearch, createProductSearchConfig, createSupplierSearchConfig } from '../ui/search/UnifiedSearchSystem';\r\nimport { DataFreshnessDashboard, DataFreshnessInfo } from '../ui/indicators/DataFreshnessIndicators';\r\nimport { designTokens } from '../ui/design-system';\r\n\r\n// Mock data interfaces matching your existing types\r\ninterface Product {\r\n  id: string;\r\n  sku: string;\r\n  name: string;\r\n  description: string;\r\n  category: string;\r\n  price: number;\r\n  stock: number;\r\n  supplier: {\r\n    id: string;\r\n    name: string;\r\n    code: string;\r\n  };\r\n  lastUpdated: Date;\r\n  status: 'active' | 'inactive' | 'pending';\r\n  trends: {\r\n    priceChange: number;\r\n    demandChange: number;\r\n    stockMovement: number;\r\n  };\r\n  imageUrl?: string;\r\n}\r\n\r\ninterface Supplier {\r\n  id: string;\r\n  name: string;\r\n  code: string;\r\n  contactPerson: string;\r\n  email: string;\r\n  phone: string;\r\n  category: string;\r\n  status: 'active' | 'inactive' | 'pending';\r\n  createdAt: Date;\r\n  productsCount: number;\r\n  lastOrderDate?: Date;\r\n}\r\n\r\n// Mock data generators\r\nconst generateMockProducts = (count: number): Product[] => {\r\n  const categories = ['Electronics', 'Furniture', 'Office Supplies', 'Hardware', 'Software'];\r\n  const suppliers = [\r\n    { id: '1', name: 'TechCorp Solutions', code: 'TECH001' },\r\n    { id: '2', name: 'Global Supplies Ltd', code: 'GLOB002' },\r\n    { id: '3', name: 'Premium Parts Co', code: 'PREM003' },\r\n    { id: '4', name: 'Industrial Materials', code: 'INDL004' },\r\n    { id: '5', name: 'Digital Systems Inc', code: 'DIGI005' }\r\n  ];\r\n\r\n  return Array.from({ length: count }, (_, i) => ({\r\n    id: `product-${i + 1}`,\r\n    sku: `SKU-${String(i + 1).padStart(4, '0')}`,\r\n    name: `Product ${i + 1}`,\r\n    description: `High-quality product from category ${categories[i % categories.length]}`,\r\n    category: categories[i % categories.length],\r\n    price: Math.round((Math.random() * 1000 + 50) * 100) / 100,\r\n    stock: Math.floor(Math.random() * 500),\r\n    supplier: suppliers[i % suppliers.length],\r\n    lastUpdated: new Date(Date.now() - Math.random() * 86400000 * 30), // Random within 30 days\r\n    status: Math.random() > 0.1 ? 'active' : (Math.random() > 0.5 ? 'inactive' : 'pending') as 'active' | 'inactive' | 'pending',\r\n    trends: {\r\n      priceChange: (Math.random() - 0.5) * 20,\r\n      demandChange: (Math.random() - 0.5) * 50,\r\n      stockMovement: Math.floor((Math.random() - 0.5) * 100)\r\n    },\r\n    imageUrl: `https://picsum.photos/400/300?random=${i + 1}`\r\n  }));\r\n};\r\n\r\nconst generateMockSuppliers = (count: number): Supplier[] => {\r\n  const categories = ['Technology', 'Manufacturing', 'Services', 'Retail', 'Industrial'];\r\n  const names = [\r\n    'TechCorp Solutions', 'Global Supplies Ltd', 'Premium Parts Co', 'Industrial Materials',\r\n    'Digital Systems Inc', 'Advanced Manufacturing', 'Quality Components', 'Smart Solutions'\r\n  ];\r\n\r\n  return Array.from({ length: count }, (_, i) => ({\r\n    id: `supplier-${i + 1}`,\r\n    name: names[i % names.length],\r\n    code: `SUP-${String(i + 1).padStart(3, '0')}`,\r\n    contactPerson: `Contact Person ${i + 1}`,\r\n    email: `contact${i + 1}@${names[i % names.length].toLowerCase().replace(/\\s+/g, '')}.com`,\r\n    phone: `+1-555-${String(Math.floor(Math.random() * 9000) + 1000)}`,\r\n    category: categories[i % categories.length],\r\n    status: Math.random() > 0.1 ? 'active' : (Math.random() > 0.5 ? 'inactive' : 'pending') as 'active' | 'inactive' | 'pending',\r\n    createdAt: new Date(Date.now() - Math.random() * 86400000 * 365), // Random within year\r\n    productsCount: Math.floor(Math.random() * 100) + 1,\r\n    lastOrderDate: Math.random() > 0.3 ? new Date(Date.now() - Math.random() * 86400000 * 90) : undefined\r\n  }));\r\n};\r\n\r\n// Main comprehensive component\r\nexport const ComprehensiveSupplierUI: React.FC = () => {\r\n  const [activeTab, setActiveTab] = useState<'products' | 'suppliers' | 'upload' | 'analytics'>('products');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [searchResults, setSearchResults] = useState<any[]>([]);\r\n\r\n  // Mock data\r\n  const mockProducts = useMemo(() => generateMockProducts(150), []);\r\n  const mockSuppliers = useMemo(() => generateMockSuppliers(25), []);\r\n\r\n  // Data freshness info\r\n  const dataFreshnessItems = useMemo(() => [\r\n    {\r\n      id: 'products',\r\n      name: 'Product Catalog',\r\n      freshnessInfo: {\r\n        lastUpdated: new Date(Date.now() - 120000), // 2 minutes ago\r\n        syncStatus: 'synced' as const,\r\n        freshnessLevel: 'fresh' as const,\r\n        changesSinceLastView: 3,\r\n        confidence: 0.95,\r\n        dataSource: 'Primary Database',\r\n        recentChanges: [\r\n          {\r\n            id: '1',\r\n            type: 'price_changed' as const,\r\n            field: 'price',\r\n            timestamp: new Date(Date.now() - 60000),\r\n            severity: 'medium' as const\r\n          },\r\n          {\r\n            id: '2',\r\n            type: 'stock_changed' as const,\r\n            field: 'stock',\r\n            timestamp: new Date(Date.now() - 180000),\r\n            severity: 'high' as const\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      id: 'suppliers',\r\n      name: 'Supplier Data',\r\n      freshnessInfo: {\r\n        lastUpdated: new Date(Date.now() - 300000), // 5 minutes ago\r\n        syncStatus: 'synced' as const,\r\n        freshnessLevel: 'fresh' as const,\r\n        changesSinceLastView: 1,\r\n        confidence: 0.98,\r\n        dataSource: 'Supplier API',\r\n        recentChanges: [\r\n          {\r\n            id: '3',\r\n            type: 'updated' as const,\r\n            field: 'contact_info',\r\n            timestamp: new Date(Date.now() - 300000),\r\n            severity: 'low' as const\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    {\r\n      id: 'pricelists',\r\n      name: 'Price Lists',\r\n      freshnessInfo: {\r\n        lastUpdated: new Date(Date.now() - 1800000), // 30 minutes ago\r\n        syncStatus: 'synced' as const,\r\n        freshnessLevel: 'stale' as const,\r\n        changesSinceLastView: 0,\r\n        confidence: 0.85,\r\n        dataSource: 'File Uploads'\r\n      }\r\n    }\r\n  ], []);\r\n\r\n  // Column definitions for data table\r\n  const productColumns: ColumnDef<Product>[] = [\r\n    {\r\n      id: 'sku',\r\n      key: 'sku',\r\n      header: 'SKU',\r\n      type: 'text',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 120\r\n    },\r\n    {\r\n      id: 'name',\r\n      key: 'name',\r\n      header: 'Product Name',\r\n      type: 'text',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 200\r\n    },\r\n    {\r\n      id: 'category',\r\n      key: 'category',\r\n      header: 'Category',\r\n      type: 'badge',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 120\r\n    },\r\n    {\r\n      id: 'price',\r\n      key: 'price',\r\n      header: 'Price',\r\n      type: 'currency',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 100,\r\n      metadata: {\r\n        currency: 'USD'\r\n      }\r\n    },\r\n    {\r\n      id: 'stock',\r\n      key: 'stock',\r\n      header: 'Stock',\r\n      type: 'number',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 80\r\n    },\r\n    {\r\n      id: 'supplier',\r\n      key: 'supplier',\r\n      header: 'Supplier',\r\n      type: 'text',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 150,\r\n      accessor: (row) => row.supplier.name\r\n    },\r\n    {\r\n      id: 'status',\r\n      key: 'status',\r\n      header: 'Status',\r\n      type: 'badge',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 100\r\n    },\r\n    {\r\n      id: 'lastUpdated',\r\n      key: 'lastUpdated',\r\n      header: 'Last Updated',\r\n      type: 'date',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 160,\r\n      accessor: (row) => row.lastUpdated,\r\n      metadata: {\r\n        dateFormat: 'MMM dd, yyyy'\r\n      }\r\n    }\r\n  ];\r\n\r\n  const supplierColumns: ColumnDef<Supplier>[] = [\r\n    {\r\n      id: 'code',\r\n      key: 'code',\r\n      header: 'Code',\r\n      type: 'text',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 100\r\n    },\r\n    {\r\n      id: 'name',\r\n      key: 'name',\r\n      header: 'Supplier Name',\r\n      type: 'text',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 200\r\n    },\r\n    {\r\n      id: 'contactPerson',\r\n      key: 'contactPerson',\r\n      header: 'Contact',\r\n      type: 'text',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 150\r\n    },\r\n    {\r\n      id: 'email',\r\n      key: 'email',\r\n      header: 'Email',\r\n      type: 'text',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 200\r\n    },\r\n    {\r\n      id: 'category',\r\n      key: 'category',\r\n      header: 'Category',\r\n      type: 'badge',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 120\r\n    },\r\n    {\r\n      id: 'productsCount',\r\n      key: 'productsCount',\r\n      header: 'Products',\r\n      type: 'number',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 100\r\n    },\r\n    {\r\n      id: 'status',\r\n      key: 'status',\r\n      header: 'Status',\r\n      type: 'badge',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 100\r\n    },\r\n    {\r\n      id: 'createdAt',\r\n      key: 'createdAt',\r\n      header: 'Created',\r\n      type: 'date',\r\n      sortable: true,\r\n      filterable: true,\r\n      width: 140,\r\n      accessor: (row) => row.createdAt,\r\n      metadata: {\r\n        dateFormat: 'MMM dd, yyyy'\r\n      }\r\n    }\r\n  ];\r\n\r\n  // Search configurations\r\n  const productSearchConfig = createProductSearchConfig();\r\n  const supplierSearchConfig = createSupplierSearchConfig();\r\n\r\n  // Handlers\r\n  const handleProductSearch = useCallback((results: Product[]) => {\r\n    setSearchResults(results);\r\n  }, []);\r\n\r\n  const handleSupplierSearch = useCallback((results: Supplier[]) => {\r\n    setSearchResults(results);\r\n  }, []);\r\n\r\n  const handleUploadComplete = useCallback((result: any) => {\r\n    console.log('Upload completed:', result);\r\n    // Refresh data or show success message\r\n  }, []);\r\n\r\n  const handleRefreshAll = useCallback(() => {\r\n    setIsLoading(true);\r\n    // Simulate refresh\r\n    setTimeout(() => setIsLoading(false), 2000);\r\n  }, []);\r\n\r\n  const handleRefreshItem = useCallback((itemId: string) => {\r\n    console.log('Refreshing item:', itemId);\r\n    // Implement individual item refresh\r\n  }, []);\r\n\r\n  return (\r\n    <AccessibilityProvider>\r\n      <div className=\"comprehensive-supplier-ui\">\r\n        <style jsx>{`\r\n          .comprehensive-supplier-ui {\r\n            min-height: 100vh;\r\n            background: ${designTokens.colors.background};\r\n            color: ${designTokens.colors.foreground};\r\n          }\r\n\r\n          .header {\r\n            background: ${designTokens.colors.card};\r\n            border-bottom: 1px solid ${designTokens.colors.border};\r\n            padding: ${designTokens.spacing.lg};\r\n          }\r\n\r\n          .nav-tabs {\r\n            display: flex;\r\n            gap: ${designTokens.spacing.sm};\r\n            margin-top: ${designTokens.spacing.md};\r\n          }\r\n\r\n          .nav-tab {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: ${designTokens.spacing.sm};\r\n            padding: ${designTokens.spacing.sm} ${designTokens.spacing.md};\r\n            background: transparent;\r\n            border: 1px solid ${designTokens.colors.border};\r\n            border-radius: ${designTokens.borderRadius.md};\r\n            color: ${designTokens.colors.muted.foreground};\r\n            cursor: pointer;\r\n            transition: all 0.2s ease;\r\n            font-size: ${designTokens.typography.sizes.sm};\r\n            font-weight: 500;\r\n          }\r\n\r\n          .nav-tab:hover {\r\n            background: ${designTokens.colors.muted.DEFAULT};\r\n            color: ${designTokens.colors.foreground};\r\n          }\r\n\r\n          .nav-tab.active {\r\n            background: ${designTokens.colors.primary.DEFAULT};\r\n            color: ${designTokens.colors.primary.foreground};\r\n            border-color: ${designTokens.colors.primary.DEFAULT};\r\n          }\r\n\r\n          .content {\r\n            padding: ${designTokens.spacing.lg};\r\n          }\r\n\r\n          .search-section {\r\n            margin-bottom: ${designTokens.spacing.lg};\r\n          }\r\n\r\n          .data-section {\r\n            background: ${designTokens.colors.card};\r\n            border: 1px solid ${designTokens.colors.border};\r\n            border-radius: ${designTokens.borderRadius.lg};\r\n            overflow: hidden;\r\n          }\r\n        `}</style>\r\n\r\n        {/* Header with Data Freshness Dashboard */}\r\n        <div className=\"header\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h1 className=\"text-2xl font-bold mb-2\">Supplier & Product Management</h1>\r\n              <p className=\"text-muted-foreground\">\r\n                Comprehensive interface with advanced search, real-time updates, and accessibility features\r\n              </p>\r\n            </div>\r\n\r\n            <DataFreshnessDashboard\r\n              items={dataFreshnessItems}\r\n              onRefreshAll={handleRefreshAll}\r\n              onRefreshItem={handleRefreshItem}\r\n              className=\"w-96\"\r\n            />\r\n          </div>\r\n\r\n          {/* Navigation Tabs */}\r\n          <div className=\"nav-tabs\">\r\n            <button\r\n              className={`nav-tab ${activeTab === 'products' ? 'active' : ''}`}\r\n              onClick={() => setActiveTab('products')}\r\n            >\r\n              <Package className=\"w-4 h-4\" />\r\n              Product Catalog\r\n            </button>\r\n            <button\r\n              className={`nav-tab ${activeTab === 'suppliers' ? 'active' : ''}`}\r\n              onClick={() => setActiveTab('suppliers')}\r\n            >\r\n              <Search className=\"w-4 h-4\" />\r\n              Suppliers\r\n            </button>\r\n            <button\r\n              className={`nav-tab ${activeTab === 'upload' ? 'active' : ''}`}\r\n              onClick={() => setActiveTab('upload')}\r\n            >\r\n              <Upload className=\"w-4 h-4\" />\r\n              Price List Upload\r\n            </button>\r\n            <button\r\n              className={`nav-tab ${activeTab === 'analytics' ? 'active' : ''}`}\r\n              onClick={() => setActiveTab('analytics')}\r\n            >\r\n              <Filter className=\"w-4 h-4\" />\r\n              Data Analytics\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Content Area */}\r\n        <div className=\"content\">\r\n          {isLoading && (\r\n            <div className=\"mb-6\">\r\n              <DataTableLoader rows={10} columns={6} />\r\n            </div>\r\n          )}\r\n\r\n          {/* Products Tab */}\r\n          {activeTab === 'products' && !isLoading && (\r\n            <div className=\"space-y-6\">\r\n              {/* Search Section */}\r\n              <div className=\"search-section\">\r\n                <UnifiedSearch\r\n                  config={productSearchConfig}\r\n                  data={mockProducts}\r\n                  onSearch={handleProductSearch}\r\n                  placeholder=\"Search products by SKU, name, category, supplier...\"\r\n                  showFieldSelector={true}\r\n                  showFilters={true}\r\n                  showSavedSearches={true}\r\n                  className=\"w-full\"\r\n                />\r\n              </div>\r\n\r\n              {/* Product Catalog Grid */}\r\n              <div className=\"data-section\">\r\n                <ProductCatalogGrid\r\n                  products={searchResults.length > 0 ? searchResults : mockProducts}\r\n                  onProductSelect={(product) => console.log('Selected product:', product)}\r\n                  onProductUpdate={(product) => console.log('Update product:', product)}\r\n                  viewMode=\"grid\"\r\n                  enableVirtualization={true}\r\n                  pageSize={20}\r\n                  className=\"p-6\"\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Suppliers Tab */}\r\n          {activeTab === 'suppliers' && !isLoading && (\r\n            <div className=\"space-y-6\">\r\n              {/* Search Section */}\r\n              <div className=\"search-section\">\r\n                <UnifiedSearch\r\n                  config={supplierSearchConfig}\r\n                  data={mockSuppliers}\r\n                  onSearch={handleSupplierSearch}\r\n                  placeholder=\"Search suppliers by name, code, contact, category...\"\r\n                  showFieldSelector={true}\r\n                  showFilters={true}\r\n                  className=\"w-full\"\r\n                />\r\n              </div>\r\n\r\n              {/* Suppliers Data Table */}\r\n              <div className=\"data-section\">\r\n                <div className=\"p-6\">\r\n                  <EnhancedDataTable<Supplier>\r\n                    data={(searchResults.length > 0 ? searchResults : mockSuppliers) as Supplier[]}\r\n                    columns={supplierColumns}\r\n                    sorting={{ enabled: true, multiSort: true }}\r\n                    grouping={{ enabled: true, defaultGroupBy: 'category', showAggregates: false }}\r\n                    pagination={{\r\n                      enabled: true,\r\n                      pageSize: 25,\r\n                      pageSizeOptions: [10, 25, 50, 100],\r\n                      showInfo: true,\r\n                      showSizeSelector: true\r\n                    }}\r\n                    selection={{ enabled: true, mode: 'multiple', showSelectAll: true }}\r\n                    actions={{\r\n                      export: { enabled: true, formats: ['csv', 'xlsx', 'json'] },\r\n                      row: [\r\n                        {\r\n                          id: 'view',\r\n                          label: 'View',\r\n                          icon: Eye,\r\n                          handler: (supplier: Supplier) => console.log('View', supplier)\r\n                        },\r\n                        {\r\n                          id: 'edit',\r\n                          label: 'Edit',\r\n                          icon: Settings,\r\n                          handler: (supplier: Supplier) => console.log('Edit', supplier)\r\n                        }\r\n                      ]\r\n                    }}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Upload Tab */}\r\n          {activeTab === 'upload' && !isLoading && (\r\n            <div className=\"space-y-6\">\r\n              <div className=\"data-section\">\r\n                <div className=\"p-6\">\r\n                  <SupplierPricelistUpload\r\n                    supplierId=\"supplier-1\"\r\n                    onUploadComplete={handleUploadComplete}\r\n                    onCancel={() => console.log('Upload cancelled')}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Analytics Tab */}\r\n          {activeTab === 'analytics' && !isLoading && (\r\n            <div className=\"space-y-6\">\r\n              <div className=\"data-section\">\r\n                <div className=\"p-6\">\r\n                  <h3 className=\"text-lg font-semibold mb-4\">Product Analytics</h3>\r\n                  <EnhancedDataTable<Product>\r\n                    data={mockProducts}\r\n                    columns={productColumns}\r\n                    sorting={{\r\n                      enabled: true,\r\n                      multiSort: true,\r\n                      defaultSort: [{ column: 'price', direction: 'desc', priority: 0 }]\r\n                    }}\r\n                    grouping={{ enabled: true, defaultGroupBy: 'category', showAggregates: true }}\r\n                    pagination={{\r\n                      enabled: true,\r\n                      pageSize: 50,\r\n                      pageSizeOptions: [25, 50, 100, 200],\r\n                      showInfo: true,\r\n                      showSizeSelector: true\r\n                    }}\r\n                    selection={{ enabled: true, mode: 'multiple', showSelectAll: true }}\r\n                    actions={{\r\n                      export: { enabled: true, formats: ['csv', 'xlsx', 'json'] },\r\n                      row: [\r\n                        {\r\n                          id: 'view',\r\n                          label: 'View',\r\n                          icon: Eye,\r\n                          handler: (product: Product) => console.log('View', product)\r\n                        },\r\n                        {\r\n                          id: 'edit',\r\n                          label: 'Edit',\r\n                          icon: Settings,\r\n                          handler: (product: Product) => console.log('Edit', product)\r\n                        }\r\n                      ]\r\n                    }}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </AccessibilityProvider>\r\n  );\r\n};\r\n\r\nexport default ComprehensiveSupplierUI;","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\integrations\\ActivityLog.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":50,"column":20,"nodeType":"Identifier","messageId":"undef","endLine":50,"endColumn":32},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":60,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":60,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'crypto' is not defined.","line":354,"column":34,"nodeType":"Identifier","messageId":"undef","endLine":354,"endColumn":40},{"ruleId":"no-undef","severity":2,"message":"'setError' is not defined.","line":367,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":367,"endColumn":33}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useCallback, useMemo } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n} from '@/components/ui/dropdown-menu';\nimport { AlertCircle, CheckCircle2, Clock, Download, Loader2, Search, ChevronDown, AlertTriangle } from 'lucide-react';\nimport { cn } from '@/lib/utils';\n\ninterface ActivityLogEntry {\n  id: string;\n  timestamp: string;\n  action: 'sync' | 'preview' | 'orchestrate' | 'cancel';\n  entityType: string;\n  syncType: 'woocommerce' | 'odoo';\n  status: 'completed' | 'failed' | 'partial' | 'cancelled';\n  recordCount: number;\n  createdCount?: number;\n  updatedCount?: number;\n  deletedCount?: number;\n  failedCount?: number;\n  duration: number; // milliseconds\n  errorMessage?: string;\n}\n\ninterface ActivityLogProps {\n  orgId: string;\n  entityType?: string;\n}\n\nconst STORAGE_KEY = 'sync_activity_log';\nconst MAX_ENTRIES_PER_ORG = 1000;\nconst POLL_INTERVAL = 10000; // 10 seconds\n\n// Storage utility functions\nconst loadActivityLog = (orgId: string): ActivityLogEntry[] => {\n  try {\n    const stored = localStorage.getItem(`${STORAGE_KEY}_${orgId}`);\n    return stored ? JSON.parse(stored) : [];\n  } catch {\n    return [];\n  }\n};\n\nconst saveActivityLog = (orgId: string, entries: ActivityLogEntry[]) => {\n  try {\n    const limited = entries.slice(0, MAX_ENTRIES_PER_ORG);\n    localStorage.setItem(`${STORAGE_KEY}_${orgId}`, JSON.stringify(limited));\n  } catch (error) {\n    console.error('Failed to save activity log:', error);\n  }\n};\n\n// Format milliseconds to readable time\nconst formatDuration = (ms: number): string => {\n  const seconds = Math.floor(ms / 1000);\n  const minutes = Math.floor(seconds / 60);\n\n  if (minutes > 0) {\n    return `${minutes}m ${seconds % 60}s`;\n  }\n  return `${seconds}s`;\n};\n\n// Get status badge variant and icon\nconst getStatusInfo = (status: string) => {\n  const info: Record<string, { variant: string; icon: React.ReactNode; label: string }> = {\n    completed: {\n      variant: 'secondary',\n      icon: <CheckCircle2 className=\"h-4 w-4\" />,\n      label: 'Completed',\n    },\n    failed: {\n      variant: 'destructive',\n      icon: <AlertCircle className=\"h-4 w-4\" />,\n      label: 'Failed',\n    },\n    partial: {\n      variant: 'outline',\n      icon: <AlertTriangle className=\"h-4 w-4\" />,\n      label: 'Partial',\n    },\n    cancelled: {\n      variant: 'secondary',\n      icon: <Clock className=\"h-4 w-4\" />,\n      label: 'Cancelled',\n    },\n  };\n\n  return info[status] || info.completed;\n};\n\n// Memoized action badge component\nconst ActionBadge = React.memo(({ action }: { action: string }) => {\n  const actionMap: Record<string, string> = {\n    sync: 'Sync',\n    preview: 'Preview',\n    orchestrate: 'Orchestrate',\n    cancel: 'Cancel',\n  };\n\n  return (\n    <Badge variant=\"outline\" className=\"font-normal\">\n      {actionMap[action] || action}\n    </Badge>\n  );\n});\n\nActionBadge.displayName = 'ActionBadge';\n\n// Memoized entity type badge component\nconst EntityTypeBadge = React.memo(({ type }: { type: string }) => {\n  const colorMap: Record<string, string> = {\n    products: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100',\n    orders: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100',\n    customers: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-100',\n    invoices: 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-100',\n  };\n\n  return (\n    <span\n      className={cn('inline-block px-2 py-1 rounded text-xs font-medium', colorMap[type] || colorMap.products)}\n    >\n      {type.charAt(0).toUpperCase() + type.slice(1)}\n    </span>\n  );\n});\n\nEntityTypeBadge.displayName = 'EntityTypeBadge';\n\n// Memoized table row component\nconst ActivityRow = React.memo(\n  ({\n    entry,\n    onShowDetails,\n  }: {\n    entry: ActivityLogEntry;\n    onShowDetails: (entry: ActivityLogEntry) => void;\n  }) => {\n    const statusInfo = getStatusInfo(entry.status);\n    const timestamp = new Date(entry.timestamp);\n\n    return (\n      <TableRow className=\"hover:bg-muted/50 cursor-pointer\" onClick={() => onShowDetails(entry)}>\n        <TableCell className=\"text-sm\">\n          {timestamp.toLocaleDateString()} {timestamp.toLocaleTimeString()}\n        </TableCell>\n        <TableCell>\n          <ActionBadge action={entry.action} />\n        </TableCell>\n        <TableCell>\n          <EntityTypeBadge type={entry.entityType} />\n        </TableCell>\n        <TableCell>\n          <Badge variant={statusInfo.variant as any} className=\"gap-1\">\n            {statusInfo.icon}\n            {statusInfo.label}\n          </Badge>\n        </TableCell>\n        <TableCell className=\"text-right text-sm\">{entry.recordCount}</TableCell>\n        <TableCell className=\"text-right text-sm text-muted-foreground\">\n          {formatDuration(entry.duration)}\n        </TableCell>\n        <TableCell>\n          {entry.errorMessage && (\n            <span\n              className=\"text-xs text-muted-foreground truncate max-w-xs block\"\n              title={entry.errorMessage}\n            >\n              {entry.errorMessage.substring(0, 40)}...\n            </span>\n          )}\n        </TableCell>\n      </TableRow>\n    );\n  }\n);\n\nActivityRow.displayName = 'ActivityRow';\n\n// Details modal component\nconst DetailsModal = React.memo(\n  ({\n    entry,\n    isOpen,\n    onClose,\n  }: {\n    entry: ActivityLogEntry | null;\n    isOpen: boolean;\n    onClose: () => void;\n  }) => {\n    if (!isOpen || !entry) return null;\n\n    const statusInfo = getStatusInfo(entry.status);\n\n    return (\n      <div className=\"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4\">\n        <Card className=\"max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-start justify-between\">\n              <div>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <span>Activity Details</span>\n                  <Badge variant={statusInfo.variant as any} className=\"gap-1\">\n                    {statusInfo.icon}\n                    {statusInfo.label}\n                  </Badge>\n                </CardTitle>\n                <CardDescription className=\"mt-1\">\n                  {new Date(entry.timestamp).toLocaleString()}\n                </CardDescription>\n              </div>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={onClose}\n                aria-label=\"Close details\"\n              >\n                ✕\n              </Button>\n            </div>\n          </CardHeader>\n\n          <CardContent className=\"space-y-6\">\n            {/* Basic info */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Action</p>\n                <p className=\"font-medium capitalize\">{entry.action}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Entity Type</p>\n                <p className=\"font-medium\">{entry.entityType}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Sync Type</p>\n                <p className=\"font-medium\">{entry.syncType === 'woocommerce' ? 'WooCommerce' : 'Odoo'}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Duration</p>\n                <p className=\"font-medium\">{formatDuration(entry.duration)}</p>\n              </div>\n            </div>\n\n            {/* Summary stats */}\n            {(entry.createdCount !== undefined ||\n              entry.updatedCount !== undefined ||\n              entry.deletedCount !== undefined) && (\n              <div className=\"border-t pt-4\">\n                <p className=\"text-sm font-semibold mb-3\">Summary</p>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                  <div className=\"text-center\">\n                    <p className=\"text-sm text-muted-foreground\">Total</p>\n                    <p className=\"text-2xl font-bold\">{entry.recordCount}</p>\n                  </div>\n                  {entry.createdCount !== undefined && (\n                    <div className=\"text-center\">\n                      <p className=\"text-sm text-muted-foreground\">Created</p>\n                      <p className=\"text-2xl font-bold text-green-600\">{entry.createdCount}</p>\n                    </div>\n                  )}\n                  {entry.updatedCount !== undefined && (\n                    <div className=\"text-center\">\n                      <p className=\"text-sm text-muted-foreground\">Updated</p>\n                      <p className=\"text-2xl font-bold text-blue-600\">{entry.updatedCount}</p>\n                    </div>\n                  )}\n                  {entry.deletedCount !== undefined && (\n                    <div className=\"text-center\">\n                      <p className=\"text-sm text-muted-foreground\">Deleted</p>\n                      <p className=\"text-2xl font-bold text-amber-600\">{entry.deletedCount}</p>\n                    </div>\n                  )}\n                  {entry.failedCount !== undefined && (\n                    <div className=\"text-center\">\n                      <p className=\"text-sm text-muted-foreground\">Failed</p>\n                      <p className=\"text-2xl font-bold text-destructive\">{entry.failedCount}</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {/* Error message */}\n            {entry.errorMessage && (\n              <div className=\"border-t pt-4 bg-destructive/5 border border-destructive/20 p-3 rounded\">\n                <p className=\"text-sm font-semibold text-destructive mb-2\">Error</p>\n                <p className=\"text-sm text-muted-foreground break-words\">{entry.errorMessage}</p>\n              </div>\n            )}\n\n            {/* Close button */}\n            <div className=\"flex justify-end pt-4 border-t\">\n              <Button variant=\"outline\" onClick={onClose}>\n                Close\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n);\n\nDetailsModal.displayName = 'DetailsModal';\n\nexport const ActivityLog: React.FC<ActivityLogProps> = ({ orgId, entityType }) => {\n  const [entries, setEntries] = useState<ActivityLogEntry[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [statusFilter, setStatusFilter] = useState('all');\n  const [dateFilter, setDateFilter] = useState('all');\n  const [entityFilter, setEntityFilter] = useState(entityType || 'all');\n  const [selectedEntry, setSelectedEntry] = useState<ActivityLogEntry | null>(null);\n  const [itemsPerPage, setItemsPerPage] = useState(10);\n  const [currentPage, setCurrentPage] = useState(1);\n\n  // Load initial data and set up polling\n  useEffect(() => {\n    let cancelled = false\n    let lastErrorKey = ''\n    async function loadData() {\n      setLoading(true)\n      try {\n        const res = await fetch(`/api/v1/integrations/sync/activity?orgId=${orgId}`)\n        if (!res.ok) {\n          const body = await res.json().catch(() => ({} as any))\n          const key = `${res.status}:${body?.error || ''}`\n          // stop repeated hammering when circuit is open\n          if (key === lastErrorKey) {\n            setLoading(false)\n            return\n          }\n          lastErrorKey = key\n          throw new Error(body?.error || `HTTP ${res.status}`)\n        }\n        const json = await res.json()\n        const entries = (json.data || []).map((row: any) => {\n          const a = String(row.action || '').toLowerCase()\n          const action = a.includes('preview') ? 'preview' : a.includes('orchestrate') ? 'orchestrate' : a.includes('cancel') ? 'cancel' : 'sync'\n          return {\n            id: String(row.id ?? crypto.randomUUID()),\n            timestamp: row.started_at || row.created_at || new Date().toISOString(),\n            action,\n            entityType: row.entity_type || 'unknown',\n            syncType: row.sync_type || 'unknown',\n            status: (row.status || 'completed'),\n            recordCount: row.record_count || 0,\n            duration: row.duration_ms || 0,\n            errorMessage: row.error_message || undefined,\n          }\n        })\n        if (!cancelled) setEntries(entries)\n      } catch (e: any) {\n        if (!cancelled) setError(e?.message || 'Failed to load activity')\n      } finally {\n        if (!cancelled) setLoading(false)\n      }\n    }\n    loadData()\n    return () => { cancelled = true }\n  }, [orgId])\n\n  // Filter entries based on criteria\n  const filteredEntries = useMemo(() => {\n    let result = [...entries];\n\n    // Search filter\n    if (searchTerm) {\n      result = result.filter(\n        (entry) =>\n          entry.id.toLowerCase().includes(searchTerm.toLowerCase()) ||\n          entry.entityType.toLowerCase().includes(searchTerm.toLowerCase()) ||\n          entry.errorMessage?.toLowerCase().includes(searchTerm.toLowerCase())\n      );\n    }\n\n    // Status filter\n    if (statusFilter !== 'all') {\n      result = result.filter((entry) => entry.status === statusFilter);\n    }\n\n    // Entity type filter\n    if (entityFilter !== 'all') {\n      result = result.filter((entry) => entry.entityType === entityFilter);\n    }\n\n    // Date filter\n    const now = Date.now();\n    const filters: Record<string, number> = {\n      '24h': 24 * 60 * 60 * 1000,\n      '7d': 7 * 24 * 60 * 60 * 1000,\n      '30d': 30 * 24 * 60 * 60 * 1000,\n    };\n\n    if (dateFilter !== 'all' && filters[dateFilter]) {\n      result = result.filter((entry) => now - new Date(entry.timestamp).getTime() <= filters[dateFilter]);\n    }\n\n    // Sort by timestamp descending (newest first)\n    return result.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());\n  }, [entries, searchTerm, statusFilter, dateFilter, entityFilter]);\n\n  // Pagination\n  const totalPages = Math.ceil(filteredEntries.length / itemsPerPage);\n  const paginatedEntries = filteredEntries.slice(\n    (currentPage - 1) * itemsPerPage,\n    currentPage * itemsPerPage\n  );\n\n  // Export to CSV\n  const exportToCSV = useCallback(() => {\n    const headers = [\n      'Timestamp',\n      'Action',\n      'Entity Type',\n      'Status',\n      'Record Count',\n      'Duration',\n      'Created',\n      'Updated',\n      'Deleted',\n      'Failed',\n      'Error Message',\n    ];\n\n    const rows = filteredEntries.map((entry) => [\n      entry.timestamp,\n      entry.action,\n      entry.entityType,\n      entry.status,\n      entry.recordCount,\n      formatDuration(entry.duration),\n      entry.createdCount || '-',\n      entry.updatedCount || '-',\n      entry.deletedCount || '-',\n      entry.failedCount || '-',\n      `\"${(entry.errorMessage || '').replace(/\"/g, '\"\"')}\"`,\n    ]);\n\n    const csv = [headers, ...rows]\n      .map((row) => row.join(','))\n      .join('\\n');\n\n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = `sync-activity-${new Date().toISOString().split('T')[0]}.csv`;\n    link.click();\n    window.URL.revokeObjectURL(url);\n  }, [filteredEntries]);\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Filters */}\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-base\">Filters</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n            {/* Search */}\n            <div className=\"lg:col-span-2\">\n              <Label htmlFor=\"search\" className=\"text-sm mb-2 block\">\n                Search\n              </Label>\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-2.5 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  id=\"search\"\n                  placeholder=\"Search by ID, entity type...\"\n                  value={searchTerm}\n                  onChange={(e) => {\n                    setSearchTerm(e.target.value);\n                    setCurrentPage(1);\n                  }}\n                  className=\"pl-10\"\n                />\n              </div>\n            </div>\n\n            {/* Status filter */}\n            <div>\n              <Label htmlFor=\"status\" className=\"text-sm mb-2 block\">\n                Status\n              </Label>\n              <Select value={statusFilter} onValueChange={(value) => {\n                setStatusFilter(value);\n                setCurrentPage(1);\n              }}>\n                <SelectTrigger id=\"status\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All</SelectItem>\n                  <SelectItem value=\"completed\">Completed</SelectItem>\n                  <SelectItem value=\"failed\">Failed</SelectItem>\n                  <SelectItem value=\"partial\">Partial</SelectItem>\n                  <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Entity type filter */}\n            <div>\n              <Label htmlFor=\"entity\" className=\"text-sm mb-2 block\">\n                Entity Type\n              </Label>\n              <Select value={entityFilter} onValueChange={(value) => {\n                setEntityFilter(value);\n                setCurrentPage(1);\n              }}>\n                <SelectTrigger id=\"entity\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All</SelectItem>\n                  <SelectItem value=\"products\">Products</SelectItem>\n                  <SelectItem value=\"customers\">Customers</SelectItem>\n                  <SelectItem value=\"orders\">Orders</SelectItem>\n                  <SelectItem value=\"invoices\">Invoices</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Date filter */}\n            <div>\n              <Label htmlFor=\"date\" className=\"text-sm mb-2 block\">\n                Date Range\n              </Label>\n              <Select value={dateFilter} onValueChange={(value) => {\n                setDateFilter(value);\n                setCurrentPage(1);\n              }}>\n                <SelectTrigger id=\"date\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Time</SelectItem>\n                  <SelectItem value=\"24h\">Last 24h</SelectItem>\n                  <SelectItem value=\"7d\">Last 7 days</SelectItem>\n                  <SelectItem value=\"30d\">Last 30 days</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Table */}\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between pb-3\">\n          <div>\n            <CardTitle>Activity Log</CardTitle>\n            <CardDescription className=\"mt-1\">\n              {filteredEntries.length} of {entries.length} entries\n            </CardDescription>\n          </div>\n          <Button\n            size=\"sm\"\n            variant=\"outline\"\n            onClick={exportToCSV}\n            disabled={filteredEntries.length === 0}\n            className=\"gap-2\"\n          >\n            <Download className=\"h-4 w-4\" />\n            Export CSV\n          </Button>\n        </CardHeader>\n\n        <CardContent>\n          {loading && !entries.length ? (\n            <div className=\"flex items-center justify-center h-40\">\n              <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n            </div>\n          ) : filteredEntries.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              No activity logs found\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              <div className=\"rounded-lg border overflow-hidden\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Timestamp</TableHead>\n                      <TableHead>Action</TableHead>\n                      <TableHead>Entity</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead className=\"text-right\">Count</TableHead>\n                      <TableHead className=\"text-right\">Duration</TableHead>\n                      <TableHead>Error</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {paginatedEntries.map((entry) => (\n                      <ActivityRow\n                        key={entry.id}\n                        entry={entry}\n                        onShowDetails={() => setSelectedEntry(entry)}\n                      />\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n\n              {/* Pagination */}\n              <div className=\"flex items-center justify-between\">\n                <Select value={itemsPerPage.toString()} onValueChange={(v) => {\n                  setItemsPerPage(parseInt(v));\n                  setCurrentPage(1);\n                }}>\n                  <SelectTrigger className=\"w-24\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"10\">10</SelectItem>\n                    <SelectItem value=\"25\">25</SelectItem>\n                    <SelectItem value=\"50\">50</SelectItem>\n                  </SelectContent>\n                </Select>\n\n                <div className=\"flex items-center gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}\n                    disabled={currentPage === 1}\n                  >\n                    Previous\n                  </Button>\n                  <span className=\"text-sm text-muted-foreground\">\n                    Page {currentPage} of {totalPages}\n                  </span>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setCurrentPage((p) => Math.min(totalPages, p + 1))}\n                    disabled={currentPage === totalPages}\n                  >\n                    Next\n                  </Button>\n                </div>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Details modal */}\n      <DetailsModal\n        entry={selectedEntry}\n        isOpen={!!selectedEntry}\n        onClose={() => setSelectedEntry(null)}\n      />\n    </div>\n  );\n};\n\nexport default ActivityLog;\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\integrations\\SyncPreview.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":249,"column":9,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":249,"endColumn":55}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport React, { useState, useEffect, useCallback } from 'react';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { AlertCircle, CheckCircle2, Search, Loader2, RefreshCw } from 'lucide-react';\nimport { cn } from '@/lib/utils';\n\ninterface SyncItem {\n  id: string | number;\n  name: string;\n  lastModified?: string;\n  preview?: string;\n  [key: string]: any;\n}\n\ninterface SyncPreviewData {\n  newItems: SyncItem[];\n  updatedItems: SyncItem[];\n  deletedItems: SyncItem[];\n  totalNew: number;\n  totalUpdated: number;\n  totalDeleted: number;\n}\n\ninterface SyncPreviewProps {\n  isOpen: boolean;\n  syncType: 'woocommerce' | 'odoo';\n  entityType: string;\n  onConfirm: (config: SyncConfig) => void;\n  onCancel: () => void;\n}\n\ninterface SyncConfig {\n  includeNew: boolean;\n  includeUpdated: boolean;\n  includeDeleted: boolean;\n  selectedIds?: (string | number)[];\n}\n\nconst ITEMS_PER_PAGE = 20;\n\n// Skeleton loader component\nconst SkeletonRow: React.FC<{ columns: number }> = ({ columns }) => (\n  <TableRow>\n    {Array.from({ length: columns }).map((_, i) => (\n      <TableCell key={i}>\n        <div className=\"h-4 bg-muted rounded animate-pulse\" />\n      </TableCell>\n    ))}\n  </TableRow>\n);\n\n// Individual item row component (memoized for performance)\nconst SyncItemRow = React.memo(\n  ({\n    item,\n    isSelected,\n    onSelect,\n  }: {\n    item: SyncItem;\n    isSelected: boolean;\n    onSelect: () => void;\n  }) => (\n    <TableRow className=\"hover:bg-muted/50\">\n      <TableCell className=\"w-12\">\n        <Checkbox\n          checked={isSelected}\n          onCheckedChange={onSelect}\n          aria-label={`Select item ${item.id}`}\n        />\n      </TableCell>\n      <TableCell className=\"font-medium\">{item.id}</TableCell>\n      <TableCell>{item.name}</TableCell>\n      <TableCell className=\"text-sm text-muted-foreground\">\n        {item.lastModified ? new Date(item.lastModified).toLocaleDateString() : '-'}\n      </TableCell>\n      <TableCell className=\"max-w-xs truncate text-sm text-muted-foreground\">\n        {item.preview ? item.preview.substring(0, 50) : '-'}\n      </TableCell>\n    </TableRow>\n  )\n);\n\nSyncItemRow.displayName = 'SyncItemRow';\n\n// Table section component (memoized)\nconst SyncItemsTable = React.memo(\n  ({\n    items,\n    totalCount,\n    isLoading,\n    selectedIds,\n    onSelectItem,\n    onLoadMore,\n  }: {\n    items: SyncItem[];\n    totalCount: number;\n    isLoading: boolean;\n    selectedIds: Set<string | number>;\n    onSelectItem: (id: string | number) => void;\n    onLoadMore: () => void;\n  }) => (\n    <div className=\"space-y-4\">\n      <div className=\"rounded-lg border bg-card\">\n        <Table>\n          <TableHeader>\n            <TableRow>\n              <TableHead className=\"w-12\">\n                <span className=\"sr-only\">Select all</span>\n              </TableHead>\n              <TableHead>ID</TableHead>\n              <TableHead>Name</TableHead>\n              <TableHead>Last Modified</TableHead>\n              <TableHead>Preview</TableHead>\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {isLoading ? (\n              <>\n                <SkeletonRow columns={5} />\n                <SkeletonRow columns={5} />\n                <SkeletonRow columns={5} />\n              </>\n            ) : items.length > 0 ? (\n              items.map((item) => (\n                <SyncItemRow\n                  key={item.id}\n                  item={item}\n                  isSelected={selectedIds.has(item.id)}\n                  onSelect={() => onSelectItem(item.id)}\n                />\n              ))\n            ) : (\n              <TableRow>\n                <TableCell colSpan={5} className=\"text-center py-8 text-muted-foreground\">\n                  No items to sync\n                </TableCell>\n              </TableRow>\n            )}\n          </TableBody>\n        </Table>\n      </div>\n\n      {!isLoading && items.length > 0 && items.length < totalCount && (\n        <Button\n          variant=\"outline\"\n          onClick={onLoadMore}\n          className=\"w-full\"\n          disabled={isLoading}\n        >\n          {isLoading ? (\n            <>\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              Loading more...\n            </>\n          ) : (\n            `Load More (${items.length}/${totalCount})`\n          )}\n        </Button>\n      )}\n    </div>\n  )\n);\n\nSyncItemsTable.displayName = 'SyncItemsTable';\n\nexport const SyncPreview: React.FC<SyncPreviewProps> = ({\n  isOpen,\n  syncType,\n  entityType,\n  onConfirm,\n  onCancel,\n}) => {\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [data, setData] = useState<SyncPreviewData | null>(null);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedNew, setSelectedNew] = useState<Set<string | number>>(new Set());\n  const [selectedUpdated, setSelectedUpdated] = useState<Set<string | number>>(new Set());\n  const [selectedDeleted, setSelectedDeleted] = useState<Set<string | number>>(new Set());\n  const [includeNew, setIncludeNew] = useState(true);\n  const [includeUpdated, setIncludeUpdated] = useState(true);\n  const [includeDeleted, setIncludeDeleted] = useState(false);\n  const [activeTab, setActiveTab] = useState('new');\n\n  // Fetch sync preview data\n  useEffect(() => {\n    if (!isOpen || !syncType || !entityType) return;\n\n    const fetchPreview = async () => {\n      setLoading(true);\n      setError(null);\n      try {\n        const response = await fetch(\n          `/api/v1/integrations/sync/preview?action=fetch&sync_type=${syncType}&entity_type=${entityType}&orgId=org-default`,\n          {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              syncType,\n              entityType,\n              orgId: 'org-default',\n            }),\n          }\n        );\n\n        if (!response.ok) {\n          throw new Error(`Failed to fetch preview: ${response.statusText}`);\n        }\n\n        const result = await response.json();\n        if (result.success) {\n          setData(result.data);\n          setSelectedNew(new Set(result.data.newItems.map((item: SyncItem) => item.id)));\n          setSelectedUpdated(new Set(result.data.updatedItems.map((item: SyncItem) => item.id)));\n        } else {\n          throw new Error(result.error || 'Failed to load preview data');\n        }\n      } catch (err) {\n        setError(err instanceof Error ? err.message : 'An error occurred');\n        setData(null);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchPreview();\n  }, [isOpen, syncType, entityType]);\n\n  const handleSelectItem = useCallback(\n    (type: 'new' | 'updated' | 'deleted', id: string | number) => {\n      const setState =\n        type === 'new'\n          ? setSelectedNew\n          : type === 'updated'\n            ? setSelectedUpdated\n            : setSelectedDeleted;\n\n      setState((prev) => {\n        const next = new Set(prev);\n        next.has(id) ? next.delete(id) : next.add(id);\n        return next;\n      });\n    },\n    []\n  );\n\n  const handleConfirm = () => {\n    onConfirm({\n      includeNew,\n      includeUpdated,\n      includeDeleted,\n      selectedIds: [\n        ...(includeNew ? Array.from(selectedNew) : []),\n        ...(includeUpdated ? Array.from(selectedUpdated) : []),\n        ...(includeDeleted ? Array.from(selectedDeleted) : []),\n      ],\n    });\n  };\n\n  // Filter items based on search\n  const filterItems = (items: SyncItem[]): SyncItem[] => {\n    if (!searchTerm) return items;\n    return items.filter(\n      (item) =>\n        item.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        String(item.id).toLowerCase().includes(searchTerm.toLowerCase())\n    );\n  };\n\n  if (!data && !loading && !error) return null;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && onCancel()}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <span>Sync Preview</span>\n            <Badge variant=\"secondary\" className=\"capitalize\">\n              {syncType === 'woocommerce' ? 'WooCommerce' : 'Odoo'} - {entityType}\n            </Badge>\n          </DialogTitle>\n          <DialogDescription>\n            Review the items that will be synced before confirming the operation\n          </DialogDescription>\n        </DialogHeader>\n\n        {error && (\n          <Card className=\"border-destructive bg-destructive/5\">\n            <CardContent className=\"pt-6\">\n              <div className=\"flex gap-3\">\n                <AlertCircle className=\"h-5 w-5 text-destructive flex-shrink-0 mt-0.5\" />\n                <div>\n                  <p className=\"font-medium text-destructive\">{error}</p>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"mt-2\"\n                    onClick={() => {\n                      setError(null);\n                      setData(null);\n                      // Re-fetch will happen automatically\n                    }}\n                  >\n                    <RefreshCw className=\"h-3 w-3 mr-1\" />\n                    Retry\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {data && (\n          <>\n            {/* Search bar */}\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-3 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search by name or ID...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n                aria-label=\"Search sync items\"\n              />\n            </div>\n\n            {/* Sync items tabs */}\n            <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"new\" className=\"flex items-center gap-2\">\n                  <CheckCircle2 className=\"h-4 w-4\" />\n                  New\n                  <Badge variant=\"secondary\" className=\"ml-1\">\n                    {data.totalNew}\n                  </Badge>\n                </TabsTrigger>\n                <TabsTrigger value=\"updated\" className=\"flex items-center gap-2\">\n                  <RefreshCw className=\"h-4 w-4\" />\n                  Updated\n                  <Badge variant=\"secondary\" className=\"ml-1\">\n                    {data.totalUpdated}\n                  </Badge>\n                </TabsTrigger>\n                <TabsTrigger value=\"deleted\" className=\"flex items-center gap-2\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  Deleted\n                  <Badge variant=\"destructive\" className=\"ml-1\">\n                    {data.totalDeleted}\n                  </Badge>\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"new\" className=\"space-y-4\">\n                <SyncItemsTable\n                  items={filterItems(data.newItems)}\n                  totalCount={data.totalNew}\n                  isLoading={loading}\n                  selectedIds={selectedNew}\n                  onSelectItem={(id) => handleSelectItem('new', id)}\n                  onLoadMore={() => {\n                    // Load more implementation would go here\n                  }}\n                />\n              </TabsContent>\n\n              <TabsContent value=\"updated\" className=\"space-y-4\">\n                <SyncItemsTable\n                  items={filterItems(data.updatedItems)}\n                  totalCount={data.totalUpdated}\n                  isLoading={loading}\n                  selectedIds={selectedUpdated}\n                  onSelectItem={(id) => handleSelectItem('updated', id)}\n                  onLoadMore={() => {\n                    // Load more implementation would go here\n                  }}\n                />\n              </TabsContent>\n\n              <TabsContent value=\"deleted\" className=\"space-y-4\">\n                <SyncItemsTable\n                  items={filterItems(data.deletedItems)}\n                  totalCount={data.totalDeleted}\n                  isLoading={loading}\n                  selectedIds={selectedDeleted}\n                  onSelectItem={(id) => handleSelectItem('deleted', id)}\n                  onLoadMore={() => {\n                    // Load more implementation would go here\n                  }}\n                />\n              </TabsContent>\n            </Tabs>\n\n            {/* Sync options */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">Sync Configuration</CardTitle>\n                <CardDescription>Choose which item types to sync</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex items-center gap-2\">\n                  <Checkbox\n                    id=\"include-new\"\n                    checked={includeNew}\n                    onCheckedChange={(checked) => setIncludeNew(checked === true)}\n                    aria-label=\"Include new items in sync\"\n                  />\n                  <Label htmlFor=\"include-new\" className=\"font-normal cursor-pointer\">\n                    Include New Items ({data.totalNew})\n                  </Label>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Checkbox\n                    id=\"include-updated\"\n                    checked={includeUpdated}\n                    onCheckedChange={(checked) => setIncludeUpdated(checked === true)}\n                    aria-label=\"Include updated items in sync\"\n                  />\n                  <Label htmlFor=\"include-updated\" className=\"font-normal cursor-pointer\">\n                    Include Updated Items ({data.totalUpdated})\n                  </Label>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Checkbox\n                    id=\"include-deleted\"\n                    checked={includeDeleted}\n                    onCheckedChange={(checked) => setIncludeDeleted(checked === true)}\n                    aria-label=\"Include deleted items in sync\"\n                  />\n                  <Label htmlFor=\"include-deleted\" className=\"font-normal cursor-pointer\">\n                    Include Deleted Items ({data.totalDeleted})\n                  </Label>\n                </div>\n              </CardContent>\n            </Card>\n          </>\n        )}\n\n        <DialogFooter className=\"flex gap-2 justify-end\">\n          <Button variant=\"outline\" onClick={onCancel} disabled={loading}>\n            Cancel\n          </Button>\n          <Button\n            onClick={handleConfirm}\n            disabled={loading || !data}\n            className={cn(\n              'gap-2',\n              loading && 'opacity-70'\n            )}\n          >\n            {loading ? (\n              <>\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                Loading...\n              </>\n            ) : (\n              <>\n                <CheckCircle2 className=\"h-4 w-4\" />\n                Sync Selected\n              </>\n            )}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default SyncPreview;\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\inventory\\AddProductsModeDialog.tsx","messages":[{"ruleId":"jsx-a11y/no-static-element-interactions","severity":2,"message":"Avoid non-native interactive elements. If using native HTML is not possible, add an appropriate role and support for tabbing, mouse, keyboard, and touch inputs to an interactive content element.","line":32,"column":11,"nodeType":"JSXOpeningElement","endLine":32,"endColumn":127},{"ruleId":"jsx-a11y/no-static-element-interactions","severity":2,"message":"Avoid non-native interactive elements. If using native HTML is not possible, add an appropriate role and support for tabbing, mouse, keyboard, and touch inputs to an interactive content element.","line":43,"column":11,"nodeType":"JSXOpeningElement","endLine":43,"endColumn":126}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport React from 'react'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog'\nimport { Button } from '@/components/ui/button'\nimport { Plus, Package } from 'lucide-react'\n\ninterface AddProductsModeDialogProps {\n  open: boolean\n  onOpenChange: (open: boolean) => void\n  onChoose: (mode: 'single' | 'multi') => void\n}\n\nexport default function AddProductsModeDialog({ open, onOpenChange, onChoose }: AddProductsModeDialogProps) {\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-3xl\">\n        <DialogHeader>\n          <DialogTitle>Select Add Product Mode</DialogTitle>\n          <DialogDescription>\n            Choose how you’d like to add products to your inventory.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <div className=\"border rounded-lg p-6 hover:shadow-sm transition cursor-pointer\" onClick={() => onChoose('single')}>\n            <div className=\"flex items-center mb-3\">\n              <Plus className=\"h-5 w-5 text-blue-600 mr-2\" />\n              <h3 className=\"font-semibold\">Add Singular Product</h3>\n            </div>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              Create a single product by entering details manually.\n            </p>\n            <Button className=\"w-full\" onClick={() => onChoose('single')}>Add Single Product</Button>\n          </div>\n\n          <div className=\"border rounded-lg p-6 hover:shadow-sm transition cursor-pointer\" onClick={() => onChoose('multi')}>\n            <div className=\"flex items-center mb-3\">\n              <Package className=\"h-5 w-5 text-green-600 mr-2\" />\n              <h3 className=\"font-semibold\">Add Multiple Products</h3>\n            </div>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              Browse supplier portfolio, filter, select, and set quantities.\n            </p>\n            <Button className=\"w-full\" variant=\"secondary\" onClick={() => onChoose('multi')}>Select Multiple Products</Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\inventory\\ErrorBoundary.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":124,"column":12,"nodeType":"Identifier","messageId":"undef","endLine":124,"endColumn":24},{"ruleId":"no-undef","severity":2,"message":"'sessionStorage' is not defined.","line":129,"column":21,"nodeType":"Identifier","messageId":"undef","endLine":129,"endColumn":35},{"ruleId":"no-undef","severity":2,"message":"'sessionStorage' is not defined.","line":132,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":132,"endColumn":21}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { Component, ErrorInfo, ReactNode } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport {\r\n  AlertTriangle,\r\n  RefreshCw,\r\n  Bug,\r\n  Clock,\r\n  User,\r\n  Monitor,\r\n  Copy,\r\n  Download,\r\n  Send,\r\n  ChevronDown,\r\n  ChevronUp\r\n} from 'lucide-react'\r\n\r\ninterface ErrorBoundaryState {\r\n  hasError: boolean\r\n  error?: Error\r\n  errorInfo?: ErrorInfo\r\n  errorId: string\r\n  timestamp: Date\r\n  expanded: boolean\r\n}\r\n\r\ninterface ErrorBoundaryProps {\r\n  children: ReactNode\r\n  fallback?: ReactNode\r\n  onError?: (error: Error, errorInfo: ErrorInfo, errorId: string) => void\r\n  showDetails?: boolean\r\n  enableReporting?: boolean\r\n}\r\n\r\ninterface ErrorDetails {\r\n  message: string\r\n  stack?: string\r\n  componentStack?: string\r\n  userAgent: string\r\n  url: string\r\n  timestamp: Date\r\n  userId?: string\r\n  sessionId?: string\r\n  buildVersion?: string\r\n}\r\n\r\nclass ErrorBoundary extends Component<ErrorBoundaryProps, ErrorBoundaryState> {\r\n  private retryCount = 0\r\n  private maxRetries = 3\r\n\r\n  constructor(props: ErrorBoundaryProps) {\r\n    super(props)\r\n    this.state = {\r\n      hasError: false,\r\n      errorId: '',\r\n      timestamp: new Date(),\r\n      expanded: false\r\n    }\r\n  }\r\n\r\n  static getDerivedStateFromError(error: Error): Partial<ErrorBoundaryState> {\r\n    const errorId = `ERR_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n    return {\r\n      hasError: true,\r\n      error,\r\n      errorId,\r\n      timestamp: new Date()\r\n    }\r\n  }\r\n\r\n  componentDidCatch(error: Error, errorInfo: ErrorInfo) {\r\n    const { onError } = this.props\r\n    const { errorId } = this.state\r\n\r\n    console.error('ErrorBoundary caught an error:', error, errorInfo)\r\n\r\n    this.setState({\r\n      error,\r\n      errorInfo\r\n    })\r\n\r\n    // Call custom error handler\r\n    onError?.(error, errorInfo, errorId)\r\n\r\n    // Log to external service in production\r\n    if (process.env.NODE_ENV === 'production') {\r\n      this.reportError(error, errorInfo, errorId)\r\n    }\r\n  }\r\n\r\n  private reportError = async (error: Error, errorInfo: ErrorInfo, errorId: string) => {\r\n    try {\r\n      const errorDetails: ErrorDetails = {\r\n        message: error.message,\r\n        stack: error.stack,\r\n        componentStack: errorInfo.componentStack,\r\n        userAgent: navigator.userAgent,\r\n        url: window.location.href,\r\n        timestamp: new Date(),\r\n        userId: this.getUserId(),\r\n        sessionId: this.getSessionId(),\r\n        buildVersion: process.env.NEXT_PUBLIC_BUILD_VERSION\r\n      }\r\n\r\n      // In a real app, send to error reporting service\r\n      // await fetch('/api/errors', {\r\n      //   method: 'POST',\r\n      //   headers: { 'Content-Type': 'application/json' },\r\n      //   body: JSON.stringify({ errorId, ...errorDetails })\r\n      // })\r\n\r\n      // Error reported to logging service\r\n    } catch (reportingError) {\r\n      console.error('Failed to report error:', reportingError)\r\n    }\r\n  }\r\n\r\n  private getUserId = (): string | undefined => {\r\n    // Get user ID from authentication context, localStorage, etc.\r\n    return localStorage.getItem('userId') || undefined\r\n  }\r\n\r\n  private getSessionId = (): string | undefined => {\r\n    // Get session ID from sessionStorage or generate one\r\n    let sessionId = sessionStorage.getItem('sessionId')\r\n    if (!sessionId) {\r\n      sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n      sessionStorage.setItem('sessionId', sessionId)\r\n    }\r\n    return sessionId\r\n  }\r\n\r\n  private handleRetry = () => {\r\n    if (this.retryCount < this.maxRetries) {\r\n      this.retryCount++\r\n      this.setState({\r\n        hasError: false,\r\n        error: undefined,\r\n        errorInfo: undefined\r\n      })\r\n    }\r\n  }\r\n\r\n  private handleRefresh = () => {\r\n    window.location.reload()\r\n  }\r\n\r\n  private copyErrorDetails = () => {\r\n    const { error, errorInfo, errorId, timestamp } = this.state\r\n\r\n    const details = {\r\n      errorId,\r\n      timestamp: timestamp.toISOString(),\r\n      message: error?.message,\r\n      stack: error?.stack,\r\n      componentStack: errorInfo?.componentStack,\r\n      url: window.location.href,\r\n      userAgent: navigator.userAgent\r\n    }\r\n\r\n    navigator.clipboard.writeText(JSON.stringify(details, null, 2))\r\n      .then(() => {\r\n        // Show success notification\r\n        console.log('Error details copied to clipboard')\r\n      })\r\n      .catch(err => {\r\n        console.error('Failed to copy error details:', err)\r\n      })\r\n  }\r\n\r\n  private downloadErrorReport = () => {\r\n    const { error, errorInfo, errorId, timestamp } = this.state\r\n\r\n    const report = {\r\n      errorId,\r\n      timestamp: timestamp.toISOString(),\r\n      error: {\r\n        message: error?.message,\r\n        stack: error?.stack,\r\n        name: error?.name\r\n      },\r\n      errorInfo: {\r\n        componentStack: errorInfo?.componentStack\r\n      },\r\n      environment: {\r\n        url: window.location.href,\r\n        userAgent: navigator.userAgent,\r\n        timestamp: new Date().toISOString(),\r\n        buildVersion: process.env.NEXT_PUBLIC_BUILD_VERSION\r\n      }\r\n    }\r\n\r\n    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' })\r\n    const url = URL.createObjectURL(blob)\r\n    const link = document.createElement('a')\r\n    link.href = url\r\n    link.download = `error-report-${errorId}.json`\r\n    document.body.appendChild(link)\r\n    link.click()\r\n    document.body.removeChild(link)\r\n    URL.revokeObjectURL(url)\r\n  }\r\n\r\n  private formatStackTrace = (stack?: string): string[] => {\r\n    if (!stack) return []\r\n    return stack.split('\\n').filter(line => line.trim())\r\n  }\r\n\r\n  render() {\r\n    const { children, fallback, showDetails = true, enableReporting = true } = this.props\r\n    const { hasError, error, errorInfo, errorId, timestamp, expanded } = this.state\r\n\r\n    if (hasError) {\r\n      if (fallback) {\r\n        return fallback\r\n      }\r\n\r\n      const canRetry = this.retryCount < this.maxRetries\r\n\r\n      return (\r\n        <div className=\"min-h-screen flex items-center justify-center p-4 bg-muted/30\">\r\n          <Card className=\"w-full max-w-4xl\">\r\n            <CardHeader className=\"pb-4\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"p-2 bg-red-100 rounded-full\">\r\n                  <AlertTriangle className=\"h-6 w-6 text-red-600\" />\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                  <CardTitle className=\"text-red-800\">Something went wrong</CardTitle>\r\n                  <p className=\"text-sm text-muted-foreground mt-1\">\r\n                    An unexpected error occurred. We've been notified and are working on it.\r\n                  </p>\r\n                </div>\r\n                <Badge variant=\"outline\" className=\"font-mono text-xs\">\r\n                  {errorId}\r\n                </Badge>\r\n              </div>\r\n            </CardHeader>\r\n\r\n            <CardContent className=\"space-y-4\">\r\n              {/* Error Summary */}\r\n              <Alert className=\"border-red-200 bg-red-50\">\r\n                <Bug className=\"h-4 w-4\" />\r\n                <AlertDescription className=\"text-red-800\">\r\n                  <div className=\"font-medium mb-1\">{error?.name || 'Error'}</div>\r\n                  <div className=\"text-sm\">{error?.message || 'An unknown error occurred'}</div>\r\n                </AlertDescription>\r\n              </Alert>\r\n\r\n              {/* Error Metadata */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n                  <span className=\"text-muted-foreground\">Time:</span>\r\n                  <span className=\"font-mono\">{timestamp.toLocaleString()}</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <User className=\"h-4 w-4 text-muted-foreground\" />\r\n                  <span className=\"text-muted-foreground\">User:</span>\r\n                  <span className=\"font-mono\">{this.getUserId() || 'Anonymous'}</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Monitor className=\"h-4 w-4 text-muted-foreground\" />\r\n                  <span className=\"text-muted-foreground\">Session:</span>\r\n                  <span className=\"font-mono text-xs\">{this.getSessionId()?.slice(0, 12)}...</span>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Action Buttons */}\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {canRetry && (\r\n                  <Button onClick={this.handleRetry} className=\"flex-1 sm:flex-none\">\r\n                    <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                    Try Again ({this.maxRetries - this.retryCount} left)\r\n                  </Button>\r\n                )}\r\n                <Button variant=\"outline\" onClick={this.handleRefresh} className=\"flex-1 sm:flex-none\">\r\n                  <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                  Refresh Page\r\n                </Button>\r\n                {showDetails && (\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    onClick={() => this.setState({ expanded: !expanded })}\r\n                    className=\"flex-1 sm:flex-none\"\r\n                  >\r\n                    {expanded ? <ChevronUp className=\"h-4 w-4 mr-2\" /> : <ChevronDown className=\"h-4 w-4 mr-2\" />}\r\n                    {expanded ? 'Hide' : 'Show'} Details\r\n                  </Button>\r\n                )}\r\n              </div>\r\n\r\n              {/* Detailed Error Information */}\r\n              {showDetails && expanded && (\r\n                <Card className=\"border-muted\">\r\n                  <CardHeader className=\"pb-3\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <CardTitle className=\"text-sm\">Error Details</CardTitle>\r\n                      <div className=\"flex gap-2\">\r\n                        <Button variant=\"ghost\" size=\"sm\" onClick={this.copyErrorDetails}>\r\n                          <Copy className=\"h-4 w-4 mr-1\" />\r\n                          Copy\r\n                        </Button>\r\n                        <Button variant=\"ghost\" size=\"sm\" onClick={this.downloadErrorReport}>\r\n                          <Download className=\"h-4 w-4 mr-1\" />\r\n                          Download\r\n                        </Button>\r\n                        {enableReporting && (\r\n                          <Button variant=\"ghost\" size=\"sm\">\r\n                            <Send className=\"h-4 w-4 mr-1\" />\r\n                            Report\r\n                          </Button>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <Tabs defaultValue=\"error\" className=\"w-full\">\r\n                      <TabsList className=\"grid w-full grid-cols-3\">\r\n                        <TabsTrigger value=\"error\">Error Stack</TabsTrigger>\r\n                        <TabsTrigger value=\"component\">Component Stack</TabsTrigger>\r\n                        <TabsTrigger value=\"environment\">Environment</TabsTrigger>\r\n                      </TabsList>\r\n\r\n                      <TabsContent value=\"error\" className=\"mt-4\">\r\n                        <ScrollArea className=\"h-64 w-full rounded border p-3 bg-muted/30\">\r\n                          <pre className=\"text-xs font-mono leading-relaxed\">\r\n                            {this.formatStackTrace(error?.stack).map((line, index) => (\r\n                              <div\r\n                                key={index}\r\n                                className={`${\r\n                                  line.includes('at ') ? 'text-blue-600' : 'text-muted-foreground'\r\n                                }`}\r\n                              >\r\n                                {line}\r\n                              </div>\r\n                            ))}\r\n                          </pre>\r\n                        </ScrollArea>\r\n                      </TabsContent>\r\n\r\n                      <TabsContent value=\"component\" className=\"mt-4\">\r\n                        <ScrollArea className=\"h-64 w-full rounded border p-3 bg-muted/30\">\r\n                          <pre className=\"text-xs font-mono leading-relaxed text-muted-foreground\">\r\n                            {errorInfo?.componentStack || 'No component stack available'}\r\n                          </pre>\r\n                        </ScrollArea>\r\n                      </TabsContent>\r\n\r\n                      <TabsContent value=\"environment\" className=\"mt-4\">\r\n                        <div className=\"space-y-3 text-sm\">\r\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                            <div>\r\n                              <span className=\"font-medium\">URL:</span>\r\n                              <div className=\"font-mono text-xs mt-1 p-2 bg-muted rounded\">\r\n                                {window.location.href}\r\n                              </div>\r\n                            </div>\r\n                            <div>\r\n                              <span className=\"font-medium\">User Agent:</span>\r\n                              <div className=\"font-mono text-xs mt-1 p-2 bg-muted rounded\">\r\n                                {navigator.userAgent}\r\n                              </div>\r\n                            </div>\r\n                            <div>\r\n                              <span className=\"font-medium\">Build Version:</span>\r\n                              <div className=\"font-mono text-xs mt-1 p-2 bg-muted rounded\">\r\n                                {process.env.NEXT_PUBLIC_BUILD_VERSION || 'Unknown'}\r\n                              </div>\r\n                            </div>\r\n                            <div>\r\n                              <span className=\"font-medium\">Error ID:</span>\r\n                              <div className=\"font-mono text-xs mt-1 p-2 bg-muted rounded\">\r\n                                {errorId}\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </TabsContent>\r\n                    </Tabs>\r\n                  </CardContent>\r\n                </Card>\r\n              )}\r\n\r\n              {/* Help Text */}\r\n              <div className=\"text-xs text-muted-foreground bg-muted/30 p-3 rounded\">\r\n                <p className=\"mb-1\">\r\n                  <strong>What happened?</strong> An unexpected error occurred in the application.\r\n                </p>\r\n                <p className=\"mb-1\">\r\n                  <strong>What can you do?</strong> Try refreshing the page or retrying the action. If the problem persists, please contact support.\r\n                </p>\r\n                <p>\r\n                  <strong>Need help?</strong> Include the error ID ({errorId}) when contacting support.\r\n                </p>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      )\r\n    }\r\n\r\n    return children\r\n  }\r\n}\r\n\r\nexport default ErrorBoundary","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\inventory\\InventoryDetailView.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'XCircle' is not defined.","line":1021,"column":28,"nodeType":"JSXIdentifier","messageId":"undef","endLine":1021,"endColumn":35},{"ruleId":"no-undef","severity":2,"message":"'XCircle' is not defined.","line":1029,"column":28,"nodeType":"JSXIdentifier","messageId":"undef","endLine":1029,"endColumn":35},{"ruleId":"no-undef","severity":2,"message":"'XCircle' is not defined.","line":1037,"column":28,"nodeType":"JSXIdentifier","messageId":"undef","endLine":1037,"endColumn":35},{"ruleId":"no-undef","severity":2,"message":"'cn' is not defined.","line":1153,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":1153,"endColumn":25}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useMemo } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Separator } from '@/components/ui/separator'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu'\r\nimport {\r\n  LineChart,\r\n  Line,\r\n  XAxis,\r\n  YAxis,\r\n  CartesianGrid,\r\n  Tooltip,\r\n  ResponsiveContainer,\r\n  BarChart,\r\n  Bar,\r\n  PieChart,\r\n  Pie,\r\n  Cell,\r\n  AreaChart,\r\n  Area,\r\n  Legend\r\n} from 'recharts'\r\nimport {\r\n  Package,\r\n  Building2,\r\n  MapPin,\r\n  DollarSign,\r\n  Calendar,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Clock,\r\n  Eye,\r\n  Edit,\r\n  Download,\r\n  Share,\r\n  MoreHorizontal,\r\n  BarChart3,\r\n  Activity,\r\n  Truck,\r\n  ShoppingCart,\r\n  FileText,\r\n  Star,\r\n  Info,\r\n  Settings,\r\n  RefreshCw,\r\n  ArrowUp,\r\n  ArrowDown,\r\n  History,\r\n  Users,\r\n  Target,\r\n  Zap,\r\n  X,\r\n  Maximize2,\r\n  Minimize2,\r\n  Copy,\r\n  ExternalLink,\r\n  Award,\r\n  Shield,\r\n  Globe,\r\n  Mail,\r\n  Phone,\r\n  Layers,\r\n  PieChart as PieChartIcon,\r\n  Percent,\r\n  MousePointer,\r\n  Filter,\r\n  Search,\r\n  Calendar as CalendarIcon\r\n} from 'lucide-react'\r\nimport type { Product, InventoryItem, Supplier, StockMovement } from '@/lib/types/inventory'\r\nimport { format, subDays, isAfter, isBefore } from 'date-fns'\r\n\r\ninterface DetailedInventoryItem {\r\n  product: Product\r\n  inventoryItem: InventoryItem\r\n  supplier: Supplier\r\n  movements: StockMovement[]\r\n  analytics: {\r\n    averageMonthlyUsage: number\r\n    stockTurnover: number\r\n    daysOnHand: number\r\n    reorderFrequency: number\r\n    costTrend: 'up' | 'down' | 'stable'\r\n    demandTrend: 'up' | 'down' | 'stable'\r\n    seasonalPattern: boolean\r\n    abcClassification: 'A' | 'B' | 'C'\r\n    velocityRating: 'fast' | 'medium' | 'slow' | 'obsolete'\r\n  }\r\n  forecasting: {\r\n    predictedStockout: string | null\r\n    recommendedReorder: number\r\n    economicOrderQuantity: number\r\n    safetyStockLevel: number\r\n  }\r\n  compliance: {\r\n    expiryTracking: boolean\r\n    batchTracking: boolean\r\n    serialTracking: boolean\r\n    regulatoryRequirements: string[]\r\n    certifications: string[]\r\n  }\r\n  performance: {\r\n    qualityScore: number\r\n    availabilityScore: number\r\n    costEfficiency: number\r\n    supplierReliability: number\r\n  }\r\n}\r\n\r\ninterface InventoryDetailViewProps {\r\n  itemId: string\r\n  onClose: () => void\r\n}\r\n\r\nexport default function InventoryDetailView({ itemId, onClose }: InventoryDetailViewProps) {\r\n  const [activeTab, setActiveTab] = useState('overview')\r\n  const [timeRange, setTimeRange] = useState('30d')\r\n\r\n  // Mock detailed data - in real implementation, this would come from API\r\n  const detailedItem: DetailedInventoryItem = {\r\n    product: {\r\n      id: itemId,\r\n      supplier_id: 'supplier-1',\r\n      name: 'Premium Steel Bolts M12x50mm',\r\n      description: 'High-grade stainless steel bolts with hex head, suitable for outdoor applications',\r\n      category: 'components',\r\n      sku: 'BOLT-M12-50-SS',\r\n      unit_of_measure: 'pieces',\r\n      unit_cost_zar: 12.50,\r\n      lead_time_days: 14,\r\n      minimum_order_quantity: 100,\r\n      status: 'active',\r\n      created_at: '2024-01-15T00:00:00Z',\r\n      updated_at: '2024-11-20T00:00:00Z',\r\n      barcode: '1234567890123',\r\n      weight_kg: 0.05,\r\n      dimensions_cm: '1.2 x 1.2 x 5.0',\r\n      shelf_life_days: null,\r\n      storage_requirements: 'Dry storage, avoid corrosive environments',\r\n      country_of_origin: 'South Africa',\r\n      brand: 'SteelTech',\r\n      model_number: 'ST-M12-50',\r\n      certification_standards: ['ISO 9001', 'SABS 0395'],\r\n      environmental_impact_score: 8.5,\r\n      recyclable: true,\r\n      critical_item: true,\r\n      strategic_importance: 'high'\r\n    } as Product,\r\n    inventoryItem: {\r\n      id: itemId,\r\n      product_id: itemId,\r\n      location: 'WAREHOUSE-A-B12',\r\n      current_stock: 450,\r\n      reserved_stock: 50,\r\n      available_stock: 400,\r\n      reorder_point: 200,\r\n      max_stock_level: 1000,\r\n      last_counted: '2024-11-15T00:00:00Z',\r\n      cost_per_unit_zar: 12.50,\r\n      total_value_zar: 5625,\r\n      created_at: '2024-01-15T00:00:00Z',\r\n      updated_at: '2024-11-20T00:00:00Z',\r\n      stock_status: 'in_stock',\r\n      abc_classification: 'A',\r\n      velocity_rating: 'fast'\r\n    } as InventoryItem,\r\n    supplier: {\r\n      id: 'supplier-1',\r\n      name: 'SteelTech Manufacturing',\r\n      email: 'orders@steeltech.co.za',\r\n      phone: '+27 11 123 4567',\r\n      status: 'active',\r\n      performance_tier: 'platinum',\r\n      preferred_supplier: true,\r\n      quality_rating: 9.2,\r\n      delivery_performance_score: 95.5\r\n    } as Supplier,\r\n    movements: [\r\n      {\r\n        id: '1',\r\n        inventory_item_id: itemId,\r\n        movement_type: 'receipt',\r\n        quantity: 500,\r\n        unit_cost_zar: 12.50,\r\n        total_value_zar: 6250,\r\n        reference_document: 'PO-2024-001',\r\n        created_at: '2024-11-01T10:00:00Z',\r\n        notes: 'Initial stock delivery',\r\n        created_by: 'system'\r\n      },\r\n      {\r\n        id: '2',\r\n        inventory_item_id: itemId,\r\n        movement_type: 'issue',\r\n        quantity: -50,\r\n        unit_cost_zar: 12.50,\r\n        total_value_zar: -625,\r\n        reference_document: 'WO-2024-015',\r\n        created_at: '2024-11-05T14:30:00Z',\r\n        notes: 'Used in Project Alpha',\r\n        created_by: 'john.doe'\r\n      }\r\n    ],\r\n    analytics: {\r\n      averageMonthlyUsage: 150,\r\n      stockTurnover: 3.6,\r\n      daysOnHand: 101,\r\n      reorderFrequency: 4,\r\n      costTrend: 'up',\r\n      demandTrend: 'stable',\r\n      seasonalPattern: false,\r\n      abcClassification: 'A',\r\n      velocityRating: 'fast'\r\n    },\r\n    forecasting: {\r\n      predictedStockout: '2025-01-15',\r\n      recommendedReorder: 300,\r\n      economicOrderQuantity: 400,\r\n      safetyStockLevel: 100\r\n    },\r\n    compliance: {\r\n      expiryTracking: false,\r\n      batchTracking: true,\r\n      serialTracking: false,\r\n      regulatoryRequirements: ['SABS Compliance', 'CE Marking'],\r\n      certifications: ['ISO 9001', 'SABS 0395']\r\n    },\r\n    performance: {\r\n      qualityScore: 92,\r\n      availabilityScore: 98,\r\n      costEfficiency: 85,\r\n      supplierReliability: 95\r\n    }\r\n  }\r\n\r\n  // Mock chart data\r\n  const stockLevelsData = [\r\n    { date: '2024-10-01', stock: 380 },\r\n    { date: '2024-10-08', stock: 420 },\r\n    { date: '2024-10-15', stock: 390 },\r\n    { date: '2024-10-22', stock: 480 },\r\n    { date: '2024-10-29', stock: 450 },\r\n    { date: '2024-11-05', stock: 400 },\r\n    { date: '2024-11-12', stock: 430 },\r\n    { date: '2024-11-19', stock: 450 }\r\n  ]\r\n\r\n  const movementData = [\r\n    { month: 'Jul', receipts: 400, issues: 150 },\r\n    { month: 'Aug', receipts: 300, issues: 180 },\r\n    { month: 'Sep', receipts: 500, issues: 200 },\r\n    { month: 'Oct', receipts: 200, issues: 160 },\r\n    { month: 'Nov', receipts: 500, issues: 140 }\r\n  ]\r\n\r\n  const costAnalysisData = [\r\n    { month: 'Jul', cost: 11.80 },\r\n    { month: 'Aug', cost: 12.00 },\r\n    { month: 'Sep', cost: 12.20 },\r\n    { month: 'Oct', cost: 12.35 },\r\n    { month: 'Nov', cost: 12.50 }\r\n  ]\r\n\r\n  const formatCurrency = (amount: number) => {\r\n    return new Intl.NumberFormat('en-ZA', {\r\n      style: 'currency',\r\n      currency: 'ZAR',\r\n      minimumFractionDigits: 2\r\n    }).format(amount)\r\n  }\r\n\r\n  const getStatusColor = (status: string) => {\r\n    switch (status) {\r\n      case 'in_stock': return 'text-green-600'\r\n      case 'low_stock': return 'text-orange-600'\r\n      case 'out_of_stock': return 'text-red-600'\r\n      case 'overstocked': return 'text-blue-600'\r\n      default: return 'text-gray-600'\r\n    }\r\n  }\r\n\r\n  const getTrendIcon = (trend: string) => {\r\n    switch (trend) {\r\n      case 'up': return <TrendingUp className=\"h-4 w-4 text-green-600\" />\r\n      case 'down': return <TrendingDown className=\"h-4 w-4 text-red-600\" />\r\n      default: return <div className=\"h-4 w-4\" />\r\n    }\r\n  }\r\n\r\n  const getPerformanceColor = (score: number) => {\r\n    if (score >= 90) return 'text-green-600'\r\n    if (score >= 70) return 'text-yellow-600'\r\n    return 'text-red-600'\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in duration-300\">\r\n      <div className=\"bg-background rounded-2xl w-full max-w-7xl max-h-[95vh] overflow-hidden shadow-2xl border-0 animate-in slide-in-from-bottom-4 duration-500\">\r\n        {/* Enhanced Header */}\r\n        <div className=\"bg-gradient-to-r from-white via-gray-50 to-white border-b p-8 shadow-sm\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-6\">\r\n              <div className=\"relative\">\r\n                <div className=\"p-4 bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-600 rounded-2xl shadow-lg\">\r\n                  <Package className=\"h-10 w-10 text-white\" />\r\n                </div>\r\n                <div className=\"absolute -bottom-2 -right-2\">\r\n                  <div className={`w-6 h-6 rounded-full border-2 border-white shadow-lg ${\r\n                    detailedItem.inventoryItem.stock_status === 'in_stock' ? 'bg-green-500' :\r\n                    detailedItem.inventoryItem.stock_status === 'low_stock' ? 'bg-orange-500' :\r\n                    detailedItem.inventoryItem.stock_status === 'out_of_stock' ? 'bg-red-500' :\r\n                    'bg-gray-500'\r\n                  }`} />\r\n                </div>\r\n              </div>\r\n              <div className=\"space-y-3\">\r\n                <div>\r\n                  <h1 className=\"text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent\">\r\n                    {detailedItem.product.name}\r\n                  </h1>\r\n                  <p className=\"text-gray-600 mt-1\">{detailedItem.product.description}</p>\r\n                </div>\r\n                <div className=\"flex items-center gap-6 text-sm\">\r\n                  <div className=\"flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-lg\">\r\n                    <BarChart3 className=\"h-4 w-4 text-gray-600\" />\r\n                    <span className=\"font-medium text-gray-700\">SKU: {detailedItem.product.sku}</span>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2 bg-blue-100 px-3 py-1 rounded-lg\">\r\n                    <MapPin className=\"h-4 w-4 text-blue-600\" />\r\n                    <span className=\"font-medium text-blue-700\">{detailedItem.inventoryItem.location}</span>\r\n                  </div>\r\n                  <Badge\r\n                    className={`px-3 py-1 font-semibold ${\r\n                      detailedItem.inventoryItem.stock_status === 'in_stock'\r\n                        ? 'bg-green-100 text-green-800 border-green-300'\r\n                        : detailedItem.inventoryItem.stock_status === 'low_stock'\r\n                        ? 'bg-orange-100 text-orange-800 border-orange-300'\r\n                        : detailedItem.inventoryItem.stock_status === 'out_of_stock'\r\n                        ? 'bg-red-100 text-red-800 border-red-300'\r\n                        : 'bg-gray-100 text-gray-800 border-gray-300'\r\n                    }`}\r\n                  >\r\n                    {detailedItem.inventoryItem.stock_status.replace('_', ' ').toUpperCase()}\r\n                  </Badge>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-center gap-3\">\r\n              <Button variant=\"outline\" size=\"sm\" className=\"hover:bg-green-50 hover:border-green-300 transition-all\">\r\n                <Download className=\"h-4 w-4 mr-2\" />\r\n                Export\r\n              </Button>\r\n              <Button variant=\"outline\" size=\"sm\" className=\"hover:bg-blue-50 hover:border-blue-300 transition-all\">\r\n                <Share className=\"h-4 w-4 mr-2\" />\r\n                Share\r\n              </Button>\r\n              <Button variant=\"outline\" size=\"sm\" className=\"hover:bg-purple-50 hover:border-purple-300 transition-all\">\r\n                <Copy className=\"h-4 w-4 mr-2\" />\r\n                Copy Link\r\n              </Button>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button variant=\"outline\" size=\"sm\" className=\"hover:bg-gray-100\">\r\n                    <MoreHorizontal className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\" className=\"w-56\">\r\n                  <DropdownMenuItem className=\"hover:bg-blue-50\">\r\n                    <Edit className=\"h-4 w-4 mr-2\" />\r\n                    Edit Product Details\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem className=\"hover:bg-green-50\">\r\n                    <BarChart3 className=\"h-4 w-4 mr-2\" />\r\n                    Adjust Stock Level\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem className=\"hover:bg-purple-50\">\r\n                    <ExternalLink className=\"h-4 w-4 mr-2\" />\r\n                    View in Catalog\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuSeparator />\r\n                  <DropdownMenuItem className=\"hover:bg-orange-50\">\r\n                    <ShoppingCart className=\"h-4 w-4 mr-2\" />\r\n                    Create Purchase Order\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem className=\"hover:bg-indigo-50\">\r\n                    <Truck className=\"h-4 w-4 mr-2\" />\r\n                    Track Shipments\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={onClose}\r\n                className=\"hover:bg-red-50 hover:border-red-300 transition-all\"\r\n              >\r\n                <X className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Enhanced Key Metrics Dashboard */}\r\n        <div className=\"bg-gradient-to-br from-gray-50 via-white to-blue-50 p-8 border-b\">\r\n          <div className=\"grid grid-cols-2 md:grid-cols-6 gap-6\">\r\n            <div className=\"group hover:scale-105 transition-all duration-300\">\r\n              <Card className=\"text-center p-4 bg-gradient-to-br from-green-50 to-emerald-50 border-green-200 shadow-sm hover:shadow-lg transition-all\">\r\n                <div className=\"flex items-center justify-center mb-2\">\r\n                  <Package className=\"h-5 w-5 text-green-600 mr-2\" />\r\n                  <div className=\"text-2xl font-bold text-green-700\">\r\n                    {detailedItem.inventoryItem.current_stock.toLocaleString()}\r\n                  </div>\r\n                </div>\r\n                <p className=\"text-sm font-medium text-green-600\">Current Stock</p>\r\n                <div className=\"mt-2\">\r\n                  <Progress value={75} className=\"h-1.5 bg-green-100\" />\r\n                  <p className=\"text-xs text-green-500 mt-1\">Healthy level</p>\r\n                </div>\r\n              </Card>\r\n            </div>\r\n\r\n            <div className=\"group hover:scale-105 transition-all duration-300\">\r\n              <Card className=\"text-center p-4 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200 shadow-sm hover:shadow-lg transition-all\">\r\n                <div className=\"flex items-center justify-center mb-2\">\r\n                  <CheckCircle className=\"h-5 w-5 text-blue-600 mr-2\" />\r\n                  <div className=\"text-2xl font-bold text-blue-700\">\r\n                    {detailedItem.inventoryItem.available_stock.toLocaleString()}\r\n                  </div>\r\n                </div>\r\n                <p className=\"text-sm font-medium text-blue-600\">Available</p>\r\n                <div className=\"mt-2\">\r\n                  <div className=\"flex justify-between text-xs text-blue-500\">\r\n                    <span>Reserved: {detailedItem.inventoryItem.reserved_stock}</span>\r\n                  </div>\r\n                </div>\r\n              </Card>\r\n            </div>\r\n\r\n            <div className=\"group hover:scale-105 transition-all duration-300\">\r\n              <Card className=\"text-center p-4 bg-gradient-to-br from-purple-50 to-violet-50 border-purple-200 shadow-sm hover:shadow-lg transition-all\">\r\n                <div className=\"flex items-center justify-center mb-2\">\r\n                  <DollarSign className=\"h-5 w-5 text-purple-600 mr-2\" />\r\n                  <div className=\"text-2xl font-bold text-purple-700\">\r\n                    {formatCurrency(detailedItem.inventoryItem.total_value_zar)}\r\n                  </div>\r\n                </div>\r\n                <p className=\"text-sm font-medium text-purple-600\">Total Value</p>\r\n                <div className=\"mt-2\">\r\n                  <div className=\"flex items-center justify-center text-xs text-purple-500\">\r\n                    <TrendingUp className=\"h-3 w-3 mr-1\" />\r\n                    <span>+8% from last month</span>\r\n                  </div>\r\n                </div>\r\n              </Card>\r\n            </div>\r\n\r\n            <div className=\"group hover:scale-105 transition-all duration-300\">\r\n              <Card className=\"text-center p-4 bg-gradient-to-br from-orange-50 to-amber-50 border-orange-200 shadow-sm hover:shadow-lg transition-all\">\r\n                <div className=\"flex items-center justify-center mb-2\">\r\n                  <CalendarIcon className=\"h-5 w-5 text-orange-600 mr-2\" />\r\n                  <div className=\"text-2xl font-bold text-orange-700\">\r\n                    {detailedItem.analytics.daysOnHand}\r\n                  </div>\r\n                </div>\r\n                <p className=\"text-sm font-medium text-orange-600\">Days on Hand</p>\r\n                <div className=\"mt-2\">\r\n                  <div className=\"text-xs text-orange-500\">\r\n                    {detailedItem.analytics.daysOnHand > 90 ? 'Overstocked' :\r\n                     detailedItem.analytics.daysOnHand > 30 ? 'Optimal' : 'Low'}\r\n                  </div>\r\n                </div>\r\n              </Card>\r\n            </div>\r\n\r\n            <div className=\"group hover:scale-105 transition-all duration-300\">\r\n              <Card className=\"text-center p-4 bg-gradient-to-br from-teal-50 to-cyan-50 border-teal-200 shadow-sm hover:shadow-lg transition-all\">\r\n                <div className=\"flex items-center justify-center mb-2\">\r\n                  <Activity className=\"h-5 w-5 text-teal-600 mr-2\" />\r\n                  <div className=\"text-2xl font-bold text-teal-700\">\r\n                    {detailedItem.analytics.stockTurnover}x\r\n                  </div>\r\n                </div>\r\n                <p className=\"text-sm font-medium text-teal-600\">Turnover</p>\r\n                <div className=\"mt-2\">\r\n                  <div className=\"text-xs text-teal-500\">\r\n                    Industry avg: 2.8x\r\n                  </div>\r\n                </div>\r\n              </Card>\r\n            </div>\r\n\r\n            <div className=\"group hover:scale-105 transition-all duration-300\">\r\n              <Card className=\"text-center p-4 bg-gradient-to-br from-red-50 to-pink-50 border-red-200 shadow-sm hover:shadow-lg transition-all\">\r\n                <div className=\"flex items-center justify-center mb-2\">\r\n                  <Target className=\"h-5 w-5 text-red-600 mr-2\" />\r\n                  <div className=\"text-2xl font-bold text-red-700\">\r\n                    {detailedItem.inventoryItem.reorder_point.toLocaleString()}\r\n                  </div>\r\n                </div>\r\n                <p className=\"text-sm font-medium text-red-600\">Reorder Point</p>\r\n                <div className=\"mt-2\">\r\n                  <div className=\"text-xs text-red-500\">\r\n                    {detailedItem.inventoryItem.current_stock <= detailedItem.inventoryItem.reorder_point\r\n                      ? 'Reorder needed'\r\n                      : 'Above threshold'\r\n                    }\r\n                  </div>\r\n                </div>\r\n              </Card>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Enhanced Main Content */}\r\n        <div className=\"p-8 bg-gray-50/50 overflow-y-auto max-h-[60vh]\">\r\n          <Tabs value={activeTab} onValueChange={setActiveTab}>\r\n            <TabsList className=\"grid w-full grid-cols-6 p-1 bg-white shadow-sm border-0 rounded-xl\">\r\n              <TabsTrigger\r\n                value=\"overview\"\r\n                className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500 data-[state=active]:to-purple-500 data-[state=active]:text-white transition-all duration-300 rounded-lg\"\r\n              >\r\n                <Package className=\"h-4 w-4 mr-2\" />\r\n                Overview\r\n              </TabsTrigger>\r\n              <TabsTrigger\r\n                value=\"analytics\"\r\n                className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-green-500 data-[state=active]:to-emerald-500 data-[state=active]:text-white transition-all duration-300 rounded-lg\"\r\n              >\r\n                <BarChart3 className=\"h-4 w-4 mr-2\" />\r\n                Analytics\r\n              </TabsTrigger>\r\n              <TabsTrigger\r\n                value=\"movements\"\r\n                className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-orange-500 data-[state=active]:to-amber-500 data-[state=active]:text-white transition-all duration-300 rounded-lg\"\r\n              >\r\n                <History className=\"h-4 w-4 mr-2\" />\r\n                Movements\r\n              </TabsTrigger>\r\n              <TabsTrigger\r\n                value=\"supplier\"\r\n                className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-500 data-[state=active]:to-blue-500 data-[state=active]:text-white transition-all duration-300 rounded-lg\"\r\n              >\r\n                <Building2 className=\"h-4 w-4 mr-2\" />\r\n                Supplier\r\n              </TabsTrigger>\r\n              <TabsTrigger\r\n                value=\"compliance\"\r\n                className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-purple-500 data-[state=active]:to-violet-500 data-[state=active]:text-white transition-all duration-300 rounded-lg\"\r\n              >\r\n                <Shield className=\"h-4 w-4 mr-2\" />\r\n                Compliance\r\n              </TabsTrigger>\r\n              <TabsTrigger\r\n                value=\"forecasting\"\r\n                className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-teal-500 data-[state=active]:to-cyan-500 data-[state=active]:text-white transition-all duration-300 rounded-lg\"\r\n              >\r\n                <Zap className=\"h-4 w-4 mr-2\" />\r\n                Forecasting\r\n              </TabsTrigger>\r\n            </TabsList>\r\n\r\n            <TabsContent value=\"overview\" className=\"mt-6\">\r\n              <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n                {/* Product Information */}\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <Package className=\"h-5 w-5\" />\r\n                      Product Details\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-4\">\r\n                    <div>\r\n                      <Label className=\"text-sm font-medium text-muted-foreground\">Description</Label>\r\n                      <p className=\"text-sm mt-1\">{detailedItem.product.description}</p>\r\n                    </div>\r\n                    <Separator />\r\n                    <div className=\"grid grid-cols-2 gap-3 text-sm\">\r\n                      <div>\r\n                        <span className=\"text-muted-foreground\">Category:</span>\r\n                        <span className=\"ml-2 font-medium\">\r\n                          {detailedItem.product.category.replace('_', ' ').toUpperCase()}\r\n                        </span>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-muted-foreground\">Brand:</span>\r\n                        <span className=\"ml-2 font-medium\">{detailedItem.product.brand}</span>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-muted-foreground\">Model:</span>\r\n                        <span className=\"ml-2 font-medium\">{detailedItem.product.model_number}</span>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-muted-foreground\">Unit Cost:</span>\r\n                        <span className=\"ml-2 font-medium\">\r\n                          {formatCurrency(detailedItem.product.unit_cost_zar)}\r\n                        </span>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-muted-foreground\">Weight:</span>\r\n                        <span className=\"ml-2 font-medium\">{detailedItem.product.weight_kg} kg</span>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-muted-foreground\">Dimensions:</span>\r\n                        <span className=\"ml-2 font-medium\">{detailedItem.product.dimensions_cm} cm</span>\r\n                      </div>\r\n                    </div>\r\n                    <Separator />\r\n                    <div>\r\n                      <Label className=\"text-sm font-medium text-muted-foreground\">Certifications</Label>\r\n                      <div className=\"flex gap-1 mt-1\">\r\n                        {detailedItem.product.certification_standards?.map((cert, index) => (\r\n                          <Badge key={index} variant=\"outline\" size=\"sm\">{cert}</Badge>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Stock Information */}\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <BarChart3 className=\"h-5 w-5\" />\r\n                      Stock Information\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-4\">\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-muted-foreground\">Current Stock</span>\r\n                        <span className=\"font-medium\">{detailedItem.inventoryItem.current_stock}</span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-muted-foreground\">Reserved</span>\r\n                        <span className=\"font-medium\">{detailedItem.inventoryItem.reserved_stock}</span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-muted-foreground\">Available</span>\r\n                        <span className=\"font-medium text-green-600\">{detailedItem.inventoryItem.available_stock}</span>\r\n                      </div>\r\n                    </div>\r\n                    <Separator />\r\n                    <div>\r\n                      <div className=\"flex justify-between items-center mb-2\">\r\n                        <span className=\"text-sm text-muted-foreground\">Stock Level</span>\r\n                        <span className=\"text-sm font-medium\">\r\n                          {Math.round((detailedItem.inventoryItem.current_stock / detailedItem.inventoryItem.max_stock_level) * 100)}%\r\n                        </span>\r\n                      </div>\r\n                      <Progress\r\n                        value={(detailedItem.inventoryItem.current_stock / detailedItem.inventoryItem.max_stock_level) * 100}\r\n                        className=\"h-2\"\r\n                      />\r\n                      <div className=\"flex justify-between text-xs text-muted-foreground mt-1\">\r\n                        <span>Reorder: {detailedItem.inventoryItem.reorder_point}</span>\r\n                        <span>Max: {detailedItem.inventoryItem.max_stock_level}</span>\r\n                      </div>\r\n                    </div>\r\n                    <Separator />\r\n                    <div className=\"grid grid-cols-2 gap-3 text-sm\">\r\n                      <div>\r\n                        <span className=\"text-muted-foreground\">ABC Class:</span>\r\n                        <Badge variant=\"outline\" className=\"ml-2\">\r\n                          {detailedItem.inventoryItem.abc_classification}\r\n                        </Badge>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-muted-foreground\">Velocity:</span>\r\n                        <Badge variant=\"outline\" className=\"ml-2\">\r\n                          {detailedItem.inventoryItem.velocity_rating}\r\n                        </Badge>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Performance Metrics */}\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <Target className=\"h-5 w-5\" />\r\n                      Performance\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-4\">\r\n                    <div className=\"space-y-3\">\r\n                      {Object.entries(detailedItem.performance).map(([key, value]) => (\r\n                        <div key={key} className=\"space-y-1\">\r\n                          <div className=\"flex justify-between items-center\">\r\n                            <span className=\"text-sm capitalize\">\r\n                              {key.replace(/([A-Z])/g, ' $1').trim()}\r\n                            </span>\r\n                            <span className={`font-medium ${getPerformanceColor(value)}`}>\r\n                              {value}%\r\n                            </span>\r\n                          </div>\r\n                          <Progress value={value} className=\"h-2\" />\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                    <Separator />\r\n                    <div className=\"text-center\">\r\n                      <div className=\"text-2xl font-bold text-green-600\">\r\n                        {Math.round(Object.values(detailedItem.performance).reduce((a, b) => a + b, 0) / 4)}\r\n                      </div>\r\n                      <p className=\"text-sm text-muted-foreground\">Overall Score</p>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n\r\n              {/* Stock Level Trend */}\r\n              <Card className=\"mt-6\">\r\n                <CardHeader>\r\n                  <CardTitle>Stock Level Trend (Last 30 Days)</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <ResponsiveContainer width=\"100%\" height={300}>\r\n                    <AreaChart data={stockLevelsData}>\r\n                      <defs>\r\n                        <linearGradient id=\"colorStock\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                          <stop offset=\"5%\" stopColor=\"#3B82F6\" stopOpacity={0.8}/>\r\n                          <stop offset=\"95%\" stopColor=\"#3B82F6\" stopOpacity={0}/>\r\n                        </linearGradient>\r\n                      </defs>\r\n                      <XAxis\r\n                        dataKey=\"date\"\r\n                        tickFormatter={(value) => format(new Date(value), 'MMM dd')}\r\n                      />\r\n                      <YAxis />\r\n                      <CartesianGrid strokeDasharray=\"3 3\" />\r\n                      <Tooltip\r\n                        labelFormatter={(value) => format(new Date(value), 'MMM dd, yyyy')}\r\n                      />\r\n                      <Area\r\n                        type=\"monotone\"\r\n                        dataKey=\"stock\"\r\n                        stroke=\"#3B82F6\"\r\n                        fillOpacity={1}\r\n                        fill=\"url(#colorStock)\"\r\n                      />\r\n                      <Line\r\n                        type=\"monotone\"\r\n                        dataKey=\"reorderPoint\"\r\n                        stroke=\"#F59E0B\"\r\n                        strokeDasharray=\"5 5\"\r\n                        dot={false}\r\n                      />\r\n                    </AreaChart>\r\n                  </ResponsiveContainer>\r\n                </CardContent>\r\n              </Card>\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"analytics\" className=\"mt-6\">\r\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                {/* Movement Analysis */}\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle>Stock Movement Analysis</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <ResponsiveContainer width=\"100%\" height={300}>\r\n                      <BarChart data={movementData}>\r\n                        <CartesianGrid strokeDasharray=\"3 3\" />\r\n                        <XAxis dataKey=\"month\" />\r\n                        <YAxis />\r\n                        <Tooltip />\r\n                        <Bar dataKey=\"receipts\" fill=\"#10B981\" name=\"Receipts\" />\r\n                        <Bar dataKey=\"issues\" fill=\"#EF4444\" name=\"Issues\" />\r\n                      </BarChart>\r\n                    </ResponsiveContainer>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Cost Analysis */}\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle>Cost Trend Analysis</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <ResponsiveContainer width=\"100%\" height={300}>\r\n                      <LineChart data={costAnalysisData}>\r\n                        <CartesianGrid strokeDasharray=\"3 3\" />\r\n                        <XAxis dataKey=\"month\" />\r\n                        <YAxis tickFormatter={(value) => `R${value}`} />\r\n                        <Tooltip formatter={(value) => [formatCurrency(value as number), 'Unit Cost']} />\r\n                        <Line\r\n                          type=\"monotone\"\r\n                          dataKey=\"cost\"\r\n                          stroke=\"#3B82F6\"\r\n                          strokeWidth={2}\r\n                          dot={{ r: 4 }}\r\n                        />\r\n                      </LineChart>\r\n                    </ResponsiveContainer>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Analytics Summary */}\r\n                <Card className=\"lg:col-span-2\">\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <Activity className=\"h-5 w-5\" />\r\n                      Analytics Summary\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-6\">\r\n                      <div className=\"text-center\">\r\n                        <div className=\"flex items-center justify-center gap-1 text-2xl font-bold\">\r\n                          {detailedItem.analytics.averageMonthlyUsage}\r\n                          {getTrendIcon(detailedItem.analytics.demandTrend)}\r\n                        </div>\r\n                        <p className=\"text-sm text-muted-foreground\">Avg Monthly Usage</p>\r\n                      </div>\r\n                      <div className=\"text-center\">\r\n                        <div className=\"flex items-center justify-center gap-1 text-2xl font-bold\">\r\n                          {detailedItem.analytics.stockTurnover}x\r\n                          {getTrendIcon('up')}\r\n                        </div>\r\n                        <p className=\"text-sm text-muted-foreground\">Stock Turnover</p>\r\n                      </div>\r\n                      <div className=\"text-center\">\r\n                        <div className=\"text-2xl font-bold\">\r\n                          {detailedItem.analytics.reorderFrequency}\r\n                        </div>\r\n                        <p className=\"text-sm text-muted-foreground\">Reorders/Year</p>\r\n                      </div>\r\n                      <div className=\"text-center\">\r\n                        <div className=\"flex items-center justify-center gap-1 text-2xl font-bold\">\r\n                          {formatCurrency(detailedItem.product.unit_cost_zar)}\r\n                          {getTrendIcon(detailedItem.analytics.costTrend)}\r\n                        </div>\r\n                        <p className=\"text-sm text-muted-foreground\">Current Unit Cost</p>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"movements\" className=\"mt-6\">\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <History className=\"h-5 w-5\" />\r\n                    Stock Movement History\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <Table>\r\n                    <TableHeader>\r\n                      <TableRow>\r\n                        <TableHead>Date</TableHead>\r\n                        <TableHead>Type</TableHead>\r\n                        <TableHead>Quantity</TableHead>\r\n                        <TableHead>Unit Cost</TableHead>\r\n                        <TableHead>Total Value</TableHead>\r\n                        <TableHead>Reference</TableHead>\r\n                        <TableHead>Notes</TableHead>\r\n                      </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                      {detailedItem.movements.map((movement) => (\r\n                        <TableRow key={movement.id}>\r\n                          <TableCell>\r\n                            {format(new Date(movement.created_at), 'MMM dd, yyyy HH:mm')}\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            <Badge\r\n                              variant={movement.movement_type === 'receipt' ? 'default' : 'destructive'}\r\n                            >\r\n                              {movement.movement_type}\r\n                            </Badge>\r\n                          </TableCell>\r\n                          <TableCell className={movement.quantity > 0 ? 'text-green-600' : 'text-red-600'}>\r\n                            {movement.quantity > 0 ? '+' : ''}{movement.quantity}\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            {movement.unit_cost_zar ? formatCurrency(movement.unit_cost_zar) : '-'}\r\n                          </TableCell>\r\n                          <TableCell className={movement.quantity > 0 ? 'text-green-600' : 'text-red-600'}>\r\n                            {movement.total_value_zar ? formatCurrency(movement.total_value_zar) : '-'}\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            <code className=\"text-sm\">{movement.reference_document}</code>\r\n                          </TableCell>\r\n                          <TableCell className=\"text-sm text-muted-foreground\">\r\n                            {movement.notes}\r\n                          </TableCell>\r\n                        </TableRow>\r\n                      ))}\r\n                    </TableBody>\r\n                  </Table>\r\n                </CardContent>\r\n              </Card>\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"supplier\" className=\"mt-6\">\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Building2 className=\"h-5 w-5\" />\r\n                    Supplier Information\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                    <div className=\"space-y-4\">\r\n                      <div>\r\n                        <h3 className=\"font-medium text-lg\">{detailedItem.supplier.name}</h3>\r\n                        <div className=\"flex items-center gap-2 mt-1\">\r\n                          <Badge variant=\"default\" className=\"bg-green-100 text-green-800\">\r\n                            {detailedItem.supplier.status.toUpperCase()}\r\n                          </Badge>\r\n                          <Badge variant=\"outline\" className=\"border-yellow-500 text-yellow-700\">\r\n                            {detailedItem.supplier.performance_tier.toUpperCase()}\r\n                          </Badge>\r\n                          {detailedItem.supplier.preferred_supplier && (\r\n                            <Badge variant=\"outline\" className=\"border-blue-500 text-blue-700\">\r\n                              <Star className=\"h-3 w-3 mr-1\" />\r\n                              PREFERRED\r\n                            </Badge>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                      <Separator />\r\n                      <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                        <div>\r\n                          <span className=\"text-muted-foreground\">Email:</span>\r\n                          <p className=\"font-medium\">{detailedItem.supplier.email}</p>\r\n                        </div>\r\n                        <div>\r\n                          <span className=\"text-muted-foreground\">Phone:</span>\r\n                          <p className=\"font-medium\">{detailedItem.supplier.phone}</p>\r\n                        </div>\r\n                        <div>\r\n                          <span className=\"text-muted-foreground\">Lead Time:</span>\r\n                          <p className=\"font-medium\">{detailedItem.product.lead_time_days} days</p>\r\n                        </div>\r\n                        <div>\r\n                          <span className=\"text-muted-foreground\">Min Order:</span>\r\n                          <p className=\"font-medium\">{detailedItem.product.minimum_order_quantity}</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"space-y-4\">\r\n                      <h4 className=\"font-medium\">Performance Metrics</h4>\r\n                      <div className=\"space-y-3\">\r\n                        <div>\r\n                          <div className=\"flex justify-between items-center\">\r\n                            <span className=\"text-sm\">Quality Rating</span>\r\n                            <span className=\"font-medium text-green-600\">\r\n                              {detailedItem.supplier.quality_rating}/10\r\n                            </span>\r\n                          </div>\r\n                          <Progress value={(detailedItem.supplier.quality_rating || 0) * 10} className=\"h-2\" />\r\n                        </div>\r\n                        <div>\r\n                          <div className=\"flex justify-between items-center\">\r\n                            <span className=\"text-sm\">Delivery Performance</span>\r\n                            <span className=\"font-medium text-green-600\">\r\n                              {detailedItem.supplier.delivery_performance_score}%\r\n                            </span>\r\n                          </div>\r\n                          <Progress value={detailedItem.supplier.delivery_performance_score || 0} className=\"h-2\" />\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"compliance\" className=\"mt-6\">\r\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <CheckCircle className=\"h-5 w-5\" />\r\n                      Tracking Requirements\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-4\">\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        {detailedItem.compliance.expiryTracking ? (\r\n                          <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n                        ) : (\r\n                          <XCircle className=\"h-4 w-4 text-gray-400\" />\r\n                        )}\r\n                        <span className=\"text-sm\">Expiry Tracking</span>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        {detailedItem.compliance.batchTracking ? (\r\n                          <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n                        ) : (\r\n                          <XCircle className=\"h-4 w-4 text-gray-400\" />\r\n                        )}\r\n                        <span className=\"text-sm\">Batch Tracking</span>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        {detailedItem.compliance.serialTracking ? (\r\n                          <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n                        ) : (\r\n                          <XCircle className=\"h-4 w-4 text-gray-400\" />\r\n                        )}\r\n                        <span className=\"text-sm\">Serial Tracking</span>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <FileText className=\"h-5 w-5\" />\r\n                      Certifications & Compliance\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-4\">\r\n                    <div>\r\n                      <Label className=\"text-sm font-medium text-muted-foreground\">Certifications</Label>\r\n                      <div className=\"flex gap-1 mt-1\">\r\n                        {detailedItem.compliance.certifications.map((cert, index) => (\r\n                          <Badge key={index} variant=\"outline\">{cert}</Badge>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                    <div>\r\n                      <Label className=\"text-sm font-medium text-muted-foreground\">Regulatory Requirements</Label>\r\n                      <div className=\"flex gap-1 mt-1\">\r\n                        {detailedItem.compliance.regulatoryRequirements.map((req, index) => (\r\n                          <Badge key={index} variant=\"secondary\">{req}</Badge>\r\n                        ))}\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n            </TabsContent>\r\n\r\n            <TabsContent value=\"forecasting\" className=\"mt-6\">\r\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <Zap className=\"h-5 w-5\" />\r\n                      Forecasting & Recommendations\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-4\">\r\n                    <div className=\"space-y-3\">\r\n                      <div>\r\n                        <span className=\"text-sm text-muted-foreground\">Predicted Stockout:</span>\r\n                        <p className=\"font-medium text-orange-600\">\r\n                          {detailedItem.forecasting.predictedStockout ?\r\n                            format(new Date(detailedItem.forecasting.predictedStockout), 'MMM dd, yyyy') :\r\n                            'Not predicted'\r\n                          }\r\n                        </p>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-sm text-muted-foreground\">Recommended Reorder:</span>\r\n                        <p className=\"font-medium\">{detailedItem.forecasting.recommendedReorder} units</p>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-sm text-muted-foreground\">Economic Order Qty:</span>\r\n                        <p className=\"font-medium\">{detailedItem.forecasting.economicOrderQuantity} units</p>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-sm text-muted-foreground\">Safety Stock Level:</span>\r\n                        <p className=\"font-medium\">{detailedItem.forecasting.safetyStockLevel} units</p>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle>Reorder Recommendation</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"bg-orange-50 border border-orange-200 rounded-lg p-4\">\r\n                      <div className=\"flex items-center gap-2 mb-2\">\r\n                        <AlertTriangle className=\"h-5 w-5 text-orange-600\" />\r\n                        <span className=\"font-medium text-orange-800\">Reorder Recommended</span>\r\n                      </div>\r\n                      <p className=\"text-sm text-orange-700 mb-3\">\r\n                        Based on current usage patterns and lead time, recommend reordering soon.\r\n                      </p>\r\n                      <div className=\"space-y-2 text-sm\">\r\n                        <div className=\"flex justify-between\">\r\n                          <span>Suggested quantity:</span>\r\n                          <span className=\"font-medium\">{detailedItem.forecasting.recommendedReorder} units</span>\r\n                        </div>\r\n                        <div className=\"flex justify-between\">\r\n                          <span>Estimated cost:</span>\r\n                          <span className=\"font-medium\">\r\n                            {formatCurrency(detailedItem.forecasting.recommendedReorder * detailedItem.product.unit_cost_zar)}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                      <Button className=\"w-full mt-4\" size=\"sm\">\r\n                        <ShoppingCart className=\"h-4 w-4 mr-2\" />\r\n                        Create Purchase Order\r\n                      </Button>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n            </TabsContent>\r\n          </Tabs>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction Label({ children, className }: { children: React.ReactNode, className?: string }) {\r\n  return (\r\n    <label className={cn(\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\", className)}>\r\n      {children}\r\n    </label>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\inventory\\InventoryManagement.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'KeyboardEvent' is not defined.","line":208,"column":32,"nodeType":"Identifier","messageId":"undef","endLine":208,"endColumn":45},{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":382,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":382,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":407,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":407,"endColumn":17},{"ruleId":"jsx-a11y/no-autofocus","severity":2,"message":"The autoFocus prop should not be used, as it can reduce usability and accessibility for users.","line":1101,"column":39,"nodeType":"JSXAttribute","endLine":1101,"endColumn":48},{"ruleId":"jsx-a11y/no-noninteractive-element-interactions","severity":2,"message":"Non-interactive elements should not be assigned mouse or keyboard event listeners.","line":1116,"column":41,"nodeType":"JSXOpeningElement","endLine":1119,"endColumn":42}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useEffect, useState, useCallback, useMemo, useRef } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Checkbox } from '@/components/ui/checkbox'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Skeleton } from '@/components/ui/skeleton'\r\nimport { cn } from '@/lib/utils'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n  DropdownMenuCheckboxItem,\r\n} from '@/components/ui/dropdown-menu'\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from '@/components/ui/tooltip'\r\nimport {\r\n  Command,\r\n  CommandEmpty,\r\n  CommandGroup,\r\n  CommandInput,\r\n  CommandItem,\r\n  CommandList,\r\n} from '@/components/ui/command'\r\nimport {\r\n  Search,\r\n  Filter,\r\n  Plus,\r\n  Edit,\r\n  Trash2,\r\n  MoreHorizontal,\r\n  Eye,\r\n  Package,\r\n  AlertTriangle,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  BarChart3,\r\n  Download,\r\n  Upload,\r\n  RefreshCw,\r\n  SlidersHorizontal,\r\n  X,\r\n  Columns3,\r\n  DollarSign,\r\n  AlertCircle,\r\n  CheckCircle2,\r\n  Activity,\r\n  ArrowUpDown,\r\n  ChevronLeft,\r\n  ChevronRight,\r\n} from 'lucide-react'\r\nimport { useInventoryStore } from '@/lib/stores/inventory-store'\r\nimport { useSupplierStore } from '@/lib/stores/supplier-store'\r\nimport { useNotificationStore } from '@/lib/stores/notification-store'\r\nimport type { InventoryItem, Product, Supplier, InventoryFilters } from '@/lib/types/inventory'\r\nimport { format } from 'date-fns'\r\nimport { deriveStockStatus } from '@/lib/utils/inventory-metrics'\r\nimport AddProductDialog from './AddProductDialog'\r\nimport AddProductsModeDialog from './AddProductsModeDialog'\r\nimport MultiProductSelectorDialog from './MultiProductSelectorDialog'\r\nimport EditProductDialog from './EditProductDialog'\r\nimport StockAdjustmentDialog from './StockAdjustmentDialog'\r\nimport ProductDetailsDialog from './ProductDetailsDialog'\r\n\r\n// Column visibility state type\r\ntype ColumnVisibility = {\r\n  sku: boolean\r\n  supplier: boolean\r\n  category: boolean\r\n  location: boolean\r\n  stock: boolean\r\n  value: boolean\r\n  status: boolean\r\n}\r\n\r\nexport default function InventoryManagement() {\r\n  const {\r\n    items,\r\n    products,\r\n    suppliers,\r\n    filters,\r\n    loading,\r\n    error,\r\n    fetchItems,\r\n    fetchProducts,\r\n    fetchSuppliers,\r\n    setFilters,\r\n    clearFilters,\r\n    deleteProduct,\r\n    clearError\r\n  } = useInventoryStore()\r\n\r\n  const { addNotification } = useNotificationStore()\r\n\r\n  // State\r\n  const [searchTerm, setSearchTerm] = useState(filters.search || '')\r\n  const [showFilters, setShowFilters] = useState(false)\r\n  const [selectedItems, setSelectedItems] = useState<Set<string>>(new Set())\r\n  const [showAddProduct, setShowAddProduct] = useState(false)\r\n  const [showAddMode, setShowAddMode] = useState(false)\r\n  const [showMultiSelect, setShowMultiSelect] = useState(false)\r\n  const [editingProduct, setEditingProduct] = useState<Product | null>(null)\r\n  const [adjustingStock, setAdjustingStock] = useState<InventoryItem | null>(null)\r\n  const [viewingProduct, setViewingProduct] = useState<Product | null>(null)\r\n\r\n  // New features state\r\n  const [searchSuggestions, setSearchSuggestions] = useState<any[]>([])\r\n  const [showSearchSuggestions, setShowSearchSuggestions] = useState(false)\r\n  const [columnVisibility, setColumnVisibility] = useState<ColumnVisibility>({\r\n    sku: true,\r\n    supplier: true,\r\n    category: true,\r\n    location: true,\r\n    stock: true,\r\n    value: true,\r\n    status: true,\r\n  })\r\n  const [priceFilter, setPriceFilter] = useState({ min: '', max: '' })\r\n  const [stockLevelFilter, setStockLevelFilter] = useState<string>('all')\r\n  const [pagination, setPagination] = useState({ page: 1, pageSize: 25 })\r\n  const [quickEditingStock, setQuickEditingStock] = useState<string | null>(null)\r\n  const [stockMovements, setStockMovements] = useState<Record<string, any[]>>({})\r\n\r\n  const searchInputRef = useRef<HTMLInputElement>(null)\r\n\r\n  const loadData = useCallback(async () => {\r\n    try {\r\n      await Promise.all([\r\n        fetchItems(),\r\n        fetchProducts(),\r\n        fetchSuppliers()\r\n      ])\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to load inventory data',\r\n        message: error instanceof Error ? error.message : 'Unknown error occurred'\r\n      })\r\n    }\r\n  }, [fetchItems, fetchProducts, fetchSuppliers, addNotification])\r\n\r\n  useEffect(() => {\r\n    loadData()\r\n  }, [loadData])\r\n\r\n  // Debounced search\r\n  useEffect(() => {\r\n    const debounceTimer = setTimeout(() => {\r\n      setFilters({ search: searchTerm })\r\n    }, 500)\r\n\r\n    return () => clearTimeout(debounceTimer)\r\n  }, [searchTerm, setFilters])\r\n\r\n  // Search suggestions\r\n  useEffect(() => {\r\n    if (searchTerm.length >= 2) {\r\n      const suggestions = [...products, ...items]\r\n        .filter(item => {\r\n          const name = 'name' in item ? item.name : (item as any).product?.name\r\n          const sku = 'sku' in item ? item.sku : (item as any).product?.sku\r\n          return name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n                 sku?.toLowerCase().includes(searchTerm.toLowerCase())\r\n        })\r\n        .slice(0, 5)\r\n      setSearchSuggestions(suggestions)\r\n      setShowSearchSuggestions(true)\r\n    } else {\r\n      setShowSearchSuggestions(false)\r\n    }\r\n  }, [searchTerm, products, items])\r\n\r\n  // Keyboard shortcuts\r\n  useEffect(() => {\r\n    const handleKeyPress = (e: KeyboardEvent) => {\r\n      if (e.ctrlKey || e.metaKey) {\r\n        switch(e.key) {\r\n          case 'k': // Ctrl+K for search\r\n            e.preventDefault()\r\n            searchInputRef.current?.focus()\r\n            break\r\n          case 'n': // Ctrl+N for new product\r\n            e.preventDefault()\r\n            setShowAddMode(true)\r\n            break\r\n          case 'e': // Ctrl+E for export\r\n            e.preventDefault()\r\n            handleExport()\r\n            break\r\n        }\r\n      }\r\n    }\r\n\r\n    window.addEventListener('keydown', handleKeyPress)\r\n    return () => window.removeEventListener('keydown', handleKeyPress)\r\n  }, [])\r\n\r\n  // Debug logging for investigating item count\r\n  useEffect(() => {\r\n    console.log('[Inventory Debug] Raw items count:', items.length)\r\n    console.log('[Inventory Debug] Products count:', products.length)\r\n    console.log('[Inventory Debug] Suppliers count:', suppliers.length)\r\n    console.log('[Inventory Debug] Active filters:', filters)\r\n    console.log('[Inventory Debug] Sample item:', items[0])\r\n  }, [items, products, suppliers, filters])\r\n\r\n  const formatCurrency = (amount: number | string | null | undefined) => {\r\n    const value = Number(amount)\r\n    return new Intl.NumberFormat('en-ZA', {\r\n      style: 'currency',\r\n      currency: 'ZAR',\r\n      minimumFractionDigits: 0,\r\n      maximumFractionDigits: 2\r\n    }).format(Number.isFinite(value) ? value : 0)\r\n  }\r\n\r\n  const getStockStatusColor = (status: string, currentStock: number, reorderPoint: number) => {\r\n    if (currentStock === 0) return 'destructive'\r\n    if (currentStock <= reorderPoint) return 'secondary'\r\n    if (status === 'overstocked') return 'outline'\r\n    return 'default'\r\n  }\r\n\r\n  const getStockStatusLabel = (item: InventoryItem) => {\r\n    if (item.current_stock === 0) return 'Out of Stock'\r\n    if (item.current_stock <= item.reorder_point) return 'Low Stock'\r\n    if (item.stock_status === 'overstocked') return 'Overstocked'\r\n    return 'In Stock'\r\n  }\r\n\r\n  const getStockStatusBadgeColor = (status: string) => {\r\n    switch (status) {\r\n      case 'in_stock':\r\n        return 'bg-green-100 text-green-800 border-green-200 hover:bg-green-100'\r\n      case 'low_stock':\r\n        return 'bg-yellow-100 text-yellow-800 border-yellow-200 hover:bg-yellow-100'\r\n      case 'out_of_stock':\r\n        return 'bg-red-100 text-red-800 border-red-200 hover:bg-red-100'\r\n      case 'overstocked':\r\n        return 'bg-blue-100 text-blue-800 border-blue-200 hover:bg-blue-100'\r\n      default:\r\n        return 'bg-gray-100 text-gray-800 border-gray-200 hover:bg-gray-100'\r\n    }\r\n  }\r\n\r\n  // Enhanced data enrichment - FIX #1 & #2\r\n  const enrichedItems = useMemo(() => {\r\n    return items.map((item) => {\r\n      const matchedProduct = products.find((p) => p.id === item.product_id)\r\n      const baseProduct = matchedProduct || item.product || {\r\n        id: item.product_id || item.id,\r\n        supplier_id: item.supplier?.id ?? item.supplier_id ?? null,\r\n        name: item.product?.name || item.name || 'Unknown Product',\r\n        description: item.product?.description || item.description || '',\r\n        category: item.product?.category || item.category || 'Uncategorized',\r\n        sku: item.product?.sku || item.sku || item.supplier_sku || '-',\r\n        unit_of_measure: item.product?.unit_of_measure || item.unit || 'each',\r\n        status: item.status || 'active',\r\n        unit_cost_zar: Number(item.cost_per_unit_zar ?? item.cost_price ?? 0),\r\n        unit_price_zar: Number(item.sale_price ?? 0),\r\n      } as Product\r\n\r\n      const matchedSupplier = suppliers.find((s) => s.id === baseProduct.supplier_id)\r\n      const baseSupplier = matchedSupplier || item.supplier || (item.supplier_name\r\n        ? ({ id: item.supplier?.id ?? item.supplier_id ?? 'unknown', name: item.supplier_name, status: item.supplier_status || 'unknown' } as Supplier)\r\n        : undefined)\r\n\r\n      const normalizedCost = Number(item.cost_per_unit_zar ?? item.cost_price ?? baseProduct.unit_cost_zar ?? 0)\r\n      const normalizedStock = Number(item.current_stock ?? item.currentStock ?? item.stock_qty ?? 0)\r\n      const normalizedValue = Number(item.total_value_zar ?? item.totalValueZar ?? item.totalValue ?? (normalizedStock * normalizedCost))\r\n\r\n      return {\r\n        ...item,\r\n        product: baseProduct,\r\n        supplier: baseSupplier,\r\n        cost_per_unit_zar: normalizedCost,\r\n        total_value_zar: normalizedValue,\r\n        current_stock: normalizedStock,\r\n        supplier_name: baseSupplier?.name || item.supplier_name || 'Unknown Supplier',\r\n        supplier_status: baseSupplier?.status || item.supplier_status || 'inactive',\r\n        stock_status: item.stock_status || deriveStockStatus(normalizedStock, Number(item.reorder_point || 0), Number(item.max_stock_level || 0)),\r\n        currency: item.currency || 'ZAR',\r\n      }\r\n    })\r\n  }, [items, products, suppliers])\r\n\r\n  // Apply filters - FIX #3\r\n  const filteredItems = useMemo(() => {\r\n    let result = enrichedItems\r\n\r\n    // Price filter\r\n    if (priceFilter.min || priceFilter.max) {\r\n      result = result.filter(item => {\r\n        const price = item.cost_per_unit_zar || 0\r\n        const min = parseFloat(priceFilter.min) || 0\r\n        const max = parseFloat(priceFilter.max) || Infinity\r\n        return price >= min && price <= max\r\n      })\r\n    }\r\n\r\n    // Stock level filter\r\n    if (stockLevelFilter !== 'all') {\r\n      result = result.filter(item => {\r\n        switch (stockLevelFilter) {\r\n          case 'critical':\r\n            return item.current_stock < 10\r\n          case 'low':\r\n            return item.current_stock <= item.reorder_point\r\n          case 'adequate':\r\n            return item.current_stock > item.reorder_point && item.current_stock < item.max_stock_level\r\n          case 'overstocked':\r\n            return item.current_stock >= item.max_stock_level\r\n          default:\r\n            return true\r\n        }\r\n      })\r\n    }\r\n\r\n    console.log('[Filter Debug] Filtered items count:', result.length)\r\n    return result\r\n  }, [enrichedItems, priceFilter, stockLevelFilter])\r\n\r\n  // Pagination\r\n  const paginatedItems = useMemo(() => {\r\n    const start = (pagination.page - 1) * pagination.pageSize\r\n    const end = start + pagination.pageSize\r\n    return filteredItems.slice(start, end)\r\n  }, [filteredItems, pagination])\r\n\r\n  const totalPages = Math.ceil(filteredItems.length / pagination.pageSize)\r\n\r\n  // Calculate stats\r\n  const stats = useMemo(() => {\r\n    const totalValue = filteredItems.reduce((sum, item) => sum + (item.total_value_zar || 0), 0)\r\n    const lowStockCount = filteredItems.filter(item => item.current_stock <= item.reorder_point).length\r\n    const outOfStockCount = filteredItems.filter(item => item.current_stock === 0).length\r\n    const criticalStockCount = filteredItems.filter(item => item.current_stock < 10 && item.current_stock > 0).length\r\n\r\n    return {\r\n      totalValue,\r\n      lowStockCount,\r\n      outOfStockCount,\r\n      criticalStockCount,\r\n      totalItems: filteredItems.length\r\n    }\r\n  }, [filteredItems])\r\n\r\n  const handleDeleteProduct = async (productId: string) => {\r\n    if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {\r\n      return\r\n    }\r\n\r\n    try {\r\n      await deleteProduct(productId)\r\n      await fetchItems() // Refresh the list\r\n      addNotification({\r\n        type: 'success',\r\n        title: 'Product deleted',\r\n        message: 'Product has been successfully deleted'\r\n      })\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to delete product',\r\n        message: error instanceof Error ? error.message : 'Unknown error occurred'\r\n      })\r\n    }\r\n  }\r\n\r\n  // Bulk delete\r\n  const handleBulkDelete = async () => {\r\n    if (selectedItems.size === 0) return\r\n\r\n    if (!confirm(`Are you sure you want to delete ${selectedItems.size} products? This action cannot be undone.`)) {\r\n      return\r\n    }\r\n\r\n    try {\r\n      await Promise.all(\r\n        Array.from(selectedItems).map(id => deleteProduct(id))\r\n      )\r\n\r\n      await fetchItems() // Refresh the list\r\n\r\n      addNotification({\r\n        type: 'success',\r\n        title: 'Products deleted',\r\n        message: `Successfully deleted ${selectedItems.size} products`\r\n      })\r\n\r\n      setSelectedItems(new Set())\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to delete products',\r\n        message: error instanceof Error ? error.message : 'Unknown error occurred'\r\n      })\r\n    }\r\n  }\r\n\r\n  // Export functionality\r\n  const handleExport = useCallback(() => {\r\n    const exportData = enrichedItems.map(item => ({\r\n      SKU: item.product?.sku || '-',\r\n      Product: item.product?.name || 'Unknown Product',\r\n      Supplier: item.supplier_name || 'Unknown',\r\n      'Supplier Status': item.supplier_status || 'unknown',\r\n      Category: item.product?.category || 'Uncategorized',\r\n      Location: item.location || '-',\r\n      'Current Stock': item.current_stock || 0,\r\n      'Unit of Measure': item.product?.unit_of_measure || 'each',\r\n      'Reorder Point': item.reorder_point || 0,\r\n      'Unit Cost': item.cost_per_unit_zar || 0,\r\n      'Total Value': item.total_value_zar || 0,\r\n      Status: item.stock_status || '-',\r\n      Currency: item.currency || 'ZAR',\r\n    }))\r\n\r\n    const csv = [\r\n      Object.keys(exportData[0]).join(','),\r\n      ...exportData.map(row => Object.values(row).map(val =>\r\n        typeof val === 'string' && val.includes(',') ? `\"${val}\"` : val\r\n      ).join(','))\r\n    ].join('\\n')\r\n\r\n    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })\r\n    const url = URL.createObjectURL(blob)\r\n    const a = document.createElement('a')\r\n    a.href = url\r\n    a.download = `inventory-export-${new Date().toISOString().split('T')[0]}.csv`\r\n    document.body.appendChild(a)\r\n    a.click()\r\n    document.body.removeChild(a)\r\n    URL.revokeObjectURL(url)\r\n\r\n    addNotification({\r\n      type: 'success',\r\n      title: 'Export complete',\r\n      message: `Exported ${exportData.length} items to CSV`\r\n    })\r\n  }, [enrichedItems, addNotification])\r\n\r\n  // Export selected items\r\n  const handleExportSelected = useCallback(() => {\r\n    const selectedItemsData = enrichedItems.filter(item => selectedItems.has(item.id))\r\n\r\n    const exportData = selectedItemsData.map(item => ({\r\n      SKU: item.product?.sku || '-',\r\n      Product: item.product?.name || 'Unknown Product',\r\n      Supplier: item.supplier_name || 'Unknown',\r\n      Category: item.product?.category || 'Uncategorized',\r\n      Location: item.location || '-',\r\n      'Current Stock': item.current_stock || 0,\r\n      'Unit Cost': item.cost_per_unit_zar || 0,\r\n      'Total Value': item.total_value_zar || 0,\r\n      Status: item.stock_status || '-',\r\n    }))\r\n\r\n    const csv = [\r\n      Object.keys(exportData[0]).join(','),\r\n      ...exportData.map(row => Object.values(row).map(val =>\r\n        typeof val === 'string' && val.includes(',') ? `\"${val}\"` : val\r\n      ).join(','))\r\n    ].join('\\n')\r\n\r\n    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })\r\n    const url = URL.createObjectURL(blob)\r\n    const a = document.createElement('a')\r\n    a.href = url\r\n    a.download = `inventory-selected-${new Date().toISOString().split('T')[0]}.csv`\r\n    document.body.appendChild(a)\r\n    a.click()\r\n    document.body.removeChild(a)\r\n    URL.revokeObjectURL(url)\r\n\r\n    addNotification({\r\n      type: 'success',\r\n      title: 'Export complete',\r\n      message: `Exported ${exportData.length} selected items to CSV`\r\n    })\r\n  }, [enrichedItems, selectedItems, addNotification])\r\n\r\n  // Quick stock update\r\n  const handleQuickStockUpdate = async (itemId: string, newStock: string) => {\r\n    const stockValue = parseInt(newStock, 10)\r\n    if (isNaN(stockValue) || stockValue < 0) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Invalid stock value',\r\n        message: 'Please enter a valid positive number'\r\n      })\r\n      return\r\n    }\r\n\r\n    try {\r\n      // TODO: Implement actual API call to update stock\r\n      // await updateItemStock(itemId, stockValue)\r\n\r\n      addNotification({\r\n        type: 'success',\r\n        title: 'Stock updated',\r\n        message: `Stock level updated to ${stockValue}`\r\n      })\r\n\r\n      setQuickEditingStock(null)\r\n      loadData()\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to update stock',\r\n        message: error instanceof Error ? error.message : 'Unknown error occurred'\r\n      })\r\n    }\r\n  }\r\n\r\n  const categories = [...new Set(products.map(p => p.category))].sort()\r\n  const locations = [...new Set(items.map(i => i.location).filter(Boolean))].sort()\r\n  const stockStatuses = ['in_stock', 'low_stock', 'out_of_stock', 'overstocked']\r\n  const abcClassifications = ['A', 'B', 'C']\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <div className=\"space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold tracking-tight\">Inventory Management</h1>\r\n            <p className=\"text-muted-foreground\">\r\n              Manage your inventory items, products, and stock levels\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={loadData}\r\n              disabled={loading}\r\n            >\r\n              <RefreshCw className={cn(\"h-4 w-4 mr-2\", loading && \"animate-spin\")} />\r\n              Refresh\r\n            </Button>\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={handleExport}\r\n              title=\"Export all items (Ctrl+E)\"\r\n            >\r\n              <Download className=\"h-4 w-4 mr-2\" />\r\n              Export\r\n            </Button>\r\n            <DropdownMenu>\r\n              <DropdownMenuTrigger asChild>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <Columns3 className=\"h-4 w-4 mr-2\" />\r\n                  Columns\r\n                </Button>\r\n              </DropdownMenuTrigger>\r\n              <DropdownMenuContent align=\"end\">\r\n                <DropdownMenuLabel>Toggle columns</DropdownMenuLabel>\r\n                <DropdownMenuSeparator />\r\n                {Object.entries(columnVisibility).map(([key, visible]) => (\r\n                  <DropdownMenuCheckboxItem\r\n                    key={key}\r\n                    checked={visible}\r\n                    onCheckedChange={(checked) =>\r\n                      setColumnVisibility(prev => ({ ...prev, [key]: checked }))\r\n                    }\r\n                  >\r\n                    {key.charAt(0).toUpperCase() + key.slice(1)}\r\n                  </DropdownMenuCheckboxItem>\r\n                ))}\r\n              </DropdownMenuContent>\r\n            </DropdownMenu>\r\n            <Button\r\n              onClick={() => setShowAddMode(true)}\r\n              size=\"sm\"\r\n              title=\"Add new product (Ctrl+N)\"\r\n            >\r\n              <Plus className=\"h-4 w-4 mr-2\" />\r\n              Add Product\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Stats Cards */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n          <Card>\r\n            <CardContent className=\"pt-6\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-muted-foreground\">Total Value</p>\r\n                  <p className=\"text-2xl font-bold\">{formatCurrency(stats.totalValue)}</p>\r\n                  <p className=\"text-xs text-muted-foreground mt-1\">{stats.totalItems} items</p>\r\n                </div>\r\n                <DollarSign className=\"h-8 w-8 text-green-600\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardContent className=\"pt-6\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-muted-foreground\">Low Stock Items</p>\r\n                  <p className=\"text-2xl font-bold text-yellow-600\">{stats.lowStockCount}</p>\r\n                  <p className=\"text-xs text-muted-foreground mt-1\">Need reordering</p>\r\n                </div>\r\n                <AlertTriangle className=\"h-8 w-8 text-yellow-600\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardContent className=\"pt-6\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-muted-foreground\">Out of Stock</p>\r\n                  <p className=\"text-2xl font-bold text-red-600\">{stats.outOfStockCount}</p>\r\n                  <p className=\"text-xs text-muted-foreground mt-1\">Urgent action needed</p>\r\n                </div>\r\n                <AlertCircle className=\"h-8 w-8 text-red-600\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardContent className=\"pt-6\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-muted-foreground\">Critical Stock</p>\r\n                  <p className=\"text-2xl font-bold text-orange-600\">{stats.criticalStockCount}</p>\r\n                  <p className=\"text-xs text-muted-foreground mt-1\">&lt; 10 units</p>\r\n                </div>\r\n                <Activity className=\"h-8 w-8 text-orange-600\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Bulk Actions Bar */}\r\n        {selectedItems.size > 0 && (\r\n          <Card className=\"border-blue-200 bg-blue-50\">\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-sm font-medium\">\r\n                  {selectedItems.size} item{selectedItems.size !== 1 ? 's' : ''} selected\r\n                </span>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Button size=\"sm\" variant=\"outline\" onClick={handleExportSelected}>\r\n                    <Download className=\"h-4 w-4 mr-2\" />\r\n                    Export Selected\r\n                  </Button>\r\n                  <Button size=\"sm\" variant=\"destructive\" onClick={handleBulkDelete}>\r\n                    <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                    Delete Selected\r\n                  </Button>\r\n                  <Button size=\"sm\" variant=\"ghost\" onClick={() => setSelectedItems(new Set())}>\r\n                    <X className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n\r\n        {/* Search and Filters */}\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center gap-4\">\r\n              <div className=\"relative flex-1\">\r\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  ref={searchInputRef}\r\n                  placeholder=\"Search products, SKUs, or suppliers... (Ctrl+K)\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-10\"\r\n                />\r\n\r\n                {/* Search Suggestions */}\r\n                {showSearchSuggestions && searchSuggestions.length > 0 && (\r\n                  <Card className=\"absolute z-50 mt-1 w-full shadow-lg\">\r\n                    <CardContent className=\"p-2\">\r\n                      <div className=\"space-y-1\">\r\n                        {searchSuggestions.map((suggestion, idx) => (\r\n                          <button\r\n                            key={idx}\r\n                            className=\"w-full text-left px-3 py-2 hover:bg-muted rounded-md text-sm\"\r\n                            onClick={() => {\r\n                              const name = 'name' in suggestion ? suggestion.name : suggestion.product?.name\r\n                              setSearchTerm(name || '')\r\n                              setShowSearchSuggestions(false)\r\n                            }}\r\n                          >\r\n                            <div className=\"font-medium\">\r\n                              {'name' in suggestion ? suggestion.name : suggestion.product?.name}\r\n                            </div>\r\n                            <div className=\"text-xs text-muted-foreground\">\r\n                              {'sku' in suggestion ? suggestion.sku : suggestion.product?.sku}\r\n                            </div>\r\n                          </button>\r\n                        ))}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n              </div>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setShowFilters(!showFilters)}\r\n              >\r\n                <SlidersHorizontal className=\"h-4 w-4 mr-2\" />\r\n                Filters\r\n                {Object.keys(filters).some(key =>\r\n                  key !== 'search' && filters[key as keyof InventoryFilters]\r\n                ) && (\r\n                  <Badge variant=\"secondary\" className=\"ml-2\">\r\n                    Active\r\n                  </Badge>\r\n                )}\r\n              </Button>\r\n              {Object.keys(filters).some(key => filters[key as keyof InventoryFilters]) && (\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={clearFilters}>\r\n                  <X className=\"h-4 w-4 mr-2\" />\r\n                  Clear\r\n                </Button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Advanced Filters */}\r\n            {showFilters && (\r\n              <div className=\"mt-4 p-4 bg-muted/50 rounded-lg space-y-4\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {/* Price Range Filter */}\r\n                  <div>\r\n                    <Label className=\"mb-2 block\">Price Range</Label>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Input\r\n                        type=\"number\"\r\n                        placeholder=\"Min\"\r\n                        value={priceFilter.min}\r\n                        onChange={(e) => setPriceFilter(prev => ({ ...prev, min: e.target.value }))}\r\n                        className=\"w-24\"\r\n                      />\r\n                      <span className=\"text-muted-foreground\">-</span>\r\n                      <Input\r\n                        type=\"number\"\r\n                        placeholder=\"Max\"\r\n                        value={priceFilter.max}\r\n                        onChange={(e) => setPriceFilter(prev => ({ ...prev, max: e.target.value }))}\r\n                        className=\"w-24\"\r\n                      />\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Stock Level Filter */}\r\n                  <div>\r\n                    <Label className=\"mb-2 block\">Stock Level</Label>\r\n                    <Select value={stockLevelFilter} onValueChange={setStockLevelFilter}>\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All levels\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all\">All Levels</SelectItem>\r\n                        <SelectItem value=\"critical\">Critical (&lt; 10)</SelectItem>\r\n                        <SelectItem value=\"low\">Low Stock</SelectItem>\r\n                        <SelectItem value=\"adequate\">Adequate</SelectItem>\r\n                        <SelectItem value=\"overstocked\">Overstocked</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  {/* Category Filter */}\r\n                  <div>\r\n                    <Label className=\"mb-2 block\">Category</Label>\r\n                    <Select\r\n                      value={filters.category?.[0] || 'all_categories'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ category: value && value !== 'all_categories' ? [value as any] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All categories\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_categories\">All categories</SelectItem>\r\n                        {categories.map(category => (\r\n                          <SelectItem key={category} value={category}>\r\n                            {category.replace('_', ' ').toUpperCase()}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  {/* Supplier Filter */}\r\n                  <div>\r\n                    <Label className=\"mb-2 block\">Supplier</Label>\r\n                    <Select\r\n                      value={filters.supplier_id?.[0] || 'all_suppliers'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ supplier_id: value && value !== 'all_suppliers' ? [value] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All suppliers\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_suppliers\">All suppliers</SelectItem>\r\n                        {suppliers.map(supplier => (\r\n                          <SelectItem key={supplier.id} value={supplier.id}>\r\n                            {supplier.name}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  {/* Stock Status Filter */}\r\n                  <div>\r\n                    <Label className=\"mb-2 block\">Stock Status</Label>\r\n                    <Select\r\n                      value={filters.stock_status?.[0] || 'all_statuses'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ stock_status: value && value !== 'all_statuses' ? [value as any] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All statuses\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_statuses\">All statuses</SelectItem>\r\n                        {stockStatuses.map(status => (\r\n                          <SelectItem key={status} value={status}>\r\n                            {status.replace('_', ' ').toUpperCase()}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  {/* Location Filter */}\r\n                  <div>\r\n                    <Label className=\"mb-2 block\">Location</Label>\r\n                    <Select\r\n                      value={filters.location?.[0] || 'all_locations'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ location: value && value !== 'all_locations' ? [value] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All locations\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_locations\">All locations</SelectItem>\r\n                        {locations.map(location => (\r\n                          <SelectItem key={location} value={location}>\r\n                            {location}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-4\">\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <Checkbox\r\n                      id=\"low-stock\"\r\n                      checked={filters.low_stock_only || false}\r\n                      onCheckedChange={(checked) =>\r\n                        setFilters({ low_stock_only: checked as boolean })\r\n                      }\r\n                    />\r\n                    <label htmlFor=\"low-stock\" className=\"text-sm cursor-pointer\">\r\n                      Low stock only\r\n                    </label>\r\n                  </div>\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <Checkbox\r\n                      id=\"out-of-stock\"\r\n                      checked={filters.out_of_stock_only || false}\r\n                      onCheckedChange={(checked) =>\r\n                        setFilters({ out_of_stock_only: checked as boolean })\r\n                      }\r\n                    />\r\n                    <label htmlFor=\"out-of-stock\" className=\"text-sm cursor-pointer\">\r\n                      Out of stock only\r\n                    </label>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Inventory Table */}\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <Package className=\"h-5 w-5\" />\r\n              Inventory Items ({filteredItems.length})\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {loading ? (\r\n              <div className=\"space-y-4\">\r\n                {[...Array(5)].map((_, i) => (\r\n                  <div key={i} className=\"flex items-center space-x-4\">\r\n                    <Skeleton className=\"h-12 w-12 rounded\" />\r\n                    <div className=\"space-y-2 flex-1\">\r\n                      <Skeleton className=\"h-4 w-3/4\" />\r\n                      <Skeleton className=\"h-4 w-1/2\" />\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            ) : filteredItems.length === 0 ? (\r\n              <div className=\"flex flex-col items-center justify-center py-12\">\r\n                <Package className=\"h-16 w-16 text-muted-foreground/50 mb-4\" />\r\n                <h3 className=\"text-lg font-semibold mb-2\">No inventory items found</h3>\r\n                <p className=\"text-sm text-muted-foreground mb-4 text-center max-w-md\">\r\n                  {searchTerm || Object.keys(filters).some(k => filters[k as keyof InventoryFilters])\r\n                    ? 'Try adjusting your search criteria or filters to find what you\\'re looking for.'\r\n                    : 'Get started by adding your first product to begin tracking your inventory.'}\r\n                </p>\r\n                <Button onClick={() => setShowAddMode(true)}>\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Add Your First Product\r\n                </Button>\r\n              </div>\r\n            ) : (\r\n              <>\r\n                <div className=\"rounded-md border\">\r\n                  <Table>\r\n                    <TableHeader>\r\n                      <TableRow>\r\n                        <TableHead className=\"w-12\">\r\n                          <Checkbox\r\n                            checked={selectedItems.size === paginatedItems.length && paginatedItems.length > 0}\r\n                            onCheckedChange={(checked) => {\r\n                              if (checked) {\r\n                                setSelectedItems(new Set(paginatedItems.map(item => item.id)))\r\n                              } else {\r\n                                setSelectedItems(new Set())\r\n                              }\r\n                            }}\r\n                          />\r\n                        </TableHead>\r\n                        <TableHead>Product</TableHead>\r\n                        {columnVisibility.sku && <TableHead>SKU</TableHead>}\r\n                        {columnVisibility.supplier && <TableHead>Supplier</TableHead>}\r\n                        {columnVisibility.category && <TableHead>Category</TableHead>}\r\n                        {columnVisibility.location && <TableHead>Location</TableHead>}\r\n                        {columnVisibility.stock && <TableHead className=\"text-right\">Current Stock</TableHead>}\r\n                        {columnVisibility.value && <TableHead className=\"text-right\">Value</TableHead>}\r\n                        {columnVisibility.status && <TableHead>Status</TableHead>}\r\n                        <TableHead className=\"text-center\">Actions</TableHead>\r\n                      </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                      {paginatedItems.map((item) => {\r\n                        const isLowStock = item.current_stock <= item.reorder_point\r\n                        const isCritical = item.current_stock < 10 && item.current_stock > 0\r\n                        const isOutOfStock = item.current_stock === 0\r\n\r\n                        return (\r\n                          <TableRow\r\n                            key={item.id}\r\n                            className={cn(\r\n                              \"hover:bg-muted/50 transition-colors relative\",\r\n                              isOutOfStock && \"bg-red-50/50\",\r\n                              isCritical && \"bg-orange-50/50\",\r\n                              isLowStock && !isCritical && !isOutOfStock && \"bg-yellow-50/50\"\r\n                            )}\r\n                          >\r\n                            <TableCell>\r\n                              <Checkbox\r\n                                checked={selectedItems.has(item.id)}\r\n                                onCheckedChange={(checked) => {\r\n                                  const newSelection = new Set(selectedItems)\r\n                                  if (checked) {\r\n                                    newSelection.add(item.id)\r\n                                  } else {\r\n                                    newSelection.delete(item.id)\r\n                                  }\r\n                                  setSelectedItems(newSelection)\r\n                                }}\r\n                              />\r\n                            </TableCell>\r\n                            <TableCell>\r\n                              <div className=\"relative\">\r\n                                {/* Stock Alert Badge */}\r\n                                {(isLowStock || isCritical || isOutOfStock) && (\r\n                                  <div className=\"absolute -top-2 -left-2\">\r\n                                    <Tooltip>\r\n                                      <TooltipTrigger>\r\n                                        <Badge\r\n                                          variant=\"destructive\"\r\n                                          className={cn(\r\n                                            \"h-5 w-5 rounded-full p-0 flex items-center justify-center\",\r\n                                            isOutOfStock && \"animate-pulse bg-red-600\",\r\n                                            isCritical && !isOutOfStock && \"bg-orange-600\",\r\n                                            isLowStock && !isCritical && !isOutOfStock && \"bg-yellow-600\"\r\n                                          )}\r\n                                        >\r\n                                          !\r\n                                        </Badge>\r\n                                      </TooltipTrigger>\r\n                                      <TooltipContent>\r\n                                        {isOutOfStock && \"Out of stock - urgent action needed\"}\r\n                                        {isCritical && !isOutOfStock && \"Critical stock level\"}\r\n                                        {isLowStock && !isCritical && !isOutOfStock && \"Low stock - reorder soon\"}\r\n                                      </TooltipContent>\r\n                                    </Tooltip>\r\n                                  </div>\r\n                                )}\r\n                                <p className=\"font-medium\">{item.product?.name || 'Unknown Product'}</p>\r\n                                {item.product?.description && (\r\n                                  <p className=\"text-sm text-muted-foreground\">\r\n                                    {item.product.description.length > 50\r\n                                      ? `${item.product.description.substring(0, 50)}...`\r\n                                      : item.product.description\r\n                                    }\r\n                                  </p>\r\n                                )}\r\n                              </div>\r\n                            </TableCell>\r\n                            {columnVisibility.sku && (\r\n                              <TableCell>\r\n                                <code className=\"text-sm bg-muted px-2 py-1 rounded\">\r\n                                  {item.product?.sku || '-'}\r\n                                </code>\r\n                              </TableCell>\r\n                            )}\r\n                            {columnVisibility.supplier && (\r\n                              <TableCell>\r\n                                <div className=\"flex flex-col gap-1\">\r\n                                  <span className=\"font-medium text-sm\">{item.supplier_name}</span>\r\n                                  <Badge\r\n                                    variant={item.supplier_status === 'active' ? 'default' : 'secondary'}\r\n                                    className=\"w-fit text-xs\"\r\n                                  >\r\n                                    {item.supplier_status}\r\n                                  </Badge>\r\n                                </div>\r\n                              </TableCell>\r\n                            )}\r\n                            {columnVisibility.category && (\r\n                              <TableCell>\r\n                                <Badge variant=\"outline\" className=\"capitalize\">\r\n                                  {item.product?.category?.replace('_', ' ')}\r\n                                </Badge>\r\n                              </TableCell>\r\n                            )}\r\n                            {columnVisibility.location && (\r\n                              <TableCell>{item.location || '-'}</TableCell>\r\n                            )}\r\n                            {columnVisibility.stock && (\r\n                              <TableCell className=\"text-right\">\r\n                                <div>\r\n                                  {quickEditingStock === item.id ? (\r\n                                    <Input\r\n                                      type=\"number\"\r\n                                      className=\"w-20 h-8 text-right\"\r\n                                      defaultValue={item.current_stock}\r\n                                      autoFocus\r\n                                      onBlur={(e) => {\r\n                                        handleQuickStockUpdate(item.id, e.target.value)\r\n                                      }}\r\n                                      onKeyDown={(e) => {\r\n                                        if (e.key === 'Enter') {\r\n                                          handleQuickStockUpdate(item.id, e.currentTarget.value)\r\n                                        } else if (e.key === 'Escape') {\r\n                                          setQuickEditingStock(null)\r\n                                        }\r\n                                      }}\r\n                                    />\r\n                                  ) : (\r\n                                    <Tooltip>\r\n                                      <TooltipTrigger asChild>\r\n                                        <p\r\n                                          className=\"font-medium cursor-pointer hover:text-blue-600\"\r\n                                          onClick={() => setQuickEditingStock(item.id)}\r\n                                        >\r\n                                          {item.current_stock} {item.product?.unit_of_measure}\r\n                                        </p>\r\n                                      </TooltipTrigger>\r\n                                      <TooltipContent>\r\n                                        Click to quick edit stock level\r\n                                      </TooltipContent>\r\n                                    </Tooltip>\r\n                                  )}\r\n                                  {item.current_stock <= item.reorder_point && (\r\n                                    <p className=\"text-xs text-orange-600\">\r\n                                      Reorder at: {item.reorder_point}\r\n                                    </p>\r\n                                  )}\r\n                                </div>\r\n                              </TableCell>\r\n                            )}\r\n                            {columnVisibility.value && (\r\n                              <TableCell className=\"text-right\">\r\n                                <p className=\"font-medium\">{formatCurrency(item.total_value_zar)}</p>\r\n                                <p className=\"text-xs text-muted-foreground\">\r\n                                  @ {formatCurrency(item.cost_per_unit_zar)}\r\n                                </p>\r\n                              </TableCell>\r\n                            )}\r\n                            {columnVisibility.status && (\r\n                              <TableCell>\r\n                                <Badge\r\n                                  className={cn(\r\n                                    \"font-semibold capitalize border\",\r\n                                    getStockStatusBadgeColor(item.stock_status)\r\n                                  )}\r\n                                >\r\n                                  {getStockStatusLabel(item)}\r\n                                </Badge>\r\n                              </TableCell>\r\n                            )}\r\n                            <TableCell className=\"text-center\">\r\n                              <DropdownMenu>\r\n                                <DropdownMenuTrigger asChild>\r\n                                  <Button variant=\"ghost\" size=\"sm\">\r\n                                    <MoreHorizontal className=\"h-4 w-4\" />\r\n                                  </Button>\r\n                                </DropdownMenuTrigger>\r\n                                <DropdownMenuContent align=\"end\">\r\n                                  <DropdownMenuItem\r\n                                    onClick={() => setViewingProduct(item.product || null)}\r\n                                  >\r\n                                    <Eye className=\"h-4 w-4 mr-2\" />\r\n                                    View Details\r\n                                  </DropdownMenuItem>\r\n                                  <DropdownMenuItem\r\n                                    onClick={() => setEditingProduct(item.product || null)}\r\n                                  >\r\n                                    <Edit className=\"h-4 w-4 mr-2\" />\r\n                                    Edit Product\r\n                                  </DropdownMenuItem>\r\n                                  <DropdownMenuItem\r\n                                    onClick={() => setAdjustingStock(item)}\r\n                                  >\r\n                                    <BarChart3 className=\"h-4 w-4 mr-2\" />\r\n                                    Adjust Stock\r\n                                  </DropdownMenuItem>\r\n                                  <DropdownMenuSeparator />\r\n                                  <DropdownMenuItem\r\n                                    onClick={() => handleDeleteProduct(item.id)}\r\n                                    className=\"text-red-600 focus:text-red-600\"\r\n                                  >\r\n                                    <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                                    Delete Product\r\n                                  </DropdownMenuItem>\r\n                                </DropdownMenuContent>\r\n                              </DropdownMenu>\r\n                            </TableCell>\r\n                          </TableRow>\r\n                        )\r\n                      })}\r\n                    </TableBody>\r\n                  </Table>\r\n                </div>\r\n\r\n                {/* Pagination */}\r\n                {totalPages > 1 && (\r\n                  <div className=\"flex items-center justify-between mt-4\">\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Showing {((pagination.page - 1) * pagination.pageSize) + 1} to {Math.min(pagination.page * pagination.pageSize, filteredItems.length)} of {filteredItems.length} items\r\n                    </p>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setPagination(p => ({ ...p, page: Math.max(1, p.page - 1) }))}\r\n                        disabled={pagination.page === 1}\r\n                      >\r\n                        <ChevronLeft className=\"h-4 w-4 mr-1\" />\r\n                        Previous\r\n                      </Button>\r\n                      <div className=\"flex items-center gap-1\">\r\n                        {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\r\n                          let pageNum\r\n                          if (totalPages <= 5) {\r\n                            pageNum = i + 1\r\n                          } else if (pagination.page <= 3) {\r\n                            pageNum = i + 1\r\n                          } else if (pagination.page >= totalPages - 2) {\r\n                            pageNum = totalPages - 4 + i\r\n                          } else {\r\n                            pageNum = pagination.page - 2 + i\r\n                          }\r\n\r\n                          return (\r\n                            <Button\r\n                              key={pageNum}\r\n                              variant={pagination.page === pageNum ? \"default\" : \"outline\"}\r\n                              size=\"sm\"\r\n                              onClick={() => setPagination(p => ({ ...p, page: pageNum }))}\r\n                              className=\"w-9\"\r\n                            >\r\n                              {pageNum}\r\n                            </Button>\r\n                          )\r\n                        })}\r\n                      </div>\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setPagination(p => ({ ...p, page: Math.min(totalPages, p.page + 1) }))}\r\n                        disabled={pagination.page === totalPages}\r\n                      >\r\n                        Next\r\n                        <ChevronRight className=\"h-4 w-4 ml-1\" />\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Dialogs */}\r\n        <AddProductsModeDialog\r\n          open={showAddMode}\r\n          onOpenChange={setShowAddMode}\r\n          onChoose={(mode) => {\r\n            setShowAddMode(false)\r\n            if (mode === 'single') setShowAddProduct(true)\r\n            if (mode === 'multi') setShowMultiSelect(true)\r\n          }}\r\n        />\r\n\r\n        <AddProductDialog\r\n          open={showAddProduct}\r\n          onOpenChange={setShowAddProduct}\r\n        />\r\n\r\n        <MultiProductSelectorDialog\r\n          open={showMultiSelect}\r\n          onOpenChange={setShowMultiSelect}\r\n        />\r\n\r\n        {editingProduct && (\r\n          <EditProductDialog\r\n            product={editingProduct}\r\n            open={!!editingProduct}\r\n            onOpenChange={(open) => !open && setEditingProduct(null)}\r\n          />\r\n        )}\r\n\r\n        {adjustingStock && (\r\n          <StockAdjustmentDialog\r\n            inventoryItem={adjustingStock}\r\n            open={!!adjustingStock}\r\n            onOpenChange={(open) => !open && setAdjustingStock(null)}\r\n          />\r\n        )}\r\n\r\n        {viewingProduct && (\r\n          <ProductDetailsDialog\r\n            product={viewingProduct}\r\n            open={!!viewingProduct}\r\n            onOpenChange={(open) => !open && setViewingProduct(null)}\r\n          />\r\n        )}\r\n      </div>\r\n    </TooltipProvider>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\inventory\\NextJsXlsxConverter.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":334,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":334,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":341,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":341,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":390,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":390,"endColumn":12},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":463,"column":17,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":463,"endColumn":87,"suggestions":[{"messageId":"addBrackets","fix":{"range":[15277,15754],"text":"{ const price = parseFloat(cellValue.toString().replace(/[^\\d.-]/g, ''))\r\n                dataRow.price = isNaN(price) ? 0 : price\r\n                if (isNaN(price) || price < 0) {\r\n                  errors.push({\r\n                    row: rowNum,\r\n                    field: 'price',\r\n                    value: cellValue,\r\n                    message: 'Invalid price value',\r\n                    severity: 'error'\r\n                  })\r\n                }\r\n                break }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":476,"column":17,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":476,"endColumn":89,"suggestions":[{"messageId":"addBrackets","fix":{"range":[15804,16376],"text":"{ const vatRate = parseFloat(cellValue.toString().replace(/[^\\d.-]/g, ''))\r\n                dataRow.vat_rate = isNaN(vatRate) ? 0 : vatRate\r\n                if (isNaN(vatRate) || vatRate < 0 || vatRate > 100) {\r\n                  warnings.push({\r\n                    row: rowNum,\r\n                    field: 'vat_rate',\r\n                    value: cellValue,\r\n                    message: 'VAT rate should be between 0 and 100',\r\n                    suggestion: 'Check if this is a percentage or decimal value'\r\n                  })\r\n                }\r\n                break }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":489,"column":17,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":489,"endColumn":86,"suggestions":[{"messageId":"addBrackets","fix":{"range":[16427,16953],"text":"{ const stockQty = parseInt(cellValue.toString().replace(/[^\\d]/g, ''))\r\n                dataRow.stock_qty = isNaN(stockQty) ? 0 : stockQty\r\n                if (isNaN(stockQty) || stockQty < 0) {\r\n                  warnings.push({\r\n                    row: rowNum,\r\n                    field: 'stock_qty',\r\n                    value: cellValue,\r\n                    message: 'Invalid stock quantity',\r\n                    suggestion: 'Should be a positive integer'\r\n                  })\r\n                }\r\n                break }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":581,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":581,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":595,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":595,"endColumn":12},{"ruleId":"@typescript-eslint/no-non-null-asserted-optional-chain","severity":2,"message":"Optional chain expressions can return undefined by design - using a non-null assertion is unsafe and wrong.","line":739,"column":39,"nodeType":"TSNonNullExpression","messageId":"noNonNullOptionalChain","endLine":741,"endColumn":53,"suggestions":[{"messageId":"suggestRemovingNonNull","fix":{"range":[26448,26449],"text":""},"desc":"You should remove the non-null assertion."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useRef, useCallback, useMemo } from 'react'\r\nimport * as XLSX from 'xlsx'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'\r\nimport { Textarea } from '@/components/ui/textarea'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport {\r\n  Upload,\r\n  CheckCircle,\r\n  AlertTriangle,\r\n  FileSpreadsheet,\r\n  RefreshCw,\r\n  Brain,\r\n  MapPin,\r\n  Settings,\r\n  Download,\r\n  Eye,\r\n  Trash2\r\n} from 'lucide-react'\r\n\r\n// Enhanced types for advanced functionality\r\nexport interface SupplierDataRow {\r\n  supplier_name: string\r\n  brand: string\r\n  category: string\r\n  sku: string\r\n  description: string\r\n  price: number\r\n  vat_rate: number\r\n  stock_qty: number\r\n  [key: string]: string | number | boolean | undefined\r\n}\r\n\r\nexport interface FieldMapping {\r\n  sourceField: string\r\n  targetField: string\r\n  confidence: number\r\n  isRequired: boolean\r\n  transformation?: string\r\n}\r\n\r\nexport interface SemanticMapping {\r\n  mappings: FieldMapping[]\r\n  confidence: number\r\n  suggestions: string[]\r\n}\r\n\r\nexport interface DataValidationResult {\r\n  isValid: boolean\r\n  errors: ValidationError[]\r\n  warnings: ValidationWarning[]\r\n  cleanedData: SupplierDataRow[]\r\n  summary: {\r\n    total: number\r\n    valid: number\r\n    invalid: number\r\n    duplicates: number\r\n    emptyRows: number\r\n  }\r\n}\r\n\r\nexport interface ValidationError {\r\n  row: number\r\n  field: string\r\n  value: any\r\n  message: string\r\n  severity: 'error' | 'warning'\r\n}\r\n\r\nexport interface ValidationWarning {\r\n  row: number\r\n  field: string\r\n  value: any\r\n  message: string\r\n  suggestion?: string\r\n}\r\n\r\nexport interface NextJsXlsxConverterProps {\r\n  open?: boolean\r\n  onOpenChange?: (open: boolean) => void\r\n  onDataProcessed: (result: DataValidationResult) => Promise<void> | void\r\n  supplierFilter?: string\r\n  requiredFields?: string[]\r\n  allowedFileTypes?: string[]\r\n  maxFileSize?: number // in MB\r\n}\r\n\r\n// Semantic field mapping engine\r\nclass SemanticMapper {\r\n  private static requiredFields = [\r\n    'supplier_name', 'brand', 'category', 'sku',\r\n    'description', 'price', 'vat_rate', 'stock_qty'\r\n  ]\r\n\r\n  private static fieldPatterns: Record<string, string[]> = {\r\n    supplier_name: [\r\n      'supplier', 'vendor', 'company', 'manufacturer', 'provider',\r\n      'supplier_name', 'vendor_name', 'company_name', 'mfg', 'brand_owner'\r\n    ],\r\n    brand: [\r\n      'brand', 'make', 'manufacturer', 'label', 'trademark',\r\n      'brand_name', 'product_brand', 'mfg_brand', 'brandname'\r\n    ],\r\n    category: [\r\n      'category', 'type', 'class', 'group', 'segment', 'classification',\r\n      'product_category', 'item_category', 'cat', 'product_type'\r\n    ],\r\n    sku: [\r\n      'sku', 'item_code', 'product_code', 'part_number', 'item_id',\r\n      'product_id', 'code', 'article_number', 'barcode', 'upc'\r\n    ],\r\n    description: [\r\n      'description', 'product_description', 'item_description', 'name',\r\n      'product_name', 'item_name', 'title', 'product_title', 'details'\r\n    ],\r\n    price: [\r\n      'price', 'cost', 'unit_price', 'unit_cost', 'amount', 'value',\r\n      'list_price', 'retail_price', 'selling_price', 'cost_price'\r\n    ],\r\n    vat_rate: [\r\n      'vat', 'vat_rate', 'tax', 'tax_rate', 'gst', 'gst_rate',\r\n      'sales_tax', 'value_added_tax', 'tax_percentage', 'vat_percent'\r\n    ],\r\n    stock_qty: [\r\n      'stock', 'quantity', 'qty', 'inventory', 'available', 'on_hand',\r\n      'stock_quantity', 'current_stock', 'in_stock', 'inventory_qty'\r\n    ]\r\n  }\r\n\r\n  static generateMapping(headers: string[]): SemanticMapping {\r\n    const mappings: FieldMapping[] = []\r\n    const normalizedHeaders = headers.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, '_'))\r\n\r\n    for (const targetField of this.requiredFields) {\r\n      const patterns = this.fieldPatterns[targetField]\r\n      let bestMatch = { field: '', confidence: 0, index: -1 }\r\n\r\n      normalizedHeaders.forEach((header, index) => {\r\n        const confidence = this.calculateConfidence(header, patterns)\r\n        if (confidence > bestMatch.confidence) {\r\n          bestMatch = { field: headers[index], confidence, index }\r\n        }\r\n      })\r\n\r\n      if (bestMatch.confidence > 0.3) {\r\n        mappings.push({\r\n          sourceField: bestMatch.field,\r\n          targetField,\r\n          confidence: bestMatch.confidence,\r\n          isRequired: true\r\n        })\r\n      }\r\n    }\r\n\r\n    const overallConfidence = mappings.length / this.requiredFields.length\r\n    const suggestions = this.generateSuggestions(mappings, headers)\r\n\r\n    return { mappings, confidence: overallConfidence, suggestions }\r\n  }\r\n\r\n  private static calculateConfidence(header: string, patterns: string[]): number {\r\n    const headerNorm = header.toLowerCase()\r\n\r\n    // Exact match\r\n    if (patterns.includes(headerNorm)) return 1.0\r\n\r\n    // Partial match scoring\r\n    let maxScore = 0\r\n    for (const pattern of patterns) {\r\n      const score = this.fuzzyMatch(headerNorm, pattern)\r\n      maxScore = Math.max(maxScore, score)\r\n    }\r\n\r\n    return maxScore\r\n  }\r\n\r\n  private static fuzzyMatch(str1: string, str2: string): number {\r\n    const longer = str1.length > str2.length ? str1 : str2\r\n    const shorter = str1.length > str2.length ? str2 : str1\r\n\r\n    if (longer.length === 0) return 1.0\r\n    if (longer.includes(shorter)) return 0.8\r\n    if (shorter.includes(longer)) return 0.7\r\n\r\n    const editDistance = this.levenshteinDistance(str1, str2)\r\n    return Math.max(0, (longer.length - editDistance) / longer.length)\r\n  }\r\n\r\n  private static levenshteinDistance(str1: string, str2: string): number {\r\n    const matrix = Array(str2.length + 1).fill(null).map(() => Array(str1.length + 1).fill(null))\r\n\r\n    for (let i = 0; i <= str1.length; i++) matrix[0][i] = i\r\n    for (let j = 0; j <= str2.length; j++) matrix[j][0] = j\r\n\r\n    for (let j = 1; j <= str2.length; j++) {\r\n      for (let i = 1; i <= str1.length; i++) {\r\n        const substitutionCost = str1[i - 1] === str2[j - 1] ? 0 : 1\r\n        matrix[j][i] = Math.min(\r\n          matrix[j][i - 1] + 1,\r\n          matrix[j - 1][i] + 1,\r\n          matrix[j - 1][i - 1] + substitutionCost\r\n        )\r\n      }\r\n    }\r\n\r\n    return matrix[str2.length][str1.length]\r\n  }\r\n\r\n  private static generateSuggestions(mappings: FieldMapping[], headers: string[]): string[] {\r\n    const suggestions: string[] = []\r\n    const mappedFields = new Set(mappings.map(m => m.targetField))\r\n\r\n    for (const requiredField of this.requiredFields) {\r\n      if (!mappedFields.has(requiredField)) {\r\n        suggestions.push(`Missing mapping for required field: ${requiredField}`)\r\n      }\r\n    }\r\n\r\n    const lowConfidenceMappings = mappings.filter(m => m.confidence < 0.7)\r\n    if (lowConfidenceMappings.length > 0) {\r\n      suggestions.push(`${lowConfidenceMappings.length} mappings have low confidence - please review`)\r\n    }\r\n\r\n    return suggestions\r\n  }\r\n\r\n  static sanitizeSupplierName(name: string): string {\r\n    return name\r\n      .trim()\r\n      .replace(/[^\\w\\s&.-]/g, '')\r\n      .replace(/\\s+/g, ' ')\r\n      .toLowerCase()\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1))\r\n      .join(' ');\r\n  }\r\n\r\n  static extractBrandFromDescription(description: string, knownBrands: string[]): string {\r\n    const desc = description.toLowerCase()\r\n    for (const brand of knownBrands) {\r\n      if (desc.includes(brand.toLowerCase())) {\r\n        return brand\r\n      }\r\n    }\r\n\r\n    // Extract potential brand from beginning of description\r\n    const words = description.split(' ')\r\n    if (words.length > 0 && words[0].length > 2) {\r\n      return words[0]\r\n    }\r\n\r\n    return 'Unknown'\r\n  }\r\n\r\n  static categorizeProduct(description: string, sku: string): string {\r\n    const text = (description + ' ' + sku).toLowerCase()\r\n\r\n    const categories = {\r\n      'Electronics': ['electronic', 'digital', 'circuit', 'led', 'lcd', 'battery'],\r\n      'Hardware': ['bolt', 'screw', 'nail', 'tool', 'metal', 'steel'],\r\n      'Software': ['software', 'license', 'app', 'program'],\r\n      'Consumables': ['paper', 'ink', 'toner', 'cartridge', 'supply'],\r\n      'Office': ['office', 'desk', 'chair', 'stationery', 'pen'],\r\n      'Industrial': ['industrial', 'machine', 'equipment', 'motor']\r\n    }\r\n\r\n    for (const [category, keywords] of Object.entries(categories)) {\r\n      if (keywords.some(keyword => text.includes(keyword))) {\r\n        return category\r\n      }\r\n    }\r\n\r\n    return 'General'\r\n  }\r\n}\r\n\r\nconst NextJsXlsxConverter: React.FC<NextJsXlsxConverterProps> = ({\r\n  open,\r\n  onOpenChange,\r\n  onDataProcessed,\r\n  supplierFilter,\r\n  requiredFields = [\r\n    'supplier_name', 'brand', 'category', 'sku',\r\n    'description', 'price', 'vat_rate', 'stock_qty'\r\n  ],\r\n  allowedFileTypes = ['.xlsx', '.xls', '.csv'],\r\n  maxFileSize = 10\r\n}) => {\r\n  const [localOpen, setLocalOpen] = useState(false)\r\n  const isOpen = open ?? localOpen\r\n  const setOpen = (v: boolean) => (onOpenChange ? onOpenChange(v) : setLocalOpen(v))\r\n\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n  const [file, setFile] = useState<File | null>(null)\r\n  const [rawData, setRawData] = useState<any[][]>([])\r\n  const [headers, setHeaders] = useState<string[]>([])\r\n  const [semanticMapping, setSemanticMapping] = useState<SemanticMapping | null>(null)\r\n  const [manualMappings, setManualMappings] = useState<Record<string, string>>({})\r\n  const [validationResult, setValidationResult] = useState<DataValidationResult | null>(null)\r\n  const [processing, setProcessing] = useState(false)\r\n  const [processingStep, setProcessingStep] = useState('')\r\n  const [progress, setProgress] = useState(0)\r\n  const [activeTab, setActiveTab] = useState('upload')\r\n\r\n  const resetState = useCallback(() => {\r\n    setFile(null)\r\n    setRawData([])\r\n    setHeaders([])\r\n    setSemanticMapping(null)\r\n    setManualMappings({})\r\n    setValidationResult(null)\r\n    setProcessing(false)\r\n    setProcessingStep('')\r\n    setProgress(0)\r\n    setActiveTab('upload')\r\n  }, [])\r\n\r\n  const handleFileUpload = useCallback(async (uploadedFile: File) => {\r\n    if (!uploadedFile) return\r\n\r\n    // Validate file size\r\n    if (uploadedFile.size > maxFileSize * 1024 * 1024) {\r\n      alert(`File size exceeds ${maxFileSize}MB limit`)\r\n      return\r\n    }\r\n\r\n    // Validate file type\r\n    const fileExt = uploadedFile.name.toLowerCase().split('.').pop()\r\n    if (!allowedFileTypes.some(type => type.includes(fileExt || ''))) {\r\n      alert(`File type not supported. Allowed types: ${allowedFileTypes.join(', ')}`)\r\n      return\r\n    }\r\n\r\n    setProcessing(true)\r\n    setProcessingStep('Reading file...')\r\n    setProgress(20)\r\n\r\n    try {\r\n      const arrayBuffer = await uploadedFile.arrayBuffer()\r\n      const workbook = XLSX.read(arrayBuffer, { type: 'array' })\r\n      const worksheetName = workbook.SheetNames[0]\r\n      const worksheet = workbook.Sheets[worksheetName]\r\n      const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 })\r\n\r\n      if (data.length < 2) {\r\n        throw new Error('File must contain at least a header row and one data row')\r\n      }\r\n\r\n      setProcessingStep('Analyzing headers...')\r\n      setProgress(40)\r\n\r\n      const fileHeaders = data[0] as string[]\r\n      const fileData = data.slice(1) as any[][]\r\n\r\n      setFile(uploadedFile)\r\n      setHeaders(fileHeaders)\r\n      setRawData(fileData)\r\n\r\n      setProcessingStep('Generating semantic mapping...')\r\n      setProgress(60)\r\n\r\n      // Generate semantic mapping\r\n      const mapping = SemanticMapper.generateMapping(fileHeaders)\r\n      setSemanticMapping(mapping)\r\n\r\n      // Initialize manual mappings with semantic suggestions\r\n      const initialMappings: Record<string, string> = {}\r\n      mapping.mappings.forEach(m => {\r\n        initialMappings[m.targetField] = m.sourceField\r\n      })\r\n      setManualMappings(initialMappings)\r\n\r\n      setProcessingStep('Complete!')\r\n      setProgress(100)\r\n      setActiveTab('mapping')\r\n\r\n    } catch (error) {\r\n      console.error('File processing error:', error)\r\n      alert(`Error processing file: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n    } finally {\r\n      setProcessing(false)\r\n      setTimeout(() => {\r\n        setProcessingStep('')\r\n        setProgress(0)\r\n      }, 1000)\r\n    }\r\n  }, [maxFileSize, allowedFileTypes])\r\n\r\n  const validateAndCleanData = useCallback((): DataValidationResult => {\r\n    if (!rawData.length || !headers.length) {\r\n      return {\r\n        isValid: false,\r\n        errors: [{ row: 0, field: 'file', value: '', message: 'No data to validate', severity: 'error' }],\r\n        warnings: [],\r\n        cleanedData: [],\r\n        summary: { total: 0, valid: 0, invalid: 0, duplicates: 0, emptyRows: 0 }\r\n      }\r\n    }\r\n\r\n    const errors: ValidationError[] = []\r\n    const warnings: ValidationWarning[] = []\r\n    const cleanedData: SupplierDataRow[] = []\r\n    let duplicates = 0\r\n    let emptyRows = 0\r\n    const seenSkus = new Set<string>()\r\n\r\n    rawData.forEach((row, index) => {\r\n      const rowNum = index + 2 // +2 because index is 0-based and we have header row\r\n\r\n      // Check for empty rows\r\n      if (row.every(cell => !cell || cell.toString().trim() === '')) {\r\n        emptyRows++\r\n        return\r\n      }\r\n\r\n      const dataRow: SupplierDataRow = {\r\n        supplier_name: '',\r\n        brand: '',\r\n        category: '',\r\n        sku: '',\r\n        description: '',\r\n        price: 0,\r\n        vat_rate: 0,\r\n        stock_qty: 0\r\n      }\r\n\r\n      // Map fields based on manual mappings\r\n      for (const [targetField, sourceField] of Object.entries(manualMappings)) {\r\n        if (sourceField && headers.includes(sourceField)) {\r\n          const colIndex = headers.indexOf(sourceField)\r\n          const cellValue = row[colIndex]\r\n\r\n          if (cellValue !== undefined && cellValue !== null) {\r\n            switch (targetField) {\r\n              case 'supplier_name':\r\n                dataRow.supplier_name = SemanticMapper.sanitizeSupplierName(cellValue.toString())\r\n                break\r\n              case 'brand':\r\n                dataRow.brand = cellValue.toString().trim()\r\n                break\r\n              case 'category':\r\n                dataRow.category = cellValue.toString().trim() ||\r\n                  SemanticMapper.categorizeProduct(dataRow.description, dataRow.sku)\r\n                break\r\n              case 'sku':\r\n                dataRow.sku = cellValue.toString().trim().toUpperCase()\r\n                break\r\n              case 'description':\r\n                dataRow.description = cellValue.toString().trim()\r\n                break\r\n              case 'price':\r\n                const price = parseFloat(cellValue.toString().replace(/[^\\d.-]/g, ''))\r\n                dataRow.price = isNaN(price) ? 0 : price\r\n                if (isNaN(price) || price < 0) {\r\n                  errors.push({\r\n                    row: rowNum,\r\n                    field: 'price',\r\n                    value: cellValue,\r\n                    message: 'Invalid price value',\r\n                    severity: 'error'\r\n                  })\r\n                }\r\n                break\r\n              case 'vat_rate':\r\n                const vatRate = parseFloat(cellValue.toString().replace(/[^\\d.-]/g, ''))\r\n                dataRow.vat_rate = isNaN(vatRate) ? 0 : vatRate\r\n                if (isNaN(vatRate) || vatRate < 0 || vatRate > 100) {\r\n                  warnings.push({\r\n                    row: rowNum,\r\n                    field: 'vat_rate',\r\n                    value: cellValue,\r\n                    message: 'VAT rate should be between 0 and 100',\r\n                    suggestion: 'Check if this is a percentage or decimal value'\r\n                  })\r\n                }\r\n                break\r\n              case 'stock_qty':\r\n                const stockQty = parseInt(cellValue.toString().replace(/[^\\d]/g, ''))\r\n                dataRow.stock_qty = isNaN(stockQty) ? 0 : stockQty\r\n                if (isNaN(stockQty) || stockQty < 0) {\r\n                  warnings.push({\r\n                    row: rowNum,\r\n                    field: 'stock_qty',\r\n                    value: cellValue,\r\n                    message: 'Invalid stock quantity',\r\n                    suggestion: 'Should be a positive integer'\r\n                  })\r\n                }\r\n                break\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Validate required fields\r\n      for (const field of requiredFields) {\r\n        if (!dataRow[field] || dataRow[field].toString().trim() === '') {\r\n          errors.push({\r\n            row: rowNum,\r\n            field,\r\n            value: dataRow[field],\r\n            message: `Required field '${field}' is missing or empty`,\r\n            severity: 'error'\r\n          })\r\n        }\r\n      }\r\n\r\n      // Check for duplicate SKUs\r\n      if (dataRow.sku && seenSkus.has(dataRow.sku)) {\r\n        duplicates++\r\n        warnings.push({\r\n          row: rowNum,\r\n          field: 'sku',\r\n          value: dataRow.sku,\r\n          message: 'Duplicate SKU found',\r\n          suggestion: 'Consider making SKUs unique or handling duplicates'\r\n        })\r\n      } else if (dataRow.sku) {\r\n        seenSkus.add(dataRow.sku)\r\n      }\r\n\r\n      // Apply supplier filter if provided\r\n      if (supplierFilter && dataRow.supplier_name.toLowerCase() !== supplierFilter.toLowerCase()) {\r\n        return // Skip this row\r\n      }\r\n\r\n      cleanedData.push(dataRow)\r\n    })\r\n\r\n    const totalRows = rawData.length\r\n    const validRows = cleanedData.length\r\n    const invalidRows = totalRows - validRows - emptyRows\r\n\r\n    return {\r\n      isValid: errors.length === 0,\r\n      errors,\r\n      warnings,\r\n      cleanedData,\r\n      summary: {\r\n        total: totalRows,\r\n        valid: validRows,\r\n        invalid: invalidRows,\r\n        duplicates,\r\n        emptyRows\r\n      }\r\n    }\r\n  }, [rawData, headers, manualMappings, requiredFields, supplierFilter])\r\n\r\n  const processData = useCallback(async () => {\r\n    setProcessing(true)\r\n    setProcessingStep('Validating data...')\r\n    setProgress(30)\r\n\r\n    try {\r\n      const result = validateAndCleanData()\r\n      setValidationResult(result)\r\n\r\n      setProcessingStep('Processing complete!')\r\n      setProgress(100)\r\n      setActiveTab('preview')\r\n\r\n      setTimeout(() => {\r\n        setProcessingStep('')\r\n        setProgress(0)\r\n        setProcessing(false)\r\n      }, 1000)\r\n\r\n    } catch (error) {\r\n      console.error('Data processing error:', error)\r\n      alert(`Error processing data: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n      setProcessing(false)\r\n    }\r\n  }, [validateAndCleanData])\r\n\r\n  const handleApply = useCallback(async () => {\r\n    if (!validationResult) return\r\n\r\n    try {\r\n      await onDataProcessed(validationResult)\r\n      setOpen(false)\r\n      resetState()\r\n    } catch (error) {\r\n      console.error('Apply error:', error)\r\n      alert(`Error applying data: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n    }\r\n  }, [validationResult, onDataProcessed, setOpen, resetState])\r\n\r\n  const mappingProgress = useMemo(() => {\r\n    if (!semanticMapping) return 0\r\n    const totalRequired = requiredFields.length\r\n    const mapped = Object.values(manualMappings).filter(Boolean).length\r\n    return (mapped / totalRequired) * 100\r\n  }, [semanticMapping, manualMappings, requiredFields])\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={setOpen}>\r\n      <DialogTrigger asChild>\r\n        <Button variant=\"outline\" size=\"sm\">\r\n          <Brain className=\"h-4 w-4 mr-2\" />\r\n          Smart Import\r\n        </Button>\r\n      </DialogTrigger>\r\n      <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <FileSpreadsheet className=\"h-5 w-5\" />\r\n            Advanced XLSX Converter with Semantic Mapping\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"flex-1 flex flex-col\">\r\n          <TabsList className=\"grid w-full grid-cols-4\">\r\n            <TabsTrigger value=\"upload\">Upload</TabsTrigger>\r\n            <TabsTrigger value=\"mapping\" disabled={!headers.length}>Mapping</TabsTrigger>\r\n            <TabsTrigger value=\"preview\" disabled={!validationResult}>Preview</TabsTrigger>\r\n            <TabsTrigger value=\"settings\">Settings</TabsTrigger>\r\n          </TabsList>\r\n\r\n          {processing && (\r\n            <div className=\"p-4 bg-muted/50 rounded-lg\">\r\n              <div className=\"flex items-center gap-2 mb-2\">\r\n                <RefreshCw className=\"h-4 w-4 animate-spin\" />\r\n                <span className=\"text-sm\">{processingStep}</span>\r\n              </div>\r\n              <Progress value={progress} className=\"w-full\" />\r\n            </div>\r\n          )}\r\n\r\n          <TabsContent value=\"upload\" className=\"flex-1\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"flex items-center gap-2\">\r\n                  <Upload className=\"h-4 w-4\" />\r\n                  File Upload\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div className=\"border-2 border-dashed border-muted-foreground/25 rounded-lg p-8 text-center\">\r\n                  <FileSpreadsheet className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\r\n                  <div className=\"space-y-2\">\r\n                    <p className=\"text-lg font-medium\">Upload your supplier data file</p>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Supports Excel (.xlsx, .xls) and CSV files up to {maxFileSize}MB\r\n                    </p>\r\n                  </div>\r\n                  <Input\r\n                    ref={fileInputRef}\r\n                    type=\"file\"\r\n                    accept={allowedFileTypes.join(',')}\r\n                    onChange={(e) => handleFileUpload(e.target.files?.[0] || null)}\r\n                    className=\"hidden\"\r\n                  />\r\n                  <Button\r\n                    onClick={() => fileInputRef.current?.click()}\r\n                    className=\"mt-4\"\r\n                    disabled={processing}\r\n                  >\r\n                    <Upload className=\"h-4 w-4 mr-2\" />\r\n                    Choose File\r\n                  </Button>\r\n                </div>\r\n\r\n                {file && (\r\n                  <Alert>\r\n                    <CheckCircle className=\"h-4 w-4\" />\r\n                    <AlertDescription>\r\n                      File loaded: {file.name} ({Math.round(file.size / 1024)}KB, {rawData.length} rows)\r\n                    </AlertDescription>\r\n                  </Alert>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"mapping\" className=\"flex-1\">\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4 h-full\">\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <MapPin className=\"h-4 w-4\" />\r\n                    Smart Field Mapping\r\n                    <Badge variant=\"outline\" className=\"ml-auto\">\r\n                      {Math.round(mappingProgress)}% Complete\r\n                    </Badge>\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"space-y-3\">\r\n                    {semanticMapping && (\r\n                      <Alert className=\"mb-4\">\r\n                        <Brain className=\"h-4 w-4\" />\r\n                        <AlertDescription>\r\n                          AI Confidence: {Math.round(semanticMapping.confidence * 100)}%\r\n                          {semanticMapping.suggestions.length > 0 && (\r\n                            <div className=\"mt-2 text-xs\">\r\n                              Suggestions: {semanticMapping.suggestions.join(', ')}\r\n                            </div>\r\n                          )}\r\n                        </AlertDescription>\r\n                      </Alert>\r\n                    )}\r\n\r\n                    {requiredFields.map(field => (\r\n                      <div key={field} className=\"space-y-1\">\r\n                        <Label className=\"text-sm font-medium\">\r\n                          {field.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())}\r\n                          <span className=\"text-red-500 ml-1\">*</span>\r\n                        </Label>\r\n                        <Select\r\n                          value={manualMappings[field] || ''}\r\n                          onValueChange={(value) =>\r\n                            setManualMappings(prev => ({ ...prev, [field]: value }))\r\n                          }\r\n                        >\r\n                          <SelectTrigger>\r\n                            <SelectValue placeholder=\"Select source column\" />\r\n                          </SelectTrigger>\r\n                          <SelectContent>\r\n                            <SelectItem value=\"none\">-- None --</SelectItem>\r\n                            {headers.map(header => (\r\n                              <SelectItem key={header} value={header}>\r\n                                {header}\r\n                                {semanticMapping?.mappings.find(m =>\r\n                                  m.sourceField === header && m.targetField === field\r\n                                ) && (\r\n                                  <Badge variant=\"secondary\" className=\"ml-2 text-xs\">\r\n                                    AI: {Math.round(\r\n                                      semanticMapping.mappings.find(m =>\r\n                                        m.sourceField === header && m.targetField === field\r\n                                      )?.confidence! * 100\r\n                                    )}%\r\n                                  </Badge>\r\n                                )}\r\n                              </SelectItem>\r\n                            ))}\r\n                          </SelectContent>\r\n                        </Select>\r\n                      </div>\r\n                    ))}\r\n\r\n                    <Button\r\n                      onClick={processData}\r\n                      className=\"w-full mt-4\"\r\n                      disabled={Object.values(manualMappings).filter(Boolean).length < requiredFields.length || processing}\r\n                    >\r\n                      <Settings className=\"h-4 w-4 mr-2\" />\r\n                      Process Data\r\n                    </Button>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle>Data Preview</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <ScrollArea className=\"h-80\">\r\n                    <Table>\r\n                      <TableHeader>\r\n                        <TableRow>\r\n                          {headers.slice(0, 4).map(header => (\r\n                            <TableHead key={header} className=\"text-xs\">{header}</TableHead>\r\n                          ))}\r\n                        </TableRow>\r\n                      </TableHeader>\r\n                      <TableBody>\r\n                        {rawData.slice(0, 10).map((row, i) => (\r\n                          <TableRow key={i}>\r\n                            {row.slice(0, 4).map((cell, j) => (\r\n                              <TableCell key={j} className=\"text-xs\">\r\n                                {cell?.toString().slice(0, 20)}...\r\n                              </TableCell>\r\n                            ))}\r\n                          </TableRow>\r\n                        ))}\r\n                      </TableBody>\r\n                    </Table>\r\n                  </ScrollArea>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"preview\" className=\"flex-1\">\r\n            {validationResult && (\r\n              <div className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\r\n                  <Card>\r\n                    <CardContent className=\"pt-6 text-center\">\r\n                      <div className=\"text-2xl font-bold\">{validationResult.summary.total}</div>\r\n                      <div className=\"text-xs text-muted-foreground\">Total Rows</div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardContent className=\"pt-6 text-center\">\r\n                      <div className=\"text-2xl font-bold text-green-600\">{validationResult.summary.valid}</div>\r\n                      <div className=\"text-xs text-muted-foreground\">Valid</div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardContent className=\"pt-6 text-center\">\r\n                      <div className=\"text-2xl font-bold text-red-600\">{validationResult.summary.invalid}</div>\r\n                      <div className=\"text-xs text-muted-foreground\">Invalid</div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardContent className=\"pt-6 text-center\">\r\n                      <div className=\"text-2xl font-bold text-yellow-600\">{validationResult.summary.duplicates}</div>\r\n                      <div className=\"text-xs text-muted-foreground\">Duplicates</div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardContent className=\"pt-6 text-center\">\r\n                      <div className=\"text-2xl font-bold text-gray-600\">{validationResult.summary.emptyRows}</div>\r\n                      <div className=\"text-xs text-muted-foreground\">Empty</div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>\r\n\r\n                {validationResult.errors.length > 0 && (\r\n                  <Card className=\"border-red-200\">\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-sm text-red-800\">Validation Errors</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <ScrollArea className=\"h-32\">\r\n                        <div className=\"space-y-1\">\r\n                          {validationResult.errors.slice(0, 20).map((error, i) => (\r\n                            <div key={i} className=\"text-sm text-red-600\">\r\n                              Row {error.row}: {error.field} - {error.message}\r\n                            </div>\r\n                          ))}\r\n                          {validationResult.errors.length > 20 && (\r\n                            <div className=\"text-xs text-muted-foreground\">\r\n                              ...and {validationResult.errors.length - 20} more errors\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </ScrollArea>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n\r\n                {validationResult.warnings.length > 0 && (\r\n                  <Card className=\"border-yellow-200\">\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-sm text-yellow-800\">Warnings</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <ScrollArea className=\"h-32\">\r\n                        <div className=\"space-y-1\">\r\n                          {validationResult.warnings.slice(0, 10).map((warning, i) => (\r\n                            <div key={i} className=\"text-sm text-yellow-600\">\r\n                              Row {warning.row}: {warning.field} - {warning.message}\r\n                              {warning.suggestion && (\r\n                                <div className=\"text-xs text-muted-foreground ml-2\">\r\n                                  💡 {warning.suggestion}\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                          ))}\r\n                        </div>\r\n                      </ScrollArea>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"text-sm\">Processed Data Preview</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <ScrollArea className=\"h-64\">\r\n                      <Table>\r\n                        <TableHeader>\r\n                          <TableRow>\r\n                            <TableHead>Supplier</TableHead>\r\n                            <TableHead>Brand</TableHead>\r\n                            <TableHead>SKU</TableHead>\r\n                            <TableHead>Description</TableHead>\r\n                            <TableHead>Price</TableHead>\r\n                            <TableHead>Stock</TableHead>\r\n                          </TableRow>\r\n                        </TableHeader>\r\n                        <TableBody>\r\n                          {validationResult.cleanedData.slice(0, 20).map((row, i) => (\r\n                            <TableRow key={i}>\r\n                              <TableCell className=\"text-xs\">{row.supplier_name}</TableCell>\r\n                              <TableCell className=\"text-xs\">{row.brand}</TableCell>\r\n                              <TableCell className=\"text-xs font-mono\">{row.sku}</TableCell>\r\n                              <TableCell className=\"text-xs\">{row.description.slice(0, 30)}...</TableCell>\r\n                              <TableCell className=\"text-xs\">${row.price.toFixed(2)}</TableCell>\r\n                              <TableCell className=\"text-xs\">{row.stock_qty}</TableCell>\r\n                            </TableRow>\r\n                          ))}\r\n                        </TableBody>\r\n                      </Table>\r\n                    </ScrollArea>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n            )}\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"settings\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>Configuration</CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div>\r\n                  <Label>Supplier Filter</Label>\r\n                  <Input\r\n                    placeholder=\"Filter by supplier name (optional)\"\r\n                    value={supplierFilter || ''}\r\n                    onChange={(e) => {\r\n                      // This would need to be passed up to parent component\r\n                    }}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>Max File Size (MB)</Label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    value={maxFileSize}\r\n                    onChange={(e) => {\r\n                      // This would need to be passed up to parent component\r\n                    }}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <Label>Required Fields</Label>\r\n                  <Textarea\r\n                    value={requiredFields.join('\\n')}\r\n                    onChange={(e) => {\r\n                      // This would need to be passed up to parent component\r\n                    }}\r\n                    placeholder=\"One field per line\"\r\n                    rows={8}\r\n                  />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n        </Tabs>\r\n\r\n        <div className=\"flex items-center justify-between pt-4 border-t\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button variant=\"outline\" onClick={resetState}>\r\n              <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n              Reset\r\n            </Button>\r\n            {validationResult && (\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <Download className=\"h-4 w-4 mr-2\" />\r\n                Export Report\r\n              </Button>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button variant=\"outline\" onClick={() => setOpen(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button\r\n              onClick={handleApply}\r\n              disabled={!validationResult || !validationResult.isValid || validationResult.cleanedData.length === 0}\r\n            >\r\n              <CheckCircle className=\"h-4 w-4 mr-2\" />\r\n              Apply ({validationResult?.cleanedData.length || 0} rows)\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n\r\nexport default NextJsXlsxConverter","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\inventory\\NotificationSystem.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":98,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":98,"endColumn":36},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":107,"column":28,"nodeType":"Identifier","messageId":"undef","endLine":107,"endColumn":40},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":121,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":121,"endColumn":21},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":122,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":122,"endColumn":21}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useCallback, useEffect } from 'react'\r\nimport { Card, CardContent } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport {\r\n  CheckCircle,\r\n  AlertTriangle,\r\n  AlertCircle,\r\n  Info,\r\n  X,\r\n  Clock,\r\n  TrendingUp,\r\n  Download,\r\n  Upload,\r\n  RefreshCw,\r\n  Bell,\r\n  BellOff\r\n} from 'lucide-react'\r\n\r\nexport type NotificationType = 'success' | 'error' | 'warning' | 'info' | 'progress'\r\nexport type NotificationPriority = 'low' | 'medium' | 'high' | 'critical'\r\n\r\nexport interface NotificationAction {\r\n  label: string\r\n  action: () => void\r\n  variant?: 'default' | 'outline' | 'destructive'\r\n}\r\n\r\nexport interface BaseNotification {\r\n  id: string\r\n  type: NotificationType\r\n  priority: NotificationPriority\r\n  title: string\r\n  message: string\r\n  timestamp: Date\r\n  duration?: number // Auto-dismiss after milliseconds (0 = persist)\r\n  actions?: NotificationAction[]\r\n  dismissible?: boolean\r\n  persistent?: boolean\r\n  groupId?: string // For grouping related notifications\r\n  data?: any // Additional data for the notification\r\n}\r\n\r\nexport interface ProgressNotification extends BaseNotification {\r\n  type: 'progress'\r\n  progress: number // 0-100\r\n  stage?: string\r\n  estimatedTime?: number\r\n  throughput?: number\r\n}\r\n\r\nexport type Notification = BaseNotification | ProgressNotification\r\n\r\ninterface NotificationContextType {\r\n  notifications: Notification[]\r\n  addNotification: (notification: Omit<Notification, 'id' | 'timestamp'>) => string\r\n  updateNotification: (id: string, updates: Partial<Notification>) => void\r\n  removeNotification: (id: string) => void\r\n  clearNotifications: (groupId?: string) => void\r\n  clearAll: () => void\r\n  markAsRead: (id: string) => void\r\n  markAllAsRead: () => void\r\n  getUnreadCount: () => number\r\n  getNotificationsByPriority: (priority: NotificationPriority) => Notification[]\r\n}\r\n\r\nconst NotificationContext = createContext<NotificationContextType | null>(null)\r\n\r\nexport const useNotifications = () => {\r\n  const context = useContext(NotificationContext)\r\n  if (!context) {\r\n    throw new Error('useNotifications must be used within a NotificationProvider')\r\n  }\r\n  return context\r\n}\r\n\r\ninterface NotificationProviderProps {\r\n  children: React.ReactNode\r\n  maxNotifications?: number\r\n  defaultDuration?: number\r\n  enablePersistence?: boolean\r\n}\r\n\r\nexport const NotificationProvider: React.FC<NotificationProviderProps> = ({\r\n  children,\r\n  maxNotifications = 10,\r\n  defaultDuration = 5000,\r\n  enablePersistence = true\r\n}) => {\r\n  const [notifications, setNotifications] = useState<Notification[]>([])\r\n  const [readNotifications, setReadNotifications] = useState<Set<string>>(new Set())\r\n\r\n  // Load persisted notifications on mount\r\n  useEffect(() => {\r\n    if (enablePersistence) {\r\n      try {\r\n        const stored = localStorage.getItem('notifications')\r\n        if (stored) {\r\n          const parsedNotifications = JSON.parse(stored).map((n: any) => ({\r\n            ...n,\r\n            timestamp: new Date(n.timestamp)\r\n          }))\r\n          setNotifications(parsedNotifications)\r\n        }\r\n\r\n        const storedRead = localStorage.getItem('notifications-read')\r\n        if (storedRead) {\r\n          setReadNotifications(new Set(JSON.parse(storedRead)))\r\n        }\r\n      } catch (error) {\r\n        console.error('Failed to load persisted notifications:', error)\r\n      }\r\n    }\r\n  }, [enablePersistence])\r\n\r\n  // Persist notifications when they change\r\n  useEffect(() => {\r\n    if (enablePersistence) {\r\n      try {\r\n        localStorage.setItem('notifications', JSON.stringify(notifications))\r\n        localStorage.setItem('notifications-read', JSON.stringify([...readNotifications]))\r\n      } catch (error) {\r\n        console.error('Failed to persist notifications:', error)\r\n      }\r\n    }\r\n  }, [notifications, readNotifications, enablePersistence])\r\n\r\n  const addNotification = useCallback((notificationData: Omit<Notification, 'id' | 'timestamp'>): string => {\r\n    const id = `notification_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n    const notification: Notification = {\r\n      ...notificationData,\r\n      id,\r\n      timestamp: new Date(),\r\n      duration: notificationData.duration ?? (notificationData.persistent ? 0 : defaultDuration),\r\n      dismissible: notificationData.dismissible ?? true\r\n    }\r\n\r\n    setNotifications(prev => {\r\n      const newNotifications = [notification, ...prev]\r\n\r\n      // Remove excess notifications if we exceed the limit\r\n      if (newNotifications.length > maxNotifications) {\r\n        return newNotifications.slice(0, maxNotifications)\r\n      }\r\n\r\n      return newNotifications\r\n    })\r\n\r\n    // Auto-dismiss if duration is set\r\n    if (notification.duration && notification.duration > 0) {\r\n      setTimeout(() => {\r\n        removeNotification(id)\r\n      }, notification.duration)\r\n    }\r\n\r\n    return id\r\n  }, [defaultDuration, maxNotifications])\r\n\r\n  const updateNotification = useCallback((id: string, updates: Partial<Notification>) => {\r\n    setNotifications(prev =>\r\n      prev.map(notification =>\r\n        notification.id === id\r\n          ? { ...notification, ...updates }\r\n          : notification\r\n      )\r\n    )\r\n  }, [])\r\n\r\n  const removeNotification = useCallback((id: string) => {\r\n    setNotifications(prev => prev.filter(n => n.id !== id))\r\n    setReadNotifications(prev => {\r\n      const newSet = new Set(prev)\r\n      newSet.delete(id)\r\n      return newSet\r\n    })\r\n  }, [])\r\n\r\n  const clearNotifications = useCallback((groupId?: string) => {\r\n    if (groupId) {\r\n      setNotifications(prev => prev.filter(n => n.groupId !== groupId))\r\n    } else {\r\n      setNotifications([])\r\n      setReadNotifications(new Set())\r\n    }\r\n  }, [])\r\n\r\n  const clearAll = useCallback(() => {\r\n    setNotifications([])\r\n    setReadNotifications(new Set())\r\n  }, [])\r\n\r\n  const markAsRead = useCallback((id: string) => {\r\n    setReadNotifications(prev => new Set([...prev, id]))\r\n  }, [])\r\n\r\n  const markAllAsRead = useCallback(() => {\r\n    setReadNotifications(new Set(notifications.map(n => n.id)))\r\n  }, [notifications])\r\n\r\n  const getUnreadCount = useCallback(() => {\r\n    return notifications.filter(n => !readNotifications.has(n.id)).length\r\n  }, [notifications, readNotifications])\r\n\r\n  const getNotificationsByPriority = useCallback((priority: NotificationPriority) => {\r\n    return notifications.filter(n => n.priority === priority)\r\n  }, [notifications])\r\n\r\n  const contextValue: NotificationContextType = {\r\n    notifications,\r\n    addNotification,\r\n    updateNotification,\r\n    removeNotification,\r\n    clearNotifications,\r\n    clearAll,\r\n    markAsRead,\r\n    markAllAsRead,\r\n    getUnreadCount,\r\n    getNotificationsByPriority\r\n  }\r\n\r\n  return (\r\n    <NotificationContext.Provider value={contextValue}>\r\n      {children}\r\n    </NotificationContext.Provider>\r\n  )\r\n}\r\n\r\n// Notification Display Component\r\ninterface NotificationItemProps {\r\n  notification: Notification\r\n  onDismiss?: (id: string) => void\r\n  onAction?: (action: NotificationAction) => void\r\n  compact?: boolean\r\n}\r\n\r\nconst NotificationItem: React.FC<NotificationItemProps> = ({\r\n  notification,\r\n  onDismiss,\r\n  onAction,\r\n  compact = false\r\n}) => {\r\n  const getIcon = () => {\r\n    switch (notification.type) {\r\n      case 'success':\r\n        return <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n      case 'error':\r\n        return <AlertCircle className=\"h-4 w-4 text-red-600\" />\r\n      case 'warning':\r\n        return <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\r\n      case 'info':\r\n        return <Info className=\"h-4 w-4 text-blue-600\" />\r\n      case 'progress':\r\n        return <RefreshCw className=\"h-4 w-4 text-blue-600 animate-spin\" />\r\n    }\r\n  }\r\n\r\n  const getBackgroundColor = () => {\r\n    switch (notification.type) {\r\n      case 'success':\r\n        return 'bg-green-50 border-green-200'\r\n      case 'error':\r\n        return 'bg-red-50 border-red-200'\r\n      case 'warning':\r\n        return 'bg-yellow-50 border-yellow-200'\r\n      case 'info':\r\n        return 'bg-blue-50 border-blue-200'\r\n      case 'progress':\r\n        return 'bg-blue-50 border-blue-200'\r\n      default:\r\n        return 'bg-white border-gray-200'\r\n    }\r\n  }\r\n\r\n  const getPriorityBadge = () => {\r\n    if (notification.priority === 'low') return null\r\n\r\n    const colors = {\r\n      medium: 'bg-yellow-100 text-yellow-800',\r\n      high: 'bg-orange-100 text-orange-800',\r\n      critical: 'bg-red-100 text-red-800'\r\n    }\r\n\r\n    return (\r\n      <Badge className={`text-xs ${colors[notification.priority as keyof typeof colors]}`}>\r\n        {notification.priority}\r\n      </Badge>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <Card className={`${getBackgroundColor()} transition-all duration-200 hover:shadow-md`}>\r\n      <CardContent className={`p-${compact ? '3' : '4'}`}>\r\n        <div className=\"flex items-start gap-3\">\r\n          <div className=\"flex-shrink-0 mt-0.5\">\r\n            {getIcon()}\r\n          </div>\r\n\r\n          <div className=\"flex-1 min-w-0\">\r\n            <div className=\"flex items-start justify-between gap-2\">\r\n              <div className=\"flex-1\">\r\n                <div className=\"flex items-center gap-2 mb-1\">\r\n                  <h4 className={`font-medium ${compact ? 'text-sm' : ''}`}>\r\n                    {notification.title}\r\n                  </h4>\r\n                  {getPriorityBadge()}\r\n                </div>\r\n                <p className={`text-muted-foreground ${compact ? 'text-xs' : 'text-sm'}`}>\r\n                  {notification.message}\r\n                </p>\r\n\r\n                {/* Progress notification specific content */}\r\n                {notification.type === 'progress' && (\r\n                  <div className=\"mt-2 space-y-2\">\r\n                    <div className=\"flex items-center justify-between text-xs\">\r\n                      <span>{(notification as ProgressNotification).stage || 'Processing...'}</span>\r\n                      <span>{(notification as ProgressNotification).progress}%</span>\r\n                    </div>\r\n                    <Progress\r\n                      value={(notification as ProgressNotification).progress}\r\n                      className=\"h-2\"\r\n                    />\r\n                    {(notification as ProgressNotification).estimatedTime && (\r\n                      <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n                        <Clock className=\"h-3 w-3\" />\r\n                        <span>\r\n                          {Math.round((notification as ProgressNotification).estimatedTime! / 1000)}s remaining\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {notification.dismissible && onDismiss && (\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={() => onDismiss(notification.id)}\r\n                  className=\"flex-shrink-0 h-6 w-6 p-0\"\r\n                >\r\n                  <X className=\"h-4 w-4\" />\r\n                </Button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Actions */}\r\n            {notification.actions && notification.actions.length > 0 && (\r\n              <div className=\"flex gap-2 mt-3\">\r\n                {notification.actions.map((action, index) => (\r\n                  <Button\r\n                    key={index}\r\n                    variant={action.variant || 'outline'}\r\n                    size=\"sm\"\r\n                    onClick={() => {\r\n                      action.action()\r\n                      onAction?.(action)\r\n                    }}\r\n                    className=\"text-xs\"\r\n                  >\r\n                    {action.label}\r\n                  </Button>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {!compact && (\r\n              <div className=\"flex items-center justify-between mt-2 text-xs text-muted-foreground\">\r\n                <span>{notification.timestamp.toLocaleTimeString()}</span>\r\n                {notification.groupId && (\r\n                  <Badge variant=\"outline\" className=\"text-xs\">\r\n                    {notification.groupId}\r\n                  </Badge>\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n\r\n// Notification List Component\r\ninterface NotificationListProps {\r\n  notifications?: Notification[]\r\n  compact?: boolean\r\n  maxVisible?: number\r\n  onDismiss?: (id: string) => void\r\n  onClearAll?: () => void\r\n}\r\n\r\nexport const NotificationList: React.FC<NotificationListProps> = ({\r\n  notifications: propNotifications,\r\n  compact = false,\r\n  maxVisible = 5,\r\n  onDismiss,\r\n  onClearAll\r\n}) => {\r\n  const { notifications: contextNotifications, removeNotification, clearAll } = useNotifications()\r\n  const notifications = propNotifications || contextNotifications\r\n\r\n  const handleDismiss = onDismiss || removeNotification\r\n  const handleClearAll = onClearAll || clearAll\r\n\r\n  const visibleNotifications = notifications.slice(0, maxVisible)\r\n  const hasMore = notifications.length > maxVisible\r\n\r\n  if (notifications.length === 0) {\r\n    return (\r\n      <div className=\"text-center py-8 text-muted-foreground\">\r\n        <BellOff className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\r\n        <p>No notifications</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h3 className=\"text-sm font-medium flex items-center gap-2\">\r\n          <Bell className=\"h-4 w-4\" />\r\n          Notifications ({notifications.length})\r\n        </h3>\r\n        {notifications.length > 0 && (\r\n          <Button variant=\"ghost\" size=\"sm\" onClick={handleClearAll}>\r\n            Clear All\r\n          </Button>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"space-y-2\">\r\n        {visibleNotifications.map(notification => (\r\n          <NotificationItem\r\n            key={notification.id}\r\n            notification={notification}\r\n            onDismiss={handleDismiss}\r\n            compact={compact}\r\n          />\r\n        ))}\r\n      </div>\r\n\r\n      {hasMore && (\r\n        <div className=\"text-center\">\r\n          <Button variant=\"ghost\" size=\"sm\">\r\n            Show {notifications.length - maxVisible} more\r\n          </Button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n// Notification Hook Helpers\r\nexport const useNotificationHelpers = () => {\r\n  const { addNotification, updateNotification } = useNotifications()\r\n\r\n  const showSuccess = useCallback((title: string, message: string, options?: Partial<Notification>) => {\r\n    return addNotification({\r\n      type: 'success',\r\n      priority: 'medium',\r\n      title,\r\n      message,\r\n      ...options\r\n    })\r\n  }, [addNotification])\r\n\r\n  const showError = useCallback((title: string, message: string, options?: Partial<Notification>) => {\r\n    return addNotification({\r\n      type: 'error',\r\n      priority: 'high',\r\n      title,\r\n      message,\r\n      persistent: true,\r\n      ...options\r\n    })\r\n  }, [addNotification])\r\n\r\n  const showWarning = useCallback((title: string, message: string, options?: Partial<Notification>) => {\r\n    return addNotification({\r\n      type: 'warning',\r\n      priority: 'medium',\r\n      title,\r\n      message,\r\n      ...options\r\n    })\r\n  }, [addNotification])\r\n\r\n  const showInfo = useCallback((title: string, message: string, options?: Partial<Notification>) => {\r\n    return addNotification({\r\n      type: 'info',\r\n      priority: 'low',\r\n      title,\r\n      message,\r\n      ...options\r\n    })\r\n  }, [addNotification])\r\n\r\n  const showProgress = useCallback((title: string, message: string, progress: number = 0, options?: Partial<ProgressNotification>) => {\r\n    return addNotification({\r\n      type: 'progress',\r\n      priority: 'medium',\r\n      title,\r\n      message,\r\n      progress,\r\n      persistent: true,\r\n      dismissible: false,\r\n      ...options\r\n    } as ProgressNotification)\r\n  }, [addNotification])\r\n\r\n  const updateProgress = useCallback((id: string, progress: number, stage?: string, estimatedTime?: number) => {\r\n    updateNotification(id, {\r\n      progress,\r\n      stage,\r\n      estimatedTime\r\n    } as Partial<ProgressNotification>)\r\n  }, [updateNotification])\r\n\r\n  return {\r\n    showSuccess,\r\n    showError,\r\n    showWarning,\r\n    showInfo,\r\n    showProgress,\r\n    updateProgress\r\n  }\r\n}\r\n\r\nexport default NotificationItem","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\inventory\\PriceListUploader.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'FileReader' is not defined.","line":26,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":26,"endColumn":34}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useMemo, useRef, useState } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'\r\nimport { Upload, CheckCircle, AlertTriangle, FileSpreadsheet, RefreshCw } from 'lucide-react'\r\nimport type { PriceListBuildResult, PriceListMapping, PriceListParseResult } from '@/types/pricelist'\r\nimport { buildPriceList, detectHeaders } from '@/lib/utils/pricelist-parser'\r\n\r\nexport interface PriceListUploaderProps {\r\n  supplierId?: string;\r\n  open?: boolean;\r\n  onOpenChange?: (open: boolean) => void;\r\n  onApply: (result: PriceListBuildResult) => Promise<void> | void;\r\n}\r\n\r\nconst readTextFromFile = (file: File): Promise<string> =>\r\n  new Promise((resolve, reject) => {\r\n    const reader = new FileReader()\r\n    reader.onload = () => resolve(String(reader.result))\r\n    reader.onerror = reject\r\n    reader.readAsText(file)\r\n  })\r\n\r\nconst PriceListUploader: React.FC<PriceListUploaderProps> = ({ supplierId, open, onOpenChange, onApply }) => {\r\n  const [localOpen, setLocalOpen] = useState(false)\r\n  const isOpen = open ?? localOpen\r\n  const setOpen = (v: boolean) => (onOpenChange ? onOpenChange(v) : setLocalOpen(v))\r\n\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n  const [fileName, setFileName] = useState<string | undefined>()\r\n  const [raw, setRaw] = useState<PriceListParseResult | undefined>()\r\n  const [mapping, setMapping] = useState<Partial<PriceListMapping>>({})\r\n  const [built, setBuilt] = useState<PriceListBuildResult | undefined>()\r\n  const [busy, setBusy] = useState(false)\r\n\r\n  const effectiveMapping: PriceListMapping | undefined = useMemo(() => {\r\n    if (!raw) return undefined\r\n    return {\r\n      sku: mapping.sku || (raw.mapping.sku as string) || raw.headers[0],\r\n      unitCost: mapping.unitCost || (raw.mapping.unitCost as string) || raw.headers[1],\r\n      supplierId: mapping.supplierId || (raw.mapping.supplierId as string),\r\n      supplierName: mapping.supplierName || (raw.mapping.supplierName as string),\r\n      supplierSku: mapping.supplierSku || (raw.mapping.supplierSku as string),\r\n      currency: mapping.currency || (raw.mapping.currency as string),\r\n      unit: mapping.unit || (raw.mapping.unit as string),\r\n      minQty: mapping.minQty || (raw.mapping.minQty as string),\r\n      effectiveDate: mapping.effectiveDate || (raw.mapping.effectiveDate as string),\r\n      notes: mapping.notes || (raw.mapping.notes as string),\r\n    }\r\n  }, [raw, mapping])\r\n\r\n  const handleFile = async (file?: File) => {\r\n    if (!file) return\r\n    setBusy(true)\r\n    try {\r\n      const text = await readTextFromFile(file)\r\n      const parsed = detectHeaders(text)\r\n      setRaw(parsed)\r\n      setMapping(parsed.mapping)\r\n      setFileName(file.name)\r\n      setBuilt(undefined)\r\n    } finally {\r\n      setBusy(false)\r\n    }\r\n  }\r\n\r\n  const buildNow = () => {\r\n    if (!raw || !effectiveMapping) return\r\n    const result = buildPriceList(raw.rowsRaw, effectiveMapping)\r\n    setBuilt(result)\r\n  }\r\n\r\n  const apply = async () => {\r\n    if (!built) return\r\n    await onApply(built)\r\n    setOpen(false)\r\n    // reset state after close\r\n    setTimeout(() => {\r\n      setRaw(undefined)\r\n      setMapping({})\r\n      setBuilt(undefined)\r\n      setFileName(undefined)\r\n    }, 300)\r\n  }\r\n\r\n  const headerOptions = raw?.headers ?? []\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={setOpen}>\r\n      <DialogTrigger asChild>\r\n        <Button variant=\"outline\" size=\"sm\">\r\n          <Upload className=\"h-4 w-4 mr-2\" />\r\n          Import Price List\r\n        </Button>\r\n      </DialogTrigger>\r\n      <DialogContent className=\"max-w-4xl\">\r\n        <DialogHeader>\r\n          <DialogTitle>Import Supplier Price List</DialogTitle>\r\n        </DialogHeader>\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4\">\r\n          <div className=\"lg:col-span-1 space-y-4\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"text-base flex items-center gap-2\">\r\n                  <FileSpreadsheet className=\"h-4 w-4\" />\r\n                  File\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-3\">\r\n                <Input\r\n                  ref={fileInputRef}\r\n                  type=\"file\"\r\n                  accept=\".csv,text/csv\"\r\n                  onChange={(e) => handleFile(e.target.files?.[0])}\r\n                />\r\n                {fileName && <div className=\"text-xs text-muted-foreground\">{fileName}</div>}\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Button variant=\"outline\" size=\"sm\" onClick={() => fileInputRef.current?.click()} disabled={busy}>\r\n                    <Upload className=\"h-4 w-4 mr-2\" />\r\n                    Choose CSV\r\n                  </Button>\r\n                  <Button variant=\"ghost\" size=\"sm\" onClick={() => { setRaw(undefined); setBuilt(undefined); setFileName(undefined); }}>\r\n                    <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                    Reset\r\n                  </Button>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {raw && (\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"text-base\">Column Mapping</CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-3\">\r\n                  {([\r\n                    ['sku', 'SKU (required)'],\r\n                    ['unitCost', 'Unit Cost (required)'],\r\n                    ['supplierSku', 'Supplier SKU'],\r\n                    ['supplierId', 'Supplier ID'],\r\n                    ['supplierName', 'Supplier Name'],\r\n                    ['currency', 'Currency'],\r\n                    ['unit', 'Unit/UoM'],\r\n                    ['minQty', 'Min Qty/MOQ'],\r\n                    ['effectiveDate', 'Effective Date'],\r\n                    ['notes', 'Notes'],\r\n                  ] as Array<[keyof PriceListMapping, string]>).map(([key, label]) => (\r\n                    <div key={key} className=\"space-y-1\">\r\n                      <Label className=\"text-xs\">{label}</Label>\r\n                      <Select value={(effectiveMapping as any)?.[key] ?? ''} onValueChange={(v) => setMapping(m => ({ ...m, [key]: v || undefined }))}>\r\n                        <SelectTrigger>\r\n                          <SelectValue placeholder=\"Select column\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          {headerOptions.map(h => (\r\n                            <SelectItem key={h} value={h}>{h}</SelectItem>\r\n                          ))}\r\n                        </SelectContent>\r\n                      </Select>\r\n                    </div>\r\n                  ))}\r\n                  <Button size=\"sm\" onClick={buildNow} disabled={busy}>\r\n                    Build Preview\r\n                  </Button>\r\n                </CardContent>\r\n              </Card>\r\n            )}\r\n          </div>\r\n\r\n          <div className=\"lg:col-span-2 space-y-4\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"text-base\">Preview</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                {!built && <div className=\"text-sm text-muted-foreground\">Upload a CSV and click Build Preview.</div>}\r\n                {built && (\r\n                  <div className=\"space-y-3\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <Badge variant=\"outline\" className=\"border-green-300 text-green-700\">\r\n                        <CheckCircle className=\"h-3 w-3 mr-1\" /> {built.valid} valid\r\n                      </Badge>\r\n                      {built.invalid > 0 && (\r\n                        <Badge variant=\"outline\" className=\"border-orange-300 text-orange-700\">\r\n                          <AlertTriangle className=\"h-3 w-3 mr-1\" /> {built.invalid} invalid\r\n                        </Badge>\r\n                      )}\r\n                      <div className=\"text-xs text-muted-foreground\">Total: {built.total}</div>\r\n                    </div>\r\n                    {built.errors.length > 0 && (\r\n                      <ScrollArea className=\"h-24 border rounded p-2\">\r\n                        <ul className=\"text-xs space-y-1\">\r\n                          {built.errors.slice(0, 50).map((e, i) => (\r\n                            <li key={i} className=\"text-orange-700\">Row {e.rowIndex}: {e.field} - {e.error}</li>\r\n                          ))}\r\n                        </ul>\r\n                      </ScrollArea>\r\n                    )}\r\n                    <div className=\"border rounded\">\r\n                      <ScrollArea className=\"h-72\">\r\n                        <Table>\r\n                          <TableHeader>\r\n                            <TableRow>\r\n                              <TableHead>SKU</TableHead>\r\n                              <TableHead>Supplier SKU</TableHead>\r\n                              <TableHead>Unit Cost</TableHead>\r\n                              <TableHead>Currency</TableHead>\r\n                              <TableHead>Min Qty</TableHead>\r\n                              <TableHead>Effective</TableHead>\r\n                            </TableRow>\r\n                          </TableHeader>\r\n                          <TableBody>\r\n                            {built.rows.slice(0, 200).map((r, i) => (\r\n                              <TableRow key={i}>\r\n                                <TableCell className=\"font-mono text-xs\">{r.sku}</TableCell>\r\n                                <TableCell className=\"font-mono text-xs\">{r.supplierSku}</TableCell>\r\n                                <TableCell className=\"text-right\">{r.unitCost.toFixed(2)}</TableCell>\r\n                                <TableCell>{r.currency}</TableCell>\r\n                                <TableCell>{r.minQty ?? ''}</TableCell>\r\n                                <TableCell>{r.effectiveDate ? r.effectiveDate.toISOString().slice(0, 10) : ''}</TableCell>\r\n                              </TableRow>\r\n                            ))}\r\n                          </TableBody>\r\n                        </Table>\r\n                      </ScrollArea>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <div className=\"flex items-center justify-end gap-2\">\r\n              <Button variant=\"outline\" onClick={() => setOpen(false)}>Cancel</Button>\r\n              <Button onClick={apply} disabled={!built || built.valid === 0}>Apply</Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n\r\nexport default PriceListUploader\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\inventory\\SupplierInventoryView.tsx","messages":[{"ruleId":"no-redeclare","severity":2,"message":"'Skeleton' is already defined.","line":112,"column":7,"nodeType":"Identifier","messageId":"redeclared","endLine":112,"endColumn":15},{"ruleId":"no-import-assign","severity":2,"message":"'Skeleton' is read-only.","line":112,"column":7,"nodeType":"Identifier","messageId":"readonly","endLine":112,"endColumn":15},{"ruleId":"no-redeclare","severity":2,"message":"'Alert' is already defined.","line":116,"column":7,"nodeType":"Identifier","messageId":"redeclared","endLine":116,"endColumn":12},{"ruleId":"no-import-assign","severity":2,"message":"'Alert' is read-only.","line":116,"column":7,"nodeType":"Identifier","messageId":"readonly","endLine":116,"endColumn":12},{"ruleId":"no-redeclare","severity":2,"message":"'AlertDescription' is already defined.","line":126,"column":7,"nodeType":"Identifier","messageId":"redeclared","endLine":126,"endColumn":23},{"ruleId":"no-import-assign","severity":2,"message":"'AlertDescription' is read-only.","line":126,"column":7,"nodeType":"Identifier","messageId":"readonly","endLine":126,"endColumn":23},{"ruleId":"jsx-a11y/no-redundant-roles","severity":2,"message":"The element button has an implicit role of button. Defining this explicitly is redundant and should be avoided.","line":445,"column":25,"nodeType":"JSXOpeningElement","endLine":462,"endColumn":26}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useMemo, useEffect } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Separator } from '@/components/ui/separator'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar'\r\nimport { Skeleton } from '@/components/ui/skeleton'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu'\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from '@/components/ui/tooltip'\r\nimport {\r\n  Search,\r\n  Filter,\r\n  Plus,\r\n  Eye,\r\n  Edit,\r\n  Package,\r\n  Users,\r\n  DollarSign,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  MoreHorizontal,\r\n  ArrowRight,\r\n  RefreshCw,\r\n  Download,\r\n  Upload,\r\n  ShoppingCart,\r\n  Truck,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Clock,\r\n  Star,\r\n  Building2,\r\n  FileText,\r\n  BarChart3,\r\n  Settings,\r\n  Info,\r\n  ExternalLink,\r\n  Zap,\r\n  Activity,\r\n  Globe,\r\n  Mail,\r\n  Phone,\r\n  MapPin,\r\n  Calendar,\r\n  Percent,\r\n  Target\r\n} from 'lucide-react'\r\nimport { allocateToSupplier, deallocateFromSupplier, useInventoryStore } from '@/lib/stores/inventory-store'\r\nimport { useNotificationStore } from '@/lib/stores/notification-store'\r\nimport type { Supplier, Product, InventoryItem } from '@/lib/types/inventory'\r\nimport { format } from 'date-fns'\r\n\r\ninterface EnrichedProduct extends Product {\r\n  inventoryItem?: InventoryItem\r\n  totalStockValue?: number\r\n  stockStatus?: 'in_stock' | 'low_stock' | 'out_of_stock' | 'overstocked'\r\n  supplierInfo?: Supplier\r\n}\r\n\r\ninterface SupplierInventoryData {\r\n  supplier: Supplier\r\n  products: EnrichedProduct[]\r\n  totalValue: number\r\n  totalItems: number\r\n  lowStockCount: number\r\n  outOfStockCount: number\r\n  categories: string[]\r\n  lastUpdated: string\r\n}\r\n\r\n// Add missing UI components\r\nconst Skeleton = ({ className }: { className?: string }) => (\r\n  <div className={`animate-pulse bg-muted rounded ${className}`} />\r\n)\r\n\r\nconst Alert = ({ children, variant = 'default', className }: {\r\n  children: React.ReactNode\r\n  variant?: 'default' | 'destructive'\r\n  className?: string\r\n}) => (\r\n  <div className={`p-4 rounded-lg border ${variant === 'destructive' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-blue-50 border-blue-200 text-blue-800'} ${className}`}>\r\n    {children}\r\n  </div>\r\n)\r\n\r\nconst AlertDescription = ({ children }: { children: React.ReactNode }) => (\r\n  <div className=\"text-sm\">{children}</div>\r\n)\r\n\r\nexport default function SupplierInventoryView() {\r\n  const {\r\n    items,\r\n    products,\r\n    suppliers,\r\n    loading,\r\n    fetchItems,\r\n    fetchProducts,\r\n    fetchSuppliers,\r\n  } = useInventoryStore()\r\n\r\n  const { addNotification } = useNotificationStore()\r\n\r\n  const [selectedSupplier, setSelectedSupplier] = useState<string>('')\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [categoryFilter, setCategoryFilter] = useState<string>('all_categories')\r\n  const [statusFilter, setStatusFilter] = useState<string>('all_statuses')\r\n  const [showAddToInventory, setShowAddToInventory] = useState(false)\r\n  const [selectedProducts, setSelectedProducts] = useState<Set<string>>(new Set())\r\n  const [viewMode, setViewMode] = useState<'grid' | 'table'>('table')\r\n\r\n  useEffect(() => {\r\n    const loadData = async () => {\r\n      try {\r\n        await Promise.all([fetchItems(), fetchProducts(), fetchSuppliers()])\r\n      } catch (error) {\r\n        addNotification({\r\n          type: 'error',\r\n          title: 'Failed to load data',\r\n          message: error instanceof Error ? error.message : 'Unknown error'\r\n        })\r\n      }\r\n    }\r\n    loadData()\r\n  }, [])\r\n\r\n  // Create enriched supplier inventory data\r\n  const supplierInventoryData = useMemo(() => {\r\n    const data: SupplierInventoryData[] = suppliers.map(supplier => {\r\n      const supplierProducts = products.filter(p => p.supplier_id === supplier.id)\r\n\r\n      const enrichedProducts: EnrichedProduct[] = supplierProducts.map(product => {\r\n        const inventoryItem = items.find(item => item.product_id === product.id)\r\n        const totalStockValue = inventoryItem ?\r\n          inventoryItem.current_stock * inventoryItem.cost_per_unit_zar : 0\r\n\r\n        let stockStatus: 'in_stock' | 'low_stock' | 'out_of_stock' | 'overstocked' = 'in_stock'\r\n        if (inventoryItem) {\r\n          if (inventoryItem.current_stock === 0) stockStatus = 'out_of_stock'\r\n          else if (inventoryItem.current_stock <= inventoryItem.reorder_point) stockStatus = 'low_stock'\r\n          else if (inventoryItem.stock_status === 'overstocked') stockStatus = 'overstocked'\r\n        } else {\r\n          stockStatus = 'out_of_stock' // No inventory item means not in stock\r\n        }\r\n\r\n        return {\r\n          ...product,\r\n          inventoryItem,\r\n          totalStockValue,\r\n          stockStatus,\r\n          supplierInfo: supplier\r\n        }\r\n      })\r\n\r\n      const totalValue = enrichedProducts.reduce((sum, p) => sum + (p.totalStockValue || 0), 0)\r\n      const totalItems = enrichedProducts.filter(p => p.inventoryItem).length\r\n      const lowStockCount = enrichedProducts.filter(p => p.stockStatus === 'low_stock').length\r\n      const outOfStockCount = enrichedProducts.filter(p => p.stockStatus === 'out_of_stock').length\r\n      const categories = [...new Set(enrichedProducts.map(p => p.category))]\r\n\r\n      return {\r\n        supplier,\r\n        products: enrichedProducts,\r\n        totalValue,\r\n        totalItems,\r\n        lowStockCount,\r\n        outOfStockCount,\r\n        categories,\r\n        lastUpdated: new Date().toISOString()\r\n      }\r\n    })\r\n\r\n    return data.sort((a, b) => b.totalValue - a.totalValue)\r\n  }, [suppliers, products, items])\r\n\r\n  const selectedSupplierData = useMemo(() => {\r\n    return supplierInventoryData.find(data => data.supplier.id === selectedSupplier)\r\n  }, [supplierInventoryData, selectedSupplier])\r\n\r\n  // Filter products based on search and filters\r\n  const filteredProducts = useMemo(() => {\r\n    if (!selectedSupplierData) return []\r\n\r\n    return selectedSupplierData.products.filter(product => {\r\n      const matchesSearch = !searchTerm ||\r\n        product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        (product.sku && product.sku.toLowerCase().includes(searchTerm.toLowerCase())) ||\r\n        product.description?.toLowerCase().includes(searchTerm.toLowerCase())\r\n\r\n      const matchesCategory = !categoryFilter || categoryFilter === 'all_categories' || product.category === categoryFilter\r\n      const matchesStatus = !statusFilter || statusFilter === 'all_statuses' || product.stockStatus === statusFilter\r\n\r\n      return matchesSearch && matchesCategory && matchesStatus\r\n    })\r\n  }, [selectedSupplierData, searchTerm, categoryFilter, statusFilter])\r\n\r\n  const formatCurrency = (amount: number) => {\r\n    return new Intl.NumberFormat('en-ZA', {\r\n      style: 'currency',\r\n      currency: 'ZAR',\r\n      minimumFractionDigits: 0\r\n    }).format(amount)\r\n  }\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    switch (status) {\r\n      case 'in_stock':\r\n        return <Badge variant=\"default\" className=\"bg-green-100 text-green-800\">In Stock</Badge>\r\n      case 'low_stock':\r\n        return <Badge variant=\"outline\" className=\"border-orange-500 text-orange-700\">Low Stock</Badge>\r\n      case 'out_of_stock':\r\n        return <Badge variant=\"destructive\">Out of Stock</Badge>\r\n      case 'overstocked':\r\n        return <Badge variant=\"secondary\">Overstocked</Badge>\r\n      default:\r\n        return <Badge variant=\"outline\">Unknown</Badge>\r\n    }\r\n  }\r\n\r\n  const handleAddToInventory = async (productIds: string[]) => {\r\n    try {\r\n      // Implementation would depend on your backend API\r\n      addNotification({\r\n        type: 'success',\r\n        title: 'Products added to inventory',\r\n        message: `${productIds.length} products added successfully`\r\n      })\r\n      setSelectedProducts(new Set())\r\n      setShowAddToInventory(false)\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to add products',\r\n        message: error instanceof Error ? error.message : 'Unknown error'\r\n      })\r\n    }\r\n  }\r\n\r\n  const handleAllocate = async (inventoryItemId: string, supplierId: string) => {\r\n    try {\r\n      await allocateToSupplier(inventoryItemId, supplierId, 1)\r\n      addNotification({ type: 'success', title: 'Allocated', message: '1 unit allocated to supplier' })\r\n    } catch (e:any) {\r\n      addNotification({ type: 'error', title: 'Allocation failed', message: e?.message || 'Unknown error' })\r\n    }\r\n  }\r\n  const handleDeallocate = async (inventoryItemId: string, supplierId: string) => {\r\n    try {\r\n      await deallocateFromSupplier(inventoryItemId, supplierId, 1)\r\n      addNotification({ type: 'success', title: 'Deallocated', message: '1 unit deallocated' })\r\n    } catch (e:any) {\r\n      addNotification({ type: 'error', title: 'Deallocation failed', message: e?.message || 'Unknown error' })\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"space-y-6\">\r\n        {/* Header Skeleton */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"space-y-2\">\r\n            <Skeleton className=\"h-8 w-80\" />\r\n            <Skeleton className=\"h-4 w-96\" />\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            <Skeleton className=\"h-9 w-20\" />\r\n            <Skeleton className=\"h-9 w-20\" />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Stats Cards Skeleton */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n          {[1, 2, 3].map(i => (\r\n            <Card key={i}>\r\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                <Skeleton className=\"h-4 w-20\" />\r\n                <Skeleton className=\"h-4 w-4\" />\r\n              </CardHeader>\r\n              <CardContent>\r\n                <Skeleton className=\"h-8 w-16 mb-1\" />\r\n                <Skeleton className=\"h-3 w-24\" />\r\n              </CardContent>\r\n            </Card>\r\n          ))}\r\n        </div>\r\n\r\n        {/* Main Content Skeleton */}\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\r\n          <Card className=\"lg:col-span-1\">\r\n            <CardHeader>\r\n              <Skeleton className=\"h-6 w-20\" />\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              {[1, 2, 3, 4].map(i => (\r\n                <div key={i} className=\"p-3 rounded\">\r\n                  <Skeleton className=\"h-5 w-32 mb-2\" />\r\n                  <div className=\"space-y-1\">\r\n                    <Skeleton className=\"h-3 w-20\" />\r\n                    <Skeleton className=\"h-3 w-24\" />\r\n                    <Skeleton className=\"h-3 w-16\" />\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </CardContent>\r\n          </Card>\r\n          <Card className=\"lg:col-span-3\">\r\n            <CardContent className=\"h-64\">\r\n              <div className=\"flex items-center justify-center h-full\">\r\n                <RefreshCw className=\"h-8 w-8 animate-spin text-muted-foreground\" />\r\n                <span className=\"ml-3 text-muted-foreground\">Loading supplier inventory data...</span>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold tracking-tight\">Supplier Inventory Management</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Manage inventory by supplier with detailed product information and stock management\r\n          </p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <Download className=\"h-4 w-4 mr-2\" />\r\n            Export\r\n          </Button>\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <Upload className=\"h-4 w-4 mr-2\" />\r\n            Import\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Supplier Overview Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Suppliers</CardTitle>\r\n            <Building2 className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{supplierInventoryData.length}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Active suppliers with inventory\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Inventory Value</CardTitle>\r\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">\r\n              {formatCurrency(supplierInventoryData.reduce((sum, data) => sum + data.totalValue, 0))}\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Across all suppliers\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Stock Alerts</CardTitle>\r\n            <AlertTriangle className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold text-orange-600\">\r\n              {supplierInventoryData.reduce((sum, data) => sum + data.lowStockCount + data.outOfStockCount, 0)}\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Items requiring attention\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\r\n        {/* Supplier List */}\r\n        <Card className=\"lg:col-span-1\">\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <Users className=\"h-5 w-5\" />\r\n              Suppliers\r\n              <Badge variant=\"secondary\" className=\"ml-auto\">\r\n                {supplierInventoryData.length}\r\n              </Badge>\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent className=\"p-0\">\r\n            <div className=\"max-h-[600px] overflow-y-auto\">\r\n              <div className=\"space-y-1\">\r\n                {supplierInventoryData.map((data) => (\r\n                  <TooltipProvider key={data.supplier.id}>\r\n                    <Tooltip>\r\n                      <TooltipTrigger asChild>\r\n                        <button\r\n                          className={`w-full text-left p-4 hover:bg-muted/80 transition-all duration-200 group relative focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 ${\r\n                            selectedSupplier === data.supplier.id\r\n                              ? 'bg-primary/10 border-r-3 border-primary shadow-sm'\r\n                              : 'hover:shadow-sm'\r\n                          }`}\r\n                          onClick={() => setSelectedSupplier(data.supplier.id)}\r\n                          onKeyDown={(e) => {\r\n                            if (e.key === 'Enter' || e.key === ' ') {\r\n                              e.preventDefault()\r\n                              setSelectedSupplier(data.supplier.id)\r\n                            }\r\n                          }}\r\n                          tabIndex={0}\r\n                          role=\"button\"\r\n                          aria-pressed={selectedSupplier === data.supplier.id}\r\n                          aria-label={`Select supplier ${data.supplier.name} with ${data.products.length} products and ${formatCurrency(data.totalValue)} total value`}\r\n                        >\r\n                          <div className=\"flex items-start justify-between mb-2\">\r\n                            <div className=\"flex items-center gap-3\">\r\n                              <Avatar className=\"h-8 w-8\">\r\n                                <AvatarFallback className=\"text-xs font-semibold bg-gradient-to-br from-blue-500 to-purple-600 text-white\">\r\n                                  {data.supplier.name.split(' ').map(n => n[0]).join('').substr(0, 2)}\r\n                                </AvatarFallback>\r\n                              </Avatar>\r\n                              <div>\r\n                                <p className=\"font-medium truncate text-sm leading-tight\">{data.supplier.name}</p>\r\n                                <div className=\"flex items-center gap-1 mt-1\">\r\n                                  {data.supplier.preferred_supplier && (\r\n                                    <Star className=\"h-3 w-3 text-yellow-500 fill-current\" />\r\n                                  )}\r\n                                  <Badge\r\n                                    variant={data.supplier.performance_tier === 'platinum' ? 'default' : 'outline'}\r\n                                    className=\"text-xs py-0 px-1.5\"\r\n                                  >\r\n                                    {data.supplier.performance_tier?.toUpperCase()}\r\n                                  </Badge>\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"grid grid-cols-2 gap-2 text-xs text-muted-foreground mb-2\">\r\n                            <div className=\"flex items-center gap-1\">\r\n                              <Package className=\"h-3 w-3\" />\r\n                              <span>{data.products.length}</span>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-1\">\r\n                              <CheckCircle className=\"h-3 w-3\" />\r\n                              <span>{data.totalItems}</span>\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-sm font-semibold text-green-600\">\r\n                              {formatCurrency(data.totalValue)}\r\n                            </span>\r\n                            {(data.lowStockCount + data.outOfStockCount) > 0 && (\r\n                              <Badge variant=\"outline\" className=\"text-xs border-orange-500 text-orange-700 bg-orange-50\">\r\n                                <AlertTriangle className=\"h-3 w-3 mr-1\" />\r\n                                {data.lowStockCount + data.outOfStockCount}\r\n                              </Badge>\r\n                            )}\r\n                          </div>\r\n\r\n                          {/* Progress Bar */}\r\n                          <div className=\"mt-2\">\r\n                            <Progress\r\n                              value={(data.totalItems / data.products.length) * 100}\r\n                              className=\"h-1.5\"\r\n                            />\r\n                            <div className=\"flex justify-between text-xs text-muted-foreground mt-1\">\r\n                              <span>{Math.round((data.totalItems / data.products.length) * 100)}% stocked</span>\r\n                            </div>\r\n                          </div>\r\n                        </button>\r\n                      </TooltipTrigger>\r\n                      <TooltipContent side=\"right\" className=\"p-3 max-w-xs\">\r\n                        <div className=\"space-y-2\">\r\n                          <p className=\"font-medium\">{data.supplier.name}</p>\r\n                          <div className=\"text-xs space-y-1\">\r\n                            <div className=\"flex justify-between\">\r\n                              <span>Products:</span>\r\n                              <span>{data.products.length}</span>\r\n                            </div>\r\n                            <div className=\"flex justify-between\">\r\n                              <span>In Stock:</span>\r\n                              <span>{data.totalItems}</span>\r\n                            </div>\r\n                            <div className=\"flex justify-between\">\r\n                              <span>Total Value:</span>\r\n                              <span>{formatCurrency(data.totalValue)}</span>\r\n                            </div>\r\n                            <div className=\"flex justify-between\">\r\n                              <span>Categories:</span>\r\n                              <span>{data.categories.length}</span>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </TooltipContent>\r\n                    </Tooltip>\r\n                  </TooltipProvider>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Supplier Detail */}\r\n        <div className=\"lg:col-span-3\">\r\n          {selectedSupplierData ? (\r\n            <div className=\"space-y-6\">\r\n              {/* Supplier Header */}\r\n              <Card className=\"border-0 shadow-md bg-gradient-to-r from-white to-gray-50\">\r\n                <CardHeader>\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-6\">\r\n                      <div className=\"relative\">\r\n                        <Avatar className=\"h-16 w-16 border-4 border-white shadow-lg\">\r\n                          <AvatarFallback className=\"text-lg font-bold bg-gradient-to-br from-blue-600 to-purple-700 text-white\">\r\n                            {selectedSupplierData.supplier.name.split(' ').map(n => n[0]).join('').substr(0, 2)}\r\n                          </AvatarFallback>\r\n                        </Avatar>\r\n                        {selectedSupplierData.supplier.preferred_supplier && (\r\n                          <div className=\"absolute -top-1 -right-1 bg-yellow-500 rounded-full p-1\">\r\n                            <Star className=\"h-3 w-3 text-white fill-current\" />\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"space-y-2\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                          <CardTitle className=\"text-2xl bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent\">\r\n                            {selectedSupplierData.supplier.name}\r\n                          </CardTitle>\r\n                          <div className=\"flex gap-2\">\r\n                            <Badge variant=\"default\" className=\"bg-green-100 text-green-800 border-green-300\">\r\n                              {selectedSupplierData.supplier.status?.toUpperCase()}\r\n                            </Badge>\r\n                            {selectedSupplierData.supplier.performance_tier && (\r\n                              <Badge\r\n                                variant={selectedSupplierData.supplier.performance_tier === 'platinum' ? 'default' : 'outline'}\r\n                                className={selectedSupplierData.supplier.performance_tier === 'platinum'\r\n                                  ? 'bg-purple-100 text-purple-800 border-purple-300'\r\n                                  : ''\r\n                                }\r\n                              >\r\n                                <Target className=\"h-3 w-3 mr-1\" />\r\n                                {selectedSupplierData.supplier.performance_tier?.toUpperCase()}\r\n                              </Badge>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"grid grid-cols-3 gap-6 text-sm\">\r\n                          <div className=\"flex items-center gap-2 text-muted-foreground\">\r\n                            <Package className=\"h-4 w-4\" />\r\n                            <span>{selectedSupplierData.products.length} Products</span>\r\n                          </div>\r\n                          <div className=\"flex items-center gap-2 text-muted-foreground\">\r\n                            <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n                            <span>{selectedSupplierData.totalItems} In Stock</span>\r\n                          </div>\r\n                          <div className=\"flex items-center gap-2 text-muted-foreground\">\r\n                            <BarChart3 className=\"h-4 w-4\" />\r\n                            <span>{selectedSupplierData.categories.length} Categories</span>\r\n                          </div>\r\n                        </div>\r\n                        {selectedSupplierData.supplier.email && (\r\n                          <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\r\n                            <div className=\"flex items-center gap-1\">\r\n                              <Mail className=\"h-3 w-3\" />\r\n                              <span>{selectedSupplierData.supplier.email}</span>\r\n                            </div>\r\n                            {selectedSupplierData.supplier.phone && (\r\n                              <div className=\"flex items-center gap-1\">\r\n                                <Phone className=\"h-3 w-3\" />\r\n                                <span>{selectedSupplierData.supplier.phone}</span>\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"flex gap-2\">\r\n                      <TooltipProvider>\r\n                        <Tooltip>\r\n                          <TooltipTrigger asChild>\r\n                            <Button\r\n                              variant=\"outline\"\r\n                              size=\"sm\"\r\n                              className=\"hover:bg-blue-50 focus:ring-2 focus:ring-blue-500 focus:ring-offset-1\"\r\n                              aria-label={`View detailed information for ${selectedSupplierData.supplier.name}`}\r\n                            >\r\n                              <Eye className=\"h-4 w-4 mr-2\" aria-hidden=\"true\" />\r\n                              Details\r\n                            </Button>\r\n                          </TooltipTrigger>\r\n                          <TooltipContent>\r\n                            <p>View detailed supplier information</p>\r\n                          </TooltipContent>\r\n                        </Tooltip>\r\n                      </TooltipProvider>\r\n\r\n                      <TooltipProvider>\r\n                        <Tooltip>\r\n                          <TooltipTrigger asChild>\r\n                            <Button\r\n                              variant=\"outline\"\r\n                              size=\"sm\"\r\n                              className=\"hover:bg-green-50 focus:ring-2 focus:ring-green-500 focus:ring-offset-1\"\r\n                              aria-label={`Edit supplier information for ${selectedSupplierData.supplier.name}`}\r\n                            >\r\n                              <Edit className=\"h-4 w-4 mr-2\" aria-hidden=\"true\" />\r\n                              Edit\r\n                            </Button>\r\n                          </TooltipTrigger>\r\n                          <TooltipContent>\r\n                            <p>Edit supplier details</p>\r\n                          </TooltipContent>\r\n                        </Tooltip>\r\n                      </TooltipProvider>\r\n\r\n                      <DropdownMenu>\r\n                        <DropdownMenuTrigger asChild>\r\n                          <Button\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            aria-label={`More options for ${selectedSupplierData.supplier.name}`}\r\n                          >\r\n                            <MoreHorizontal className=\"h-4 w-4\" aria-hidden=\"true\" />\r\n                          </Button>\r\n                        </DropdownMenuTrigger>\r\n                        <DropdownMenuContent align=\"end\">\r\n                          <DropdownMenuItem>\r\n                            <ExternalLink className=\"h-4 w-4 mr-2\" />\r\n                            Visit Website\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <FileText className=\"h-4 w-4 mr-2\" />\r\n                            View Contract\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          <DropdownMenuItem>\r\n                            <Settings className=\"h-4 w-4 mr-2\" />\r\n                            Supplier Settings\r\n                          </DropdownMenuItem>\r\n                        </DropdownMenuContent>\r\n                      </DropdownMenu>\r\n                    </div>\r\n                  </div>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"grid grid-cols-4 gap-6\">\r\n                    <div className=\"text-center p-4 rounded-lg bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200\">\r\n                      <div className=\"flex items-center justify-center mb-2\">\r\n                        <DollarSign className=\"h-6 w-6 text-green-600 mr-1\" />\r\n                        <div className=\"text-2xl font-bold text-green-700\">\r\n                          {formatCurrency(selectedSupplierData.totalValue)}\r\n                        </div>\r\n                      </div>\r\n                      <p className=\"text-sm font-medium text-green-600\">Total Value</p>\r\n                      <div className=\"mt-2\">\r\n                        <Progress\r\n                          value={75}\r\n                          className=\"h-2 bg-green-100\"\r\n                        />\r\n                        <p className=\"text-xs text-green-500 mt-1\">+12% vs last month</p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"text-center p-4 rounded-lg bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200\">\r\n                      <div className=\"flex items-center justify-center mb-2\">\r\n                        <CheckCircle className=\"h-6 w-6 text-blue-600 mr-1\" />\r\n                        <div className=\"text-2xl font-bold text-blue-700\">\r\n                          {selectedSupplierData.totalItems}\r\n                        </div>\r\n                      </div>\r\n                      <p className=\"text-sm font-medium text-blue-600\">Items in Stock</p>\r\n                      <div className=\"mt-2\">\r\n                        <Progress\r\n                          value={(selectedSupplierData.totalItems / selectedSupplierData.products.length) * 100}\r\n                          className=\"h-2 bg-blue-100\"\r\n                        />\r\n                        <p className=\"text-xs text-blue-500 mt-1\">\r\n                          {Math.round((selectedSupplierData.totalItems / selectedSupplierData.products.length) * 100)}% coverage\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"text-center p-4 rounded-lg bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200\">\r\n                      <div className=\"flex items-center justify-center mb-2\">\r\n                        <AlertTriangle className=\"h-6 w-6 text-orange-600 mr-1\" />\r\n                        <div className=\"text-2xl font-bold text-orange-700\">\r\n                          {selectedSupplierData.lowStockCount}\r\n                        </div>\r\n                      </div>\r\n                      <p className=\"text-sm font-medium text-orange-600\">Low Stock</p>\r\n                      <div className=\"mt-2\">\r\n                        <Progress\r\n                          value={(selectedSupplierData.lowStockCount / selectedSupplierData.totalItems) * 100}\r\n                          className=\"h-2 bg-orange-100\"\r\n                        />\r\n                        <p className=\"text-xs text-orange-500 mt-1\">\r\n                          {selectedSupplierData.lowStockCount > 0 ? 'Needs attention' : 'All good'}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <div className=\"text-center p-4 rounded-lg bg-gradient-to-br from-red-50 to-pink-50 border border-red-200\">\r\n                      <div className=\"flex items-center justify-center mb-2\">\r\n                        <Package className=\"h-6 w-6 text-red-600 mr-1\" />\r\n                        <div className=\"text-2xl font-bold text-red-700\">\r\n                          {selectedSupplierData.outOfStockCount}\r\n                        </div>\r\n                      </div>\r\n                      <p className=\"text-sm font-medium text-red-600\">Out of Stock</p>\r\n                      <div className=\"mt-2\">\r\n                        <Progress\r\n                          value={selectedSupplierData.outOfStockCount > 0 ? 100 : 0}\r\n                          className=\"h-2 bg-red-100\"\r\n                        />\r\n                        <p className=\"text-xs text-red-500 mt-1\">\r\n                          {selectedSupplierData.outOfStockCount > 0 ? 'Urgent action' : 'No issues'}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Enhanced Filters */}\r\n              <Card className=\"border-0 shadow-sm\">\r\n                <CardContent className=\"p-6\">\r\n                  <div className=\"space-y-4\">\r\n                    {/* Search and Quick Actions */}\r\n                    <div className=\"flex items-center gap-4\">\r\n                      <div className=\"relative flex-1\">\r\n                        <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                        <Input\r\n                          placeholder=\"Search products, SKUs, or descriptions...\"\r\n                          value={searchTerm}\r\n                          onChange={(e) => setSearchTerm(e.target.value)}\r\n                          className=\"pl-10 pr-10 h-10 border-2 focus:border-primary transition-all\"\r\n                          aria-label=\"Search products by name, SKU, or description\"\r\n                          aria-describedby=\"search-help\"\r\n                        />\r\n                        <div id=\"search-help\" className=\"sr-only\">\r\n                          Search through all products for the selected supplier by name, SKU, or description\r\n                        </div>\r\n                        {searchTerm && (\r\n                          <button\r\n                            onClick={() => setSearchTerm('')}\r\n                            className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                          >\r\n                            ×\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n\r\n                      {/* Quick Filter Badges */}\r\n                      <div className=\"flex gap-2\">\r\n                        <Button\r\n                          variant={statusFilter === 'low_stock' ? 'default' : 'outline'}\r\n                          size=\"sm\"\r\n                          onClick={() => setStatusFilter(statusFilter === 'low_stock' ? 'all_statuses' : 'low_stock')}\r\n                          className={statusFilter === 'low_stock' ? 'bg-orange-600' : ''}\r\n                          aria-pressed={statusFilter === 'low_stock'}\r\n                          aria-label=\"Filter products with low stock levels\"\r\n                        >\r\n                          <AlertTriangle className=\"h-3 w-3 mr-1\" aria-hidden=\"true\" />\r\n                          Low Stock\r\n                        </Button>\r\n                        <Button\r\n                          variant={statusFilter === 'out_of_stock' ? 'default' : 'outline'}\r\n                          size=\"sm\"\r\n                          onClick={() => setStatusFilter(statusFilter === 'out_of_stock' ? 'all_statuses' : 'out_of_stock')}\r\n                          className={statusFilter === 'out_of_stock' ? 'bg-red-600' : ''}\r\n                          aria-pressed={statusFilter === 'out_of_stock'}\r\n                          aria-label=\"Filter products that are out of stock\"\r\n                        >\r\n                          <Package className=\"h-3 w-3 mr-1\" aria-hidden=\"true\" />\r\n                          Out of Stock\r\n                        </Button>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Detailed Filters */}\r\n                    <div className=\"flex items-center gap-4\">\r\n                      <Select value={categoryFilter} onValueChange={setCategoryFilter}>\r\n                        <SelectTrigger className=\"w-56\" aria-label=\"Filter by product category\">\r\n                          <Filter className=\"h-4 w-4 mr-2\" aria-hidden=\"true\" />\r\n                          <SelectValue placeholder=\"All categories\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          <SelectItem value=\"all_categories\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <BarChart3 className=\"h-4 w-4\" />\r\n                              All categories\r\n                            </div>\r\n                          </SelectItem>\r\n                          {selectedSupplierData.categories.map(category => (\r\n                            <SelectItem key={category} value={category}>\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <div className=\"w-2 h-2 rounded-full bg-blue-500\" />\r\n                                {category.replace('_', ' ').toUpperCase()}\r\n                              </div>\r\n                            </SelectItem>\r\n                          ))}\r\n                        </SelectContent>\r\n                      </Select>\r\n\r\n                      <Select value={statusFilter} onValueChange={setStatusFilter}>\r\n                        <SelectTrigger className=\"w-48\" aria-label=\"Filter by stock status\">\r\n                          <Activity className=\"h-4 w-4 mr-2\" aria-hidden=\"true\" />\r\n                          <SelectValue placeholder=\"All statuses\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          <SelectItem value=\"all_statuses\">All statuses</SelectItem>\r\n                          <SelectItem value=\"in_stock\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <CheckCircle className=\"h-4 w-4 text-green-600\" />\r\n                              In Stock\r\n                            </div>\r\n                          </SelectItem>\r\n                          <SelectItem value=\"low_stock\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <AlertTriangle className=\"h-4 w-4 text-orange-600\" />\r\n                              Low Stock\r\n                            </div>\r\n                          </SelectItem>\r\n                          <SelectItem value=\"out_of_stock\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Package className=\"h-4 w-4 text-red-600\" />\r\n                              Out of Stock\r\n                            </div>\r\n                          </SelectItem>\r\n                          <SelectItem value=\"overstocked\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <TrendingUp className=\"h-4 w-4 text-blue-600\" />\r\n                              Overstocked\r\n                            </div>\r\n                          </SelectItem>\r\n                        </SelectContent>\r\n                      </Select>\r\n\r\n                      {selectedProducts.size > 0 && (\r\n                        <Button\r\n                          onClick={() => setShowAddToInventory(true)}\r\n                          className=\"whitespace-nowrap bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 shadow-lg\"\r\n                        >\r\n                          <Plus className=\"h-4 w-4 mr-2\" />\r\n                          Add to Inventory ({selectedProducts.size})\r\n                        </Button>\r\n                      )}\r\n                    </div>\r\n\r\n                    {/* Results Summary */}\r\n                    {(searchTerm || categoryFilter !== 'all_categories' || statusFilter !== 'all_statuses') && (\r\n                      <div className=\"flex items-center justify-between pt-2 border-t\">\r\n                        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                          <Info className=\"h-4 w-4\" />\r\n                          <span>Showing {filteredProducts.length} of {selectedSupplierData.products.length} products</span>\r\n                        </div>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"sm\"\r\n                          onClick={() => {\r\n                            setSearchTerm('')\r\n                            setCategoryFilter('all_categories')\r\n                            setStatusFilter('all_statuses')\r\n                          }}\r\n                        >\r\n                          Clear filters\r\n                        </Button>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Products Table */}\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Package className=\"h-5 w-5\" />\r\n                    Products ({filteredProducts.length})\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <Table>\r\n                    <TableHeader>\r\n                      <TableRow>\r\n                        <TableHead className=\"w-12\">\r\n                      <span className=\"sr-only\">Select</span>\r\n                    </TableHead>\r\n                        <TableHead>Product</TableHead>\r\n                        <TableHead>Category</TableHead>\r\n                        <TableHead>Current Stock</TableHead>\r\n                        <TableHead className=\"text-right\">Unit Cost</TableHead>\r\n                        <TableHead className=\"text-right\">Total Value</TableHead>\r\n                        <TableHead>Status</TableHead>\r\n                        <TableHead className=\"text-center\">\r\n                      <span>Actions</span>\r\n                      <span className=\"sr-only\">, sortable column</span>\r\n                    </TableHead>\r\n                      </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                      {filteredProducts.map((product) => (\r\n                        <TableRow key={product.id}>\r\n                          <TableCell>\r\n                            <input\r\n                              type=\"checkbox\"\r\n                              checked={selectedProducts.has(product.id)}\r\n                              onChange={(e) => {\r\n                                const newSelection = new Set(selectedProducts)\r\n                                if (e.target.checked) {\r\n                                  newSelection.add(product.id)\r\n                                } else {\r\n                                  newSelection.delete(product.id)\r\n                                }\r\n                                setSelectedProducts(newSelection)\r\n                              }}\r\n                              className=\"rounded focus:ring-2 focus:ring-primary focus:ring-offset-1\"\r\n                              aria-label={`Select product ${product.name}`}\r\n                              aria-describedby={`product-${product.id}-details`}\r\n                            />\r\n                            <div id={`product-${product.id}-details`} className=\"sr-only\">\r\n                              {product.name} - {product.stockStatus} - {product.inventoryItem ? `${product.inventoryItem.current_stock} ${product.unit_of_measure} in stock` : 'Not in inventory'}\r\n                            </div>\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            <div>\r\n                              <p className=\"font-medium\">{product.name}</p>\r\n                              {product.sku && (\r\n                                <code className=\"text-sm text-muted-foreground\">{product.sku}</code>\r\n                              )}\r\n                              {product.description && (\r\n                                <p className=\"text-sm text-muted-foreground\">\r\n                                  {product.description.length > 50\r\n                                    ? `${product.description.substring(0, 50)}...`\r\n                                    : product.description\r\n                                  }\r\n                                </p>\r\n                              )}\r\n                            </div>\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            <Badge variant=\"outline\">\r\n                              {product.category.replace('_', ' ').toUpperCase()}\r\n                            </Badge>\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            {product.inventoryItem ? (\r\n                              <div>\r\n                                <p className=\"font-medium\">\r\n                                  {product.inventoryItem.current_stock} {product.unit_of_measure}\r\n                                </p>\r\n                                <p className=\"text-xs text-muted-foreground\">\r\n                                  Reorder: {product.inventoryItem.reorder_point}\r\n                                </p>\r\n                              </div>\r\n                            ) : (\r\n                              <span className=\"text-muted-foreground\">Not in inventory</span>\r\n                            )}\r\n                          </TableCell>\r\n                          <TableCell className=\"text-right\">\r\n                            {formatCurrency(product.unit_cost_zar)}\r\n                          </TableCell>\r\n                          <TableCell className=\"text-right\">\r\n                            {product.totalStockValue ? formatCurrency(product.totalStockValue) : '-'}\r\n                          </TableCell>\r\n                          <TableCell>\r\n                            {getStatusBadge(product.stockStatus || 'unknown')}\r\n                          </TableCell>\r\n                          <TableCell className=\"text-center\">\r\n                            <DropdownMenu>\r\n                              <DropdownMenuTrigger asChild>\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  aria-label={`More actions for ${product.name}`}\r\n                                >\r\n                                  <MoreHorizontal className=\"h-4 w-4\" aria-hidden=\"true\" />\r\n                                </Button>\r\n                              </DropdownMenuTrigger>\r\n                              <DropdownMenuContent align=\"end\">\r\n                                <DropdownMenuItem>\r\n                                  <Eye className=\"h-4 w-4 mr-2\" />\r\n                                  View Details\r\n                                </DropdownMenuItem>\r\n                                <DropdownMenuItem>\r\n                                  <Edit className=\"h-4 w-4 mr-2\" />\r\n                                  Edit Product\r\n                                </DropdownMenuItem>\r\n                                <DropdownMenuSeparator />\r\n                                {product.inventoryItem ? (\r\n                                  <DropdownMenuItem>\r\n                                    <BarChart3 className=\"h-4 w-4 mr-2\" />\r\n                                    Adjust Stock\r\n                                  </DropdownMenuItem>\r\n                                ) : (\r\n                                  <DropdownMenuItem>\r\n                                    <Plus className=\"h-4 w-4 mr-2\" />\r\n                                    Add to Inventory\r\n                                  </DropdownMenuItem>\r\n                                )}\r\n                                <DropdownMenuItem>\r\n                                  <ShoppingCart className=\"h-4 w-4 mr-2\" />\r\n                                  Create Order\r\n                                </DropdownMenuItem>\r\n                              </DropdownMenuContent>\r\n                            </DropdownMenu>\r\n                          </TableCell>\r\n                        </TableRow>\r\n                      ))}\r\n                    </TableBody>\r\n                  </Table>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n          ) : (\r\n            <Card className=\"lg:col-span-3 border-dashed border-2\">\r\n              <CardContent className=\"flex items-center justify-center h-96\">\r\n                <div className=\"text-center space-y-6\">\r\n                  <div className=\"relative\">\r\n                    <div className=\"absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full opacity-20 animate-pulse\" />\r\n                    <Building2 className=\"h-16 w-16 mx-auto text-muted-foreground relative z-10\" />\r\n                  </div>\r\n                  <div className=\"space-y-3\">\r\n                    <h3 className=\"text-xl font-semibold text-gray-900\">Select a Supplier</h3>\r\n                    <p className=\"text-muted-foreground max-w-md mx-auto\">\r\n                      Choose a supplier from the list on the left to view their complete inventory details,\r\n                      product catalog, and stock management information.\r\n                    </p>\r\n                  </div>\r\n                  <div className=\"flex items-center justify-center gap-4 text-sm text-muted-foreground\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <div className=\"w-3 h-3 bg-green-500 rounded-full\" />\r\n                      <span>In Stock</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <div className=\"w-3 h-3 bg-orange-500 rounded-full\" />\r\n                      <span>Low Stock</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <div className=\"w-3 h-3 bg-red-500 rounded-full\" />\r\n                      <span>Out of Stock</span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Quick Stats Preview */}\r\n                  <div className=\"grid grid-cols-3 gap-4 pt-6 border-t max-w-md mx-auto\">\r\n                    <div className=\"text-center\">\r\n                      <div className=\"text-2xl font-bold text-blue-600\">\r\n                        {supplierInventoryData.length}\r\n                      </div>\r\n                      <p className=\"text-xs text-muted-foreground\">Suppliers</p>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                      <div className=\"text-2xl font-bold text-green-600\">\r\n                        {supplierInventoryData.reduce((sum, data) => sum + data.totalItems, 0)}\r\n                      </div>\r\n                      <p className=\"text-xs text-muted-foreground\">Items in Stock</p>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                      <div className=\"text-2xl font-bold text-purple-600\">\r\n                        {formatCurrency(supplierInventoryData.reduce((sum, data) => sum + data.totalValue, 0))}\r\n                      </div>\r\n                      <p className=\"text-xs text-muted-foreground\">Total Value</p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Add to Inventory Dialog */}\r\n      <Dialog open={showAddToInventory} onOpenChange={setShowAddToInventory}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Add Products to Inventory</DialogTitle>\r\n            <DialogDescription>\r\n              Add {selectedProducts.size} selected products to the main inventory system.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n            <div className=\"bg-muted/50 p-4 rounded-lg\">\r\n              <h4 className=\"font-medium mb-2\">Selected Products:</h4>\r\n              <ul className=\"space-y-1\">\r\n                {Array.from(selectedProducts).map(productId => {\r\n                  const product = products.find(p => p.id === productId)\r\n                  return product ? (\r\n                    <li key={productId} className=\"text-sm\">{product.name}</li>\r\n                  ) : null\r\n                })}\r\n              </ul>\r\n            </div>\r\n            <div className=\"flex justify-end gap-2\">\r\n              <Button variant=\"outline\" onClick={() => setShowAddToInventory(false)}>\r\n                Cancel\r\n              </Button>\r\n              <Button onClick={() => handleAddToInventory(Array.from(selectedProducts))}>\r\n                Add to Inventory\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\loyalty\\admin\\RewardCatalogManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":857,"column":21,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":860,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":873,"column":17,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":876,"endColumn":19}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport React, { useState, useMemo } from 'react'\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'\nimport { useForm } from 'react-hook-form'\nimport { zodResolver } from '@hookform/resolvers/zod'\nimport { z } from 'zod'\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Badge } from '@/components/ui/badge'\nimport { Skeleton } from '@/components/ui/skeleton'\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select'\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n} from '@/components/ui/dialog'\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu'\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from '@/components/ui/form'\nimport { Switch } from '@/components/ui/switch'\nimport { Label } from '@/components/ui/label'\nimport {\n  Search,\n  Plus,\n  MoreHorizontal,\n  Edit,\n  Trash2,\n  Package,\n  Star,\n  TrendingUp,\n  DollarSign,\n  Gift,\n  Truck,\n  ArrowUpCircle,\n  Percent,\n  AlertCircle,\n  Filter,\n  Download,\n  ChevronLeft,\n  ChevronRight,\n} from 'lucide-react'\nimport { toast } from 'sonner'\nimport { format } from 'date-fns'\nimport type { RewardCatalog, RewardType, RewardAnalytics } from '@/types/loyalty'\n\nconst rewardSchema = z.object({\n  name: z.string().min(1, 'Name is required').max(200),\n  description: z.string().optional(),\n  reward_type: z.enum(['points', 'discount', 'cashback', 'free_shipping', 'upgrade', 'gift']),\n  points_required: z.number().min(1, 'Points required must be positive'),\n  monetary_value: z.number().min(0).optional().nullable(),\n  max_redemptions_per_customer: z.number().min(1).optional().nullable(),\n  stock_quantity: z.number().min(0).optional().nullable(),\n  is_active: z.boolean().default(true),\n  is_featured: z.boolean().default(false),\n  valid_from: z.string().optional(),\n  valid_until: z.string().optional().nullable(),\n  image_url: z.string().url().optional().nullable().or(z.literal('')),\n})\n\ntype RewardFormData = z.infer<typeof rewardSchema>\n\nconst REWARD_TYPE_ICONS: Record<RewardType, any> = {\n  points: Gift,\n  discount: Percent,\n  cashback: DollarSign,\n  free_shipping: Truck,\n  upgrade: ArrowUpCircle,\n  gift: Package,\n}\n\nconst REWARD_TYPE_COLORS: Record<RewardType, string> = {\n  points: 'bg-purple-500',\n  discount: 'bg-green-500',\n  cashback: 'bg-blue-500',\n  free_shipping: 'bg-orange-500',\n  upgrade: 'bg-pink-500',\n  gift: 'bg-yellow-500',\n}\n\nexport default function RewardCatalogManager() {\n  const [search, setSearch] = useState('')\n  const [typeFilter, setTypeFilter] = useState<RewardType | 'all'>('all')\n  const [statusFilter, setStatusFilter] = useState<'all' | 'active' | 'inactive'>('all')\n  const [selectedReward, setSelectedReward] = useState<RewardCatalog | null>(null)\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false)\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false)\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false)\n  const [isStockDialogOpen, setIsStockDialogOpen] = useState(false)\n  const [isAnalyticsDialogOpen, setIsAnalyticsDialogOpen] = useState(false)\n  const [page, setPage] = useState(1)\n  const pageSize = 10\n\n  const queryClient = useQueryClient()\n\n  // Fetch rewards\n  const { data: rewards, isLoading } = useQuery({\n    queryKey: ['rewards'],\n    queryFn: async () => {\n      const res = await fetch('/api/v1/admin/loyalty/rewards')\n      if (!res.ok) throw new Error('Failed to fetch rewards')\n      const response = await res.json()\n      // API returns paginated response { success: true, data: [...], pagination: {...} }\n      return (response.data || []) as RewardCatalog[]\n    },\n  })\n\n  // Fetch analytics for selected reward\n  const { data: analytics } = useQuery({\n    queryKey: ['reward-analytics', selectedReward?.id],\n    queryFn: async () => {\n      const res = await fetch(`/api/v1/admin/loyalty/rewards/${selectedReward!.id}/analytics`)\n      if (!res.ok) throw new Error('Failed to fetch analytics')\n      return res.json() as Promise<RewardAnalytics>\n    },\n    enabled: !!selectedReward && isAnalyticsDialogOpen,\n  })\n\n  // Form\n  const form = useForm<RewardFormData>({\n    resolver: zodResolver(rewardSchema),\n    defaultValues: {\n      name: '',\n      description: '',\n      reward_type: 'gift',\n      points_required: 100,\n      monetary_value: null,\n      max_redemptions_per_customer: null,\n      stock_quantity: null,\n      is_active: true,\n      is_featured: false,\n      valid_from: new Date().toISOString().split('T')[0],\n      valid_until: null,\n      image_url: '',\n    },\n  })\n\n  // Create mutation\n  const createMutation = useMutation({\n    mutationFn: async (data: RewardFormData) => {\n      const res = await fetch('/api/v1/admin/loyalty/rewards', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          ...data,\n          valid_from: data.valid_from ? new Date(data.valid_from) : undefined,\n          valid_until: data.valid_until ? new Date(data.valid_until) : undefined,\n        }),\n      })\n      if (!res.ok) {\n        const error = await res.json()\n        throw new Error(error.error || 'Failed to create reward')\n      }\n      return res.json()\n    },\n    onSuccess: () => {\n      toast.success('Reward created successfully')\n      queryClient.invalidateQueries({ queryKey: ['rewards'] })\n      setIsCreateDialogOpen(false)\n      form.reset()\n    },\n    onError: (error: Error) => {\n      toast.error(error.message)\n    },\n  })\n\n  // Update mutation\n  const updateMutation = useMutation({\n    mutationFn: async (data: RewardFormData & { id: string }) => {\n      const { id, ...payload } = data\n      const res = await fetch(`/api/v1/admin/loyalty/rewards/${id}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          ...payload,\n          valid_from: payload.valid_from ? new Date(payload.valid_from) : undefined,\n          valid_until: payload.valid_until ? new Date(payload.valid_until) : undefined,\n        }),\n      })\n      if (!res.ok) {\n        const error = await res.json()\n        throw new Error(error.error || 'Failed to update reward')\n      }\n      return res.json()\n    },\n    onSuccess: () => {\n      toast.success('Reward updated successfully')\n      queryClient.invalidateQueries({ queryKey: ['rewards'] })\n      setIsEditDialogOpen(false)\n      setSelectedReward(null)\n    },\n    onError: (error: Error) => {\n      toast.error(error.message)\n    },\n  })\n\n  // Delete mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const res = await fetch(`/api/v1/admin/loyalty/rewards/${id}`, {\n        method: 'DELETE',\n      })\n      if (!res.ok) {\n        const error = await res.json()\n        throw new Error(error.error || 'Failed to delete reward')\n      }\n    },\n    onSuccess: () => {\n      toast.success('Reward deleted successfully')\n      queryClient.invalidateQueries({ queryKey: ['rewards'] })\n      setIsDeleteDialogOpen(false)\n      setSelectedReward(null)\n    },\n    onError: (error: Error) => {\n      toast.error(error.message)\n    },\n  })\n\n  // Stock update mutation\n  const stockMutation = useMutation({\n    mutationFn: async ({ id, quantity }: { id: string; quantity: number }) => {\n      const res = await fetch(`/api/v1/admin/loyalty/rewards/${id}/stock`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ stock_quantity: quantity, operation: 'set' }),\n      })\n      if (!res.ok) {\n        const error = await res.json()\n        throw new Error(error.error || 'Failed to update stock')\n      }\n      return res.json()\n    },\n    onSuccess: () => {\n      toast.success('Stock updated successfully')\n      queryClient.invalidateQueries({ queryKey: ['rewards'] })\n      setIsStockDialogOpen(false)\n      setSelectedReward(null)\n    },\n    onError: (error: Error) => {\n      toast.error(error.message)\n    },\n  })\n\n  // Filtered and paginated rewards\n  const filteredRewards = useMemo(() => {\n    if (!rewards) return []\n\n    return rewards.filter((reward) => {\n      const matchesSearch = reward.name.toLowerCase().includes(search.toLowerCase())\n      const matchesType = typeFilter === 'all' || reward.reward_type === typeFilter\n      const matchesStatus =\n        statusFilter === 'all' ||\n        (statusFilter === 'active' && reward.is_active) ||\n        (statusFilter === 'inactive' && !reward.is_active)\n\n      return matchesSearch && matchesType && matchesStatus\n    })\n  }, [rewards, search, typeFilter, statusFilter])\n\n  const paginatedRewards = useMemo(() => {\n    const start = (page - 1) * pageSize\n    return filteredRewards.slice(start, start + pageSize)\n  }, [filteredRewards, page])\n\n  const totalPages = Math.ceil(filteredRewards.length / pageSize)\n\n  const handleEdit = (reward: RewardCatalog) => {\n    setSelectedReward(reward)\n    form.reset({\n      name: reward.name,\n      description: reward.description || '',\n      reward_type: reward.reward_type,\n      points_required: reward.points_required,\n      monetary_value: reward.monetary_value,\n      max_redemptions_per_customer: reward.max_redemptions_per_customer,\n      stock_quantity: reward.stock_quantity,\n      is_active: reward.is_active,\n      is_featured: reward.is_featured,\n      valid_from: reward.valid_from ? format(new Date(reward.valid_from), 'yyyy-MM-dd') : undefined,\n      valid_until: reward.valid_until ? format(new Date(reward.valid_until), 'yyyy-MM-dd') : null,\n      image_url: reward.image_url || '',\n    })\n    setIsEditDialogOpen(true)\n  }\n\n  const handleDelete = (reward: RewardCatalog) => {\n    setSelectedReward(reward)\n    setIsDeleteDialogOpen(true)\n  }\n\n  const handleStockManagement = (reward: RewardCatalog) => {\n    setSelectedReward(reward)\n    setIsStockDialogOpen(true)\n  }\n\n  const handleViewAnalytics = (reward: RewardCatalog) => {\n    setSelectedReward(reward)\n    setIsAnalyticsDialogOpen(true)\n  }\n\n  const onSubmit = (data: RewardFormData) => {\n    if (selectedReward) {\n      updateMutation.mutate({ ...data, id: selectedReward.id })\n    } else {\n      createMutation.mutate(data)\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold tracking-tight\">Reward Catalog</h2>\n          <p className=\"text-muted-foreground\">Manage your loyalty rewards and redemptions</p>\n        </div>\n        <Button onClick={() => setIsCreateDialogOpen(true)}>\n          <Plus className=\"w-4 h-4 mr-2\" />\n          Add Reward\n        </Button>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex gap-4\">\n            <div className=\"flex-1\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search rewards...\"\n                  value={search}\n                  onChange={(e) => setSearch(e.target.value)}\n                  className=\"pl-9\"\n                />\n              </div>\n            </div>\n            <Select value={typeFilter} onValueChange={(v) => setTypeFilter(v as any)}>\n              <SelectTrigger className=\"w-40\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Types</SelectItem>\n                <SelectItem value=\"points\">Points</SelectItem>\n                <SelectItem value=\"discount\">Discount</SelectItem>\n                <SelectItem value=\"cashback\">Cashback</SelectItem>\n                <SelectItem value=\"free_shipping\">Free Shipping</SelectItem>\n                <SelectItem value=\"upgrade\">Upgrade</SelectItem>\n                <SelectItem value=\"gift\">Gift</SelectItem>\n              </SelectContent>\n            </Select>\n            <Select value={statusFilter} onValueChange={(v) => setStatusFilter(v as any)}>\n              <SelectTrigger className=\"w-32\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Status</SelectItem>\n                <SelectItem value=\"active\">Active</SelectItem>\n                <SelectItem value=\"inactive\">Inactive</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Table */}\n      <Card>\n        <CardContent className=\"p-0\">\n          {isLoading ? (\n            <div className=\"p-8 space-y-4\">\n              {[...Array(5)].map((_, i) => (\n                <Skeleton key={i} className=\"h-12 w-full\" />\n              ))}\n            </div>\n          ) : (\n            <>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Reward</TableHead>\n                    <TableHead>Type</TableHead>\n                    <TableHead>Points</TableHead>\n                    <TableHead>Stock</TableHead>\n                    <TableHead>Redemptions</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead className=\"w-12\"></TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {paginatedRewards.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={7} className=\"text-center py-12 text-muted-foreground\">\n                        No rewards found\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    paginatedRewards.map((reward) => {\n                      const Icon = REWARD_TYPE_ICONS[reward.reward_type]\n                      const lowStock = reward.stock_quantity && reward.stock_quantity < 10\n\n                      return (\n                        <TableRow key={reward.id}>\n                          <TableCell>\n                            <div className=\"flex items-center gap-3\">\n                              {reward.image_url && (\n                                <img\n                                  src={reward.image_url}\n                                  alt={reward.name}\n                                  className=\"w-10 h-10 rounded object-cover\"\n                                />\n                              )}\n                              <div>\n                                <div className=\"font-medium flex items-center gap-2\">\n                                  {reward.name}\n                                  {reward.is_featured && <Star className=\"w-4 h-4 text-yellow-500 fill-yellow-500\" />}\n                                </div>\n                                {reward.description && (\n                                  <div className=\"text-sm text-muted-foreground line-clamp-1\">\n                                    {reward.description}\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              <div className={`w-2 h-2 rounded-full ${REWARD_TYPE_COLORS[reward.reward_type]}`} />\n                              <span className=\"capitalize\">{reward.reward_type.replace('_', ' ')}</span>\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant=\"outline\">{reward.points_required.toLocaleString()} pts</Badge>\n                          </TableCell>\n                          <TableCell>\n                            {reward.stock_quantity !== null ? (\n                              <Badge variant={lowStock ? 'destructive' : 'secondary'}>\n                                {reward.stock_quantity}\n                              </Badge>\n                            ) : (\n                              <span className=\"text-muted-foreground\">Unlimited</span>\n                            )}\n                          </TableCell>\n                          <TableCell>{reward.redemption_count.toLocaleString()}</TableCell>\n                          <TableCell>\n                            <Badge variant={reward.is_active ? 'default' : 'secondary'}>\n                              {reward.is_active ? 'Active' : 'Inactive'}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            <DropdownMenu>\n                              <DropdownMenuTrigger asChild>\n                                <Button variant=\"ghost\" size=\"sm\">\n                                  <MoreHorizontal className=\"w-4 h-4\" />\n                                </Button>\n                              </DropdownMenuTrigger>\n                              <DropdownMenuContent align=\"end\">\n                                <DropdownMenuItem onClick={() => handleEdit(reward)}>\n                                  <Edit className=\"w-4 h-4 mr-2\" />\n                                  Edit\n                                </DropdownMenuItem>\n                                {reward.stock_quantity !== null && (\n                                  <DropdownMenuItem onClick={() => handleStockManagement(reward)}>\n                                    <Package className=\"w-4 h-4 mr-2\" />\n                                    Manage Stock\n                                  </DropdownMenuItem>\n                                )}\n                                <DropdownMenuItem onClick={() => handleViewAnalytics(reward)}>\n                                  <TrendingUp className=\"w-4 h-4 mr-2\" />\n                                  View Analytics\n                                </DropdownMenuItem>\n                                <DropdownMenuSeparator />\n                                <DropdownMenuItem\n                                  onClick={() => handleDelete(reward)}\n                                  className=\"text-destructive\"\n                                >\n                                  <Trash2 className=\"w-4 h-4 mr-2\" />\n                                  Delete\n                                </DropdownMenuItem>\n                              </DropdownMenuContent>\n                            </DropdownMenu>\n                          </TableCell>\n                        </TableRow>\n                      )\n                    })\n                  )}\n                </TableBody>\n              </Table>\n\n              {/* Pagination */}\n              {totalPages > 1 && (\n                <div className=\"flex items-center justify-between p-4 border-t\">\n                  <div className=\"text-sm text-muted-foreground\">\n                    Showing {(page - 1) * pageSize + 1} to {Math.min(page * pageSize, filteredRewards.length)} of{' '}\n                    {filteredRewards.length} rewards\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setPage(page - 1)}\n                      disabled={page === 1}\n                    >\n                      <ChevronLeft className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setPage(page + 1)}\n                      disabled={page === totalPages}\n                    >\n                      <ChevronRight className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Create/Edit Dialog */}\n      <Dialog open={isCreateDialogOpen || isEditDialogOpen} onOpenChange={(open) => {\n        if (!open) {\n          setIsCreateDialogOpen(false)\n          setIsEditDialogOpen(false)\n          setSelectedReward(null)\n          form.reset()\n        }\n      }}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>{selectedReward ? 'Edit Reward' : 'Create Reward'}</DialogTitle>\n            <DialogDescription>\n              {selectedReward ? 'Update reward details' : 'Add a new reward to your catalog'}\n            </DialogDescription>\n          </DialogHeader>\n\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Name *</FormLabel>\n                    <FormControl>\n                      <Input placeholder=\"e.g., $10 Gift Card\" {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Description</FormLabel>\n                    <FormControl>\n                      <Textarea placeholder=\"Reward description...\" rows={3} {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"reward_type\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Type *</FormLabel>\n                      <Select value={field.value} onValueChange={field.onChange}>\n                        <FormControl>\n                          <SelectTrigger>\n                            <SelectValue />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"points\">Points</SelectItem>\n                          <SelectItem value=\"discount\">Discount</SelectItem>\n                          <SelectItem value=\"cashback\">Cashback</SelectItem>\n                          <SelectItem value=\"free_shipping\">Free Shipping</SelectItem>\n                          <SelectItem value=\"upgrade\">Upgrade</SelectItem>\n                          <SelectItem value=\"gift\">Gift</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"points_required\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Points Required *</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          min=\"1\"\n                          {...field}\n                          onChange={(e) => field.onChange(parseInt(e.target.value))}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"monetary_value\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Monetary Value</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          step=\"0.01\"\n                          min=\"0\"\n                          placeholder=\"Optional\"\n                          {...field}\n                          value={field.value || ''}\n                          onChange={(e) => field.onChange(e.target.value ? parseFloat(e.target.value) : null)}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"stock_quantity\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Stock Quantity</FormLabel>\n                      <FormControl>\n                        <Input\n                          type=\"number\"\n                          min=\"0\"\n                          placeholder=\"Unlimited\"\n                          {...field}\n                          value={field.value || ''}\n                          onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : null)}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"max_redemptions_per_customer\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Max Redemptions Per Customer</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"number\"\n                        min=\"1\"\n                        placeholder=\"Unlimited\"\n                        {...field}\n                        value={field.value || ''}\n                        onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : null)}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"image_url\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Image URL</FormLabel>\n                    <FormControl>\n                      <Input placeholder=\"https://...\" {...field} value={field.value || ''} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"valid_from\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Valid From</FormLabel>\n                      <FormControl>\n                        <Input type=\"date\" {...field} value={field.value || ''} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"valid_until\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Valid Until</FormLabel>\n                      <FormControl>\n                        <Input type=\"date\" {...field} value={field.value || ''} />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"flex gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"is_active\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex items-center gap-2 space-y-0\">\n                      <FormControl>\n                        <Switch checked={field.value} onCheckedChange={field.onChange} />\n                      </FormControl>\n                      <FormLabel className=\"!mt-0\">Active</FormLabel>\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"is_featured\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex items-center gap-2 space-y-0\">\n                      <FormControl>\n                        <Switch checked={field.value} onCheckedChange={field.onChange} />\n                      </FormControl>\n                      <FormLabel className=\"!mt-0\">Featured</FormLabel>\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsCreateDialogOpen(false)\n                    setIsEditDialogOpen(false)\n                    setSelectedReward(null)\n                    form.reset()\n                  }}\n                >\n                  Cancel\n                </Button>\n                <Button type=\"submit\" disabled={createMutation.isPending || updateMutation.isPending}>\n                  {createMutation.isPending || updateMutation.isPending ? 'Saving...' : 'Save'}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Dialog */}\n      <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Delete Reward</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{selectedReward?.name}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsDeleteDialogOpen(false)}>\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => selectedReward && deleteMutation.mutate(selectedReward.id)}\n              disabled={deleteMutation.isPending}\n            >\n              {deleteMutation.isPending ? 'Deleting...' : 'Delete'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Stock Management Dialog */}\n      <Dialog open={isStockDialogOpen} onOpenChange={setIsStockDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Manage Stock</DialogTitle>\n            <DialogDescription>\n              Update stock quantity for \"{selectedReward?.name}\"\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Current Stock</Label>\n              <div className=\"text-2xl font-bold\">{selectedReward?.stock_quantity || 0}</div>\n            </div>\n            <div>\n              <Label htmlFor=\"new-stock\">New Stock Quantity</Label>\n              <Input\n                id=\"new-stock\"\n                type=\"number\"\n                min=\"0\"\n                defaultValue={selectedReward?.stock_quantity || 0}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter') {\n                    const input = e.target as HTMLInputElement\n                    selectedReward && stockMutation.mutate({\n                      id: selectedReward.id,\n                      quantity: parseInt(input.value),\n                    })\n                  }\n                }}\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsStockDialogOpen(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                const input = document.getElementById('new-stock') as HTMLInputElement\n                selectedReward && stockMutation.mutate({\n                  id: selectedReward.id,\n                  quantity: parseInt(input.value),\n                })\n              }}\n              disabled={stockMutation.isPending}\n            >\n              {stockMutation.isPending ? 'Updating...' : 'Update Stock'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Analytics Dialog */}\n      <Dialog open={isAnalyticsDialogOpen} onOpenChange={setIsAnalyticsDialogOpen}>\n        <DialogContent className=\"max-w-3xl\">\n          <DialogHeader>\n            <DialogTitle>Reward Analytics</DialogTitle>\n            <DialogDescription>{selectedReward?.name}</DialogDescription>\n          </DialogHeader>\n          {analytics ? (\n            <div className=\"grid grid-cols-2 gap-4\">\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-sm font-medium\">Total Redemptions</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{analytics.total_redemptions.toLocaleString()}</div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-sm font-medium\">Unique Customers</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{analytics.unique_customers.toLocaleString()}</div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-sm font-medium\">Points Spent</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{analytics.total_points_spent.toLocaleString()}</div>\n                </CardContent>\n              </Card>\n              <Card>\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-sm font-medium\">Avg Fulfillment</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">\n                    {analytics.avg_fulfillment_hours?.toFixed(1) || 'N/A'}\n                    {analytics.avg_fulfillment_hours && 'h'}\n                  </div>\n                </CardContent>\n              </Card>\n              <Card className=\"col-span-2\">\n                <CardHeader className=\"pb-3\">\n                  <CardTitle className=\"text-sm font-medium\">Status Breakdown</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-2\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Fulfilled:</span>\n                    <span className=\"font-medium\">{analytics.fulfilled_redemptions}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Pending:</span>\n                    <span className=\"font-medium\">{analytics.pending_redemptions}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Cancelled:</span>\n                    <span className=\"font-medium\">{analytics.cancelled_redemptions}</span>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {[...Array(6)].map((_, i) => (\n                <Skeleton key={i} className=\"h-20 w-full\" />\n              ))}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\loyalty\\customer\\RewardCatalog.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'Separator' is not defined.","line":474,"column":20,"nodeType":"JSXIdentifier","messageId":"undef","endLine":474,"endColumn":29}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * RewardCatalog - Browse and redeem rewards\n *\n * Features:\n * - Grid/list view toggle\n * - Filters: Points range, type, availability\n * - Sort options\n * - Reward cards with redemption\n * - Redemption modal with confirmation\n * - Terms display\n *\n * APIs:\n * - GET /api/v1/customers/[id]/loyalty/rewards/available\n * - POST /api/v1/customers/[id]/loyalty/rewards/redeem\n */\n\n'use client';\n\nimport { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport {\n  Grid3x3,\n  List,\n  Gift,\n  Check,\n  AlertCircle,\n  Search,\n  Filter,\n  X,\n  Sparkles,\n} from 'lucide-react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport { Slider } from '@/components/ui/slider';\nimport { PointsDisplay } from './shared/PointsDisplay';\nimport { cn } from '@/lib/utils';\nimport { toast } from 'sonner';\n\ninterface RewardCatalogProps {\n  customerId: string;\n  currentPoints: number;\n}\n\ninterface Reward {\n  id: string;\n  name: string;\n  description: string;\n  points_cost: number;\n  reward_type: string;\n  image_url?: string;\n  stock_quantity?: number;\n  is_featured: boolean;\n  is_active: boolean;\n  terms?: string;\n}\n\nexport function RewardCatalog({\n  customerId,\n  currentPoints,\n}: RewardCatalogProps) {\n  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');\n  const [searchQuery, setSearchQuery] = useState('');\n  const [selectedRewardType, setSelectedRewardType] = useState<string>('all');\n  const [maxPoints, setMaxPoints] = useState<number[]>([currentPoints]);\n  const [sortBy, setSortBy] = useState('points_asc');\n  const [showFilters, setShowFilters] = useState(false);\n  const [selectedReward, setSelectedReward] = useState<Reward | null>(null);\n\n  const queryClient = useQueryClient();\n\n  // Fetch rewards\n  const { data, isLoading } = useQuery({\n    queryKey: [\n      'available-rewards',\n      customerId,\n      selectedRewardType,\n      maxPoints[0],\n    ],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (selectedRewardType !== 'all') {\n        params.append('reward_type', selectedRewardType);\n      }\n      params.append('max_points', maxPoints[0].toString());\n\n      const response = await fetch(\n        `/api/v1/customers/${customerId}/loyalty/rewards/available?${params}`\n      );\n      if (!response.ok) throw new Error('Failed to fetch rewards');\n      const json = await response.json();\n      return json.data as Reward[];\n    },\n  });\n\n  // Redeem mutation\n  const redeemMutation = useMutation({\n    mutationFn: async (rewardId: string) => {\n      const response = await fetch(\n        `/api/v1/customers/${customerId}/loyalty/rewards/redeem`,\n        {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ reward_id: rewardId }),\n        }\n      );\n      if (!response.ok) throw new Error('Failed to redeem reward');\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({\n        queryKey: ['available-rewards', customerId],\n      });\n      queryClient.invalidateQueries({\n        queryKey: ['loyalty-summary', customerId],\n      });\n      toast.success('Reward redeemed successfully!', {\n        description: `Redemption code: ${data.data.redemption_code}`,\n      });\n      setSelectedReward(null);\n    },\n    onError: () => {\n      toast.error('Failed to redeem reward', {\n        description: 'Please try again or contact support.',\n      });\n    },\n  });\n\n  // Filter and sort rewards\n  const filteredRewards = (data || [])\n    .filter((reward) => {\n      if (searchQuery) {\n        const query = searchQuery.toLowerCase();\n        return (\n          reward.name.toLowerCase().includes(query) ||\n          reward.description.toLowerCase().includes(query)\n        );\n      }\n      return true;\n    })\n    .sort((a, b) => {\n      switch (sortBy) {\n        case 'points_asc':\n          return a.points_cost - b.points_cost;\n        case 'points_desc':\n          return b.points_cost - a.points_cost;\n        case 'name':\n          return a.name.localeCompare(b.name);\n        default:\n          return 0;\n      }\n    });\n\n  const handleRedeem = (reward: Reward) => {\n    if (reward.points_cost > currentPoints) {\n      toast.error('Insufficient points', {\n        description: `You need ${(reward.points_cost - currentPoints).toLocaleString()} more points.`,\n      });\n      return;\n    }\n    setSelectedReward(reward);\n  };\n\n  const confirmRedeem = () => {\n    if (selectedReward) {\n      redeemMutation.mutate(selectedReward.id);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n        <div>\n          <h2 className=\"text-2xl font-bold\">Reward Catalog</h2>\n          <p className=\"text-muted-foreground\">\n            You have{' '}\n            <span className=\"font-semibold text-primary\">\n              {currentPoints.toLocaleString()}\n            </span>{' '}\n            points to spend\n          </p>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant={viewMode === 'grid' ? 'default' : 'outline'}\n            size=\"icon\"\n            onClick={() => setViewMode('grid')}\n          >\n            <Grid3x3 className=\"h-4 w-4\" />\n          </Button>\n          <Button\n            variant={viewMode === 'list' ? 'default' : 'outline'}\n            size=\"icon\"\n            onClick={() => setViewMode('list')}\n          >\n            <List className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      {/* Search and Filters */}\n      <Card>\n        <CardContent className=\"pt-6 space-y-4\">\n          <div className=\"flex flex-col sm:flex-row gap-3\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search rewards...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n              />\n            </div>\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowFilters(!showFilters)}\n              className=\"gap-2\"\n            >\n              <Filter className=\"h-4 w-4\" />\n              Filters\n              {showFilters && <X className=\"h-4 w-4\" />}\n            </Button>\n          </div>\n\n          <AnimatePresence>\n            {showFilters && (\n              <motion.div\n                initial={{ height: 0, opacity: 0 }}\n                animate={{ height: 'auto', opacity: 1 }}\n                exit={{ height: 0, opacity: 0 }}\n                className=\"grid gap-4 sm:grid-cols-3\"\n              >\n                <div className=\"space-y-2\">\n                  <Label>Reward Type</Label>\n                  <Select\n                    value={selectedRewardType}\n                    onValueChange={setSelectedRewardType}\n                  >\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Types</SelectItem>\n                      <SelectItem value=\"discount\">Discount</SelectItem>\n                      <SelectItem value=\"product\">Product</SelectItem>\n                      <SelectItem value=\"experience\">Experience</SelectItem>\n                      <SelectItem value=\"shipping\">Shipping</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Sort By</Label>\n                  <Select value={sortBy} onValueChange={setSortBy}>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"points_asc\">\n                        Points: Low to High\n                      </SelectItem>\n                      <SelectItem value=\"points_desc\">\n                        Points: High to Low\n                      </SelectItem>\n                      <SelectItem value=\"name\">Name</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Max Points: {maxPoints[0].toLocaleString()}</Label>\n                  <Slider\n                    value={maxPoints}\n                    onValueChange={setMaxPoints}\n                    max={currentPoints}\n                    step={100}\n                    className=\"mt-2\"\n                  />\n                </div>\n              </motion.div>\n            )}\n          </AnimatePresence>\n        </CardContent>\n      </Card>\n\n      {/* Rewards Grid/List */}\n      {isLoading ? (\n        <div className=\"flex justify-center py-12\">\n          <div className=\"text-center space-y-4\">\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto\" />\n            <p className=\"text-muted-foreground\">Loading rewards...</p>\n          </div>\n        </div>\n      ) : filteredRewards.length === 0 ? (\n        <Card>\n          <CardContent className=\"pt-12 pb-12 text-center space-y-4\">\n            <Gift className=\"h-12 w-12 text-muted-foreground mx-auto\" />\n            <div>\n              <p className=\"font-medium\">No rewards found</p>\n              <p className=\"text-sm text-muted-foreground\">\n                Try adjusting your filters or search query\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      ) : (\n        <div\n          className={cn(\n            'grid gap-4',\n            viewMode === 'grid'\n              ? 'sm:grid-cols-2 lg:grid-cols-3'\n              : 'grid-cols-1'\n          )}\n        >\n          {filteredRewards.map((reward, index) => (\n            <motion.div\n              key={reward.id}\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: index * 0.05 }}\n            >\n              <Card\n                className={cn(\n                  'h-full transition-shadow hover:shadow-lg',\n                  reward.is_featured && 'border-primary'\n                )}\n              >\n                <CardContent className=\"pt-6\">\n                  <div\n                    className={cn(\n                      'space-y-4',\n                      viewMode === 'list' && 'flex gap-4 items-start'\n                    )}\n                  >\n                    {/* Image placeholder */}\n                    <div\n                      className={cn(\n                        'bg-gradient-to-br from-primary/10 to-primary/5 rounded-lg flex items-center justify-center',\n                        viewMode === 'grid'\n                          ? 'aspect-video'\n                          : 'w-32 h-32 shrink-0'\n                      )}\n                    >\n                      <Gift className=\"h-12 w-12 text-primary\" />\n                    </div>\n\n                    {/* Content */}\n                    <div className=\"flex-1 space-y-3\">\n                      <div className=\"space-y-1\">\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <h3 className=\"font-semibold line-clamp-2\">\n                            {reward.name}\n                          </h3>\n                          {reward.is_featured && (\n                            <Badge\n                              variant=\"secondary\"\n                              className=\"shrink-0 gap-1 bg-primary/10 text-primary\"\n                            >\n                              <Sparkles className=\"h-3 w-3\" />\n                              Featured\n                            </Badge>\n                          )}\n                        </div>\n                        <p className=\"text-sm text-muted-foreground line-clamp-2\">\n                          {reward.description}\n                        </p>\n                      </div>\n\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <PointsDisplay\n                            points={reward.points_cost}\n                            animated={false}\n                            variant=\"compact\"\n                            className=\"text-2xl\"\n                          />\n                          <p className=\"text-xs text-muted-foreground\">\n                            points\n                          </p>\n                        </div>\n\n                        {reward.stock_quantity !== undefined && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {reward.stock_quantity > 0\n                              ? `${reward.stock_quantity} left`\n                              : 'Out of stock'}\n                          </Badge>\n                        )}\n                      </div>\n\n                      <Button\n                        onClick={() => handleRedeem(reward)}\n                        disabled={\n                          reward.points_cost > currentPoints ||\n                          reward.stock_quantity === 0 ||\n                          redeemMutation.isPending\n                        }\n                        className=\"w-full gap-2\"\n                      >\n                        {reward.points_cost > currentPoints ? (\n                          <>\n                            <AlertCircle className=\"h-4 w-4\" />\n                            Need{' '}\n                            {(reward.points_cost - currentPoints).toLocaleString()}{' '}\n                            more\n                          </>\n                        ) : reward.stock_quantity === 0 ? (\n                          'Out of Stock'\n                        ) : (\n                          <>\n                            <Gift className=\"h-4 w-4\" />\n                            Redeem\n                          </>\n                        )}\n                      </Button>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </motion.div>\n          ))}\n        </div>\n      )}\n\n      {/* Redemption Confirmation Dialog */}\n      <Dialog\n        open={!!selectedReward}\n        onOpenChange={(open) => !open && setSelectedReward(null)}\n      >\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Confirm Redemption</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to redeem this reward?\n            </DialogDescription>\n          </DialogHeader>\n\n          {selectedReward && (\n            <div className=\"space-y-4\">\n              <Card>\n                <CardContent className=\"pt-6 space-y-3\">\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"bg-primary/10 p-3 rounded-lg\">\n                      <Gift className=\"h-6 w-6 text-primary\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <h3 className=\"font-semibold\">{selectedReward.name}</h3>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {selectedReward.description}\n                      </p>\n                    </div>\n                  </div>\n\n                  <Separator />\n\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-sm text-muted-foreground\">\n                      Points Cost\n                    </span>\n                    <span className=\"text-lg font-bold text-primary\">\n                      {selectedReward.points_cost.toLocaleString()}\n                    </span>\n                  </div>\n\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-sm text-muted-foreground\">\n                      Your Balance After\n                    </span>\n                    <span className=\"text-lg font-semibold\">\n                      {(currentPoints - selectedReward.points_cost).toLocaleString()}\n                    </span>\n                  </div>\n                </CardContent>\n              </Card>\n\n              {selectedReward.terms && (\n                <div className=\"text-xs text-muted-foreground bg-muted p-3 rounded-lg\">\n                  <p className=\"font-medium mb-1\">Terms & Conditions:</p>\n                  <p>{selectedReward.terms}</p>\n                </div>\n              )}\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setSelectedReward(null)}\n              disabled={redeemMutation.isPending}\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={confirmRedeem}\n              disabled={redeemMutation.isPending}\n              className=\"gap-2\"\n            >\n              {redeemMutation.isPending ? (\n                <>\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white\" />\n                  Redeeming...\n                </>\n              ) : (\n                <>\n                  <Check className=\"h-4 w-4\" />\n                  Confirm Redemption\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\magicui\\magic-card.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":8,"column":62,"nodeType":"Identifier","messageId":"undef","endLine":8,"endColumn":76},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":25,"column":26,"nodeType":"Identifier","messageId":"undef","endLine":25,"endColumn":40}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useCallback, useEffect } from \"react\";\nimport { motion, useMotionTemplate, useMotionValue } from \"framer-motion\";\n\nimport { cn } from \"@/lib/utils\";\n\nexport interface MagicCardProps extends React.HTMLAttributes<HTMLDivElement> {\n  gradientSize?: number;\n  gradientColor?: string;\n  gradientOpacity?: number;\n}\n\nexport function MagicCard({\n  children,\n  className,\n  gradientSize = 200,\n  gradientColor = \"#262626\",\n  gradientOpacity = 0.8,\n}: MagicCardProps) {\n  const mouseX = useMotionValue(-gradientSize);\n  const mouseY = useMotionValue(-gradientSize);\n\n  const handleMouseMove = useCallback(\n    (e: React.MouseEvent<HTMLDivElement>) => {\n      const { left, top } = e.currentTarget.getBoundingClientRect();\n      mouseX.set(e.clientX - left);\n      mouseY.set(e.clientY - top);\n    },\n    [mouseX, mouseY],\n  );\n\n  const handleMouseLeave = useCallback(() => {\n    mouseX.set(-gradientSize);\n    mouseY.set(-gradientSize);\n  }, [mouseX, mouseY, gradientSize]);\n\n  useEffect(() => {\n    mouseX.set(-gradientSize);\n    mouseY.set(-gradientSize);\n  }, [mouseX, mouseY, gradientSize]);\n\n  return (\n    <div\n      onMouseMove={handleMouseMove}\n      onMouseLeave={handleMouseLeave}\n      className={cn(\n        \"group relative overflow-hidden rounded-xl bg-neutral-100 dark:bg-neutral-900 border border-white/10\",\n        className,\n      )}\n    >\n      <div className=\"relative z-10\">{children}</div>\n      <motion.div\n        className=\"pointer-events-none absolute -inset-px rounded-xl opacity-0 transition-opacity duration-300 group-hover:opacity-100\"\n        style={{\n          background: useMotionTemplate`\n            radial-gradient(${gradientSize}px circle at ${mouseX}px ${mouseY}px, ${gradientColor}, transparent 100%)\n          `,\n          opacity: gradientOpacity,\n        }}\n      />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\magicui\\number-ticker.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLSpanElement' is not defined.","line":21,"column":22,"nodeType":"Identifier","messageId":"undef","endLine":21,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useRef } from \"react\";\nimport { useInView, useMotionValue, useSpring } from \"framer-motion\";\n\nimport { cn } from \"@/lib/utils\";\n\nexport default function NumberTicker({\n  value,\n  direction = \"up\",\n  delay = 0,\n  className,\n  decimalPlaces = 0,\n}: {\n  value: number;\n  direction?: \"up\" | \"down\";\n  className?: string;\n  delay?: number;\n  decimalPlaces?: number;\n}) {\n  const ref = useRef<HTMLSpanElement>(null);\n  const motionValue = useMotionValue(direction === \"down\" ? value : 0);\n  const springValue = useSpring(motionValue, {\n    damping: 60,\n    stiffness: 100,\n  });\n  const isInView = useInView(ref, { once: true, margin: \"0px\" });\n\n  useEffect(() => {\n    if (isInView) {\n      setTimeout(() => {\n        motionValue.set(direction === \"down\" ? 0 : value);\n      }, delay * 1000);\n    }\n  }, [motionValue, isInView, delay, value, direction]);\n\n  useEffect(\n    () =>\n      springValue.on(\"change\", (latest) => {\n        if (ref.current) {\n          ref.current.textContent = Intl.NumberFormat(\"en-US\", {\n            minimumFractionDigits: decimalPlaces,\n            maximumFractionDigits: decimalPlaces,\n          }).format(Number(latest.toFixed(decimalPlaces)));\n        }\n      }),\n    [springValue, decimalPlaces],\n  );\n\n  return (\n    <span\n      className={cn(\n        \"inline-block tabular-nums text-black dark:text-white tracking-wider\",\n        className,\n      )}\n      ref={ref}\n    />\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\magicui\\particles.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLCanvasElement' is not defined.","line":30,"column":28,"nodeType":"Identifier","messageId":"undef","endLine":30,"endColumn":45},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":31,"column":37,"nodeType":"Identifier","messageId":"undef","endLine":31,"endColumn":51},{"ruleId":"no-undef","severity":2,"message":"'CanvasRenderingContext2D' is not defined.","line":32,"column":26,"nodeType":"Identifier","messageId":"undef","endLine":32,"endColumn":50}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { useEffect, useRef, useState } from \"react\";\n\nimport { cn } from \"@/lib/utils\";\n\ninterface ParticlesProps {\n  className?: string;\n  quantity?: number;\n  staticity?: number;\n  ease?: number;\n  size?: number;\n  refresh?: boolean;\n  color?: string;\n  vx?: number;\n  vy?: number;\n}\n\nexport default function Particles({\n  className,\n  quantity = 100,\n  staticity = 50,\n  ease = 50,\n  size = 0.4,\n  refresh = false,\n  color = \"#ffffff\",\n  vx = 0,\n  vy = 0,\n}: ParticlesProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const canvasContainerRef = useRef<HTMLDivElement>(null);\n  const context = useRef<CanvasRenderingContext2D | null>(null);\n  const circles = useRef<any[]>([]);\n  const mousePosition = useRef<{ x: number; y: number }>({ x: 0, y: 0 });\n  const mouseMoveRef = useRef<boolean>(false);\n  const [canvasSize, setCanvasSize] = useState<{ w: number; h: number }>({\n    w: 0,\n    h: 0,\n  });\n  const dpr = typeof window !== \"undefined\" ? window.devicePixelRatio : 1;\n\n  useEffect(() => {\n    if (canvasRef.current) {\n      context.current = canvasRef.current.getContext(\"2d\");\n    }\n    initCanvas();\n    animate();\n    window.addEventListener(\"resize\", initCanvas);\n\n    return () => {\n      window.removeEventListener(\"resize\", initCanvas);\n    };\n  }, [color]);\n\n  useEffect(() => {\n    onMouseMove();\n  }, [canvasSize.w, canvasSize.h]);\n\n  useEffect(() => {\n    initCanvas();\n  }, [refresh]);\n\n  const initCanvas = () => {\n    resizeCanvas();\n    drawParticles();\n  };\n\n  const onMouseMove = () => {\n    if (canvasRef.current) {\n      const rect = canvasRef.current.getBoundingClientRect();\n      const { w, h } = canvasSize;\n      const x = mousePosition.current.x - rect.left - w / 2;\n      const y = mousePosition.current.y - rect.top - h / 2;\n      const inside = x < w / 2 && x > -w / 2 && y < h / 2 && y > -h / 2;\n      if (inside) {\n        mouseMoveRef.current = true;\n      } else {\n        mouseMoveRef.current = false;\n      }\n    }\n  };\n\n  type Circle = {\n    x: number;\n    y: number;\n    translateX: number;\n    translateY: number;\n    size: number;\n    alpha: number;\n    targetAlpha: number;\n    dx: number;\n    dy: number;\n    magnetism: number;\n  };\n\n  const resizeCanvas = () => {\n    if (canvasContainerRef.current && canvasRef.current && context.current) {\n      circles.current.length = 0;\n      setCanvasSize({\n        w: canvasContainerRef.current.offsetWidth,\n        h: canvasContainerRef.current.offsetHeight,\n      });\n      canvasRef.current.width = canvasContainerRef.current.offsetWidth * dpr;\n      canvasRef.current.height = canvasContainerRef.current.offsetHeight * dpr;\n      canvasRef.current.style.width = `${canvasContainerRef.current.offsetWidth}px`;\n      canvasRef.current.style.height = `${canvasContainerRef.current.offsetHeight}px`;\n      context.current.scale(dpr, dpr);\n    }\n  };\n\n  const circleParams = (): Circle => {\n    const x = Math.floor(Math.random() * canvasSize.w);\n    const y = Math.floor(Math.random() * canvasSize.h);\n    const translateX = 0;\n    const translateY = 0;\n    const pSize = Math.floor(Math.random() * 2) + size;\n    const alpha = 0;\n    const targetAlpha = parseFloat((Math.random() * 0.6 + 0.1).toFixed(1));\n    const dx = (Math.random() - 0.5) * 0.1;\n    const dy = (Math.random() - 0.5) * 0.1;\n    const magnetism = 0.1 + Math.random() * 4;\n    return {\n      x,\n      y,\n      translateX,\n      translateY,\n      size: pSize,\n      alpha,\n      targetAlpha,\n      dx,\n      dy,\n      magnetism,\n    };\n  };\n\n  const rgb = hexToRgb(color);\n\n  const drawCircle = (circle: Circle, update = false) => {\n    if (context.current) {\n      const { x, y, translateX, translateY, size, alpha } = circle;\n      context.current.translate(translateX, translateY);\n      context.current.beginPath();\n      context.current.arc(x, y, size, 0, 2 * Math.PI);\n      context.current.fillStyle = `rgba(${rgb.join(\", \")}, ${alpha})`;\n      context.current.fill();\n      context.current.setTransform(dpr, 0, 0, dpr, 0, 0);\n\n      if (!update) {\n        circles.current.push(circle);\n      }\n    }\n  };\n\n  const clearContext = () => {\n    if (context.current) {\n      context.current.clearRect(0, 0, canvasSize.w, canvasSize.h);\n    }\n  };\n\n  const drawParticles = () => {\n    clearContext();\n    const particleCount = quantity;\n    for (let i = 0; i < particleCount; i++) {\n      const circle = circleParams();\n      drawCircle(circle);\n    }\n  };\n\n  const remapValue = (\n    value: number,\n    start1: number,\n    end1: number,\n    start2: number,\n    end2: number,\n  ): number => {\n    const remapped =\n      ((value - start1) * (end2 - start2)) / (end1 - start1) + start2;\n    return remapped > 0 ? remapped : 0;\n  };\n\n  const animate = () => {\n    clearContext();\n    circles.current.forEach((circle: Circle, i: number) => {\n      const edge = [\n        circle.x + circle.translateX - circle.size,\n        canvasSize.w - circle.x - circle.translateX - circle.size,\n        circle.y + circle.translateY - circle.size,\n        canvasSize.h - circle.y - circle.translateY - circle.size,\n      ];\n      const closestEdge = edge.reduce((a, b) => Math.min(a, b));\n      const remapClosestEdge = parseFloat(\n        remapValue(closestEdge, 0, 20, 0, 1).toFixed(2),\n      );\n      if (remapClosestEdge > 1) {\n        circle.alpha += 0.02;\n        if (circle.alpha > circle.targetAlpha) {\n          circle.alpha = circle.targetAlpha;\n        }\n      } else {\n        circle.alpha = circle.targetAlpha * remapClosestEdge;\n      }\n      circle.x += circle.dx + vx;\n      circle.y += circle.dy + vy;\n      circle.translateX +=\n        (mousePosition.current.x / (staticity / circle.magnetism) -\n          circle.translateX) /\n        ease;\n      circle.translateY +=\n        (mousePosition.current.y / (staticity / circle.magnetism) -\n          circle.translateY) /\n        ease;\n\n      drawCircle(circle, true);\n\n      if (\n        circle.x < -circle.size ||\n        circle.x > canvasSize.w + circle.size ||\n        circle.y < -circle.size ||\n        circle.y > canvasSize.h + circle.size\n      ) {\n        circles.current.splice(i, 1);\n        const newCircle = circleParams();\n        drawCircle(newCircle);\n      }\n    });\n    window.requestAnimationFrame(animate);\n  };\n\n  return (\n    <div className={cn(\"pointer-events-none\", className)} ref={canvasContainerRef} aria-hidden=\"true\">\n      <canvas ref={canvasRef} className=\"size-full\" />\n    </div>\n  );\n}\n\nfunction hexToRgb(hex: string): number[] {\n  hex = hex.replace(\"#\", \"\");\n  if (hex.length === 3) {\n    hex = hex\n      .split(\"\")\n      .map((char) => char + char)\n      .join(\"\");\n  }\n  const hexInt = parseInt(hex, 16);\n  const red = (hexInt >> 16) & 255;\n  const green = (hexInt >> 8) & 255;\n  const blue = hexInt & 255;\n  return [red, green, blue];\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\magicui\\shimmer-button.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLButtonElement' is not defined.","line":8,"column":38,"nodeType":"Identifier","messageId":"undef","endLine":8,"endColumn":55},{"ruleId":"no-undef","severity":2,"message":"'HTMLButtonElement' is not defined.","line":18,"column":40,"nodeType":"Identifier","messageId":"undef","endLine":18,"endColumn":57}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport React, { CSSProperties } from \"react\";\n\nimport { cn } from \"@/lib/utils\";\n\nexport interface ShimmerButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement> {\n  shimmerColor?: string;\n  shimmerSize?: string;\n  borderRadius?: string;\n  shimmerDuration?: string;\n  background?: string;\n  className?: string;\n  children?: React.ReactNode;\n}\n\nconst ShimmerButton = React.forwardRef<HTMLButtonElement, ShimmerButtonProps>(\n  (\n    {\n      shimmerColor = \"#ffffff\",\n      shimmerSize = \"0.05em\",\n      shimmerDuration = \"3s\",\n      borderRadius = \"100px\",\n      background = \"rgba(0, 0, 0, 1)\",\n      className,\n      children,\n      ...props\n    },\n    ref,\n  ) => {\n    return (\n      <button\n        style={\n          {\n            \"--spread\": \"90deg\",\n            \"--shimmer-color\": shimmerColor,\n            \"--radius\": borderRadius,\n            \"--speed\": shimmerDuration,\n            \"--cut\": shimmerSize,\n            \"--bg\": background,\n          } as CSSProperties\n        }\n        className={cn(\n          \"group relative z-0 flex cursor-pointer items-center justify-center overflow-hidden whitespace-nowrap border border-white/10 px-6 py-3 text-white [background:var(--bg)] [border-radius:var(--radius)] dark:text-black\",\n          \"transform-gpu transition-transform duration-300 ease-in-out active:translate-y-[1px]\",\n          className,\n        )}\n        ref={ref}\n        {...props}\n      >\n        {/* spark container */}\n        <div\n          className={cn(\n            \"-z-30 blur-[2px]\",\n            \"absolute inset-0 overflow-visible [container-type:size]\",\n          )}\n        >\n          {/* spark */}\n          <div className=\"absolute inset-0 h-[100cqh] animate-shimmer [aspect-ratio:1] [border-radius:0] [mask:none]\">\n            {/* spark before */}\n            <div className=\"animate-spin-around absolute -inset-full w-auto rotate-0 [background:conic-gradient(from_calc(270deg-(var(--spread)*0.5)),transparent_0,var(--shimmer-color)_var(--spread),transparent_var(--spread))] [translate:0_0]\" />\n          </div>\n        </div>\n        {children}\n\n        {/* Highlight */}\n        <div\n          className={cn(\n            \"insert-0 absolute h-full w-full\",\n            \"rounded-2xl px-4 py-1.5 text-sm font-medium shadow-[inset_0_-8px_10px_#ffffff1f]\",\n            // transition\n            \"transform-gpu transition-all duration-300 ease-in-out\",\n            // on hover\n            \"group-hover:shadow-[inset_0_-6px_10px_#ffffff3f]\",\n            // on click\n            \"group-active:shadow-[inset_0_-10px_10px_#ffffff3f]\",\n          )}\n        />\n\n        {/* backdrop */}\n        <div\n          className={cn(\n            \"absolute -z-20 [background:var(--bg)] [border-radius:var(--radius)] [inset:var(--cut)]\",\n          )}\n        />\n      </button>\n    );\n  },\n);\n\nShimmerButton.displayName = \"ShimmerButton\";\n\nexport default ShimmerButton;\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\pricing\\PricingRuleManager.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":83,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":83,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Pricing Rule Manager Component\n *\n * Comprehensive interface for managing pricing rules with\n * creation, editing, filtering, and activation controls\n *\n * Author: Aster\n * Date: 2025-11-02\n */\n\n'use client';\n\nimport React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Badge } from '@/components/ui/badge';\nimport { Switch } from '@/components/ui/switch';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from '@/components/ui/dialog';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport { Plus, Edit, Trash2, AlertTriangle, CheckCircle2 } from 'lucide-react';\nimport { PricingRule, PricingRuleType, PricingStrategy } from '@/lib/db/pricing-schema';\n\nexport function PricingRuleManager() {\n  const [rules, setRules] = useState<PricingRule[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [filterType, setFilterType] = useState<string>('all');\n  const [searchTerm, setSearchTerm] = useState('');\n\n  useEffect(() => {\n    fetchRules();\n  }, [filterType, searchTerm]);\n\n  const fetchRules = async () => {\n    try {\n      let url = '/api/v1/pricing/rules?';\n      if (filterType !== 'all') url += `rule_type=${filterType}&`;\n      if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}`;\n\n      const response = await fetch(url);\n      const data = await response.json();\n      if (data.success) {\n        setRules(data.data);\n      }\n    } catch (error) {\n      console.error('Failed to fetch rules:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const toggleRuleActivation = async (ruleId: string, currentState: boolean) => {\n    try {\n      const response = await fetch(`/api/v1/pricing/rules/${ruleId}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ is_active: !currentState }),\n      });\n\n      if (response.ok) {\n        fetchRules();\n      }\n    } catch (error) {\n      console.error('Failed to toggle rule:', error);\n    }\n  };\n\n  const deleteRule = async (ruleId: string) => {\n    if (!confirm('Are you sure you want to delete this rule?')) return;\n\n    try {\n      const response = await fetch(`/api/v1/pricing/rules/${ruleId}`, {\n        method: 'DELETE',\n      });\n\n      if (response.ok) {\n        fetchRules();\n      }\n    } catch (error) {\n      console.error('Failed to delete rule:', error);\n    }\n  };\n\n  const getRuleTypeLabel = (type: PricingRuleType) => {\n    const labels: Record<PricingRuleType, string> = {\n      [PricingRuleType.COST_PLUS]: 'Cost Plus',\n      [PricingRuleType.MARKET_BASED]: 'Market Based',\n      [PricingRuleType.COMPETITIVE]: 'Competitive',\n      [PricingRuleType.DYNAMIC]: 'Dynamic',\n      [PricingRuleType.BUNDLE]: 'Bundle',\n      [PricingRuleType.CLEARANCE]: 'Clearance',\n      [PricingRuleType.PROMOTIONAL]: 'Promotional',\n    };\n    return labels[type] || type;\n  };\n\n  const getStrategyLabel = (strategy: PricingStrategy) => {\n    const labels: Record<PricingStrategy, string> = {\n      [PricingStrategy.MAXIMIZE_REVENUE]: 'Max Revenue',\n      [PricingStrategy.MAXIMIZE_PROFIT]: 'Max Profit',\n      [PricingStrategy.MAXIMIZE_VOLUME]: 'Max Volume',\n      [PricingStrategy.MATCH_COMPETITION]: 'Match Competition',\n      [PricingStrategy.PREMIUM_POSITIONING]: 'Premium',\n      [PricingStrategy.VALUE_POSITIONING]: 'Value',\n    };\n    return labels[strategy] || strategy;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header & Filters */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4 flex-1\">\n          <Input\n            placeholder=\"Search rules...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"max-w-sm\"\n          />\n          <Select value={filterType} onValueChange={setFilterType}>\n            <SelectTrigger className=\"w-[200px]\">\n              <SelectValue placeholder=\"Filter by type\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Types</SelectItem>\n              <SelectItem value={PricingRuleType.COST_PLUS}>Cost Plus</SelectItem>\n              <SelectItem value={PricingRuleType.MARKET_BASED}>Market Based</SelectItem>\n              <SelectItem value={PricingRuleType.COMPETITIVE}>Competitive</SelectItem>\n              <SelectItem value={PricingRuleType.DYNAMIC}>Dynamic</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n        <Dialog>\n          <DialogTrigger asChild>\n            <Button>\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Create Rule\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\">\n            <DialogHeader>\n              <DialogTitle>Create Pricing Rule</DialogTitle>\n              <DialogDescription>\n                Define automated pricing strategies for your products\n              </DialogDescription>\n            </DialogHeader>\n            <CreateRuleForm onSuccess={fetchRules} />\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      {/* Rules List */}\n      <div className=\"space-y-4\">\n        {loading ? (\n          <Card>\n            <CardContent className=\"py-8 text-center text-muted-foreground\">\n              Loading rules...\n            </CardContent>\n          </Card>\n        ) : rules.length === 0 ? (\n          <Card>\n            <CardContent className=\"py-8 text-center text-muted-foreground\">\n              No pricing rules found. Create your first rule to get started.\n            </CardContent>\n          </Card>\n        ) : (\n          rules.map((rule) => (\n            <Card key={rule.rule_id}>\n              <CardHeader>\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center gap-2\">\n                      <CardTitle>{rule.name}</CardTitle>\n                      <Badge variant={rule.is_active ? 'default' : 'secondary'}>\n                        {rule.is_active ? (\n                          <>\n                            <CheckCircle2 className=\"mr-1 h-3 w-3\" />\n                            Active\n                          </>\n                        ) : (\n                          'Inactive'\n                        )}\n                      </Badge>\n                      <Badge variant=\"outline\">{getRuleTypeLabel(rule.rule_type)}</Badge>\n                      <Badge variant=\"outline\">{getStrategyLabel(rule.strategy)}</Badge>\n                    </div>\n                    <CardDescription className=\"mt-1\">\n                      {rule.description || 'No description provided'}\n                    </CardDescription>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Switch\n                      checked={rule.is_active}\n                      onCheckedChange={() => toggleRuleActivation(rule.rule_id, rule.is_active)}\n                    />\n                    <Button variant=\"ghost\" size=\"icon\">\n                      <Edit className=\"h-4 w-4\" />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      onClick={() => deleteRule(rule.rule_id)}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                  <div>\n                    <Label className=\"text-muted-foreground\">Priority</Label>\n                    <p className=\"font-medium\">{rule.priority}</p>\n                  </div>\n                  {rule.config.margin_percent && (\n                    <div>\n                      <Label className=\"text-muted-foreground\">Target Margin</Label>\n                      <p className=\"font-medium\">{rule.config.margin_percent}%</p>\n                    </div>\n                  )}\n                  {rule.config.markup_percent && (\n                    <div>\n                      <Label className=\"text-muted-foreground\">Markup</Label>\n                      <p className=\"font-medium\">{rule.config.markup_percent}%</p>\n                    </div>\n                  )}\n                  {rule.applies_to_categories && rule.applies_to_categories.length > 0 && (\n                    <div>\n                      <Label className=\"text-muted-foreground\">Applies To</Label>\n                      <p className=\"font-medium\">{rule.applies_to_categories.length} categories</p>\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction CreateRuleForm({ onSuccess }: { onSuccess: () => void }) {\n  const [formData, setFormData] = useState({\n    name: '',\n    description: '',\n    rule_type: PricingRuleType.COST_PLUS,\n    strategy: PricingStrategy.MAXIMIZE_PROFIT,\n    priority: 50,\n    margin_percent: 30,\n  });\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n\n    try {\n      const response = await fetch('/api/v1/pricing/rules', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          ...formData,\n          config: {\n            margin_percent: formData.margin_percent,\n          },\n        }),\n      });\n\n      if (response.ok) {\n        onSuccess();\n      }\n    } catch (error) {\n      console.error('Failed to create rule:', error);\n    }\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div>\n        <Label htmlFor=\"name\">Rule Name</Label>\n        <Input\n          id=\"name\"\n          value={formData.name}\n          onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n          required\n        />\n      </div>\n      <div>\n        <Label htmlFor=\"description\">Description</Label>\n        <Input\n          id=\"description\"\n          value={formData.description}\n          onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n        />\n      </div>\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div>\n          <Label htmlFor=\"rule_type\">Rule Type</Label>\n          <Select\n            value={formData.rule_type}\n            onValueChange={(value) => setFormData({ ...formData, rule_type: value as PricingRuleType })}\n          >\n            <SelectTrigger>\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value={PricingRuleType.COST_PLUS}>Cost Plus</SelectItem>\n              <SelectItem value={PricingRuleType.MARKET_BASED}>Market Based</SelectItem>\n              <SelectItem value={PricingRuleType.COMPETITIVE}>Competitive</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n        <div>\n          <Label htmlFor=\"strategy\">Strategy</Label>\n          <Select\n            value={formData.strategy}\n            onValueChange={(value) => setFormData({ ...formData, strategy: value as PricingStrategy })}\n          >\n            <SelectTrigger>\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value={PricingStrategy.MAXIMIZE_PROFIT}>Maximize Profit</SelectItem>\n              <SelectItem value={PricingStrategy.MAXIMIZE_REVENUE}>Maximize Revenue</SelectItem>\n              <SelectItem value={PricingStrategy.MATCH_COMPETITION}>Match Competition</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div>\n          <Label htmlFor=\"priority\">Priority (1-100)</Label>\n          <Input\n            id=\"priority\"\n            type=\"number\"\n            min=\"1\"\n            max=\"100\"\n            value={formData.priority}\n            onChange={(e) => setFormData({ ...formData, priority: parseInt(e.target.value) })}\n          />\n        </div>\n        <div>\n          <Label htmlFor=\"margin\">Target Margin %</Label>\n          <Input\n            id=\"margin\"\n            type=\"number\"\n            value={formData.margin_percent}\n            onChange={(e) => setFormData({ ...formData, margin_percent: parseFloat(e.target.value) })}\n          />\n        </div>\n      </div>\n      <Button type=\"submit\" className=\"w-full\">Create Rule</Button>\n    </form>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\purchase-orders\\BulkOperations.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'getStatusColor' is not defined.","line":634,"column":67,"nodeType":"Identifier","messageId":"undef","endLine":634,"endColumn":81}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState } from 'react'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter\r\n} from '@/components/ui/dialog'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Textarea } from '@/components/ui/textarea'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Separator } from '@/components/ui/separator'\r\nimport { Checkbox } from '@/components/ui/checkbox'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport {\r\n  Settings,\r\n  Send,\r\n  Mail,\r\n  Trash2,\r\n  Copy,\r\n  Edit,\r\n  Download,\r\n  Printer,\r\n  CheckCircle,\r\n  XCircle,\r\n  Clock,\r\n  AlertTriangle,\r\n  FileText,\r\n  Package,\r\n  User,\r\n  Calendar\r\n} from 'lucide-react'\r\n\r\nimport { cn, formatCurrency, formatDate } from '@/lib/utils'\r\nimport { PurchaseOrder } from './PurchaseOrdersManagement'\r\n\r\ninterface BulkOperationsProps {\r\n  open: boolean\r\n  onClose: () => void\r\n  selectedOrders: string[]\r\n  orders: PurchaseOrder[]\r\n}\r\n\r\ntype BulkAction =\r\n  | 'send-to-supplier'\r\n  | 'approve'\r\n  | 'reject'\r\n  | 'cancel'\r\n  | 'change-status'\r\n  | 'change-priority'\r\n  | 'export'\r\n  | 'print'\r\n  | 'email'\r\n  | 'duplicate'\r\n  | 'delete'\r\n  | 'add-notes'\r\n  | 'update-delivery-date'\r\n\r\ninterface BulkActionConfig {\r\n  id: BulkAction\r\n  title: string\r\n  description: string\r\n  icon: React.ReactNode\r\n  category: 'workflow' | 'communication' | 'export' | 'maintenance'\r\n  requiresConfirmation: boolean\r\n  requiresInput?: boolean\r\n  dangerLevel?: 'low' | 'medium' | 'high'\r\n}\r\n\r\nconst bulkActions: BulkActionConfig[] = [\r\n  {\r\n    id: 'send-to-supplier',\r\n    title: 'Send to Suppliers',\r\n    description: 'Send selected purchase orders to their respective suppliers',\r\n    icon: <Send className=\"h-4 w-4\" />,\r\n    category: 'workflow',\r\n    requiresConfirmation: true\r\n  },\r\n  {\r\n    id: 'approve',\r\n    title: 'Approve Orders',\r\n    description: 'Approve all selected purchase orders',\r\n    icon: <CheckCircle className=\"h-4 w-4\" />,\r\n    category: 'workflow',\r\n    requiresConfirmation: true\r\n  },\r\n  {\r\n    id: 'reject',\r\n    title: 'Reject Orders',\r\n    description: 'Reject all selected purchase orders',\r\n    icon: <XCircle className=\"h-4 w-4\" />,\r\n    category: 'workflow',\r\n    requiresConfirmation: true,\r\n    requiresInput: true,\r\n    dangerLevel: 'medium'\r\n  },\r\n  {\r\n    id: 'cancel',\r\n    title: 'Cancel Orders',\r\n    description: 'Cancel all selected purchase orders',\r\n    icon: <XCircle className=\"h-4 w-4\" />,\r\n    category: 'workflow',\r\n    requiresConfirmation: true,\r\n    requiresInput: true,\r\n    dangerLevel: 'high'\r\n  },\r\n  {\r\n    id: 'change-status',\r\n    title: 'Change Status',\r\n    description: 'Update the status of selected orders',\r\n    icon: <Edit className=\"h-4 w-4\" />,\r\n    category: 'workflow',\r\n    requiresConfirmation: true,\r\n    requiresInput: true\r\n  },\r\n  {\r\n    id: 'change-priority',\r\n    title: 'Change Priority',\r\n    description: 'Update the priority of selected orders',\r\n    icon: <AlertTriangle className=\"h-4 w-4\" />,\r\n    category: 'workflow',\r\n    requiresConfirmation: true,\r\n    requiresInput: true\r\n  },\r\n  {\r\n    id: 'email',\r\n    title: 'Send Email',\r\n    description: 'Send email notifications for selected orders',\r\n    icon: <Mail className=\"h-4 w-4\" />,\r\n    category: 'communication',\r\n    requiresConfirmation: true,\r\n    requiresInput: true\r\n  },\r\n  {\r\n    id: 'export',\r\n    title: 'Export Data',\r\n    description: 'Export selected orders to various formats',\r\n    icon: <Download className=\"h-4 w-4\" />,\r\n    category: 'export',\r\n    requiresConfirmation: false,\r\n    requiresInput: true\r\n  },\r\n  {\r\n    id: 'print',\r\n    title: 'Print Orders',\r\n    description: 'Print selected purchase orders',\r\n    icon: <Printer className=\"h-4 w-4\" />,\r\n    category: 'export',\r\n    requiresConfirmation: false\r\n  },\r\n  {\r\n    id: 'duplicate',\r\n    title: 'Duplicate Orders',\r\n    description: 'Create copies of selected orders',\r\n    icon: <Copy className=\"h-4 w-4\" />,\r\n    category: 'maintenance',\r\n    requiresConfirmation: true\r\n  },\r\n  {\r\n    id: 'add-notes',\r\n    title: 'Add Notes',\r\n    description: 'Add notes to selected orders',\r\n    icon: <FileText className=\"h-4 w-4\" />,\r\n    category: 'maintenance',\r\n    requiresConfirmation: false,\r\n    requiresInput: true\r\n  },\r\n  {\r\n    id: 'update-delivery-date',\r\n    title: 'Update Delivery Date',\r\n    description: 'Change delivery date for selected orders',\r\n    icon: <Calendar className=\"h-4 w-4\" />,\r\n    category: 'maintenance',\r\n    requiresConfirmation: true,\r\n    requiresInput: true\r\n  },\r\n  {\r\n    id: 'delete',\r\n    title: 'Delete Orders',\r\n    description: 'Permanently delete selected orders',\r\n    icon: <Trash2 className=\"h-4 w-4\" />,\r\n    category: 'maintenance',\r\n    requiresConfirmation: true,\r\n    requiresInput: true,\r\n    dangerLevel: 'high'\r\n  }\r\n]\r\n\r\nconst BulkOperations: React.FC<BulkOperationsProps> = ({\r\n  open,\r\n  onClose,\r\n  selectedOrders,\r\n  orders\r\n}) => {\r\n  const [selectedAction, setSelectedAction] = useState<BulkAction | null>(null)\r\n  const [inputData, setInputData] = useState<Record<string, any>>({})\r\n  const [processing, setProcessing] = useState(false)\r\n  const [progress, setProgress] = useState(0)\r\n  const [results, setResults] = useState<{\r\n    success: number\r\n    failed: number\r\n    errors: string[]\r\n  } | null>(null)\r\n\r\n  const selectedOrdersData = orders.filter(order => selectedOrders.includes(order.id))\r\n  const totalValue = selectedOrdersData.reduce((sum, order) => sum + order.totalAmount, 0)\r\n\r\n  const resetState = () => {\r\n    setSelectedAction(null)\r\n    setInputData({})\r\n    setProcessing(false)\r\n    setProgress(0)\r\n    setResults(null)\r\n  }\r\n\r\n  const handleClose = () => {\r\n    resetState()\r\n    onClose()\r\n  }\r\n\r\n  const getActionsByCategory = (category: string) => {\r\n    return bulkActions.filter(action => action.category === category)\r\n  }\r\n\r\n  const validateAction = (action: BulkActionConfig): string[] => {\r\n    const errors: string[] = []\r\n\r\n    // Check if action is valid for selected orders\r\n    selectedOrdersData.forEach(order => {\r\n      switch (action.id) {\r\n        case 'send-to-supplier':\r\n          if (order.status !== 'approved') {\r\n            errors.push(`${order.poNumber}: Order must be approved before sending`)\r\n          }\r\n          break\r\n        case 'approve':\r\n          if (!['draft', 'pending'].includes(order.status)) {\r\n            errors.push(`${order.poNumber}: Order is not in approvable state`)\r\n          }\r\n          break\r\n        case 'cancel':\r\n          if (['completed', 'cancelled'].includes(order.status)) {\r\n            errors.push(`${order.poNumber}: Cannot cancel completed or already cancelled order`)\r\n          }\r\n          break\r\n      }\r\n    })\r\n\r\n    // Check required inputs\r\n    if (action.requiresInput) {\r\n      switch (action.id) {\r\n        case 'reject':\r\n        case 'cancel':\r\n          if (!inputData.reason) {\r\n            errors.push('Reason is required')\r\n          }\r\n          break\r\n        case 'change-status':\r\n          if (!inputData.newStatus) {\r\n            errors.push('New status is required')\r\n          }\r\n          break\r\n        case 'change-priority':\r\n          if (!inputData.newPriority) {\r\n            errors.push('New priority is required')\r\n          }\r\n          break\r\n        case 'add-notes':\r\n          if (!inputData.notes) {\r\n            errors.push('Notes are required')\r\n          }\r\n          break\r\n        case 'update-delivery-date':\r\n          if (!inputData.newDeliveryDate) {\r\n            errors.push('New delivery date is required')\r\n          }\r\n          break\r\n      }\r\n    }\r\n\r\n    return errors\r\n  }\r\n\r\n  const executeAction = async (action: BulkActionConfig) => {\r\n    const errors = validateAction(action)\r\n    if (errors.length > 0) {\r\n      setResults({ success: 0, failed: selectedOrders.length, errors })\r\n      return\r\n    }\r\n\r\n    setProcessing(true)\r\n    setProgress(0)\r\n\r\n    // Simulate processing\r\n    let successCount = 0\r\n    let failedCount = 0\r\n    const processingErrors: string[] = []\r\n\r\n    for (let i = 0; i < selectedOrdersData.length; i++) {\r\n      const order = selectedOrdersData[i]\r\n\r\n      // Simulate API call delay\r\n      await new Promise(resolve => setTimeout(resolve, 500))\r\n\r\n      try {\r\n        // Mock processing logic\r\n\r\n        // Simulate some failures\r\n        if (Math.random() < 0.1) {\r\n          throw new Error(`Failed to process ${order.poNumber}`)\r\n        }\r\n\r\n        successCount++\r\n      } catch (error) {\r\n        failedCount++\r\n        processingErrors.push(error instanceof Error ? error.message : 'Unknown error')\r\n      }\r\n\r\n      setProgress(((i + 1) / selectedOrdersData.length) * 100)\r\n    }\r\n\r\n    setResults({\r\n      success: successCount,\r\n      failed: failedCount,\r\n      errors: processingErrors\r\n    })\r\n    setProcessing(false)\r\n  }\r\n\r\n  const renderActionInputs = (action: BulkActionConfig) => {\r\n    if (!action.requiresInput) return null\r\n\r\n    switch (action.id) {\r\n      case 'reject':\r\n      case 'cancel':\r\n        return (\r\n          <div className=\"space-y-4\">\r\n            <div>\r\n              <Label htmlFor=\"reason\">Reason</Label>\r\n              <Textarea\r\n                id=\"reason\"\r\n                placeholder=\"Enter reason for rejection/cancellation...\"\r\n                value={inputData.reason || ''}\r\n                onChange={(e) => setInputData(prev => ({ ...prev, reason: e.target.value }))}\r\n              />\r\n            </div>\r\n          </div>\r\n        )\r\n\r\n      case 'change-status':\r\n        return (\r\n          <div>\r\n            <Label htmlFor=\"status\">New Status</Label>\r\n            <Select\r\n              value={inputData.newStatus || ''}\r\n              onValueChange={(value) => setInputData(prev => ({ ...prev, newStatus: value }))}\r\n            >\r\n              <SelectTrigger>\r\n                <SelectValue placeholder=\"Select new status\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"draft\">Draft</SelectItem>\r\n                <SelectItem value=\"pending\">Pending</SelectItem>\r\n                <SelectItem value=\"approved\">Approved</SelectItem>\r\n                <SelectItem value=\"sent\">Sent</SelectItem>\r\n                <SelectItem value=\"in_progress\">In Progress</SelectItem>\r\n                <SelectItem value=\"shipped\">Shipped</SelectItem>\r\n                <SelectItem value=\"delivered\">Delivered</SelectItem>\r\n                <SelectItem value=\"completed\">Completed</SelectItem>\r\n                <SelectItem value=\"cancelled\">Cancelled</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        )\r\n\r\n      case 'change-priority':\r\n        return (\r\n          <div>\r\n            <Label htmlFor=\"priority\">New Priority</Label>\r\n            <Select\r\n              value={inputData.newPriority || ''}\r\n              onValueChange={(value) => setInputData(prev => ({ ...prev, newPriority: value }))}\r\n            >\r\n              <SelectTrigger>\r\n                <SelectValue placeholder=\"Select new priority\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"low\">Low</SelectItem>\r\n                <SelectItem value=\"medium\">Medium</SelectItem>\r\n                <SelectItem value=\"high\">High</SelectItem>\r\n                <SelectItem value=\"urgent\">Urgent</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        )\r\n\r\n      case 'add-notes':\r\n        return (\r\n          <div>\r\n            <Label htmlFor=\"notes\">Notes</Label>\r\n            <Textarea\r\n              id=\"notes\"\r\n              placeholder=\"Enter notes to add to selected orders...\"\r\n              value={inputData.notes || ''}\r\n              onChange={(e) => setInputData(prev => ({ ...prev, notes: e.target.value }))}\r\n            />\r\n          </div>\r\n        )\r\n\r\n      case 'email':\r\n        return (\r\n          <div className=\"space-y-4\">\r\n            <div>\r\n              <Label htmlFor=\"emailSubject\">Email Subject</Label>\r\n              <Input\r\n                id=\"emailSubject\"\r\n                placeholder=\"Purchase Order Update\"\r\n                value={inputData.emailSubject || ''}\r\n                onChange={(e) => setInputData(prev => ({ ...prev, emailSubject: e.target.value }))}\r\n              />\r\n            </div>\r\n            <div>\r\n              <Label htmlFor=\"emailMessage\">Message</Label>\r\n              <Textarea\r\n                id=\"emailMessage\"\r\n                placeholder=\"Enter email message...\"\r\n                value={inputData.emailMessage || ''}\r\n                onChange={(e) => setInputData(prev => ({ ...prev, emailMessage: e.target.value }))}\r\n              />\r\n            </div>\r\n          </div>\r\n        )\r\n\r\n      case 'export':\r\n        return (\r\n          <div>\r\n            <Label htmlFor=\"exportFormat\">Export Format</Label>\r\n            <Select\r\n              value={inputData.exportFormat || 'xlsx'}\r\n              onValueChange={(value) => setInputData(prev => ({ ...prev, exportFormat: value }))}\r\n            >\r\n              <SelectTrigger>\r\n                <SelectValue />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"xlsx\">Excel (.xlsx)</SelectItem>\r\n                <SelectItem value=\"csv\">CSV (.csv)</SelectItem>\r\n                <SelectItem value=\"pdf\">PDF (.pdf)</SelectItem>\r\n                <SelectItem value=\"json\">JSON (.json)</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        )\r\n\r\n      case 'update-delivery-date':\r\n        return (\r\n          <div>\r\n            <Label htmlFor=\"deliveryDate\">New Delivery Date</Label>\r\n            <Input\r\n              id=\"deliveryDate\"\r\n              type=\"date\"\r\n              value={inputData.newDeliveryDate || ''}\r\n              onChange={(e) => setInputData(prev => ({ ...prev, newDeliveryDate: e.target.value }))}\r\n            />\r\n          </div>\r\n        )\r\n\r\n      default:\r\n        return null\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleClose}>\r\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <Settings className=\"h-5 w-5\" />\r\n            Bulk Operations\r\n          </DialogTitle>\r\n          <DialogDescription>\r\n            Perform actions on {selectedOrders.length} selected purchase orders\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {/* Selected Orders Summary */}\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"text-sm\">Selected Orders Summary</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl font-bold\">{selectedOrders.length}</div>\r\n                <div className=\"text-sm text-muted-foreground\">Orders Selected</div>\r\n              </div>\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl font-bold\">{formatCurrency(totalValue)}</div>\r\n                <div className=\"text-sm text-muted-foreground\">Total Value</div>\r\n              </div>\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl font-bold\">\r\n                  {new Set(selectedOrdersData.map(o => o.supplierId)).size}\r\n                </div>\r\n                <div className=\"text-sm text-muted-foreground\">Suppliers</div>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {!selectedAction && !processing && !results && (\r\n          <div className=\"space-y-6\">\r\n            {/* Action Categories */}\r\n            {['workflow', 'communication', 'export', 'maintenance'].map(category => (\r\n              <div key={category}>\r\n                <h3 className=\"text-lg font-semibold mb-3 capitalize\">{category} Actions</h3>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                  {getActionsByCategory(category).map(action => (\r\n                    <Card\r\n                      key={action.id}\r\n                      className={cn(\r\n                        \"cursor-pointer transition-colors hover:bg-muted/50\",\r\n                        action.dangerLevel === 'high' && \"border-red-200 hover:bg-red-50\",\r\n                        action.dangerLevel === 'medium' && \"border-yellow-200 hover:bg-yellow-50\"\r\n                      )}\r\n                      onClick={() => setSelectedAction(action.id)}\r\n                    >\r\n                      <CardContent className=\"pt-4\">\r\n                        <div className=\"flex items-start gap-3\">\r\n                          <div className={cn(\r\n                            \"p-2 rounded-lg\",\r\n                            action.dangerLevel === 'high' && \"bg-red-100 text-red-600\",\r\n                            action.dangerLevel === 'medium' && \"bg-yellow-100 text-yellow-600\",\r\n                            !action.dangerLevel && \"bg-blue-100 text-blue-600\"\r\n                          )}>\r\n                            {action.icon}\r\n                          </div>\r\n                          <div className=\"flex-1\">\r\n                            <h4 className=\"font-medium\">{action.title}</h4>\r\n                            <p className=\"text-sm text-muted-foreground mt-1\">\r\n                              {action.description}\r\n                            </p>\r\n                            <div className=\"flex items-center gap-2 mt-2\">\r\n                              {action.requiresConfirmation && (\r\n                                <Badge variant=\"secondary\" className=\"text-xs\">\r\n                                  Requires Confirmation\r\n                                </Badge>\r\n                              )}\r\n                              {action.dangerLevel && (\r\n                                <Badge\r\n                                  variant=\"outline\"\r\n                                  className={cn(\r\n                                    \"text-xs\",\r\n                                    action.dangerLevel === 'high' && \"border-red-200 text-red-600\",\r\n                                    action.dangerLevel === 'medium' && \"border-yellow-200 text-yellow-600\"\r\n                                  )}\r\n                                >\r\n                                  {action.dangerLevel.charAt(0).toUpperCase() + action.dangerLevel.slice(1)} Risk\r\n                                </Badge>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </CardContent>\r\n                    </Card>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        {/* Action Configuration */}\r\n        {selectedAction && !processing && !results && (\r\n          <div className=\"space-y-6\">\r\n            {(() => {\r\n              const action = bulkActions.find(a => a.id === selectedAction)!\r\n              return (\r\n                <>\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"flex items-center gap-2\">\r\n                        {action.icon}\r\n                        {action.title}\r\n                      </CardTitle>\r\n                      <CardDescription>{action.description}</CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      {renderActionInputs(action)}\r\n                    </CardContent>\r\n                  </Card>\r\n\r\n                  {action.dangerLevel && (\r\n                    <Alert className={cn(\r\n                      action.dangerLevel === 'high' && \"border-red-200 bg-red-50\",\r\n                      action.dangerLevel === 'medium' && \"border-yellow-200 bg-yellow-50\"\r\n                    )}>\r\n                      <AlertTriangle className=\"h-4 w-4\" />\r\n                      <AlertDescription>\r\n                        {action.dangerLevel === 'high' &&\r\n                          \"This is a high-risk operation that cannot be undone. Please proceed with caution.\"\r\n                        }\r\n                        {action.dangerLevel === 'medium' &&\r\n                          \"This operation may affect order workflows. Please review before proceeding.\"\r\n                        }\r\n                      </AlertDescription>\r\n                    </Alert>\r\n                  )}\r\n\r\n                  {/* Affected Orders */}\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-sm\">Affected Orders</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-2 max-h-48 overflow-y-auto\">\r\n                        {selectedOrdersData.map(order => (\r\n                          <div key={order.id} className=\"flex items-center justify-between p-2 border rounded\">\r\n                            <div>\r\n                              <span className=\"font-medium\">{order.poNumber}</span>\r\n                              <span className=\"text-sm text-muted-foreground ml-2\">\r\n                                {order.supplierName}\r\n                              </span>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Badge variant=\"outline\" className={getStatusColor(order.status)}>\r\n                                {order.status}\r\n                              </Badge>\r\n                              <span className=\"text-sm font-medium\">\r\n                                {formatCurrency(order.totalAmount, order.currency)}\r\n                              </span>\r\n                            </div>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </>\r\n              )\r\n            })()}\r\n          </div>\r\n        )}\r\n\r\n        {/* Processing */}\r\n        {processing && (\r\n          <div className=\"space-y-6 text-center\">\r\n            <div>\r\n              <Package className=\"h-12 w-12 mx-auto mb-4 text-blue-500\" />\r\n              <h3 className=\"text-lg font-semibold\">Processing Orders</h3>\r\n              <p className=\"text-muted-foreground\">\r\n                Please wait while we process your bulk operation...\r\n              </p>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Progress value={progress} className=\"w-full\" />\r\n              <p className=\"text-sm text-muted-foreground\">\r\n                {Math.round(progress)}% complete\r\n              </p>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Results */}\r\n        {results && (\r\n          <div className=\"space-y-6\">\r\n            <div className=\"text-center\">\r\n              <CheckCircle className=\"h-12 w-12 mx-auto mb-4 text-green-500\" />\r\n              <h3 className=\"text-lg font-semibold\">Operation Complete</h3>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <Card>\r\n                <CardContent className=\"pt-6 text-center\">\r\n                  <div className=\"text-2xl font-bold text-green-600\">{results.success}</div>\r\n                  <div className=\"text-sm text-muted-foreground\">Successful</div>\r\n                </CardContent>\r\n              </Card>\r\n              <Card>\r\n                <CardContent className=\"pt-6 text-center\">\r\n                  <div className=\"text-2xl font-bold text-red-600\">{results.failed}</div>\r\n                  <div className=\"text-sm text-muted-foreground\">Failed</div>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n\r\n            {results.errors.length > 0 && (\r\n              <Card className=\"border-red-200 bg-red-50\">\r\n                <CardHeader>\r\n                  <CardTitle className=\"text-sm text-red-800\">Errors</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <ul className=\"list-disc list-inside text-sm text-red-600 space-y-1\">\r\n                    {results.errors.map((error, index) => (\r\n                      <li key={index}>{error}</li>\r\n                    ))}\r\n                  </ul>\r\n                </CardContent>\r\n              </Card>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        <DialogFooter>\r\n          {!selectedAction && !processing && !results && (\r\n            <Button variant=\"outline\" onClick={handleClose}>\r\n              Close\r\n            </Button>\r\n          )}\r\n\r\n          {selectedAction && !processing && !results && (\r\n            <>\r\n              <Button variant=\"outline\" onClick={resetState}>\r\n                Back\r\n              </Button>\r\n              <Button\r\n                onClick={() => {\r\n                  const action = bulkActions.find(a => a.id === selectedAction)!\r\n                  executeAction(action)\r\n                }}\r\n              >\r\n                Execute Action\r\n              </Button>\r\n            </>\r\n          )}\r\n\r\n          {results && (\r\n            <Button onClick={handleClose}>\r\n              Close\r\n            </Button>\r\n          )}\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n\r\nexport default BulkOperations","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\purchase-orders\\PurchaseOrdersManagement.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":340,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":340,"endColumn":14}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useMemo, useEffect } from 'react'\r\nimport {\r\n  Plus,\r\n  Search,\r\n  Filter,\r\n  Download,\r\n  MoreHorizontal,\r\n  Eye,\r\n  Edit,\r\n  Trash2,\r\n  Copy,\r\n  Send,\r\n  CheckCircle,\r\n  XCircle,\r\n  Clock,\r\n  AlertTriangle,\r\n  DollarSign,\r\n  Calendar,\r\n  Package,\r\n  Truck,\r\n  FileText,\r\n  Settings,\r\n  Upload,\r\n  Printer,\r\n  Mail,\r\n  Star,\r\n  TrendingUp\r\n} from 'lucide-react'\r\nimport { format } from 'date-fns'\r\n\r\nimport { cn, formatCurrency, formatDate, getStatusColor } from '@/lib/utils'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Checkbox } from '@/components/ui/checkbox'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n  DialogFooter\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger\r\n} from '@/components/ui/dropdown-menu'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Separator } from '@/components/ui/separator'\r\n\r\nimport POCreationWizard from './POCreationWizard'\r\nimport PODetailsModal from './PODetailsModal'\r\nimport ApprovalWorkflow from './ApprovalWorkflow'\r\nimport BulkOperations from './BulkOperations'\r\nimport POTemplates from './POTemplates'\r\nimport CurrencyManager from './CurrencyManager'\r\nimport { usePurchaseOrders, usePurchaseOrderMetrics } from '@/hooks/usePurchaseOrders'\r\n\r\n// Types\r\nexport interface PurchaseOrderItem {\r\n  id: string\r\n  productCode: string\r\n  description: string\r\n  quantity: number\r\n  unitPrice: number\r\n  currency: string\r\n  totalPrice: number\r\n  deliveryDate?: Date\r\n  specifications?: string\r\n  category: string\r\n}\r\n\r\nexport interface PurchaseOrder {\r\n  id: string\r\n  poNumber: string\r\n  supplierId: string\r\n  supplierName: string\r\n  status: 'draft' | 'pending' | 'approved' | 'sent' | 'acknowledged' | 'in_progress' | 'shipped' | 'delivered' | 'completed' | 'cancelled'\r\n  priority: 'low' | 'medium' | 'high' | 'urgent'\r\n  createdDate: Date\r\n  requestedDeliveryDate: Date\r\n  approvedDate?: Date\r\n  sentDate?: Date\r\n  items: PurchaseOrderItem[]\r\n  subtotal: number\r\n  taxAmount: number\r\n  shippingCost: number\r\n  totalAmount: number\r\n  currency: string\r\n  exchangeRate: number\r\n  budgetCode?: string\r\n  department: string\r\n  requestedBy: string\r\n  approvedBy?: string\r\n  notes?: string\r\n  attachments: string[]\r\n  deliveryAddress: {\r\n    street: string\r\n    city: string\r\n    state: string\r\n    zipCode: string\r\n    country: string\r\n  }\r\n  billingAddress: {\r\n    street: string\r\n    city: string\r\n    state: string\r\n    zipCode: string\r\n    country: string\r\n  }\r\n  terms: {\r\n    paymentTerms: string\r\n    deliveryTerms: string\r\n    warrantyTerms: string\r\n  }\r\n  trackingNumber?: string\r\n  invoiceNumber?: string\r\n  changeOrders: ChangeOrder[]\r\n  approvalWorkflow: ApprovalStep[]\r\n}\r\n\r\nexport interface ChangeOrder {\r\n  id: string\r\n  changeNumber: string\r\n  description: string\r\n  reason: string\r\n  originalAmount: number\r\n  newAmount: number\r\n  impact: string\r\n  status: 'pending' | 'approved' | 'rejected'\r\n  requestedBy: string\r\n  requestedDate: Date\r\n  approvedBy?: string\r\n  approvedDate?: Date\r\n}\r\n\r\nexport interface ApprovalStep {\r\n  id: string\r\n  stepNumber: number\r\n  approverRole: string\r\n  approverName: string\r\n  status: 'pending' | 'approved' | 'rejected' | 'skipped'\r\n  approvedDate?: Date\r\n  comments?: string\r\n  required: boolean\r\n}\r\n\r\n// Mock data\r\nconst mockPurchaseOrders: PurchaseOrder[] = [\r\n  {\r\n    id: '1',\r\n    poNumber: 'PO-2024-001',\r\n    supplierId: 'SUP001',\r\n    supplierName: 'TechCorp Solutions',\r\n    status: 'approved',\r\n    priority: 'high',\r\n    createdDate: new Date('2024-01-15'),\r\n    requestedDeliveryDate: new Date('2024-02-15'),\r\n    approvedDate: new Date('2024-01-18'),\r\n    items: [\r\n      {\r\n        id: '1-1',\r\n        productCode: 'LAPTOP-001',\r\n        description: 'Dell Latitude 7420 Laptop',\r\n        quantity: 10,\r\n        unitPrice: 1200,\r\n        currency: 'USD',\r\n        totalPrice: 12000,\r\n        category: 'Hardware'\r\n      }\r\n    ],\r\n    subtotal: 12000,\r\n    taxAmount: 1200,\r\n    shippingCost: 150,\r\n    totalAmount: 13350,\r\n    currency: 'USD',\r\n    exchangeRate: 1,\r\n    department: 'IT',\r\n    requestedBy: 'John Doe',\r\n    approvedBy: 'Jane Smith',\r\n    notes: 'Urgent requirement for new hires',\r\n    attachments: ['specs.pdf', 'quote.xlsx'],\r\n    deliveryAddress: {\r\n      street: '123 Business St',\r\n      city: 'New York',\r\n      state: 'NY',\r\n      zipCode: '10001',\r\n      country: 'USA'\r\n    },\r\n    billingAddress: {\r\n      street: '123 Business St',\r\n      city: 'New York',\r\n      state: 'NY',\r\n      zipCode: '10001',\r\n      country: 'USA'\r\n    },\r\n    terms: {\r\n      paymentTerms: 'Net 30',\r\n      deliveryTerms: 'FOB Destination',\r\n      warrantyTerms: '1 Year Standard'\r\n    },\r\n    changeOrders: [],\r\n    approvalWorkflow: [\r\n      {\r\n        id: 'step-1',\r\n        stepNumber: 1,\r\n        approverRole: 'Department Manager',\r\n        approverName: 'Jane Smith',\r\n        status: 'approved',\r\n        approvedDate: new Date('2024-01-17'),\r\n        required: true\r\n      },\r\n      {\r\n        id: 'step-2',\r\n        stepNumber: 2,\r\n        approverRole: 'Finance Director',\r\n        approverName: 'Bob Johnson',\r\n        status: 'approved',\r\n        approvedDate: new Date('2024-01-18'),\r\n        required: true\r\n      }\r\n    ]\r\n  }\r\n  // Add more mock data as needed\r\n]\r\n\r\nconst PurchaseOrdersManagement: React.FC = () => {\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [statusFilter, setStatusFilter] = useState<string>('all')\r\n  const [priorityFilter, setPriorityFilter] = useState<string>('all')\r\n  const [departmentFilter, setDepartmentFilter] = useState<string>('all')\r\n  const [selectedOrders, setSelectedOrders] = useState<string[]>([])\r\n  const [currentView, setCurrentView] = useState<'grid' | 'list'>('list')\r\n  const [isWizardOpen, setIsWizardOpen] = useState(false)\r\n  const [selectedOrder, setSelectedOrder] = useState<any | null>(null)\r\n  const [isDetailsOpen, setIsDetailsOpen] = useState(false)\r\n  const [isBulkOperationsOpen, setIsBulkOperationsOpen] = useState(false)\r\n  const [isTemplatesOpen, setIsTemplatesOpen] = useState(false)\r\n  const [isCurrencyManagerOpen, setIsCurrencyManagerOpen] = useState(false)\r\n\r\n  // Real API data hooks\r\n  const {\r\n    orders: databaseOrders,\r\n    loading: ordersLoading,\r\n    error: ordersError,\r\n    fetchPurchaseOrders,\r\n    deletePurchaseOrders\r\n  } = usePurchaseOrders()\r\n\r\n  const {\r\n    metrics: databaseMetrics,\r\n    loading: metricsLoading,\r\n    error: metricsError\r\n  } = usePurchaseOrderMetrics()\r\n\r\n  // Filter and search logic\r\n  const filteredOrders = useMemo(() => {\r\n    if (!databaseOrders || ordersLoading) return []\r\n\r\n    return databaseOrders.filter(order => {\r\n      const matchesSearch =\r\n        order.po_number.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n        (order.supplier_name && order.supplier_name.toLowerCase().includes(searchTerm.toLowerCase())) ||\r\n        (order.notes && order.notes.toLowerCase().includes(searchTerm.toLowerCase()))\r\n\r\n      const matchesStatus = statusFilter === 'all' || order.status === statusFilter\r\n      // Note: priority filter disabled for now since our database schema doesn't have priority field\r\n      // const matchesPriority = priorityFilter === 'all' || order.priority === priorityFilter\r\n      // const matchesDepartment = departmentFilter === 'all' || order.department === departmentFilter\r\n\r\n      return matchesSearch && matchesStatus\r\n    })\r\n  }, [databaseOrders, searchTerm, statusFilter, ordersLoading])\r\n\r\n  // Statistics from API metrics\r\n  const stats = useMemo(() => {\r\n    if (databaseMetrics) {\r\n      return {\r\n        total: databaseMetrics.totalOrders || 0,\r\n        pending: databaseMetrics.pendingApprovals || 0,\r\n        approved: databaseMetrics.statusBreakdown?.approved || 0,\r\n        inProgress: databaseMetrics.inProgress || 0,\r\n        totalValue: databaseMetrics.totalValue || 0\r\n      }\r\n    }\r\n\r\n    // Fallback calculation from orders data if metrics not available\r\n    if (databaseOrders && databaseOrders.length > 0) {\r\n      const total = databaseOrders.length\r\n      const pending = databaseOrders.filter(po => po.status === 'pending_approval').length\r\n      const approved = databaseOrders.filter(po => po.status === 'approved').length\r\n      const inProgress = databaseOrders.filter(po => ['sent', 'acknowledged', 'in_progress', 'shipped'].includes(po.status)).length\r\n      const totalValue = databaseOrders.reduce((sum, po) => sum + (po.total_amount || 0), 0)\r\n\r\n      return { total, pending, approved, inProgress, totalValue }\r\n    }\r\n\r\n    return { total: 0, pending: 0, approved: 0, inProgress: 0, totalValue: 0 }\r\n  }, [databaseMetrics, databaseOrders])\r\n\r\n  const handleOrderSelect = (orderId: string, checked: boolean) => {\r\n    if (checked) {\r\n      setSelectedOrders(prev => [...prev, orderId])\r\n    } else {\r\n      setSelectedOrders(prev => prev.filter(id => id !== orderId))\r\n    }\r\n  }\r\n\r\n  const handleSelectAll = (checked: boolean) => {\r\n    if (checked) {\r\n      setSelectedOrders(filteredOrders.map(order => order.id))\r\n    } else {\r\n      setSelectedOrders([])\r\n    }\r\n  }\r\n\r\n  const openOrderDetails = (order: any) => {\r\n    setSelectedOrder(order)\r\n    setIsDetailsOpen(true)\r\n  }\r\n\r\n  const handleDeleteOrders = async (orderIds: string[]) => {\r\n    if (window.confirm(`Are you sure you want to delete ${orderIds.length} order(s)?`)) {\r\n      try {\r\n        await deletePurchaseOrders(orderIds)\r\n        setSelectedOrders(prev => prev.filter(id => !orderIds.includes(id)))\r\n      } catch (error) {\r\n        console.error('Error deleting orders:', error)\r\n        alert('Failed to delete orders. Please try again.')\r\n      }\r\n    }\r\n  }\r\n\r\n  const getStatusIcon = (status: string) => {\r\n    switch (status) {\r\n      case 'draft': return <FileText className=\"h-4 w-4\" />\r\n      case 'pending_approval': return <Clock className=\"h-4 w-4\" />\r\n      case 'approved': return <CheckCircle className=\"h-4 w-4\" />\r\n      case 'sent': return <Send className=\"h-4 w-4\" />\r\n      case 'acknowledged': return <CheckCircle className=\"h-4 w-4\" />\r\n      case 'in_progress': return <Package className=\"h-4 w-4\" />\r\n      case 'shipped': return <Truck className=\"h-4 w-4\" />\r\n      case 'received': return <CheckCircle className=\"h-4 w-4\" />\r\n      case 'completed': return <CheckCircle className=\"h-4 w-4\" />\r\n      case 'cancelled': return <XCircle className=\"h-4 w-4\" />\r\n      // Legacy support\r\n      case 'pending': return <Clock className=\"h-4 w-4\" />\r\n      case 'delivered': return <CheckCircle className=\"h-4 w-4\" />\r\n      default: return <FileText className=\"h-4 w-4\" />\r\n    }\r\n  }\r\n\r\n  const getPriorityIcon = (priority: string) => {\r\n    switch (priority) {\r\n      case 'urgent': return <AlertTriangle className=\"h-4 w-4 text-red-500\" />\r\n      case 'high': return <TrendingUp className=\"h-4 w-4 text-orange-500\" />\r\n      case 'medium': return <Clock className=\"h-4 w-4 text-yellow-500\" />\r\n      default: return <Clock className=\"h-4 w-4 text-gray-500\" />\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold tracking-tight\">Purchase Orders</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Manage purchase orders, track approvals, and monitor deliveries\r\n          </p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button variant=\"outline\" onClick={() => setIsTemplatesOpen(true)}>\r\n            <Star className=\"h-4 w-4 mr-2\" />\r\n            Templates\r\n          </Button>\r\n          <Button variant=\"outline\" onClick={() => setIsCurrencyManagerOpen(true)}>\r\n            <DollarSign className=\"h-4 w-4 mr-2\" />\r\n            Currency\r\n          </Button>\r\n          <Button onClick={() => setIsWizardOpen(true)}>\r\n            <Plus className=\"h-4 w-4 mr-2\" />\r\n            Create PO\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Statistics Cards */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Orders</CardTitle>\r\n            <FileText className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{stats.total}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              +12% from last month\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Pending Approval</CardTitle>\r\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{stats.pending}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Requires attention\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">In Progress</CardTitle>\r\n            <Package className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{stats.inProgress}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Being processed\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Value</CardTitle>\r\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatCurrency(stats.totalValue)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              This month\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Filters and Search */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Filters</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex flex-col md:flex-row gap-4\">\r\n            <div className=\"flex-1\">\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-3 top-3 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  placeholder=\"Search by PO number, supplier, or department...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-10\"\r\n                />\r\n              </div>\r\n            </div>\r\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\r\n              <SelectTrigger className=\"w-40\">\r\n                <SelectValue placeholder=\"Status\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">All Status</SelectItem>\r\n                <SelectItem value=\"draft\">Draft</SelectItem>\r\n                <SelectItem value=\"pending_approval\">Pending Approval</SelectItem>\r\n                <SelectItem value=\"approved\">Approved</SelectItem>\r\n                <SelectItem value=\"sent\">Sent</SelectItem>\r\n                <SelectItem value=\"acknowledged\">Acknowledged</SelectItem>\r\n                <SelectItem value=\"in_progress\">In Progress</SelectItem>\r\n                <SelectItem value=\"shipped\">Shipped</SelectItem>\r\n                <SelectItem value=\"received\">Received</SelectItem>\r\n                <SelectItem value=\"completed\">Completed</SelectItem>\r\n                <SelectItem value=\"cancelled\">Cancelled</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n            <Select value={priorityFilter} onValueChange={setPriorityFilter}>\r\n              <SelectTrigger className=\"w-40\">\r\n                <SelectValue placeholder=\"Priority\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">All Priority</SelectItem>\r\n                <SelectItem value=\"urgent\">Urgent</SelectItem>\r\n                <SelectItem value=\"high\">High</SelectItem>\r\n                <SelectItem value=\"medium\">Medium</SelectItem>\r\n                <SelectItem value=\"low\">Low</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n            <Select value={departmentFilter} onValueChange={setDepartmentFilter}>\r\n              <SelectTrigger className=\"w-40\">\r\n                <SelectValue placeholder=\"Department\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"all\">All Departments</SelectItem>\r\n                <SelectItem value=\"IT\">IT</SelectItem>\r\n                <SelectItem value=\"Finance\">Finance</SelectItem>\r\n                <SelectItem value=\"Operations\">Operations</SelectItem>\r\n                <SelectItem value=\"Marketing\">Marketing</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Actions Bar */}\r\n      {selectedOrders.length > 0 && (\r\n        <Card>\r\n          <CardContent className=\"pt-6\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <span className=\"text-sm text-muted-foreground\">\r\n                {selectedOrders.length} order(s) selected\r\n              </span>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setIsBulkOperationsOpen(true)}\r\n                >\r\n                  <Settings className=\"h-4 w-4 mr-2\" />\r\n                  Bulk Actions\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <Download className=\"h-4 w-4 mr-2\" />\r\n                  Export\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <Printer className=\"h-4 w-4 mr-2\" />\r\n                  Print\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Purchase Orders Table */}\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex items-center justify-between\">\r\n            <CardTitle>Purchase Orders ({filteredOrders.length})</CardTitle>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <Filter className=\"h-4 w-4 mr-2\" />\r\n                Advanced Filters\r\n              </Button>\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <Upload className=\"h-4 w-4 mr-2\" />\r\n                Import\r\n              </Button>\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <Download className=\"h-4 w-4 mr-2\" />\r\n                Export\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"rounded-md border\">\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead className=\"w-12\">\r\n                    <Checkbox\r\n                      checked={selectedOrders.length === filteredOrders.length}\r\n                      onCheckedChange={handleSelectAll}\r\n                      aria-label=\"Select all\"\r\n                    />\r\n                  </TableHead>\r\n                  <TableHead>PO Number</TableHead>\r\n                  <TableHead>Supplier</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                  <TableHead>Priority</TableHead>\r\n                  <TableHead>Department</TableHead>\r\n                  <TableHead>Amount</TableHead>\r\n                  <TableHead>Created</TableHead>\r\n                  <TableHead>Delivery Date</TableHead>\r\n                  <TableHead>Progress</TableHead>\r\n                  <TableHead className=\"w-12\"></TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {ordersLoading ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={11} className=\"text-center py-8\">\r\n                      <div className=\"flex items-center justify-center gap-2\">\r\n                        <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary\"></div>\r\n                        Loading purchase orders...\r\n                      </div>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : ordersError ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={11} className=\"text-center py-8 text-red-600\">\r\n                      Error loading purchase orders: {ordersError}\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : filteredOrders.length === 0 ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={11} className=\"text-center py-8 text-muted-foreground\">\r\n                      No purchase orders found\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : (\r\n                  filteredOrders.map((order) => (\r\n                    <TableRow key={order.id}>\r\n                      <TableCell>\r\n                        <Checkbox\r\n                          checked={selectedOrders.includes(order.id)}\r\n                          onCheckedChange={(checked) => handleOrderSelect(order.id, checked as boolean)}\r\n                          aria-label={`Select ${order.po_number}`}\r\n                        />\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col\">\r\n                          <span className=\"font-medium\">{order.po_number}</span>\r\n                          <span className=\"text-sm text-muted-foreground\">\r\n                            Created: {new Date(order.created_at).toLocaleDateString()}\r\n                          </span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col\">\r\n                          <span className=\"font-medium\">{order.supplier_name || 'Unknown Supplier'}</span>\r\n                          <span className=\"text-sm text-muted-foreground\">\r\n                            Code: {order.supplier_code || 'N/A'}\r\n                          </span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          {getStatusIcon(order.status)}\r\n                          <Badge\r\n                            variant=\"outline\"\r\n                            className={getStatusColor(order.status)}\r\n                          >\r\n                            {order.status.charAt(0).toUpperCase() + order.status.slice(1).replace('_', ' ')}\r\n                          </Badge>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Clock className=\"h-4 w-4 text-gray-500\" />\r\n                          <span className=\"capitalize\">Medium</span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant=\"secondary\">General</Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col\">\r\n                          <span className=\"font-medium\">\r\n                            {formatCurrency(order.total_amount, order.currency)}\r\n                          </span>\r\n                          <span className=\"text-sm text-muted-foreground\">\r\n                            Tax: {formatCurrency(order.tax_amount, order.currency)}\r\n                          </span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <span className=\"text-sm\">\r\n                          {new Date(order.created_at).toLocaleDateString()}\r\n                        </span>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <span className=\"text-sm\">\r\n                          {order.required_date\r\n                            ? new Date(order.required_date).toLocaleDateString()\r\n                            : 'Not specified'\r\n                          }\r\n                        </span>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col gap-1\">\r\n                          <Progress value={getOrderProgressFromStatus(order.status)} className=\"w-20\" />\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            {getOrderProgressFromStatus(order.status)}%\r\n                          </span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <DropdownMenu>\r\n                          <DropdownMenuTrigger asChild>\r\n                            <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\r\n                              <MoreHorizontal className=\"h-4 w-4\" />\r\n                            </Button>\r\n                          </DropdownMenuTrigger>\r\n                          <DropdownMenuContent align=\"end\">\r\n                            <DropdownMenuItem onClick={() => openOrderDetails(order)}>\r\n                              <Eye className=\"h-4 w-4 mr-2\" />\r\n                              View Details\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Edit className=\"h-4 w-4 mr-2\" />\r\n                              Edit\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Copy className=\"h-4 w-4 mr-2\" />\r\n                              Duplicate\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuSeparator />\r\n                            <DropdownMenuItem>\r\n                              <Send className=\"h-4 w-4 mr-2\" />\r\n                              Send to Supplier\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Mail className=\"h-4 w-4 mr-2\" />\r\n                              Email\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Printer className=\"h-4 w-4 mr-2\" />\r\n                              Print\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuSeparator />\r\n                            <DropdownMenuItem\r\n                              className=\"text-red-600\"\r\n                              onClick={() => handleDeleteOrders([order.id])}\r\n                            >\r\n                              <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                              Delete\r\n                            </DropdownMenuItem>\r\n                          </DropdownMenuContent>\r\n                        </DropdownMenu>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Modals and Dialogs */}\r\n      <POCreationWizard\r\n        open={isWizardOpen}\r\n        onClose={() => setIsWizardOpen(false)}\r\n      />\r\n\r\n      <PODetailsModal\r\n        order={selectedOrder}\r\n        open={isDetailsOpen}\r\n        onClose={() => setIsDetailsOpen(false)}\r\n      />\r\n\r\n      <BulkOperations\r\n        open={isBulkOperationsOpen}\r\n        onClose={() => setIsBulkOperationsOpen(false)}\r\n        selectedOrders={selectedOrders}\r\n        orders={databaseOrders || []}\r\n      />\r\n\r\n      <POTemplates\r\n        open={isTemplatesOpen}\r\n        onClose={() => setIsTemplatesOpen(false)}\r\n      />\r\n\r\n      <CurrencyManager\r\n        open={isCurrencyManagerOpen}\r\n        onClose={() => setIsCurrencyManagerOpen(false)}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\n// Helper function to calculate order progress from database status\r\nfunction getOrderProgressFromStatus(status: string): number {\r\n  const statusProgress: Record<string, number> = {\r\n    'draft': 10,\r\n    'pending_approval': 20,\r\n    'approved': 40,\r\n    'sent': 50,\r\n    'acknowledged': 60,\r\n    'in_progress': 70,\r\n    'shipped': 85,\r\n    'received': 95,\r\n    'completed': 100,\r\n    'cancelled': 0\r\n  }\r\n\r\n  return statusProgress[status] || 0\r\n}\r\n\r\n// Helper function to calculate order progress (legacy support)\r\nfunction getOrderProgress(order: PurchaseOrder): number {\r\n  const statusProgress: Record<string, number> = {\r\n    'draft': 10,\r\n    'pending': 20,\r\n    'approved': 40,\r\n    'sent': 50,\r\n    'acknowledged': 60,\r\n    'in_progress': 70,\r\n    'shipped': 85,\r\n    'delivered': 95,\r\n    'completed': 100,\r\n    'cancelled': 0\r\n  }\r\n\r\n  return statusProgress[order.status] || 0\r\n}\r\n\r\nexport default PurchaseOrdersManagement","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\spp\\AnimatedComponents.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'requestAnimationFrame' is not defined.","line":234,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":234,"endColumn":30},{"ruleId":"no-undef","severity":2,"message":"'requestAnimationFrame' is not defined.","line":240,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":240,"endColumn":26}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Animated components for SPP\r\n * Beautiful animations using Framer Motion\r\n */\r\n\r\nimport React from 'react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport confetti from 'canvas-confetti';\r\n\r\n// Animation variants\r\nexport const fadeIn = {\r\n  initial: { opacity: 0 },\r\n  animate: { opacity: 1 },\r\n  exit: { opacity: 0 },\r\n  transition: { duration: 0.2 },\r\n};\r\n\r\nexport const slideIn = {\r\n  initial: { x: 20, opacity: 0 },\r\n  animate: { x: 0, opacity: 1 },\r\n  exit: { x: -20, opacity: 0 },\r\n  transition: { duration: 0.3 },\r\n};\r\n\r\nexport const slideUp = {\r\n  initial: { y: 20, opacity: 0 },\r\n  animate: { y: 0, opacity: 1 },\r\n  exit: { y: -20, opacity: 0 },\r\n  transition: { duration: 0.3 },\r\n};\r\n\r\nexport const scaleIn = {\r\n  initial: { scale: 0.95, opacity: 0 },\r\n  animate: { scale: 1, opacity: 1 },\r\n  exit: { scale: 0.95, opacity: 0 },\r\n  transition: { duration: 0.2 },\r\n};\r\n\r\n// Animated container components\r\nexport function FadeInContainer({ children, ...props }: { children: React.ReactNode; [key: string]: any }) {\r\n  return (\r\n    <motion.div {...fadeIn} {...props}>\r\n      {children}\r\n    </motion.div>\r\n  );\r\n}\r\n\r\nexport function SlideInContainer({ children, ...props }: { children: React.ReactNode; [key: string]: any }) {\r\n  return (\r\n    <motion.div {...slideIn} {...props}>\r\n      {children}\r\n    </motion.div>\r\n  );\r\n}\r\n\r\nexport function SlideUpContainer({ children, ...props }: { children: React.ReactNode; [key: string]: any }) {\r\n  return (\r\n    <motion.div {...slideUp} {...props}>\r\n      {children}\r\n    </motion.div>\r\n  );\r\n}\r\n\r\nexport function ScaleInContainer({ children, ...props }: { children: React.ReactNode; [key: string]: any }) {\r\n  return (\r\n    <motion.div {...scaleIn} {...props}>\r\n      {children}\r\n    </motion.div>\r\n  );\r\n}\r\n\r\n// Animated list\r\nexport function AnimatedList({ children }: { children: React.ReactNode[] }) {\r\n  return (\r\n    <AnimatePresence mode=\"popLayout\">\r\n      {React.Children.map(children, (child, index) => (\r\n        <motion.div\r\n          key={index}\r\n          initial={{ opacity: 0, y: 20 }}\r\n          animate={{ opacity: 1, y: 0 }}\r\n          exit={{ opacity: 0, x: -20 }}\r\n          transition={{ duration: 0.2, delay: index * 0.05 }}\r\n        >\r\n          {child}\r\n        </motion.div>\r\n      ))}\r\n    </AnimatePresence>\r\n  );\r\n}\r\n\r\n// Success confetti\r\nexport function triggerConfetti() {\r\n  const count = 200;\r\n  const defaults = {\r\n    origin: { y: 0.7 },\r\n    zIndex: 9999,\r\n  };\r\n\r\n  function fire(particleRatio: number, opts: confetti.Options) {\r\n    confetti({\r\n      ...defaults,\r\n      ...opts,\r\n      particleCount: Math.floor(count * particleRatio),\r\n    });\r\n  }\r\n\r\n  fire(0.25, {\r\n    spread: 26,\r\n    startVelocity: 55,\r\n  });\r\n\r\n  fire(0.2, {\r\n    spread: 60,\r\n  });\r\n\r\n  fire(0.35, {\r\n    spread: 100,\r\n    decay: 0.91,\r\n    scalar: 0.8,\r\n  });\r\n\r\n  fire(0.1, {\r\n    spread: 120,\r\n    startVelocity: 25,\r\n    decay: 0.92,\r\n    scalar: 1.2,\r\n  });\r\n\r\n  fire(0.1, {\r\n    spread: 120,\r\n    startVelocity: 45,\r\n  });\r\n}\r\n\r\n// Pulsing dot indicator\r\nexport function PulsingDot({ className }: { className?: string }) {\r\n  return (\r\n    <motion.span\r\n      className={className}\r\n      animate={{\r\n        scale: [1, 1.2, 1],\r\n        opacity: [1, 0.8, 1],\r\n      }}\r\n      transition={{\r\n        duration: 2,\r\n        repeat: Infinity,\r\n        ease: 'easeInOut',\r\n      }}\r\n    />\r\n  );\r\n}\r\n\r\n// Loading spinner\r\nexport function LoadingSpinner({ size = 'md' }: { size?: 'sm' | 'md' | 'lg' }) {\r\n  const sizeClasses = {\r\n    sm: 'w-4 h-4',\r\n    md: 'w-6 h-6',\r\n    lg: 'w-8 h-8',\r\n  };\r\n\r\n  return (\r\n    <motion.div\r\n      className={`${sizeClasses[size]} border-2 border-current border-t-transparent rounded-full`}\r\n      animate={{ rotate: 360 }}\r\n      transition={{\r\n        duration: 1,\r\n        repeat: Infinity,\r\n        ease: 'linear',\r\n      }}\r\n    />\r\n  );\r\n}\r\n\r\n// Progress bar with animation\r\nexport function AnimatedProgressBar({ value, className }: { value: number; className?: string }) {\r\n  return (\r\n    <div className={`h-2 bg-muted rounded-full overflow-hidden ${className}`}>\r\n      <motion.div\r\n        className=\"h-full bg-primary\"\r\n        initial={{ width: 0 }}\r\n        animate={{ width: `${value}%` }}\r\n        transition={{ duration: 0.5, ease: 'easeOut' }}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n\r\n// Stagger children animation\r\nexport function StaggerContainer({ children, staggerDelay = 0.1 }: { children: React.ReactNode; staggerDelay?: number }) {\r\n  return (\r\n    <motion.div\r\n      initial=\"hidden\"\r\n      animate=\"visible\"\r\n      variants={{\r\n        visible: {\r\n          transition: {\r\n            staggerChildren: staggerDelay,\r\n          },\r\n        },\r\n      }}\r\n    >\r\n      {React.Children.map(children, (child) => (\r\n        <motion.div\r\n          variants={{\r\n            hidden: { opacity: 0, y: 20 },\r\n            visible: { opacity: 1, y: 0 },\r\n          }}\r\n        >\r\n          {child}\r\n        </motion.div>\r\n      ))}\r\n    </motion.div>\r\n  );\r\n}\r\n\r\n// Number counter animation\r\nexport function AnimatedNumber({ value, duration = 1 }: { value: number; duration?: number }) {\r\n  const [displayValue, setDisplayValue] = React.useState(0);\r\n\r\n  React.useEffect(() => {\r\n    const startTime = Date.now();\r\n    const startValue = displayValue;\r\n    const difference = value - startValue;\r\n\r\n    const updateValue = () => {\r\n      const now = Date.now();\r\n      const progress = Math.min((now - startTime) / (duration * 1000), 1);\r\n      const easeOutQuad = 1 - (1 - progress) * (1 - progress);\r\n      const currentValue = Math.floor(startValue + difference * easeOutQuad);\r\n\r\n      setDisplayValue(currentValue);\r\n\r\n      if (progress < 1) {\r\n        requestAnimationFrame(updateValue);\r\n      } else {\r\n        setDisplayValue(value);\r\n      }\r\n    };\r\n\r\n    requestAnimationFrame(updateValue);\r\n  }, [value, duration]);\r\n\r\n  return <span>{displayValue.toLocaleString()}</span>;\r\n}\r\n\r\n// Shimmer effect for loading states\r\nexport function ShimmerEffect({ className }: { className?: string }) {\r\n  return (\r\n    <div className={`relative overflow-hidden ${className}`}>\r\n      <motion.div\r\n        className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent\"\r\n        animate={{\r\n          x: ['-100%', '100%'],\r\n        }}\r\n        transition={{\r\n          duration: 1.5,\r\n          repeat: Infinity,\r\n          ease: 'linear',\r\n        }}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\spp\\PortfolioDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":180,"column":28,"nodeType":"Block","messageId":"tsIgnoreInsteadOfExpectError","endLine":180,"endColumn":74,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[6576,6622],"text":"/* @ts-expect-error - supplier_name added by view */"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n/**\r\n * Enhanced Portfolio Dashboard with React Query integration\r\n * Real-time metrics and upload history from Neon database\r\n */\r\n\r\nimport React from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table';\r\nimport {\r\n  Upload,\r\n  CheckCircle2,\r\n  AlertCircle,\r\n  BarChart3,\r\n  FileUp,\r\n  ArrowRight,\r\n  RefreshCw,\r\n  Clock,\r\n} from 'lucide-react';\r\nimport { cn, formatDate } from '@/lib/utils';\r\nimport { useDashboardMetrics, usePricelistUploads } from '@/hooks/useNeonSpp';\r\nimport { MetricsDashboard } from './MetricsDashboard';\r\nimport { SkeletonDashboard } from './LoadingStates';\r\nimport { ConnectionError, EmptyState } from './ErrorStates';\r\n\r\ninterface PortfolioDashboardProps {\r\n  onNavigateToTab?: (tab: string) => void;\r\n}\r\n\r\nexport function PortfolioDashboard({ onNavigateToTab }: PortfolioDashboardProps) {\r\n  const router = useRouter();\r\n\r\n  // React Query hooks\r\n  const { data: metrics, isLoading: metricsLoading, error: metricsError, refetch: refetchMetrics } = useDashboardMetrics();\r\n  const { data: uploadsData, isLoading: uploadsLoading, error: uploadsError, refetch: refetchUploads } = usePricelistUploads({ limit: 10 });\r\n\r\n  // Ensure uploads is always an array\r\n  const uploads = Array.isArray(uploadsData) ? uploadsData : [];\r\n\r\n  const loading = metricsLoading || uploadsLoading;\r\n\r\n  const handleRefresh = () => {\r\n    refetchMetrics();\r\n    refetchUploads();\r\n  };\r\n\r\n  const handleNavigate = (tab: string) => {\r\n    if (onNavigateToTab) {\r\n      onNavigateToTab(tab);\r\n    } else {\r\n      router.push(`/nxt-spp?tab=${tab}`);\r\n    }\r\n  };\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    switch (status) {\r\n      case 'received':\r\n        return (\r\n          <Badge variant=\"outline\" className=\"bg-blue-50 text-blue-700 border-blue-200 rounded-full px-2.5 py-0.5\">\r\n            <div className=\"w-1.5 h-1.5 bg-blue-600 rounded-full mr-1.5\" />\r\n            Received\r\n          </Badge>\r\n        );\r\n      case 'validating':\r\n        return (\r\n          <Badge variant=\"outline\" className=\"bg-yellow-50 text-yellow-700 border-yellow-200 rounded-full px-2.5 py-0.5\">\r\n            <RefreshCw className=\"h-3 w-3 mr-1 animate-spin\" />\r\n            Validating\r\n          </Badge>\r\n        );\r\n      case 'validated':\r\n        return (\r\n          <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-200 rounded-full px-2.5 py-0.5\">\r\n            <div className=\"w-1.5 h-1.5 bg-green-600 rounded-full mr-1.5\" />\r\n            Validated\r\n          </Badge>\r\n        );\r\n      case 'merged':\r\n        return (\r\n          <Badge className=\"bg-green-600 text-white rounded-full px-2.5 py-0.5\">\r\n            <div className=\"w-1.5 h-1.5 bg-white rounded-full mr-1.5\" />\r\n            Merged\r\n          </Badge>\r\n        );\r\n      case 'failed':\r\n        return (\r\n          <Badge variant=\"destructive\" className=\"rounded-full px-2.5 py-0.5\">\r\n            <div className=\"w-1.5 h-1.5 bg-white rounded-full mr-1.5\" />\r\n            Failed\r\n          </Badge>\r\n        );\r\n      default:\r\n        return <Badge variant=\"outline\" className=\"rounded-full px-2.5 py-0.5\">{status}</Badge>;\r\n    }\r\n  };\r\n\r\n  // Loading state\r\n  if (loading && !metrics) {\r\n    return <SkeletonDashboard />;\r\n  }\r\n\r\n  // Error state\r\n  if (metricsError || uploadsError) {\r\n    return <ConnectionError onRetry={handleRefresh} />;\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-bold tracking-tight text-gray-900\">Dashboard Overview</h2>\r\n          <p className=\"text-muted-foreground mt-1 text-sm\">Monitor your supplier portfolio and catalog updates</p>\r\n        </div>\r\n        <Button \r\n          onClick={handleRefresh} \r\n          variant=\"outline\" \r\n          size=\"sm\" \r\n          disabled={loading}\r\n          className=\"border-gray-200 hover:bg-gray-50\"\r\n        >\r\n          <RefreshCw className={cn('h-4 w-4 mr-2', loading && 'animate-spin')} />\r\n          Refresh\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Key Metrics */}\r\n      <MetricsDashboard metrics={metrics || null} loading={loading} />\r\n\r\n      {/* Main Content Grid */}\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n        {/* Recent Uploads - Left 2/3 */}\r\n        <Card className=\"lg:col-span-2 bg-white border border-gray-200 shadow-sm rounded-xl\">\r\n          <CardHeader className=\"pb-4\">\r\n            <CardTitle className=\"flex items-center gap-2 text-lg font-semibold text-gray-900\">\r\n              <FileUp className=\"h-5 w-5 text-gray-600\" />\r\n              Recent Uploads\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {uploads.length === 0 ? (\r\n              <EmptyState\r\n                icon={FileUp}\r\n                title=\"No Uploads Yet\"\r\n                message=\"Start by uploading your first supplier pricelist to build your product catalog.\"\r\n                action={() => handleNavigate('upload')}\r\n                actionLabel=\"Upload Pricelist\"\r\n              />\r\n            ) : (\r\n              <ScrollArea className=\"h-[400px]\">\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow className=\"border-b border-gray-200 hover:bg-transparent\">\r\n                      <TableHead className=\"font-semibold text-gray-900\">Supplier</TableHead>\r\n                      <TableHead className=\"font-semibold text-gray-900\">File</TableHead>\r\n                      <TableHead className=\"font-semibold text-gray-900\">Date</TableHead>\r\n                      <TableHead className=\"text-right font-semibold text-gray-900\">Rows</TableHead>\r\n                      <TableHead className=\"font-semibold text-gray-900\">Status</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {uploads.map((upload) => (\r\n                      <TableRow \r\n                        key={upload.upload_id}\r\n                        className=\"border-b border-gray-100 hover:bg-gray-50/50\"\r\n                      >\r\n                        <TableCell className=\"font-medium text-gray-900\">\r\n                          {/* @ts-ignore - supplier_name added by view */}\r\n                          {upload.supplier_name || 'Unknown'}\r\n                        </TableCell>\r\n                        <TableCell className=\"max-w-[200px] truncate text-gray-700\">\r\n                          {upload.filename}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-sm text-gray-600\">\r\n                          {formatDate(upload.received_at)}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right text-gray-700\">\r\n                          {upload.row_count.toLocaleString()}\r\n                        </TableCell>\r\n                        <TableCell>{getStatusBadge(upload.status)}</TableCell>\r\n                      </TableRow>\r\n                    ))}\r\n                  </TableBody>\r\n                </Table>\r\n              </ScrollArea>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Right Column - Quick Actions & Activity */}\r\n        <div className=\"space-y-6\">\r\n          {/* Quick Actions */}\r\n          <Card className=\"bg-white border border-gray-200 shadow-sm rounded-xl\">\r\n            <CardHeader className=\"pb-4\">\r\n              <CardTitle className=\"text-lg font-semibold text-gray-900\">Quick Actions</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              <Button\r\n                className=\"w-full justify-between bg-gray-900 hover:bg-gray-800 text-white shadow-md\"\r\n                onClick={() => handleNavigate('upload')}\r\n              >\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Upload className=\"h-4 w-4\" />\r\n                  <span>Upload Pricelist</span>\r\n                </div>\r\n                <ArrowRight className=\"h-4 w-4\" />\r\n              </Button>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Recent Activity */}\r\n          <Card className=\"bg-white border border-gray-200 shadow-sm rounded-xl\">\r\n            <CardHeader className=\"pb-4\">\r\n              <CardTitle className=\"text-lg font-semibold text-gray-900\">Recent Activity</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                {uploads.filter(u => u.status === 'merged').length > 0 && (\r\n                  <div className=\"flex items-start gap-3\">\r\n                    <div className=\"w-2 h-2 bg-green-600 rounded-full mt-1.5 flex-shrink-0\" />\r\n                    <div className=\"flex-1 text-sm\">\r\n                      <div className=\"font-medium text-gray-900\">Recent Merges</div>\r\n                      <div className=\"text-gray-600\">\r\n                        {uploads.filter(u => u.status === 'merged').length} successful uploads\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {metrics && metrics.new_products_count > 0 && (\r\n                  <div className=\"flex items-start gap-3\">\r\n                    <div className=\"w-2 h-2 bg-blue-600 rounded-full mt-1.5 flex-shrink-0\" />\r\n                    <div className=\"flex-1 text-sm\">\r\n                      <div className=\"font-medium text-gray-900\">New Products</div>\r\n                      <div className=\"text-gray-600\">\r\n                        {metrics.new_products_count} new products added\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {metrics && metrics.recent_price_changes_count > 0 && (\r\n                  <div className=\"flex items-start gap-3\">\r\n                    <div className=\"w-2 h-2 bg-yellow-600 rounded-full mt-1.5 flex-shrink-0\" />\r\n                    <div className=\"flex-1 text-sm\">\r\n                      <div className=\"font-medium text-gray-900\">Price Changes</div>\r\n                      <div className=\"text-gray-600\">\r\n                        {metrics.recent_price_changes_count} products updated\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Workflow */}\r\n      <Card className=\"bg-white border border-gray-200 shadow-sm rounded-xl\">\r\n        <CardHeader className=\"pb-4\">\r\n          <CardTitle className=\"text-lg font-semibold text-gray-900\">Workflow</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center justify-center gap-8\">\r\n            <div className=\"flex-1 text-center\">\r\n              <div className=\"w-16 h-16 mx-auto bg-green-100 rounded-full flex items-center justify-center mb-3\">\r\n                <Upload className=\"h-8 w-8 text-green-600\" />\r\n              </div>\r\n              <div className=\"text-lg font-semibold text-gray-900 mb-1\">Upload</div>\r\n              <div className=\"text-3xl font-bold text-gray-900\">\r\n                {uploads.filter(u => u.status === 'merged').length}\r\n              </div>\r\n              <div className=\"text-sm text-gray-600 mt-1\">Merged uploads</div>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\supplier-portfolio\\EnhancedPricelistUpload.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":145,"column":58,"nodeType":"Identifier","messageId":"undef","endLine":145,"endColumn":72}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useCallback } from 'react'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogDescription,\r\n} from '@/components/ui/dialog'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport { useToast } from '@/hooks/use-toast'\r\nimport {\r\n  Upload,\r\n  FileUp,\r\n  CheckCircle2,\r\n  AlertCircle,\r\n  Info,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  Sparkles,\r\n  ArrowRight,\r\n  X,\r\n  Download,\r\n  AlertTriangle,\r\n  Loader2,\r\n} from 'lucide-react'\r\nimport { cn } from '@/lib/utils'\r\nimport { useUploadPricelist, useMergeUpload } from '@/hooks/useNeonSpp'\r\nimport { useQuery } from '@tanstack/react-query'\nimport type {\r\n  PricelistUploadRequest,\r\n  PricelistValidationResult,\r\n  MergeResult,\r\n  Supplier,\r\n} from '@/types/nxt-spp'\r\n\r\n// Step definitions\r\nconst STEPS = [\r\n  { id: 1, name: 'Upload', description: 'Select file and supplier' },\r\n  { id: 2, name: 'Validate', description: 'Validate data quality' },\r\n  { id: 3, name: 'Review', description: 'Review validation results' },\r\n  { id: 4, name: 'Merge', description: 'Merge to catalog' },\r\n  { id: 5, name: 'Complete', description: 'Upload complete' },\r\n]\r\n\r\ninterface EnhancedPricelistUploadProps {\r\n  open?: boolean\r\n  onOpenChange?: (open: boolean) => void\r\n  onComplete: (result: MergeResult) => Promise<void>\r\n  defaultSupplierId?: string\r\n  autoValidate?: boolean\r\n  autoMerge?: boolean\r\n}\r\n\r\nexport function EnhancedPricelistUpload({\r\n  open = false,\r\n  onOpenChange,\r\n  onComplete,\r\n  defaultSupplierId,\r\n  autoValidate = false,\r\n  autoMerge = false,\r\n}: EnhancedPricelistUploadProps) {\r\n  // Hooks\r\n  const { toast } = useToast()\r\n  const uploadMutation = useUploadPricelist()\r\n  const mergeMutation = useMergeUpload()\r\n\r\n  // State\r\n  const [currentStep, setCurrentStep] = useState(1)\r\n  const [file, setFile] = useState<File | null>(null)\r\n  const [supplierId, setSupplierId] = useState<string>(defaultSupplierId || '')\r\n  const [uploadId, setUploadId] = useState<string | null>(null)\r\n  const [validationResult, setValidationResult] = useState<PricelistValidationResult | null>(null)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [validationProgress, setValidationProgress] = useState(0)\n  // Selection integration removed from NXT-SPP workflow\n\r\n  // Load suppliers query\r\n  const { data: suppliersData } = useQuery({\r\n    queryKey: ['suppliers', 'active'],\r\n    queryFn: async () => {\r\n      // Use /api/suppliers with status=active filter (v3 API)\r\n      const response = await fetch('/api/suppliers?status=active&limit=1000')\r\n      if (!response.ok) {\r\n        console.error('Failed to fetch suppliers:', response.status)\r\n        throw new Error('Failed to fetch suppliers')\r\n      }\r\n      const data = await response.json()\r\n      // Handle v3 API response format with pagination: {success, data, pagination}\r\n      const supplierList = data.success && data.data \r\n        ? data.data \r\n        : Array.isArray(data?.data) \r\n        ? data.data \r\n        : Array.isArray(data) \r\n        ? data \r\n        : []\r\n      // Map supplier data to match expected format (id instead of supplier_id)\r\n      return supplierList.map((s: any) => ({\r\n        ...s,\r\n        id: s.id || s.supplier_id, // Ensure id field exists\r\n        supplier_id: s.supplier_id || s.id, // Keep supplier_id for compatibility\r\n        code: s.code || s.supplier_code,\r\n        active: s.active ?? s.status === 'active',\r\n      })) as Supplier[]\r\n    },\r\n    enabled: open,\r\n    staleTime: 5 * 60 * 1000,\r\n  })\r\n\r\n  const suppliers = suppliersData || []\n  const loading = uploadMutation.isPending || mergeMutation.isPending\n\n  // Selections list no longer needed here\n\r\n  // Reset state\r\n  const resetState = useCallback(() => {\r\n    setCurrentStep(1)\r\n    setFile(null)\r\n    setSupplierId(defaultSupplierId || '')\r\n    setUploadId(null)\r\n    setValidationResult(null)\r\n    setError(null)\r\n    setValidationProgress(0)\r\n    uploadMutation.reset()\r\n    mergeMutation.reset()\r\n  }, [defaultSupplierId, uploadMutation, mergeMutation])\r\n\r\n  // Handle file drop\r\n  const handleFileDrop = useCallback((e: React.DragEvent<HTMLDivElement>) => {\r\n    e.preventDefault()\r\n    const droppedFile = e.dataTransfer.files[0]\r\n    if (droppedFile && isValidFileType(droppedFile)) {\r\n      setFile(droppedFile)\r\n      setError(null)\r\n    } else {\r\n      setError('Please upload a valid Excel (.xlsx, .xls) or CSV file')\r\n    }\r\n  }, [])\r\n\r\n  const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const selectedFile = e.target.files?.[0]\r\n    if (selectedFile && isValidFileType(selectedFile)) {\r\n      setFile(selectedFile)\r\n      setError(null)\r\n    } else {\r\n      setError('Please upload a valid Excel (.xlsx, .xls) or CSV file')\r\n    }\r\n  }, [])\r\n\r\n  const isValidFileType = (file: File) => {\r\n    const validTypes = [\r\n      'application/vnd.ms-excel',\r\n      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n      'text/csv',\r\n    ]\r\n    return validTypes.includes(file.type) || file.name.match(/\\.(xlsx|xls|csv)$/i);\r\n  }\r\n\r\n  // Step 1: Upload file\r\n  const handleUpload = async () => {\r\n    if (!file || !supplierId) {\r\n      setError('Please select both a file and a supplier')\r\n      return\r\n    }\r\n\r\n    setError(null)\r\n\r\n    try {\r\n      // Get supplier's default currency or fall back to ZAR\r\n      const selectedSupplier = suppliers.find(s => s.id === supplierId)\r\n      const currency = selectedSupplier?.default_currency || \r\n                       (selectedSupplier as any)?.currency || \r\n                       'ZAR'\r\n      \r\n      const newUploadId = await uploadMutation.mutateAsync({\r\n        file,\r\n        supplier_id: supplierId,\r\n        filename: file.name,\r\n        currency: currency,\r\n      })\r\n\r\n      setUploadId(newUploadId)\r\n      setCurrentStep(2)\r\n\r\n      toast({\r\n        title: 'Upload successful',\r\n        description: 'Pricelist uploaded successfully',\r\n      })\r\n\r\n      // Auto-validate if enabled\r\n      if (autoValidate) {\r\n        await handleValidate(newUploadId)\r\n      }\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : 'Upload failed'\r\n      setError(message)\r\n      toast({\r\n        title: 'Upload failed',\r\n        description: message,\r\n        variant: 'destructive',\r\n      })\r\n    }\r\n  }\r\n\r\n  // Step 2: Validate\r\n  const handleValidate = async (uploadIdToValidate?: string) => {\r\n    const idToUse = uploadIdToValidate || uploadId\r\n    if (!idToUse) return\r\n\r\n    setError(null)\r\n    setValidationProgress(0)\r\n\r\n    try {\r\n      // Simulate progressive validation\r\n      const progressInterval = setInterval(() => {\r\n        setValidationProgress(prev => Math.min(prev + 10, 90))\r\n      }, 200)\r\n\r\n      const response = await fetch('/api/spp/validate', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ upload_id: idToUse }),\r\n      })\r\n\r\n      clearInterval(progressInterval)\r\n      setValidationProgress(100)\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Validation failed')\r\n      }\r\n\r\n      const result = await response.json()\r\n      setValidationResult(result.data)\r\n      setCurrentStep(3)\r\n\r\n      toast({\r\n        title: 'Validation complete',\r\n        description: `Validated ${result.data.valid_rows} of ${result.data.total_rows} rows`,\r\n      })\r\n\r\n      // Auto-merge if enabled and validation passed\r\n      if (autoMerge && result.data.status === 'valid') {\r\n        await handleMerge()\r\n      }\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : 'Validation failed'\r\n      setError(message)\r\n      toast({\r\n        title: 'Validation failed',\r\n        description: message,\r\n        variant: 'destructive',\r\n      })\r\n    }\r\n  }\r\n\r\n  // Step 4: Merge\r\n  const handleMerge = async (skipInvalidRows?: boolean) => {\n    if (!uploadId) return\n\n    setError(null)\n    setCurrentStep(4) // Show loading state\n\n    try {\n      const result = await mergeMutation.mutateAsync(skipInvalidRows ? { uploadId, skipInvalidRows: true } : uploadId)\n      setCurrentStep(5)\n\r\n      toast({\r\n        title: 'Merge successful',\r\n        description: `Created ${result.products_created} products, updated ${result.products_updated} products`,\r\n      })\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : 'Merge failed'\r\n      setError(message)\r\n      setCurrentStep(3) // Go back to review step\r\n      toast({\r\n        title: 'Merge failed',\r\n        description: message,\r\n        variant: 'destructive',\r\n      })\r\n    }\r\n  }\r\n\r\n  // Handle close\r\n  const handleClose = () => {\r\n    if (currentStep === 5 && mergeMutation.data) {\r\n      onComplete(mergeMutation.data)\r\n    }\r\n    onOpenChange?.(false)\r\n    setTimeout(resetState, 300)\r\n  }\r\n\r\n  // Render step content\r\n  const renderStepContent = () => {\r\n    switch (currentStep) {\r\n      case 1:\r\n        return (\r\n          <div className=\"space-y-6\">\r\n            {/* File Upload */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"file-upload\">Pricelist File</Label>\r\n              <div\r\n                onDrop={handleFileDrop}\r\n                onDragOver={(e) => e.preventDefault()}\r\n                className={cn(\r\n                  \"border-2 border-dashed rounded-lg p-8 text-center transition-colors\",\r\n                  file ? \"border-green-500 bg-green-50\" : \"border-gray-300 hover:border-gray-400\"\r\n                )}\r\n              >\r\n                {file ? (\r\n                  <div className=\"space-y-2\">\r\n                    <CheckCircle2 className=\"h-12 w-12 text-green-600 mx-auto\" />\r\n                    <div className=\"font-medium\">{file.name}</div>\r\n                    <div className=\"text-sm text-muted-foreground\">\r\n                      {(file.size / 1024 / 1024).toFixed(2)} MB\r\n                    </div>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => setFile(null)}\r\n                    >\r\n                      <X className=\"h-4 w-4 mr-2\" />\r\n                      Remove\r\n                    </Button>\r\n                  </div>\r\n                ) : (\r\n                  <>\r\n                    <FileUp className=\"h-12 w-12 text-muted-foreground mx-auto\" />\r\n                    <div className=\"mt-4\">\r\n                      <Label htmlFor=\"file-input\" className=\"cursor-pointer\">\r\n                        <div className=\"text-sm font-medium text-blue-600 hover:text-blue-700\">\r\n                          Click to upload or drag and drop\r\n                        </div>\r\n                      </Label>\r\n                      <Input\r\n                        id=\"file-input\"\r\n                        type=\"file\"\r\n                        accept=\".xlsx,.xls,.csv\"\r\n                        onChange={handleFileSelect}\r\n                        className=\"hidden\"\r\n                      />\r\n                      <div className=\"text-xs text-muted-foreground mt-2\">\r\n                        Excel (.xlsx, .xls) or CSV files only\r\n                      </div>\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Supplier Selection */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"supplier\">Supplier</Label>\r\n              <Select value={supplierId || undefined} onValueChange={setSupplierId}>\r\n                <SelectTrigger id=\"supplier\">\r\n                  <SelectValue placeholder=\"Select supplier\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {suppliers.length > 0 ? (\r\n                    suppliers.map((supplier) => (\r\n                      <SelectItem\r\n                        key={supplier.id}\r\n                        value={supplier.id}\r\n                      >\r\n                        {supplier.name} {supplier.code && `(${supplier.code})`}\r\n                      </SelectItem>\r\n                    ))\r\n                  ) : (\r\n                    <div className=\"p-2 text-sm text-muted-foreground text-center\">\r\n                      No suppliers found\r\n                    </div>\r\n                  )}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            {/* Currency Info */}\r\n            <Alert>\r\n              <Info className=\"h-4 w-4\" />\r\n              <AlertDescription>\r\n                {supplierId ? (\r\n                  (() => {\r\n                    const selectedSupplier = suppliers.find(s => s.id === supplierId)\r\n                    const currency = selectedSupplier?.default_currency || \r\n                                     (selectedSupplier as any)?.currency || \r\n                                     'ZAR'\r\n                    return `Prices will be imported in ${currency}. The system will automatically map columns and validate data.`\r\n                  })()\r\n                ) : (\r\n                  'Prices will be imported in ZAR (South African Rand). The system will automatically map columns and validate data.'\r\n                )}\r\n              </AlertDescription>\r\n            </Alert>\r\n          </div>\r\n        )\r\n\r\n      case 2:\r\n        return (\r\n          <div className=\"space-y-6\">\r\n            <div className=\"text-center py-8\">\r\n              <Loader2 className=\"h-16 w-16 animate-spin text-blue-600 mx-auto\" />\r\n              <div className=\"mt-4 font-medium text-lg\">Validating Upload...</div>\r\n              <div className=\"text-sm text-muted-foreground mt-2\">\r\n                Checking data quality and mapping fields\r\n              </div>\r\n              <Progress value={validationProgress} className=\"mt-4 max-w-md mx-auto\" />\r\n              <div className=\"text-xs text-muted-foreground mt-2\">\r\n                {validationProgress}% complete\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )\r\n\r\n      case 3:\r\n        return (\r\n          <div className=\"space-y-6\">\r\n            {validationResult && (\r\n              <>\r\n                {/* Summary Cards */}\r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\r\n                        Total Rows\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"text-2xl font-bold\">{validationResult.total_rows}</div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\r\n                        Valid Rows\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"text-2xl font-bold text-green-600\">\r\n                        {validationResult.valid_rows}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\r\n                        Errors\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"text-2xl font-bold text-red-600\">\r\n                        {validationResult.invalid_rows}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>\r\n\r\n                {/* Validation Status */}\r\n                <Alert className={cn(\r\n                  validationResult.status === 'valid' && \"border-green-200 bg-green-50\",\r\n                  validationResult.status === 'invalid' && \"border-red-200 bg-red-50\",\r\n                  validationResult.status === 'warning' && \"border-yellow-200 bg-yellow-50\"\r\n                )}>\r\n                  {validationResult.status === 'valid' && <CheckCircle2 className=\"h-4 w-4 text-green-600\" />}\r\n                  {validationResult.status === 'invalid' && <AlertCircle className=\"h-4 w-4 text-red-600\" />}\r\n                  {validationResult.status === 'warning' && <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />}\r\n                  <AlertDescription>\r\n                    {validationResult.status === 'valid' && 'All data validated successfully. Ready to merge.'}\r\n                    {validationResult.status === 'invalid' && `Found ${validationResult.errors.length} errors that must be fixed before merging.`}\r\n                    {validationResult.status === 'warning' && `Validation passed with ${validationResult.warnings.length} warnings.`}\r\n                  </AlertDescription>\r\n                </Alert>\r\n\r\n                {/* Summary Metrics */}\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                  <div className=\"flex items-center gap-2 p-3 border rounded-lg\">\r\n                    <Sparkles className=\"h-5 w-5 text-blue-600\" />\r\n                    <div>\r\n                      <div className=\"text-sm text-muted-foreground\">New Products</div>\r\n                      <div className=\"font-medium\">{validationResult.summary.new_products}</div>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2 p-3 border rounded-lg\">\r\n                    <TrendingUp className=\"h-5 w-5 text-green-600\" />\r\n                    <div>\r\n                      <div className=\"text-sm text-muted-foreground\">Price Updates</div>\r\n                      <div className=\"font-medium\">{validationResult.summary.updated_prices}</div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Errors */}\r\n                {validationResult.errors.length > 0 && (\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-base flex items-center gap-2\">\r\n                        <AlertCircle className=\"h-5 w-5 text-red-600\" />\r\n                        Validation Errors ({validationResult.errors.length})\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <ScrollArea className=\"h-48\">\r\n                        <div className=\"space-y-2\">\r\n                          {validationResult.errors.slice(0, 10).map((error, idx) => (\r\n                            <div key={idx} className=\"text-sm p-2 bg-red-50 border border-red-200 rounded\">\r\n                              <span className=\"font-medium\">Row {error.row_num}:</span> {error.message}\r\n                              {error.field && <span className=\"text-muted-foreground\"> (field: {error.field})</span>}\r\n                            </div>\r\n                          ))}\r\n                          {validationResult.errors.length > 10 && (\r\n                            <div className=\"text-sm text-muted-foreground text-center py-2\">\r\n                              + {validationResult.errors.length - 10} more errors\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </ScrollArea>\r\n                      <Button variant=\"outline\" size=\"sm\" className=\"mt-3\">\r\n                        <Download className=\"h-4 w-4 mr-2\" />\r\n                        Download Error Report\r\n                      </Button>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n\r\n                {/* Warnings */}\r\n                {validationResult.warnings.length > 0 && (\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-base flex items-center gap-2\">\r\n                        <AlertTriangle className=\"h-5 w-5 text-yellow-600\" />\r\n                        Warnings ({validationResult.warnings.length})\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <ScrollArea className=\"h-32\">\r\n                        <div className=\"space-y-2\">\r\n                          {validationResult.warnings.slice(0, 5).map((warning, idx) => (\r\n                            <div key={idx} className=\"text-sm p-2 bg-yellow-50 border border-yellow-200 rounded\">\r\n                              <span className=\"font-medium\">Row {warning.row_num}:</span> {warning.message}\r\n                            </div>\r\n                          ))}\r\n                        </div>\r\n                      </ScrollArea>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n              </>\r\n            )}\r\n          </div>\r\n        )\r\n\r\n      case 4:\r\n        return (\r\n          <div className=\"space-y-6\">\r\n            <div className=\"text-center py-8\">\r\n              <Loader2 className=\"h-16 w-16 animate-spin text-blue-600 mx-auto\" />\r\n              <div className=\"mt-4 font-medium text-lg\">Merging to Catalog...</div>\r\n              <div className=\"text-sm text-muted-foreground mt-2\">\r\n                Creating supplier products and updating price history\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )\r\n\r\n      case 5:\n        return (\n          <div className=\"space-y-6\">\n            {mergeMutation.data && (\n              <>\n                <div className=\"text-center py-6\">\r\n                  <div className=\"mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center\">\r\n                    <CheckCircle2 className=\"h-10 w-10 text-green-600\" />\r\n                  </div>\r\n                  <div className=\"mt-4 font-medium text-lg\">Upload Complete!</div>\r\n                  <div className=\"text-sm text-muted-foreground mt-2\">\r\n                    Successfully merged pricelist to catalog\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Merge Statistics */}\r\n                <div className=\"grid grid-cols-3 gap-4\">\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\r\n                        Products Created\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"text-2xl font-bold text-blue-600\">\r\n                        {mergeMutation.data.products_created}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\r\n                        Products Updated\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"text-2xl font-bold text-green-600\">\r\n                        {mergeMutation.data.products_updated}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\r\n                        Prices Updated\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"text-2xl font-bold text-purple-600\">\r\n                        {mergeMutation.data.prices_updated}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>\r\n\r\n                {/* Next Steps */}\r\n                <Alert>\n                  <ArrowRight className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    <strong>Next Step:</strong> Review updated products in the catalog. This upload updated pricing and created any missing products.\n                  </AlertDescription>\n                </Alert>\n\n              </>\n            )}\n          </div>\n        )\n\r\n      default:\r\n        return null\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle>Upload Supplier Pricelist</DialogTitle>\r\n          <DialogDescription>\r\n            The single canonical system for uploading all supplier pricelists\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {/* Progress Steps */}\r\n        <div className=\"py-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            {STEPS.map((step, idx) => (\r\n              <React.Fragment key={step.id}>\r\n                <div className=\"flex flex-col items-center\">\r\n                  <div className={cn(\r\n                    \"w-10 h-10 rounded-full flex items-center justify-center font-medium transition-colors\",\r\n                    currentStep > step.id && \"bg-green-600 text-white\",\r\n                    currentStep === step.id && \"bg-blue-600 text-white\",\r\n                    currentStep < step.id && \"bg-gray-200 text-gray-600\"\r\n                  )}>\r\n                    {currentStep > step.id ? <CheckCircle2 className=\"h-6 w-6\" /> : step.id}\r\n                  </div>\r\n                  <div className=\"mt-2 text-xs font-medium text-center\">\r\n                    {step.name}\r\n                  </div>\r\n                </div>\r\n                {idx < STEPS.length - 1 && (\r\n                  <div className={cn(\r\n                    \"flex-1 h-1 mx-2 transition-colors\",\r\n                    currentStep > step.id ? \"bg-green-600\" : \"bg-gray-200\"\r\n                  )} />\r\n                )}\r\n              </React.Fragment>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Error Display */}\r\n        {error && (\r\n          <Alert variant=\"destructive\">\r\n            <AlertCircle className=\"h-4 w-4\" />\r\n            <AlertDescription>{error}</AlertDescription>\r\n          </Alert>\r\n        )}\r\n\r\n        {/* Step Content */}\r\n        <div className=\"min-h-[400px]\">\r\n          <AnimatePresence mode=\"wait\">\r\n            <motion.div\r\n              key={currentStep}\r\n              initial={{ opacity: 0, x: 20 }}\r\n              animate={{ opacity: 1, x: 0 }}\r\n              exit={{ opacity: 0, x: -20 }}\r\n              transition={{ duration: 0.2 }}\r\n            >\r\n              {renderStepContent()}\r\n            </motion.div>\r\n          </AnimatePresence>\r\n        </div>\r\n\r\n        {/* Actions */}\r\n        <div className=\"flex justify-between pt-4 border-t\">\r\n          <Button\r\n            variant=\"outline\"\r\n            onClick={handleClose}\r\n            disabled={loading}\r\n          >\r\n            {currentStep === 5 ? 'Close' : 'Cancel'}\r\n          </Button>\r\n\r\n          <div className=\"flex gap-2\">\r\n            {currentStep === 1 && (\r\n              <Button onClick={handleUpload} disabled={!file || !supplierId || loading}>\r\n                {loading ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : <Upload className=\"h-4 w-4 mr-2\" />}\r\n                Upload & Validate\r\n              </Button>\r\n            )}\r\n            {currentStep === 3 && validationResult && (\n              <>\n                {validationResult.status === 'invalid' ? (\n                  <>\n                    <Button variant=\"outline\" onClick={() => setCurrentStep(1)}>\n                      Fix & Re-upload\n                    </Button>\n                    <Button onClick={() => handleMerge(true)} disabled={loading}>\n                      {loading ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : null}\n                      Proceed with {validationResult.valid_rows} of {validationResult.total_rows}\n                    </Button>\n                  </>\n                ) : (\n                  <Button onClick={() => handleMerge(false)} disabled={loading}>\n                    {loading ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : null}\n                    Merge to Catalog\n                  </Button>\n                )}\n              </>\n            )}\n            {currentStep === 5 && (\n              <Button onClick={handleClose}>\n                Close\n                <ArrowRight className=\"h-4 w-4 ml-2\" />\n              </Button>\n            )}\n          </div>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\supplier-portfolio\\ISIWizard.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":183,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":183,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":229,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":229,"endColumn":12}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useCallback, useEffect } from 'react'\r\nimport { motion } from 'framer-motion'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Label } from '@/components/ui/label'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogDescription,\r\n  DialogFooter,\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport {\r\n  CheckCircle2,\r\n  Info,\r\n  TrendingUp,\r\n  AlertCircle,\r\n  Loader2,\r\n  Package,\r\n  DollarSign,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n} from 'lucide-react'\r\nimport { cn, formatCurrency } from '@/lib/utils'\r\nimport { useToast } from '@/hooks/use-toast'\r\nimport {\r\n  useActiveSelection,\r\n  useSelections,\r\n  useCreateSelection,\r\n  useAddProductsToSelection,\r\n  useActivateSelection,\r\n  useSelectionProducts,\r\n} from '@/hooks/useNeonSpp'\r\nimport SupplierProductDataTable from './SupplierProductDataTable'\r\nimport type { InventorySelection } from '@/types/nxt-spp'\r\n\r\ninterface ISIWizardProps {\r\n  defaultSupplierId?: string\r\n  defaultSelectionId?: string\r\n  onComplete?: (selection: InventorySelection) => void\r\n  onCancel?: () => void\r\n  onNavigateToReports?: () => void\r\n}\r\n\r\nexport function ISIWizard({\r\n  defaultSupplierId,\r\n  defaultSelectionId,\r\n  onComplete,\r\n  onCancel,\r\n  onNavigateToReports,\r\n}: ISIWizardProps) {\r\n  // State\r\n  const [selectionId, setSelectionId] = useState<string | null>(defaultSelectionId || null)\r\n  const [selectionName, setSelectionName] = useState('')\r\n  const [selectedProductIds, setSelectedProductIds] = useState<string[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [showCreateDialog, setShowCreateDialog] = useState(!defaultSelectionId)\r\n  const [showActivateDialog, setShowActivateDialog] = useState(false)\r\n  const [showConflictDialog, setShowConflictDialog] = useState(false)\r\n  const [conflictInfo, setConflictInfo] = useState<{\r\n    active_selection_id: string\r\n    active_selection_name: string\r\n  } | null>(null)\r\n  const [selections, setSelections] = useState<InventorySelection[]>([])\r\n  const [activeSelection, setActiveSelection] = useState<InventorySelection | null>(null)\r\n  const [selectionSummary, setSelectionSummary] = useState({\r\n    count: 0,\r\n    totalValue: 0,\r\n    supplierCount: 0,\r\n    categoryCount: 0,\r\n  })\r\n\r\n  // Load existing selections and active selection\r\n  useEffect(() => {\r\n    fetchSelections()\r\n    fetchActiveSelection()\r\n  }, [])\r\n\r\n  const fetchSelections = async () => {\r\n    try {\r\n      const response = await fetch('/api/core/selections?status=draft,active')\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        setSelections(data.data || [])\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to fetch selections:', err)\r\n    }\r\n  }\r\n\r\n  const fetchActiveSelection = async () => {\r\n    try {\r\n      const response = await fetch('/api/core/selections/active')\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        setActiveSelection(data.data)\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to fetch active selection:', err)\r\n    }\r\n  }\r\n\r\n  // Create new selection\r\n  const handleCreateSelection = async () => {\r\n    if (!selectionName.trim()) {\r\n      setError('Please enter a selection name')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch('/api/core/selections', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          selection_name: selectionName,\r\n          description: 'Created via ISI Wizard',\r\n          created_by: '00000000-0000-0000-0000-000000000000', // System user placeholder\r\n          status: 'draft',\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) throw new Error('Failed to create selection')\r\n\r\n      const result = await response.json()\r\n      setSelectionId(result.selection.selection_id)\r\n      setShowCreateDialog(false)\r\n      fetchSelections()\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Failed to create selection')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  // Add products to selection\r\n  const handleAddToSelection = async () => {\r\n    if (!selectionId || selectedProductIds.length === 0) {\r\n      setError('No products selected')\r\n      return\r\n    }\r\n\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch('/api/core/selections/workflow', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          selection_id: selectionId,\r\n          supplier_product_ids: selectedProductIds,\r\n          action: 'select',\r\n          selected_by: '00000000-0000-0000-0000-000000000000', // System user placeholder\r\n        }),\r\n      })\r\n\r\n      if (!response.ok) throw new Error('Failed to add products')\r\n\r\n      const result = await response.json()\r\n\r\n      // Clear selection and show success\r\n      setSelectedProductIds([])\r\n      updateSelectionSummary()\r\n\r\n      // Show success notification\r\n      alert(`Successfully added ${result.items_affected} products to selection`)\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Failed to add products')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  // Activate selection with single-active enforcement\r\n  const handleActivateSelection = async (deactivateOthers = false) => {\r\n    if (!selectionId) return\r\n\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch(`/api/core/selections/${selectionId}/activate`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ deactivate_others: deactivateOthers }),\r\n      })\r\n\r\n      const result = await response.json()\r\n\r\n      if (response.status === 409) {\r\n        // Conflict: Another selection is active\r\n        setConflictInfo(result.conflict)\r\n        setShowActivateDialog(false)\r\n        setShowConflictDialog(true)\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      if (!response.ok) {\r\n        throw new Error(result.error || 'Failed to activate selection')\r\n      }\r\n\r\n      // Success! Invalidate caches and refresh\r\n      setShowActivateDialog(false)\r\n      setShowConflictDialog(false)\r\n\r\n      // Trigger cache invalidation on frontend\r\n      await fetchActiveSelection()\r\n      await fetchSelections()\r\n\r\n      // Show success message\r\n      alert('Selection activated successfully! All stock reports now reflect this selection.')\r\n\r\n      // Call completion handler\r\n      if (onComplete) {\r\n        onComplete(result.data)\r\n      }\r\n\r\n      // Navigate to stock reports\r\n      if (onNavigateToReports) {\r\n        onNavigateToReports()\r\n      }\r\n\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Failed to activate selection')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  // Update selection summary\r\n  const updateSelectionSummary = useCallback(async () => {\r\n    if (!selectionId) return\r\n\r\n    try {\r\n      // Fetch selection items\r\n      const itemsResponse = await fetch(`/api/core/selections/${selectionId}/items`)\r\n      if (!itemsResponse.ok) {\r\n        console.error('Failed to fetch selection items')\r\n        return\r\n      }\r\n\r\n      const itemsData = await itemsResponse.json()\r\n      const items = itemsData.data || []\r\n\r\n      // Fetch catalog to get enriched product data with prices\r\n      const catalogResponse = await fetch('/api/core/selections/catalog')\r\n      if (!catalogResponse.ok) {\r\n        // Fallback to basic item count if catalog fails\r\n        setSelectionSummary({\r\n          count: items.length,\r\n          totalValue: 0,\r\n          supplierCount: 0,\r\n          categoryCount: 0,\r\n        })\r\n        return\r\n      }\r\n\r\n      const catalogData = await catalogResponse.json()\r\n      const catalog = catalogData.catalog || []\r\n\r\n      // Match items with catalog to get enriched data\r\n      const enrichedItems = items.map((item: any) => {\r\n        const catalogProduct = catalog.find((p: any) => p.supplier_product_id === item.supplier_product_id)\r\n        return {\r\n          ...item,\r\n          current_price: catalogProduct?.current_price || 0,\r\n          supplier_id: catalogProduct?.supplier_id || item.supplier_id,\r\n          category_id: catalogProduct?.category_id || item.category_id,\r\n        }\r\n      })\r\n\r\n      // Calculate metrics\r\n      const totalValue = enrichedItems.reduce((sum: number, item: any) => sum + (item.current_price || 0), 0)\r\n      const supplierIds = new Set(enrichedItems.map((item: any) => item.supplier_id).filter(Boolean))\r\n      const categoryIds = new Set(enrichedItems.map((item: any) => item.category_id).filter(Boolean))\r\n\r\n      setSelectionSummary({\r\n        count: enrichedItems.length,\r\n        totalValue,\r\n        supplierCount: supplierIds.size,\r\n        categoryCount: categoryIds.size,\r\n      })\r\n    } catch (err) {\r\n      console.error('Failed to update summary:', err)\r\n      // Set zero metrics on error\r\n      setSelectionSummary({\r\n        count: 0,\r\n        totalValue: 0,\r\n        supplierCount: 0,\r\n        categoryCount: 0,\r\n      })\r\n    }\r\n  }, [selectionId])\r\n\r\n  useEffect(() => {\r\n    if (selectionId) {\r\n      updateSelectionSummary()\r\n    }\r\n  }, [selectionId, updateSelectionSummary])\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Package className=\"h-6 w-6\" />\r\n              Inventory Selection Interface (ISI)\r\n            </div>\r\n            {selectionId && (\r\n              <div className=\"flex items-center gap-2\">\r\n                {activeSelection?.selection_id === selectionId && (\r\n                  <Badge variant=\"default\" className=\"bg-green-100 text-green-800\">\r\n                    <CheckCircle className=\"h-3 w-3 mr-1\" />\r\n                    Active\r\n                  </Badge>\r\n                )}\r\n                <Button\r\n                  onClick={() => setShowActivateDialog(true)}\r\n                  disabled={selectionSummary.count === 0 || activeSelection?.selection_id === selectionId}\r\n                >\r\n                  <CheckCircle2 className=\"h-4 w-4 mr-2\" />\r\n                  Activate Selection\r\n                </Button>\r\n              </div>\r\n            )}\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center justify-between\">\r\n            {/* Selection Info */}\r\n            <div className=\"flex items-center gap-4\">\r\n              <div>\r\n                <Label>Current Selection</Label>\r\n                <Select\r\n                  value={selectionId || ''}\r\n                  onValueChange={(value) => {\r\n                    if (value === 'new') {\r\n                      setShowCreateDialog(true)\r\n                    } else {\r\n                      setSelectionId(value)\r\n                    }\r\n                  }}\r\n                >\r\n                  <SelectTrigger className=\"w-[300px]\">\r\n                    <SelectValue placeholder=\"Select or create selection\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"new\">+ Create New Selection</SelectItem>\r\n                    {selections.map(sel => (\r\n                      <SelectItem key={sel.selection_id} value={sel.selection_id}>\r\n                        {sel.selection_name}\r\n                        <Badge variant=\"outline\" className=\"ml-2\">\r\n                          {sel.status}\r\n                        </Badge>\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Summary Metrics */}\r\n            {selectionId && (\r\n              <div className=\"grid grid-cols-4 gap-4\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"text-2xl font-bold text-blue-600\">\r\n                    {selectionSummary.count}\r\n                  </div>\r\n                  <div className=\"text-xs text-muted-foreground\">Products</div>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <div className=\"text-2xl font-bold text-green-600\">\r\n                    {formatCurrency(selectionSummary.totalValue)}\r\n                  </div>\r\n                  <div className=\"text-xs text-muted-foreground\">Total Value</div>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <div className=\"text-2xl font-bold text-purple-600\">\r\n                    {selectionSummary.supplierCount}\r\n                  </div>\r\n                  <div className=\"text-xs text-muted-foreground\">Suppliers</div>\r\n                </div>\r\n                <div className=\"text-center\">\r\n                  <div className=\"text-2xl font-bold text-orange-600\">\r\n                    {selectionSummary.categoryCount}\r\n                  </div>\r\n                  <div className=\"text-xs text-muted-foreground\">Categories</div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Active Selection Banner */}\r\n      {activeSelection && activeSelection.selection_id !== selectionId && (\r\n        <Alert className=\"bg-yellow-50 border-yellow-200\">\r\n          <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\r\n          <AlertDescription>\r\n            <strong className=\"text-yellow-900\">Current Active Selection:</strong>{' '}\r\n            <span className=\"text-yellow-700\">{activeSelection.selection_name}</span>\r\n            <span className=\"text-yellow-600 ml-2\">\r\n              (This is currently shown in all stock reports)\r\n            </span>\r\n          </AlertDescription>\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Info Alert */}\r\n      {!selectionId && (\r\n        <Alert>\r\n          <Info className=\"h-4 w-4\" />\r\n          <AlertDescription>\r\n            Create or select an inventory selection to begin choosing products to stock.\r\n            Only products in the active selection will appear in stock reports.\r\n          </AlertDescription>\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Error Display */}\r\n      {error && (\r\n        <Alert variant=\"destructive\">\r\n          <AlertCircle className=\"h-4 w-4\" />\r\n          <AlertDescription>{error}</AlertDescription>\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Product Selection Table */}\r\n      {selectionId && (\r\n        <>\r\n          {/* Selection Actions */}\r\n          {selectedProductIds.length > 0 && (\r\n            <motion.div\r\n              initial={{ opacity: 0, y: -10 }}\r\n              animate={{ opacity: 1, y: 0 }}\r\n              className=\"sticky top-0 z-10 p-4 bg-blue-50 border border-blue-200 rounded-lg\"\r\n            >\r\n              <div className=\"flex items-center justify-between\">\r\n                <div className=\"text-sm font-medium text-blue-900\">\r\n                  {selectedProductIds.length} product{selectedProductIds.length !== 1 ? 's' : ''} selected\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                  <Button\r\n                    onClick={handleAddToSelection}\r\n                    disabled={loading}\r\n                    size=\"sm\"\r\n                  >\r\n                    {loading ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : <CheckCircle2 className=\"h-4 w-4 mr-2\" />}\r\n                    Add to Selection\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setSelectedProductIds([])}\r\n                  >\r\n                    Clear\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </motion.div>\r\n          )}\r\n\r\n          {/* Data Table */}\r\n          <SupplierProductDataTable\r\n            supplier_id={defaultSupplierId}\r\n            selection_id={selectionId}\r\n            enable_selection={true}\r\n            on_selection_change={setSelectedProductIds}\r\n          />\r\n        </>\r\n      )}\r\n\r\n      {/* Create Selection Dialog */}\r\n      <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Create Inventory Selection</DialogTitle>\r\n            <DialogDescription>\r\n              Name this selection to start choosing products to stock\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          <div className=\"space-y-4 py-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"selection-name\">Selection Name</Label>\r\n              <Input\r\n                id=\"selection-name\"\r\n                placeholder=\"e.g., Q1 2025 Inventory\"\r\n                value={selectionName}\r\n                onChange={(e) => setSelectionName(e.target.value)}\r\n                onKeyPress={(e) => e.key === 'Enter' && handleCreateSelection()}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setShowCreateDialog(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button onClick={handleCreateSelection} disabled={loading || !selectionName.trim()}>\r\n              {loading && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\r\n              Create Selection\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Activate Confirmation Dialog */}\r\n      <Dialog open={showActivateDialog} onOpenChange={setShowActivateDialog}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Activate Inventory Selection?</DialogTitle>\r\n            <DialogDescription>\r\n              This will make {selectionSummary.count} products available for stock tracking in NXT SOH reports.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          <div className=\"py-4 space-y-4\">\r\n            <Alert>\r\n              <Info className=\"h-4 w-4\" />\r\n              <AlertDescription>\r\n                <strong>Business Rule:</strong> Only ONE selection can be active at a time.\r\n                Activating this selection will ensure all stock reports show only these products.\r\n              </AlertDescription>\r\n            </Alert>\r\n\r\n            {activeSelection && activeSelection.selection_id !== selectionId && (\r\n              <Alert variant=\"destructive\">\r\n                <AlertTriangle className=\"h-4 w-4\" />\r\n                <AlertDescription>\r\n                  <strong>Warning:</strong> Another selection \"{activeSelection.selection_name}\" is currently active.\r\n                  Activating this selection will automatically archive the current one.\r\n                </AlertDescription>\r\n              </Alert>\r\n            )}\r\n          </div>\r\n\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setShowActivateDialog(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button onClick={() => handleActivateSelection(true)} disabled={loading}>\r\n              {loading && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\r\n              Activate Selection\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Conflict Resolution Dialog */}\r\n      <Dialog open={showConflictDialog} onOpenChange={setShowConflictDialog}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Selection Conflict</DialogTitle>\r\n            <DialogDescription>\r\n              Another selection is currently active\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          <div className=\"py-4 space-y-4\">\r\n            <Alert variant=\"destructive\">\r\n              <AlertTriangle className=\"h-4 w-4\" />\r\n              <AlertDescription>\r\n                <strong>Conflict:</strong> \"{conflictInfo?.active_selection_name}\" is currently the active selection.\r\n                Only one selection can be active at a time.\r\n              </AlertDescription>\r\n            </Alert>\r\n\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              Would you like to deactivate \"{conflictInfo?.active_selection_name}\" and activate this selection instead?\r\n            </p>\r\n\r\n            <Alert>\r\n              <Info className=\"h-4 w-4\" />\r\n              <AlertDescription>\r\n                The current selection will be archived (not deleted) and can be reactivated later.\r\n              </AlertDescription>\r\n            </Alert>\r\n          </div>\r\n\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setShowConflictDialog(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button onClick={() => handleActivateSelection(true)} disabled={loading} variant=\"destructive\">\r\n              {loading && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\r\n              Deactivate Current & Activate This\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\AIEnhancedSupplierDashboard.tsx","messages":[{"ruleId":"jsx-a11y/no-static-element-interactions","severity":2,"message":"Avoid non-native interactive elements. If using native HTML is not possible, add an appropriate role and support for tabbing, mouse, keyboard, and touch inputs to an interactive content element.","line":433,"column":27,"nodeType":"JSXOpeningElement","endLine":434,"endColumn":77}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useCallback, useEffect } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from '@/components/ui/tooltip'\r\nimport {\r\n  Brain,\r\n  Sparkles,\r\n  TrendingUp,\r\n  Target,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Star,\r\n  BarChart3,\r\n  MessageSquare,\r\n  Lightbulb,\r\n  Settings,\r\n  RefreshCw,\r\n  Download,\r\n  Plus,\r\n  Eye,\r\n  Activity,\r\n  DollarSign,\r\n  Clock,\r\n  Zap,\r\n  Loader2\r\n} from 'lucide-react'\r\n\r\n// Import existing supplier dashboard\r\nimport EnhancedSupplierDashboard from './EnhancedSupplierDashboard'\r\n\r\n// Import new AI components\r\nimport {\r\n  AISupplierDiscoveryPanel,\r\n  AISupplierInsightsPanel,\r\n  AIPredictiveAnalyticsDashboard,\r\n  useAISupplier,\r\n  useAISupplierRecommendations,\r\n  useAISupplierInsights\r\n} from './ai'\r\n\r\nimport type {\r\n  AISupplierRecommendation,\r\n  AISupplierInsight\r\n} from '@/types/ai-supplier'\r\n\r\ninterface AIEnhancedSupplierDashboardProps {\r\n  onSupplierSelect?: (supplier: any) => void\r\n  className?: string\r\n}\r\n\r\nexport default function AIEnhancedSupplierDashboard({\r\n  onSupplierSelect,\r\n  className\r\n}: AIEnhancedSupplierDashboardProps) {\r\n  const [activeTab, setActiveTab] = useState('dashboard')\r\n  const [showAIPanel, setShowAIPanel] = useState(true)\r\n  const [selectedSupplier, setSelectedSupplier] = useState<string | null>(null)\r\n  const [aiMode, setAiMode] = useState<'standard' | 'enhanced' | 'expert'>('enhanced')\r\n\r\n  // AI hooks for different functionalities\r\n  const {\r\n    state: aiState,\r\n    refreshAll: refreshAI\r\n  } = useAISupplier({\r\n    supplierId: selectedSupplier || undefined,\r\n    autoFetch: true,\r\n    enableRealTimeUpdates: true,\r\n    analysisDepth: aiMode === 'expert' ? 'comprehensive' : 'standard'\r\n  })\r\n\r\n  const {\r\n    recommendations,\r\n    loading: recommendationsLoading,\r\n    search: searchSuppliers\r\n  } = useAISupplierRecommendations()\r\n\r\n  const {\r\n    insights,\r\n    loading: insightsLoading,\r\n    refresh: refreshInsights,\r\n    bookmark: bookmarkInsight,\r\n    provideFeedback: provideInsightFeedback\r\n  } = useAISupplierInsights(selectedSupplier || undefined)\r\n\r\n  // Handle AI-driven supplier recommendation\r\n  const handleSupplierRecommend = useCallback((recommendation: AISupplierRecommendation) => {\r\n    console.log('AI Supplier Recommendation:', recommendation)\r\n    // Integration with existing supplier selection logic\r\n    if (onSupplierSelect) {\r\n      onSupplierSelect({\r\n        id: recommendation.supplier.id || `ai_rec_${recommendation.id}`,\r\n        name: recommendation.supplier.name,\r\n        category: recommendation.supplier.category,\r\n        aiRecommendation: true,\r\n        confidenceScore: recommendation.confidenceScore,\r\n        recommendationType: recommendation.recommendationType\r\n      })\r\n    }\r\n  }, [onSupplierSelect])\r\n\r\n  // Handle insight actions\r\n  const handleInsightAction = useCallback(async (insight: AISupplierInsight, action: string) => {\r\n    console.log('Insight Action:', { insight: insight.id, action })\r\n\r\n    // Example actions based on insight type\r\n    switch (action) {\r\n      case 'view_supplier':\r\n        if (insight.relatedSuppliers.length > 0) {\r\n          setSelectedSupplier(insight.relatedSuppliers[0])\r\n          setActiveTab('dashboard')\r\n        }\r\n        break\r\n      case 'generate_report':\r\n        // Trigger report generation\r\n        console.log('Generating report for insight:', insight.title)\r\n        break\r\n      case 'schedule_review':\r\n        // Schedule supplier review\r\n        console.log('Scheduling review based on insight:', insight.title)\r\n        break\r\n      default:\r\n        console.log('Unknown action:', action)\r\n    }\r\n  }, [])\r\n\r\n  // Calculate AI enhancement summary\r\n  const aiSummary = {\r\n    totalRecommendations: recommendations.length,\r\n    highConfidenceRecs: recommendations.filter(r => r.confidenceScore >= 80).length,\r\n    totalInsights: insights.length,\r\n    criticalInsights: insights.filter(i => i.impact === 'high' || i.impact === 'critical').length,\r\n    aiAccuracy: 94, // This would come from the AI service\r\n    modelVersion: aiState.aiConfig.modelVersions.recommendation || 'v2.1'\r\n  }\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <div className={`space-y-6 ${className}`}>\r\n        {/* AI Enhancement Header */}\r\n        <div className=\"flex items-center justify-between p-4 bg-gradient-to-r from-purple-50 via-blue-50 to-indigo-50 rounded-lg border\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"p-2 bg-purple-100 rounded-lg\">\r\n              <Brain className=\"h-6 w-6 text-purple-600\" />\r\n            </div>\r\n            <div>\r\n              <h2 className=\"text-lg font-semibold text-gray-900\">\r\n                AI-Enhanced Supplier Management\r\n              </h2>\r\n              <p className=\"text-sm text-gray-600\">\r\n                Powered by advanced AI • Model v{aiSummary.modelVersion} • {aiSummary.aiAccuracy}% accuracy\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2\">\r\n            {/* AI Mode Selector */}\r\n            <select\r\n              value={aiMode}\r\n              onChange={(e) => setAiMode(e.target.value as any)}\r\n              className=\"px-3 py-1 text-sm border rounded-md bg-white\"\r\n            >\r\n              <option value=\"standard\">Standard AI</option>\r\n              <option value=\"enhanced\">Enhanced AI</option>\r\n              <option value=\"expert\">Expert AI</option>\r\n            </select>\r\n\r\n            <Tooltip>\r\n              <TooltipTrigger asChild>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setShowAIPanel(!showAIPanel)}\r\n                >\r\n                  {showAIPanel ? <Eye className=\"h-4 w-4\" /> : <Sparkles className=\"h-4 w-4\" />}\r\n                </Button>\r\n              </TooltipTrigger>\r\n              <TooltipContent>\r\n                {showAIPanel ? 'Hide AI Panel' : 'Show AI Panel'}\r\n              </TooltipContent>\r\n            </Tooltip>\r\n\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={refreshAI}\r\n              disabled={aiState.recommendationsLoading || aiState.insightsLoading}\r\n            >\r\n              <RefreshCw className={`h-4 w-4 mr-2 ${\r\n                aiState.recommendationsLoading || aiState.insightsLoading ? 'animate-spin' : ''\r\n              }`} />\r\n              Refresh AI\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* AI Summary Cards */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n          <Card className=\"border-purple-200 bg-purple-50/50\">\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-purple-600\">AI Recommendations</p>\r\n                  <p className=\"text-2xl font-bold text-purple-900\">{aiSummary.totalRecommendations}</p>\r\n                  <p className=\"text-xs text-purple-600\">\r\n                    {aiSummary.highConfidenceRecs} high confidence\r\n                  </p>\r\n                </div>\r\n                <Target className=\"h-8 w-8 text-purple-500\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-blue-200 bg-blue-50/50\">\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-blue-600\">AI Insights</p>\r\n                  <p className=\"text-2xl font-bold text-blue-900\">{aiSummary.totalInsights}</p>\r\n                  <p className=\"text-xs text-blue-600\">\r\n                    {aiSummary.criticalInsights} critical\r\n                  </p>\r\n                </div>\r\n                <Lightbulb className=\"h-8 w-8 text-blue-500\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-green-200 bg-green-50/50\">\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-green-600\">Model Accuracy</p>\r\n                  <p className=\"text-2xl font-bold text-green-900\">{aiSummary.aiAccuracy}%</p>\r\n                  <p className=\"text-xs text-green-600\">Last 30 days</p>\r\n                </div>\r\n                <CheckCircle className=\"h-8 w-8 text-green-500\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card className=\"border-orange-200 bg-orange-50/50\">\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-orange-600\">Active Models</p>\r\n                  <p className=\"text-2xl font-bold text-orange-900\">4</p>\r\n                  <p className=\"text-xs text-orange-600\">Recommendations, Insights, Risk, Chat</p>\r\n                </div>\r\n                <Activity className=\"h-8 w-8 text-orange-500\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Main Dashboard with AI Integration */}\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-6\">\r\n          {/* Main Dashboard Area */}\r\n          <div className={showAIPanel ? \"lg:col-span-8\" : \"lg:col-span-12\"}>\r\n            <Tabs value={activeTab} onValueChange={setActiveTab}>\r\n              <TabsList className=\"grid w-full grid-cols-4\">\r\n                <TabsTrigger value=\"dashboard\">\r\n                  <BarChart3 className=\"h-4 w-4 mr-2\" />\r\n                  Dashboard\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"ai-discovery\">\r\n                  <Target className=\"h-4 w-4 mr-2\" />\r\n                  AI Discovery\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"ai-analytics\">\r\n                  <TrendingUp className=\"h-4 w-4 mr-2\" />\r\n                  AI Analytics\r\n                </TabsTrigger>\r\n                <TabsTrigger value=\"ai-chat\">\r\n                  <MessageSquare className=\"h-4 w-4 mr-2\" />\r\n                  AI Assistant\r\n                </TabsTrigger>\r\n              </TabsList>\r\n\r\n              {/* Enhanced Traditional Dashboard */}\r\n              <TabsContent value=\"dashboard\">\r\n                <div className=\"space-y-4\">\r\n                  {/* AI Enhancement Overlay for Traditional Dashboard */}\r\n                  {selectedSupplier && insights.length > 0 && (\r\n                    <Card className=\"border-blue-200 bg-blue-50/30\">\r\n                      <CardHeader className=\"pb-3\">\r\n                        <CardTitle className=\"flex items-center gap-2 text-base\">\r\n                          <Sparkles className=\"h-4 w-4 text-blue-600\" />\r\n                          AI Insights for Current Supplier\r\n                        </CardTitle>\r\n                      </CardHeader>\r\n                      <CardContent>\r\n                        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                          {insights.slice(0, 3).map((insight) => (\r\n                            <div key={insight.id} className=\"p-3 bg-white rounded-lg border\">\r\n                              <div className=\"flex items-center justify-between mb-2\">\r\n                                <Badge className={\r\n                                  insight.impact === 'high' ? 'bg-red-100 text-red-800' :\r\n                                  insight.impact === 'medium' ? 'bg-orange-100 text-orange-800' :\r\n                                  'bg-green-100 text-green-800'\r\n                                }>\r\n                                  {insight.impact.toUpperCase()}\r\n                                </Badge>\r\n                                <span className=\"text-xs text-muted-foreground\">\r\n                                  {insight.confidence}% confidence\r\n                                </span>\r\n                              </div>\r\n                              <h4 className=\"font-medium text-sm mb-1\">{insight.title}</h4>\r\n                              <p className=\"text-xs text-muted-foreground line-clamp-2\">\r\n                                {insight.description}\r\n                              </p>\r\n                            </div>\r\n                          ))}\r\n                        </div>\r\n                      </CardContent>\r\n                    </Card>\r\n                  )}\r\n\r\n                  {/* Original Enhanced Supplier Dashboard */}\r\n                  <EnhancedSupplierDashboard\r\n                    onSupplierSelect={(supplier) => {\r\n                      setSelectedSupplier(supplier.id)\r\n                      onSupplierSelect?.(supplier)\r\n                    }}\r\n                  />\r\n                </div>\r\n              </TabsContent>\r\n\r\n              {/* AI Discovery Tab */}\r\n              <TabsContent value=\"ai-discovery\">\r\n                <AISupplierDiscoveryPanel\r\n                  onSupplierRecommend={handleSupplierRecommend}\r\n                  onInsightAction={handleInsightAction}\r\n                />\r\n              </TabsContent>\r\n\r\n              {/* AI Analytics Tab */}\r\n              <TabsContent value=\"ai-analytics\">\r\n                <AIPredictiveAnalyticsDashboard />\r\n              </TabsContent>\r\n\r\n              {/* AI Chat Tab */}\r\n              <TabsContent value=\"ai-chat\">\r\n                <AISupplierInsightsPanel\r\n                  supplierId={selectedSupplier || undefined}\r\n                  onInsightAction={handleInsightAction}\r\n                  onNavigateToSupplier={(supplierId) => {\r\n                    setSelectedSupplier(supplierId)\r\n                    setActiveTab('dashboard')\r\n                  }}\r\n                />\r\n              </TabsContent>\r\n            </Tabs>\r\n          </div>\r\n\r\n          {/* AI Side Panel */}\r\n          {showAIPanel && (\r\n            <div className=\"lg:col-span-4\">\r\n              <div className=\"space-y-4 sticky top-6\">\r\n                {/* Quick AI Actions */}\r\n                <Card>\r\n                  <CardHeader className=\"pb-3\">\r\n                    <CardTitle className=\"text-base flex items-center gap-2\">\r\n                      <Zap className=\"h-4 w-4 text-yellow-600\" />\r\n                      Quick AI Actions\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-2\">\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      className=\"w-full justify-start\"\r\n                      onClick={() => searchSuppliers('sustainable packaging suppliers')}\r\n                      disabled={recommendationsLoading}\r\n                    >\r\n                      <Target className=\"h-4 w-4 mr-2\" />\r\n                      Find Sustainable Suppliers\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      className=\"w-full justify-start\"\r\n                      onClick={() => {\r\n                        setActiveTab('ai-analytics')\r\n                      }}\r\n                    >\r\n                      <TrendingUp className=\"h-4 w-4 mr-2\" />\r\n                      Analyze Market Trends\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      className=\"w-full justify-start\"\r\n                      onClick={() => {\r\n                        setActiveTab('ai-chat')\r\n                      }}\r\n                    >\r\n                      <MessageSquare className=\"h-4 w-4 mr-2\" />\r\n                      Ask AI Assistant\r\n                    </Button>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                {/* Recent AI Recommendations */}\r\n                {recommendations.length > 0 && (\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-base flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Star className=\"h-4 w-4 text-purple-600\" />\r\n                          Recent Recommendations\r\n                        </div>\r\n                        <Badge variant=\"outline\">{recommendations.length}</Badge>\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-3 max-h-64 overflow-y-auto\">\r\n                        {recommendations.slice(0, 3).map((rec) => (\r\n                          <div key={rec.id} className=\"p-3 border rounded-lg hover:bg-muted/50 cursor-pointer\"\r\n                               onClick={() => handleSupplierRecommend(rec)}>\r\n                            <div className=\"flex items-center justify-between mb-2\">\r\n                              <h4 className=\"font-medium text-sm\">{rec.supplier.name}</h4>\r\n                              <Badge className={\r\n                                rec.confidenceScore >= 90 ? 'bg-green-100 text-green-800' :\r\n                                rec.confidenceScore >= 70 ? 'bg-orange-100 text-orange-800' :\r\n                                'bg-gray-100 text-gray-800'\r\n                              }>\r\n                                {rec.confidenceScore}%\r\n                              </Badge>\r\n                            </div>\r\n                            <p className=\"text-xs text-muted-foreground mb-2\">\r\n                              {rec.supplier.category} • {rec.supplier.geographic_region}\r\n                            </p>\r\n                            <div className=\"flex items-center gap-1\">\r\n                              <CheckCircle className=\"h-3 w-3 text-green-500\" />\r\n                              <span className=\"text-xs text-green-700\">\r\n                                {rec.matchReasons[0]}\r\n                              </span>\r\n                            </div>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n\r\n                {/* Critical AI Insights */}\r\n                {insights.filter(i => i.impact === 'high' || i.impact === 'critical').length > 0 && (\r\n                  <Card>\r\n                    <CardHeader className=\"pb-3\">\r\n                      <CardTitle className=\"text-base flex items-center justify-between\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <AlertTriangle className=\"h-4 w-4 text-red-600\" />\r\n                          Critical Insights\r\n                        </div>\r\n                        <Badge variant=\"destructive\">\r\n                          {insights.filter(i => i.impact === 'high' || i.impact === 'critical').length}\r\n                        </Badge>\r\n                      </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-3 max-h-64 overflow-y-auto\">\r\n                        {insights\r\n                          .filter(i => i.impact === 'high' || i.impact === 'critical')\r\n                          .slice(0, 3)\r\n                          .map((insight) => (\r\n                            <div key={insight.id} className=\"p-3 border rounded-lg bg-red-50/50\">\r\n                              <div className=\"flex items-center justify-between mb-2\">\r\n                                <Badge className=\"bg-red-100 text-red-800 text-xs\">\r\n                                  {insight.impact.toUpperCase()}\r\n                                </Badge>\r\n                                <span className=\"text-xs text-muted-foreground\">\r\n                                  {insight.confidence}%\r\n                                </span>\r\n                              </div>\r\n                              <h4 className=\"font-medium text-sm mb-1\">{insight.title}</h4>\r\n                              <p className=\"text-xs text-muted-foreground\">\r\n                                {insight.description}\r\n                              </p>\r\n                              {insight.actionable && insight.suggestedActions.length > 0 && (\r\n                                <Button\r\n                                  size=\"sm\"\r\n                                  variant=\"outline\"\r\n                                  className=\"mt-2 w-full text-xs\"\r\n                                  onClick={() => handleInsightAction(insight, insight.suggestedActions[0].action)}\r\n                                >\r\n                                  {insight.suggestedActions[0].action}\r\n                                </Button>\r\n                              )}\r\n                            </div>\r\n                          ))}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                )}\r\n\r\n                {/* AI Performance Status */}\r\n                <Card>\r\n                  <CardHeader className=\"pb-3\">\r\n                    <CardTitle className=\"text-base flex items-center gap-2\">\r\n                      <Activity className=\"h-4 w-4 text-green-600\" />\r\n                      AI System Status\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"space-y-3\">\r\n                    <div className=\"space-y-2\">\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span>Model Accuracy</span>\r\n                        <span className=\"font-medium\">{aiSummary.aiAccuracy}%</span>\r\n                      </div>\r\n                      <Progress value={aiSummary.aiAccuracy} className=\"h-2\" />\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span>Response Time</span>\r\n                        <span className=\"font-medium\">1.2s avg</span>\r\n                      </div>\r\n                      <Progress value={85} className=\"h-2\" />\r\n                    </div>\r\n\r\n                    <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\r\n                      <span>Last updated: 2 min ago</span>\r\n                      <div className=\"flex items-center gap-1\">\r\n                        <div className=\"w-2 h-2 bg-green-500 rounded-full\"></div>\r\n                        <span>Online</span>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </TooltipProvider>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\AISupplierDiscovery.tsx","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":389,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":389,"endColumn":65,"suggestions":[{"messageId":"addBrackets","fix":{"range":[12495,12649],"text":"{ const riskOrder = { 'low': 0, 'medium': 1, 'high': 2 }\r\n          return riskOrder[a.complianceStatus.riskLevel] - riskOrder[b.complianceStatus.riskLevel] }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useEffect, useMemo, useCallback } from \"react\"\r\nimport { motion, AnimatePresence } from \"framer-motion\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\"\r\nimport {\r\n  Brain,\r\n  Search,\r\n  Sparkles,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  Building2,\r\n  MapPin,\r\n  Star,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Clock,\r\n  DollarSign,\r\n  Award,\r\n  ShieldCheck,\r\n  Zap,\r\n  Target,\r\n  Users,\r\n  Globe,\r\n  Activity,\r\n  BarChart3,\r\n  Eye,\r\n  Heart,\r\n  BookmarkPlus,\r\n  Filter,\r\n  SortAsc,\r\n  Loader2,\r\n  RefreshCw,\r\n  Info,\r\n  Lightbulb,\r\n  Crown,\r\n  Database,\r\n  Calculator,\r\n  ArrowRight,\r\n  ExternalLink,\r\n  ChevronRight,\r\n  Gauge\r\n} from \"lucide-react\"\r\n\r\n// AI Enhanced Types\r\ninterface AISupplierRecommendation {\r\n  id: string\r\n  name: string\r\n  legalName: string\r\n  industry: string\r\n  location: {\r\n    country: string\r\n    city: string\r\n    region: string\r\n    coordinates: { lat: number; lng: number }\r\n  }\r\n  aiMatchScore: number\r\n  confidenceLevel: number\r\n  reasoning: string[]\r\n  keyStrengths: string[]\r\n  potentialRisks: string[]\r\n  estimatedSavings: number\r\n  performancePreview: {\r\n    deliveryRating: number\r\n    qualityScore: number\r\n    sustainabilityRating: number\r\n    innovationIndex: number\r\n  }\r\n  marketIntelligence: {\r\n    marketPosition: 'leader' | 'challenger' | 'follower'\r\n    pricingTier: 'premium' | 'competitive' | 'budget'\r\n    growthTrend: number\r\n    marketShare: number\r\n  }\r\n  complianceStatus: {\r\n    certifications: string[]\r\n    riskLevel: 'low' | 'medium' | 'high'\r\n    lastAudit: string\r\n    complianceScore: number\r\n  }\r\n  contactRecommendation: {\r\n    bestTimeToContact: string\r\n    preferredChannel: 'email' | 'phone' | 'platform'\r\n    keyPersona: string\r\n    approachStrategy: string\r\n  }\r\n  tags: string[]\r\n  status: 'available' | 'exclusive' | 'preferred' | 'restricted'\r\n  lastUpdated: string\r\n}\r\n\r\ninterface AIInsight {\r\n  id: string\r\n  type: 'market_trend' | 'cost_opportunity' | 'risk_alert' | 'performance_insight'\r\n  title: string\r\n  description: string\r\n  impact: 'high' | 'medium' | 'low'\r\n  confidence: number\r\n  recommendation: string\r\n  data: any\r\n  createdAt: string\r\n}\r\n\r\ninterface AISupplierDiscoveryProps {\r\n  onSupplierSelect?: (supplier: AISupplierRecommendation) => void\r\n  onSupplierBookmark?: (supplierId: string) => void\r\n  initialQuery?: string\r\n  compactMode?: boolean\r\n}\r\n\r\nconst AISupplierDiscovery: React.FC<AISupplierDiscoveryProps> = ({\r\n  onSupplierSelect,\r\n  onSupplierBookmark,\r\n  initialQuery = \"\",\r\n  compactMode = false\r\n}) => {\r\n  // State Management\r\n  const [searchQuery, setSearchQuery] = useState(initialQuery)\r\n  const [aiProcessing, setAIProcessing] = useState(false)\r\n  const [recommendations, setRecommendations] = useState<AISupplierRecommendation[]>([])\r\n  const [selectedSupplier, setSelectedSupplier] = useState<AISupplierRecommendation | null>(null)\r\n  const [filters, setFilters] = useState({\r\n    industry: \"\",\r\n    location: \"\",\r\n    tier: \"\",\r\n    riskLevel: \"\",\r\n    minMatchScore: 70\r\n  })\r\n  const [sortBy, setSortBy] = useState<'match_score' | 'savings' | 'performance' | 'risk'>('match_score')\r\n  const [insights, setInsights] = useState<AIInsight[]>([])\r\n  const [bookmarkedSuppliers, setBookmarkedSuppliers] = useState<string[]>([])\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [activeTab, setActiveTab] = useState(\"recommendations\")\r\n\r\n  // AI-powered search with auto-suggestions\r\n  const [searchSuggestions, setSearchSuggestions] = useState<string[]>([])\r\n  const [showSuggestions, setShowSuggestions] = useState(false)\r\n\r\n  // Simulate AI processing and recommendations\r\n  const performAISearch = useCallback(async (query: string) => {\r\n    setAIProcessing(true)\r\n    setError(null)\r\n\r\n    try {\r\n      // Simulate API call delay\r\n      await new Promise(resolve => setTimeout(resolve, 1500))\r\n\r\n      // Mock AI recommendations\r\n      const mockRecommendations: AISupplierRecommendation[] = [\r\n        {\r\n          id: \"ai_sup_001\",\r\n          name: \"TechFlow Solutions\",\r\n          legalName: \"TechFlow Solutions Pty Ltd\",\r\n          industry: \"Technology Components\",\r\n          location: {\r\n            country: \"South Africa\",\r\n            city: \"Cape Town\",\r\n            region: \"Western Cape\",\r\n            coordinates: { lat: -33.9249, lng: 18.4241 }\r\n          },\r\n          aiMatchScore: 94,\r\n          confidenceLevel: 89,\r\n          reasoning: [\r\n            \"Perfect alignment with your technology procurement requirements\",\r\n            \"Exceptional delivery performance (98.2% on-time)\",\r\n            \"Strong sustainability credentials matching your ESG goals\",\r\n            \"Competitive pricing with 15% cost reduction potential\"\r\n          ],\r\n          keyStrengths: [\r\n            \"Advanced manufacturing capabilities\",\r\n            \"ISO 27001 certified security processes\",\r\n            \"Carbon-neutral operations\",\r\n            \"24/7 technical support\"\r\n          ],\r\n          potentialRisks: [\r\n            \"Single facility dependency\",\r\n            \"Limited backup suppliers\"\r\n          ],\r\n          estimatedSavings: 180000,\r\n          performancePreview: {\r\n            deliveryRating: 4.9,\r\n            qualityScore: 4.7,\r\n            sustainabilityRating: 4.8,\r\n            innovationIndex: 4.6\r\n          },\r\n          marketIntelligence: {\r\n            marketPosition: 'challenger',\r\n            pricingTier: 'competitive',\r\n            growthTrend: 15.2,\r\n            marketShare: 8.5\r\n          },\r\n          complianceStatus: {\r\n            certifications: [\"ISO 9001\", \"ISO 14001\", \"ISO 27001\", \"B-BBEE Level 2\"],\r\n            riskLevel: 'low',\r\n            lastAudit: \"2024-08-15\",\r\n            complianceScore: 96\r\n          },\r\n          contactRecommendation: {\r\n            bestTimeToContact: \"Tuesday-Thursday, 9AM-11AM SAST\",\r\n            preferredChannel: 'email',\r\n            keyPersona: \"Technical Decision Maker\",\r\n            approachStrategy: \"Lead with sustainability and innovation focus\"\r\n          },\r\n          tags: [\"AI-Recommended\", \"Sustainability Leader\", \"Innovation Partner\"],\r\n          status: 'available',\r\n          lastUpdated: new Date().toISOString()\r\n        },\r\n        {\r\n          id: \"ai_sup_002\",\r\n          name: \"Global Component Systems\",\r\n          legalName: \"Global Component Systems International\",\r\n          industry: \"Industrial Components\",\r\n          location: {\r\n            country: \"Germany\",\r\n            city: \"Munich\",\r\n            region: \"Bavaria\",\r\n            coordinates: { lat: 48.1351, lng: 11.5820 }\r\n          },\r\n          aiMatchScore: 87,\r\n          confidenceLevel: 82,\r\n          reasoning: [\r\n            \"Strong quality heritage with German engineering excellence\",\r\n            \"Proven track record with similar enterprises\",\r\n            \"Competitive pricing for premium quality\",\r\n            \"EU compliance reduces regulatory risk\"\r\n          ],\r\n          keyStrengths: [\r\n            \"Industry 4.0 manufacturing\",\r\n            \"Premium quality standards\",\r\n            \"European regulatory compliance\",\r\n            \"Strong R&D investment\"\r\n          ],\r\n          potentialRisks: [\r\n            \"Currency exchange rate exposure\",\r\n            \"Longer lead times due to distance\"\r\n          ],\r\n          estimatedSavings: 95000,\r\n          performancePreview: {\r\n            deliveryRating: 4.4,\r\n            qualityScore: 4.9,\r\n            sustainabilityRating: 4.3,\r\n            innovationIndex: 4.8\r\n          },\r\n          marketIntelligence: {\r\n            marketPosition: 'leader',\r\n            pricingTier: 'premium',\r\n            growthTrend: 8.1,\r\n            marketShare: 22.3\r\n          },\r\n          complianceStatus: {\r\n            certifications: [\"ISO 9001\", \"CE Marking\", \"REACH Compliance\"],\r\n            riskLevel: 'low',\r\n            lastAudit: \"2024-07-22\",\r\n            complianceScore: 94\r\n          },\r\n          contactRecommendation: {\r\n            bestTimeToContact: \"Monday-Friday, 2PM-4PM CET\",\r\n            preferredChannel: 'platform',\r\n            keyPersona: \"Engineering Specialist\",\r\n            approachStrategy: \"Emphasize precision and quality requirements\"\r\n          },\r\n          tags: [\"Premium Quality\", \"European Excellence\", \"R&D Leader\"],\r\n          status: 'preferred',\r\n          lastUpdated: new Date().toISOString()\r\n        }\r\n      ]\r\n\r\n      setRecommendations(mockRecommendations)\r\n\r\n      // Mock AI insights\r\n      const mockInsights: AIInsight[] = [\r\n        {\r\n          id: \"insight_001\",\r\n          type: 'cost_opportunity',\r\n          title: \"Significant Cost Reduction Opportunity\",\r\n          description: \"AI analysis indicates potential 18% cost reduction through strategic supplier consolidation\",\r\n          impact: 'high',\r\n          confidence: 91,\r\n          recommendation: \"Consider bundling requirements with TechFlow Solutions for volume discounts\",\r\n          data: { potentialSavings: 275000, timeframe: \"6 months\" },\r\n          createdAt: new Date().toISOString()\r\n        },\r\n        {\r\n          id: \"insight_002\",\r\n          type: 'market_trend',\r\n          title: \"Market Trend Alert: Supply Chain Diversification\",\r\n          description: \"Industry trend shows 35% increase in supply chain diversification initiatives\",\r\n          impact: 'medium',\r\n          confidence: 84,\r\n          recommendation: \"Consider geographic diversification with European suppliers\",\r\n          data: { trend: \"+35%\", timeline: \"Q4 2024\" },\r\n          createdAt: new Date().toISOString()\r\n        }\r\n      ]\r\n\r\n      setInsights(mockInsights)\r\n\r\n    } catch (err) {\r\n      setError(\"AI search failed. Please try again.\")\r\n      console.error(\"AI search error:\", err)\r\n    } finally {\r\n      setAIProcessing(false)\r\n    }\r\n  }, [])\r\n\r\n  // Search suggestions based on input\r\n  const updateSearchSuggestions = useCallback((query: string) => {\r\n    if (query.length < 2) {\r\n      setSearchSuggestions([])\r\n      setShowSuggestions(false)\r\n      return\r\n    }\r\n\r\n    const suggestions = [\r\n      \"Technology components with sustainability focus\",\r\n      \"Industrial automation suppliers in Europe\",\r\n      \"Cost-effective software licensing partners\",\r\n      \"Green energy equipment manufacturers\",\r\n      \"Automotive parts suppliers with ISO certification\"\r\n    ].filter(suggestion =>\r\n      suggestion.toLowerCase().includes(query.toLowerCase())\r\n    )\r\n\r\n    setSearchSuggestions(suggestions)\r\n    setShowSuggestions(suggestions.length > 0)\r\n  }, [])\r\n\r\n  // Handle search input changes\r\n  const handleSearchChange = (value: string) => {\r\n    setSearchQuery(value)\r\n    updateSearchSuggestions(value)\r\n  }\r\n\r\n  // Execute AI search\r\n  const executeSearch = () => {\r\n    if (searchQuery.trim()) {\r\n      setShowSuggestions(false)\r\n      performAISearch(searchQuery)\r\n    }\r\n  }\r\n\r\n  // Filter and sort recommendations\r\n  const filteredAndSortedRecommendations = useMemo(() => {\r\n    const filtered = recommendations.filter(supplier => {\r\n      return (\r\n        (!filters.industry || supplier.industry.includes(filters.industry)) &&\r\n        (!filters.location || supplier.location.country.includes(filters.location)) &&\r\n        (!filters.riskLevel || supplier.complianceStatus.riskLevel === filters.riskLevel) &&\r\n        (supplier.aiMatchScore >= filters.minMatchScore)\r\n      )\r\n    })\r\n\r\n    return filtered.sort((a, b) => {\r\n      switch (sortBy) {\r\n        case 'savings':\r\n          return b.estimatedSavings - a.estimatedSavings\r\n        case 'performance':\r\n          return b.performancePreview.deliveryRating - a.performancePreview.deliveryRating\r\n        case 'risk':\r\n          const riskOrder = { 'low': 0, 'medium': 1, 'high': 2 }\r\n          return riskOrder[a.complianceStatus.riskLevel] - riskOrder[b.complianceStatus.riskLevel]\r\n        default:\r\n          return b.aiMatchScore - a.aiMatchScore\r\n      }\r\n    })\r\n  }, [recommendations, filters, sortBy])\r\n\r\n  // Get match score color\r\n  const getMatchScoreColor = (score: number): string => {\r\n    if (score >= 90) return \"from-green-500 to-emerald-600\"\r\n    if (score >= 80) return \"from-blue-500 to-indigo-600\"\r\n    if (score >= 70) return \"from-yellow-500 to-orange-600\"\r\n    return \"from-red-500 to-pink-600\"\r\n  }\r\n\r\n  // Get performance indicator color\r\n  const getPerformanceColor = (score: number): string => {\r\n    if (score >= 4.5) return \"text-green-600\"\r\n    if (score >= 4.0) return \"text-blue-600\"\r\n    if (score >= 3.5) return \"text-yellow-600\"\r\n    return \"text-red-600\"\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* AI-Powered Header */}\r\n      <motion.div\r\n        initial={{ opacity: 0, y: 20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        className=\"bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 rounded-2xl p-8 text-white shadow-2xl\"\r\n      >\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"space-y-2\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <motion.div\r\n                animate={{ scale: [1, 1.1, 1] }}\r\n                transition={{ duration: 2, repeat: Infinity, ease: \"easeInOut\" }}\r\n                className=\"p-3 bg-white/20 rounded-xl backdrop-blur-sm\"\r\n              >\r\n                <Brain className=\"h-8 w-8\" />\r\n              </motion.div>\r\n              <div>\r\n                <h1 className=\"text-3xl font-bold\">AI Supplier Discovery</h1>\r\n                <p className=\"text-purple-100 text-lg\">Intelligent matching with market insights</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-3\">\r\n            <Badge variant=\"secondary\" className=\"bg-white/20 text-white border-white/30\">\r\n              <Sparkles className=\"h-4 w-4 mr-1\" />\r\n              AI Powered\r\n            </Badge>\r\n            <Badge variant=\"secondary\" className=\"bg-white/20 text-white border-white/30\">\r\n              <Database className=\"h-4 w-4 mr-1\" />\r\n              {recommendations.length} Found\r\n            </Badge>\r\n          </div>\r\n        </div>\r\n      </motion.div>\r\n      {/* AI Search Interface */}\r\n      <Card className=\"border-0 shadow-xl\">\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Search className=\"h-5 w-5\" />\r\n            Intelligent Search\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"space-y-4\">\r\n            <div className=\"relative\">\r\n              <div className=\"flex gap-2\">\r\n                <div className=\"flex-1 relative\">\r\n                  <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\r\n                  <Input\r\n                    placeholder=\"Describe what you're looking for (e.g., 'sustainable tech suppliers in Africa')\"\r\n                    value={searchQuery}\r\n                    onChange={(e) => handleSearchChange(e.target.value)}\r\n                    onKeyPress={(e) => e.key === 'Enter' && executeSearch()}\r\n                    className=\"pl-10 py-6 text-lg border-2 border-gray-200 focus:border-purple-500 rounded-xl\"\r\n                    aria-label=\"AI supplier search\"\r\n                  />\r\n                  {aiProcessing && (\r\n                    <div className=\"absolute right-3 top-3\">\r\n                      <Loader2 className=\"h-5 w-5 animate-spin text-purple-500\" />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n                <Button\r\n                  onClick={executeSearch}\r\n                  disabled={!searchQuery.trim() || aiProcessing}\r\n                  size=\"lg\"\r\n                  className=\"px-8 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-xl\"\r\n                >\r\n                  {aiProcessing ? (\r\n                    <Loader2 className=\"h-5 w-5 animate-spin mr-2\" />\r\n                  ) : (\r\n                    <Brain className=\"h-5 w-5 mr-2\" />\r\n                  )}\r\n                  AI Search\r\n                </Button>\r\n              </div>\r\n\r\n              {/* Search Suggestions */}\r\n              <AnimatePresence>\r\n                {showSuggestions && (\r\n                  <motion.div\r\n                    initial={{ opacity: 0, y: 10 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    exit={{ opacity: 0, y: -10 }}\r\n                    className=\"absolute z-10 w-full mt-2 bg-white border-2 border-gray-200 rounded-xl shadow-xl\"\r\n                  >\r\n                    {searchSuggestions.map((suggestion, index) => (\r\n                      <motion.div\r\n                        key={index}\r\n                        whileHover={{ backgroundColor: \"#f3f4f6\" }}\r\n                        className=\"px-4 py-3 cursor-pointer border-b border-gray-100 last:border-b-0\"\r\n                        onClick={() => {\r\n                          setSearchQuery(suggestion)\r\n                          setShowSuggestions(false)\r\n                          performAISearch(suggestion)\r\n                        }}\r\n                      >\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Lightbulb className=\"h-4 w-4 text-purple-500\" />\r\n                          <span className=\"text-sm\">{suggestion}</span>\r\n                        </div>\r\n                      </motion.div>\r\n                    ))}\r\n                  </motion.div>\r\n                )}\r\n              </AnimatePresence>\r\n            </div>\r\n\r\n            {/* Filters and Sort */}\r\n            <div className=\"flex flex-wrap gap-3\">\r\n              <Select value={filters.industry} onValueChange={(value) => setFilters({...filters, industry: value})}>\r\n                <SelectTrigger className=\"w-48\">\r\n                  <SelectValue placeholder=\"Industry\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">All Industries</SelectItem>\r\n                  <SelectItem value=\"Technology\">Technology</SelectItem>\r\n                  <SelectItem value=\"Manufacturing\">Manufacturing</SelectItem>\r\n                  <SelectItem value=\"Services\">Services</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n\r\n              <Select value={filters.location} onValueChange={(value) => setFilters({...filters, location: value})}>\r\n                <SelectTrigger className=\"w-48\">\r\n                  <SelectValue placeholder=\"Location\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">All Locations</SelectItem>\r\n                  <SelectItem value=\"South Africa\">South Africa</SelectItem>\r\n                  <SelectItem value=\"Europe\">Europe</SelectItem>\r\n                  <SelectItem value=\"Asia\">Asia</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n\r\n              <Select value={sortBy} onValueChange={(value) => setSortBy(value as any)}>\r\n                <SelectTrigger className=\"w-48\">\r\n                  <SelectValue />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"match_score\">AI Match Score</SelectItem>\r\n                  <SelectItem value=\"savings\">Estimated Savings</SelectItem>\r\n                  <SelectItem value=\"performance\">Performance</SelectItem>\r\n                  <SelectItem value=\"risk\">Risk Level</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n\r\n              <div className=\"flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg\">\r\n                <span className=\"text-sm text-gray-600\">Min Match:</span>\r\n                <span className=\"text-sm font-medium\">{filters.minMatchScore}%</span>\r\n                <input\r\n                  type=\"range\"\r\n                  min=\"50\"\r\n                  max=\"100\"\r\n                  value={filters.minMatchScore}\r\n                  onChange={(e) => setFilters({...filters, minMatchScore: parseInt(e.target.value)})}\r\n                  className=\"w-20\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n      {/* Error State */}\r\n      {error && (\r\n        <Alert className=\"border-red-200 bg-red-50\">\r\n          <AlertTriangle className=\"h-4 w-4 text-red-600\" />\r\n          <AlertDescription className=\"text-red-800\">\r\n            <div className=\"font-semibold mb-1\">AI Search Error</div>\r\n            <div>{error}</div>\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              className=\"mt-2\"\r\n              onClick={() => setError(null)}\r\n            >\r\n              Dismiss\r\n            </Button>\r\n          </AlertDescription>\r\n        </Alert>\r\n      )}\r\n      {/* Main Content Tabs */}\r\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\r\n        <TabsList className=\"grid w-full grid-cols-3\">\r\n          <TabsTrigger value=\"recommendations\" className=\"flex items-center gap-2\">\r\n            <Building2 className=\"h-4 w-4\" />\r\n            Recommendations\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"insights\" className=\"flex items-center gap-2\">\r\n            <Sparkles className=\"h-4 w-4\" />\r\n            Market Insights\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"comparison\" className=\"flex items-center gap-2\">\r\n            <BarChart3 className=\"h-4 w-4\" />\r\n            Comparison\r\n          </TabsTrigger>\r\n        </TabsList>\r\n\r\n        {/* Recommendations Tab */}\r\n        <TabsContent value=\"recommendations\">\r\n          {aiProcessing ? (\r\n            <motion.div\r\n              initial={{ opacity: 0 }}\r\n              animate={{ opacity: 1 }}\r\n              className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\"\r\n            >\r\n              {[1, 2, 3, 4].map((i) => (\r\n                <Card key={i} className=\"border-0 shadow-lg\">\r\n                  <CardContent className=\"p-6\">\r\n                    <div className=\"animate-pulse space-y-4\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <div className=\"w-12 h-12 bg-gray-200 rounded-xl\"></div>\r\n                        <div className=\"flex-1 space-y-2\">\r\n                          <div className=\"h-4 bg-gray-200 rounded w-3/4\"></div>\r\n                          <div className=\"h-3 bg-gray-200 rounded w-1/2\"></div>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"h-24 bg-gray-200 rounded\"></div>\r\n                      <div className=\"flex gap-2\">\r\n                        <div className=\"h-6 bg-gray-200 rounded w-20\"></div>\r\n                        <div className=\"h-6 bg-gray-200 rounded w-20\"></div>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              ))}\r\n            </motion.div>\r\n          ) : (\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n              <AnimatePresence>\r\n                {filteredAndSortedRecommendations.map((supplier, index) => (\r\n                  <motion.div\r\n                    key={supplier.id}\r\n                    initial={{ opacity: 0, y: 20 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    exit={{ opacity: 0, y: -20 }}\r\n                    transition={{ delay: index * 0.1 }}\r\n                  >\r\n                    <Card className=\"border-0 shadow-lg hover:shadow-xl transition-all duration-300 group\">\r\n                      <CardHeader className=\"pb-3\">\r\n                        <div className=\"flex items-start justify-between\">\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"p-3 bg-gradient-to-r from-purple-100 to-indigo-100 rounded-xl\">\r\n                              <Building2 className=\"h-6 w-6 text-purple-600\" />\r\n                            </div>\r\n                            <div>\r\n                              <CardTitle className=\"text-lg leading-tight\">{supplier.name}</CardTitle>\r\n                              <p className=\"text-sm text-gray-600\">{supplier.industry}</p>\r\n                              <div className=\"flex items-center gap-1 mt-1\">\r\n                                <MapPin className=\"h-3 w-3 text-gray-400\" />\r\n                                <span className=\"text-xs text-gray-500\">\r\n                                  {supplier.location.city}, {supplier.location.country}\r\n                                </span>\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"flex flex-col items-end gap-2\">\r\n                            <div className={`px-3 py-1 rounded-full bg-gradient-to-r ${getMatchScoreColor(supplier.aiMatchScore)} text-white text-sm font-bold`}>\r\n                              {supplier.aiMatchScore}% Match\r\n                            </div>\r\n                            <Button\r\n                              variant=\"ghost\"\r\n                              size=\"sm\"\r\n                              onClick={() => {\r\n                                const newBookmarks = bookmarkedSuppliers.includes(supplier.id)\r\n                                  ? bookmarkedSuppliers.filter(id => id !== supplier.id)\r\n                                  : [...bookmarkedSuppliers, supplier.id]\r\n                                setBookmarkedSuppliers(newBookmarks)\r\n                                onSupplierBookmark?.(supplier.id)\r\n                              }}\r\n                              className=\"text-gray-400 hover:text-red-500\"\r\n                            >\r\n                              <Heart\r\n                                className={`h-4 w-4 ${bookmarkedSuppliers.includes(supplier.id) ? 'fill-current text-red-500' : ''}`}\r\n                              />\r\n                            </Button>\r\n                          </div>\r\n                        </div>\r\n                      </CardHeader>\r\n\r\n                      <CardContent className=\"space-y-4\">\r\n                        {/* AI Confidence and Key Insights */}\r\n                        <div className=\"space-y-2\">\r\n                          <div className=\"flex items-center justify-between text-sm\">\r\n                            <span className=\"text-gray-600\">AI Confidence</span>\r\n                            <span className=\"font-medium\">{supplier.confidenceLevel}%</span>\r\n                          </div>\r\n                          <Progress value={supplier.confidenceLevel} className=\"h-2\" />\r\n                        </div>\r\n\r\n                        {/* Performance Preview */}\r\n                        <div className=\"grid grid-cols-2 gap-3 text-sm\">\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-gray-600\">Delivery</span>\r\n                            <span className={`font-medium flex items-center gap-1 ${getPerformanceColor(supplier.performancePreview.deliveryRating)}`}>\r\n                              <Star className=\"h-3 w-3 fill-current\" />\r\n                              {supplier.performancePreview.deliveryRating}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-gray-600\">Quality</span>\r\n                            <span className={`font-medium flex items-center gap-1 ${getPerformanceColor(supplier.performancePreview.qualityScore)}`}>\r\n                              <Award className=\"h-3 w-3\" />\r\n                              {supplier.performancePreview.qualityScore}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-gray-600\">Sustainability</span>\r\n                            <span className={`font-medium flex items-center gap-1 ${getPerformanceColor(supplier.performancePreview.sustainabilityRating)}`}>\r\n                              <ShieldCheck className=\"h-3 w-3\" />\r\n                              {supplier.performancePreview.sustainabilityRating}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-gray-600\">Innovation</span>\r\n                            <span className={`font-medium flex items-center gap-1 ${getPerformanceColor(supplier.performancePreview.innovationIndex)}`}>\r\n                              <Zap className=\"h-3 w-3\" />\r\n                              {supplier.performancePreview.innovationIndex}\r\n                            </span>\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Estimated Savings */}\r\n                        <div className=\"p-3 bg-green-50 rounded-lg\">\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <span className=\"text-sm text-green-700 font-medium\">Potential Savings</span>\r\n                            <span className=\"text-lg font-bold text-green-800\">\r\n                              ${(supplier.estimatedSavings / 1000).toFixed(0)}k\r\n                            </span>\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Key Strengths */}\r\n                        <div className=\"space-y-2\">\r\n                          <h4 className=\"text-sm font-medium text-gray-700\">Key Strengths</h4>\r\n                          <div className=\"flex flex-wrap gap-1\">\r\n                            {supplier.keyStrengths.slice(0, 2).map((strength, i) => (\r\n                              <Badge key={i} variant=\"outline\" className=\"text-xs\">\r\n                                {strength}\r\n                              </Badge>\r\n                            ))}\r\n                            {supplier.keyStrengths.length > 2 && (\r\n                              <Badge variant=\"outline\" className=\"text-xs\">\r\n                                +{supplier.keyStrengths.length - 2} more\r\n                              </Badge>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Action Buttons */}\r\n                        <div className=\"flex gap-2 pt-2\">\r\n                          <Button\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            onClick={() => setSelectedSupplier(supplier)}\r\n                            className=\"flex-1\"\r\n                          >\r\n                            <Eye className=\"h-4 w-4 mr-1\" />\r\n                            View Details\r\n                          </Button>\r\n                          <Button\r\n                            size=\"sm\"\r\n                            onClick={() => onSupplierSelect?.(supplier)}\r\n                            className=\"flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700\"\r\n                          >\r\n                            <ArrowRight className=\"h-4 w-4 mr-1\" />\r\n                            Connect\r\n                          </Button>\r\n                        </div>\r\n                      </CardContent>\r\n                    </Card>\r\n                  </motion.div>\r\n                ))}\r\n              </AnimatePresence>\r\n            </div>\r\n          )}\r\n        </TabsContent>\r\n\r\n        {/* Market Insights Tab */}\r\n        <TabsContent value=\"insights\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {insights.map((insight, index) => (\r\n              <motion.div\r\n                key={insight.id}\r\n                initial={{ opacity: 0, x: -20 }}\r\n                animate={{ opacity: 1, x: 0 }}\r\n                transition={{ delay: index * 0.1 }}\r\n              >\r\n                <Card className=\"border-0 shadow-lg\">\r\n                  <CardContent className=\"p-6\">\r\n                    <div className=\"flex items-start gap-4\">\r\n                      <div className={`p-3 rounded-xl ${\r\n                        insight.type === 'cost_opportunity' ? 'bg-green-100 text-green-600' :\r\n                        insight.type === 'market_trend' ? 'bg-blue-100 text-blue-600' :\r\n                        insight.type === 'risk_alert' ? 'bg-red-100 text-red-600' :\r\n                        'bg-purple-100 text-purple-600'\r\n                      }`}>\r\n                        {insight.type === 'cost_opportunity' && <DollarSign className=\"h-5 w-5\" />}\r\n                        {insight.type === 'market_trend' && <TrendingUp className=\"h-5 w-5\" />}\r\n                        {insight.type === 'risk_alert' && <AlertTriangle className=\"h-5 w-5\" />}\r\n                        {insight.type === 'performance_insight' && <BarChart3 className=\"h-5 w-5\" />}\r\n                      </div>\r\n                      <div className=\"flex-1 space-y-2\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <h3 className=\"font-semibold\">{insight.title}</h3>\r\n                          <Badge variant={insight.impact === 'high' ? 'destructive' : insight.impact === 'medium' ? 'default' : 'secondary'}>\r\n                            {insight.impact} impact\r\n                          </Badge>\r\n                        </div>\r\n                        <p className=\"text-sm text-gray-600\">{insight.description}</p>\r\n                        <div className=\"p-3 bg-blue-50 rounded-lg\">\r\n                          <h4 className=\"text-sm font-medium text-blue-800 mb-1\">Recommendation</h4>\r\n                          <p className=\"text-sm text-blue-700\">{insight.recommendation}</p>\r\n                        </div>\r\n                        <div className=\"flex items-center justify-between text-xs text-gray-500\">\r\n                          <span>{insight.confidence}% confidence</span>\r\n                          <span>{new Date(insight.createdAt).toLocaleDateString()}</span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </motion.div>\r\n            ))}\r\n          </div>\r\n        </TabsContent>\r\n\r\n        {/* Comparison Tab */}\r\n        <TabsContent value=\"comparison\">\r\n          <Card className=\"border-0 shadow-lg\">\r\n            <CardHeader>\r\n              <CardTitle>Supplier Comparison Matrix</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"overflow-x-auto\">\r\n                <table className=\"w-full\">\r\n                  <thead>\r\n                    <tr className=\"border-b\">\r\n                      <th className=\"text-left py-3 px-2\">Supplier</th>\r\n                      <th className=\"text-center py-3 px-2\">AI Match</th>\r\n                      <th className=\"text-center py-3 px-2\">Savings</th>\r\n                      <th className=\"text-center py-3 px-2\">Performance</th>\r\n                      <th className=\"text-center py-3 px-2\">Risk</th>\r\n                      <th className=\"text-center py-3 px-2\">Action</th>\r\n                    </tr>\r\n                  </thead>\r\n                  <tbody>\r\n                    {filteredAndSortedRecommendations.slice(0, 5).map((supplier, index) => (\r\n                      <tr key={supplier.id} className=\"border-b hover:bg-gray-50\">\r\n                        <td className=\"py-4 px-2\">\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"p-2 bg-purple-100 rounded-lg\">\r\n                              <Building2 className=\"h-4 w-4 text-purple-600\" />\r\n                            </div>\r\n                            <div>\r\n                              <div className=\"font-medium\">{supplier.name}</div>\r\n                              <div className=\"text-sm text-gray-500\">{supplier.location.country}</div>\r\n                            </div>\r\n                          </div>\r\n                        </td>\r\n                        <td className=\"text-center py-4 px-2\">\r\n                          <div className={`px-2 py-1 rounded-full bg-gradient-to-r ${getMatchScoreColor(supplier.aiMatchScore)} text-white text-sm font-medium`}>\r\n                            {supplier.aiMatchScore}%\r\n                          </div>\r\n                        </td>\r\n                        <td className=\"text-center py-4 px-2\">\r\n                          <div className=\"text-green-600 font-medium\">\r\n                            ${(supplier.estimatedSavings / 1000).toFixed(0)}k\r\n                          </div>\r\n                        </td>\r\n                        <td className=\"text-center py-4 px-2\">\r\n                          <div className=\"flex items-center justify-center gap-1\">\r\n                            <Star className=\"h-4 w-4 text-yellow-500 fill-current\" />\r\n                            <span>{supplier.performancePreview.deliveryRating}</span>\r\n                          </div>\r\n                        </td>\r\n                        <td className=\"text-center py-4 px-2\">\r\n                          <Badge variant={\r\n                            supplier.complianceStatus.riskLevel === 'low' ? 'default' :\r\n                            supplier.complianceStatus.riskLevel === 'medium' ? 'secondary' : 'destructive'\r\n                          }>\r\n                            {supplier.complianceStatus.riskLevel}\r\n                          </Badge>\r\n                        </td>\r\n                        <td className=\"text-center py-4 px-2\">\r\n                          <Button\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            onClick={() => setSelectedSupplier(supplier)}\r\n                          >\r\n                            <Eye className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </td>\r\n                      </tr>\r\n                    ))}\r\n                  </tbody>\r\n                </table>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n      </Tabs>\r\n      {/* Supplier Detail Dialog */}\r\n      {selectedSupplier && (\r\n        <Dialog open={!!selectedSupplier} onOpenChange={() => setSelectedSupplier(null)}>\r\n          <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-y-auto\">\r\n            <DialogHeader>\r\n              <DialogTitle className=\"flex items-center gap-3\">\r\n                <div className=\"p-2 bg-purple-100 rounded-lg\">\r\n                  <Building2 className=\"h-6 w-6 text-purple-600\" />\r\n                </div>\r\n                {selectedSupplier.name} - AI Analysis\r\n              </DialogTitle>\r\n              <DialogDescription>\r\n                Comprehensive AI-powered supplier analysis and recommendations\r\n              </DialogDescription>\r\n            </DialogHeader>\r\n\r\n            <div className=\"space-y-6\">\r\n              {/* AI Matching Analysis */}\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Brain className=\"h-5 w-5\" />\r\n                    AI Matching Analysis\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <div className=\"text-center\">\r\n                      <div className={`text-3xl font-bold bg-gradient-to-r ${getMatchScoreColor(selectedSupplier.aiMatchScore)} bg-clip-text text-transparent`}>\r\n                        {selectedSupplier.aiMatchScore}%\r\n                      </div>\r\n                      <div className=\"text-sm text-gray-600\">Match Score</div>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                      <div className=\"text-3xl font-bold text-blue-600\">\r\n                        {selectedSupplier.confidenceLevel}%\r\n                      </div>\r\n                      <div className=\"text-sm text-gray-600\">Confidence Level</div>\r\n                    </div>\r\n                    <div className=\"text-center\">\r\n                      <div className=\"text-3xl font-bold text-green-600\">\r\n                        ${(selectedSupplier.estimatedSavings / 1000).toFixed(0)}k\r\n                      </div>\r\n                      <div className=\"text-sm text-gray-600\">Potential Savings</div>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <Separator className=\"my-4\" />\r\n\r\n                  <div className=\"space-y-3\">\r\n                    <h4 className=\"font-medium\">AI Reasoning</h4>\r\n                    <div className=\"space-y-2\">\r\n                      {selectedSupplier.reasoning.map((reason, index) => (\r\n                        <div key={index} className=\"flex items-start gap-2\">\r\n                          <CheckCircle className=\"h-4 w-4 text-green-500 mt-0.5 flex-shrink-0\" />\r\n                          <span className=\"text-sm text-gray-700\">{reason}</span>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Performance Metrics */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle>Performance Preview</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"space-y-4\">\r\n                      {Object.entries(selectedSupplier.performancePreview).map(([key, value]) => (\r\n                        <div key={key} className=\"space-y-1\">\r\n                          <div className=\"flex justify-between text-sm\">\r\n                            <span className=\"capitalize\">{key.replace(/([A-Z])/g, ' $1')}</span>\r\n                            <span className=\"font-medium\">{value}/5</span>\r\n                          </div>\r\n                          <Progress value={(value / 5) * 100} className=\"h-2\" />\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle>Market Intelligence</CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"space-y-3\">\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Market Position</span>\r\n                        <Badge variant=\"outline\" className=\"capitalize\">\r\n                          {selectedSupplier.marketIntelligence.marketPosition}\r\n                        </Badge>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Pricing Tier</span>\r\n                        <Badge variant=\"outline\" className=\"capitalize\">\r\n                          {selectedSupplier.marketIntelligence.pricingTier}\r\n                        </Badge>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Growth Trend</span>\r\n                        <span className=\"text-sm font-medium text-green-600\">\r\n                          +{selectedSupplier.marketIntelligence.growthTrend}%\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"flex justify-between\">\r\n                        <span className=\"text-sm text-gray-600\">Market Share</span>\r\n                        <span className=\"text-sm font-medium\">\r\n                          {selectedSupplier.marketIntelligence.marketShare}%\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n\r\n              {/* Contact Recommendation */}\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Target className=\"h-5 w-5\" />\r\n                    AI Contact Strategy\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-3\">\r\n                      <div>\r\n                        <span className=\"text-sm text-gray-600\">Best Time to Contact</span>\r\n                        <div className=\"font-medium\">{selectedSupplier.contactRecommendation.bestTimeToContact}</div>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-sm text-gray-600\">Preferred Channel</span>\r\n                        <div className=\"font-medium capitalize\">{selectedSupplier.contactRecommendation.preferredChannel}</div>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"space-y-3\">\r\n                      <div>\r\n                        <span className=\"text-sm text-gray-600\">Key Persona</span>\r\n                        <div className=\"font-medium\">{selectedSupplier.contactRecommendation.keyPersona}</div>\r\n                      </div>\r\n                      <div>\r\n                        <span className=\"text-sm text-gray-600\">Approach Strategy</span>\r\n                        <div className=\"font-medium\">{selectedSupplier.contactRecommendation.approachStrategy}</div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              {/* Actions */}\r\n              <div className=\"flex gap-3 pt-4\">\r\n                <Button\r\n                  onClick={() => onSupplierSelect?.(selectedSupplier)}\r\n                  className=\"flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700\"\r\n                >\r\n                  <ArrowRight className=\"h-4 w-4 mr-2\" />\r\n                  Connect with Supplier\r\n                </Button>\r\n                <Button variant=\"outline\" className=\"flex-1\">\r\n                  <ExternalLink className=\"h-4 w-4 mr-2\" />\r\n                  View Company Profile\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </DialogContent>\r\n        </Dialog>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default AISupplierDiscovery","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\EnhancedSupplierDashboard.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'Brain' is not defined.","line":582,"column":14,"nodeType":"JSXIdentifier","messageId":"undef","endLine":582,"endColumn":19},{"ruleId":"no-undef","severity":2,"message":"'Sparkles' is not defined.","line":586,"column":14,"nodeType":"JSXIdentifier","messageId":"undef","endLine":586,"endColumn":22},{"ruleId":"no-undef","severity":2,"message":"'User' is not defined.","line":1146,"column":24,"nodeType":"JSXIdentifier","messageId":"undef","endLine":1146,"endColumn":28}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useMemo, useCallback, useEffect } from \"react\"\r\nimport { useSuppliers, useDashboardMetrics } from \"@/hooks/useSuppliers\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport { cn, formatCurrency, formatDate, formatPercentage } from \"@/lib/utils\"\r\nimport {\r\n  Building2,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Clock,\r\n  Users,\r\n  Package,\r\n  DollarSign,\r\n  Phone,\r\n  Mail,\r\n  FileText,\r\n  Star,\r\n  BarChart3,\r\n  Activity,\r\n  Calendar,\r\n  Globe,\r\n  MapPin,\r\n  Settings,\r\n  Eye,\r\n  Edit,\r\n  Download,\r\n  Upload,\r\n  RefreshCw,\r\n  Search,\r\n  Filter,\r\n  Plus,\r\n  MoreHorizontal,\r\n  History,\r\n  ShoppingCart,\r\n  Target,\r\n  Award,\r\n  Zap\r\n} from \"lucide-react\"\r\nimport NextJsXlsxConverter from \"@/components/inventory/NextJsXlsxConverter\"\r\nimport type { DataValidationResult } from \"@/components/inventory/NextJsXlsxConverter\"\r\nimport dynamic from 'next/dynamic'\r\nconst AISupplierDiscovery = dynamic(\r\n  () => import('@/components/suppliers/AISupplierDiscovery'),\r\n  {\r\n    loading: () => <div className=\"animate-pulse h-96 bg-gray-100 rounded-lg\" />,\r\n    ssr: false\r\n  }\r\n)\r\nimport AIInsightCards from \"@/components/ai/InsightCards\"\r\nimport AIChatInterface from \"@/components/ai/ChatInterface\"\r\nimport { AIErrorBoundary } from \"@/components/ai/AIErrorHandler\"\r\n\r\n// Enhanced Supplier Types\r\nexport interface SupplierPerformanceMetrics {\r\n  deliveryPerformance: {\r\n    onTimeDeliveryRate: number\r\n    averageDeliveryDays: number\r\n    totalDeliveries: number\r\n    lateDeliveries: number\r\n  }\r\n  qualityMetrics: {\r\n    qualityRating: number\r\n    defectRate: number\r\n    returnRate: number\r\n    qualityIssues: number\r\n  }\r\n  financialMetrics: {\r\n    totalSpend: number\r\n    averageOrderValue: number\r\n    paymentTerms: string\r\n    discountRate: number\r\n  }\r\n  relationshipMetrics: {\r\n    responsiveness: number\r\n    communication: number\r\n    innovation: number\r\n    sustainability: number\r\n  }\r\n}\r\n\r\nexport interface SupplierContact {\r\n  id: string\r\n  name: string\r\n  role: string\r\n  department: string\r\n  email: string\r\n  phone: string\r\n  isPrimary: boolean\r\n  isActive: boolean\r\n  createdAt: Date\r\n  lastContactDate?: Date\r\n}\r\n\r\nexport interface PricelistVersion {\r\n  id: string\r\n  version: string\r\n  fileName: string\r\n  uploadDate: Date\r\n  uploadedBy: string\r\n  itemCount: number\r\n  status: 'active' | 'archived' | 'draft'\r\n  effectiveDate: Date\r\n  expiryDate?: Date\r\n  changes: string[]\r\n  notes?: string\r\n}\r\n\r\nexport interface EnhancedSupplier {\r\n  id: string\r\n  code: string\r\n  name: string\r\n  legalName: string\r\n  website: string\r\n  industry: string\r\n  tier: 'tier_1' | 'tier_2' | 'tier_3' | 'strategic'\r\n  status: 'active' | 'inactive' | 'under_review' | 'suspended'\r\n\r\n  // Contact Information\r\n  primaryContact: SupplierContact\r\n  contacts: SupplierContact[]\r\n\r\n  // Address Information\r\n  addresses: {\r\n    billing: Address\r\n    shipping: Address\r\n    headquarters: Address\r\n  }\r\n\r\n  // Business Details\r\n  taxNumber: string\r\n  registrationNumber: string\r\n  certifications: string[]\r\n  paymentTerms: string\r\n  currency: string\r\n  creditLimit: number\r\n\r\n  // Performance\r\n  performanceMetrics: SupplierPerformanceMetrics\r\n  rating: number\r\n  ratingHistory: { date: Date; rating: number; notes: string }[]\r\n\r\n  // Pricelists\r\n  pricelists: PricelistVersion[]\r\n  activePricelistId?: string\r\n\r\n  // Audit Trail\r\n  createdAt: Date\r\n  updatedAt: Date\r\n  createdBy: string\r\n  updatedBy: string\r\n\r\n  // Additional Metadata\r\n  tags: string[]\r\n  notes: string\r\n  documents: { id: string; name: string; type: string; url: string; uploadDate: Date }[]\r\n\r\n  // Risk Assessment\r\n  riskLevel: 'low' | 'medium' | 'high' | 'critical'\r\n  riskFactors: string[]\r\n  lastRiskAssessment: Date\r\n}\r\n\r\ninterface Address {\r\n  street: string\r\n  city: string\r\n  state: string\r\n  postalCode: string\r\n  country: string\r\n}\r\n\r\n// Sample data\r\nconst sampleSuppliers: EnhancedSupplier[] = [\r\n  {\r\n    id: 'sup_001',\r\n    code: 'DELL_001',\r\n    name: 'Dell Technologies',\r\n    legalName: 'Dell Technologies Inc.',\r\n    website: 'https://dell.com',\r\n    industry: 'Technology Hardware',\r\n    tier: 'strategic',\r\n    status: 'active',\r\n    primaryContact: {\r\n      id: 'contact_001',\r\n      name: 'Sarah Johnson',\r\n      role: 'Account Manager',\r\n      department: 'Sales',\r\n      email: 'sarah.johnson@dell.com',\r\n      phone: '+1-555-0123',\r\n      isPrimary: true,\r\n      isActive: true,\r\n      createdAt: new Date('2024-01-15'),\r\n      lastContactDate: new Date('2024-09-20')\r\n    },\r\n    contacts: [],\r\n    addresses: {\r\n      billing: {\r\n        street: '1 Dell Way',\r\n        city: 'Round Rock',\r\n        state: 'TX',\r\n        postalCode: '78682',\r\n        country: 'USA'\r\n      },\r\n      shipping: {\r\n        street: '1 Dell Way',\r\n        city: 'Round Rock',\r\n        state: 'TX',\r\n        postalCode: '78682',\r\n        country: 'USA'\r\n      },\r\n      headquarters: {\r\n        street: '1 Dell Way',\r\n        city: 'Round Rock',\r\n        state: 'TX',\r\n        postalCode: '78682',\r\n        country: 'USA'\r\n      }\r\n    },\r\n    taxNumber: 'US123456789',\r\n    registrationNumber: 'DEL001234',\r\n    certifications: ['ISO 9001', 'ISO 14001', 'SOC 2'],\r\n    paymentTerms: 'Net 30',\r\n    currency: 'USD',\r\n    creditLimit: 1000000,\r\n    performanceMetrics: {\r\n      deliveryPerformance: {\r\n        onTimeDeliveryRate: 95.8,\r\n        averageDeliveryDays: 3.2,\r\n        totalDeliveries: 248,\r\n        lateDeliveries: 10\r\n      },\r\n      qualityMetrics: {\r\n        qualityRating: 4.8,\r\n        defectRate: 0.5,\r\n        returnRate: 1.2,\r\n        qualityIssues: 3\r\n      },\r\n      financialMetrics: {\r\n        totalSpend: 2850000,\r\n        averageOrderValue: 11500,\r\n        paymentTerms: 'Net 30',\r\n        discountRate: 12.5\r\n      },\r\n      relationshipMetrics: {\r\n        responsiveness: 9.2,\r\n        communication: 8.8,\r\n        innovation: 9.0,\r\n        sustainability: 8.5\r\n      }\r\n    },\r\n    rating: 4.8,\r\n    ratingHistory: [\r\n      { date: new Date('2024-01-01'), rating: 4.6, notes: 'Quarterly review - good performance' },\r\n      { date: new Date('2024-04-01'), rating: 4.7, notes: 'Improved delivery times' },\r\n      { date: new Date('2024-07-01'), rating: 4.8, notes: 'Excellent service quality' }\r\n    ],\r\n    pricelists: [\r\n      {\r\n        id: 'pl_001',\r\n        version: 'v2024.3',\r\n        fileName: 'dell_pricelist_2024_q3.xlsx',\r\n        uploadDate: new Date('2024-07-01'),\r\n        uploadedBy: 'john.doe@company.com',\r\n        itemCount: 1250,\r\n        status: 'active',\r\n        effectiveDate: new Date('2024-07-01'),\r\n        expiryDate: new Date('2024-09-30'),\r\n        changes: ['Price reduction on laptop series', 'New desktop models added'],\r\n        notes: 'Q3 pricing update with competitive adjustments'\r\n      },\r\n      {\r\n        id: 'pl_002',\r\n        version: 'v2024.2',\r\n        fileName: 'dell_pricelist_2024_q2.xlsx',\r\n        uploadDate: new Date('2024-04-01'),\r\n        uploadedBy: 'jane.smith@company.com',\r\n        itemCount: 1180,\r\n        status: 'archived',\r\n        effectiveDate: new Date('2024-04-01'),\r\n        expiryDate: new Date('2024-06-30'),\r\n        changes: ['Updated warranty terms', 'Seasonal promotions'],\r\n        notes: 'Q2 pricing with spring promotions'\r\n      }\r\n    ],\r\n    activePricelistId: 'pl_001',\r\n    createdAt: new Date('2024-01-15'),\r\n    updatedAt: new Date('2024-09-20'),\r\n    createdBy: 'admin@company.com',\r\n    updatedBy: 'sarah.manager@company.com',\r\n    tags: ['technology', 'hardware', 'strategic'],\r\n    notes: 'Key strategic partner for enterprise hardware',\r\n    documents: [\r\n      {\r\n        id: 'doc_001',\r\n        name: 'Master Service Agreement',\r\n        type: 'contract',\r\n        url: '/documents/dell_msa_2024.pdf',\r\n        uploadDate: new Date('2024-01-15')\r\n      }\r\n    ],\r\n    riskLevel: 'low',\r\n    riskFactors: [],\r\n    lastRiskAssessment: new Date('2024-08-15')\r\n  }\r\n]\r\n\r\ninterface EnhancedSupplierDashboardProps {\r\n  onSupplierSelect?: (supplier: EnhancedSupplier) => void\r\n}\r\n\r\nconst EnhancedSupplierDashboard: React.FC<EnhancedSupplierDashboardProps> = ({\r\n  onSupplierSelect\r\n}) => {\r\n  const { suppliers: realSuppliers, loading: suppliersLoading, error: suppliersError, fetchSuppliers } = useSuppliers()\r\n  const { metrics, loading: metricsLoading, error: metricsError } = useDashboardMetrics()\r\n  const [suppliers, setSuppliers] = useState<EnhancedSupplier[]>(sampleSuppliers)\r\n  const [selectedSupplier, setSelectedSupplier] = useState<EnhancedSupplier | null>(null)\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n  const [tierFilter, setTierFilter] = useState<string>(\"\")\r\n  const [statusFilter, setStatusFilter] = useState<string>(\"\")\r\n  const [activeTab, setActiveTab] = useState(\"overview\")\r\n  const [showPerformanceDialog, setShowPerformanceDialog] = useState(false)\r\n  const [showPricelistDialog, setShowPricelistDialog] = useState(false)\r\n\r\n  // Update suppliers when real data is loaded\r\n  useEffect(() => {\r\n    if (realSuppliers && realSuppliers.length > 0) {\r\n      // Convert real suppliers to enhanced format for display\r\n      const enhancedSuppliers = realSuppliers.map(supplier => ({\r\n        ...sampleSuppliers[0], // Use sample as template\r\n        id: supplier.id,\r\n        code: supplier.code,\r\n        name: supplier.name,\r\n        legalName: supplier.businessInfo?.legalName || supplier.name,\r\n        website: supplier.businessInfo?.website || '',\r\n        industry: supplier.category,\r\n        tier: supplier.tier as any,\r\n        status: supplier.status as any,\r\n        primaryContact: {\r\n          ...sampleSuppliers[0].primaryContact,\r\n          name: supplier.contacts[0]?.name || '',\r\n          email: supplier.contacts[0]?.email || '',\r\n          phone: supplier.contacts[0]?.phone || '',\r\n          role: supplier.contacts[0]?.title || '',\r\n        },\r\n        taxNumber: supplier.businessInfo?.taxId || '',\r\n        registrationNumber: supplier.businessInfo?.registrationNumber || '',\r\n        paymentTerms: supplier.financial?.paymentTerms || 'Net 30',\r\n        currency: supplier.financial?.currency || 'ZAR',\r\n        tags: supplier.tags || [],\r\n        notes: supplier.notes || '',\r\n        createdAt: supplier.createdAt,\r\n        updatedAt: supplier.updatedAt,\r\n      }))\r\n      setSuppliers(enhancedSuppliers)\r\n    }\r\n  }, [realSuppliers])\r\n\r\n  // Handle pricelist upload\r\n  const handlePricelistUpload = useCallback(async (supplierId: string, result: DataValidationResult) => {\r\n    const newPricelist: PricelistVersion = {\r\n      id: `pl_${Date.now()}`,\r\n      version: `v${new Date().getFullYear()}.${new Date().getMonth() + 1}`,\r\n      fileName: `pricelist_${supplierId}_${Date.now()}.xlsx`,\r\n      uploadDate: new Date(),\r\n      uploadedBy: 'current.user@company.com',\r\n      itemCount: result.cleanedData.length,\r\n      status: 'active',\r\n      effectiveDate: new Date(),\r\n      expiryDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000), // 90 days\r\n      changes: [`Imported ${result.cleanedData.length} items`],\r\n      notes: 'Uploaded via enhanced XLSX converter'\r\n    }\r\n\r\n    setSuppliers(prev => prev.map(supplier => {\r\n      if (supplier.id === supplierId) {\r\n        // Archive existing active pricelist\r\n        const updatedPricelists = supplier.pricelists.map(pl =>\r\n          pl.status === 'active' ? { ...pl, status: 'archived' as const } : pl\r\n        )\r\n\r\n        return {\r\n          ...supplier,\r\n          pricelists: [...updatedPricelists, newPricelist],\r\n          activePricelistId: newPricelist.id,\r\n          updatedAt: new Date()\r\n        }\r\n      }\r\n      return supplier\r\n    }))\r\n\r\n  }, [])\r\n\r\n  // Filter suppliers\r\n  const filteredSuppliers = useMemo(() => {\r\n    return suppliers.filter(supplier => {\r\n      const matchesSearch = searchQuery === \"\" ||\r\n        supplier.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        supplier.code.toLowerCase().includes(searchQuery.toLowerCase()) ||\r\n        supplier.industry.toLowerCase().includes(searchQuery.toLowerCase())\r\n\r\n      const matchesTier = tierFilter === \"\" || supplier.tier === tierFilter\r\n      const matchesStatus = statusFilter === \"\" || supplier.status === statusFilter\r\n\r\n      return matchesSearch && matchesTier && matchesStatus\r\n    })\r\n  }, [suppliers, searchQuery, tierFilter, statusFilter])\r\n\r\n  // Calculate dashboard metrics from real data or fallback to sample\r\n  const dashboardMetrics = useMemo(() => {\r\n    if (metrics) {\r\n      return {\r\n        totalSuppliers: metrics.totalSuppliers,\r\n        activeSuppliers: metrics.activeSuppliers,\r\n        totalSpend: metrics.totalPurchaseValue,\r\n        avgRating: metrics.avgPerformanceRating,\r\n        avgOnTimeDelivery: metrics.onTimeDeliveryRate,\r\n        riskDistribution: {\r\n          low: suppliers.filter(s => s.riskLevel === 'low').length,\r\n          medium: suppliers.filter(s => s.riskLevel === 'medium').length,\r\n          high: suppliers.filter(s => s.riskLevel === 'high').length,\r\n          critical: suppliers.filter(s => s.riskLevel === 'critical').length\r\n        }\r\n      }\r\n    }\r\n\r\n    // Fallback to calculated metrics from suppliers data\r\n    const activeSuppliers = suppliers.filter(s => s.status === 'active').length\r\n    const totalSpend = suppliers.reduce((sum, s) => sum + s.performanceMetrics.financialMetrics.totalSpend, 0)\r\n    const avgRating = suppliers.length > 0 ? suppliers.reduce((sum, s) => sum + s.rating, 0) / suppliers.length : 0\r\n    const avgOnTimeDelivery = suppliers.length > 0 ? suppliers.reduce((sum, s) => sum + s.performanceMetrics.deliveryPerformance.onTimeDeliveryRate, 0) / suppliers.length : 0\r\n\r\n    return {\r\n      totalSuppliers: suppliers.length,\r\n      activeSuppliers,\r\n      totalSpend,\r\n      avgRating,\r\n      avgOnTimeDelivery,\r\n      riskDistribution: {\r\n        low: suppliers.filter(s => s.riskLevel === 'low').length,\r\n        medium: suppliers.filter(s => s.riskLevel === 'medium').length,\r\n        high: suppliers.filter(s => s.riskLevel === 'high').length,\r\n        critical: suppliers.filter(s => s.riskLevel === 'critical').length\r\n      }\r\n    }\r\n  }, [suppliers, metrics])\r\n\r\n  const getTierColor = (tier: string): string => {\r\n    const colors = {\r\n      strategic: \"bg-purple-100 text-purple-800 border-purple-200\",\r\n      tier_1: \"bg-green-100 text-green-800 border-green-200\",\r\n      tier_2: \"bg-blue-100 text-blue-800 border-blue-200\",\r\n      tier_3: \"bg-gray-100 text-gray-800 border-gray-200\"\r\n    }\r\n    return colors[tier as keyof typeof colors] || colors.tier_3\r\n  }\r\n\r\n  const getStatusColor = (status: string): string => {\r\n    const colors = {\r\n      active: \"bg-green-100 text-green-800 border-green-200\",\r\n      inactive: \"bg-gray-100 text-gray-800 border-gray-200\",\r\n      under_review: \"bg-yellow-100 text-yellow-800 border-yellow-200\",\r\n      suspended: \"bg-red-100 text-red-800 border-red-200\"\r\n    }\r\n    return colors[status as keyof typeof colors] || colors.inactive\r\n  }\r\n\r\n  const getRiskColor = (risk: string): string => {\r\n    const colors = {\r\n      low: \"text-green-600\",\r\n      medium: \"text-yellow-600\",\r\n      high: \"text-orange-600\",\r\n      critical: \"text-red-600\"\r\n    }\r\n    return colors[risk as keyof typeof colors] || colors.low\r\n  }\r\n\r\n  // Show loading state\r\n  if (suppliersLoading || metricsLoading) {\r\n    return (\r\n      <div className=\"space-y-6\">\r\n        <div className=\"flex items-center justify-center p-8\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <div className=\"h-6 w-6 animate-spin rounded-full border-2 border-primary border-t-transparent\" />\r\n            <span>Loading suppliers...</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Show error state\r\n  if (suppliersError || metricsError) {\r\n    return (\r\n      <div className=\"space-y-6\">\r\n        <Alert variant=\"destructive\">\r\n          <AlertTriangle className=\"h-4 w-4\" />\r\n          <AlertDescription>\r\n            {suppliersError || metricsError || 'Failed to load supplier data'}\r\n          </AlertDescription>\r\n        </Alert>\r\n        <Button onClick={() => fetchSuppliers()} variant=\"outline\">\r\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n          Try Again\r\n        </Button>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <AIErrorBoundary>\r\n      <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold tracking-tight\">Enhanced Supplier Management</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Comprehensive supplier relationship and performance management\r\n          </p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <Download className=\"h-4 w-4 mr-2\" />\r\n            Export Report\r\n          </Button>\r\n          <Button size=\"sm\">\r\n            <Plus className=\"h-4 w-4 mr-2\" />\r\n            Add Supplier\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\r\n        <TabsList className=\"grid w-full grid-cols-7\">\r\n          <TabsTrigger value=\"overview\">Overview</TabsTrigger>\r\n          <TabsTrigger value=\"directory\">Directory</TabsTrigger>\r\n          <TabsTrigger value=\"performance\">Performance</TabsTrigger>\r\n          <TabsTrigger value=\"pricelists\">Pricelists</TabsTrigger>\r\n          <TabsTrigger value=\"analytics\">Analytics</TabsTrigger>\r\n          <TabsTrigger value=\"ai-discovery\" className=\"flex items-center gap-2\">\r\n            <Brain className=\"h-4 w-4\" />\r\n            AI Discovery\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"ai-insights\" className=\"flex items-center gap-2\">\r\n            <Sparkles className=\"h-4 w-4\" />\r\n            AI Insights\r\n          </TabsTrigger>\r\n        </TabsList>\r\n\r\n        {/* Overview Tab */}\r\n        <TabsContent value=\"overview\" className=\"space-y-6\">\r\n          {/* Key Metrics */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n            <Card>\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Total Suppliers</p>\r\n                    <p className=\"text-2xl font-bold\">{dashboardMetrics.totalSuppliers}</p>\r\n                  </div>\r\n                  <Building2 className=\"h-8 w-8 text-blue-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Active Suppliers</p>\r\n                    <p className=\"text-2xl font-bold\">{dashboardMetrics.activeSuppliers}</p>\r\n                  </div>\r\n                  <CheckCircle className=\"h-8 w-8 text-green-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Total Spend</p>\r\n                    <p className=\"text-2xl font-bold\">{formatCurrency(dashboardMetrics.totalSpend)}</p>\r\n                  </div>\r\n                  <DollarSign className=\"h-8 w-8 text-green-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Avg Rating</p>\r\n                    <p className=\"text-2xl font-bold\">{dashboardMetrics.avgRating.toFixed(1)}</p>\r\n                  </div>\r\n                  <Star className=\"h-8 w-8 text-yellow-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n\r\n          {/* Performance Metrics */}\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"flex items-center gap-2\">\r\n                  <TrendingUp className=\"h-5 w-5\" />\r\n                  Delivery Performance\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"space-y-4\">\r\n                  <div>\r\n                    <div className=\"flex justify-between text-sm mb-2\">\r\n                      <span>On-Time Delivery Rate</span>\r\n                      <span>{dashboardMetrics.avgOnTimeDelivery.toFixed(1)}%</span>\r\n                    </div>\r\n                    <Progress value={dashboardMetrics.avgOnTimeDelivery} className=\"h-2\" />\r\n                  </div>\r\n\r\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                    <div>\r\n                      <p className=\"text-muted-foreground\">Best Performer</p>\r\n                      <p className=\"font-medium\">Dell Technologies</p>\r\n                      <p className=\"text-xs text-green-600\">95.8% on-time</p>\r\n                    </div>\r\n                    <div>\r\n                      <p className=\"text-muted-foreground\">Avg Delivery Days</p>\r\n                      <p className=\"font-medium\">3.2 days</p>\r\n                      <p className=\"text-xs text-blue-600\">Industry standard: 5 days</p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"flex items-center gap-2\">\r\n                  <Target className=\"h-5 w-5\" />\r\n                  Risk Distribution\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"space-y-3\">\r\n                  {Object.entries(dashboardMetrics.riskDistribution).map(([level, count]) => (\r\n                    <div key={level} className=\"flex items-center justify-between\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <div className={cn(\"w-3 h-3 rounded-full\", {\r\n                          \"bg-green-500\": level === \"low\",\r\n                          \"bg-yellow-500\": level === \"medium\",\r\n                          \"bg-orange-500\": level === \"high\",\r\n                          \"bg-red-500\": level === \"critical\"\r\n                        })} />\r\n                        <span className=\"text-sm capitalize\">{level} Risk</span>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <span className=\"font-medium\">{count}</span>\r\n                        <span className=\"text-xs text-muted-foreground\">\r\n                          ({((count / dashboardMetrics.totalSuppliers) * 100).toFixed(0)}%)\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n\r\n          {/* Top Suppliers */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"flex items-center gap-2\">\r\n                <Award className=\"h-5 w-5\" />\r\n                Top Performing Suppliers\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                {suppliers\r\n                  .sort((a, b) => b.rating - a.rating)\r\n                  .slice(0, 5)\r\n                  .map((supplier, index) => (\r\n                    <div key={supplier.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <div className=\"flex items-center justify-center w-8 h-8 rounded-full bg-primary/10\">\r\n                          <span className=\"text-sm font-medium\">#{index + 1}</span>\r\n                        </div>\r\n                        <div>\r\n                          <p className=\"font-medium\">{supplier.name}</p>\r\n                          <p className=\"text-xs text-muted-foreground\">{supplier.industry}</p>\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <Badge variant=\"outline\" className={getTierColor(supplier.tier)}>\r\n                          {supplier.tier.replace('_', ' ').toUpperCase()}\r\n                        </Badge>\r\n                        <div className=\"text-right\">\r\n                          <div className=\"flex items-center gap-1\">\r\n                            <Star className=\"h-4 w-4 text-yellow-500 fill-current\" />\r\n                            <span className=\"font-medium\">{supplier.rating}</span>\r\n                          </div>\r\n                          <p className=\"text-xs text-muted-foreground\">\r\n                            {supplier.performanceMetrics.deliveryPerformance.onTimeDeliveryRate}% on-time\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Directory Tab */}\r\n        <TabsContent value=\"directory\" className=\"space-y-6\">\r\n          {/* Search and Filters */}\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex flex-col md:flex-row gap-4\">\r\n                <div className=\"flex-1\">\r\n                  <div className=\"relative\">\r\n                    <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n                    <Input\r\n                      placeholder=\"Search suppliers by name, code, or industry...\"\r\n                      value={searchQuery}\r\n                      onChange={(e) => setSearchQuery(e.target.value)}\r\n                      className=\"pl-8\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Select value={tierFilter} onValueChange={setTierFilter}>\r\n                    <SelectTrigger className=\"w-32\">\r\n                      <SelectValue placeholder=\"All Tiers\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"all\">All Tiers</SelectItem>\r\n                      <SelectItem value=\"strategic\">Strategic</SelectItem>\r\n                      <SelectItem value=\"tier_1\">Tier 1</SelectItem>\r\n                      <SelectItem value=\"tier_2\">Tier 2</SelectItem>\r\n                      <SelectItem value=\"tier_3\">Tier 3</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                  <Select value={statusFilter} onValueChange={setStatusFilter}>\r\n                    <SelectTrigger className=\"w-32\">\r\n                      <SelectValue placeholder=\"All Status\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"all\">All Status</SelectItem>\r\n                      <SelectItem value=\"active\">Active</SelectItem>\r\n                      <SelectItem value=\"inactive\">Inactive</SelectItem>\r\n                      <SelectItem value=\"under_review\">Under Review</SelectItem>\r\n                      <SelectItem value=\"suspended\">Suspended</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => fetchSuppliers()}\r\n                    disabled={suppliersLoading}\r\n                  >\r\n                    <RefreshCw className={`h-4 w-4 mr-2 ${suppliersLoading ? 'animate-spin' : ''}`} />\r\n                    {suppliersLoading ? 'Loading...' : 'Refresh'}\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Suppliers Table */}\r\n          <Card>\r\n            <CardContent className=\"p-0\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead>Supplier</TableHead>\r\n                    <TableHead>Tier</TableHead>\r\n                    <TableHead>Status</TableHead>\r\n                    <TableHead>Rating</TableHead>\r\n                    <TableHead>On-Time %</TableHead>\r\n                    <TableHead>Total Spend</TableHead>\r\n                    <TableHead>Risk Level</TableHead>\r\n                    <TableHead>Last Contact</TableHead>\r\n                    <TableHead className=\"text-right\">Actions</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {filteredSuppliers.map((supplier) => (\r\n                    <TableRow key={supplier.id} className=\"cursor-pointer hover:bg-muted/50\">\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-3\">\r\n                          <div className=\"h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center\">\r\n                            <Building2 className=\"h-5 w-5 text-primary\" />\r\n                          </div>\r\n                          <div>\r\n                            <div className=\"font-medium\">{supplier.name}</div>\r\n                            <div className=\"text-sm text-muted-foreground\">{supplier.code}</div>\r\n                          </div>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant=\"outline\" className={getTierColor(supplier.tier)}>\r\n                          {supplier.tier.replace('_', ' ').toUpperCase()}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <Badge variant=\"outline\" className={getStatusColor(supplier.status)}>\r\n                          {supplier.status.replace('_', ' ').toUpperCase()}\r\n                        </Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Star className=\"h-4 w-4 text-yellow-500 fill-current\" />\r\n                          <span className=\"font-medium\">{supplier.rating}</span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <span className=\"font-medium\">\r\n                          {supplier.performanceMetrics.deliveryPerformance.onTimeDeliveryRate}%\r\n                        </span>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {formatCurrency(supplier.performanceMetrics.financialMetrics.totalSpend)}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <span className={cn(\"font-medium\", getRiskColor(supplier.riskLevel))}>\r\n                          {supplier.riskLevel.toUpperCase()}\r\n                        </span>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <span className=\"text-sm\">\r\n                          {supplier.primaryContact.lastContactDate\r\n                            ? formatDate(supplier.primaryContact.lastContactDate)\r\n                            : 'No contact'\r\n                          }\r\n                        </span>\r\n                      </TableCell>\r\n                      <TableCell className=\"text-right\">\r\n                        <DropdownMenu>\r\n                          <DropdownMenuTrigger asChild>\r\n                            <Button variant=\"ghost\" size=\"sm\">\r\n                              <MoreHorizontal className=\"h-4 w-4\" />\r\n                            </Button>\r\n                          </DropdownMenuTrigger>\r\n                          <DropdownMenuContent align=\"end\">\r\n                            <DropdownMenuItem onClick={() => setSelectedSupplier(supplier)}>\r\n                              <Eye className=\"mr-2 h-4 w-4\" />\r\n                              View Details\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Edit className=\"mr-2 h-4 w-4\" />\r\n                              Edit Supplier\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <Upload className=\"mr-2 h-4 w-4\" />\r\n                              Upload Pricelist\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuSeparator />\r\n                            <DropdownMenuItem>\r\n                              <BarChart3 className=\"mr-2 h-4 w-4\" />\r\n                              Performance Report\r\n                            </DropdownMenuItem>\r\n                            <DropdownMenuItem>\r\n                              <ShoppingCart className=\"mr-2 h-4 w-4\" />\r\n                              Create Purchase Order\r\n                            </DropdownMenuItem>\r\n                          </DropdownMenuContent>\r\n                        </DropdownMenu>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Performance Tab */}\r\n        <TabsContent value=\"performance\" className=\"space-y-6\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {suppliers.slice(0, 4).map((supplier) => (\r\n              <Card key={supplier.id}>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center justify-between\">\r\n                    <span>{supplier.name}</span>\r\n                    <Badge variant=\"outline\" className={getTierColor(supplier.tier)}>\r\n                      {supplier.tier.replace('_', ' ').toUpperCase()}\r\n                    </Badge>\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"space-y-4\">\r\n                    <div className=\"grid grid-cols-2 gap-4\">\r\n                      <div className=\"text-center\">\r\n                        <div className=\"text-2xl font-bold text-green-600\">\r\n                          {supplier.performanceMetrics.deliveryPerformance.onTimeDeliveryRate}%\r\n                        </div>\r\n                        <div className=\"text-sm text-muted-foreground\">On-Time Delivery</div>\r\n                      </div>\r\n                      <div className=\"text-center\">\r\n                        <div className=\"text-2xl font-bold text-blue-600\">\r\n                          {supplier.rating}\r\n                        </div>\r\n                        <div className=\"text-sm text-muted-foreground\">Overall Rating</div>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <Separator />\r\n\r\n                    <div className=\"space-y-2\">\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span>Quality Rating</span>\r\n                        <span>{supplier.performanceMetrics.qualityMetrics.qualityRating}/5</span>\r\n                      </div>\r\n                      <Progress\r\n                        value={(supplier.performanceMetrics.qualityMetrics.qualityRating / 5) * 100}\r\n                        className=\"h-2\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span>Responsiveness</span>\r\n                        <span>{supplier.performanceMetrics.relationshipMetrics.responsiveness}/10</span>\r\n                      </div>\r\n                      <Progress\r\n                        value={(supplier.performanceMetrics.relationshipMetrics.responsiveness / 10) * 100}\r\n                        className=\"h-2\"\r\n                      />\r\n                    </div>\r\n\r\n                    <div className=\"flex justify-between items-center text-sm\">\r\n                      <span>Total Spend:</span>\r\n                      <span className=\"font-medium\">\r\n                        {formatCurrency(supplier.performanceMetrics.financialMetrics.totalSpend)}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        </TabsContent>\r\n\r\n        {/* Pricelists Tab */}\r\n        <TabsContent value=\"pricelists\" className=\"space-y-6\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {suppliers.map((supplier) => (\r\n              <Card key={supplier.id}>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center justify-between\">\r\n                    <span>{supplier.name}</span>\r\n                    <NextJsXlsxConverter\r\n                      onDataProcessed={(result) => handlePricelistUpload(supplier.id, result)}\r\n                      supplierFilter={supplier.name}\r\n                    />\r\n                  </CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"space-y-3\">\r\n                    {supplier.pricelists.map((pricelist) => (\r\n                      <div key={pricelist.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                        <div>\r\n                          <div className=\"font-medium\">{pricelist.version}</div>\r\n                          <div className=\"text-sm text-muted-foreground\">\r\n                            {pricelist.itemCount} items • {formatDate(pricelist.uploadDate)}\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Badge\r\n                            variant=\"outline\"\r\n                            className={pricelist.status === 'active' ? 'border-green-300 text-green-700' : 'border-gray-300 text-gray-700'}\r\n                          >\r\n                            {pricelist.status}\r\n                          </Badge>\r\n                          <Button variant=\"ghost\" size=\"sm\">\r\n                            <Download className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                    {supplier.pricelists.length === 0 && (\r\n                      <div className=\"text-center py-4 text-muted-foreground\">\r\n                        No pricelists uploaded yet\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        </TabsContent>\r\n\r\n        {/* Analytics Tab */}\r\n        <TabsContent value=\"analytics\" className=\"space-y-6\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>Spend Analysis</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"space-y-4\">\r\n                  {suppliers.map((supplier) => (\r\n                    <div key={supplier.id} className=\"space-y-2\">\r\n                      <div className=\"flex justify-between text-sm\">\r\n                        <span>{supplier.name}</span>\r\n                        <span>{formatCurrency(supplier.performanceMetrics.financialMetrics.totalSpend)}</span>\r\n                      </div>\r\n                      <Progress\r\n                        value={(supplier.performanceMetrics.financialMetrics.totalSpend / dashboardMetrics.totalSpend) * 100}\r\n                        className=\"h-2\"\r\n                      />\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>Rating Trends</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"space-y-4\">\r\n                  {suppliers.map((supplier) => (\r\n                    <div key={supplier.id} className=\"flex items-center justify-between\">\r\n                      <span className=\"text-sm font-medium\">{supplier.name}</span>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        {supplier.ratingHistory.slice(-3).map((rating, index) => (\r\n                          <div key={index} className=\"text-xs text-muted-foreground\">\r\n                            {rating.rating}\r\n                          </div>\r\n                        ))}\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Star className=\"h-4 w-4 text-yellow-500 fill-current\" />\r\n                          <span className=\"font-medium\">{supplier.rating}</span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        {/* AI Discovery Tab */}\r\n        <TabsContent value=\"ai-discovery\" className=\"space-y-6\">\r\n          <AIErrorBoundary>\r\n            <AISupplierDiscovery\r\n              onSupplierSelect={(supplier) => {\r\n                console.log('AI Supplier selected:', supplier)\r\n                // Convert AI supplier to enhanced supplier format if needed\r\n                onSupplierSelect?.(supplier as any)\r\n              }}\r\n              onSupplierBookmark={(supplierId) => {\r\n                console.log('AI Supplier bookmarked:', supplierId)\r\n              }}\r\n            />\r\n          </AIErrorBoundary>\r\n        </TabsContent>\r\n\r\n        {/* AI Insights Tab */}\r\n        <TabsContent value=\"ai-insights\" className=\"space-y-6\">\r\n          <AIErrorBoundary>\r\n            <AIInsightCards\r\n              filterBy={{\r\n                category: ['Supplier Management', 'Cost Optimization', 'Risk Management']\r\n              }}\r\n              onInsightAction={(insightId, action) => {\r\n                console.log('AI Insight action:', insightId, action)\r\n                // Handle insight actions like creating plans, analyzing suppliers, etc.\r\n              }}\r\n              onInsightStatusChange={(id, status) => {\r\n                console.log('AI Insight status changed:', id, status)\r\n              }}\r\n              onRefresh={() => {\r\n                console.log('AI Insights refreshed')\r\n              }}\r\n            />\r\n          </AIErrorBoundary>\r\n        </TabsContent>\r\n      </Tabs>\r\n\r\n      {/* Supplier Detail Dialog */}\r\n      {selectedSupplier && (\r\n        <Dialog open={!!selectedSupplier} onOpenChange={() => setSelectedSupplier(null)}>\r\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\r\n            <DialogHeader>\r\n              <DialogTitle>{selectedSupplier.name} - Supplier Details</DialogTitle>\r\n              <DialogDescription>\r\n                Comprehensive supplier information and performance metrics\r\n              </DialogDescription>\r\n            </DialogHeader>\r\n\r\n            <div className=\"space-y-6\">\r\n              {/* Basic Information */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                <div>\r\n                  <h4 className=\"font-medium mb-2\">Contact Information</h4>\r\n                  <div className=\"space-y-2 text-sm\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <User className=\"h-4 w-4\" />\r\n                      <span>{selectedSupplier.primaryContact.name} ({selectedSupplier.primaryContact.role})</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Mail className=\"h-4 w-4\" />\r\n                      <span>{selectedSupplier.primaryContact.email}</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Phone className=\"h-4 w-4\" />\r\n                      <span>{selectedSupplier.primaryContact.phone}</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Globe className=\"h-4 w-4\" />\r\n                      <span>{selectedSupplier.website}</span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <div>\r\n                  <h4 className=\"font-medium mb-2\">Business Details</h4>\r\n                  <div className=\"space-y-2 text-sm\">\r\n                    <div>Industry: {selectedSupplier.industry}</div>\r\n                    <div>Payment Terms: {selectedSupplier.paymentTerms}</div>\r\n                    <div>Credit Limit: {formatCurrency(selectedSupplier.creditLimit)}</div>\r\n                    <div>Risk Level:\r\n                      <span className={cn(\"ml-1 font-medium\", getRiskColor(selectedSupplier.riskLevel))}>\r\n                        {selectedSupplier.riskLevel.toUpperCase()}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Performance Metrics Grid */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n                <Card>\r\n                  <CardContent className=\"p-4 text-center\">\r\n                    <div className=\"text-2xl font-bold text-green-600\">\r\n                      {selectedSupplier.performanceMetrics.deliveryPerformance.onTimeDeliveryRate}%\r\n                    </div>\r\n                    <div className=\"text-sm text-muted-foreground\">On-Time Delivery</div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                <Card>\r\n                  <CardContent className=\"p-4 text-center\">\r\n                    <div className=\"text-2xl font-bold text-blue-600\">\r\n                      {selectedSupplier.performanceMetrics.qualityMetrics.qualityRating}/5\r\n                    </div>\r\n                    <div className=\"text-sm text-muted-foreground\">Quality Rating</div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                <Card>\r\n                  <CardContent className=\"p-4 text-center\">\r\n                    <div className=\"text-2xl font-bold text-purple-600\">\r\n                      {formatCurrency(selectedSupplier.performanceMetrics.financialMetrics.totalSpend)}\r\n                    </div>\r\n                    <div className=\"text-sm text-muted-foreground\">Total Spend</div>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                <Card>\r\n                  <CardContent className=\"p-4 text-center\">\r\n                    <div className=\"text-2xl font-bold text-yellow-600\">\r\n                      {selectedSupplier.rating}/5\r\n                    </div>\r\n                    <div className=\"text-sm text-muted-foreground\">Overall Rating</div>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n\r\n              {/* Recent Pricelists */}\r\n              <div>\r\n                <h4 className=\"font-medium mb-3\">Recent Pricelists</h4>\r\n                <div className=\"space-y-2\">\r\n                  {selectedSupplier.pricelists.slice(0, 3).map((pricelist) => (\r\n                    <div key={pricelist.id} className=\"flex items-center justify-between p-2 border rounded\">\r\n                      <div>\r\n                        <div className=\"font-medium\">{pricelist.version}</div>\r\n                        <div className=\"text-xs text-muted-foreground\">\r\n                          {pricelist.itemCount} items • {formatDate(pricelist.uploadDate)}\r\n                        </div>\r\n                      </div>\r\n                      <Badge variant=\"outline\" className={\r\n                        pricelist.status === 'active' ? 'border-green-300 text-green-700' : 'border-gray-300 text-gray-700'\r\n                      }>\r\n                        {pricelist.status}\r\n                      </Badge>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </DialogContent>\r\n        </Dialog>\r\n      )}\r\n      </div>\r\n    </AIErrorBoundary>\r\n  )\r\n}\r\n\r\nexport default EnhancedSupplierDashboard","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\EnhancedSupplierForm.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\n\"use client\"\n\nimport React, { useState, useEffect } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport { useForm, useFieldArray } from \"react-hook-form\"\nimport { zodResolver } from \"@hookform/resolvers/zod\"\nimport * as z from \"zod\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Checkbox } from \"@/components/ui/checkbox\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\"\nimport {\n  Form,\n  FormControl,\n  FormDescription,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { Separator } from \"@/components/ui/separator\"\nimport { Alert, AlertDescription } from \"@/components/ui/alert\"\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\nimport { cn } from \"@/lib/utils\"\nimport WebSupplierDiscovery from \"./WebSupplierDiscovery\"\nimport {\n  Building2,\n  User,\n  MapPin,\n  DollarSign,\n  Star,\n  Plus,\n  Trash2,\n  Save,\n  X,\n  Upload,\n  AlertTriangle,\n  CheckCircle,\n  Globe,\n  Phone,\n  Mail,\n  Calendar,\n  FileText,\n  Settings,\n  Brain,\n  Sparkles,\n  Loader2,\n  ArrowLeft,\n  HelpCircle,\n  Info\n} from \"lucide-react\"\n\n// Enhanced validation schemas with better accessibility\nconst contactSchema = z.object({\n  id: z.string().optional(),\n  type: z.enum([\"primary\", \"billing\", \"technical\", \"sales\", \"support\"]).optional(),\n  name: z.string().optional(),\n  title: z.string().optional(),\n  email: z.string().email(\"Invalid email address\").optional().or(z.literal(\"\")),\n  phone: z.string().optional(),\n  mobile: z.string().optional(),\n  department: z.string().optional(),\n  isPrimary: z.boolean().default(false),\n  isActive: z.boolean().default(true),\n})\n\nconst addressSchema = z.object({\n  id: z.string().optional(),\n  type: z.enum([\"headquarters\", \"billing\", \"shipping\", \"warehouse\", \"manufacturing\"]).optional(),\n  name: z.string().optional(),\n  addressLine1: z.string().optional(),\n  addressLine2: z.string().optional(),\n  city: z.string().optional(),\n  state: z.string().optional(),\n  postalCode: z.string().optional(),\n  country: z.string().optional(),\n  isPrimary: z.boolean().default(false),\n  isActive: z.boolean().default(true),\n})\n\nconst supplierSchema = z.object({\n  id: z.string().optional(),\n  name: z.string().optional(),\n  code: z.string().optional(),\n  status: z.enum([\"active\", \"inactive\", \"pending\", \"suspended\"]).optional(),\n  tier: z.enum([\"strategic\", \"preferred\", \"approved\", \"conditional\"]).optional(),\n  categories: z.array(z.string()).default([]), // Changed from category to categories (array)\n  tags: z.array(z.string()).default([]),\n  brands: z.array(z.string()).default([]),\n\n  // Business Information\n  businessInfo: z.object({\n    legalName: z.string().optional(),\n    tradingName: z.string().optional(),\n    taxId: z.string().optional().or(z.literal(\"\")),\n    registrationNumber: z.string().optional().or(z.literal(\"\")),\n    website: z.string().url(\"Invalid website URL\").optional().or(z.literal(\"\")),\n    foundedYear: z.number().min(1800).max(new Date().getFullYear()).nullish(),\n    employeeCount: z.number().min(1).nullish(),\n    annualRevenue: z.number().min(0).nullish(),\n    currency: z.string().optional(),\n  }).optional(),\n\n  // Capabilities\n  capabilities: z.object({\n    products: z.array(z.string()).default([]),\n    services: z.array(z.string()).default([]),\n    leadTime: z.number().optional(),\n    paymentTerms: z.string().optional(),\n  }).optional(),\n\n  // Financial\n  financial: z.object({\n    creditRating: z.string().optional(),\n    paymentTerms: z.string().optional(),\n    currency: z.string().optional(),\n  }).optional(),\n\n  // Contacts and Addresses\n  contacts: z.array(contactSchema).optional(),\n  addresses: z.array(addressSchema).optional(),\n\n  // Notes\n  notes: z.string().optional(),\n})\n\ntype SupplierFormData = z.infer<typeof supplierSchema>\n\n// AI Supplier Discovery Hook - Now uses real web search\nconst useAISupplierDiscovery = () => {\n  const [isSearching, setIsSearching] = useState(false)\n  const [error, setError] = useState<string | null>(null)\n\n  const searchSupplier = async (supplierName: string, supplierCode?: string): Promise<Partial<SupplierFormData> | null> => {\n    if (!supplierName.trim()) return null\n\n    setIsSearching(true)\n    setError(null)\n\n    try {\n      // Call the web search API to get real supplier information\n      const response = await fetch('/api/ai/suppliers/web-search', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          supplierName,\n          supplierCode,\n        }),\n      })\n\n      if (!response.ok) {\n        throw new Error(`API error: ${response.status}`)\n      }\n\n      const result = await response.json()\n\n      if (!result.success) {\n        throw new Error(result.error || 'Failed to search supplier')\n      }\n\n      // Return the populated data from web search\n      return result.data as Partial<SupplierFormData>\n    } catch (err) {\n      console.error('Web search error:', err)\n      setError(err instanceof Error ? err.message : \"Failed to discover supplier information. Please try again.\")\n      return null\n    } finally {\n      setIsSearching(false)\n    }\n  }\n\n  return { searchSupplier, isSearching, error }\n}\n\n// Web Discovery Integration Component\ninterface WebDiscoveryIntegrationProps {\n  onDataFound: (data: any) => void\n  initialQuery?: string\n  onClose?: () => void\n}\n\nconst WebDiscoveryIntegration: React.FC<WebDiscoveryIntegrationProps> = ({\n  onDataFound,\n  initialQuery = \"\",\n  onClose\n}) => {\n  // Handle web discovery data transformation\n  const handleWebDataFound = (webData: any) => {\n    // Transform web discovery data to form format - comprehensive mapping\n    const transformedData: Partial<SupplierFormData> = {\n      name: webData.companyName || webData.name,\n      code: webData.code,\n      categories: webData.categories || (webData.category ? [webData.category] : []) || [],\n      tags: webData.tags || [],\n      brands: webData.brands || webData.products?.slice(0, 5) || [], // Use products as brands if brands not available\n      businessInfo: {\n        legalName: webData.legalName || webData.companyName,\n        tradingName: webData.tradingName || webData.companyName,\n        website: webData.website || webData.url || '',\n        foundedYear: webData.founded ? parseInt(webData.founded) : undefined,\n        employeeCount: webData.employees ? parseInt(webData.employees.replace(/[^0-9]/g, '')) : undefined,\n        annualRevenue: webData.revenue ? parseFloat(webData.revenue.replace(/[^0-9.]/g, '')) : undefined,\n        currency: webData.currency || 'ZAR',\n        taxId: webData.taxId || '',\n        registrationNumber: webData.registrationNumber || '',\n      },\n      capabilities: {\n        products: webData.products || [],\n        services: webData.services || [],\n        paymentTerms: webData.paymentTerms,\n        leadTime: webData.leadTime,\n      },\n      addresses: webData.addresses?.map((addr: any, index: number) => ({\n        type: addr.type || (index === 0 ? \"headquarters\" : \"shipping\"),\n        name: addr.name || (index === 0 ? \"Head Office\" : `Address ${index + 1}`),\n        addressLine1: addr.street || addr.addressLine1 || '',\n        addressLine2: addr.addressLine2 || '',\n        city: addr.city || '',\n        state: addr.state || '',\n        country: addr.country || 'South Africa',\n        postalCode: addr.postalCode || '',\n        isPrimary: index === 0,\n        isActive: true,\n      })) || [],\n    }\n\n    // Add contact from web data if available\n    if (webData.contactEmail || webData.contactPhone) {\n      transformedData.contacts = [{\n        type: \"primary\",\n        name: webData.contactPerson || webData.contactName || \"\",\n        email: webData.contactEmail || \"\",\n        phone: webData.contactPhone || \"\",\n        mobile: webData.contactMobile || \"\",\n        isPrimary: true,\n        isActive: true,\n      }]\n    }\n\n    // Add financial info if available\n    if (webData.currency || webData.paymentTerms) {\n      transformedData.financial = {\n        currency: webData.currency || 'ZAR',\n        paymentTerms: webData.paymentTerms,\n      }\n    }\n\n    onDataFound(transformedData)\n    if (onClose) onClose()\n  }\n\n  return (\n    <WebSupplierDiscovery\n      onDataFound={handleWebDataFound}\n      initialQuery={initialQuery}\n    />\n  )\n}\n\n// Help tooltips for accessibility\nconst FieldTooltip: React.FC<{ content: string; children: React.ReactNode }> = ({\n  content,\n  children\n}) => (\n  <Tooltip>\n    <TooltipTrigger asChild>\n      <div className=\"flex items-center gap-1\">\n        {children}\n        <HelpCircle className=\"h-3 w-3 text-muted-foreground\" />\n      </div>\n    </TooltipTrigger>\n    <TooltipContent>\n      <p className=\"max-w-xs\">{content}</p>\n    </TooltipContent>\n  </Tooltip>\n)\n\n// Main Form Component\ninterface EnhancedSupplierFormProps {\n  supplier?: any // Type this properly based on your supplier type\n  onSubmit?: (data: SupplierFormData) => Promise<void>\n  onCancel?: () => void\n  isLoading?: boolean\n}\n\nconst EnhancedSupplierForm: React.FC<EnhancedSupplierFormProps> = ({\n  supplier,\n  onSubmit,\n  onCancel,\n  isLoading = false\n}) => {\n  const router = useRouter()\n  const [activeTab, setActiveTab] = useState(\"basic\")\n  const [tagInput, setTagInput] = useState(\"\")\n  const [categoryInput, setCategoryInput] = useState(\"\")\n  const [brandInput, setBrandInput] = useState(\"\")\n  const [productInput, setProductInput] = useState(\"\")\n  const [serviceInput, setServiceInput] = useState(\"\")\n  const [isSubmitting, setIsSubmitting] = useState(false)\n  const [submitError, setSubmitError] = useState<string | null>(null)\n  const [submitSuccess, setSubmitSuccess] = useState(false)\n  const [showWebDiscovery, setShowWebDiscovery] = useState(false)\n\n  const form = useForm<SupplierFormData>({\n    resolver: zodResolver(supplierSchema),\n    defaultValues: supplier ? {\n      ...supplier,\n      categories: supplier.categories || (supplier.category ? [supplier.category] : []),\n      businessInfo: {\n        ...supplier.businessInfo,\n        website: supplier.businessInfo?.website || \"\",\n        tradingName: supplier.businessInfo?.tradingName || \"\",\n        foundedYear: supplier.businessInfo?.foundedYear ?? undefined,\n        employeeCount: supplier.businessInfo?.employeeCount ?? undefined,\n        annualRevenue: supplier.businessInfo?.annualRevenue ?? undefined,\n      },\n      contacts: supplier.contacts.map((contact: any) => ({\n        ...contact,\n        mobile: contact.mobile || \"\",\n        department: contact.department || \"\",\n      })),\n      addresses: supplier.addresses.map((address: any) => ({\n        ...address,\n        name: address.name || \"\",\n        addressLine2: address.addressLine2 || \"\",\n      })),\n      notes: supplier.notes || \"\",\n    } : {\n      name: \"\",\n      code: \"\",\n      status: \"pending\",\n      tier: \"approved\",\n      categories: [],\n      tags: [],\n      brands: [],\n      businessInfo: {\n        legalName: \"\",\n        tradingName: \"\",\n        taxId: \"\",\n        registrationNumber: \"\",\n        website: \"\",\n        foundedYear: undefined,\n        employeeCount: undefined,\n        annualRevenue: undefined,\n        currency: \"ZAR\",\n      },\n      capabilities: {\n        products: [],\n        services: [],\n        leadTime: 30,\n        paymentTerms: \"Net 30\",\n      },\n      financial: {\n        creditRating: \"\",\n        paymentTerms: \"Net 30\",\n        currency: \"ZAR\",\n      },\n      contacts: [],\n      addresses: [],\n      notes: \"\",\n    }\n  })\n\n  const { fields: contactFields, append: appendContact, remove: removeContact } = useFieldArray({\n    control: form.control,\n    name: \"contacts\"\n  })\n\n  const { fields: addressFields, append: appendAddress, remove: removeAddress } = useFieldArray({\n    control: form.control,\n    name: \"addresses\"\n  })\n\n  const watchedTags = form.watch(\"tags\")\n  const watchedCategories = form.watch(\"categories\")\n  const watchedBrands = form.watch(\"brands\")\n  const watchedProducts = form.watch(\"capabilities.products\")\n  const watchedServices = form.watch(\"capabilities.services\")\n\n  // Handle AI data population\n  const handleAIDataFound = (data: Partial<SupplierFormData>) => {\n    Object.entries(data).forEach(([key, value]) => {\n      if (value !== undefined && value !== null) {\n        if (key === 'businessInfo' && typeof value === 'object') {\n          // Handle nested businessInfo object\n          form.setValue('businessInfo', value as any, { shouldValidate: true })\n        } else if (key === 'contacts' && Array.isArray(value)) {\n          form.setValue('contacts', value as any, { shouldValidate: true })\n        } else if (key === 'addresses' && Array.isArray(value)) {\n          form.setValue('addresses', value as any, { shouldValidate: true })\n        } else if (key === 'capabilities' && typeof value === 'object') {\n          form.setValue('capabilities', value as any, { shouldValidate: true })\n        } else if (key === 'financial' && typeof value === 'object') {\n          form.setValue('financial', value as any, { shouldValidate: true })\n        } else {\n          form.setValue(key as keyof SupplierFormData, value as any, { shouldValidate: true })\n        }\n      }\n    })\n    setShowWebDiscovery(false)\n    // Trigger validation to show any errors\n    setTimeout(() => {\n      form.trigger()\n    }, 100)\n  }\n\n  // Generate supplier code based on name\n  useEffect(() => {\n    const name = form.watch(\"name\")\n    if (name && !supplier) {\n      const code = name\n        .toUpperCase()\n        .replace(/[^A-Z0-9]/g, \"\")\n        .substring(0, 6)\n      form.setValue(\"code\", code)\n    }\n  }, [form.watch(\"name\")])\n\n  const handleSubmit = async (data: SupplierFormData) => {\n    console.log('🟢 Form submit handler called with data:', data)\n    try {\n      setSubmitError(null)\n      setSubmitSuccess(false)\n      setIsSubmitting(true)\n\n      if (onSubmit) {\n        await onSubmit(data)\n        // Set success and redirect after onSubmit succeeds\n        setSubmitSuccess(true)\n        setTimeout(() => {\n          router.push(`/suppliers?refresh=${Date.now()}`)\n          router.refresh()\n        }, 1500)\n      } else {\n        // Default submission logic - actually call the API\n        const response = await fetch('/api/suppliers', {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify(data),\n        })\n\n        if (!response.ok) {\n          const errorData = await response.json().catch(() => ({}))\n          throw new Error(errorData.error || `HTTP error! status: ${response.status}`)\n        }\n\n        const result = await response.json()\n        \n        if (!result.success) {\n          throw new Error(result.error || 'Failed to create supplier')\n        }\n\n        setSubmitSuccess(true)\n\n        // Invalidate cache and refresh supplier lists\n        // Trigger a refresh by reloading the page or using router refresh\n        // Navigate back after success with cache invalidation\n        setTimeout(() => {\n          // Add timestamp to force cache invalidation\n          router.push(`/suppliers?refresh=${Date.now()}`)\n          router.refresh() // Force refresh of server components\n        }, 1500)\n      }\n    } catch (error) {\n      setSubmitError(error instanceof Error ? error.message : 'Failed to save supplier')\n      console.error(\"Form submission error:\", error)\n    } finally {\n      setIsSubmitting(false)\n    }\n  }\n\n  // Tag management\n  const addTag = () => {\n    if (tagInput.trim() && !watchedTags.includes(tagInput.trim())) {\n      form.setValue(\"tags\", [...watchedTags, tagInput.trim()])\n      setTagInput(\"\")\n    }\n  }\n\n  const removeTag = (tagToRemove: string) => {\n    form.setValue(\"tags\", watchedTags.filter(tag => tag !== tagToRemove))\n  }\n\n  // Category management (same as tags)\n  const addCategory = () => {\n    if (categoryInput.trim() && !watchedCategories.includes(categoryInput.trim())) {\n      form.setValue(\"categories\", [...watchedCategories, categoryInput.trim()])\n      setCategoryInput(\"\")\n    }\n  }\n\n  const removeCategory = (categoryToRemove: string) => {\n    form.setValue(\"categories\", watchedCategories.filter(cat => cat !== categoryToRemove))\n  }\n\n  // Brand management\n  const addBrand = () => {\n    if (brandInput.trim() && !watchedBrands.includes(brandInput.trim())) {\n      form.setValue(\"brands\", [...watchedBrands, brandInput.trim()])\n      setBrandInput(\"\")\n    }\n  }\n\n  const removeBrand = (brandToRemove: string) => {\n    form.setValue(\"brands\", watchedBrands.filter(brand => brand !== brandToRemove))\n  }\n\n  // Product management\n  const addProduct = () => {\n    if (productInput.trim() && !watchedProducts.includes(productInput.trim())) {\n      form.setValue(\"capabilities.products\", [...watchedProducts, productInput.trim()])\n      setProductInput(\"\")\n    }\n  }\n\n  const removeProduct = (productToRemove: string) => {\n    form.setValue(\"capabilities.products\", watchedProducts.filter(p => p !== productToRemove))\n  }\n\n  // Service management\n  const addService = () => {\n    if (serviceInput.trim() && !watchedServices.includes(serviceInput.trim())) {\n      form.setValue(\"capabilities.services\", [...watchedServices, serviceInput.trim()])\n      setServiceInput(\"\")\n    }\n  }\n\n  const removeService = (serviceToRemove: string) => {\n    form.setValue(\"capabilities.services\", watchedServices.filter(s => s !== serviceToRemove))\n  }\n\n  // Contact management\n  const addContact = () => {\n    appendContact({\n      type: \"technical\",\n      name: \"\",\n      title: \"\",\n      email: \"\",\n      phone: \"\",\n      mobile: \"\",\n      department: \"\",\n      isPrimary: false,\n      isActive: true,\n    })\n  }\n\n  // Address management\n  const addAddress = () => {\n    appendAddress({\n      type: \"billing\",\n      name: \"\",\n      addressLine1: \"\",\n      addressLine2: \"\",\n      city: \"\",\n      state: \"\",\n      postalCode: \"\",\n      country: \"South Africa\",\n      isPrimary: false,\n      isActive: true,\n    })\n  }\n\n  return (\n    <TooltipProvider>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-start justify-between\">\n          <div className=\"flex flex-col gap-2\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => onCancel ? onCancel() : router.push('/suppliers')}\n              className=\"flex items-center gap-1.5 h-7 px-2 text-xs text-muted-foreground hover:text-foreground w-fit\"\n            >\n              <ArrowLeft className=\"h-3 w-3\" />\n              Back to Suppliers\n            </Button>\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">\n                {supplier ? \"Edit Supplier\" : \"Add New Supplier\"}\n              </h1>\n              <p className=\"text-muted-foreground\">\n                {supplier ? \"Update supplier information and settings\" : \"Create a new supplier profile\"}\n              </p>\n            </div>\n          </div>\n\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowWebDiscovery(true)}\n              className=\"bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 border-blue-200\"\n            >\n              <Globe className=\"h-4 w-4 mr-2\" />\n              Web Discovery\n            </Button>\n\n            <Button\n              variant=\"outline\"\n              onClick={() => onCancel ? onCancel() : router.push('/suppliers')}\n            >\n              <X className=\"h-4 w-4 mr-2\" />\n              Cancel\n            </Button>\n\n            <Button\n              type=\"submit\"\n              onClick={(e) => {\n                e.preventDefault()\n                console.log('🟡 Button clicked, triggering form submit')\n                const formElement = e.currentTarget.closest('form')\n                if (formElement) {\n                  formElement.requestSubmit()\n                } else {\n                  // Fallback: manually trigger validation and submit\n                  form.handleSubmit(handleSubmit, (errors) => {\n                    console.error('🔴 Form validation errors:', errors)\n                    setSubmitError('Please check the form for validation errors')\n                  })()\n                }\n              }}\n              disabled={isLoading || isSubmitting}\n              className=\"min-w-[120px]\"\n            >\n              {(isLoading || isSubmitting) ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  {supplier ? \"Updating...\" : \"Creating...\"}\n                </>\n              ) : (\n                <>\n                  <Save className=\"h-4 w-4 mr-2\" />\n                  {supplier ? \"Update\" : \"Create\"} Supplier\n                </>\n              )}\n            </Button>\n          </div>\n        </div>\n\n        {/* Web Discovery Panel */}\n        {showWebDiscovery && (\n          <Dialog open={showWebDiscovery} onOpenChange={setShowWebDiscovery}>\n            <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle className=\"flex items-center gap-2\">\n                  <Globe className=\"h-5 w-5\" />\n                  Web Supplier Discovery\n                </DialogTitle>\n                <DialogDescription>\n                  Discover supplier information from the web to auto-populate form fields\n                </DialogDescription>\n              </DialogHeader>\n              \n              <WebDiscoveryIntegration\n                onDataFound={handleAIDataFound}\n                initialQuery={form.watch(\"name\")}\n                onClose={() => setShowWebDiscovery(false)}\n              />\n\n              <DialogFooter>\n                <Button variant=\"outline\" onClick={() => setShowWebDiscovery(false)}>\n                  Close\n                </Button>\n              </DialogFooter>\n            </DialogContent>\n          </Dialog>\n        )}\n\n        {/* Success/Error Messages */}\n        {submitSuccess && (\n          <Alert className=\"border-green-200 bg-green-50\">\n            <CheckCircle className=\"h-4 w-4 text-green-600\" />\n            <AlertDescription className=\"text-green-800\">\n              Supplier {supplier ? 'updated' : 'created'} successfully! Redirecting...\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {submitError && (\n          <Alert variant=\"destructive\">\n            <AlertTriangle className=\"h-4 w-4\" />\n            <AlertDescription>{submitError}</AlertDescription>\n          </Alert>\n        )}\n\n        {/* Form */}\n        <Form {...form}>\n          <form onSubmit={(e) => {\n            e.preventDefault()\n            form.handleSubmit(handleSubmit, (errors) => {\n              console.error('🔴 Form validation errors:', errors)\n              setSubmitError('Please check the form for validation errors')\n            })(e)\n          }} className=\"space-y-6\">\n            <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-3\">\n              <div className=\"p-1.5 bg-muted rounded-lg\">\n                <TabsList className=\"grid w-full grid-cols-5 h-auto p-0.5 bg-transparent\">\n                  <TabsTrigger value=\"basic\" className=\"h-9\">Basic Info</TabsTrigger>\n                  <TabsTrigger value=\"business\" className=\"h-9\">Business</TabsTrigger>\n                  <TabsTrigger value=\"contacts\" className=\"h-9\">Contacts</TabsTrigger>\n                  <TabsTrigger value=\"addresses\" className=\"h-9\">Addresses</TabsTrigger>\n                  <TabsTrigger value=\"capabilities\" className=\"h-9\">Capabilities</TabsTrigger>\n                </TabsList>\n              </div>\n\n              {/* Basic Information */}\n              <TabsContent value=\"basic\" className=\"space-y-6 mt-3\">\n                <Card className=\"gap-2\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Building2 className=\"h-5 w-5\" />\n                      Basic Information\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3 pt-2\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                      <FormField\n                        control={form.control}\n                        name=\"name\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"The primary name used to identify this supplier\">\n                                Supplier Name\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                placeholder=\"Enter supplier name\"\n                                {...field}\n                                aria-describedby=\"supplier-name-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"supplier-name-help\">\n                              This will be the main identifier for the supplier\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"code\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Unique code automatically generated from supplier name\">\n                                Supplier Code\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                placeholder=\"e.g., TECH001\"\n                                {...field}\n                                aria-describedby=\"supplier-code-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"supplier-code-help\">\n                              Unique identifier (auto-generated from name)\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"status\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Current operational status of the supplier\">\n                                Status\n                              </FieldTooltip>\n                            </FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                              <FormControl>\n                                <SelectTrigger aria-describedby=\"status-help\">\n                                  <SelectValue placeholder=\"Select status\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"active\">Active</SelectItem>\n                                <SelectItem value=\"inactive\">Inactive</SelectItem>\n                                <SelectItem value=\"pending\">Pending</SelectItem>\n                                <SelectItem value=\"suspended\">Suspended</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormDescription id=\"status-help\">\n                              Current operational status\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"tier\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Business relationship tier indicating partnership level\">\n                                Tier\n                              </FieldTooltip>\n                            </FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                              <FormControl>\n                                <SelectTrigger aria-describedby=\"tier-help\">\n                                  <SelectValue placeholder=\"Select tier\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"strategic\">Strategic</SelectItem>\n                                <SelectItem value=\"preferred\">Preferred</SelectItem>\n                                <SelectItem value=\"approved\">Approved</SelectItem>\n                                <SelectItem value=\"conditional\">Conditional</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormDescription id=\"tier-help\">\n                              Business relationship level\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      {/* Categories - Same as Tags */}\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                        <FieldTooltip content=\"Product categories this supplier specializes in. Categories are automatically extracted from supplier data, but you can add or remove them manually.\">\n                          Categories\n                              </FieldTooltip>\n                            </FormLabel>\n                      <div className=\"space-y-2\">\n                        <div className=\"flex gap-2\">\n                              <Input\n                            placeholder=\"Add a category\"\n                            value={categoryInput}\n                            onChange={(e) => setCategoryInput(e.target.value)}\n                            onKeyPress={(e) => e.key === \"Enter\" && (e.preventDefault(), addCategory())}\n                            aria-label=\"Add new category\"\n                          />\n                          <Button\n                            type=\"button\"\n                            onClick={addCategory}\n                            variant=\"outline\"\n                            aria-label=\"Add category\"\n                          >\n                            <Plus className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                        <div className=\"flex flex-wrap gap-2\">\n                          {watchedCategories.map((category, index) => (\n                            <Badge key={index} variant=\"secondary\" className=\"flex items-center gap-1\">\n                              {category}\n                              <Button\n                                type=\"button\"\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-auto p-0.5 hover:bg-transparent\"\n                                onClick={() => removeCategory(category)}\n                                aria-label={`Remove category ${category}`}\n                              >\n                                <X className=\"h-3 w-3\" />\n                              </Button>\n                            </Badge>\n                          ))}\n                        </div>\n                        {watchedCategories.length === 0 && (\n                          <p className=\"text-sm text-muted-foreground\">\n                            No categories added yet. Categories will be automatically extracted from supplier data, or you can add them manually.\n                          </p>\n                        )}\n                      </div>\n                          </FormItem>\n                    </div>\n\n                    {/* Tags */}\n                    <FormItem className=\"gap-4\">\n                      <FormLabel>\n                        <FieldTooltip content=\"Keywords to help categorize and search for this supplier\">\n                          Tags\n                        </FieldTooltip>\n                      </FormLabel>\n                      <div className=\"space-y-2\">\n                        <div className=\"flex gap-2\">\n                          <Input\n                            placeholder=\"Add a tag\"\n                            value={tagInput}\n                            onChange={(e) => setTagInput(e.target.value)}\n                            onKeyPress={(e) => e.key === \"Enter\" && (e.preventDefault(), addTag())}\n                            aria-label=\"Add new tag\"\n                          />\n                          <Button\n                            type=\"button\"\n                            onClick={addTag}\n                            variant=\"outline\"\n                            aria-label=\"Add tag\"\n                          >\n                            <Plus className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                        <div className=\"flex flex-wrap gap-2\">\n                          {watchedTags.map((tag, index) => (\n                            <Badge key={index} variant=\"secondary\" className=\"flex items-center gap-1\">\n                              {tag}\n                              <Button\n                                type=\"button\"\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-auto p-0.5 hover:bg-transparent\"\n                                onClick={() => removeTag(tag)}\n                                aria-label={`Remove tag ${tag}`}\n                              >\n                                <X className=\"h-3 w-3\" />\n                              </Button>\n                            </Badge>\n                          ))}\n                        </div>\n                      </div>\n                    </FormItem>\n\n                    {/* Brands */}\n                    <FormItem className=\"gap-4\">\n                      <FormLabel>\n                        <FieldTooltip content=\"Brands or product lines associated with this supplier\">\n                          Supplier Brands\n                        </FieldTooltip>\n                      </FormLabel>\n                      <div className=\"space-y-2\">\n                        <div className=\"flex gap-2\">\n                          <Input\n                            placeholder=\"Add a brand\"\n                            value={brandInput}\n                            onChange={(e) => setBrandInput(e.target.value)}\n                            onKeyPress={(e) => e.key === \"Enter\" && (e.preventDefault(), addBrand())}\n                            aria-label=\"Add new brand\"\n                          />\n                          <Button\n                            type=\"button\"\n                            onClick={addBrand}\n                            variant=\"outline\"\n                            aria-label=\"Add brand\"\n                          >\n                            <Plus className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                        <div className=\"flex flex-wrap gap-2\">\n                          {watchedBrands.map((brand, index) => (\n                            <Badge key={index} variant=\"secondary\" className=\"flex items-center gap-1\">\n                              {brand}\n                              <Button\n                                type=\"button\"\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-auto p-0.5 hover:bg-transparent\"\n                                onClick={() => removeBrand(brand)}\n                                aria-label={`Remove brand ${brand}`}\n                              >\n                                <X className=\"h-3 w-3\" />\n                              </Button>\n                            </Badge>\n                          ))}\n                        </div>\n                      </div>\n                    </FormItem>\n\n                    {/* Notes */}\n                    <FormField\n                      control={form.control}\n                      name=\"notes\"\n                      render={({ field }) => (\n                        <FormItem className=\"gap-4\">\n                          <FormLabel>\n                            <FieldTooltip content=\"Additional notes or comments about this supplier\">\n                              Notes\n                            </FieldTooltip>\n                          </FormLabel>\n                          <FormControl>\n                            <textarea\n                              className=\"flex min-h-[80px] w-full rounded-sm border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\n                              placeholder=\"Additional notes about this supplier...\"\n                              value={field.value || \"\"}\n                              onChange={field.onChange}\n                              aria-describedby=\"notes-help\"\n                            />\n                          </FormControl>\n                          <FormDescription id=\"notes-help\">\n                            Optional: Additional information or comments\n                          </FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              {/* Business Information Tab */}\n              <TabsContent value=\"business\" className=\"space-y-6 mt-3\">\n                <Card className=\"gap-2\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <FileText className=\"h-5 w-5\" />\n                      Business Information\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3 pt-2\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                      <FormField\n                        control={form.control}\n                        name=\"businessInfo.legalName\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Official registered business name\">\n                                Legal Name\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                placeholder=\"Enter legal company name\"\n                                {...field}\n                                aria-describedby=\"legal-name-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"legal-name-help\">\n                              Official registered business name\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"businessInfo.tradingName\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Name used for day-to-day business operations\">\n                                Trading Name\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                placeholder=\"Enter trading name\"\n                                value={field.value || \"\"}\n                                onChange={field.onChange}\n                                aria-describedby=\"trading-name-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"trading-name-help\">\n                              Optional: Business operating name\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"businessInfo.taxId\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Tax identification number\">\n                                Tax ID\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                placeholder=\"Enter tax identification number\"\n                                {...field}\n                                aria-describedby=\"tax-id-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"tax-id-help\">\n                              Tax identification number\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"businessInfo.registrationNumber\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Official business registration number\">\n                                Registration Number\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                placeholder=\"Enter business registration number\"\n                                {...field}\n                                aria-describedby=\"reg-number-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"reg-number-help\">\n                              Business registration number\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"businessInfo.website\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Company website URL\">\n                                Website\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                placeholder=\"https://example.com\"\n                                {...field}\n                                aria-describedby=\"website-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"website-help\">\n                              Optional: Company website\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"businessInfo.foundedYear\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Year the company was established\">\n                                Founded Year\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                type=\"number\"\n                                placeholder=\"e.g., 2010\"\n                                value={field.value != null ? field.value.toString() : \"\"}\n                                onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : undefined)}\n                                aria-describedby=\"founded-year-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"founded-year-help\">\n                              Optional: Year established\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"businessInfo.employeeCount\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Number of employees\">\n                                Employee Count\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                type=\"number\"\n                                placeholder=\"Number of employees\"\n                                value={field.value != null ? field.value.toString() : \"\"}\n                                onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : undefined)}\n                                aria-describedby=\"employee-count-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"employee-count-help\">\n                              Optional: Total number of employees\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"businessInfo.currency\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Primary currency for transactions\">\n                                Currency\n                              </FieldTooltip>\n                            </FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                              <FormControl>\n                                <SelectTrigger aria-describedby=\"currency-help\">\n                                  <SelectValue placeholder=\"Select currency\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"ZAR\">ZAR - South African Rand</SelectItem>\n                                <SelectItem value=\"USD\">USD - US Dollar</SelectItem>\n                                <SelectItem value=\"EUR\">EUR - Euro</SelectItem>\n                                <SelectItem value=\"GBP\">GBP - British Pound</SelectItem>\n                                <SelectItem value=\"CAD\">CAD - Canadian Dollar</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormDescription id=\"currency-help\">\n                              Primary transaction currency\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              {/* Contacts Tab */}\n              <TabsContent value=\"contacts\" className=\"space-y-6 mt-3\">\n                <Card className=\"gap-2\">\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <User className=\"h-5 w-5\" />\n                        Contact Information\n                      </CardTitle>\n                      <Button\n                        type=\"button\"\n                        onClick={addContact}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        aria-label=\"Add new contact\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Add Contact\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"space-y-6\">\n                    {contactFields.length === 0 && (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <p>No contacts added. Click \"Add Contact\" to add one, or submit without contacts.</p>\n                      </div>\n                    )}\n                    {contactFields.map((contact, index) => (\n                      <div key={contact.id} className=\"p-4 border rounded-lg space-y-4\">\n                        <div className=\"flex items-center justify-between\">\n                          <h4 className=\"font-medium\">Contact {index + 1}</h4>\n                          <Button\n                            type=\"button\"\n                            onClick={() => removeContact(index)}\n                            variant=\"outline\"\n                            size=\"sm\"\n                            aria-label={`Remove contact ${index + 1}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.type`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Contact Type</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                                  <FormControl>\n                                    <SelectTrigger>\n                                      <SelectValue placeholder=\"Select type\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"primary\">Primary</SelectItem>\n                                    <SelectItem value=\"billing\">Billing</SelectItem>\n                                    <SelectItem value=\"technical\">Technical</SelectItem>\n                                    <SelectItem value=\"sales\">Sales</SelectItem>\n                                    <SelectItem value=\"support\">Support</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.name`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Full Name</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter full name\"\n                                    {...field}\n                                    aria-label={`Contact ${index + 1} full name`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.title`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Job Title</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter job title\"\n                                    {...field}\n                                    aria-label={`Contact ${index + 1} job title`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.department`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Department</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter department\"\n                                    value={field.value || \"\"}\n                                    onChange={field.onChange}\n                                    aria-label={`Contact ${index + 1} department`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.email`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Email</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    type=\"email\"\n                                    placeholder=\"Enter email address\"\n                                    {...field}\n                                    aria-label={`Contact ${index + 1} email`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.phone`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Phone</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter phone number\"\n                                    {...field}\n                                    aria-label={`Contact ${index + 1} phone`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.mobile`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Mobile</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter mobile number\"\n                                    value={field.value || \"\"}\n                                    onChange={field.onChange}\n                                    aria-label={`Contact ${index + 1} mobile`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n\n                        <div className=\"flex items-center gap-4\">\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.isPrimary`}\n                            render={({ field }) => (\n                              <FormItem className=\"flex flex-row items-start space-x-3 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value}\n                                    onCheckedChange={field.onChange}\n                                    aria-label={`Mark contact ${index + 1} as primary`}\n                                  />\n                                </FormControl>\n                                <div className=\"space-y-1 leading-none\">\n                                  <FormLabel>Primary Contact</FormLabel>\n                                </div>\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`contacts.${index}.isActive`}\n                            render={({ field }) => (\n                              <FormItem className=\"flex flex-row items-start space-x-3 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value}\n                                    onCheckedChange={field.onChange}\n                                    aria-label={`Mark contact ${index + 1} as active`}\n                                  />\n                                </FormControl>\n                                <div className=\"space-y-1 leading-none\">\n                                  <FormLabel>Active</FormLabel>\n                                </div>\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      </div>\n                    ))}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              {/* Addresses Tab */}\n              <TabsContent value=\"addresses\" className=\"space-y-6 mt-3\">\n                <Card className=\"gap-2\">\n                  <CardHeader className=\"pb-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <MapPin className=\"h-5 w-5\" />\n                        Address Information\n                      </CardTitle>\n                      <Button\n                        type=\"button\"\n                        onClick={addAddress}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        aria-label=\"Add new address\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Add Address\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"space-y-6\">\n                    {addressFields.length === 0 && (\n                      <div className=\"text-center py-8 text-muted-foreground\">\n                        <p>No addresses added. Click \"Add Address\" to add one, or submit without addresses.</p>\n                      </div>\n                    )}\n                    {addressFields.map((address, index) => (\n                      <div key={address.id} className=\"p-4 border rounded-lg space-y-4\">\n                        <div className=\"flex items-center justify-between\">\n                          <h4 className=\"font-medium\">Address {index + 1}</h4>\n                          <Button\n                            type=\"button\"\n                            onClick={() => removeAddress(index)}\n                            variant=\"outline\"\n                            size=\"sm\"\n                            aria-label={`Remove address ${index + 1}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.type`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Address Type</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                                  <FormControl>\n                                    <SelectTrigger>\n                                      <SelectValue placeholder=\"Select type\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"headquarters\">Headquarters</SelectItem>\n                                    <SelectItem value=\"billing\">Billing</SelectItem>\n                                    <SelectItem value=\"shipping\">Shipping</SelectItem>\n                                    <SelectItem value=\"warehouse\">Warehouse</SelectItem>\n                                    <SelectItem value=\"manufacturing\">Manufacturing</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.name`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Location Name</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"e.g., Main Office\"\n                                    value={field.value || \"\"}\n                                    onChange={field.onChange}\n                                    aria-label={`Address ${index + 1} location name`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.addressLine1`}\n                            render={({ field }) => (\n                              <FormItem className=\"md:col-span-2\">\n                                <FormLabel>Address Line 1</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter street address\"\n                                    {...field}\n                                    aria-label={`Address ${index + 1} line 1`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.addressLine2`}\n                            render={({ field }) => (\n                              <FormItem className=\"md:col-span-2\">\n                                <FormLabel>Address Line 2</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Apartment, suite, etc.\"\n                                    value={field.value || \"\"}\n                                    onChange={field.onChange}\n                                    aria-label={`Address ${index + 1} line 2`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.city`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>City</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter city\"\n                                    {...field}\n                                    aria-label={`Address ${index + 1} city`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.state`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>State/Province</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter state or province\"\n                                    {...field}\n                                    aria-label={`Address ${index + 1} state`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.postalCode`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Postal Code</FormLabel>\n                                <FormControl>\n                                  <Input\n                                    placeholder=\"Enter postal code\"\n                                    {...field}\n                                    aria-label={`Address ${index + 1} postal code`}\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.country`}\n                            render={({ field }) => (\n                              <FormItem className=\"gap-4\">\n                                <FormLabel>Country</FormLabel>\n                                <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                                  <FormControl>\n                                    <SelectTrigger>\n                                      <SelectValue placeholder=\"Select country\" />\n                                    </SelectTrigger>\n                                  </FormControl>\n                                  <SelectContent>\n                                    <SelectItem value=\"South Africa\">South Africa</SelectItem>\n                                    <SelectItem value=\"United States\">United States</SelectItem>\n                                    <SelectItem value=\"Canada\">Canada</SelectItem>\n                                    <SelectItem value=\"United Kingdom\">United Kingdom</SelectItem>\n                                    <SelectItem value=\"Germany\">Germany</SelectItem>\n                                    <SelectItem value=\"France\">France</SelectItem>\n                                    <SelectItem value=\"Japan\">Japan</SelectItem>\n                                    <SelectItem value=\"Australia\">Australia</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                                <FormMessage />\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n\n                        <div className=\"flex items-center gap-4\">\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.isPrimary`}\n                            render={({ field }) => (\n                              <FormItem className=\"flex flex-row items-start space-x-3 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value}\n                                    onCheckedChange={field.onChange}\n                                    aria-label={`Mark address ${index + 1} as primary`}\n                                  />\n                                </FormControl>\n                                <div className=\"space-y-1 leading-none\">\n                                  <FormLabel>Primary Address</FormLabel>\n                                </div>\n                              </FormItem>\n                            )}\n                          />\n\n                          <FormField\n                            control={form.control}\n                            name={`addresses.${index}.isActive`}\n                            render={({ field }) => (\n                              <FormItem className=\"flex flex-row items-start space-x-3 space-y-0\">\n                                <FormControl>\n                                  <Checkbox\n                                    checked={field.value}\n                                    onCheckedChange={field.onChange}\n                                    aria-label={`Mark address ${index + 1} as active`}\n                                  />\n                                </FormControl>\n                                <div className=\"space-y-1 leading-none\">\n                                  <FormLabel>Active</FormLabel>\n                                </div>\n                              </FormItem>\n                            )}\n                          />\n                        </div>\n                      </div>\n                    ))}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              {/* Capabilities Tab */}\n              <TabsContent value=\"capabilities\" className=\"space-y-6 mt-3\">\n                <Card className=\"gap-2\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Settings className=\"h-5 w-5\" />\n                      Capabilities & Financial\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-6\">\n                    {/* Products */}\n                    <div className=\"space-y-3\">\n                      <FormLabel>\n                        <FieldTooltip content=\"Products or items this supplier provides\">\n                          Products & Items\n                        </FieldTooltip>\n                      </FormLabel>\n                      <div className=\"flex gap-2\">\n                        <Input\n                          placeholder=\"Add a product or item\"\n                          value={productInput}\n                          onChange={(e) => setProductInput(e.target.value)}\n                          onKeyPress={(e) => e.key === \"Enter\" && (e.preventDefault(), addProduct())}\n                          aria-label=\"Add new product\"\n                        />\n                        <Button\n                          type=\"button\"\n                          onClick={addProduct}\n                          variant=\"outline\"\n                          aria-label=\"Add product\"\n                        >\n                          <Plus className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {watchedProducts.map((product, index) => (\n                          <Badge key={index} variant=\"secondary\" className=\"flex items-center gap-1\">\n                            {product}\n                            <Button\n                              type=\"button\"\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              className=\"h-auto p-0.5 hover:bg-transparent\"\n                              onClick={() => removeProduct(product)}\n                              aria-label={`Remove product ${product}`}\n                            >\n                              <X className=\"h-3 w-3\" />\n                            </Button>\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n\n                    {/* Services */}\n                    <div className=\"space-y-3\">\n                      <FormLabel>\n                        <FieldTooltip content=\"Services this supplier offers\">\n                          Services\n                        </FieldTooltip>\n                      </FormLabel>\n                      <div className=\"flex gap-2\">\n                        <Input\n                          placeholder=\"Add a service\"\n                          value={serviceInput}\n                          onChange={(e) => setServiceInput(e.target.value)}\n                          onKeyPress={(e) => e.key === \"Enter\" && (e.preventDefault(), addService())}\n                          aria-label=\"Add new service\"\n                        />\n                        <Button\n                          type=\"button\"\n                          onClick={addService}\n                          variant=\"outline\"\n                          aria-label=\"Add service\"\n                        >\n                          <Plus className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {watchedServices.map((service, index) => (\n                          <Badge key={index} variant=\"secondary\" className=\"flex items-center gap-1\">\n                            {service}\n                            <Button\n                              type=\"button\"\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              className=\"h-auto p-0.5 hover:bg-transparent\"\n                              onClick={() => removeService(service)}\n                              aria-label={`Remove service ${service}`}\n                            >\n                              <X className=\"h-3 w-3\" />\n                            </Button>\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                      <FormField\n                        control={form.control}\n                        name=\"capabilities.leadTime\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Expected delivery time in days\">\n                                Lead Time (days)\n                              </FieldTooltip>\n                            </FormLabel>\n                            <FormControl>\n                              <Input\n                                type=\"number\"\n                                placeholder=\"Enter lead time in days\"\n                                value={field.value?.toString() || \"\"}\n                                onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : 30)}\n                                aria-describedby=\"lead-time-help\"\n                              />\n                            </FormControl>\n                            <FormDescription id=\"lead-time-help\">\n                              Expected delivery time in days\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"capabilities.paymentTerms\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Payment terms for transactions\">\n                                Payment Terms\n                              </FieldTooltip>\n                            </FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                              <FormControl>\n                                <SelectTrigger aria-describedby=\"payment-terms-help\">\n                                  <SelectValue placeholder=\"Select payment terms\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"Net 15\">Net 15</SelectItem>\n                                <SelectItem value=\"Net 30\">Net 30</SelectItem>\n                                <SelectItem value=\"Net 45\">Net 45</SelectItem>\n                                <SelectItem value=\"Net 60\">Net 60</SelectItem>\n                                <SelectItem value=\"Net 90\">Net 90</SelectItem>\n                                <SelectItem value=\"COD\">Cash on Delivery</SelectItem>\n                                <SelectItem value=\"Prepaid\">Prepaid</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormDescription id=\"payment-terms-help\">\n                              Standard payment terms\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"financial.creditRating\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Credit rating assessment\">\n                                Credit Rating\n                              </FieldTooltip>\n                            </FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                              <FormControl>\n                                <SelectTrigger aria-describedby=\"credit-rating-help\">\n                                  <SelectValue placeholder=\"Select credit rating\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"AAA\">AAA - Excellent</SelectItem>\n                                <SelectItem value=\"AA\">AA - Very Good</SelectItem>\n                                <SelectItem value=\"A\">A - Good</SelectItem>\n                                <SelectItem value=\"BBB\">BBB - Adequate</SelectItem>\n                                <SelectItem value=\"BB\">BB - Questionable</SelectItem>\n                                <SelectItem value=\"B\">B - Poor</SelectItem>\n                                <SelectItem value=\"CCC\">CCC - Very Poor</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormDescription id=\"credit-rating-help\">\n                              Optional: Credit assessment\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={form.control}\n                        name=\"financial.currency\"\n                        render={({ field }) => (\n                          <FormItem className=\"gap-4\">\n                            <FormLabel>\n                              <FieldTooltip content=\"Primary transaction currency\">\n                                Financial Currency\n                              </FieldTooltip>\n                            </FormLabel>\n                            <Select onValueChange={field.onChange} value={field.value || \"\"}>\n                              <FormControl>\n                                <SelectTrigger aria-describedby=\"financial-currency-help\">\n                                  <SelectValue placeholder=\"Select currency\" />\n                                </SelectTrigger>\n                              </FormControl>\n                              <SelectContent>\n                                <SelectItem value=\"ZAR\">ZAR - South African Rand</SelectItem>\n                                <SelectItem value=\"USD\">USD - US Dollar</SelectItem>\n                                <SelectItem value=\"EUR\">EUR - Euro</SelectItem>\n                                <SelectItem value=\"GBP\">GBP - British Pound</SelectItem>\n                                <SelectItem value=\"CAD\">CAD - Canadian Dollar</SelectItem>\n                              </SelectContent>\n                            </Select>\n                            <FormDescription id=\"financial-currency-help\">\n                              Primary transaction currency\n                            </FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n            </Tabs>\n          </form>\n        </Form>\n      </div>\n    </TooltipProvider>\n  )\n}\n\nexport default EnhancedSupplierForm","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\ProductToInventoryWizard.tsx","messages":[{"ruleId":"no-redeclare","severity":2,"message":"'Warehouse' is already defined.","line":66,"column":11,"nodeType":"Identifier","messageId":"redeclared","endLine":66,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Textarea } from '@/components/ui/textarea'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Checkbox } from '@/components/ui/checkbox'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Separator } from '@/components/ui/separator'\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table'\r\nimport {\r\n  Package,\r\n  MapPin,\r\n  DollarSign,\r\n  AlertTriangle,\r\n  CheckCircle2,\r\n  ArrowRight,\r\n  Target,\r\n  Warehouse,\r\n  ClipboardCheck,\r\n  Zap,\r\n  Building2,\r\n  Clock,\r\n  ShoppingCart,\r\n  RefreshCw,\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  Settings\r\n} from 'lucide-react'\r\n\r\ninterface Product {\r\n  id: string\r\n  name: string\r\n  description: string\r\n  category: string\r\n  sku: string\r\n  supplierSku: string\r\n  basePrice: number\r\n  currency: string\r\n  active: boolean\r\n}\r\n\r\ninterface InventoryConfiguration {\r\n  productId: string\r\n  initialStock: number\r\n  reorderPoint: number\r\n  maxStock: number\r\n  unitCost: number\r\n  location: string\r\n  notes: string\r\n  autoReorderEnabled: boolean\r\n}\r\n\r\ninterface Warehouse {\r\n  id: string\r\n  name: string\r\n  code: string\r\n  locations: WarehouseLocation[]\r\n}\r\n\r\ninterface WarehouseLocation {\r\n  id: string\r\n  code: string\r\n  name: string\r\n  zone: string\r\n  aisle: string\r\n  shelf: string\r\n  available: boolean\r\n}\r\n\r\ninterface SupplierConfiguration {\r\n  leadTimeDays: number\r\n  minimumOrderQuantity: number\r\n  preferredOrderMultiple: number\r\n  autoReorderEnabled: boolean\r\n  qualityRating: number\r\n}\r\n\r\ninterface PromotionResult {\r\n  productId: string\r\n  inventoryItemId: string\r\n  status: 'success' | 'error' | 'warning'\r\n  message: string\r\n}\r\n\r\ninterface ProductToInventoryWizardProps {\r\n  isOpen: boolean\r\n  onClose: () => void\r\n  supplierId: string\r\n  supplierName: string\r\n  productIds: string[]\r\n  onComplete?: (results: PromotionResult[]) => void\r\n}\r\n\r\nconst STEPS = [\r\n  { id: 'products', title: 'Product Selection', description: 'Review products to promote' },\r\n  { id: 'inventory', title: 'Inventory Setup', description: 'Configure stock parameters' },\r\n  { id: 'locations', title: 'Location Assignment', description: 'Assign warehouse locations' },\r\n  { id: 'supplier', title: 'Supplier Settings', description: 'Configure supplier-specific settings' },\r\n  { id: 'review', title: 'Review & Confirm', description: 'Review and execute promotion' }\r\n]\r\n\r\nexport default function ProductToInventoryWizard({\r\n  isOpen,\r\n  onClose,\r\n  supplierId,\r\n  supplierName,\r\n  productIds,\r\n  onComplete\r\n}: ProductToInventoryWizardProps) {\r\n  const [currentStep, setCurrentStep] = useState(0)\r\n  const [loading, setLoading] = useState(false)\r\n  const [processing, setProcessing] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  const [products, setProducts] = useState<Product[]>([])\r\n  const [warehouses, setWarehouses] = useState<Warehouse[]>([])\r\n  const [selectedProducts, setSelectedProducts] = useState<Set<string>>(new Set())\r\n  const [inventoryConfigs, setInventoryConfigs] = useState<Map<string, InventoryConfiguration>>(new Map())\r\n  const [supplierConfig, setSupplierConfig] = useState<SupplierConfiguration>({\r\n    leadTimeDays: 14,\r\n    minimumOrderQuantity: 1,\r\n    preferredOrderMultiple: 1,\r\n    autoReorderEnabled: false,\r\n    qualityRating: 0\r\n  })\r\n  const [selectedWarehouse, setSelectedWarehouse] = useState<string>('')\r\n  const [promotionResults, setPromotionResults] = useState<PromotionResult[]>([])\r\n\r\n  useEffect(() => {\r\n    if (isOpen && productIds.length > 0) {\r\n      loadInitialData()\r\n    }\r\n  }, [isOpen, productIds])\r\n\r\n  const loadInitialData = async () => {\r\n    try {\r\n      setLoading(true)\r\n      setError(null)\r\n\r\n      // Load products and warehouses in parallel\r\n      const [productsResponse, warehousesResponse] = await Promise.all([\r\n        fetch(`/api/suppliers/${supplierId}/products?ids=${productIds.join(',')}`),\r\n        fetch('/api/warehouses')\r\n      ])\r\n\r\n      if (!productsResponse.ok) {\r\n        throw new Error('Failed to load products')\r\n      }\r\n\r\n      const productsData = await productsResponse.json()\r\n      if (!productsData.success) {\r\n        throw new Error(productsData.error || 'Failed to load products')\r\n      }\r\n\r\n      const warehousesData = warehousesResponse.ok ? await warehousesResponse.json() : { success: true, data: [] }\r\n\r\n      setProducts(productsData.data)\r\n      setWarehouses(warehousesData.data || [])\r\n\r\n      // Initialize selections\r\n      setSelectedProducts(new Set(productsData.data.map((p: Product) => p.id)))\r\n\r\n      // Initialize inventory configurations with defaults\r\n      const configs = new Map()\r\n      productsData.data.forEach((product: Product) => {\r\n        configs.set(product.id, {\r\n          productId: product.id,\r\n          initialStock: 0,\r\n          reorderPoint: 10,\r\n          maxStock: 100,\r\n          unitCost: product.basePrice,\r\n          location: '',\r\n          notes: '',\r\n          autoReorderEnabled: false\r\n        })\r\n      })\r\n      setInventoryConfigs(configs)\r\n\r\n      // Set default warehouse if available\r\n      if (warehousesData.data && warehousesData.data.length > 0) {\r\n        setSelectedWarehouse(warehousesData.data[0].id)\r\n      }\r\n\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Failed to load data')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const updateInventoryConfig = (productId: string, updates: Partial<InventoryConfiguration>) => {\r\n    setInventoryConfigs(prev => {\r\n      const newConfigs = new Map(prev)\r\n      const existing = newConfigs.get(productId) || { productId } as InventoryConfiguration\r\n      newConfigs.set(productId, { ...existing, ...updates })\r\n      return newConfigs\r\n    })\r\n  }\r\n\r\n  const handleNext = () => {\r\n    if (currentStep < STEPS.length - 1) {\r\n      setCurrentStep(prev => prev + 1)\r\n    }\r\n  }\r\n\r\n  const handlePrevious = () => {\r\n    if (currentStep > 0) {\r\n      setCurrentStep(prev => prev - 1)\r\n    }\r\n  }\r\n\r\n  const executePromotion = async () => {\r\n    try {\r\n      setProcessing(true)\r\n      setError(null)\r\n\r\n      const selectedProductsList = Array.from(selectedProducts)\r\n      const promotionPayload = {\r\n        supplierId,\r\n        warehouseId: selectedWarehouse,\r\n        supplierConfiguration: supplierConfig,\r\n        productPromotions: selectedProductsList.map(productId => {\r\n          const config = inventoryConfigs.get(productId)!\r\n          const product = products.find(p => p.id === productId)!\r\n\r\n          return {\r\n            productId,\r\n            sku: product.sku,\r\n            name: product.name,\r\n            description: product.description,\r\n            category: product.category,\r\n            initialStock: config.initialStock,\r\n            reorderPoint: config.reorderPoint,\r\n            maxStock: config.maxStock,\r\n            unitCost: config.unitCost,\r\n            location: config.location,\r\n            notes: config.notes,\r\n            autoReorderEnabled: config.autoReorderEnabled\r\n          }\r\n        })\r\n      }\r\n\r\n      const response = await fetch(`/api/suppliers/${supplierId}/inventory/promote`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify(promotionPayload)\r\n      })\r\n\r\n      const result = await response.json()\r\n\r\n      if (!result.success) {\r\n        throw new Error(result.error || 'Promotion failed')\r\n      }\r\n\r\n      setPromotionResults(result.data.results)\r\n\r\n      if (onComplete) {\r\n        onComplete(result.data.results)\r\n      }\r\n\r\n      // Auto-advance to final step to show results\r\n      setCurrentStep(STEPS.length - 1)\r\n\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Promotion failed')\r\n    } finally {\r\n      setProcessing(false)\r\n    }\r\n  }\r\n\r\n  const formatCurrency = (amount: number, currency = 'ZAR') => {\r\n    return new Intl.NumberFormat('en-ZA', {\r\n      style: 'currency',\r\n      currency,\r\n      minimumFractionDigits: 2\r\n    }).format(amount)\r\n  }\r\n\r\n  const getSelectedProducts = () => {\r\n    return products.filter(p => selectedProducts.has(p.id))\r\n  }\r\n\r\n  const getTotalValue = () => {\r\n    return Array.from(selectedProducts).reduce((total, productId) => {\r\n      const config = inventoryConfigs.get(productId)\r\n      return total + (config ? config.initialStock * config.unitCost : 0)\r\n    }, 0)\r\n  }\r\n\r\n  const canProceed = () => {\r\n    switch (currentStep) {\r\n      case 0: // Product selection\r\n        return selectedProducts.size > 0\r\n      case 1: // Inventory setup\r\n        return Array.from(selectedProducts).every(productId => {\r\n          const config = inventoryConfigs.get(productId)\r\n          return config && config.reorderPoint >= 0 && config.unitCost > 0\r\n        })\r\n      case 2: // Location assignment\r\n        return selectedWarehouse !== '' && Array.from(selectedProducts).every(productId => {\r\n          const config = inventoryConfigs.get(productId)\r\n          return config && config.location !== ''\r\n        })\r\n      case 3: // Supplier settings\r\n        return supplierConfig.leadTimeDays > 0 && supplierConfig.minimumOrderQuantity > 0\r\n      default:\r\n        return true\r\n    }\r\n  }\r\n\r\n  if (!isOpen) return null\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={onClose}>\r\n      <DialogContent className=\"max-w-5xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-3\">\r\n            <Package className=\"h-6 w-6\" />\r\n            <div>\r\n              <h2 className=\"text-xl font-bold\">Promote Products to Inventory</h2>\r\n              <p className=\"text-sm font-normal text-muted-foreground\">\r\n                {supplierName} • {selectedProducts.size} products selected\r\n              </p>\r\n            </div>\r\n          </DialogTitle>\r\n          <DialogDescription>\r\n            Configure inventory parameters and promote selected products to your main inventory system.\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {loading ? (\r\n          <div className=\"flex items-center justify-center h-64\">\r\n            <RefreshCw className=\"h-6 w-6 animate-spin mr-2\" />\r\n            <span>Loading products and warehouses...</span>\r\n          </div>\r\n        ) : error ? (\r\n          <Alert variant=\"destructive\">\r\n            <AlertTriangle className=\"h-4 w-4\" />\r\n            <AlertDescription>{error}</AlertDescription>\r\n          </Alert>\r\n        ) : (\r\n          <div className=\"space-y-6\">\r\n            {/* Progress Steps */}\r\n            <div className=\"flex items-center justify-between\">\r\n              {STEPS.map((step, index) => (\r\n                <div key={step.id} className=\"flex items-center\">\r\n                  <div className={`flex items-center justify-center w-10 h-10 rounded-full border-2 ${\r\n                    index <= currentStep\r\n                      ? 'bg-primary text-primary-foreground border-primary'\r\n                      : 'bg-background text-muted-foreground border-muted'\r\n                  }`}>\r\n                    {index < currentStep ? (\r\n                      <CheckCircle2 className=\"h-5 w-5\" />\r\n                    ) : (\r\n                      <span className=\"text-sm font-semibold\">{index + 1}</span>\r\n                    )}\r\n                  </div>\r\n                  {index < STEPS.length - 1 && (\r\n                    <div className={`w-16 h-0.5 mx-2 ${\r\n                      index < currentStep ? 'bg-primary' : 'bg-muted'\r\n                    }`} />\r\n                  )}\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n            <div className=\"text-center\">\r\n              <h3 className=\"text-lg font-semibold\">{STEPS[currentStep].title}</h3>\r\n              <p className=\"text-sm text-muted-foreground\">{STEPS[currentStep].description}</p>\r\n            </div>\r\n\r\n            {/* Step Content */}\r\n            <div className=\"min-h-[400px]\">\r\n              {currentStep === 0 && ( // Product Selection\r\n                (<Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <Package className=\"h-5 w-5\" />\r\n                      Select Products to Promote\r\n                    </CardTitle>\r\n                    <CardDescription>\r\n                      Choose which products to add to your inventory system\r\n                    </CardDescription>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <Table>\r\n                      <TableHeader>\r\n                        <TableRow>\r\n                          <TableHead className=\"w-12\"></TableHead>\r\n                          <TableHead>Product</TableHead>\r\n                          <TableHead>Category</TableHead>\r\n                          <TableHead className=\"text-right\">Base Price</TableHead>\r\n                          <TableHead>Status</TableHead>\r\n                        </TableRow>\r\n                      </TableHeader>\r\n                      <TableBody>\r\n                        {products.map((product) => (\r\n                          <TableRow key={product.id}>\r\n                            <TableCell>\r\n                              <Checkbox\r\n                                checked={selectedProducts.has(product.id)}\r\n                                onCheckedChange={(checked) => {\r\n                                  const newSelection = new Set(selectedProducts)\r\n                                  if (checked) {\r\n                                    newSelection.add(product.id)\r\n                                  } else {\r\n                                    newSelection.delete(product.id)\r\n                                  }\r\n                                  setSelectedProducts(newSelection)\r\n                                }}\r\n                              />\r\n                            </TableCell>\r\n                            <TableCell>\r\n                              <div>\r\n                                <p className=\"font-medium\">{product.name}</p>\r\n                                <p className=\"text-sm text-muted-foreground\">SKU: {product.sku}</p>\r\n                                {product.description && (\r\n                                  <p className=\"text-xs text-muted-foreground mt-1\">\r\n                                    {product.description.length > 60\r\n                                      ? `${product.description.substring(0, 60)}...`\r\n                                      : product.description\r\n                                    }\r\n                                  </p>\r\n                                )}\r\n                              </div>\r\n                            </TableCell>\r\n                            <TableCell>\r\n                              <Badge variant=\"outline\">\r\n                                {product.category.replace('_', ' ').toUpperCase()}\r\n                              </Badge>\r\n                            </TableCell>\r\n                            <TableCell className=\"text-right\">\r\n                              {formatCurrency(product.basePrice, product.currency)}\r\n                            </TableCell>\r\n                            <TableCell>\r\n                              <Badge variant={product.active ? 'default' : 'secondary'}>\r\n                                {product.active ? 'Active' : 'Inactive'}\r\n                              </Badge>\r\n                            </TableCell>\r\n                          </TableRow>\r\n                        ))}\r\n                      </TableBody>\r\n                    </Table>\r\n                  </CardContent>\r\n                </Card>)\r\n              )}\r\n\r\n              {currentStep === 1 && ( // Inventory Setup\r\n                (<div className=\"space-y-4\">\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"flex items-center gap-2\">\r\n                        <Settings className=\"h-5 w-5\" />\r\n                        Inventory Parameters\r\n                      </CardTitle>\r\n                      <CardDescription>\r\n                        Configure stock levels and costs for each product\r\n                      </CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-6\">\r\n                        {getSelectedProducts().map((product) => {\r\n                          const config = inventoryConfigs.get(product.id) || {} as InventoryConfiguration\r\n                          return (\r\n                            <Card key={product.id} className=\"border-muted\">\r\n                              <CardHeader className=\"pb-3\">\r\n                                <CardTitle className=\"text-base\">{product.name}</CardTitle>\r\n                                <CardDescription>SKU: {product.sku}</CardDescription>\r\n                              </CardHeader>\r\n                              <CardContent>\r\n                                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n                                  <div>\r\n                                    <Label htmlFor={`initialStock-${product.id}`}>Initial Stock</Label>\r\n                                    <Input\r\n                                      id={`initialStock-${product.id}`}\r\n                                      type=\"number\"\r\n                                      min=\"0\"\r\n                                      value={config.initialStock || 0}\r\n                                      onChange={(e) => updateInventoryConfig(product.id, {\r\n                                        initialStock: parseInt(e.target.value) || 0\r\n                                      })}\r\n                                    />\r\n                                  </div>\r\n                                  <div>\r\n                                    <Label htmlFor={`reorderPoint-${product.id}`}>Reorder Point *</Label>\r\n                                    <Input\r\n                                      id={`reorderPoint-${product.id}`}\r\n                                      type=\"number\"\r\n                                      min=\"0\"\r\n                                      value={config.reorderPoint || 10}\r\n                                      onChange={(e) => updateInventoryConfig(product.id, {\r\n                                        reorderPoint: parseInt(e.target.value) || 0\r\n                                      })}\r\n                                    />\r\n                                  </div>\r\n                                  <div>\r\n                                    <Label htmlFor={`maxStock-${product.id}`}>Max Stock</Label>\r\n                                    <Input\r\n                                      id={`maxStock-${product.id}`}\r\n                                      type=\"number\"\r\n                                      min=\"0\"\r\n                                      value={config.maxStock || 100}\r\n                                      onChange={(e) => updateInventoryConfig(product.id, {\r\n                                        maxStock: parseInt(e.target.value) || 0\r\n                                      })}\r\n                                    />\r\n                                  </div>\r\n                                  <div>\r\n                                    <Label htmlFor={`unitCost-${product.id}`}>Unit Cost *</Label>\r\n                                    <div className=\"relative\">\r\n                                      <DollarSign className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                                      <Input\r\n                                        id={`unitCost-${product.id}`}\r\n                                        type=\"number\"\r\n                                        min=\"0\"\r\n                                        step=\"0.01\"\r\n                                        className=\"pl-9\"\r\n                                        value={config.unitCost || product.basePrice}\r\n                                        onChange={(e) => updateInventoryConfig(product.id, {\r\n                                          unitCost: parseFloat(e.target.value) || 0\r\n                                        })}\r\n                                      />\r\n                                    </div>\r\n                                  </div>\r\n                                </div>\r\n                                <div className=\"mt-4\">\r\n                                  <Label htmlFor={`notes-${product.id}`}>Notes</Label>\r\n                                  <Textarea\r\n                                    id={`notes-${product.id}`}\r\n                                    placeholder=\"Add any notes about this product...\"\r\n                                    rows={2}\r\n                                    value={config.notes || ''}\r\n                                    onChange={(e) => updateInventoryConfig(product.id, {\r\n                                      notes: e.target.value\r\n                                    })}\r\n                                  />\r\n                                </div>\r\n                                <div className=\"mt-4 flex items-center space-x-2\">\r\n                                  <Checkbox\r\n                                    id={`autoReorder-${product.id}`}\r\n                                    checked={config.autoReorderEnabled || false}\r\n                                    onCheckedChange={(checked) => updateInventoryConfig(product.id, {\r\n                                      autoReorderEnabled: checked as boolean\r\n                                    })}\r\n                                  />\r\n                                  <Label htmlFor={`autoReorder-${product.id}`}>\r\n                                    Enable auto-reorder when stock reaches reorder point\r\n                                  </Label>\r\n                                </div>\r\n                              </CardContent>\r\n                            </Card>\r\n                          )\r\n                        })}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  {/* Summary */}\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"text-base\">Summary</CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"grid grid-cols-3 gap-4\">\r\n                        <div>\r\n                          <p className=\"text-sm text-muted-foreground\">Products</p>\r\n                          <p className=\"text-lg font-semibold\">{selectedProducts.size}</p>\r\n                        </div>\r\n                        <div>\r\n                          <p className=\"text-sm text-muted-foreground\">Total Initial Stock Value</p>\r\n                          <p className=\"text-lg font-semibold\">{formatCurrency(getTotalValue())}</p>\r\n                        </div>\r\n                        <div>\r\n                          <p className=\"text-sm text-muted-foreground\">Average Unit Cost</p>\r\n                          <p className=\"text-lg font-semibold\">\r\n                            {selectedProducts.size > 0 ? formatCurrency(getTotalValue() / Array.from(selectedProducts).reduce((sum, id) => {\r\n                              const config = inventoryConfigs.get(id)\r\n                              return sum + (config?.initialStock || 0)\r\n                            }, 0) || 0) : formatCurrency(0)}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>)\r\n              )}\r\n\r\n              {currentStep === 2 && ( // Location Assignment\r\n                (<div className=\"space-y-4\">\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"flex items-center gap-2\">\r\n                        <Warehouse className=\"h-5 w-5\" />\r\n                        Warehouse Selection\r\n                      </CardTitle>\r\n                      <CardDescription>\r\n                        Choose the warehouse for these products\r\n                      </CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-4\">\r\n                        <div>\r\n                          <Label htmlFor=\"warehouse\">Warehouse</Label>\r\n                          <Select value={selectedWarehouse} onValueChange={setSelectedWarehouse}>\r\n                            <SelectTrigger>\r\n                              <SelectValue placeholder=\"Select warehouse\" />\r\n                            </SelectTrigger>\r\n                            <SelectContent>\r\n                              {warehouses.map((warehouse) => (\r\n                                <SelectItem key={warehouse.id} value={warehouse.id}>\r\n                                  {warehouse.name} ({warehouse.code})\r\n                                </SelectItem>\r\n                              ))}\r\n                              {warehouses.length === 0 && (\r\n                                <SelectItem value=\"default\">Main Warehouse</SelectItem>\r\n                              )}\r\n                            </SelectContent>\r\n                          </Select>\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"flex items-center gap-2\">\r\n                        <MapPin className=\"h-5 w-5\" />\r\n                        Location Assignment\r\n                      </CardTitle>\r\n                      <CardDescription>\r\n                        Assign specific locations for each product\r\n                      </CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-4\">\r\n                        {getSelectedProducts().map((product) => {\r\n                          const config = inventoryConfigs.get(product.id) || {} as InventoryConfiguration\r\n                          return (\r\n                            <div key={product.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                              <div>\r\n                                <p className=\"font-medium\">{product.name}</p>\r\n                                <p className=\"text-sm text-muted-foreground\">SKU: {product.sku}</p>\r\n                              </div>\r\n                              <div className=\"w-48\">\r\n                                <Input\r\n                                  placeholder=\"e.g., A-1-2-B\"\r\n                                  value={config.location || ''}\r\n                                  onChange={(e) => updateInventoryConfig(product.id, {\r\n                                    location: e.target.value\r\n                                  })}\r\n                                />\r\n                              </div>\r\n                            </div>\r\n                          )\r\n                        })}\r\n                      </div>\r\n                      <div className=\"mt-4 p-4 bg-muted/50 rounded-lg\">\r\n                        <h4 className=\"text-sm font-medium mb-2\">Location Format</h4>\r\n                        <p className=\"text-sm text-muted-foreground\">\r\n                          Use format: Zone-Aisle-Shelf-Bin (e.g., A-1-2-B for Zone A, Aisle 1, Shelf 2, Bin B)\r\n                        </p>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>)\r\n              )}\r\n\r\n              {currentStep === 3 && ( // Supplier Settings\r\n                (<Card>\r\n                  <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\">\r\n                      <Building2 className=\"h-5 w-5\" />\r\n                      Supplier Configuration\r\n                    </CardTitle>\r\n                    <CardDescription>\r\n                      Configure supplier-specific settings for these products\r\n                    </CardDescription>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                      <div className=\"space-y-4\">\r\n                        <div>\r\n                          <Label htmlFor=\"leadTimeDays\">Lead Time (Days) *</Label>\r\n                          <div className=\"relative\">\r\n                            <Clock className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                            <Input\r\n                              id=\"leadTimeDays\"\r\n                              type=\"number\"\r\n                              min=\"1\"\r\n                              className=\"pl-9\"\r\n                              value={supplierConfig.leadTimeDays}\r\n                              onChange={(e) => setSupplierConfig(prev => ({\r\n                                ...prev,\r\n                                leadTimeDays: parseInt(e.target.value) || 1\r\n                              }))}\r\n                            />\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div>\r\n                          <Label htmlFor=\"minimumOrderQuantity\">Minimum Order Quantity *</Label>\r\n                          <Input\r\n                            id=\"minimumOrderQuantity\"\r\n                            type=\"number\"\r\n                            min=\"1\"\r\n                            value={supplierConfig.minimumOrderQuantity}\r\n                            onChange={(e) => setSupplierConfig(prev => ({\r\n                              ...prev,\r\n                              minimumOrderQuantity: parseInt(e.target.value) || 1\r\n                            }))}\r\n                          />\r\n                        </div>\r\n\r\n                        <div>\r\n                          <Label htmlFor=\"preferredOrderMultiple\">Preferred Order Multiple</Label>\r\n                          <Input\r\n                            id=\"preferredOrderMultiple\"\r\n                            type=\"number\"\r\n                            min=\"1\"\r\n                            value={supplierConfig.preferredOrderMultiple}\r\n                            onChange={(e) => setSupplierConfig(prev => ({\r\n                              ...prev,\r\n                              preferredOrderMultiple: parseInt(e.target.value) || 1\r\n                            }))}\r\n                          />\r\n                          <p className=\"text-xs text-muted-foreground mt-1\">\r\n                            Orders will be rounded to multiples of this number\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n\r\n                      <div className=\"space-y-4\">\r\n                        <div>\r\n                          <Label htmlFor=\"qualityRating\">Quality Rating (0-5)</Label>\r\n                          <Input\r\n                            id=\"qualityRating\"\r\n                            type=\"number\"\r\n                            min=\"0\"\r\n                            max=\"5\"\r\n                            step=\"0.1\"\r\n                            value={supplierConfig.qualityRating}\r\n                            onChange={(e) => setSupplierConfig(prev => ({\r\n                              ...prev,\r\n                              qualityRating: parseFloat(e.target.value) || 0\r\n                            }))}\r\n                          />\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center space-x-2\">\r\n                          <Checkbox\r\n                            id=\"globalAutoReorder\"\r\n                            checked={supplierConfig.autoReorderEnabled}\r\n                            onCheckedChange={(checked) => setSupplierConfig(prev => ({\r\n                              ...prev,\r\n                              autoReorderEnabled: checked as boolean\r\n                            }))}\r\n                          />\r\n                          <Label htmlFor=\"globalAutoReorder\">\r\n                            Enable auto-reorder for all products from this supplier\r\n                          </Label>\r\n                        </div>\r\n\r\n                        <div className=\"bg-blue-50 p-4 rounded-lg\">\r\n                          <h4 className=\"text-sm font-medium text-blue-900 mb-2\">Settings Summary</h4>\r\n                          <ul className=\"text-sm text-blue-800 space-y-1\">\r\n                            <li>• Orders will be placed {supplierConfig.leadTimeDays} days before stock runs out</li>\r\n                            <li>• Minimum order: {supplierConfig.minimumOrderQuantity} units</li>\r\n                            {supplierConfig.preferredOrderMultiple > 1 && (\r\n                              <li>• Orders rounded to multiples of {supplierConfig.preferredOrderMultiple}</li>\r\n                            )}\r\n                            <li>• Auto-reorder: {supplierConfig.autoReorderEnabled ? 'Enabled' : 'Disabled'}</li>\r\n                          </ul>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>)\r\n              )}\r\n\r\n              {currentStep === 4 && ( // Review & Confirm\r\n                (<div className=\"space-y-4\">\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle className=\"flex items-center gap-2\">\r\n                        <ClipboardCheck className=\"h-5 w-5\" />\r\n                        Review Configuration\r\n                      </CardTitle>\r\n                      <CardDescription>\r\n                        Review all settings before promoting products to inventory\r\n                      </CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-6\">\r\n                        {/* Summary Stats */}\r\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n                          <div className=\"text-center p-4 bg-muted/50 rounded-lg\">\r\n                            <p className=\"text-2xl font-bold text-blue-600\">{selectedProducts.size}</p>\r\n                            <p className=\"text-sm text-muted-foreground\">Products</p>\r\n                          </div>\r\n                          <div className=\"text-center p-4 bg-muted/50 rounded-lg\">\r\n                            <p className=\"text-2xl font-bold text-green-600\">{formatCurrency(getTotalValue())}</p>\r\n                            <p className=\"text-sm text-muted-foreground\">Initial Value</p>\r\n                          </div>\r\n                          <div className=\"text-center p-4 bg-muted/50 rounded-lg\">\r\n                            <p className=\"text-2xl font-bold text-orange-600\">{supplierConfig.leadTimeDays}</p>\r\n                            <p className=\"text-sm text-muted-foreground\">Lead Time (Days)</p>\r\n                          </div>\r\n                          <div className=\"text-center p-4 bg-muted/50 rounded-lg\">\r\n                            <p className=\"text-2xl font-bold text-purple-600\">\r\n                              {warehouses.find(w => w.id === selectedWarehouse)?.name || 'Main Warehouse'}\r\n                            </p>\r\n                            <p className=\"text-sm text-muted-foreground\">Warehouse</p>\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Products to Promote */}\r\n                        <div>\r\n                          <h4 className=\"font-medium mb-3\">Products to Promote</h4>\r\n                          <div className=\"space-y-2\">\r\n                            {getSelectedProducts().map((product) => {\r\n                              const config = inventoryConfigs.get(product.id)!\r\n                              return (\r\n                                <div key={product.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                                  <div>\r\n                                    <p className=\"font-medium\">{product.name}</p>\r\n                                    <p className=\"text-sm text-muted-foreground\">\r\n                                      {product.sku} • {config.location}\r\n                                    </p>\r\n                                  </div>\r\n                                  <div className=\"text-right\">\r\n                                    <p className=\"font-medium\">\r\n                                      {config.initialStock} units @ {formatCurrency(config.unitCost)}\r\n                                    </p>\r\n                                    <p className=\"text-sm text-muted-foreground\">\r\n                                      Reorder at: {config.reorderPoint}\r\n                                    </p>\r\n                                  </div>\r\n                                </div>\r\n                              )\r\n                            })}\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Execution Results */}\r\n                        {promotionResults.length > 0 && (\r\n                          <div>\r\n                            <h4 className=\"font-medium mb-3\">Promotion Results</h4>\r\n                            <div className=\"space-y-2\">\r\n                              {promotionResults.map((result, index) => (\r\n                                <div key={index} className={`flex items-center justify-between p-3 border rounded-lg ${\r\n                                  result.status === 'success' ? 'border-green-200 bg-green-50' :\r\n                                  result.status === 'error' ? 'border-red-200 bg-red-50' :\r\n                                  'border-yellow-200 bg-yellow-50'\r\n                                }`}>\r\n                                  <div className=\"flex items-center gap-2\">\r\n                                    {result.status === 'success' ? (\r\n                                      <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\r\n                                    ) : result.status === 'error' ? (\r\n                                      <AlertTriangle className=\"h-5 w-5 text-red-600\" />\r\n                                    ) : (\r\n                                      <AlertTriangle className=\"h-5 w-5 text-yellow-600\" />\r\n                                    )}\r\n                                    <div>\r\n                                      <p className=\"font-medium\">\r\n                                        {products.find(p => p.id === result.productId)?.name}\r\n                                      </p>\r\n                                      <p className=\"text-sm text-muted-foreground\">{result.message}</p>\r\n                                    </div>\r\n                                  </div>\r\n                                  <Badge variant={\r\n                                    result.status === 'success' ? 'default' :\r\n                                    result.status === 'error' ? 'destructive' : 'secondary'\r\n                                  }>\r\n                                    {result.status}\r\n                                  </Badge>\r\n                                </div>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>)\r\n              )}\r\n            </div>\r\n\r\n            {/* Navigation */}\r\n            <div className=\"flex items-center justify-between pt-6 border-t\">\r\n              <Button\r\n                variant=\"outline\"\r\n                onClick={handlePrevious}\r\n                disabled={currentStep === 0}\r\n              >\r\n                <ChevronLeft className=\"h-4 w-4 mr-2\" />\r\n                Previous\r\n              </Button>\r\n\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"text-sm text-muted-foreground\">\r\n                  Step {currentStep + 1} of {STEPS.length}\r\n                </span>\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-2\">\r\n                {currentStep < STEPS.length - 1 ? (\r\n                  <Button\r\n                    onClick={handleNext}\r\n                    disabled={!canProceed()}\r\n                  >\r\n                    Next\r\n                    <ChevronRight className=\"h-4 w-4 ml-2\" />\r\n                  </Button>\r\n                ) : promotionResults.length === 0 ? (\r\n                  <Button\r\n                    onClick={executePromotion}\r\n                    disabled={!canProceed() || processing}\r\n                  >\r\n                    {processing ? (\r\n                      <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                    ) : (\r\n                      <Zap className=\"h-4 w-4 mr-2\" />\r\n                    )}\r\n                    {processing ? 'Promoting...' : 'Promote to Inventory'}\r\n                  </Button>\r\n                ) : (\r\n                  <Button onClick={onClose}>\r\n                    <CheckCircle2 className=\"h-4 w-4 mr-2\" />\r\n                    Complete\r\n                  </Button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\SupplierDirectory.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An empty interface declaration allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowInterfaces' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":649,"column":11,"nodeType":"Identifier","messageId":"noEmptyInterface","endLine":649,"endColumn":33,"suggestions":[{"messageId":"replaceEmptyInterface","data":{"replacement":"object"},"fix":{"range":[17513,17548],"text":"type SupplierDirectoryProps = object"},"desc":"Replace empty interface with `object`."},{"messageId":"replaceEmptyInterface","data":{"replacement":"unknown"},"fix":{"range":[17513,17548],"text":"type SupplierDirectoryProps = unknown"},"desc":"Replace empty interface with `unknown`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n\"use client\"\r\n\r\nimport React, { useState, useMemo, useCallback } from \"react\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n  DropdownMenuCheckboxItem,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { cn, formatCurrency, formatPercentage, getStatusColor, getTierColor, formatDate } from \"@/lib/utils\"\r\nimport { Supplier, SupplierSearchFilters, SupplierSortOptions } from \"@/types/supplier\"\r\nimport {\r\n  Search,\r\n  Filter,\r\n  Plus,\r\n  Download,\r\n  Upload,\r\n  RefreshCw,\r\n  MoreHorizontal,\r\n  Eye,\r\n  Edit,\r\n  Trash2,\r\n  MapPin,\r\n  Phone,\r\n  Mail,\r\n  Globe,\r\n  Building2,\r\n  Star,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  Calendar,\r\n  Users,\r\n  DollarSign,\r\n  Package,\r\n  FileText,\r\n  ShoppingCart,\r\n  CreditCard,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Clock,\r\n  SortAsc,\r\n  SortDesc,\r\n  ArrowUpDown,\r\n  X,\r\n  Settings,\r\n  Columns\r\n} from \"lucide-react\"\r\n\r\n// Purged and seeded supplier list (minimal defaults)\r\nconst supplierSeedNames = [\r\n  \"BK Percussion\",\r\n  \"BC Electronics\",\r\n  \"Legacy Brands\",\r\n  \"Alpha Technologies\",\r\n  \"Music Power\",\r\n  \"Viva Afrika\",\r\n  \"Audiolite\",\r\n  \"Tuerk Multimedia\",\r\n  \"Tuerk Technologies\",\r\n  \"Sonic Informed\",\r\n  \"Stage Audio Works\",\r\n  \"Stage One Distribution\",\r\n  \"Yamaha Music South Africa\",\r\n  \"AV Distribution\",\r\n  \"Sennheiser South Africa\",\r\n  \"Planetworld\",\r\n  \"MD Distribution\",\r\n  \"Rockit Distribution\",\r\n  \"Rolling Thunder\",\r\n  \"Global Music\",\r\n  \"Audiosure\",\r\n  \"ApexPro Distribution\"\r\n]\r\n\r\nconst sampleSuppliers: Supplier[] = [\r\n  {\r\n    id: \"SUP-1001\",\r\n    name: \"BK Percussion\",\r\n    code: \"BKPRC\",\r\n    status: \"active\",\r\n    tier: \"strategic\",\r\n    category: \"Musical Instruments\",\r\n    subcategory: \"Percussion\",\r\n    tags: [\"percussion\", \"drums\", \"premium\", \"professional\"],\r\n    contacts: [{\r\n      id: \"c1\",\r\n      type: \"primary\",\r\n      name: \"Sarah Mitchell\",\r\n      title: \"Sales Manager\",\r\n      email: \"sarah@bkpercussion.co.za\",\r\n      phone: \"+27 11 234 5678\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    addresses: [{\r\n      id: \"a1\",\r\n      type: \"headquarters\",\r\n      addressLine1: \"123 Music Street\",\r\n      city: \"Johannesburg\",\r\n      state: \"Gauteng\",\r\n      postalCode: \"2000\",\r\n      country: \"South Africa\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    businessInfo: {\r\n      legalName: \"BK Percussion (Pty) Ltd\",\r\n      tradingName: \"BK Percussion\",\r\n      taxId: \"1234567890\",\r\n      registrationNumber: \"2010/123456/07\",\r\n      website: \"https://www.bkpercussion.co.za\",\r\n      foundedYear: 2010,\r\n      employeeCount: 25,\r\n      annualRevenue: 15000000,\r\n      currency: \"ZAR\"\r\n    },\r\n    capabilities: {\r\n      products: [\"Drum Kits\", \"Cymbals\", \"Percussion Accessories\", \"Electronic Drums\"],\r\n      services: [\"Equipment Rental\", \"Maintenance\", \"Custom Builds\"],\r\n      certifications: [{ id: \"cert1\", name: \"ISO 9001:2015\", issuer: \"SABS\", validUntil: \"2025-12-31\" }],\r\n      leadTime: 14,\r\n      minimumOrderValue: 5000,\r\n      paymentTerms: \"Net 30\"\r\n    },\r\n    performance: {\r\n      overallRating: 4.7,\r\n      qualityRating: 4.8,\r\n      deliveryRating: 4.6,\r\n      serviceRating: 4.7,\r\n      priceRating: 4.5,\r\n      metrics: {\r\n        onTimeDeliveryRate: 94,\r\n        qualityAcceptanceRate: 98,\r\n        responseTime: 2,\r\n        defectRate: 1.2,\r\n        leadTimeVariance: 3\r\n      },\r\n      kpis: [],\r\n      lastEvaluationDate: new Date(\"2024-01-15\"),\r\n      nextEvaluationDate: new Date(\"2024-07-15\")\r\n    },\r\n    financial: {\r\n      creditRating: \"A\",\r\n      paymentTerms: \"Net 30\",\r\n      currency: \"ZAR\"\r\n    },\r\n    createdAt: new Date(\"2023-01-15\"),\r\n    updatedAt: new Date(\"2024-01-20\"),\r\n    createdBy: \"admin\",\r\n    lastContactDate: new Date(\"2024-01-18\")\r\n  },\r\n  {\r\n    id: \"SUP-1002\",\r\n    name: \"BC Electronics\",\r\n    code: \"BCELEC\",\r\n    status: \"active\",\r\n    tier: \"preferred\",\r\n    category: \"Electronics\",\r\n    subcategory: \"Audio Equipment\",\r\n    tags: [\"electronics\", \"audio\", \"professional\", \"broadcast\"],\r\n    contacts: [{\r\n      id: \"c2\",\r\n      type: \"primary\",\r\n      name: \"David Chen\",\r\n      title: \"Technical Director\",\r\n      email: \"david@bcelectronics.co.za\",\r\n      phone: \"+27 21 345 6789\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    addresses: [{\r\n      id: \"a2\",\r\n      type: \"headquarters\",\r\n      addressLine1: \"456 Tech Avenue\",\r\n      city: \"Cape Town\",\r\n      state: \"Western Cape\",\r\n      postalCode: \"8001\",\r\n      country: \"South Africa\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    businessInfo: {\r\n      legalName: \"BC Electronics (Pty) Ltd\",\r\n      tradingName: \"BC Electronics\",\r\n      taxId: \"2345678901\",\r\n      registrationNumber: \"2012/234567/07\",\r\n      website: \"https://www.bcelectronics.co.za\",\r\n      foundedYear: 2012,\r\n      employeeCount: 40,\r\n      annualRevenue: 25000000,\r\n      currency: \"ZAR\"\r\n    },\r\n    capabilities: {\r\n      products: [\"Mixers\", \"Amplifiers\", \"Microphones\", \"Audio Processors\"],\r\n      services: [\"Installation\", \"Technical Support\", \"Training\"],\r\n      certifications: [{ id: \"cert2\", name: \"BEE Level 2\", issuer: \"SANAS\", validUntil: \"2025-06-30\" }],\r\n      leadTime: 21,\r\n      minimumOrderValue: 10000,\r\n      paymentTerms: \"Net 30\"\r\n    },\r\n    performance: {\r\n      overallRating: 4.5,\r\n      qualityRating: 4.6,\r\n      deliveryRating: 4.4,\r\n      serviceRating: 4.5,\r\n      priceRating: 4.3,\r\n      metrics: {\r\n        onTimeDeliveryRate: 92,\r\n        qualityAcceptanceRate: 96,\r\n        responseTime: 4,\r\n        defectRate: 2.1,\r\n        leadTimeVariance: 5\r\n      },\r\n      kpis: [],\r\n      lastEvaluationDate: new Date(\"2024-02-01\"),\r\n      nextEvaluationDate: new Date(\"2024-08-01\")\r\n    },\r\n    financial: {\r\n      creditRating: \"A-\",\r\n      paymentTerms: \"Net 30\",\r\n      currency: \"ZAR\"\r\n    },\r\n    createdAt: new Date(\"2023-02-01\"),\r\n    updatedAt: new Date(\"2024-02-05\"),\r\n    createdBy: \"admin\",\r\n    lastContactDate: new Date(\"2024-02-03\")\r\n  },\r\n  {\r\n    id: \"SUP-1003\",\r\n    name: \"Legacy Brands\",\r\n    code: \"LEGACY\",\r\n    status: \"active\",\r\n    tier: \"approved\",\r\n    category: \"Musical Instruments\",\r\n    subcategory: \"Guitars & Amplifiers\",\r\n    tags: [\"guitars\", \"amplifiers\", \"vintage\", \"classic\"],\r\n    contacts: [{\r\n      id: \"c3\",\r\n      type: \"primary\",\r\n      name: \"Mike Rodriguez\",\r\n      title: \"Sales Director\",\r\n      email: \"mike@legacybrands.co.za\",\r\n      phone: \"+27 31 456 7890\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    addresses: [{\r\n      id: \"a3\",\r\n      type: \"headquarters\",\r\n      addressLine1: \"789 Guitar Lane\",\r\n      city: \"Durban\",\r\n      state: \"KwaZulu-Natal\",\r\n      postalCode: \"4000\",\r\n      country: \"South Africa\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    businessInfo: {\r\n      legalName: \"Legacy Brands (Pty) Ltd\",\r\n      tradingName: \"Legacy Brands\",\r\n      taxId: \"3456789012\",\r\n      registrationNumber: \"2015/345678/07\",\r\n      website: \"https://www.legacybrands.co.za\",\r\n      foundedYear: 2015,\r\n      employeeCount: 18,\r\n      annualRevenue: 12000000,\r\n      currency: \"ZAR\"\r\n    },\r\n    capabilities: {\r\n      products: [\"Electric Guitars\", \"Acoustic Guitars\", \"Amplifiers\", \"Effects Pedals\"],\r\n      services: [\"Guitar Setup\", \"Repairs\", \"Custom Modifications\"],\r\n      certifications: [{ id: \"cert3\", name: \"BEE Level 3\", issuer: \"SANAS\", validUntil: \"2025-03-31\" }],\r\n      leadTime: 28,\r\n      minimumOrderValue: 3000,\r\n      paymentTerms: \"Net 30\"\r\n    },\r\n    performance: {\r\n      overallRating: 4.3,\r\n      qualityRating: 4.4,\r\n      deliveryRating: 4.2,\r\n      serviceRating: 4.3,\r\n      priceRating: 4.1,\r\n      metrics: {\r\n        onTimeDeliveryRate: 89,\r\n        qualityAcceptanceRate: 94,\r\n        responseTime: 6,\r\n        defectRate: 2.8,\r\n        leadTimeVariance: 7\r\n      },\r\n      kpis: [],\r\n      lastEvaluationDate: new Date(\"2024-01-20\"),\r\n      nextEvaluationDate: new Date(\"2024-07-20\")\r\n    },\r\n    financial: {\r\n      creditRating: \"B+\",\r\n      paymentTerms: \"Net 30\",\r\n      currency: \"ZAR\"\r\n    },\r\n    createdAt: new Date(\"2023-03-01\"),\r\n    updatedAt: new Date(\"2024-01-25\"),\r\n    createdBy: \"admin\",\r\n    lastContactDate: new Date(\"2024-01-22\")\r\n  }\r\n];\r\n\r\n/* removed legacy sample suppliers */\r\n\r\n/*\r\n  {\r\n    id: \"1\",\r\n    name: \"TechCorp Solutions Inc\",\r\n    code: \"TECH001\",\r\n    status: \"active\",\r\n    tier: \"strategic\",\r\n    category: \"Technology\",\r\n    subcategory: \"Software Development\",\r\n    tags: [\"preferred\", \"enterprise\", \"cloud\", \"innovation\"],\r\n    contacts: [{\r\n      id: \"c1\",\r\n      type: \"primary\",\r\n      name: \"John Smith\",\r\n      title: \"Account Manager\",\r\n      email: \"john@techcorp.com\",\r\n      phone: \"+1-555-0123\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    addresses: [{\r\n      id: \"a1\",\r\n      type: \"headquarters\",\r\n      addressLine1: \"123 Tech Street\",\r\n      city: \"San Francisco\",\r\n      state: \"CA\",\r\n      postalCode: \"94105\",\r\n      country: \"USA\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    businessInfo: {\r\n      legalName: \"TechCorp Solutions Inc\",\r\n      tradingName: \"TechCorp\",\r\n      taxId: \"12-3456789\",\r\n      registrationNumber: \"REG123456\",\r\n      website: \"https://techcorp.com\",\r\n      foundedYear: 2010,\r\n      employeeCount: 250,\r\n      annualRevenue: 50000000,\r\n      currency: \"USD\"\r\n    },\r\n    capabilities: {\r\n      products: [\"Software Development\", \"Cloud Services\", \"AI Solutions\"],\r\n      services: [\"Consulting\", \"Support\", \"Training\"],\r\n      certifications: [],\r\n      leadTime: 30,\r\n      paymentTerms: \"Net 30\"\r\n    },\r\n    performance: {\r\n      overallRating: 4.8,\r\n      qualityRating: 4.9,\r\n      deliveryRating: 4.7,\r\n      serviceRating: 4.8,\r\n      priceRating: 4.6,\r\n      metrics: {\r\n        onTimeDeliveryRate: 95,\r\n        qualityAcceptanceRate: 98,\r\n        responseTime: 2,\r\n        defectRate: 1.5,\r\n        leadTimeVariance: 5\r\n      },\r\n      kpis: [],\r\n      lastEvaluationDate: new Date(\"2024-01-15\"),\r\n      nextEvaluationDate: new Date(\"2024-07-15\")\r\n    },\r\n    financial: {\r\n      creditRating: \"A\",\r\n      paymentTerms: \"Net 30\",\r\n      currency: \"USD\"\r\n    },\r\n    createdAt: new Date(\"2023-01-15\"),\r\n    updatedAt: new Date(\"2024-01-20\"),\r\n    createdBy: \"admin\",\r\n    lastContactDate: new Date(\"2024-01-18\"),\r\n    nextReviewDate: new Date(\"2024-06-15\")\r\n  },\r\n  {\r\n    id: \"2\",\r\n    name: \"Global Manufacturing Inc\",\r\n    code: \"MANUF001\",\r\n    status: \"active\",\r\n    tier: \"preferred\",\r\n    category: \"Manufacturing\",\r\n    subcategory: \"Industrial Equipment\",\r\n    tags: [\"reliable\", \"iso-certified\", \"automotive\"],\r\n    contacts: [{\r\n      id: \"c2\",\r\n      type: \"primary\",\r\n      name: \"Sarah Johnson\",\r\n      title: \"Operations Manager\",\r\n      email: \"sarah@globalmanuf.com\",\r\n      phone: \"+1-555-0124\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    addresses: [{\r\n      id: \"a2\",\r\n      type: \"headquarters\",\r\n      addressLine1: \"456 Industrial Blvd\",\r\n      city: \"Detroit\",\r\n      state: \"MI\",\r\n      postalCode: \"48201\",\r\n      country: \"USA\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    businessInfo: {\r\n      legalName: \"Global Manufacturing Inc\",\r\n      tradingName: \"Global Manuf\",\r\n      taxId: \"98-7654321\",\r\n      registrationNumber: \"REG789012\",\r\n      website: \"https://globalmanuf.com\",\r\n      foundedYear: 1995,\r\n      employeeCount: 500,\r\n      annualRevenue: 120000000,\r\n      currency: \"USD\"\r\n    },\r\n    capabilities: {\r\n      products: [\"Components\", \"Assembly\", \"Custom Parts\"],\r\n      services: [\"Manufacturing\", \"Quality Control\", \"Testing\"],\r\n      certifications: [],\r\n      leadTime: 45,\r\n      paymentTerms: \"Net 45\"\r\n    },\r\n    performance: {\r\n      overallRating: 4.5,\r\n      qualityRating: 4.6,\r\n      deliveryRating: 4.3,\r\n      serviceRating: 4.5,\r\n      priceRating: 4.6,\r\n      metrics: {\r\n        onTimeDeliveryRate: 88,\r\n        qualityAcceptanceRate: 94,\r\n        responseTime: 4,\r\n        defectRate: 2.8,\r\n        leadTimeVariance: 12\r\n      },\r\n      kpis: [],\r\n      lastEvaluationDate: new Date(\"2024-01-10\"),\r\n      nextEvaluationDate: new Date(\"2024-07-10\")\r\n    },\r\n    financial: {\r\n      creditRating: \"B+\",\r\n      paymentTerms: \"Net 45\",\r\n      currency: \"USD\"\r\n    },\r\n    createdAt: new Date(\"2022-06-20\"),\r\n    updatedAt: new Date(\"2024-01-15\"),\r\n    createdBy: \"admin\",\r\n    lastContactDate: new Date(\"2024-01-12\"),\r\n    nextReviewDate: new Date(\"2024-05-20\")\r\n  },\r\n  {\r\n    id: \"3\",\r\n    name: \"EcoSupply Solutions\",\r\n    code: \"ECO001\",\r\n    status: \"pending\",\r\n    tier: \"approved\",\r\n    category: \"Sustainability\",\r\n    subcategory: \"Green Materials\",\r\n    tags: [\"green\", \"certified\", \"renewable\"],\r\n    contacts: [{\r\n      id: \"c3\",\r\n      type: \"primary\",\r\n      name: \"Maria Garcia\",\r\n      title: \"Sustainability Director\",\r\n      email: \"maria@ecosupply.com\",\r\n      phone: \"+1-555-0125\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    addresses: [{\r\n      id: \"a3\",\r\n      type: \"headquarters\",\r\n      addressLine1: \"789 Green Way\",\r\n      city: \"Portland\",\r\n      state: \"OR\",\r\n      postalCode: \"97201\",\r\n      country: \"USA\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    businessInfo: {\r\n      legalName: \"EcoSupply Solutions LLC\",\r\n      tradingName: \"EcoSupply\",\r\n      taxId: \"55-7891234\",\r\n      registrationNumber: \"REG345678\",\r\n      website: \"https://ecosupply.com\",\r\n      foundedYear: 2018,\r\n      employeeCount: 75,\r\n      annualRevenue: 15000000,\r\n      currency: \"USD\"\r\n    },\r\n    capabilities: {\r\n      products: [\"Sustainable Materials\", \"Eco-Packaging\", \"Recyclables\"],\r\n      services: [\"Consulting\", \"Carbon Footprint Analysis\", \"Sustainability Audits\"],\r\n      certifications: [],\r\n      leadTime: 21,\r\n      paymentTerms: \"Net 30\"\r\n    },\r\n    performance: {\r\n      overallRating: 4.2,\r\n      qualityRating: 4.3,\r\n      deliveryRating: 4.1,\r\n      serviceRating: 4.4,\r\n      priceRating: 3.8,\r\n      metrics: {\r\n        onTimeDeliveryRate: 85,\r\n        qualityAcceptanceRate: 92,\r\n        responseTime: 3,\r\n        defectRate: 3.2,\r\n        leadTimeVariance: 8\r\n      },\r\n      kpis: [],\r\n      lastEvaluationDate: new Date(\"2024-01-05\"),\r\n      nextEvaluationDate: new Date(\"2024-07-05\")\r\n    },\r\n    financial: {\r\n      creditRating: \"B\",\r\n      paymentTerms: \"Net 30\",\r\n      currency: \"USD\"\r\n    },\r\n    createdAt: new Date(\"2023-08-10\"),\r\n    updatedAt: new Date(\"2024-01-08\"),\r\n    createdBy: \"admin\",\r\n    lastContactDate: new Date(\"2024-01-05\"),\r\n    nextReviewDate: new Date(\"2024-04-10\")\r\n  },\r\n  {\r\n    id: \"4\",\r\n    name: \"Pacific Logistics Corp\",\r\n    code: \"LOG001\",\r\n    status: \"inactive\",\r\n    tier: \"conditional\",\r\n    category: \"Logistics\",\r\n    subcategory: \"Freight & Shipping\",\r\n    tags: [\"logistics\", \"shipping\", \"warehousing\"],\r\n    contacts: [{\r\n      id: \"c4\",\r\n      type: \"primary\",\r\n      name: \"David Chen\",\r\n      title: \"Logistics Manager\",\r\n      email: \"david@pacificlogistics.com\",\r\n      phone: \"+1-555-0126\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    addresses: [{\r\n      id: \"a4\",\r\n      type: \"headquarters\",\r\n      addressLine1: \"321 Harbor Drive\",\r\n      city: \"Los Angeles\",\r\n      state: \"CA\",\r\n      postalCode: \"90015\",\r\n      country: \"USA\",\r\n      isPrimary: true,\r\n      isActive: true\r\n    }],\r\n    businessInfo: {\r\n      legalName: \"Pacific Logistics Corporation\",\r\n      tradingName: \"Pacific Logistics\",\r\n      taxId: \"77-2468135\",\r\n      registrationNumber: \"REG901234\",\r\n      website: \"https://pacificlogistics.com\",\r\n      foundedYear: 2008,\r\n      employeeCount: 180,\r\n      annualRevenue: 35000000,\r\n      currency: \"USD\"\r\n    },\r\n    capabilities: {\r\n      products: [\"Shipping\", \"Warehousing\", \"Distribution\"],\r\n      services: [\"Logistics Planning\", \"Inventory Management\", \"Supply Chain Optimization\"],\r\n      certifications: [],\r\n      leadTime: 14,\r\n      paymentTerms: \"Net 60\"\r\n    },\r\n    performance: {\r\n      overallRating: 3.8,\r\n      qualityRating: 3.9,\r\n      deliveryRating: 3.6,\r\n      serviceRating: 4.0,\r\n      priceRating: 3.9,\r\n      metrics: {\r\n        onTimeDeliveryRate: 78,\r\n        qualityAcceptanceRate: 87,\r\n        responseTime: 6,\r\n        defectRate: 4.5,\r\n        leadTimeVariance: 18\r\n      },\r\n      kpis: [],\r\n      lastEvaluationDate: new Date(\"2023-12-20\"),\r\n      nextEvaluationDate: new Date(\"2024-06-20\")\r\n    },\r\n    financial: {\r\n      creditRating: \"C+\",\r\n      paymentTerms: \"Net 60\",\r\n      currency: \"USD\"\r\n    },\r\n    createdAt: new Date(\"2022-03-10\"),\r\n    updatedAt: new Date(\"2023-12-25\"),\r\n    createdBy: \"admin\",\r\n    lastContactDate: new Date(\"2023-12-18\"),\r\n    nextReviewDate: new Date(\"2024-03-15\")\r\n  }\r\n*/\r\n\r\ninterface SupplierDirectoryProps {}\r\n\r\nconst SupplierDirectory: React.FC<SupplierDirectoryProps> = () => {\r\n  const [suppliers] = useState<Supplier[]>(sampleSuppliers)\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n  const [selectedSuppliers, setSelectedSuppliers] = useState<string[]>([])\r\n  const [sortConfig, setSortConfig] = useState<SupplierSortOptions>({\r\n    field: \"name\",\r\n    direction: \"asc\"\r\n  })\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const [pageSize, setPageSize] = useState(10)\r\n  const [filters, setFilters] = useState<SupplierSearchFilters>({})\r\n  const [viewMode, setViewMode] = useState<\"table\" | \"cards\">(\"table\")\r\n  const [showFilters, setShowFilters] = useState(false)\r\n\r\n  // Get unique values for filter options\r\n  const filterOptions = useMemo(() => {\r\n    const categories = Array.from(new Set(suppliers.map(s => s.category)))\r\n    const statuses = Array.from(new Set(suppliers.map(s => s.status)))\r\n    const tiers = Array.from(new Set(suppliers.map(s => s.tier)))\r\n    const locations = Array.from(new Set(suppliers.map(s => s.addresses[0]?.country).filter(Boolean)))\r\n\r\n    return { categories, statuses, tiers, locations }\r\n  }, [suppliers])\r\n\r\n  // Filter and sort suppliers\r\n  const filteredAndSortedSuppliers = useMemo(() => {\r\n    const filtered = suppliers.filter(supplier => {\r\n      // Search query filter\r\n      if (searchQuery) {\r\n        const query = searchQuery.toLowerCase()\r\n        const matchesQuery =\r\n          supplier.name.toLowerCase().includes(query) ||\r\n          supplier.code.toLowerCase().includes(query) ||\r\n          supplier.businessInfo.legalName.toLowerCase().includes(query) ||\r\n          supplier.category.toLowerCase().includes(query) ||\r\n          supplier.tags.some(tag => tag.toLowerCase().includes(query))\r\n\r\n        if (!matchesQuery) return false\r\n      }\r\n\r\n      // Status filter\r\n      if (filters.status && filters.status.length > 0) {\r\n        if (!filters.status.includes(supplier.status)) return false\r\n      }\r\n\r\n      // Tier filter\r\n      if (filters.tier && filters.tier.length > 0) {\r\n        if (!filters.tier.includes(supplier.tier)) return false\r\n      }\r\n\r\n      // Category filter\r\n      if (filters.category && filters.category.length > 0) {\r\n        if (!filters.category.includes(supplier.category)) return false\r\n      }\r\n\r\n      // Location filter\r\n      if (filters.location && filters.location.length > 0) {\r\n        const supplierCountry = supplier.addresses[0]?.country\r\n        if (!supplierCountry || !filters.location.includes(supplierCountry)) return false\r\n      }\r\n\r\n      // Performance rating filter\r\n      if (filters.performanceRating) {\r\n        const rating = supplier.performance.overallRating\r\n        if (rating < filters.performanceRating.min || rating > filters.performanceRating.max) {\r\n          return false\r\n        }\r\n      }\r\n\r\n      return true\r\n    })\r\n\r\n    // Sort filtered results\r\n    filtered.sort((a, b) => {\r\n      let aValue: any, bValue: any\r\n\r\n      switch (sortConfig.field) {\r\n        case \"name\":\r\n          aValue = a.businessInfo.tradingName || a.businessInfo.legalName\r\n          bValue = b.businessInfo.tradingName || b.businessInfo.legalName\r\n          break\r\n        case \"code\":\r\n          aValue = a.code\r\n          bValue = b.code\r\n          break\r\n        case \"status\":\r\n          aValue = a.status\r\n          bValue = b.status\r\n          break\r\n        case \"tier\":\r\n          aValue = a.tier\r\n          bValue = b.tier\r\n          break\r\n        case \"performanceRating\":\r\n          aValue = a.performance.overallRating\r\n          bValue = b.performance.overallRating\r\n          break\r\n        case \"lastContactDate\":\r\n          aValue = a.lastContactDate || new Date(0)\r\n          bValue = b.lastContactDate || new Date(0)\r\n          break\r\n        case \"createdAt\":\r\n          aValue = a.createdAt\r\n          bValue = b.createdAt\r\n          break\r\n        default:\r\n          aValue = a.name\r\n          bValue = b.name\r\n      }\r\n\r\n      if (aValue < bValue) return sortConfig.direction === \"asc\" ? -1 : 1\r\n      if (aValue > bValue) return sortConfig.direction === \"asc\" ? 1 : -1\r\n      return 0\r\n    })\r\n\r\n    return filtered\r\n  }, [suppliers, searchQuery, filters, sortConfig])\r\n\r\n  // Pagination\r\n  const paginatedSuppliers = useMemo(() => {\r\n    const startIndex = (currentPage - 1) * pageSize\r\n    return filteredAndSortedSuppliers.slice(startIndex, startIndex + pageSize)\r\n  }, [filteredAndSortedSuppliers, currentPage, pageSize])\r\n\r\n  const totalPages = Math.ceil(filteredAndSortedSuppliers.length / pageSize)\r\n\r\n  // Handle sorting\r\n  const handleSort = useCallback((field: SupplierSortOptions[\"field\"]) => {\r\n    setSortConfig(prev => ({\r\n      field,\r\n      direction: prev.field === field && prev.direction === \"asc\" ? \"desc\" : \"asc\"\r\n    }))\r\n  }, [])\r\n\r\n  // Handle supplier selection\r\n  const handleSelectSupplier = useCallback((supplierId: string) => {\r\n    setSelectedSuppliers(prev =>\r\n      prev.includes(supplierId)\r\n        ? prev.filter(id => id !== supplierId)\r\n        : [...prev, supplierId]\r\n    )\r\n  }, [])\r\n\r\n  const handleSelectAll = useCallback(() => {\r\n    setSelectedSuppliers(prev =>\r\n      prev.length === paginatedSuppliers.length\r\n        ? []\r\n        : paginatedSuppliers.map(s => s.id)\r\n    )\r\n  }, [paginatedSuppliers])\r\n\r\n  // Clear filters\r\n  const clearFilters = useCallback(() => {\r\n    setFilters({})\r\n    setSearchQuery(\"\")\r\n  }, [])\r\n\r\n  // Render sort icon\r\n  const renderSortIcon = (field: SupplierSortOptions[\"field\"]) => {\r\n    if (sortConfig.field !== field) {\r\n      return <ArrowUpDown className=\"h-4 w-4 opacity-50\" />\r\n    }\r\n    return sortConfig.direction === \"asc\"\r\n      ? <SortAsc className=\"h-4 w-4\" />\r\n      : <SortDesc className=\"h-4 w-4\" />\r\n  }\r\n\r\n  const breadcrumbs = [\r\n    { label: \"Suppliers\" }\r\n  ]\r\n\r\n  return (\r\n    \r\n      <div className=\"space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold tracking-tight\">Supplier Directory</h1>\r\n            <p className=\"text-muted-foreground\">\r\n              Manage and monitor all your suppliers in one place\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button variant=\"outline\" size=\"sm\">\r\n              <Upload className=\"h-4 w-4 mr-2\" />\r\n              Import\r\n            </Button>\r\n            <Button variant=\"outline\" size=\"sm\">\r\n              <Download className=\"h-4 w-4 mr-2\" />\r\n              Export\r\n            </Button>\r\n            <Button size=\"sm\">\r\n              <Plus className=\"h-4 w-4 mr-2\" />\r\n              Add Supplier\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Summary Stats */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-muted-foreground\">Total Suppliers</p>\r\n                  <p className=\"text-2xl font-bold\">{suppliers.length}</p>\r\n                </div>\r\n                <Building2 className=\"h-8 w-8 text-blue-500\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-muted-foreground\">Active</p>\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {suppliers.filter(s => s.status === \"active\").length}\r\n                  </p>\r\n                </div>\r\n                <CheckCircle className=\"h-8 w-8 text-green-500\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-muted-foreground\">Strategic</p>\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {suppliers.filter(s => s.tier === \"strategic\").length}\r\n                  </p>\r\n                </div>\r\n                <Star className=\"h-8 w-8 text-purple-500\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm text-muted-foreground\">Avg Rating</p>\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {(suppliers.reduce((sum, s) => sum + s.performance.overallRating, 0) / suppliers.length).toFixed(1)}\r\n                  </p>\r\n                </div>\r\n                <TrendingUp className=\"h-8 w-8 text-orange-500\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Search and Filters */}\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex flex-col md:flex-row gap-4\">\r\n              <div className=\"flex-1\">\r\n                <div className=\"relative\">\r\n                  <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n                  <Input\r\n                    placeholder=\"Search suppliers by name, code, category, or tags...\"\r\n                    value={searchQuery}\r\n                    onChange={(e) => setSearchQuery(e.target.value)}\r\n                    className=\"pl-8\"\r\n                  />\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setShowFilters(!showFilters)}\r\n                  className={cn(showFilters && \"bg-accent\")}\r\n                >\r\n                  <Filter className=\"h-4 w-4 mr-2\" />\r\n                  Filters\r\n                  {Object.keys(filters).length > 0 && (\r\n                    <Badge variant=\"secondary\" className=\"ml-2\">\r\n                      {Object.keys(filters).length}\r\n                    </Badge>\r\n                  )}\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\" onClick={clearFilters}>\r\n                  <X className=\"h-4 w-4 mr-2\" />\r\n                  Clear\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                  Refresh\r\n                </Button>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Advanced Filters */}\r\n            {showFilters && (\r\n              <div className=\"mt-4 p-4 border rounded-lg bg-muted/50\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4\">\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Status</label>\r\n                    <Select\r\n                      value={filters.status?.[0] || \"\"}\r\n                      onValueChange={(value) =>\r\n                        setFilters(prev => ({ ...prev, status: value ? [value as any] : undefined }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All Statuses\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all\">All Statuses</SelectItem>\r\n                        {filterOptions.statuses.map(status => (\r\n                          <SelectItem key={status} value={status}>\r\n                            {status.charAt(0).toUpperCase() + status.slice(1)}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Tier</label>\r\n                    <Select\r\n                      value={filters.tier?.[0] || \"\"}\r\n                      onValueChange={(value) =>\r\n                        setFilters(prev => ({ ...prev, tier: value ? [value as any] : undefined }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All Tiers\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all\">All Tiers</SelectItem>\r\n                        {filterOptions.tiers.map(tier => (\r\n                          <SelectItem key={tier} value={tier}>\r\n                            {tier.charAt(0).toUpperCase() + tier.slice(1)}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Category</label>\r\n                    <Select\r\n                      value={filters.category?.[0] || \"\"}\r\n                      onValueChange={(value) =>\r\n                        setFilters(prev => ({ ...prev, category: value ? [value] : undefined }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All Categories\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all\">All Categories</SelectItem>\r\n                        {filterOptions.categories.map(category => (\r\n                          <SelectItem key={category} value={category}>\r\n                            {category}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Location</label>\r\n                    <Select\r\n                      value={filters.location?.[0] || \"\"}\r\n                      onValueChange={(value) =>\r\n                        setFilters(prev => ({ ...prev, location: value ? [value] : undefined }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All Locations\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all\">All Locations</SelectItem>\r\n                        {filterOptions.locations.map(location => (\r\n                          <SelectItem key={location} value={location}>\r\n                            {location}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">View</label>\r\n                    <Select value={viewMode} onValueChange={(value: any) => setViewMode(value)}>\r\n                      <SelectTrigger>\r\n                        <SelectValue />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"table\">Table View</SelectItem>\r\n                        <SelectItem value=\"cards\">Card View</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Results Summary */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              Showing {paginatedSuppliers.length} of {filteredAndSortedSuppliers.length} suppliers\r\n            </p>\r\n            {selectedSuppliers.length > 0 && (\r\n              <div className=\"flex items-center gap-2\">\r\n                <Badge variant=\"secondary\">\r\n                  {selectedSuppliers.length} selected\r\n                </Badge>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <Download className=\"h-4 w-4 mr-2\" />\r\n                  Export Selected\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                  Delete Selected\r\n                </Button>\r\n              </div>\r\n            )}\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Select value={pageSize.toString()} onValueChange={(value) => setPageSize(Number(value))}>\r\n              <SelectTrigger className=\"w-20\">\r\n                <SelectValue />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"5\">5</SelectItem>\r\n                <SelectItem value=\"10\">10</SelectItem>\r\n                <SelectItem value=\"20\">20</SelectItem>\r\n                <SelectItem value=\"50\">50</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n            <span className=\"text-sm text-muted-foreground\">per page</span>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Suppliers Table */}\r\n        <Card>\r\n          <CardContent className=\"p-0\">\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead className=\"w-12\">\r\n                    <Checkbox\r\n                      checked={selectedSuppliers.length === paginatedSuppliers.length && paginatedSuppliers.length > 0}\r\n                      onCheckedChange={handleSelectAll}\r\n                    />\r\n                  </TableHead>\r\n                  <TableHead>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={() => handleSort(\"name\")}\r\n                      className=\"h-8 p-0 hover:bg-transparent\"\r\n                    >\r\n                      Supplier\r\n                      {renderSortIcon(\"name\")}\r\n                    </Button>\r\n                  </TableHead>\r\n                  <TableHead>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={() => handleSort(\"status\")}\r\n                      className=\"h-8 p-0 hover:bg-transparent\"\r\n                    >\r\n                      Status\r\n                      {renderSortIcon(\"status\")}\r\n                    </Button>\r\n                  </TableHead>\r\n                  <TableHead>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={() => handleSort(\"tier\")}\r\n                      className=\"h-8 p-0 hover:bg-transparent\"\r\n                    >\r\n                      Tier\r\n                      {renderSortIcon(\"tier\")}\r\n                    </Button>\r\n                  </TableHead>\r\n                  <TableHead>Category</TableHead>\r\n                  <TableHead>Location</TableHead>\r\n                  <TableHead>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={() => handleSort(\"performanceRating\")}\r\n                      className=\"h-8 p-0 hover:bg-transparent\"\r\n                    >\r\n                      Performance\r\n                      {renderSortIcon(\"performanceRating\")}\r\n                    </Button>\r\n                  </TableHead>\r\n                  <TableHead>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={() => handleSort(\"lastContactDate\")}\r\n                      className=\"h-8 p-0 hover:bg-transparent\"\r\n                    >\r\n                      Last Contact\r\n                      {renderSortIcon(\"lastContactDate\")}\r\n                    </Button>\r\n                  </TableHead>\r\n                  <TableHead className=\"text-right\">Actions</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {paginatedSuppliers.map((supplier) => (\r\n                  <TableRow key={supplier.id}>\r\n                    <TableCell>\r\n                      <Checkbox\r\n                        checked={selectedSuppliers.includes(supplier.id)}\r\n                        onCheckedChange={() => handleSelectSupplier(supplier.id)}\r\n                      />\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center\">\r\n                          <Building2 className=\"h-4 w-4 text-primary\" />\r\n                        </div>\r\n                        <div>\r\n                          <div className=\"font-medium\">\r\n                            {supplier.businessInfo.tradingName || supplier.businessInfo.legalName}\r\n                          </div>\r\n                          <div className=\"text-sm text-muted-foreground\">\r\n                            {supplier.code}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Badge\r\n                        className={cn(\"capitalize\", getStatusColor(supplier.status))}\r\n                        variant=\"outline\"\r\n                      >\r\n                        {supplier.status}\r\n                      </Badge>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Badge\r\n                        className={cn(\"capitalize\", getTierColor(supplier.tier))}\r\n                        variant=\"outline\"\r\n                      >\r\n                        {supplier.tier}\r\n                      </Badge>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div>\r\n                        <div className=\"font-medium\">{supplier.category}</div>\r\n                        {supplier.subcategory && (\r\n                          <div className=\"text-sm text-muted-foreground\">\r\n                            {supplier.subcategory}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex items-center gap-1\">\r\n                        <MapPin className=\"h-3 w-3 text-muted-foreground\" />\r\n                        <span className=\"text-sm\">\r\n                          {supplier.addresses[0]?.city}, {supplier.addresses[0]?.country}\r\n                        </span>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Star className=\"h-4 w-4 fill-yellow-400 text-yellow-400\" />\r\n                          <span className=\"font-medium\">\r\n                            {supplier.performance.overallRating.toFixed(1)}\r\n                          </span>\r\n                        </div>\r\n                        <div className=\"text-xs text-muted-foreground\">\r\n                          {formatPercentage(supplier.performance.metrics.onTimeDeliveryRate)} OTD\r\n                        </div>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"text-sm\">\r\n                        {supplier.lastContactDate\r\n                          ? formatDate(supplier.lastContactDate)\r\n                          : \"Never\"\r\n                        }\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell className=\"text-right\">\r\n                      <DropdownMenu>\r\n                        <DropdownMenuTrigger asChild>\r\n                          <Button variant=\"ghost\" size=\"sm\">\r\n                            <MoreHorizontal className=\"h-4 w-4\" />\r\n                          </Button>\r\n                        </DropdownMenuTrigger>\r\n                        <DropdownMenuContent align=\"end\">\r\n                          <DropdownMenuItem>\r\n                            <Eye className=\"mr-2 h-4 w-4\" />\r\n                            View Details\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <Edit className=\"mr-2 h-4 w-4\" />\r\n                            Edit Supplier\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          <DropdownMenuItem>\r\n                            <ShoppingCart className=\"mr-2 h-4 w-4\" />\r\n                            New Purchase Order\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <FileText className=\"mr-2 h-4 w-4\" />\r\n                            View Contracts\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <CreditCard className=\"mr-2 h-4 w-4\" />\r\n                            Financial Records\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          <DropdownMenuItem variant=\"destructive\">\r\n                            <Trash2 className=\"mr-2 h-4 w-4\" />\r\n                            Delete\r\n                          </DropdownMenuItem>\r\n                        </DropdownMenuContent>\r\n                      </DropdownMenu>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Pagination */}\r\n        {totalPages > 1 && (\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"text-sm text-muted-foreground\">\r\n              Page {currentPage} of {totalPages}\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}\r\n                disabled={currentPage === 1}\r\n              >\r\n                Previous\r\n              </Button>\r\n              <div className=\"flex items-center gap-1\">\r\n                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\r\n                  const page = i + 1\r\n                  return (\r\n                    <Button\r\n                      key={page}\r\n                      variant={currentPage === page ? \"default\" : \"outline\"}\r\n                      size=\"sm\"\r\n                      onClick={() => setCurrentPage(page)}\r\n                    >\r\n                      {page}\r\n                    </Button>\r\n                  )\r\n                })}\r\n              </div>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}\r\n                disabled={currentPage === totalPages}\r\n              >\r\n                Next\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    \r\n  )\r\n}\r\n\r\nexport default SupplierDirectory","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\SupplierManagement.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":127,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":127,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n\"use client\"\r\n\r\nimport React, { useEffect, useState } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Checkbox } from '@/components/ui/checkbox'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu'\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from '@/components/ui/tooltip'\r\nimport {\r\n  Search,\r\n  Filter,\r\n  Plus,\r\n  Edit,\r\n  Trash2,\r\n  MoreHorizontal,\r\n  Eye,\r\n  Building2,\r\n  Mail,\r\n  Phone,\r\n  MapPin,\r\n  Star,\r\n  TrendingUp,\r\n  Package,\r\n  Clock,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  RefreshCw,\r\n  Download,\r\n  Upload,\r\n  X,\r\n  SlidersHorizontal\r\n} from 'lucide-react'\r\nimport { useSupplierStore } from '@/lib/stores/supplier-store'\r\nimport { useNotificationStore } from '@/lib/stores/notification-store'\r\nimport type { Supplier, SupplierFilters } from '@/lib/types/inventory'\r\nimport { format } from 'date-fns'\r\n\r\nexport default function SupplierManagement() {\r\n  const {\r\n    suppliers,\r\n    analytics,\r\n    filters,\r\n    loading,\r\n    error,\r\n    fetchSuppliers,\r\n    fetchAnalytics,\r\n    setFilters,\r\n    clearFilters,\r\n    addSupplier,\r\n    updateSupplier,\r\n    deleteSupplier,\r\n    clearError\r\n  } = useSupplierStore()\r\n\r\n  const { addNotification } = useNotificationStore()\r\n\r\n  const [searchTerm, setSearchTerm] = useState(filters.search || '')\r\n  const [showFilters, setShowFilters] = useState(false)\r\n  const [selectedSuppliers, setSelectedSuppliers] = useState<Set<string>>(new Set())\r\n  const [showAddSupplier, setShowAddSupplier] = useState(false)\r\n  const [editingSupplier, setEditingSupplier] = useState<Supplier | null>(null)\r\n  const [viewingSupplier, setViewingSupplier] = useState<Supplier | null>(null)\r\n\r\n  useEffect(() => {\r\n    loadData()\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    const debounceTimer = setTimeout(() => {\r\n      setFilters({ search: searchTerm })\r\n    }, 500)\r\n\r\n    return () => clearTimeout(debounceTimer)\r\n  }, [searchTerm])\r\n\r\n  const loadData = async () => {\r\n    try {\r\n      await Promise.all([\r\n        fetchSuppliers(),\r\n        fetchAnalytics()\r\n      ])\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to load supplier data',\r\n        message: error instanceof Error ? error.message : 'Unknown error occurred'\r\n      })\r\n    }\r\n  }\r\n\r\n  const handleDeleteSupplier = async (supplierId: string) => {\r\n    if (!confirm('Are you sure you want to delete this supplier? This action cannot be undone.')) {\r\n      return\r\n    }\r\n\r\n    try {\r\n      await deleteSupplier(supplierId)\r\n      addNotification({\r\n        type: 'success',\r\n        title: 'Supplier deleted',\r\n        message: 'Supplier has been successfully deleted'\r\n      })\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to delete supplier',\r\n        message: error instanceof Error ? error.message : 'Unknown error occurred'\r\n      })\r\n    }\r\n  }\r\n\r\n  const getStatusBadgeVariant = (status: string) => {\r\n    switch (status) {\r\n      case 'active':\r\n        return 'default'\r\n      case 'inactive':\r\n        return 'secondary'\r\n      case 'suspended':\r\n        return 'destructive'\r\n      case 'pending_approval':\r\n        return 'outline'\r\n      case 'blocked':\r\n        return 'destructive'\r\n      case 'under_review':\r\n        return 'outline'\r\n      default:\r\n        return 'secondary'\r\n    }\r\n  }\r\n\r\n  const getPerformanceTierColor = (tier: string) => {\r\n    switch (tier) {\r\n      case 'platinum':\r\n        return 'text-purple-600'\r\n      case 'gold':\r\n        return 'text-yellow-600'\r\n      case 'silver':\r\n        return 'text-gray-600'\r\n      case 'bronze':\r\n        return 'text-orange-600'\r\n      case 'unrated':\r\n        return 'text-gray-400'\r\n      default:\r\n        return 'text-gray-400'\r\n    }\r\n  }\r\n\r\n  const formatCurrency = (amount: number | null) => {\r\n    if (amount === null) return 'N/A'\r\n    return new Intl.NumberFormat('en-ZA', {\r\n      style: 'currency',\r\n      currency: 'ZAR',\r\n      minimumFractionDigits: 0\r\n    }).format(amount)\r\n  }\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return format(new Date(dateString), 'MMM dd, yyyy')\r\n  }\r\n\r\n  const statuses = ['active', 'inactive', 'suspended', 'pending_approval', 'blocked', 'under_review']\r\n  const performanceTiers = ['platinum', 'gold', 'silver', 'bronze', 'unrated']\r\n  const regions = [...new Set(suppliers.map(s => s.geographic_region).filter(Boolean))]\r\n  const categories = [...new Set(suppliers.map(s => s.primary_category).filter(Boolean))]\r\n  const beeLevels = [...new Set(suppliers.map(s => s.bee_level).filter(Boolean))]\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <div className=\"space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold tracking-tight\">Supplier Management</h1>\r\n            <p className=\"text-muted-foreground\">\r\n              Manage your supplier relationships and performance\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={loadData}\r\n              disabled={loading}\r\n            >\r\n              <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />\r\n              Refresh\r\n            </Button>\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n            >\r\n              <Download className=\"h-4 w-4 mr-2\" />\r\n              Export\r\n            </Button>\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n            >\r\n              <Upload className=\"h-4 w-4 mr-2\" />\r\n              Import\r\n            </Button>\r\n            <Button\r\n              onClick={() => setShowAddSupplier(true)}\r\n              size=\"sm\"\r\n            >\r\n              <Plus className=\"h-4 w-4 mr-2\" />\r\n              Add Supplier\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Analytics Cards */}\r\n        {analytics && (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n            <Card>\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Total Suppliers</p>\r\n                    <p className=\"text-2xl font-bold\">{analytics.totalSuppliers}</p>\r\n                    <p className=\"text-xs text-green-600\">\r\n                      {analytics.activeSuppliers} active\r\n                    </p>\r\n                  </div>\r\n                  <Building2 className=\"h-8 w-8 text-blue-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Total Spend</p>\r\n                    <p className=\"text-2xl font-bold\">{formatCurrency(analytics.spendAnalysis.totalSpend)}</p>\r\n                    <p className=\"text-xs text-blue-600\">\r\n                      Avg: {formatCurrency(analytics.spendAnalysis.avgOrderValue)}\r\n                    </p>\r\n                  </div>\r\n                  <TrendingUp className=\"h-8 w-8 text-green-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">On-Time Delivery</p>\r\n                    <p className=\"text-2xl font-bold\">{analytics.performanceMetrics.onTimeDeliveryRate.toFixed(1)}%</p>\r\n                    <p className=\"text-xs text-orange-600\">\r\n                      Avg: {analytics.performanceMetrics.avgDeliveryTime} days\r\n                    </p>\r\n                  </div>\r\n                  <Clock className=\"h-8 w-8 text-orange-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Quality Score</p>\r\n                    <p className=\"text-2xl font-bold\">{analytics.performanceMetrics.avgQualityScore.toFixed(1)}/5</p>\r\n                    <p className=\"text-xs text-purple-600\">\r\n                      Response: {analytics.performanceMetrics.avgResponsivenessScore.toFixed(1)}/5\r\n                    </p>\r\n                  </div>\r\n                  <Star className=\"h-8 w-8 text-yellow-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n        )}\r\n\r\n        {/* Search and Filters */}\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center gap-4\">\r\n              <div className=\"relative flex-1\">\r\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  placeholder=\"Search suppliers...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-10\"\r\n                />\r\n              </div>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setShowFilters(!showFilters)}\r\n              >\r\n                <SlidersHorizontal className=\"h-4 w-4 mr-2\" />\r\n                Filters\r\n                {Object.keys(filters).some(key =>\r\n                  key !== 'search' && filters[key as keyof SupplierFilters]\r\n                ) && (\r\n                  <Badge variant=\"secondary\" className=\"ml-2\">\r\n                    Active\r\n                  </Badge>\r\n                )}\r\n              </Button>\r\n              {Object.keys(filters).some(key => filters[key as keyof SupplierFilters]) && (\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={clearFilters}>\r\n                  <X className=\"h-4 w-4 mr-2\" />\r\n                  Clear\r\n                </Button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Advanced Filters */}\r\n            {showFilters && (\r\n              <div className=\"mt-4 p-4 bg-muted/50 rounded-lg space-y-4\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Status</label>\r\n                    <Select\r\n                      value={filters.status?.[0] || 'all_statuses'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ status: value && value !== 'all_statuses' ? [value as any] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All statuses\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_statuses\">All statuses</SelectItem>\r\n                        {statuses.map(status => (\r\n                          <SelectItem key={status} value={status}>\r\n                            {status.replace('_', ' ').toUpperCase()}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Performance Tier</label>\r\n                    <Select\r\n                      value={filters.performance_tier?.[0] || 'all_tiers'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ performance_tier: value && value !== 'all_tiers' ? [value as any] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All tiers\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_tiers\">All tiers</SelectItem>\r\n                        {performanceTiers.map(tier => (\r\n                          <SelectItem key={tier} value={tier}>\r\n                            {tier.toUpperCase()}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Category</label>\r\n                    <Select\r\n                      value={filters.category?.[0] || 'all_categories'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ category: value && value !== 'all_categories' ? [value] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All categories\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_categories\">All categories</SelectItem>\r\n                        {categories.map(category => (\r\n                          <SelectItem key={category} value={category}>\r\n                            {category}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Region</label>\r\n                    <Select\r\n                      value={filters.region?.[0] || 'all_regions'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ region: value && value !== 'all_regions' ? [value] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All regions\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_regions\">All regions</SelectItem>\r\n                        {regions.map(region => (\r\n                          <SelectItem key={region} value={region}>\r\n                            {region}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">BEE Level</label>\r\n                    <Select\r\n                      value={filters.bee_level?.[0] || 'all_levels'}\r\n                      onValueChange={(value) =>\r\n                        setFilters({ bee_level: value && value !== 'all_levels' ? [value] : undefined })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All levels\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"all_levels\">All levels</SelectItem>\r\n                        {beeLevels.map(level => (\r\n                          <SelectItem key={level} value={level}>\r\n                            {level}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center space-x-4\">\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <Checkbox\r\n                      id=\"preferred-only\"\r\n                      checked={filters.preferred_only || false}\r\n                      onCheckedChange={(checked) =>\r\n                        setFilters({ preferred_only: checked as boolean })\r\n                      }\r\n                    />\r\n                    <label htmlFor=\"preferred-only\" className=\"text-sm\">\r\n                      Preferred suppliers only\r\n                    </label>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Suppliers Table */}\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <Building2 className=\"h-5 w-5\" />\r\n              Suppliers ({suppliers.length})\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {loading ? (\r\n              <div className=\"flex items-center justify-center py-8\">\r\n                <RefreshCw className=\"h-6 w-6 animate-spin mr-2\" />\r\n                <span>Loading suppliers...</span>\r\n              </div>\r\n            ) : suppliers.length === 0 ? (\r\n              <div className=\"text-center py-8\">\r\n                <Building2 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\r\n                <h3 className=\"text-lg font-medium mb-2\">No suppliers found</h3>\r\n                <p className=\"text-muted-foreground mb-4\">\r\n                  Get started by adding your first supplier.\r\n                </p>\r\n                <Button onClick={() => setShowAddSupplier(true)}>\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Add Supplier\r\n                </Button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"rounded-md border\">\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead className=\"w-12\">\r\n                        <Checkbox\r\n                          checked={selectedSuppliers.size === suppliers.length}\r\n                          onCheckedChange={(checked) => {\r\n                            if (checked) {\r\n                              setSelectedSuppliers(new Set(suppliers.map(s => s.id)))\r\n                            } else {\r\n                              setSelectedSuppliers(new Set())\r\n                            }\r\n                          }}\r\n                        />\r\n                      </TableHead>\r\n                      <TableHead>Supplier</TableHead>\r\n                      <TableHead>Contact</TableHead>\r\n                      <TableHead>Performance</TableHead>\r\n                      <TableHead>Spend (12M)</TableHead>\r\n                      <TableHead>Location</TableHead>\r\n                      <TableHead>Status</TableHead>\r\n                      <TableHead className=\"text-center\">Actions</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {suppliers.map((supplier) => (\r\n                      <TableRow key={supplier.id}>\r\n                        <TableCell>\r\n                          <Checkbox\r\n                            checked={selectedSuppliers.has(supplier.id)}\r\n                            onCheckedChange={(checked) => {\r\n                              const newSelection = new Set(selectedSuppliers)\r\n                              if (checked) {\r\n                                newSelection.add(supplier.id)\r\n                              } else {\r\n                                newSelection.delete(supplier.id)\r\n                              }\r\n                              setSelectedSuppliers(newSelection)\r\n                            }}\r\n                          />\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-semibold\">\r\n                              {supplier.name.charAt(0)}\r\n                            </div>\r\n                            <div>\r\n                              <p className=\"font-medium\">{supplier.name}</p>\r\n                              <p className=\"text-sm text-muted-foreground\">\r\n                                {supplier.primary_category || 'General'}\r\n                              </p>\r\n                              {supplier.preferred_supplier && (\r\n                                <Badge variant=\"outline\" className=\"text-xs mt-1\">\r\n                                  Preferred\r\n                                </Badge>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"space-y-1\">\r\n                            {supplier.email && (\r\n                              <div className=\"flex items-center gap-1 text-sm\">\r\n                                <Mail className=\"h-3 w-3 text-muted-foreground\" />\r\n                                <span className=\"truncate max-w-[120px]\">{supplier.email}</span>\r\n                              </div>\r\n                            )}\r\n                            {supplier.phone && (\r\n                              <div className=\"flex items-center gap-1 text-sm\">\r\n                                <Phone className=\"h-3 w-3 text-muted-foreground\" />\r\n                                <span>{supplier.phone}</span>\r\n                              </div>\r\n                            )}\r\n                            {supplier.contact_person && (\r\n                              <p className=\"text-xs text-muted-foreground\">\r\n                                Contact: {supplier.contact_person}\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"space-y-1\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Star className={`h-3 w-3 ${getPerformanceTierColor(supplier.performance_tier)}`} />\r\n                              <span className={`text-sm font-medium ${getPerformanceTierColor(supplier.performance_tier)}`}>\r\n                                {supplier.performance_tier.toUpperCase()}\r\n                              </span>\r\n                            </div>\r\n                            {supplier.quality_rating && (\r\n                              <div className=\"text-xs text-muted-foreground\">\r\n                                Quality: {supplier.quality_rating.toFixed(1)}/5\r\n                              </div>\r\n                            )}\r\n                            {supplier.delivery_performance_score && (\r\n                              <div className=\"text-xs text-muted-foreground\">\r\n                                Delivery: {supplier.delivery_performance_score.toFixed(1)}%\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div>\r\n                            <p className=\"font-medium\">\r\n                              {formatCurrency(supplier.spend_last_12_months)}\r\n                            </p>\r\n                            {supplier.bee_level && (\r\n                              <p className=\"text-xs text-muted-foreground\">\r\n                                BEE: {supplier.bee_level}\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center gap-1 text-sm\">\r\n                            <MapPin className=\"h-3 w-3 text-muted-foreground\" />\r\n                            <span>{supplier.geographic_region || 'Not specified'}</span>\r\n                          </div>\r\n                          {supplier.rural_based && (\r\n                            <Badge variant=\"outline\" className=\"text-xs mt-1\">\r\n                              Rural\r\n                            </Badge>\r\n                          )}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <Badge variant={getStatusBadgeVariant(supplier.status)}>\r\n                            {supplier.status.replace('_', ' ').toUpperCase()}\r\n                          </Badge>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-center\">\r\n                          <DropdownMenu>\r\n                            <DropdownMenuTrigger asChild>\r\n                              <Button variant=\"ghost\" size=\"sm\">\r\n                                <MoreHorizontal className=\"h-4 w-4\" />\r\n                              </Button>\r\n                            </DropdownMenuTrigger>\r\n                            <DropdownMenuContent align=\"end\">\r\n                              <DropdownMenuItem\r\n                                onClick={() => setViewingSupplier(supplier)}\r\n                              >\r\n                                <Eye className=\"h-4 w-4 mr-2\" />\r\n                                View Details\r\n                              </DropdownMenuItem>\r\n                              <DropdownMenuItem\r\n                                onClick={() => setEditingSupplier(supplier)}\r\n                              >\r\n                                <Edit className=\"h-4 w-4 mr-2\" />\r\n                                Edit Supplier\r\n                              </DropdownMenuItem>\r\n                              <DropdownMenuItem\r\n                                onClick={() => handleDeleteSupplier(supplier.id)}\r\n                                className=\"text-red-600\"\r\n                              >\r\n                                <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                                Delete Supplier\r\n                              </DropdownMenuItem>\r\n                            </DropdownMenuContent>\r\n                          </DropdownMenu>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Add/Edit/View Dialogs would go here */}\r\n        {/* For brevity, not implementing the full dialogs in this response */}\r\n      </div>\r\n    </TooltipProvider>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\SupplierManagement_backup.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":127,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":127,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n\"use client\"\r\n\r\nimport React, { useEffect, useState } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Checkbox } from '@/components/ui/checkbox'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '@/components/ui/table'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog'\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu'\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from '@/components/ui/tooltip'\r\nimport {\r\n  Search,\r\n  Filter,\r\n  Plus,\r\n  Edit,\r\n  Trash2,\r\n  MoreHorizontal,\r\n  Eye,\r\n  Building2,\r\n  Mail,\r\n  Phone,\r\n  MapPin,\r\n  Star,\r\n  TrendingUp,\r\n  Package,\r\n  Clock,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  RefreshCw,\r\n  Download,\r\n  Upload,\r\n  X,\r\n  SlidersHorizontal\r\n} from 'lucide-react'\r\nimport { useSupplierStore } from '@/lib/stores/supplier-store'\r\nimport { useNotificationStore } from '@/lib/stores/notification-store'\r\nimport type { Supplier, SupplierFilters } from '@/lib/types/inventory'\r\nimport { format } from 'date-fns'\r\n\r\nexport default function SupplierManagement() {\r\n  const {\r\n    suppliers,\r\n    analytics,\r\n    filters,\r\n    loading,\r\n    error,\r\n    fetchSuppliers,\r\n    fetchAnalytics,\r\n    setFilters,\r\n    clearFilters,\r\n    addSupplier,\r\n    updateSupplier,\r\n    deleteSupplier,\r\n    clearError\r\n  } = useSupplierStore()\r\n\r\n  const { addNotification } = useNotificationStore()\r\n\r\n  const [searchTerm, setSearchTerm] = useState(filters.search || '')\r\n  const [showFilters, setShowFilters] = useState(false)\r\n  const [selectedSuppliers, setSelectedSuppliers] = useState<Set<string>>(new Set())\r\n  const [showAddSupplier, setShowAddSupplier] = useState(false)\r\n  const [editingSupplier, setEditingSupplier] = useState<Supplier | null>(null)\r\n  const [viewingSupplier, setViewingSupplier] = useState<Supplier | null>(null)\r\n\r\n  useEffect(() => {\r\n    loadData()\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    const debounceTimer = setTimeout(() => {\r\n      setFilters({ search: searchTerm })\r\n    }, 500)\r\n\r\n    return () => clearTimeout(debounceTimer)\r\n  }, [searchTerm])\r\n\r\n  const loadData = async () => {\r\n    try {\r\n      await Promise.all([\r\n        fetchSuppliers(),\r\n        fetchAnalytics()\r\n      ])\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to load supplier data',\r\n        message: error instanceof Error ? error.message : 'Unknown error occurred'\r\n      })\r\n    }\r\n  }\r\n\r\n  const handleDeleteSupplier = async (supplierId: string) => {\r\n    if (!confirm('Are you sure you want to delete this supplier? This action cannot be undone.')) {\r\n      return\r\n    }\r\n\r\n    try {\r\n      await deleteSupplier(supplierId)\r\n      addNotification({\r\n        type: 'success',\r\n        title: 'Supplier deleted',\r\n        message: 'Supplier has been successfully deleted'\r\n      })\r\n    } catch (error) {\r\n      addNotification({\r\n        type: 'error',\r\n        title: 'Failed to delete supplier',\r\n        message: error instanceof Error ? error.message : 'Unknown error occurred'\r\n      })\r\n    }\r\n  }\r\n\r\n  const getStatusBadgeVariant = (status: string) => {\r\n    switch (status) {\r\n      case 'active':\r\n        return 'default'\r\n      case 'inactive':\r\n        return 'secondary'\r\n      case 'suspended':\r\n        return 'destructive'\r\n      case 'pending_approval':\r\n        return 'outline'\r\n      case 'blocked':\r\n        return 'destructive'\r\n      case 'under_review':\r\n        return 'outline'\r\n      default:\r\n        return 'secondary'\r\n    }\r\n  }\r\n\r\n  const getPerformanceTierColor = (tier: string) => {\r\n    switch (tier) {\r\n      case 'platinum':\r\n        return 'text-purple-600'\r\n      case 'gold':\r\n        return 'text-yellow-600'\r\n      case 'silver':\r\n        return 'text-gray-600'\r\n      case 'bronze':\r\n        return 'text-orange-600'\r\n      case 'unrated':\r\n        return 'text-gray-400'\r\n      default:\r\n        return 'text-gray-400'\r\n    }\r\n  }\r\n\r\n  const formatCurrency = (amount: number | null) => {\r\n    if (amount === null) return 'N/A'\r\n    return new Intl.NumberFormat('en-ZA', {\r\n      style: 'currency',\r\n      currency: 'ZAR',\r\n      minimumFractionDigits: 0\r\n    }).format(amount)\r\n  }\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return format(new Date(dateString), 'MMM dd, yyyy')\r\n  }\r\n\r\n  const statuses = ['active', 'inactive', 'suspended', 'pending_approval', 'blocked', 'under_review']\r\n  const performanceTiers = ['platinum', 'gold', 'silver', 'bronze', 'unrated']\r\n  const regions = [...new Set(suppliers.map(s => s.geographic_region).filter(Boolean))]\r\n  const categories = [...new Set(suppliers.map(s => s.primary_category).filter(Boolean))]\r\n  const beeLevels = [...new Set(suppliers.map(s => s.bee_level).filter(Boolean))]\r\n\r\n  const ALL_STATUSES_VALUE = '__all-statuses__'\r\n  const ALL_TIERS_VALUE = '__all-tiers__'\r\n  const ALL_CATEGORIES_VALUE = '__all-categories__'\r\n  const ALL_REGIONS_VALUE = '__all-regions__'\r\n  const ALL_LEVELS_VALUE = '__all-levels__'\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <div className=\"space-y-6\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h1 className=\"text-3xl font-bold tracking-tight\">Supplier Management</h1>\r\n            <p className=\"text-muted-foreground\">\r\n              Manage your supplier relationships and performance\r\n            </p>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={loadData}\r\n              disabled={loading}\r\n            >\r\n              <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />\r\n              Refresh\r\n            </Button>\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n            >\r\n              <Download className=\"h-4 w-4 mr-2\" />\r\n              Export\r\n            </Button>\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n            >\r\n              <Upload className=\"h-4 w-4 mr-2\" />\r\n              Import\r\n            </Button>\r\n            <Button\r\n              onClick={() => setShowAddSupplier(true)}\r\n              size=\"sm\"\r\n            >\r\n              <Plus className=\"h-4 w-4 mr-2\" />\r\n              Add Supplier\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Analytics Cards */}\r\n        {analytics && (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n            <Card>\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Total Suppliers</p>\r\n                    <p className=\"text-2xl font-bold\">{analytics.totalSuppliers}</p>\r\n                    <p className=\"text-xs text-green-600\">\r\n                      {analytics.activeSuppliers} active\r\n                    </p>\r\n                  </div>\r\n                  <Building2 className=\"h-8 w-8 text-blue-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Total Spend</p>\r\n                    <p className=\"text-2xl font-bold\">{formatCurrency(analytics.spendAnalysis.totalSpend)}</p>\r\n                    <p className=\"text-xs text-blue-600\">\r\n                      Avg: {formatCurrency(analytics.spendAnalysis.avgOrderValue)}\r\n                    </p>\r\n                  </div>\r\n                  <TrendingUp className=\"h-8 w-8 text-green-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">On-Time Delivery</p>\r\n                    <p className=\"text-2xl font-bold\">{analytics.performanceMetrics.onTimeDeliveryRate.toFixed(1)}%</p>\r\n                    <p className=\"text-xs text-orange-600\">\r\n                      Avg: {analytics.performanceMetrics.avgDeliveryTime} days\r\n                    </p>\r\n                  </div>\r\n                  <Clock className=\"h-8 w-8 text-orange-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardContent className=\"p-6\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <p className=\"text-sm text-muted-foreground\">Quality Score</p>\r\n                    <p className=\"text-2xl font-bold\">{analytics.performanceMetrics.avgQualityScore.toFixed(1)}/5</p>\r\n                    <p className=\"text-xs text-purple-600\">\r\n                      Response: {analytics.performanceMetrics.avgResponsivenessScore.toFixed(1)}/5\r\n                    </p>\r\n                  </div>\r\n                  <Star className=\"h-8 w-8 text-yellow-500\" />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n        )}\r\n\r\n        {/* Search and Filters */}\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center gap-4\">\r\n              <div className=\"relative flex-1\">\r\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  placeholder=\"Search suppliers...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-10\"\r\n                />\r\n              </div>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setShowFilters(!showFilters)}\r\n              >\r\n                <SlidersHorizontal className=\"h-4 w-4 mr-2\" />\r\n                Filters\r\n                {Object.keys(filters).some(key =>\r\n                  key !== 'search' && filters[key as keyof SupplierFilters]\r\n                ) && (\r\n                  <Badge variant=\"secondary\" className=\"ml-2\">\r\n                    Active\r\n                  </Badge>\r\n                )}\r\n              </Button>\r\n              {Object.keys(filters).some(key => filters[key as keyof SupplierFilters]) && (\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={clearFilters}>\r\n                  <X className=\"h-4 w-4 mr-2\" />\r\n                  Clear\r\n                </Button>\r\n              )}\r\n            </div>\r\n\r\n            {/* Advanced Filters */}\r\n            {showFilters && (\r\n              <div className=\"mt-4 p-4 bg-muted/50 rounded-lg space-y-4\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Status</label>\r\n                    <Select\r\n                      value={filters.status?.[0] || ALL_STATUSES_VALUE}\r\n                      onValueChange={(value) =>\r\n                        setFilters({\r\n                          status: value === ALL_STATUSES_VALUE ? undefined : [value as any],\r\n                        })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All statuses\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value={ALL_STATUSES_VALUE}>All statuses</SelectItem>\r\n                        {statuses.map(status => (\r\n                          <SelectItem key={status} value={status}>\r\n                            {status.replace('_', ' ').toUpperCase()}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Performance Tier</label>\r\n                    <Select\r\n                      value={filters.performance_tier?.[0] || ALL_TIERS_VALUE}\r\n                      onValueChange={(value) =>\r\n                        setFilters({\r\n                          performance_tier:\r\n                            value === ALL_TIERS_VALUE ? undefined : [value as any],\r\n                        })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All tiers\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value={ALL_TIERS_VALUE}>All tiers</SelectItem>\r\n                        {performanceTiers.map(tier => (\r\n                          <SelectItem key={tier} value={tier}>\r\n                            {tier.toUpperCase()}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Category</label>\r\n                    <Select\r\n                      value={filters.category?.[0] || ALL_CATEGORIES_VALUE}\r\n                      onValueChange={(value) =>\r\n                        setFilters({\r\n                          category: value === ALL_CATEGORIES_VALUE ? undefined : [value],\r\n                        })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All categories\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value={ALL_CATEGORIES_VALUE}>All categories</SelectItem>\r\n                        {categories.map(category => (\r\n                          <SelectItem key={category} value={category}>\r\n                            {category}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">Region</label>\r\n                    <Select\r\n                      value={filters.region?.[0] || ALL_REGIONS_VALUE}\r\n                      onValueChange={(value) =>\r\n                        setFilters({\r\n                          region: value === ALL_REGIONS_VALUE ? undefined : [value],\r\n                        })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All regions\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value={ALL_REGIONS_VALUE}>All regions</SelectItem>\r\n                        {regions.map(region => (\r\n                          <SelectItem key={region} value={region}>\r\n                            {region}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <label className=\"text-sm font-medium mb-2 block\">BEE Level</label>\r\n                    <Select\r\n                      value={filters.bee_level?.[0] || ALL_LEVELS_VALUE}\r\n                      onValueChange={(value) =>\r\n                        setFilters({\r\n                          bee_level: value === ALL_LEVELS_VALUE ? undefined : [value],\r\n                        })\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"All levels\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value={ALL_LEVELS_VALUE}>All levels</SelectItem>\r\n                        {beeLevels.map(level => (\r\n                          <SelectItem key={level} value={level}>\r\n                            {level}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center space-x-4\">\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <Checkbox\r\n                      id=\"preferred-only\"\r\n                      checked={filters.preferred_only || false}\r\n                      onCheckedChange={(checked) =>\r\n                        setFilters({ preferred_only: checked as boolean })\r\n                      }\r\n                    />\r\n                    <label htmlFor=\"preferred-only\" className=\"text-sm\">\r\n                      Preferred suppliers only\r\n                    </label>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Suppliers Table */}\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <Building2 className=\"h-5 w-5\" />\r\n              Suppliers ({suppliers.length})\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {loading ? (\r\n              <div className=\"flex items-center justify-center py-8\">\r\n                <RefreshCw className=\"h-6 w-6 animate-spin mr-2\" />\r\n                <span>Loading suppliers...</span>\r\n              </div>\r\n            ) : suppliers.length === 0 ? (\r\n              <div className=\"text-center py-8\">\r\n                <Building2 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\r\n                <h3 className=\"text-lg font-medium mb-2\">No suppliers found</h3>\r\n                <p className=\"text-muted-foreground mb-4\">\r\n                  Get started by adding your first supplier.\r\n                </p>\r\n                <Button onClick={() => setShowAddSupplier(true)}>\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Add Supplier\r\n                </Button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"rounded-md border\">\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead className=\"w-12\">\r\n                        <Checkbox\r\n                          checked={selectedSuppliers.size === suppliers.length}\r\n                          onCheckedChange={(checked) => {\r\n                            if (checked) {\r\n                              setSelectedSuppliers(new Set(suppliers.map(s => s.id)))\r\n                            } else {\r\n                              setSelectedSuppliers(new Set())\r\n                            }\r\n                          }}\r\n                        />\r\n                      </TableHead>\r\n                      <TableHead>Supplier</TableHead>\r\n                      <TableHead>Contact</TableHead>\r\n                      <TableHead>Performance</TableHead>\r\n                      <TableHead>Spend (12M)</TableHead>\r\n                      <TableHead>Location</TableHead>\r\n                      <TableHead>Status</TableHead>\r\n                      <TableHead className=\"text-center\">Actions</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {suppliers.map((supplier) => (\r\n                      <TableRow key={supplier.id}>\r\n                        <TableCell>\r\n                          <Checkbox\r\n                            checked={selectedSuppliers.has(supplier.id)}\r\n                            onCheckedChange={(checked) => {\r\n                              const newSelection = new Set(selectedSuppliers)\r\n                              if (checked) {\r\n                                newSelection.add(supplier.id)\r\n                              } else {\r\n                                newSelection.delete(supplier.id)\r\n                              }\r\n                              setSelectedSuppliers(newSelection)\r\n                            }}\r\n                          />\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-semibold\">\r\n                              {supplier.name.charAt(0)}\r\n                            </div>\r\n                            <div>\r\n                              <p className=\"font-medium\">{supplier.name}</p>\r\n                              <p className=\"text-sm text-muted-foreground\">\r\n                                {supplier.primary_category || 'General'}\r\n                              </p>\r\n                              {supplier.preferred_supplier && (\r\n                                <Badge variant=\"outline\" className=\"text-xs mt-1\">\r\n                                  Preferred\r\n                                </Badge>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"space-y-1\">\r\n                            {supplier.email && (\r\n                              <div className=\"flex items-center gap-1 text-sm\">\r\n                                <Mail className=\"h-3 w-3 text-muted-foreground\" />\r\n                                <span className=\"truncate max-w-[120px]\">{supplier.email}</span>\r\n                              </div>\r\n                            )}\r\n                            {supplier.phone && (\r\n                              <div className=\"flex items-center gap-1 text-sm\">\r\n                                <Phone className=\"h-3 w-3 text-muted-foreground\" />\r\n                                <span>{supplier.phone}</span>\r\n                              </div>\r\n                            )}\r\n                            {supplier.contact_person && (\r\n                              <p className=\"text-xs text-muted-foreground\">\r\n                                Contact: {supplier.contact_person}\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"space-y-1\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Star className={`h-3 w-3 ${getPerformanceTierColor(supplier.performance_tier)}`} />\r\n                              <span className={`text-sm font-medium ${getPerformanceTierColor(supplier.performance_tier)}`}>\r\n                                {supplier.performance_tier.toUpperCase()}\r\n                              </span>\r\n                            </div>\r\n                            {supplier.quality_rating && (\r\n                              <div className=\"text-xs text-muted-foreground\">\r\n                                Quality: {supplier.quality_rating.toFixed(1)}/5\r\n                              </div>\r\n                            )}\r\n                            {supplier.delivery_performance_score && (\r\n                              <div className=\"text-xs text-muted-foreground\">\r\n                                Delivery: {supplier.delivery_performance_score.toFixed(1)}%\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div>\r\n                            <p className=\"font-medium\">\r\n                              {formatCurrency(supplier.spend_last_12_months)}\r\n                            </p>\r\n                            {supplier.bee_level && (\r\n                              <p className=\"text-xs text-muted-foreground\">\r\n                                BEE: {supplier.bee_level}\r\n                              </p>\r\n                            )}\r\n                          </div>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <div className=\"flex items-center gap-1 text-sm\">\r\n                            <MapPin className=\"h-3 w-3 text-muted-foreground\" />\r\n                            <span>{supplier.geographic_region || 'Not specified'}</span>\r\n                          </div>\r\n                          {supplier.rural_based && (\r\n                            <Badge variant=\"outline\" className=\"text-xs mt-1\">\r\n                              Rural\r\n                            </Badge>\r\n                          )}\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          <Badge variant={getStatusBadgeVariant(supplier.status)}>\r\n                            {supplier.status.replace('_', ' ').toUpperCase()}\r\n                          </Badge>\r\n                        </TableCell>\r\n                        <TableCell className=\"text-center\">\r\n                          <DropdownMenu>\r\n                            <DropdownMenuTrigger asChild>\r\n                              <Button variant=\"ghost\" size=\"sm\">\r\n                                <MoreHorizontal className=\"h-4 w-4\" />\r\n                              </Button>\r\n                            </DropdownMenuTrigger>\r\n                            <DropdownMenuContent align=\"end\">\r\n                              <DropdownMenuItem\r\n                                onClick={() => setViewingSupplier(supplier)}\r\n                              >\r\n                                <Eye className=\"h-4 w-4 mr-2\" />\r\n                                View Details\r\n                              </DropdownMenuItem>\r\n                              <DropdownMenuItem\r\n                                onClick={() => setEditingSupplier(supplier)}\r\n                              >\r\n                                <Edit className=\"h-4 w-4 mr-2\" />\r\n                                Edit Supplier\r\n                              </DropdownMenuItem>\r\n                              <DropdownMenuItem\r\n                                onClick={() => handleDeleteSupplier(supplier.id)}\r\n                                className=\"text-red-600\"\r\n                              >\r\n                                <Trash2 className=\"h-4 w-4 mr-2\" />\r\n                                Delete Supplier\r\n                              </DropdownMenuItem>\r\n                            </DropdownMenuContent>\r\n                          </DropdownMenu>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))}\r\n                  </TableBody>\r\n                </Table>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Add/Edit/View Dialogs would go here */}\r\n        {/* For brevity, not implementing the full dialogs in this response */}\r\n      </div>\r\n    </TooltipProvider>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\UnifiedSupplierDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'confirm' is not defined.","line":609,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":609,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":631,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":631,"endColumn":12}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\n\"use client\"\n\nimport React, { useState, useMemo, useCallback, useEffect } from \"react\"\nimport { useRouter } from \"next/navigation\"\nimport AppLayout from '@/components/layout/AppLayout'\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Input } from \"@/components/ui/input\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { Progress } from \"@/components/ui/progress\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\nimport { Separator } from \"@/components/ui/separator\"\nimport { Alert, AlertDescription } from \"@/components/ui/alert\"\nimport { Checkbox } from \"@/components/ui/checkbox\"\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\"\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\"\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\nimport { useSuppliers } from \"@/hooks/useSuppliers\"\nimport { useSupplierMutations } from \"@/hooks/useRealTimeDataFixed\"\nimport { cn, formatCurrency, formatDate, formatPercentage, getStatusColor, getTierColor } from \"@/lib/utils\"\nimport { getDisplayUrl } from \"@/lib/utils/url-validation\"\nimport { SafeLink } from \"@/components/ui/SafeLink\"\nimport SupplierPricelistUpload from \"./SupplierPricelistUpload\"\nimport SupplierQuickActions from \"./SupplierQuickActions\"\nimport {\n  Building2,\n  TrendingUp,\n  TrendingDown,\n  AlertTriangle,\n  CheckCircle,\n  Clock,\n  Users,\n  Package,\n  DollarSign,\n  Phone,\n  Mail,\n  FileText,\n  Star,\n  BarChart3,\n  Activity,\n  Calendar,\n  Globe,\n  MapPin,\n  Settings,\n  Eye,\n  Edit,\n  Download,\n  Upload,\n  RefreshCw,\n  Search,\n  Filter,\n  Plus,\n  MoreHorizontal,\n  History,\n  ShoppingCart,\n  Target,\n  Award,\n  Zap,\n  X,\n  Trash2,\n  SlidersHorizontal,\n  ArrowUpDown,\n  ChevronLeft,\n  ChevronRight,\n  ExternalLink,\n  Loader2\n} from \"lucide-react\"\n\n// Types\ninterface SupplierMetrics {\n  totalSuppliers: number\n  activeSuppliers: number\n  totalSpend: number\n  avgRating: number\n  avgOnTimeDelivery: number\n  riskDistribution: {\n    low: number\n    medium: number\n    high: number\n    critical: number\n  }\n}\n\ninterface SupplierData {\n  id: string\n  code: string\n  name: string\n  legalName: string\n  status: 'active' | 'inactive' | 'pending' | 'suspended'\n  tier: 'strategic' | 'preferred' | 'approved' | 'conditional'\n  category: string\n  subcategory?: string\n  website?: string\n  rating: number\n  onTimeDelivery: number\n  totalSpend: number\n  riskLevel: 'low' | 'medium' | 'high' | 'critical'\n  lastContact: Date | null\n  primaryContact: {\n    name: string\n    email: string\n    phone: string\n    role: string\n  }\n  address: {\n    city: string\n    country: string\n    full: string\n  }\n  tags: string[]\n  createdAt: Date\n  updatedAt: Date\n}\n\n// Transformation function to convert DatabaseSupplier to SupplierData\nfunction transformDatabaseSupplierToSupplierData(dbSupplier: any): SupplierData {\n  // Generate a risk level based on performance tier\n  const getRiskLevel = (performanceTier: string): 'low' | 'medium' | 'high' | 'critical' => {\n    switch (performanceTier) {\n      case 'tier_1': return 'low'\n      case 'tier_2': return 'low'\n      case 'tier_3': return 'medium'\n      case 'unrated':\n      default: return 'high'\n    }\n  }\n\n  // Parse address or use defaults\n  const parseAddress = (address: string | null) => {\n    if (!address) {\n      return {\n        city: 'Unknown',\n        country: 'South Africa',\n        full: 'Address not provided'\n      }\n    }\n    // Simple parsing - could be enhanced\n    return {\n      city: 'Various',\n      country: 'South Africa',\n      full: address\n    }\n  }\n\n  const rawStatus = dbSupplier.status\n  const normalizedStatus =\n    typeof rawStatus === 'string'\n      ? rawStatus.toLowerCase()\n      : rawStatus\n        ? 'active'\n        : 'inactive'\n  const status: SupplierData['status'] =\n    normalizedStatus === 'active' ||\n    normalizedStatus === 'inactive' ||\n    normalizedStatus === 'pending' ||\n    normalizedStatus === 'suspended'\n      ? normalizedStatus\n      : 'inactive'\n\n  return {\n    id: dbSupplier.id,\n    code: dbSupplier.supplier_code || 'N/A',\n    name: dbSupplier.name,\n    companyName: dbSupplier.company_name || dbSupplier.name,\n    status,\n    tier: dbSupplier.performance_tier === 'tier_1' ? 'strategic' :\n          dbSupplier.performance_tier === 'tier_2' ? 'preferred' :\n          dbSupplier.performance_tier === 'tier_3' ? 'approved' : 'conditional',\n    category: dbSupplier.primary_category || 'General',\n    subcategory: undefined,\n    website: dbSupplier.website || undefined,\n    rating: parseFloat(dbSupplier.rating) || 0,\n    onTimeDelivery: 85, // Default value - could be calculated\n    totalSpend: parseFloat(dbSupplier.spend_last_12_months) || 0,\n    riskLevel: getRiskLevel(dbSupplier.performance_tier),\n    lastContact: null, // Not available in DB\n    primaryContact: {\n      name: dbSupplier.contact_person || 'Unknown',\n      email: dbSupplier.email || '',\n      phone: dbSupplier.phone || '',\n      role: 'Primary Contact'\n    },\n    address: parseAddress(dbSupplier.address),\n    tags: [],\n    createdAt: new Date(dbSupplier.created_at),\n    updatedAt: new Date(dbSupplier.updated_at)\n  }\n}\n\n// Sample data with South African suppliers\nconst sampleSuppliers: SupplierData[] = [\n  {\n    id: \"SUP-001\",\n    code: \"BKPRC\",\n    name: \"BK Percussion\",\n    legalName: \"BK Percussion (Pty) Ltd\",\n    status: \"active\",\n    tier: \"strategic\",\n    category: \"Musical Instruments\",\n    subcategory: \"Percussion\",\n    website: \"https://www.bkpercussion.co.za\",\n    rating: 4.7,\n    onTimeDelivery: 94,\n    totalSpend: 2850000,\n    riskLevel: \"low\",\n    lastContact: new Date(\"2024-09-20\"),\n    primaryContact: {\n      name: \"Sarah Mitchell\",\n      email: \"sarah@bkpercussion.co.za\",\n      phone: \"+27 11 234 5678\",\n      role: \"Sales Manager\"\n    },\n    address: {\n      city: \"Johannesburg\",\n      country: \"South Africa\",\n      full: \"123 Music Street, Johannesburg, Gauteng 2000\"\n    },\n    tags: [\"percussion\", \"drums\", \"premium\", \"professional\"],\n    createdAt: new Date(\"2023-01-15\"),\n    updatedAt: new Date(\"2024-09-20\")\n  },\n  {\n    id: \"SUP-002\",\n    code: \"BCELEC\",\n    name: \"BC Electronics\",\n    legalName: \"BC Electronics (Pty) Ltd\",\n    status: \"active\",\n    tier: \"preferred\",\n    category: \"Electronics\",\n    subcategory: \"Audio Equipment\",\n    website: \"https://www.bcelectronics.co.za\",\n    rating: 4.5,\n    onTimeDelivery: 92,\n    totalSpend: 1890000,\n    riskLevel: \"low\",\n    lastContact: new Date(\"2024-09-18\"),\n    primaryContact: {\n      name: \"David Chen\",\n      email: \"david@bcelectronics.co.za\",\n      phone: \"+27 21 345 6789\",\n      role: \"Technical Director\"\n    },\n    address: {\n      city: \"Cape Town\",\n      country: \"South Africa\",\n      full: \"456 Tech Avenue, Cape Town, Western Cape 8001\"\n    },\n    tags: [\"electronics\", \"audio\", \"professional\", \"broadcast\"],\n    createdAt: new Date(\"2023-02-01\"),\n    updatedAt: new Date(\"2024-09-18\")\n  },\n  {\n    id: \"SUP-003\",\n    code: \"LEGACY\",\n    name: \"Legacy Brands\",\n    legalName: \"Legacy Brands (Pty) Ltd\",\n    status: \"active\",\n    tier: \"approved\",\n    category: \"Musical Instruments\",\n    subcategory: \"Guitars & Amplifiers\",\n    website: \"https://www.legacybrands.co.za\",\n    rating: 4.3,\n    onTimeDelivery: 89,\n    totalSpend: 1250000,\n    riskLevel: \"medium\",\n    lastContact: new Date(\"2024-09-15\"),\n    primaryContact: {\n      name: \"Mike Rodriguez\",\n      email: \"mike@legacybrands.co.za\",\n      phone: \"+27 31 456 7890\",\n      role: \"Sales Director\"\n    },\n    address: {\n      city: \"Durban\",\n      country: \"South Africa\",\n      full: \"789 Guitar Lane, Durban, KwaZulu-Natal 4000\"\n    },\n    tags: [\"guitars\", \"amplifiers\", \"vintage\", \"classic\"],\n    createdAt: new Date(\"2023-03-01\"),\n    updatedAt: new Date(\"2024-09-15\")\n  }\n]\n\n// Export functionality\nconst handleExportSuppliers = async (suppliers: SupplierData[], format: 'csv' | 'xlsx' | 'pdf') => {\n  try {\n    // Simulate export processing\n    await new Promise(resolve => setTimeout(resolve, 1000))\n\n    const data = suppliers.map(supplier => ({\n      Code: supplier.code,\n      Name: supplier.name,\n      'Legal Name': supplier.legalName,\n      Status: supplier.status,\n      Tier: supplier.tier,\n      Category: supplier.category,\n      Rating: supplier.rating,\n      'On-Time Delivery %': supplier.onTimeDelivery,\n      'Total Spend': supplier.totalSpend,\n      'Risk Level': supplier.riskLevel,\n      'Primary Contact': supplier.primaryContact.name,\n      'Contact Email': supplier.primaryContact.email,\n      'Contact Phone': supplier.primaryContact.phone,\n      Location: supplier.address.full,\n      Website: supplier.website || '',\n      'Last Contact': supplier.lastContact ? formatDate(supplier.lastContact) : 'Never',\n      Created: formatDate(supplier.createdAt),\n      Updated: formatDate(supplier.updatedAt)\n    }))\n\n    // Convert to CSV format\n    if (format === 'csv') {\n      const headers = Object.keys(data[0])\n      const csvContent = [\n        headers.join(','),\n        ...data.map(row => headers.map(header => `\"${row[header as keyof typeof row]}\"`).join(','))\n      ].join('\\n')\n\n      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })\n      const link = document.createElement('a')\n      const url = URL.createObjectURL(blob)\n      link.setAttribute('href', url)\n      link.setAttribute('download', `suppliers_export_${new Date().toISOString().split('T')[0]}.csv`)\n      link.style.visibility = 'hidden'\n      document.body.appendChild(link)\n      link.click()\n      document.body.removeChild(link)\n    }\n\n    return true\n  } catch (error) {\n    console.error('Export failed:', error)\n    throw new Error('Export failed. Please try again.')\n  }\n}\n\n// Main Component\ninterface UnifiedSupplierDashboardProps {\n  initialTab?: string\n}\n\nconst UnifiedSupplierDashboard: React.FC<UnifiedSupplierDashboardProps> = ({\n  initialTab = \"overview\"\n}) => {\n  const router = useRouter()\n  const { suppliers: apiSuppliers, loading: suppliersLoading, error: suppliersError, fetchSuppliers, refresh, deleteSupplier: deleteSupplierHook } = useSuppliers()\n  const { deleteSupplier: deleteSupplierMutation } = useSupplierMutations()\n\n  // Refetch suppliers when component mounts or when refresh param is present\n  useEffect(() => {\n    // Check if there's a refresh param in the URL\n    const urlParams = new URLSearchParams(window.location.search)\n    if (urlParams.has('refresh')) {\n      // Remove the refresh param and refetch\n      const newUrl = window.location.pathname\n      window.history.replaceState({}, '', newUrl)\n      refresh()\n    }\n  }, [refresh])\n\n  // Fetch supplier activities\n  useEffect(() => {\n    const fetchActivities = async () => {\n      try {\n        setActivitiesLoading(true)\n        const response = await fetch('/api/activities/recent?limit=20')\n        if (response.ok) {\n          const result = await response.json()\n          if (result.success && result.data) {\n            // Filter for supplier-related activities\n            const supplierRelated = result.data.filter((activity: any) => \n              activity.entityType === 'supplier' || \n              activity.type?.includes('supplier') ||\n              activity.metadata?.category === 'supplier_management'\n            )\n            setSupplierActivities(supplierRelated.slice(0, 15))\n          }\n        }\n      } catch (error) {\n        console.error('Failed to fetch activities:', error)\n      } finally {\n        setActivitiesLoading(false)\n      }\n    }\n    fetchActivities()\n  }, [])\n\n  // Convert API suppliers to component format\n  const suppliers = useMemo(() => {\n    return apiSuppliers.map((supplier: any) => transformDatabaseSupplierToSupplierData(supplier))\n  }, [apiSuppliers])\n\n  // Legacy code (remove after confirming new transformation works)\n  const legacyTransform = useMemo(() => {\n    return apiSuppliers.map((supplier: any) => ({\n      website: supplier.website || '',\n      contactInfo: {\n        primaryContact: {\n          name: supplier.contact_person || '',\n          title: '',\n          email: supplier.email || '',\n          phone: supplier.phone || '',\n          department: ''\n        },\n        address: {\n          street: supplier.address || '',\n          city: '',\n          state: '',\n          postalCode: '',\n          country: 'South Africa'\n        }\n      },\n      businessInfo: {\n        taxId: supplier.tax_id || '',\n        registrationNumber: '',\n        foundedYear: 0,\n        employeeCount: 0,\n        annualRevenue: 0,\n        currency: 'ZAR'\n      },\n      capabilities: {\n        products: [],\n        services: [],\n        certifications: [],\n        leadTime: 30,\n        minimumOrderValue: 0,\n        paymentTerms: supplier.payment_terms || 'Net 30'\n      },\n      performance: {\n        overallRating: parseFloat(supplier.rating) || 0,\n        qualityRating: 0,\n        deliveryRating: 0,\n        serviceRating: 0,\n        priceRating: 0,\n        onTimeDeliveryRate: 0.9,\n        qualityAcceptanceRate: 0.95,\n        responseTime: 24\n      },\n      financial: {\n        creditRating: 'Good',\n        creditLimit: 0,\n        totalPurchaseValue: parseFloat(supplier.spend_last_12_months) || 0,\n        paymentHistory: 'Good',\n        riskScore: supplier.performance_tier === 'tier_1' ? 20 :\n                  supplier.performance_tier === 'tier_2' ? 35 : 60\n      },\n      contractInfo: {\n        hasActiveContract: false,\n        contractExpiry: new Date(),\n        preferredSupplier: supplier.preferred_supplier || false\n      },\n      tags: [],\n      createdAt: new Date(supplier.created_at),\n      updatedAt: new Date(supplier.updated_at)\n    }))\n  }, [apiSuppliers])\n\n  const [selectedSupplier, setSelectedSupplier] = useState<SupplierData | null>(null)\n  const [selectedSuppliers, setSelectedSuppliers] = useState<string[]>([])\n  const [searchQuery, setSearchQuery] = useState(\"\")\n  const [activeTab, setActiveTab] = useState(initialTab)\n  const [showFilters, setShowFilters] = useState(false)\n  const [isExporting, setIsExporting] = useState(false)\n  const [showPricelistUpload, setShowPricelistUpload] = useState(false)\n  const [supplierActivities, setSupplierActivities] = useState<any[]>([])\n  const [activitiesLoading, setActivitiesLoading] = useState(true)\n\n  // Filters\n  const [statusFilter, setStatusFilter] = useState<string>(\"\")\n  const [tierFilter, setTierFilter] = useState<string>(\"\")\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"\")\n  const [riskFilter, setRiskFilter] = useState<string>(\"\")\n\n  // Calculate dashboard metrics\n  const dashboardMetrics = useMemo((): SupplierMetrics => {\n    const activeSuppliers = suppliers.filter(s => s.status === 'active').length\n    const totalSpend = suppliers.reduce((sum, s) => sum + s.totalSpend, 0)\n    const avgRating = suppliers.length > 0\n      ? suppliers.reduce((sum, s) => sum + s.rating, 0) / suppliers.length\n      : 0\n    const avgOnTimeDelivery = suppliers.length > 0\n      ? suppliers.reduce((sum, s) => sum + s.onTimeDelivery, 0) / suppliers.length\n      : 0\n\n    return {\n      totalSuppliers: suppliers.length,\n      activeSuppliers,\n      totalSpend,\n      avgRating,\n      avgOnTimeDelivery,\n      riskDistribution: {\n        low: suppliers.filter(s => s.riskLevel === 'low').length,\n        medium: suppliers.filter(s => s.riskLevel === 'medium').length,\n        high: suppliers.filter(s => s.riskLevel === 'high').length,\n        critical: suppliers.filter(s => s.riskLevel === 'critical').length\n      }\n    }\n  }, [suppliers])\n\n  // Filter suppliers\n  const filteredSuppliers = useMemo(() => {\n    return suppliers.filter(supplier => {\n      // Search filter\n      if (searchQuery) {\n        const query = searchQuery.toLowerCase()\n        const matchesSearch =\n          supplier.name.toLowerCase().includes(query) ||\n          supplier.code.toLowerCase().includes(query) ||\n          supplier.category.toLowerCase().includes(query) ||\n          supplier.tags.some(tag => tag.toLowerCase().includes(query))\n\n        if (!matchesSearch) return false\n      }\n\n      // Status filter\n      if (statusFilter && statusFilter !== 'all' && supplier.status !== statusFilter) {\n        return false\n      }\n\n      // Tier filter\n      if (tierFilter && tierFilter !== 'all' && supplier.tier !== tierFilter) {\n        return false\n      }\n\n      // Category filter\n      if (categoryFilter && categoryFilter !== 'all' && supplier.category !== categoryFilter) {\n        return false\n      }\n\n      // Risk filter\n      if (riskFilter && riskFilter !== 'all' && supplier.riskLevel !== riskFilter) {\n        return false\n      }\n\n      return true\n    })\n  }, [suppliers, searchQuery, statusFilter, tierFilter, categoryFilter, riskFilter])\n\n  // Handle export\n  const handleExport = async (format: 'csv' | 'xlsx' | 'pdf') => {\n    setIsExporting(true)\n    try {\n      const suppliersToExport = selectedSuppliers.length > 0\n        ? suppliers.filter(s => selectedSuppliers.includes(s.id))\n        : filteredSuppliers\n\n      await handleExportSuppliers(suppliersToExport, format)\n    } catch (error) {\n      console.error('Export failed:', error)\n    } finally {\n      setIsExporting(false)\n    }\n  }\n\n  // Clear filters\n  const clearFilters = () => {\n    setSearchQuery(\"\")\n    setStatusFilter(\"\")\n    setTierFilter(\"\")\n    setCategoryFilter(\"\")\n    setRiskFilter(\"\")\n  }\n\n  // Navigation helpers\n  const navigateToNewSupplier = () => {\n    router.push('/suppliers/new')\n  }\n\n  const navigateToEditSupplier = (supplierId: string) => {\n    router.push(`/suppliers/${supplierId}/edit`)\n  }\n\n  const handleDeleteSupplier = async (supplierId: string, supplierName: string) => {\n    if (!confirm(`Are you sure you want to delete \"${supplierName}\"? This action cannot be undone.`)) {\n      return\n    }\n\n    try {\n      // Use the deleteSupplier from useSuppliers hook to ensure local state is updated\n      await deleteSupplierHook(supplierId)\n\n      // Also update React Query cache for consistency\n      if (deleteSupplierMutation) {\n        try {\n          await deleteSupplierMutation.mutateAsync(supplierId)\n        } catch (e) {\n          // If React Query mutation fails, it's ok since the main deletion succeeded\n          console.log('React Query cache update skipped:', e)\n        }\n      }\n\n      // Success notification could be added here if needed\n      console.log(`✅ Supplier \"${supplierName}\" deleted successfully`)\n    } catch (error) {\n      console.error('Failed to delete supplier:', error)\n      alert(error instanceof Error ? error.message : 'Failed to delete supplier')\n    }\n  }\n\n  // Utility functions\n\n  const getRiskColor = (risk: string) => {\n    const colors = {\n      low: \"text-green-600\",\n      medium: \"text-yellow-600\",\n      high: \"text-orange-600\",\n      critical: \"text-red-600\"\n    }\n    return colors[risk as keyof typeof colors] || colors.low\n  }\n\n  // Handle loading and error states\n  if (suppliersLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto\"></div>\n          <p className=\"mt-2 text-sm text-muted-foreground\">Loading suppliers...</p>\n        </div>\n      </div>\n    )\n  }\n\n  if (suppliersError) {\n    return (\n      <Alert className=\"max-w-md mx-auto\">\n        <AlertTriangle className=\"h-4 w-4\" />\n        <AlertDescription>\n          Error loading suppliers: {suppliersError}\n        </AlertDescription>\n      </Alert>\n    )\n  }\n\n  // Debug: show raw data\n  if (apiSuppliers && apiSuppliers.length === 0) {\n    return (\n      <div className=\"p-4\">\n        <h2 className=\"text-xl font-bold mb-4\">Debug Info</h2>\n        <p>API Suppliers Length: {apiSuppliers.length}</p>\n        <p>Loading: {suppliersLoading ? 'Yes' : 'No'}</p>\n        <p>Error: {suppliersError || 'None'}</p>\n        <pre className=\"bg-gray-100 p-4 mt-4 text-sm\">\n          {JSON.stringify(apiSuppliers, null, 2)}\n        </pre>\n      </div>\n    )\n  }\n\n  const breadcrumbs = [\n    { label: \"Supplier Management\" }\n  ]\n\n  return (\n    <AppLayout\n      title=\"Suppliers\"\n      breadcrumbs={breadcrumbs}\n    >\n      <TooltipProvider>\n        <div className=\"flex flex-col lg:flex-row gap-6 relative z-0\">\n          {/* Main Content */}\n          <div className=\"flex-1 space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4\">\n          <div>\n            <h1 className=\"text-3xl font-bold tracking-tight\">Supplier Management</h1>\n            <p className=\"text-muted-foreground mt-1\">\n              Comprehensive supplier relationship and performance management\n            </p>\n          </div>\n\n          {/* Action Buttons */}\n          <div className=\"flex flex-wrap items-center gap-2\">\n            <Button\n              onClick={navigateToNewSupplier}\n              size=\"sm\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Supplier\n            </Button>\n          </div>\n        </div>\n\n        {/* Metrics Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          <Card className=\"bg-card border border-border\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Suppliers</p>\n                  <p className=\"text-3xl font-bold tracking-tight mt-1\">\n                    {dashboardMetrics.totalSuppliers}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {dashboardMetrics.activeSuppliers} active\n                  </p>\n                </div>\n                <div className=\"p-3 rounded-lg bg-muted\">\n                  <Building2 className=\"h-6 w-6 text-muted-foreground\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-card border border-border\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Spend</p>\n                  <p className=\"text-3xl font-bold tracking-tight mt-1\">\n                    {formatCurrency(dashboardMetrics.totalSpend)}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Avg: {formatCurrency(dashboardMetrics.totalSpend / dashboardMetrics.totalSuppliers)}\n                  </p>\n                </div>\n                <div className=\"p-3 rounded-lg bg-muted\">\n                  <DollarSign className=\"h-6 w-6 text-muted-foreground\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-card border border-border\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">On-Time Delivery</p>\n                  <p className=\"text-3xl font-bold tracking-tight mt-1\">\n                    {dashboardMetrics.avgOnTimeDelivery.toFixed(1)}%\n                  </p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Industry avg: 85%\n                  </p>\n                </div>\n                <div className=\"p-3 rounded-lg bg-muted\">\n                  <Clock className=\"h-6 w-6 text-muted-foreground\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-card border border-border\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Avg Rating</p>\n                  <p className=\"text-3xl font-bold tracking-tight mt-1\">\n                    {dashboardMetrics.avgRating.toFixed(1)}/5\n                  </p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {dashboardMetrics.riskDistribution.low} low risk\n                  </p>\n                </div>\n                <div className=\"p-3 rounded-lg bg-muted\">\n                  <Star className=\"h-6 w-6 text-muted-foreground\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Main Content Tabs */}\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"relative\">\n          <TabsList className=\"grid w-full grid-cols-4\">\n            <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n            <TabsTrigger value=\"directory\">Directory</TabsTrigger>\n            <TabsTrigger value=\"performance\">Performance</TabsTrigger>\n            <TabsTrigger value=\"analytics\">Analytics</TabsTrigger>\n          </TabsList>\n\n          {/* Overview Tab */}\n          <TabsContent value=\"overview\" className=\"space-y-6 mt-6\">\n            {/* Supplier Management Activity */}\n            <Card className=\"bg-card border border-border\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Activity className=\"h-5 w-5 text-muted-foreground\" />\n                  Supplier Management Activity\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"p-0\">\n                {activitiesLoading ? (\n                  <div className=\"divide-y divide-border\">\n                    {Array.from({ length: 15 }).map((_, i) => (\n                      <div key={i} className=\"flex items-start gap-2 px-4 py-2.5 animate-pulse\">\n                        <div className=\"w-6 h-6 rounded bg-muted shrink-0 mt-0.5\" />\n                        <div className=\"flex-1 space-y-1.5 min-w-0\">\n                          <div className=\"h-3.5 bg-muted rounded w-3/4\" />\n                          <div className=\"h-3 bg-muted rounded w-full\" />\n                          <div className=\"h-2.5 bg-muted rounded w-1/4\" />\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : supplierActivities.length > 0 ? (\n                  <div className=\"divide-y divide-border max-h-[600px] overflow-y-auto\">\n                    {supplierActivities.map((activity) => {\n                      const getActivityIcon = () => {\n                        if (activity.type?.includes('upload')) return Upload\n                        if (activity.type?.includes('update')) return RefreshCw\n                        if (activity.type?.includes('order')) return ShoppingCart\n                        if (activity.type?.includes('added')) return Building2\n                        if (activity.type?.includes('price')) return DollarSign\n                        if (activity.type?.includes('inventory')) return Package\n                        return Activity\n                      }\n                      const getActivityColor = () => {\n                        if (activity.type?.includes('upload')) return 'text-green-600 bg-green-50 border-green-200'\n                        if (activity.type?.includes('update')) return 'text-blue-600 bg-blue-50 border-blue-200'\n                        if (activity.type?.includes('order')) return 'text-purple-600 bg-purple-50 border-purple-200'\n                        if (activity.type?.includes('added')) return 'text-emerald-600 bg-emerald-50 border-emerald-200'\n                        if (activity.type?.includes('price')) return 'text-amber-600 bg-amber-50 border-amber-200'\n                        if (activity.type?.includes('inventory')) return 'text-indigo-600 bg-indigo-50 border-indigo-200'\n                        return 'text-muted-foreground bg-muted border-border'\n                      }\n                      const Icon = getActivityIcon()\n                      const formatTime = (timestamp: string) => {\n                        const date = new Date(timestamp)\n                        const now = new Date()\n                        const diffMs = now.getTime() - date.getTime()\n                        const diffMins = Math.floor(diffMs / 60000)\n                        const diffHours = Math.floor(diffMins / 60)\n                        const diffDays = Math.floor(diffHours / 24)\n                        if (diffDays > 0) return `${diffDays}d ago`\n                        if (diffHours > 0) return `${diffHours}h ago`\n                        if (diffMins > 0) return `${diffMins}m ago`\n                        return 'Just now'\n                      }\n                      const getActivityDetails = () => {\n                        const details: string[] = []\n                        if (activity.entityName) {\n                          details.push(activity.entityName)\n                        }\n                        if (activity.metadata?.source) {\n                          details.push(`via ${activity.metadata.source}`)\n                        }\n                        if (activity.priority && activity.priority !== 'low') {\n                          details.push(`${activity.priority} priority`)\n                        }\n                        return details.length > 0 ? details.join(' • ') : null\n                      }\n                      return (\n                        <div\n                          key={activity.id}\n                          className=\"flex items-start gap-2 px-4 py-2.5 hover:bg-muted/30 transition-colors\"\n                        >\n                          <div className={cn(\n                            \"flex items-center justify-center w-6 h-6 rounded shrink-0 mt-0.5\",\n                            getActivityColor()\n                          )}>\n                            <Icon className=\"h-3.5 w-3.5\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm font-medium text-foreground leading-tight\">\n                              {activity.title || activity.description}\n                            </p>\n                            {activity.description && activity.title && (\n                              <p className=\"text-xs text-muted-foreground mt-0.5 leading-relaxed line-clamp-2\">\n                                {activity.description}\n                              </p>\n                            )}\n                            <div className=\"flex items-center gap-2 mt-1\">\n                              <span className=\"text-xs text-muted-foreground\">\n                                {formatTime(activity.timestamp)}\n                              </span>\n                              {getActivityDetails() && (\n                                <>\n                                  <span className=\"text-xs text-muted-foreground\">•</span>\n                                  <span className=\"text-xs text-muted-foreground\">\n                                    {getActivityDetails()}\n                                  </span>\n                                </>\n                              )}\n                              {activity.status && activity.status !== 'completed' && (\n                                <>\n                                  <span className=\"text-xs text-muted-foreground\">•</span>\n                                  <Badge variant=\"outline\" className=\"h-4 px-1.5 text-xs\">\n                                    {activity.status}\n                                  </Badge>\n                                </>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                      )\n                    })}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <Activity className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n                    <p className=\"text-sm\">No recent activities</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Risk Distribution */}\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              <Card className=\"bg-card border border-border\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Target className=\"h-5 w-5 text-muted-foreground\" />\n                    Risk Distribution\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    {Object.entries(dashboardMetrics.riskDistribution).map(([level, count]) => (\n                      <div key={level} className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className={cn(\"w-3 h-3 rounded-full\", {\n                            \"bg-green-500\": level === \"low\",\n                            \"bg-yellow-500\": level === \"medium\",\n                            \"bg-orange-500\": level === \"high\",\n                            \"bg-red-500\": level === \"critical\"\n                          })} />\n                          <span className=\"text-sm capitalize\">{level} Risk</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"font-medium\">{count}</span>\n                          <span className=\"text-xs text-muted-foreground\">\n                            ({((count / dashboardMetrics.totalSuppliers) * 100).toFixed(0)}%)\n                          </span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-card border border-border\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <TrendingUp className=\"h-5 w-5 text-muted-foreground\" />\n                    Performance Trends\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    <div>\n                      <div className=\"flex justify-between text-sm mb-2\">\n                        <span>Overall Performance</span>\n                        <span>{dashboardMetrics.avgRating.toFixed(1)}/5</span>\n                      </div>\n                      <Progress value={(dashboardMetrics.avgRating / 5) * 100} className=\"h-2\" />\n                    </div>\n\n                    <div>\n                      <div className=\"flex justify-between text-sm mb-2\">\n                        <span>On-Time Delivery</span>\n                        <span>{dashboardMetrics.avgOnTimeDelivery.toFixed(1)}%</span>\n                      </div>\n                      <Progress value={dashboardMetrics.avgOnTimeDelivery} className=\"h-2\" />\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Top Performers */}\n            <Card className=\"bg-card border border-border\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Award className=\"h-5 w-5 text-muted-foreground\" />\n                  Top Performing Suppliers\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {suppliers\n                    .sort((a, b) => b.rating - a.rating)\n                    .slice(0, 3)\n                    .map((supplier, index) => (\n                      <div\n                        key={supplier.id}\n                        className=\"group relative flex items-center justify-between p-4 border rounded-lg transition-colors hover:bg-muted\"\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          <div className={cn(\n                            \"flex items-center justify-center w-10 h-10 rounded-full font-bold bg-muted\",\n                            index === 0 && \"bg-primary text-primary-foreground\",\n                            index === 1 && \"bg-muted\",\n                            index === 2 && \"bg-muted\"\n                          )}>\n                            <span className=\"text-sm\">#{index + 1}</span>\n                          </div>\n                          <div>\n                            <p className=\"font-medium\">{supplier.name}</p>\n                            <p className=\"text-xs text-muted-foreground\">{supplier.category}</p>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-3 relative z-10\">\n                          <Badge variant=\"outline\" className={getTierColor(supplier.tier)}>\n                            {supplier.tier.toUpperCase()}\n                          </Badge>\n                          <div className=\"text-right\">\n                            <div className=\"flex items-center gap-1\">\n                              <Star className=\"h-4 w-4 text-yellow-500 fill-current\" />\n                              <span className=\"font-medium\">{supplier.rating}</span>\n                            </div>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {supplier.onTimeDelivery}% on-time\n                            </p>\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                </div>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* Directory Tab */}\n          <TabsContent value=\"directory\" className=\"space-y-6\">\n            {/* Search and Filters */}\n            <Card className=\"bg-card border border-border\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex flex-col lg:flex-row gap-4\">\n                  <div className=\"flex-1\">\n                    <div className=\"relative\">\n                      <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                      <Input\n                        placeholder=\"Search suppliers by name, code, category, or tags...\"\n                        value={searchQuery}\n                        onChange={(e) => setSearchQuery(e.target.value)}\n                        className=\"pl-10\"\n                      />\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setShowFilters(!showFilters)}\n                    >\n                      <SlidersHorizontal className=\"h-4 w-4 mr-2\" />\n                      Filters\n                      {(statusFilter || tierFilter || categoryFilter || riskFilter) && (\n                        <Badge variant=\"secondary\" className=\"ml-2\">\n                          Active\n                        </Badge>\n                      )}\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={clearFilters}>\n                      <X className=\"h-4 w-4 mr-2\" />\n                      Clear\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\">\n                      <RefreshCw className=\"h-4 w-4 mr-2\" />\n                      Refresh\n                    </Button>\n                  </div>\n                </div>\n\n                {/* Advanced Filters */}\n                {showFilters && (\n                  <div className=\"mt-4 p-4 bg-muted/50 rounded-lg space-y-4\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                      <div>\n                        <label className=\"text-sm font-medium mb-2 block\">Status</label>\n                        <Select value={statusFilter} onValueChange={setStatusFilter}>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"All statuses\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"all\">All Statuses</SelectItem>\n                            <SelectItem value=\"active\">Active</SelectItem>\n                            <SelectItem value=\"inactive\">Inactive</SelectItem>\n                            <SelectItem value=\"pending\">Pending</SelectItem>\n                            <SelectItem value=\"suspended\">Suspended</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium mb-2 block\">Tier</label>\n                        <Select value={tierFilter} onValueChange={setTierFilter}>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"All tiers\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"all\">All Tiers</SelectItem>\n                            <SelectItem value=\"strategic\">Strategic</SelectItem>\n                            <SelectItem value=\"preferred\">Preferred</SelectItem>\n                            <SelectItem value=\"approved\">Approved</SelectItem>\n                            <SelectItem value=\"conditional\">Conditional</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium mb-2 block\">Category</label>\n                        <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"All categories\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"all\">All Categories</SelectItem>\n                            <SelectItem value=\"Musical Instruments\">Musical Instruments</SelectItem>\n                            <SelectItem value=\"Electronics\">Electronics</SelectItem>\n                            <SelectItem value=\"Technology\">Technology</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium mb-2 block\">Risk Level</label>\n                        <Select value={riskFilter} onValueChange={setRiskFilter}>\n                          <SelectTrigger>\n                            <SelectValue placeholder=\"All levels\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"all\">All Levels</SelectItem>\n                            <SelectItem value=\"low\">Low Risk</SelectItem>\n                            <SelectItem value=\"medium\">Medium Risk</SelectItem>\n                            <SelectItem value=\"high\">High Risk</SelectItem>\n                            <SelectItem value=\"critical\">Critical Risk</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Results Summary */}\n            <div className=\"flex items-center justify-between\">\n              <p className=\"text-sm text-muted-foreground\">\n                Showing {filteredSuppliers.length} of {suppliers.length} suppliers\n              </p>\n              {selectedSuppliers.length > 0 && (\n                <div className=\"flex items-center gap-2\">\n                  <Badge variant=\"secondary\">\n                    {selectedSuppliers.length} selected\n                  </Badge>\n                  <Button variant=\"outline\" size=\"sm\" onClick={() => handleExport('csv')}>\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Export Selected\n                  </Button>\n                </div>\n              )}\n            </div>\n\n            {/* Suppliers Table */}\n            <Card className=\"bg-card border border-border overflow-hidden\">\n              <CardContent className=\"p-0\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead className=\"w-12\">\n                        <Checkbox\n                          checked={selectedSuppliers.length === filteredSuppliers.length && filteredSuppliers.length > 0}\n                          onCheckedChange={(checked) => {\n                            if (checked) {\n                              setSelectedSuppliers(filteredSuppliers.map(s => s.id))\n                            } else {\n                              setSelectedSuppliers([])\n                            }\n                          }}\n                        />\n                      </TableHead>\n                      <TableHead>Supplier</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Tier</TableHead>\n                      <TableHead>Performance</TableHead>\n                      <TableHead>Spend</TableHead>\n                      <TableHead>Location</TableHead>\n                      <TableHead>Risk</TableHead>\n                      <TableHead className=\"text-center\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {filteredSuppliers.map((supplier) => (\n                      <TableRow key={supplier.id}>\n                        <TableCell>\n                          <Checkbox\n                            checked={selectedSuppliers.includes(supplier.id)}\n                            onCheckedChange={(checked) => {\n                              if (checked) {\n                                setSelectedSuppliers([...selectedSuppliers, supplier.id])\n                              } else {\n                                setSelectedSuppliers(selectedSuppliers.filter(id => id !== supplier.id))\n                              }\n                            }}\n                          />\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"w-10 h-10 bg-primary rounded-full flex items-center justify-center text-primary-foreground font-semibold\">\n                              {supplier.name.charAt(0)}\n                            </div>\n                            <div>\n                              <p className=\"font-medium\">{supplier.name}</p>\n                              <p className=\"text-sm text-muted-foreground\">{supplier.code}</p>\n                            </div>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\" className={getStatusColor(supplier.status)}>\n                            {String(supplier.status ?? 'inactive').toUpperCase()}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\" className={getTierColor(supplier.tier)}>\n                            {supplier.tier.toUpperCase()}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"space-y-1\">\n                            <div className=\"flex items-center gap-1\">\n                              <Star className=\"h-4 w-4 text-yellow-500 fill-current\" />\n                              <span className=\"font-medium\">{supplier.rating}</span>\n                            </div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              {supplier.onTimeDelivery}% on-time\n                            </div>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <p className=\"font-medium\">{formatCurrency(supplier.totalSpend)}</p>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center gap-1 text-sm\">\n                            <MapPin className=\"h-3 w-3 text-muted-foreground\" />\n                            <span>{supplier.address.city}, {supplier.address.country}</span>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <span className={cn(\"font-medium\", getRiskColor(supplier.riskLevel))}>\n                            {supplier.riskLevel.toUpperCase()}\n                          </span>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <DropdownMenu>\n                            <DropdownMenuTrigger asChild>\n                              <Button variant=\"ghost\" size=\"sm\">\n                                <MoreHorizontal className=\"h-4 w-4\" />\n                              </Button>\n                            </DropdownMenuTrigger>\n                            <DropdownMenuContent align=\"end\">\n                              <DropdownMenuItem onClick={() => setSelectedSupplier(supplier)}>\n                                <Eye className=\"h-4 w-4 mr-2\" />\n                                View Details\n                              </DropdownMenuItem>\n                              <DropdownMenuItem onClick={() => navigateToEditSupplier(supplier.id)}>\n                                <Edit className=\"h-4 w-4 mr-2\" />\n                                Edit Supplier\n                              </DropdownMenuItem>\n                              <DropdownMenuSeparator />\n                              <DropdownMenuItem>\n                                <ShoppingCart className=\"h-4 w-4 mr-2\" />\n                                Create Order\n                              </DropdownMenuItem>\n                              <DropdownMenuItem>\n                                <BarChart3 className=\"h-4 w-4 mr-2\" />\n                                Performance Report\n                              </DropdownMenuItem>\n                              <DropdownMenuSeparator />\n                              <DropdownMenuItem\n                                onClick={() => handleDeleteSupplier(supplier.id, supplier.name)}\n                                className=\"text-red-600 focus:text-red-600\"\n                              >\n                                <Trash2 className=\"h-4 w-4 mr-2\" />\n                                Delete Supplier\n                              </DropdownMenuItem>\n                            </DropdownMenuContent>\n                          </DropdownMenu>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          {/* Performance Tab */}\n          <TabsContent value=\"performance\" className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              {filteredSuppliers.slice(0, 4).map((supplier) => (\n                <Card\n                  key={supplier.id}\n                  className=\"bg-card border border-border\"\n                >\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center justify-between\">\n                      <span>\n                        {supplier.name}\n                      </span>\n                      <Badge variant=\"outline\" className={getTierColor(supplier.tier)}>\n                        {supplier.tier.toUpperCase()}\n                      </Badge>\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div className=\"text-center\">\n                          <div className=\"text-2xl font-bold text-green-600\">\n                            {supplier.onTimeDelivery}%\n                          </div>\n                          <div className=\"text-sm text-muted-foreground\">On-Time Delivery</div>\n                        </div>\n                        <div className=\"text-center\">\n                          <div className=\"text-2xl font-bold text-blue-600\">\n                            {supplier.rating}\n                          </div>\n                          <div className=\"text-sm text-muted-foreground\">Overall Rating</div>\n                        </div>\n                      </div>\n\n                      <Separator />\n\n                      <div className=\"space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <span>Performance Score</span>\n                          <span>{supplier.rating}/5</span>\n                        </div>\n                        <Progress value={(supplier.rating / 5) * 100} className=\"h-2\" />\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <span>Delivery Performance</span>\n                          <span>{supplier.onTimeDelivery}%</span>\n                        </div>\n                        <Progress value={supplier.onTimeDelivery} className=\"h-2\" />\n                      </div>\n\n                      <div className=\"flex justify-between items-center text-sm\">\n                        <span>Total Spend:</span>\n                        <span className=\"font-medium\">{formatCurrency(supplier.totalSpend)}</span>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          </TabsContent>\n\n          {/* Analytics Tab */}\n          <TabsContent value=\"analytics\" className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n              <Card className=\"bg-card border border-border\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <DollarSign className=\"h-5 w-5 text-muted-foreground\" />\n                    Spend Analysis\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {suppliers.map((supplier) => (\n                      <div key={supplier.id} className=\"space-y-2\">\n                        <div className=\"flex justify-between text-sm\">\n                          <span>{supplier.name}</span>\n                          <span>{formatCurrency(supplier.totalSpend)}</span>\n                        </div>\n                        <Progress\n                          value={(supplier.totalSpend / dashboardMetrics.totalSpend) * 100}\n                          className=\"h-2\"\n                        />\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card className=\"bg-card border border-border\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <BarChart3 className=\"h-5 w-5 text-muted-foreground\" />\n                    Performance Distribution\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {suppliers.map((supplier) => (\n                      <div key={supplier.id} className=\"flex items-center justify-between\">\n                        <span className=\"text-sm font-medium\">{supplier.name}</span>\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"flex items-center gap-1\">\n                            <Star className=\"h-4 w-4 text-yellow-500 fill-current\" />\n                            <span className=\"font-medium\">{supplier.rating}</span>\n                          </div>\n                          <Badge variant=\"outline\" className={getRiskColor(supplier.riskLevel)}>\n                            {supplier.riskLevel}\n                          </Badge>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          </TabsContent>\n        </Tabs>\n\n        {/* Supplier Detail Modal */}\n        {selectedSupplier && (\n          <Dialog open={!!selectedSupplier} onOpenChange={() => setSelectedSupplier(null)}>\n            <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle className=\"flex items-center justify-between\">\n                  <span>{selectedSupplier.name} - Details</span>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => navigateToEditSupplier(selectedSupplier.id)}\n                  >\n                    <Edit className=\"h-4 w-4 mr-2\" />\n                    Edit\n                  </Button>\n                </DialogTitle>\n                <DialogDescription>\n                  Comprehensive supplier information and performance metrics\n                </DialogDescription>\n              </DialogHeader>\n\n              <div className=\"space-y-6\">\n                {/* Basic Information */}\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div className=\"space-y-4\">\n                    <div>\n                      <h4 className=\"font-medium mb-2\">Contact Information</h4>\n                      <div className=\"space-y-2 text-sm\">\n                        <div className=\"flex items-center gap-2\">\n                          <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                          <span>{selectedSupplier.primaryContact.email}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                          <span>{selectedSupplier.primaryContact.phone}</span>\n                        </div>\n                        {selectedSupplier.website && (\n                          <div className=\"flex items-center gap-2\">\n                            <Globe className=\"h-4 w-4 text-muted-foreground\" />\n                            <SafeLink\n                              href={selectedSupplier.website}\n                              target=\"_blank\"\n                              rel=\"noopener noreferrer\"\n                              className=\"text-blue-600 hover:underline flex items-center gap-1\"\n                            >\n                              {getDisplayUrl(selectedSupplier.website) || selectedSupplier.website}\n                              <ExternalLink className=\"h-3 w-3\" />\n                            </SafeLink>\n                          </div>\n                        )}\n                        <div className=\"flex items-center gap-2\">\n                          <MapPin className=\"h-4 w-4 text-muted-foreground\" />\n                          <span>{selectedSupplier.address.full}</span>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    <div>\n                      <h4 className=\"font-medium mb-2\">Business Details</h4>\n                      <div className=\"space-y-2 text-sm\">\n                        <div>Legal Name: {selectedSupplier.legalName}</div>\n                        <div>Category: {selectedSupplier.category}</div>\n                        {selectedSupplier.subcategory && (\n                          <div>Subcategory: {selectedSupplier.subcategory}</div>\n                        )}\n                        <div>\n                          Risk Level:\n                          <span className={cn(\"ml-1 font-medium\", getRiskColor(selectedSupplier.riskLevel))}>\n                            {selectedSupplier.riskLevel.toUpperCase()}\n                          </span>\n                        </div>\n                        <div>\n                          Last Contact: {selectedSupplier.lastContact\n                            ? formatDate(selectedSupplier.lastContact)\n                            : 'Never'\n                          }\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Performance Metrics */}\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <Card>\n                    <CardContent className=\"p-4 text-center\">\n                      <div className=\"text-2xl font-bold text-blue-600\">\n                        {selectedSupplier.rating}/5\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">Overall Rating</div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"p-4 text-center\">\n                      <div className=\"text-2xl font-bold text-green-600\">\n                        {selectedSupplier.onTimeDelivery}%\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">On-Time Delivery</div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardContent className=\"p-4 text-center\">\n                      <div className=\"text-2xl font-bold text-purple-600\">\n                        {formatCurrency(selectedSupplier.totalSpend)}\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">Total Spend</div>\n                    </CardContent>\n                  </Card>\n                </div>\n\n                {/* Tags */}\n                {selectedSupplier.tags.length > 0 && (\n                  <div>\n                    <h4 className=\"font-medium mb-2\">Tags</h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {selectedSupplier.tags.map((tag, index) => (\n                        <Badge key={index} variant=\"secondary\">\n                          {tag}\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n            </DialogContent>\n          </Dialog>\n        )}\n\n        {/* Pricelist Upload Dialog */}\n        {showPricelistUpload && (\n          <Dialog open={showPricelistUpload} onOpenChange={setShowPricelistUpload}>\n            <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Upload Supplier Pricelist</DialogTitle>\n                <DialogDescription>\n                  Upload a pricelist file or manually enter pricelist items for suppliers.\n                </DialogDescription>\n              </DialogHeader>\n              <SupplierPricelistUpload\n                supplierId={selectedSupplier?.id}\n                onUploadComplete={(pricelist) => {\n                  console.log('Pricelist uploaded:', pricelist)\n                  setShowPricelistUpload(false)\n                  // Refresh suppliers data\n                  window.location.reload()\n                }}\n                onCancel={() => setShowPricelistUpload(false)}\n              />\n            </DialogContent>\n          </Dialog>\n        )}\n      </div>\n\n      {/* Quick Actions Sidebar */}\n      <aside className=\"lg:w-80 xl:w-96 shrink-0\">\n        <div className=\"sticky top-4 space-y-4\">\n          <SupplierQuickActions\n            onRefreshData={() => {\n              refresh()\n            }}\n            onViewAnalytics={() => setActiveTab('analytics')}\n          />\n        </div>\n      </aside>\n    </div>\n    </TooltipProvider>\n    </AppLayout>\n  )\n}\n\nexport default UnifiedSupplierDashboard\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\suppliers\\ai\\AISupplierDiscoveryPanel.tsx","messages":[{"ruleId":"no-redeclare","severity":2,"message":"'AISupplierRecommendation' is already defined.","line":39,"column":11,"nodeType":"Identifier","messageId":"redeclared","endLine":39,"endColumn":35},{"ruleId":"no-redeclare","severity":2,"message":"'AISupplierInsight' is already defined.","line":63,"column":11,"nodeType":"Identifier","messageId":"redeclared","endLine":63,"endColumn":28}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useCallback, useEffect } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport {\r\n  Brain,\r\n  Search,\r\n  Sparkles,\r\n  TrendingUp,\r\n  Target,\r\n  MapPin,\r\n  Star,\r\n  Clock,\r\n  AlertCircle,\r\n  CheckCircle,\r\n  Loader2,\r\n  RefreshCw,\r\n  MessageSquare,\r\n  Filter,\r\n  Zap,\r\n  ThumbsUp,\r\n  ThumbsDown\r\n} from 'lucide-react'\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from '@/components/ui/tooltip'\r\nimport type { Supplier } from '@/types/supplier'\r\nimport type { AISupplierRecommendation, AISupplierInsight } from '@/types/ai-supplier'\r\n\r\ninterface AISupplierRecommendation {\r\n  id: string\r\n  supplier: Partial<Supplier>\r\n  confidenceScore: number\r\n  matchReasons: string[]\r\n  riskFactors: string[]\r\n  predictedPerformance: {\r\n    deliveryReliability: number\r\n    qualityScore: number\r\n    costEffectiveness: number\r\n    relationshipPotential: number\r\n  }\r\n  marketIntelligence: {\r\n    competitorAnalysis: string\r\n    industryPosition: string\r\n    growthTrend: 'increasing' | 'stable' | 'declining'\r\n    marketShare: number\r\n  }\r\n  aiInsights: string[]\r\n  recommendationType: 'perfect_match' | 'good_alternative' | 'cost_effective' | 'innovative'\r\n  estimatedSavings?: number\r\n  implementationComplexity: 'low' | 'medium' | 'high'\r\n}\r\n\r\ninterface AISupplierInsight {\r\n  id: string\r\n  type: 'opportunity' | 'risk' | 'trend' | 'recommendation'\r\n  title: string\r\n  description: string\r\n  impact: 'low' | 'medium' | 'high'\r\n  confidence: number\r\n  actionable: boolean\r\n  suggestedActions: string[]\r\n  relatedSuppliers: string[]\r\n  dataPoints: Record<string, any>\r\n  timestamp: Date\r\n}\r\n\r\ninterface AISupplierDiscoveryPanelProps {\r\n  onSupplierRecommend?: (supplier: AISupplierRecommendation) => void\r\n  onInsightAction?: (insight: AISupplierInsight, action: string) => void\r\n  className?: string\r\n}\r\n\r\nexport default function AISupplierDiscoveryPanel({\r\n  onSupplierRecommend,\r\n  onInsightAction,\r\n  className\r\n}: AISupplierDiscoveryPanelProps) {\r\n  // State management\r\n  const [searchQuery, setSearchQuery] = useState('')\r\n  const [isSearching, setIsSearching] = useState(false)\r\n  const [recommendations, setRecommendations] = useState<AISupplierRecommendation[]>([])\r\n  const [insights, setInsights] = useState<AISupplierInsight[]>([])\r\n  const [activeTab, setActiveTab] = useState('discover')\r\n  const [searchHistory, setSearchHistory] = useState<string[]>([])\r\n  const [isAnalyzing, setIsAnalyzing] = useState(false)\r\n\r\n  // AI-powered search functionality\r\n  const handleAISearch = useCallback(async (query: string) => {\r\n    if (!query.trim()) return\r\n\r\n    setIsSearching(true)\r\n    try {\r\n      const response = await fetch('/api/ai/suppliers/discover', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          query,\r\n          context: 'supplier_discovery',\r\n          includeMarketIntelligence: true,\r\n          includePredictiveAnalysis: true\r\n        })\r\n      })\r\n\r\n      if (!response.ok) throw new Error('Search failed')\r\n\r\n      const { recommendations: newRecs, insights: newInsights } = await response.json()\r\n      setRecommendations(newRecs)\r\n      setInsights(newInsights)\r\n\r\n      // Update search history\r\n      setSearchHistory(prev => [query, ...prev.filter(q => q !== query)].slice(0, 5))\r\n    } catch (error) {\r\n      console.error('AI search error:', error)\r\n    } finally {\r\n      setIsSearching(false)\r\n    }\r\n  }, [])\r\n\r\n  // Auto-insights generation\r\n  useEffect(() => {\r\n    const generateMarketInsights = async () => {\r\n      setIsAnalyzing(true)\r\n      try {\r\n        const response = await fetch('/api/ai/suppliers/insights', {\r\n          method: 'POST',\r\n          headers: { 'Content-Type': 'application/json' },\r\n          body: JSON.stringify({\r\n            analysisType: 'market_opportunities',\r\n            includeRiskAssessment: true\r\n          })\r\n        })\r\n\r\n        if (response.ok) {\r\n          const { insights } = await response.json()\r\n          setInsights(prev => [...insights, ...prev])\r\n        }\r\n      } catch (error) {\r\n        console.error('Auto-insights error:', error)\r\n      } finally {\r\n        setIsAnalyzing(false)\r\n      }\r\n    }\r\n\r\n    generateMarketInsights()\r\n  }, [])\r\n\r\n  const getRecommendationTypeColor = (type: AISupplierRecommendation['recommendationType']) => {\r\n    const colors = {\r\n      perfect_match: 'bg-green-500',\r\n      good_alternative: 'bg-blue-500',\r\n      cost_effective: 'bg-orange-500',\r\n      innovative: 'bg-purple-500'\r\n    }\r\n    return colors[type]\r\n  }\r\n\r\n  const getRecommendationTypeLabel = (type: AISupplierRecommendation['recommendationType']) => {\r\n    const labels = {\r\n      perfect_match: 'Perfect Match',\r\n      good_alternative: 'Good Alternative',\r\n      cost_effective: 'Cost Effective',\r\n      innovative: 'Innovative Option'\r\n    }\r\n    return labels[type]\r\n  }\r\n\r\n  const getInsightIcon = (type: AISupplierInsight['type']) => {\r\n    const icons = {\r\n      opportunity: TrendingUp,\r\n      risk: AlertCircle,\r\n      trend: Target,\r\n      recommendation: Sparkles\r\n    }\r\n    const Icon = icons[type]\r\n    return <Icon className=\"h-4 w-4\" />\r\n  }\r\n\r\n  const getImpactColor = (impact: string) => {\r\n    const colors = {\r\n      low: 'text-green-600',\r\n      medium: 'text-orange-600',\r\n      high: 'text-red-600'\r\n    }\r\n    return colors[impact as keyof typeof colors] || 'text-gray-600'\r\n  }\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <Card className={className}>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Brain className=\"h-5 w-5 text-purple-600\" />\r\n            AI Supplier Discovery\r\n            {isAnalyzing && <Loader2 className=\"h-4 w-4 animate-spin\" />}\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-6\">\r\n          {/* AI Search Interface */}\r\n          <div className=\"space-y-3\">\r\n            <div className=\"flex gap-2\">\r\n              <div className=\"relative flex-1\">\r\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  placeholder=\"Describe what type of supplier you need... (e.g., 'sustainable packaging suppliers in South Africa')\"\r\n                  value={searchQuery}\r\n                  onChange={(e) => setSearchQuery(e.target.value)}\r\n                  onKeyDown={(e) => e.key === 'Enter' && handleAISearch(searchQuery)}\r\n                  className=\"pl-10\"\r\n                />\r\n              </div>\r\n              <Button\r\n                onClick={() => handleAISearch(searchQuery)}\r\n                disabled={isSearching}\r\n              >\r\n                {isSearching ? (\r\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                ) : (\r\n                  <Sparkles className=\"h-4 w-4\" />\r\n                )}\r\n                {isSearching ? 'Searching...' : 'AI Search'}\r\n              </Button>\r\n            </div>\r\n\r\n            {/* Search History */}\r\n            {searchHistory.length > 0 && (\r\n              <div className=\"flex flex-wrap gap-1\">\r\n                {searchHistory.map((query, index) => (\r\n                  <Badge\r\n                    key={index}\r\n                    variant=\"outline\"\r\n                    className=\"cursor-pointer text-xs\"\r\n                    onClick={() => setSearchQuery(query)}\r\n                  >\r\n                    {query}\r\n                  </Badge>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\r\n            <TabsList className=\"grid w-full grid-cols-3\">\r\n              <TabsTrigger value=\"discover\">\r\n                <Target className=\"h-4 w-4 mr-2\" />\r\n                Discover\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"recommendations\">\r\n                <Star className=\"h-4 w-4 mr-2\" />\r\n                Recommendations ({recommendations.length})\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"insights\">\r\n                <Brain className=\"h-4 w-4 mr-2\" />\r\n                Insights ({insights.length})\r\n              </TabsTrigger>\r\n            </TabsList>\r\n\r\n            {/* Discovery Tab */}\r\n            <TabsContent value=\"discover\" className=\"space-y-4\">\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <Card className=\"bg-gradient-to-br from-blue-50 to-indigo-50\">\r\n                  <CardContent className=\"p-4\">\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <Zap className=\"h-5 w-5 text-blue-600\" />\r\n                      <span className=\"font-medium\">Smart Matching</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      AI analyzes your requirements against supplier capabilities, performance data, and market intelligence.\r\n                    </p>\r\n                  </CardContent>\r\n                </Card>\r\n\r\n                <Card className=\"bg-gradient-to-br from-green-50 to-emerald-50\">\r\n                  <CardContent className=\"p-4\">\r\n                    <div className=\"flex items-center gap-2 mb-2\">\r\n                      <TrendingUp className=\"h-5 w-5 text-green-600\" />\r\n                      <span className=\"font-medium\">Predictive Analytics</span>\r\n                    </div>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Get predictions on supplier performance, cost savings, and relationship potential.\r\n                    </p>\r\n                  </CardContent>\r\n                </Card>\r\n              </div>\r\n\r\n              {recommendations.length === 0 && !isSearching && (\r\n                <div className=\"text-center py-8 text-muted-foreground\">\r\n                  <Brain className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\r\n                  <p>Use AI search to discover suppliers that match your specific needs</p>\r\n                </div>\r\n              )}\r\n            </TabsContent>\r\n\r\n            {/* Recommendations Tab */}\r\n            <TabsContent value=\"recommendations\" className=\"space-y-4\">\r\n              <ScrollArea className=\"h-[500px]\">\r\n                <div className=\"space-y-4\">\r\n                  {recommendations.map((rec) => (\r\n                    <Card key={rec.id} className=\"border-l-4 border-l-blue-500\">\r\n                      <CardHeader className=\"pb-3\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <div className=\"h-10 w-10 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-semibold\">\r\n                              {rec.supplier.name?.[0] || 'S'}\r\n                            </div>\r\n                            <div>\r\n                              <CardTitle className=\"text-lg\">{rec.supplier.name}</CardTitle>\r\n                              <p className=\"text-sm text-muted-foreground\">\r\n                                {rec.supplier.primary_category} • {rec.supplier.geographic_region}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"text-right\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Badge\r\n                                className={`${getRecommendationTypeColor(rec.recommendationType)} text-white`}\r\n                              >\r\n                                {getRecommendationTypeLabel(rec.recommendationType)}\r\n                              </Badge>\r\n                            </div>\r\n                            <div className=\"text-sm text-muted-foreground mt-1\">\r\n                              {rec.confidenceScore}% confidence\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      </CardHeader>\r\n                      <CardContent className=\"space-y-4\">\r\n                        {/* Confidence Score */}\r\n                        <div>\r\n                          <div className=\"flex justify-between text-sm mb-1\">\r\n                            <span>AI Confidence</span>\r\n                            <span>{rec.confidenceScore}%</span>\r\n                          </div>\r\n                          <Progress value={rec.confidenceScore} className=\"h-2\" />\r\n                        </div>\r\n\r\n                        {/* Predicted Performance */}\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                          <div>\r\n                            <div className=\"text-sm font-medium mb-2\">Predicted Performance</div>\r\n                            <div className=\"space-y-1 text-xs\">\r\n                              <div className=\"flex justify-between\">\r\n                                <span>Delivery:</span>\r\n                                <span className=\"font-medium\">{rec.predictedPerformance.deliveryReliability}%</span>\r\n                              </div>\r\n                              <div className=\"flex justify-between\">\r\n                                <span>Quality:</span>\r\n                                <span className=\"font-medium\">{rec.predictedPerformance.qualityScore}%</span>\r\n                              </div>\r\n                              <div className=\"flex justify-between\">\r\n                                <span>Cost Effectiveness:</span>\r\n                                <span className=\"font-medium\">{rec.predictedPerformance.costEffectiveness}%</span>\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div>\r\n                            <div className=\"text-sm font-medium mb-2\">Market Intelligence</div>\r\n                            <div className=\"text-xs space-y-1\">\r\n                              <div>Position: {rec.marketIntelligence.industryPosition}</div>\r\n                              <div>Growth: {rec.marketIntelligence.growthTrend}</div>\r\n                              <div>Market Share: {rec.marketIntelligence.marketShare}%</div>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Match Reasons */}\r\n                        <div>\r\n                          <div className=\"text-sm font-medium mb-2\">Why This Match?</div>\r\n                          <div className=\"flex flex-wrap gap-1\">\r\n                            {rec.matchReasons.map((reason, index) => (\r\n                              <Badge key={index} variant=\"outline\" className=\"text-xs\">\r\n                                <CheckCircle className=\"h-3 w-3 mr-1 text-green-500\" />\r\n                                {reason}\r\n                              </Badge>\r\n                            ))}\r\n                          </div>\r\n                        </div>\r\n\r\n                        {/* Risk Factors */}\r\n                        {rec.riskFactors.length > 0 && (\r\n                          <div>\r\n                            <div className=\"text-sm font-medium mb-2\">Risk Considerations</div>\r\n                            <div className=\"flex flex-wrap gap-1\">\r\n                              {rec.riskFactors.map((risk, index) => (\r\n                                <Badge key={index} variant=\"outline\" className=\"text-xs border-orange-200\">\r\n                                  <AlertCircle className=\"h-3 w-3 mr-1 text-orange-500\" />\r\n                                  {risk}\r\n                                </Badge>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n\r\n                        {/* AI Insights */}\r\n                        {rec.aiInsights.length > 0 && (\r\n                          <div>\r\n                            <div className=\"text-sm font-medium mb-2\">AI Insights</div>\r\n                            <div className=\"text-sm text-muted-foreground space-y-1\">\r\n                              {rec.aiInsights.map((insight, index) => (\r\n                                <div key={index} className=\"flex items-start gap-2\">\r\n                                  <Sparkles className=\"h-3 w-3 mt-1 text-purple-500\" />\r\n                                  <span>{insight}</span>\r\n                                </div>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n\r\n                        {/* Action Buttons */}\r\n                        <div className=\"flex gap-2 pt-2\">\r\n                          <Button\r\n                            size=\"sm\"\r\n                            onClick={() => onSupplierRecommend?.(rec)}\r\n                          >\r\n                            View Details\r\n                          </Button>\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"outline\"\r\n                            onClick={() => {/* Handle contact supplier */}}\r\n                          >\r\n                            <MessageSquare className=\"h-4 w-4 mr-1\" />\r\n                            Contact\r\n                          </Button>\r\n                          <Tooltip>\r\n                            <TooltipTrigger asChild>\r\n                              <Button size=\"sm\" variant=\"ghost\">\r\n                                <ThumbsUp className=\"h-4 w-4\" />\r\n                              </Button>\r\n                            </TooltipTrigger>\r\n                            <TooltipContent>Good recommendation</TooltipContent>\r\n                          </Tooltip>\r\n                          <Tooltip>\r\n                            <TooltipTrigger asChild>\r\n                              <Button size=\"sm\" variant=\"ghost\">\r\n                                <ThumbsDown className=\"h-4 w-4\" />\r\n                              </Button>\r\n                            </TooltipTrigger>\r\n                            <TooltipContent>Not relevant</TooltipContent>\r\n                          </Tooltip>\r\n                        </div>\r\n                      </CardContent>\r\n                    </Card>\r\n                  ))}\r\n                </div>\r\n              </ScrollArea>\r\n            </TabsContent>\r\n\r\n            {/* Insights Tab */}\r\n            <TabsContent value=\"insights\" className=\"space-y-4\">\r\n              <ScrollArea className=\"h-[500px]\">\r\n                <div className=\"space-y-4\">\r\n                  {insights.map((insight) => (\r\n                    <Card key={insight.id} className=\"border-l-4 border-l-purple-500\">\r\n                      <CardContent className=\"p-4\">\r\n                        <div className=\"flex items-start justify-between mb-3\">\r\n                          <div className=\"flex items-start gap-3\">\r\n                            {getInsightIcon(insight.type)}\r\n                            <div>\r\n                              <h4 className=\"font-medium\">{insight.title}</h4>\r\n                              <p className=\"text-sm text-muted-foreground mt-1\">\r\n                                {insight.description}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"text-right text-sm\">\r\n                            <div className={`font-medium ${getImpactColor(insight.impact)}`}>\r\n                              {insight.impact.toUpperCase()} IMPACT\r\n                            </div>\r\n                            <div className=\"text-muted-foreground\">\r\n                              {insight.confidence}% confidence\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n\r\n                        {insight.actionable && insight.suggestedActions.length > 0 && (\r\n                          <div className=\"space-y-2\">\r\n                            <div className=\"text-sm font-medium\">Suggested Actions:</div>\r\n                            <div className=\"space-y-1\">\r\n                              {insight.suggestedActions.map((action, index) => (\r\n                                <div key={index} className=\"flex items-center gap-2\">\r\n                                  <Button\r\n                                    size=\"sm\"\r\n                                    variant=\"outline\"\r\n                                    onClick={() => onInsightAction?.(insight, action)}\r\n                                  >\r\n                                    {action}\r\n                                  </Button>\r\n                                </div>\r\n                              ))}\r\n                            </div>\r\n                          </div>\r\n                        )}\r\n\r\n                        <div className=\"text-xs text-muted-foreground mt-3\">\r\n                          {new Date(insight.timestamp).toLocaleString()}\r\n                        </div>\r\n                      </CardContent>\r\n                    </Card>\r\n                  ))}\r\n                </div>\r\n              </ScrollArea>\r\n            </TabsContent>\r\n          </Tabs>\r\n        </CardContent>\r\n      </Card>\r\n    </TooltipProvider>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\test\\TimestampValidationTest.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":69,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":69,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":92,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":92,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":121,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":121,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'alert' is not defined.","line":406,"column":15,"nodeType":"Identifier","messageId":"undef","endLine":406,"endColumn":20}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Timestamp Validation Test Component\r\n * Tests all date/timestamp handling scenarios to ensure robustness\r\n */\r\n\r\n'use client';\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Alert, AlertDescription } from '@/components/ui/alert';\r\nimport {\r\n  safeParseDate,\r\n  safeGetTime,\r\n  formatTimestamp,\r\n  getRelativeTime,\r\n  serializeTimestamp,\r\n  sortByTimestamp,\r\n  filterByDateRange\r\n} from '@/lib/utils/date-utils';\r\nimport { CheckCircle, XCircle, Clock, AlertTriangle } from 'lucide-react';\r\n\r\ninterface TestCase {\r\n  name: string;\r\n  input: unknown;\r\n  expectedResult: 'valid' | 'invalid' | 'fallback';\r\n  description: string;\r\n}\r\n\r\ninterface TestResult {\r\n  name: string;\r\n  passed: boolean;\r\n  result: any;\r\n  error?: string;\r\n  duration: number;\r\n}\r\n\r\nconst TEST_CASES: TestCase[] = [\r\n  // Valid dates\r\n  { name: 'ISO String', input: '2024-01-15T10:30:00.000Z', expectedResult: 'valid', description: 'Standard ISO date string' },\r\n  { name: 'Date Object', input: new Date('2024-01-15'), expectedResult: 'valid', description: 'Native Date object' },\r\n  { name: 'Timestamp Number', input: 1705312200000, expectedResult: 'valid', description: 'Unix timestamp' },\r\n  { name: 'Simple Date String', input: '2024-01-15', expectedResult: 'valid', description: 'YYYY-MM-DD format' },\r\n\r\n  // Invalid dates that should fallback gracefully\r\n  { name: 'Null Input', input: null, expectedResult: 'fallback', description: 'Null value' },\r\n  { name: 'Undefined Input', input: undefined, expectedResult: 'fallback', description: 'Undefined value' },\r\n  { name: 'Empty String', input: '', expectedResult: 'fallback', description: 'Empty string' },\r\n  { name: 'Invalid String', input: 'not-a-date', expectedResult: 'fallback', description: 'Non-date string' },\r\n  { name: 'Invalid Number', input: NaN, expectedResult: 'fallback', description: 'NaN value' },\r\n  { name: 'Invalid Date Object', input: new Date('invalid'), expectedResult: 'fallback', description: 'Invalid Date object' },\r\n\r\n  // Edge cases\r\n  { name: 'Future Date', input: '2030-12-31T23:59:59.999Z', expectedResult: 'valid', description: 'Far future date' },\r\n  { name: 'Past Date', input: '1970-01-01T00:00:00.000Z', expectedResult: 'valid', description: 'Unix epoch' },\r\n  { name: 'Zero Timestamp', input: 0, expectedResult: 'valid', description: 'Zero timestamp' },\r\n];\r\n\r\nexport default function TimestampValidationTest() {\r\n  const [testResults, setTestResults] = useState<TestResult[]>([]);\r\n  const [isRunning, setIsRunning] = useState(false);\r\n  const [apiTestResult, setApiTestResult] = useState<any>(null);\r\n\r\n  /**\r\n   * Run individual test case\r\n   */\r\n  const runTest = (testCase: TestCase): TestResult => {\r\n    const startTime = performance.now();\r\n\r\n    try {\r\n      // Test safeParseDate\r\n      const parseResult = safeParseDate(testCase.input);\r\n      const isValidParse = parseResult !== null;\r\n\r\n      // Test safeGetTime\r\n      const timeResult = safeGetTime(testCase.input);\r\n      const isValidTime = !isNaN(timeResult);\r\n\r\n      // Test formatTimestamp\r\n      const formatResult = formatTimestamp(testCase.input);\r\n      const isValidFormat = !formatResult.includes('Invalid');\r\n\r\n      // Test getRelativeTime\r\n      const relativeResult = getRelativeTime(testCase.input);\r\n      const isValidRelative = !relativeResult.includes('Unknown');\r\n\r\n      // Test serializeTimestamp\r\n      const serializeResult = serializeTimestamp(testCase.input);\r\n      const isValidSerialize = serializeResult.includes('T') && serializeResult.includes('Z');\r\n\r\n      const endTime = performance.now();\r\n\r\n      // Determine if test passed based on expected result\r\n      let passed = false;\r\n      if (testCase.expectedResult === 'valid') {\r\n        passed = isValidParse && isValidTime && isValidFormat && isValidRelative && isValidSerialize;\r\n      } else if (testCase.expectedResult === 'fallback') {\r\n        passed = !isValidParse && !isValidRelative; // Should fallback gracefully\r\n      }\r\n\r\n      return {\r\n        name: testCase.name,\r\n        passed,\r\n        result: {\r\n          parseResult: parseResult?.toISOString() || 'null',\r\n          timeResult,\r\n          formatResult,\r\n          relativeResult,\r\n          serializeResult,\r\n          isValidParse,\r\n          isValidTime,\r\n          isValidFormat,\r\n          isValidRelative,\r\n          isValidSerialize\r\n        },\r\n        duration: endTime - startTime\r\n      };\r\n\r\n    } catch (error) {\r\n      const endTime = performance.now();\r\n      return {\r\n        name: testCase.name,\r\n        passed: false,\r\n        result: null,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        duration: endTime - startTime\r\n      };\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Run all tests\r\n   */\r\n  const runAllTests = async () => {\r\n    setIsRunning(true);\r\n    setTestResults([]);\r\n\r\n    const results: TestResult[] = [];\r\n\r\n    for (const testCase of TEST_CASES) {\r\n      const result = runTest(testCase);\r\n      results.push(result);\r\n\r\n      // Update results incrementally for better UX\r\n      setTestResults([...results]);\r\n\r\n      // Small delay to prevent blocking\r\n      await new Promise(resolve => setTimeout(resolve, 10));\r\n    }\r\n\r\n    setIsRunning(false);\r\n  };\r\n\r\n  /**\r\n   * Test API endpoint timestamp handling\r\n   */\r\n  const testApiEndpoint = async () => {\r\n    try {\r\n      const response = await fetch('/api/activities/recent?limit=5');\r\n      const result = await response.json();\r\n\r\n      if (result.success && result.data) {\r\n        // Test that all timestamps can be parsed\r\n        const timestampTests = result.data.map((activity: any) => ({\r\n          id: activity.id,\r\n          timestamp: activity.timestamp,\r\n          canParse: safeParseDate(activity.timestamp) !== null,\r\n          formatted: formatTimestamp(activity.timestamp),\r\n          relative: getRelativeTime(activity.timestamp)\r\n        }));\r\n\r\n        setApiTestResult({\r\n          success: true,\r\n          totalActivities: result.data.length,\r\n          validTimestamps: timestampTests.filter((t: any) => t.canParse).length,\r\n          details: timestampTests\r\n        });\r\n      } else {\r\n        setApiTestResult({\r\n          success: false,\r\n          error: result.error || 'Failed to fetch activities'\r\n        });\r\n      }\r\n    } catch (error) {\r\n      setApiTestResult({\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'API test failed'\r\n      });\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Test array sorting and filtering\r\n   */\r\n  const testArrayOperations = () => {\r\n    const testData = [\r\n      { id: '1', timestamp: '2024-01-15T10:00:00Z', name: 'First' },\r\n      { id: '2', timestamp: '2024-01-15T12:00:00Z', name: 'Second' },\r\n      { id: '3', timestamp: null, name: 'Null timestamp' },\r\n      { id: '4', timestamp: '2024-01-15T08:00:00Z', name: 'Third' },\r\n      { id: '5', timestamp: 'invalid-date', name: 'Invalid timestamp' }\r\n    ];\r\n\r\n    try {\r\n      // Test sorting\r\n      const sorted = sortByTimestamp(testData, 'desc');\r\n      const sortedValid = sorted.filter(item => safeParseDate(item.timestamp) !== null);\r\n\r\n      // Test filtering\r\n      const filtered = filterByDateRange(\r\n        testData,\r\n        '2024-01-15T09:00:00Z',\r\n        '2024-01-15T11:00:00Z'\r\n      );\r\n\r\n      return {\r\n        success: true,\r\n        originalCount: testData.length,\r\n        sortedCount: sorted.length,\r\n        validAfterSort: sortedValid.length,\r\n        filteredCount: filtered.length,\r\n        sortOrder: sorted.map(item => item.name)\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Array operations failed'\r\n      };\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Calculate test summary\r\n   */\r\n  const testSummary = React.useMemo(() => {\r\n    const total = testResults.length;\r\n    const passed = testResults.filter(r => r.passed).length;\r\n    const failed = total - passed;\r\n    const avgDuration = total > 0 ? testResults.reduce((sum, r) => sum + r.duration, 0) / total : 0;\r\n\r\n    return { total, passed, failed, avgDuration };\r\n  }, [testResults]);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center space-x-2\">\r\n            <Clock className=\"w-5 h-5\" />\r\n            <span>Timestamp Validation Test Suite</span>\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Comprehensive testing of date/timestamp handling across the application\r\n          </CardDescription>\r\n        </CardHeader>\r\n\r\n        <CardContent className=\"space-y-4\">\r\n          <div className=\"flex items-center space-x-4\">\r\n            <Button\r\n              onClick={runAllTests}\r\n              disabled={isRunning}\r\n              variant=\"default\"\r\n            >\r\n              {isRunning ? 'Running Tests...' : 'Run All Tests'}\r\n            </Button>\r\n\r\n            <Button\r\n              onClick={testApiEndpoint}\r\n              variant=\"outline\"\r\n            >\r\n              Test API Endpoint\r\n            </Button>\r\n\r\n            <Button\r\n              onClick={() => setTestResults([])}\r\n              variant=\"outline\"\r\n              disabled={isRunning}\r\n            >\r\n              Clear Results\r\n            </Button>\r\n          </div>\r\n\r\n          {testResults.length > 0 && (\r\n            <div className=\"grid grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg\">\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl font-bold text-blue-600\">{testSummary.total}</div>\r\n                <div className=\"text-sm text-gray-600\">Total Tests</div>\r\n              </div>\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl font-bold text-green-600\">{testSummary.passed}</div>\r\n                <div className=\"text-sm text-gray-600\">Passed</div>\r\n              </div>\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl font-bold text-red-600\">{testSummary.failed}</div>\r\n                <div className=\"text-sm text-gray-600\">Failed</div>\r\n              </div>\r\n              <div className=\"text-center\">\r\n                <div className=\"text-2xl font-bold text-purple-600\">{testSummary.avgDuration.toFixed(2)}ms</div>\r\n                <div className=\"text-sm text-gray-600\">Avg Duration</div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Test Results */}\r\n      {testResults.length > 0 && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Test Results</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-3\">\r\n              {testResults.map((result, index) => (\r\n                <div\r\n                  key={index}\r\n                  className=\"flex items-center justify-between p-3 border rounded-lg\"\r\n                >\r\n                  <div className=\"flex items-center space-x-3\">\r\n                    {result.passed ? (\r\n                      <CheckCircle className=\"w-5 h-5 text-green-500\" />\r\n                    ) : (\r\n                      <XCircle className=\"w-5 h-5 text-red-500\" />\r\n                    )}\r\n                    <div>\r\n                      <div className=\"font-medium\">{result.name}</div>\r\n                      {result.error && (\r\n                        <div className=\"text-sm text-red-600\">{result.error}</div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <Badge variant={result.passed ? 'default' : 'destructive'}>\r\n                      {result.passed ? 'PASS' : 'FAIL'}\r\n                    </Badge>\r\n                    <span className=\"text-xs text-gray-500\">\r\n                      {result.duration.toFixed(2)}ms\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* API Test Results */}\r\n      {apiTestResult && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>API Endpoint Test Results</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {apiTestResult.success ? (\r\n              <div className=\"space-y-4\">\r\n                <Alert>\r\n                  <CheckCircle className=\"h-4 w-4\" />\r\n                  <AlertDescription>\r\n                    API test successful! {apiTestResult.validTimestamps}/{apiTestResult.totalActivities} timestamps are valid.\r\n                  </AlertDescription>\r\n                </Alert>\r\n\r\n                {apiTestResult.details && (\r\n                  <div className=\"space-y-2\">\r\n                    {apiTestResult.details.map((detail: any, index: number) => (\r\n                      <div key={index} className=\"p-2 border rounded text-sm\">\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <span className=\"font-mono\">{detail.id}</span>\r\n                          <Badge variant={detail.canParse ? 'default' : 'destructive'}>\r\n                            {detail.canParse ? 'Valid' : 'Invalid'}\r\n                          </Badge>\r\n                        </div>\r\n                        <div className=\"text-gray-600 mt-1\">\r\n                          <div>Formatted: {detail.formatted}</div>\r\n                          <div>Relative: {detail.relative}</div>\r\n                        </div>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            ) : (\r\n              <Alert variant=\"destructive\">\r\n                <AlertTriangle className=\"h-4 w-4\" />\r\n                <AlertDescription>\r\n                  API test failed: {apiTestResult.error}\r\n                </AlertDescription>\r\n              </Alert>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Array Operations Test */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Array Operations Test</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Button\r\n            onClick={() => {\r\n              const result = testArrayOperations();\r\n              console.log('Array operations test result:', result);\r\n              alert(JSON.stringify(result, null, 2));\r\n            }}\r\n            variant=\"outline\"\r\n          >\r\n            Test Sorting & Filtering\r\n          </Button>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\theme-provider.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":30,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":30,"endColumn":36},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":72,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":72,"endColumn":21}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport * as React from 'react';\n\ntype Theme = 'light' | 'dark' | 'system';\n\ninterface ThemeProviderProps {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n  storageKey?: string;\n}\n\ninterface ThemeProviderState {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n}\n\nconst ThemeProviderContext = React.createContext<ThemeProviderState | undefined>(undefined);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = 'system',\n  storageKey = 'theme',\n}: ThemeProviderProps) {\n  const [theme, setTheme] = React.useState<Theme>(defaultTheme);\n  const [mounted, setMounted] = React.useState(false);\n\n  React.useEffect(() => {\n    setMounted(true);\n    const savedTheme = localStorage.getItem(storageKey) as Theme | null;\n    if (savedTheme) {\n      setTheme(savedTheme);\n      applyTheme(savedTheme);\n    } else {\n      applyTheme(defaultTheme);\n    }\n  }, [defaultTheme, storageKey]);\n\n  React.useEffect(() => {\n    if (!mounted) return;\n\n    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');\n    const handleChange = () => {\n      if (theme === 'system') {\n        applyTheme('system');\n      }\n    };\n\n    mediaQuery.addEventListener('change', handleChange);\n    return () => mediaQuery.removeEventListener('change', handleChange);\n  }, [theme, mounted]);\n\n  const applyTheme = (newTheme: Theme) => {\n    const root = window.document.documentElement;\n    root.classList.remove('light', 'dark');\n\n    if (newTheme === 'system') {\n      const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches\n        ? 'dark'\n        : 'light';\n      root.classList.add(systemTheme);\n    } else {\n      root.classList.add(newTheme);\n    }\n  };\n\n  const value = React.useMemo(\n    () => ({\n      theme,\n      setTheme: (newTheme: Theme) => {\n        setTheme(newTheme);\n        localStorage.setItem(storageKey, newTheme);\n        applyTheme(newTheme);\n      },\n    }),\n    [theme, storageKey]\n  );\n\n  // Prevent flash of unstyled content\n  if (!mounted) {\n    return <>{children}</>;\n  }\n\n  return (\n    <ThemeProviderContext.Provider value={value}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = React.useContext(ThemeProviderContext);\n\n  if (context === undefined) {\n    throw new Error('useTheme must be used within a ThemeProvider');\n  }\n\n  return context;\n};\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\BulletproofActivityList.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'Activity' is not defined.","line":341,"column":16,"nodeType":"JSXIdentifier","messageId":"undef","endLine":341,"endColumn":24},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useMemo\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":376,"column":42,"nodeType":"Identifier","endLine":376,"endColumn":49},{"ruleId":"no-undef","severity":2,"message":"'Activity' is not defined.","line":636,"column":32,"nodeType":"JSXIdentifier","messageId":"undef","endLine":636,"endColumn":40}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Bulletproof Activity List Component\r\n * Handles timestamp errors, provides safe sorting, and graceful degradation\r\n */\r\n\r\n'use client'\r\n\r\nimport React, { useState, useMemo, useCallback } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Input } from '@/components/ui/input'\r\nimport { BulletproofDataLoader, ActivityDataLoader } from '@/components/ui/BulletproofDataLoader'\r\nimport { InventoryBoundary } from '@/components/error-boundaries/GranularErrorBoundary'\r\nimport { InvalidDateFallback, InvalidNumberFallback } from '@/components/fallbacks/FallbackComponents'\r\nimport {\r\n  TimestampValidator,\r\n  NumberValidator,\r\n  StringValidator,\r\n  DataSanitizer,\r\n  SafeSorter\r\n} from '@/utils/dataValidation'\r\nimport {\r\n  Clock,\r\n  Package,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  AlertTriangle,\r\n  Filter,\r\n  Search,\r\n  ArrowUpDown,\r\n  ArrowUp,\r\n  ArrowDown,\r\n  RefreshCw,\r\n  Eye,\r\n  EyeOff,\r\n  CheckCircle,\r\n  XCircle,\r\n  Calendar,\r\n  Hash,\r\n  DollarSign,\r\n  Info\r\n} from 'lucide-react'\r\nimport { format, formatDistanceToNow } from 'date-fns'\r\n\r\n// ============================================================================\r\n// TYPES & INTERFACES\r\n// ============================================================================\r\n\r\nexport interface ActivityItem {\r\n  id: string\r\n  timestamp?: any\r\n  created_at?: any\r\n  updated_at?: any\r\n  type: string\r\n  description: string\r\n  amount?: number\r\n  quantity?: number\r\n  status?: string\r\n  user?: string\r\n  metadata?: Record<string, any>\r\n}\r\n\r\nexport interface ActivityListProps {\r\n  loadActivities: () => Promise<ActivityItem[]>\r\n  title?: string\r\n  showFilters?: boolean\r\n  showStats?: boolean\r\n  allowExport?: boolean\r\n  maxItems?: number\r\n  autoRefresh?: boolean\r\n  refreshInterval?: number\r\n  onItemClick?: (item: ActivityItem) => void\r\n  className?: string\r\n}\r\n\r\nexport interface ActivityStats {\r\n  total: number\r\n  validTimestamps: number\r\n  invalidTimestamps: number\r\n  sanitizedItems: number\r\n  dateRange?: {\r\n    earliest: Date\r\n    latest: Date\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// ACTIVITY SANITIZATION\r\n// ============================================================================\r\n\r\nfunction sanitizeActivity(item: any): ActivityItem & { sanitized: boolean; validationErrors: string[] } {\r\n  const validationErrors: string[] = []\r\n  let sanitized = false\r\n\r\n  // Sanitize ID\r\n  const idResult = StringValidator.validate(item.id, { fallback: `activity-${Date.now()}-${Math.random()}` })\r\n  if (idResult.sanitized) {\r\n    sanitized = true\r\n    validationErrors.push('Generated fallback ID')\r\n  }\r\n\r\n  // Sanitize timestamps\r\n  const timestampResult = TimestampValidator.validate(\r\n    item.timestamp || item.created_at || item.date,\r\n    { fallbackToNow: false, allowNull: true }\r\n  )\r\n  if (timestampResult.sanitized) {\r\n    sanitized = true\r\n  }\r\n  if (timestampResult.errors.length > 0) {\r\n    validationErrors.push(...timestampResult.errors)\r\n  }\r\n\r\n  const createdAtResult = TimestampValidator.validate(\r\n    item.created_at,\r\n    { fallbackToNow: false, allowNull: true }\r\n  )\r\n\r\n  const updatedAtResult = TimestampValidator.validate(\r\n    item.updated_at,\r\n    { fallbackToNow: false, allowNull: true }\r\n  )\r\n\r\n  // Sanitize other fields\r\n  const typeResult = StringValidator.validate(item.type, { fallback: 'general' })\r\n  const descriptionResult = StringValidator.validate(item.description, { fallback: 'No description available' })\r\n  const amountResult = NumberValidator.validate(item.amount, { allowNull: true, decimals: 2 })\r\n  const quantityResult = NumberValidator.validate(item.quantity, { allowNull: true, decimals: 0 })\r\n  const statusResult = StringValidator.validate(item.status, { fallback: 'unknown' })\r\n  const userResult = StringValidator.validate(item.user, { allowNull: true })\r\n\r\n  if (typeResult.sanitized || descriptionResult.sanitized ||\r\n      amountResult.sanitized || quantityResult.sanitized || statusResult.sanitized) {\r\n    sanitized = true\r\n  }\r\n\r\n  return {\r\n    id: idResult.data!,\r\n    timestamp: timestampResult.data,\r\n    created_at: createdAtResult.data,\r\n    updated_at: updatedAtResult.data,\r\n    type: typeResult.data!,\r\n    description: descriptionResult.data!,\r\n    amount: amountResult.data,\r\n    quantity: quantityResult.data,\r\n    status: statusResult.data!,\r\n    user: userResult.data,\r\n    metadata: item.metadata || {},\r\n    sanitized,\r\n    validationErrors\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// ACTIVITY STATS CALCULATOR\r\n// ============================================================================\r\n\r\nfunction calculateActivityStats(activities: (ActivityItem & { sanitized: boolean })[]): ActivityStats {\r\n  let validTimestamps = 0\r\n  let invalidTimestamps = 0\r\n  let sanitizedItems = 0\r\n  let earliest: Date | null = null\r\n  let latest: Date | null = null\r\n\r\n  activities.forEach(activity => {\r\n    if (activity.sanitized) sanitizedItems++\r\n\r\n    const timestamp = activity.timestamp || activity.created_at\r\n    if (timestamp && TimestampValidator.validate(timestamp).isValid) {\r\n      validTimestamps++\r\n\r\n      const date = TimestampValidator.validate(timestamp).data!\r\n      if (!earliest || date < earliest) earliest = date\r\n      if (!latest || date > latest) latest = date\r\n    } else {\r\n      invalidTimestamps++\r\n    }\r\n  })\r\n\r\n  return {\r\n    total: activities.length,\r\n    validTimestamps,\r\n    invalidTimestamps,\r\n    sanitizedItems,\r\n    dateRange: earliest && latest ? { earliest, latest } : undefined\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// SAFE ACTIVITY FORMATTER\r\n// ============================================================================\r\n\r\nconst ActivityFormatter = {\r\n  timestamp: (value: any, fallback: string = 'Invalid Date'): string => {\r\n    const result = TimestampValidator.validate(value)\r\n    if (!result.isValid || !result.data) return fallback\r\n\r\n    try {\r\n      return format(result.data, 'MMM dd, yyyy HH:mm')\r\n    } catch {\r\n      return fallback\r\n    }\r\n  },\r\n\r\n  relativeTime: (value: any, fallback: string = 'Unknown time'): string => {\r\n    const result = TimestampValidator.validate(value)\r\n    if (!result.isValid || !result.data) return fallback\r\n\r\n    try {\r\n      return formatDistanceToNow(result.data, { addSuffix: true })\r\n    } catch {\r\n      return fallback\r\n    }\r\n  },\r\n\r\n  amount: (value: any, fallback: string = '—'): string => {\r\n    const result = NumberValidator.validate(value, { allowNull: true })\r\n    if (!result.isValid || result.data === null) return fallback\r\n\r\n    return NumberValidator.formatSafe(result.data, {\r\n      style: 'currency',\r\n      currency: 'USD',\r\n      minimumFractionDigits: 2\r\n    })\r\n  },\r\n\r\n  quantity: (value: any, fallback: string = '—'): string => {\r\n    const result = NumberValidator.validate(value, { allowNull: true })\r\n    if (!result.isValid || result.data === null) return fallback\r\n\r\n    return NumberValidator.formatSafe(result.data, {\r\n      style: 'decimal',\r\n      maximumFractionDigits: 0\r\n    })\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// ACTIVITY STATUS INDICATOR\r\n// ============================================================================\r\n\r\nconst ActivityStatusIndicator: React.FC<{\r\n  activity: ActivityItem & { sanitized: boolean; validationErrors: string[] }\r\n}> = ({ activity }) => {\r\n  const hasTimestampIssues = !activity.timestamp && !activity.created_at\r\n  const hasValidationErrors = activity.validationErrors.length > 0\r\n\r\n  if (hasTimestampIssues || hasValidationErrors) {\r\n    return (\r\n      <div className=\"flex items-center gap-1\">\r\n        <AlertTriangle className=\"h-3 w-3 text-yellow-500\" />\r\n        <Badge variant=\"outline\" className=\"text-xs\">\r\n          Issues: {activity.validationErrors.length}\r\n        </Badge>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (activity.sanitized) {\r\n    return (\r\n      <div className=\"flex items-center gap-1\">\r\n        <Info className=\"h-3 w-3 text-blue-500\" />\r\n        <Badge variant=\"outline\" className=\"text-xs bg-blue-50\">\r\n          Sanitized\r\n        </Badge>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-1\">\r\n      <CheckCircle className=\"h-3 w-3 text-green-500\" />\r\n      <Badge variant=\"outline\" className=\"text-xs bg-green-50\">\r\n        Valid\r\n      </Badge>\r\n    </div>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// MAIN COMPONENT\r\n// ============================================================================\r\n\r\nexport const BulletproofActivityList: React.FC<ActivityListProps> = ({\r\n  loadActivities,\r\n  title = 'Recent Activity',\r\n  showFilters = true,\r\n  showStats = true,\r\n  allowExport = false,\r\n  maxItems = 100,\r\n  autoRefresh = false,\r\n  refreshInterval = 30000,\r\n  onItemClick,\r\n  className = ''\r\n}) => {\r\n  // State management\r\n  const [searchTerm, setSearchTerm] = useState('')\r\n  const [filterType, setFilterType] = useState<string>('all')\r\n  const [filterStatus, setFilterStatus] = useState<string>('all')\r\n  const [sortField, setSortField] = useState<'timestamp' | 'type' | 'amount'>('timestamp')\r\n  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc')\r\n  const [showValidationIssues, setShowValidationIssues] = useState(false)\r\n  const [showSanitized, setShowSanitized] = useState(true)\r\n\r\n  // Handle sorting change\r\n  const handleSort = useCallback((field: 'timestamp' | 'type' | 'amount') => {\r\n    if (sortField === field) {\r\n      setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc')\r\n    } else {\r\n      setSortField(field)\r\n      setSortDirection('desc')\r\n    }\r\n  }, [sortField])\r\n\r\n  // Render sort button\r\n  const SortButton: React.FC<{ field: 'timestamp' | 'type' | 'amount'; children: React.ReactNode }> = ({ field, children }) => (\r\n    <Button\r\n      variant=\"ghost\"\r\n      size=\"sm\"\r\n      onClick={() => handleSort(field)}\r\n      className=\"h-8 px-2 font-medium\"\r\n    >\r\n      {children}\r\n      {sortField === field ? (\r\n        sortDirection === 'asc' ? <ArrowUp className=\"ml-1 h-3 w-3\" /> : <ArrowDown className=\"ml-1 h-3 w-3\" />\r\n      ) : (\r\n        <ArrowUpDown className=\"ml-1 h-3 w-3 opacity-50\" />\r\n      )}\r\n    </Button>\r\n  )\r\n\r\n  return (\r\n    <InventoryBoundary className={className}>\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex items-center justify-between\">\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <Activity className=\"h-5 w-5\" />\r\n              {title}\r\n            </CardTitle>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setShowValidationIssues(!showValidationIssues)}\r\n              >\r\n                {showValidationIssues ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\r\n                Issues\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n\r\n        <CardContent>\r\n          <ActivityDataLoader\r\n            loadData={loadActivities}\r\n            enableCaching={true}\r\n            cacheKey=\"activity-list\"\r\n            cacheDuration={60000} // 1 minute\r\n            autoRefresh={autoRefresh}\r\n            refreshInterval={refreshInterval}\r\n            errorTitle=\"Activity Loading Error\"\r\n            className=\"space-y-4\"\r\n          >\r\n            {(activities) => {\r\n              // Sanitize all activities\r\n              const sanitizedActivities = activities.map(sanitizeActivity)\r\n\r\n              // Calculate stats\r\n              const stats = calculateActivityStats(sanitizedActivities)\r\n\r\n              // Filter activities\r\n              const filteredActivities = useMemo(() => {\r\n                let filtered = sanitizedActivities\r\n\r\n                // Search filter\r\n                if (searchTerm) {\r\n                  const term = searchTerm.toLowerCase()\r\n                  filtered = filtered.filter(activity =>\r\n                    activity.description.toLowerCase().includes(term) ||\r\n                    activity.type.toLowerCase().includes(term) ||\r\n                    activity.user?.toLowerCase().includes(term)\r\n                  )\r\n                }\r\n\r\n                // Type filter\r\n                if (filterType !== 'all') {\r\n                  filtered = filtered.filter(activity => activity.type === filterType)\r\n                }\r\n\r\n                // Status filter\r\n                if (filterStatus !== 'all') {\r\n                  filtered = filtered.filter(activity => activity.status === filterStatus)\r\n                }\r\n\r\n                // Validation issues filter\r\n                if (showValidationIssues) {\r\n                  filtered = filtered.filter(activity =>\r\n                    activity.validationErrors.length > 0 || !activity.timestamp\r\n                  )\r\n                }\r\n\r\n                // Sanitized filter\r\n                if (!showSanitized) {\r\n                  filtered = filtered.filter(activity => !activity.sanitized)\r\n                }\r\n\r\n                // Sort activities safely\r\n                switch (sortField) {\r\n                  case 'timestamp':\r\n                    return SafeSorter.byTimestamp(\r\n                      filtered,\r\n                      (item) => item.timestamp || item.created_at,\r\n                      sortDirection\r\n                    )\r\n                  case 'type':\r\n                    return SafeSorter.byString(filtered, (item) => item.type, sortDirection)\r\n                  case 'amount':\r\n                    return SafeSorter.byNumber(filtered, (item) => item.amount, sortDirection)\r\n                  default:\r\n                    return filtered\r\n                }\r\n              }, [sanitizedActivities, searchTerm, filterType, filterStatus, showValidationIssues, showSanitized, sortField, sortDirection])\r\n\r\n              // Get unique types and statuses for filters\r\n              const uniqueTypes = [...new Set(sanitizedActivities.map(a => a.type))]\r\n              const uniqueStatuses = [...new Set(sanitizedActivities.map(a => a.status))]\r\n\r\n              return (\r\n                <div className=\"space-y-4\">\r\n                  {/* Stats Display */}\r\n                  {showStats && (\r\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n                      <Card className=\"p-3\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Hash className=\"h-4 w-4 text-blue-500\" />\r\n                          <div>\r\n                            <div className=\"text-sm font-medium\">Total</div>\r\n                            <div className=\"text-lg font-bold\">{stats.total}</div>\r\n                          </div>\r\n                        </div>\r\n                      </Card>\r\n\r\n                      <Card className=\"p-3\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <CheckCircle className=\"h-4 w-4 text-green-500\" />\r\n                          <div>\r\n                            <div className=\"text-sm font-medium\">Valid</div>\r\n                            <div className=\"text-lg font-bold\">{stats.validTimestamps}</div>\r\n                          </div>\r\n                        </div>\r\n                      </Card>\r\n\r\n                      <Card className=\"p-3\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <XCircle className=\"h-4 w-4 text-red-500\" />\r\n                          <div>\r\n                            <div className=\"text-sm font-medium\">Invalid</div>\r\n                            <div className=\"text-lg font-bold\">{stats.invalidTimestamps}</div>\r\n                          </div>\r\n                        </div>\r\n                      </Card>\r\n\r\n                      <Card className=\"p-3\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <Info className=\"h-4 w-4 text-blue-500\" />\r\n                          <div>\r\n                            <div className=\"text-sm font-medium\">Sanitized</div>\r\n                            <div className=\"text-lg font-bold\">{stats.sanitizedItems}</div>\r\n                          </div>\r\n                        </div>\r\n                      </Card>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Filters */}\r\n                  {showFilters && (\r\n                    <div className=\"flex flex-wrap items-center gap-2\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <Search className=\"h-4 w-4 text-muted-foreground\" />\r\n                        <Input\r\n                          placeholder=\"Search activities...\"\r\n                          value={searchTerm}\r\n                          onChange={(e) => setSearchTerm(e.target.value)}\r\n                          className=\"w-64\"\r\n                        />\r\n                      </div>\r\n\r\n                      <Select value={filterType} onValueChange={setFilterType}>\r\n                        <SelectTrigger className=\"w-32\">\r\n                          <SelectValue placeholder=\"Type\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          <SelectItem value=\"all\">All Types</SelectItem>\r\n                          {uniqueTypes.map(type => (\r\n                            <SelectItem key={type} value={type}>{type}</SelectItem>\r\n                          ))}\r\n                        </SelectContent>\r\n                      </Select>\r\n\r\n                      <Select value={filterStatus} onValueChange={setFilterStatus}>\r\n                        <SelectTrigger className=\"w-32\">\r\n                          <SelectValue placeholder=\"Status\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          <SelectItem value=\"all\">All Status</SelectItem>\r\n                          {uniqueStatuses.map(status => (\r\n                            <SelectItem key={status} value={status}>{status}</SelectItem>\r\n                          ))}\r\n                        </SelectContent>\r\n                      </Select>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Sorting Controls */}\r\n                  <div className=\"flex items-center gap-2 border-b pb-2\">\r\n                    <span className=\"text-sm text-muted-foreground\">Sort by:</span>\r\n                    <SortButton field=\"timestamp\">\r\n                      <Clock className=\"mr-1 h-3 w-3\" />\r\n                      Time\r\n                    </SortButton>\r\n                    <SortButton field=\"type\">\r\n                      <Package className=\"mr-1 h-3 w-3\" />\r\n                      Type\r\n                    </SortButton>\r\n                    <SortButton field=\"amount\">\r\n                      <DollarSign className=\"mr-1 h-3 w-3\" />\r\n                      Amount\r\n                    </SortButton>\r\n                  </div>\r\n\r\n                  {/* Activity List */}\r\n                  <div className=\"space-y-2 max-h-96 overflow-y-auto\">\r\n                    {filteredActivities.slice(0, maxItems).map((activity) => (\r\n                      <Card\r\n                        key={activity.id}\r\n                        className={`p-3 transition-colors hover:bg-muted/50 ${\r\n                          onItemClick ? 'cursor-pointer' : ''\r\n                        } ${activity.sanitized ? 'border-blue-200' : ''}`}\r\n                        onClick={() => onItemClick?.(activity)}\r\n                      >\r\n                        <div className=\"flex items-start justify-between\">\r\n                          <div className=\"flex-1 min-w-0\">\r\n                            <div className=\"flex items-center gap-2 mb-1\">\r\n                              <Badge variant=\"secondary\" className=\"text-xs\">\r\n                                {activity.type}\r\n                              </Badge>\r\n                              <Badge\r\n                                variant={activity.status === 'success' ? 'default' : 'outline'}\r\n                                className=\"text-xs\"\r\n                              >\r\n                                {activity.status}\r\n                              </Badge>\r\n                              <ActivityStatusIndicator activity={activity} />\r\n                            </div>\r\n\r\n                            <p className=\"text-sm font-medium mb-1 truncate\">\r\n                              {activity.description}\r\n                            </p>\r\n\r\n                            <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\r\n                              <div className=\"flex items-center gap-1\">\r\n                                <Clock className=\"h-3 w-3\" />\r\n                                {activity.timestamp || activity.created_at ? (\r\n                                  <>\r\n                                    <span>\r\n                                      {ActivityFormatter.timestamp(activity.timestamp || activity.created_at)}\r\n                                    </span>\r\n                                    <span className=\"text-xs opacity-60\">\r\n                                      ({ActivityFormatter.relativeTime(activity.timestamp || activity.created_at)})\r\n                                    </span>\r\n                                  </>\r\n                                ) : (\r\n                                  <InvalidDateFallback originalValue=\"No timestamp\" />\r\n                                )}\r\n                              </div>\r\n\r\n                              {activity.amount !== null && activity.amount !== undefined && (\r\n                                <div className=\"flex items-center gap-1\">\r\n                                  <DollarSign className=\"h-3 w-3\" />\r\n                                  <span>{ActivityFormatter.amount(activity.amount)}</span>\r\n                                </div>\r\n                              )}\r\n\r\n                              {activity.quantity !== null && activity.quantity !== undefined && (\r\n                                <div className=\"flex items-center gap-1\">\r\n                                  <Package className=\"h-3 w-3\" />\r\n                                  <span>{ActivityFormatter.quantity(activity.quantity)}</span>\r\n                                </div>\r\n                              )}\r\n\r\n                              {activity.user && (\r\n                                <span>by {activity.user}</span>\r\n                              )}\r\n                            </div>\r\n\r\n                            {/* Show validation errors if any */}\r\n                            {activity.validationErrors.length > 0 && (\r\n                              <Alert className=\"mt-2 border-yellow-200 bg-yellow-50\">\r\n                                <AlertTriangle className=\"h-3 w-3 text-yellow-600\" />\r\n                                <AlertDescription className=\"text-xs text-yellow-800\">\r\n                                  <strong>Data Issues:</strong> {activity.validationErrors.join(', ')}\r\n                                </AlertDescription>\r\n                              </Alert>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </Card>\r\n                    ))}\r\n\r\n                    {filteredActivities.length === 0 && (\r\n                      <Card className=\"p-8 text-center\">\r\n                        <div className=\"text-muted-foreground\">\r\n                          {searchTerm || filterType !== 'all' || filterStatus !== 'all' ? (\r\n                            <div>\r\n                              <Search className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\r\n                              <p>No activities match your current filters.</p>\r\n                              <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                className=\"mt-2\"\r\n                                onClick={() => {\r\n                                  setSearchTerm('')\r\n                                  setFilterType('all')\r\n                                  setFilterStatus('all')\r\n                                }}\r\n                              >\r\n                                Clear Filters\r\n                              </Button>\r\n                            </div>\r\n                          ) : (\r\n                            <div>\r\n                              <Activity className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\r\n                              <p>No activities found.</p>\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </Card>\r\n                    )}\r\n\r\n                    {filteredActivities.length > maxItems && (\r\n                      <Alert>\r\n                        <Info className=\"h-4 w-4\" />\r\n                        <AlertDescription>\r\n                          Showing {maxItems} of {filteredActivities.length} activities.\r\n                          Use filters to narrow down results.\r\n                        </AlertDescription>\r\n                      </Alert>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )\r\n            }}\r\n          </ActivityDataLoader>\r\n        </CardContent>\r\n      </Card>\r\n    </InventoryBoundary>\r\n  )\r\n}\r\n\r\nexport default BulletproofActivityList","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\BulletproofDataLoader.tsx","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token. Did you mean `{'>'}` or `&gt;`?","line":219,"column":59}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Bulletproof Data Loader Component\r\n * Handles all data loading states with comprehensive error recovery and graceful degradation\r\n * Specifically designed to handle timestamp errors and backend issues\r\n */\r\n\r\n'use client'\r\n\r\nimport React, { useState, useCallback, useEffect, useMemo } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Skeleton } from '@/components/ui/skeleton'\r\nimport { LoadingStateManager, MetricLoadingState } from '@/components/dashboard/LoadingStateManager'\r\nimport { useErrorRecovery, useApiRetry, useSafeAsync } from '@/hooks/useErrorRecovery'\r\nimport {\r\n  LoadingSkeleton,\r\n  DataError,\r\n  NetworkError,\r\n  ServerError,\r\n  InvalidDateFallback,\r\n  InvalidNumberFallback,\r\n  NoDataFound\r\n} from '@/components/fallbacks/FallbackComponents'\r\nimport {\r\n  AlertTriangle,\r\n  RefreshCw,\r\n  Loader2,\r\n  Clock,\r\n  Database,\r\n  Wifi,\r\n  Server,\r\n  Shield,\r\n  Activity,\r\n  CheckCircle,\r\n  XCircle,\r\n  WifiOff,\r\n  Timer\r\n} from 'lucide-react'\r\n\r\n// ============================================================================\r\n// TYPES & INTERFACES\r\n// ============================================================================\r\n\r\ninterface DataLoaderProps<T> {\r\n  loadData: () => Promise<T>\r\n  children: (data: T) => React.ReactNode\r\n\r\n  // Error handling options\r\n  fallbackComponent?: React.ReactNode\r\n  errorBoundary?: boolean\r\n\r\n  // Loading customization\r\n  loadingComponent?: React.ReactNode\r\n  loadingType?: 'skeleton' | 'spinner' | 'custom'\r\n  skeletonType?: 'table' | 'chart' | 'card' | 'list'\r\n\r\n  // Retry configuration\r\n  enableRetry?: boolean\r\n  maxRetries?: number\r\n  retryDelay?: number\r\n\r\n  // Data validation\r\n  validateData?: (data: T) => boolean\r\n  sanitizeData?: (data: T) => T\r\n\r\n  // Caching\r\n  enableCaching?: boolean\r\n  cacheKey?: string\r\n  cacheDuration?: number\r\n\r\n  // Auto-refresh\r\n  autoRefresh?: boolean\r\n  refreshInterval?: number\r\n\r\n  // Callback handlers\r\n  onError?: (error: Error) => void\r\n  onSuccess?: (data: T) => void\r\n  onRetry?: (attempt: number) => void\r\n\r\n  // UI customization\r\n  className?: string\r\n  emptyMessage?: string\r\n  errorTitle?: string\r\n}\r\n\r\ninterface CacheEntry<T> {\r\n  data: T\r\n  timestamp: number\r\n  expiresAt: number\r\n}\r\n\r\n// ============================================================================\r\n// CACHE MANAGEMENT\r\n// ============================================================================\r\n\r\nclass DataCache {\r\n  private static cache = new Map<string, CacheEntry<any>>()\r\n\r\n  static set<T>(key: string, data: T, duration: number): void {\r\n    const now = Date.now()\r\n    this.cache.set(key, {\r\n      data,\r\n      timestamp: now,\r\n      expiresAt: now + duration\r\n    })\r\n  }\r\n\r\n  static get<T>(key: string): T | null {\r\n    const entry = this.cache.get(key)\r\n    if (!entry) return null\r\n\r\n    if (Date.now() > entry.expiresAt) {\r\n      this.cache.delete(key)\r\n      return null\r\n    }\r\n\r\n    return entry.data\r\n  }\r\n\r\n  static clear(key?: string): void {\r\n    if (key) {\r\n      this.cache.delete(key)\r\n    } else {\r\n      this.cache.clear()\r\n    }\r\n  }\r\n\r\n  static getStats() {\r\n    return {\r\n      size: this.cache.size,\r\n      entries: Array.from(this.cache.entries()).map(([key, entry]) => ({\r\n        key,\r\n        age: Date.now() - entry.timestamp,\r\n        expires: entry.expiresAt - Date.now()\r\n      }))\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// DATA SANITIZATION UTILITIES\r\n// ============================================================================\r\n\r\nexport const DataSanitizers = {\r\n  /**\r\n   * Sanitize timestamp data to handle invalid dates gracefully\r\n   */\r\n  sanitizeTimestamp: (value: any): Date | null => {\r\n    if (!value) return null\r\n\r\n    try {\r\n      let date: Date\r\n\r\n      if (value instanceof Date) {\r\n        date = value\r\n      } else if (typeof value === 'string') {\r\n        // Handle various string formats\r\n        date = new Date(value)\r\n      } else if (typeof value === 'number') {\r\n        // Handle Unix timestamps (both seconds and milliseconds)\r\n        date = new Date(value > 1e10 ? value : value * 1000)\r\n      } else {\r\n        return null\r\n      }\r\n\r\n      // Check if date is valid\r\n      if (isNaN(date.getTime())) {\r\n        return null\r\n      }\r\n\r\n      // Check if date is reasonable (not too far in past/future)\r\n      const now = new Date()\r\n      const minDate = new Date('1970-01-01')\r\n      const maxDate = new Date(now.getFullYear() + 10, 11, 31)\r\n\r\n      if (date < minDate || date > maxDate) {\r\n        return null\r\n      }\r\n\r\n      return date\r\n    } catch (error) {\r\n      console.warn('Failed to sanitize timestamp:', value, error)\r\n      return null\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Sanitize numeric data to handle invalid numbers gracefully\r\n   */\r\n  sanitizeNumber: (value: any, fallback: number = 0): number => {\r\n    if (typeof value === 'number' && !isNaN(value) && isFinite(value)) {\r\n      return value\r\n    }\r\n\r\n    if (typeof value === 'string') {\r\n      const parsed = parseFloat(value.replace(/[^\\d.-]/g, ''))\r\n      if (!isNaN(parsed) && isFinite(parsed)) {\r\n        return parsed\r\n      }\r\n    }\r\n\r\n    return fallback\r\n  },\r\n\r\n  /**\r\n   * Sanitize string data to handle null/undefined gracefully\r\n   */\r\n  sanitizeString: (value: any, fallback: string = ''): string => {\r\n    if (typeof value === 'string') return value\r\n    if (value === null || value === undefined) return fallback\r\n    return String(value)\r\n  },\r\n\r\n  /**\r\n   * Sanitize array data to ensure it's always an array\r\n   */\r\n  sanitizeArray: <T>(value: any, fallback: T[] = []): T[] => {\r\n    if (Array.isArray(value)) return value\r\n    if (value === null || value === undefined) return fallback\r\n    return [value]\r\n  },\r\n\r\n  /**\r\n   * Comprehensive data sanitizer for common data structures\r\n   */\r\n  sanitizeActivityData: (data: any) => {\r\n    if (!data || typeof data !== 'object') return null\r\n\r\n    return {\r\n      ...data,\r\n      id: DataSanitizers.sanitizeString(data.id, `temp-${Date.now()}`),\r\n      timestamp: DataSanitizers.sanitizeTimestamp(data.timestamp),\r\n      created_at: DataSanitizers.sanitizeTimestamp(data.created_at),\r\n      updated_at: DataSanitizers.sanitizeTimestamp(data.updated_at),\r\n      amount: DataSanitizers.sanitizeNumber(data.amount),\r\n      quantity: DataSanitizers.sanitizeNumber(data.quantity),\r\n      price: DataSanitizers.sanitizeNumber(data.price),\r\n      total: DataSanitizers.sanitizeNumber(data.total),\r\n      name: DataSanitizers.sanitizeString(data.name, 'Unnamed Item'),\r\n      description: DataSanitizers.sanitizeString(data.description),\r\n      status: DataSanitizers.sanitizeString(data.status, 'unknown'),\r\n      type: DataSanitizers.sanitizeString(data.type, 'general')\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// CONNECTION STATUS DETECTOR\r\n// ============================================================================\r\n\r\nfunction useConnectionStatus() {\r\n  const [isOnline, setIsOnline] = useState(typeof navigator !== 'undefined' ? navigator.onLine : true)\r\n  const [connectionQuality, setConnectionQuality] = useState<'good' | 'poor' | 'offline'>('good')\r\n\r\n  useEffect(() => {\r\n    if (typeof window === 'undefined') return\r\n\r\n    const updateOnlineStatus = () => setIsOnline(navigator.onLine)\r\n\r\n    window.addEventListener('online', updateOnlineStatus)\r\n    window.addEventListener('offline', updateOnlineStatus)\r\n\r\n    // Simple connection quality test\r\n    const testConnection = async () => {\r\n      if (!navigator.onLine) {\r\n        setConnectionQuality('offline')\r\n        return\r\n      }\r\n\r\n      try {\r\n        const start = Date.now()\r\n        await fetch('/api/health', { method: 'HEAD', cache: 'no-cache' })\r\n        const duration = Date.now() - start\r\n\r\n        setConnectionQuality(duration < 1000 ? 'good' : 'poor')\r\n      } catch {\r\n        setConnectionQuality('poor')\r\n      }\r\n    }\r\n\r\n    testConnection()\r\n    const interval = setInterval(testConnection, 30000) // Test every 30s\r\n\r\n    return () => {\r\n      window.removeEventListener('online', updateOnlineStatus)\r\n      window.removeEventListener('offline', updateOnlineStatus)\r\n      clearInterval(interval)\r\n    }\r\n  }, [])\r\n\r\n  return { isOnline, connectionQuality }\r\n}\r\n\r\n// ============================================================================\r\n// BULLETPROOF DATA LOADER COMPONENT\r\n// ============================================================================\r\n\r\nexport function BulletproofDataLoader<T>({\r\n  loadData,\r\n  children,\r\n  fallbackComponent,\r\n  errorBoundary = true,\r\n  loadingComponent,\r\n  loadingType = 'skeleton',\r\n  skeletonType = 'card',\r\n  enableRetry = true,\r\n  maxRetries = 3,\r\n  retryDelay = 1000,\r\n  validateData = () => true,\r\n  sanitizeData,\r\n  enableCaching = false,\r\n  cacheKey,\r\n  cacheDuration = 5 * 60 * 1000, // 5 minutes\r\n  autoRefresh = false,\r\n  refreshInterval = 30000, // 30 seconds\r\n  onError,\r\n  onSuccess,\r\n  onRetry,\r\n  className = '',\r\n  emptyMessage,\r\n  errorTitle = 'Data Loading Error'\r\n}: DataLoaderProps<T>) {\r\n  const { isOnline, connectionQuality } = useConnectionStatus()\r\n\r\n  const [data, setData] = useState<T | null>(null)\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const [error, setError] = useState<Error | null>(null)\r\n  const [lastRefresh, setLastRefresh] = useState<Date>(new Date())\r\n  const [retryCount, setRetryCount] = useState(0)\r\n\r\n  const errorRecovery = useErrorRecovery({\r\n    retryConfig: {\r\n      maxRetries,\r\n      baseDelay: retryDelay,\r\n      maxDelay: retryDelay * 8,\r\n      jitter: true,\r\n      retryCondition: (error: Error, attempt: number) => {\r\n        // Don't retry if offline\r\n        if (!isOnline) return false\r\n\r\n        // Always retry network/timeout errors\r\n        if (error.message.includes('fetch') ||\r\n            error.message.includes('timeout') ||\r\n            error.message.includes('network')) {\r\n          return true\r\n        }\r\n\r\n        // Retry server errors (5xx)\r\n        if (error.message.includes('5')) return true\r\n\r\n        // Retry on first attempt for any error\r\n        return attempt === 1\r\n      }\r\n    },\r\n    onError: (error, attempt) => {\r\n      setRetryCount(attempt)\r\n      onError?.(error)\r\n      onRetry?.(attempt)\r\n    },\r\n    onRetrySuccess: (attempt) => {\r\n      setRetryCount(0)\r\n    },\r\n    showToast: false\r\n  })\r\n\r\n  // Load data with full error protection\r\n  const loadDataSafely = useCallback(async (bypassCache = false) => {\r\n    if (!isOnline) {\r\n      throw new Error('No internet connection')\r\n    }\r\n\r\n    setIsLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      // Check cache first\r\n      if (enableCaching && cacheKey && !bypassCache) {\r\n        const cachedData = DataCache.get<T>(cacheKey)\r\n        if (cachedData) {\r\n          setData(cachedData)\r\n          setIsLoading(false)\r\n          setLastRefresh(new Date())\r\n          onSuccess?.(cachedData)\r\n          return cachedData\r\n        }\r\n      }\r\n\r\n      // Load fresh data\r\n      const result = await errorRecovery.executeWithRetry(async () => {\r\n        const rawData = await loadData()\r\n\r\n        // Validate data\r\n        if (!validateData(rawData)) {\r\n          throw new Error('Data validation failed')\r\n        }\r\n\r\n        // Sanitize data if sanitizer provided\r\n        const cleanData = sanitizeData ? sanitizeData(rawData) : rawData\r\n\r\n        return cleanData\r\n      })\r\n\r\n      // Cache the result\r\n      if (enableCaching && cacheKey) {\r\n        DataCache.set(cacheKey, result, cacheDuration)\r\n      }\r\n\r\n      setData(result)\r\n      setError(null)\r\n      setLastRefresh(new Date())\r\n      onSuccess?.(result)\r\n\r\n      return result\r\n    } catch (error) {\r\n      const err = error as Error\r\n      setError(err)\r\n      setData(null)\r\n      onError?.(err)\r\n      throw err\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }, [\r\n    loadData, enableCaching, cacheKey, cacheDuration, validateData,\r\n    sanitizeData, isOnline, errorRecovery, onSuccess, onError\r\n  ])\r\n\r\n  // Initial load\r\n  useEffect(() => {\r\n    loadDataSafely().catch(() => {\r\n      // Error already handled in loadDataSafely\r\n    })\r\n  }, []) // Only run on mount\r\n\r\n  // Auto-refresh functionality\r\n  useEffect(() => {\r\n    if (!autoRefresh || !isOnline) return\r\n\r\n    const interval = setInterval(() => {\r\n      if (document.visibilityState === 'visible') {\r\n        loadDataSafely().catch(() => {\r\n          // Error already handled\r\n        })\r\n      }\r\n    }, refreshInterval)\r\n\r\n    return () => clearInterval(interval)\r\n  }, [autoRefresh, refreshInterval, isOnline, loadDataSafely])\r\n\r\n  // Manual retry function\r\n  const handleRetry = useCallback(() => {\r\n    loadDataSafely(true).catch(() => {\r\n      // Error already handled\r\n    })\r\n  }, [loadDataSafely])\r\n\r\n  // Render loading state\r\n  const renderLoading = () => {\r\n    if (loadingComponent) return loadingComponent\r\n\r\n    if (loadingType === 'spinner') {\r\n      return (\r\n        <div className=\"flex items-center justify-center py-8\">\r\n          <Loader2 className=\"h-8 w-8 animate-spin\" />\r\n          <span className=\"ml-2\">Loading...</span>\r\n        </div>\r\n      )\r\n    }\r\n\r\n    return <LoadingSkeleton type={skeletonType} />\r\n  }\r\n\r\n  // Render error state\r\n  const renderError = () => {\r\n    if (fallbackComponent) return fallbackComponent\r\n\r\n    // Offline state\r\n    if (!isOnline) {\r\n      return (\r\n        <Alert className=\"border-orange-200 bg-orange-50\">\r\n          <WifiOff className=\"h-4 w-4 text-orange-600\" />\r\n          <AlertDescription className=\"text-orange-800\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <div className=\"font-medium\">No Internet Connection</div>\r\n                <div className=\"text-sm opacity-80\">\r\n                  Please check your connection and try again.\r\n                </div>\r\n              </div>\r\n              <Button size=\"sm\" variant=\"outline\" onClick={handleRetry}>\r\n                <RefreshCw className=\"h-3 w-3 mr-1\" />\r\n                Retry\r\n              </Button>\r\n            </div>\r\n          </AlertDescription>\r\n        </Alert>\r\n      )\r\n    }\r\n\r\n    // Network/timeout errors\r\n    if (error?.message.includes('fetch') ||\r\n        error?.message.includes('timeout') ||\r\n        error?.message.includes('network')) {\r\n      return <NetworkError onRetry={enableRetry ? handleRetry : undefined} />\r\n    }\r\n\r\n    // Server errors\r\n    if (error?.message.includes('5')) {\r\n      const match = error.message.match(/(\\d{3})/)\r\n      const errorCode = match ? match[1] : undefined\r\n      return <ServerError errorCode={errorCode} onRetry={enableRetry ? handleRetry : undefined} />\r\n    }\r\n\r\n    // Generic error\r\n    return (\r\n      <DataError\r\n        title={errorTitle}\r\n        message={error?.message || 'An unexpected error occurred'}\r\n        onRetry={enableRetry ? handleRetry : undefined}\r\n      />\r\n    )\r\n  }\r\n\r\n  // Connection status indicator\r\n  const ConnectionStatus = () => (\r\n    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n      {isOnline ? (\r\n        <>\r\n          <div className={`w-2 h-2 rounded-full ${\r\n            connectionQuality === 'good' ? 'bg-green-500' :\r\n            connectionQuality === 'poor' ? 'bg-yellow-500' : 'bg-red-500'\r\n          }`} />\r\n          <span>\r\n            {connectionQuality === 'good' ? 'Connected' :\r\n             connectionQuality === 'poor' ? 'Slow connection' : 'Connection issues'}\r\n          </span>\r\n        </>\r\n      ) : (\r\n        <>\r\n          <WifiOff className=\"w-3 h-3 text-red-500\" />\r\n          <span>Offline</span>\r\n        </>\r\n      )}\r\n    </div>\r\n  )\r\n\r\n  // Retry status indicator\r\n  const RetryStatus = () => {\r\n    if (!errorRecovery.isRetrying && retryCount === 0) return null\r\n\r\n    return (\r\n      <div className=\"flex items-center gap-2 text-xs\">\r\n        {errorRecovery.isRetrying && (\r\n          <>\r\n            <Loader2 className=\"w-3 h-3 animate-spin\" />\r\n            <span>Retrying... ({retryCount}/{maxRetries})</span>\r\n          </>\r\n        )}\r\n        {retryCount > 0 && !errorRecovery.isRetrying && (\r\n          <Badge variant=\"outline\" className=\"text-xs\">\r\n            Retried {retryCount}x\r\n          </Badge>\r\n        )}\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Main render logic\r\n  const renderContent = () => {\r\n    if (isLoading && !data) {\r\n      return renderLoading()\r\n    }\r\n\r\n    if (error && !data) {\r\n      return renderError()\r\n    }\r\n\r\n    if (!data || (Array.isArray(data) && data.length === 0)) {\r\n      return <NoDataFound onRefresh={enableRetry ? handleRetry : undefined} />\r\n    }\r\n\r\n    return children(data)\r\n  }\r\n\r\n  return (\r\n    <div className={`bulletproof-data-loader ${className}`}>\r\n      {/* Status indicators */}\r\n      <div className=\"flex items-center justify-between mb-2\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <ConnectionStatus />\r\n          <RetryStatus />\r\n        </div>\r\n\r\n        {data && (\r\n          <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n            <Timer className=\"w-3 h-3\" />\r\n            <span>Last updated: {lastRefresh.toLocaleTimeString()}</span>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Main content */}\r\n      {renderContent()}\r\n    </div>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// SPECIALIZED DATA LOADERS\r\n// ============================================================================\r\n\r\n/**\r\n * Activity Data Loader with timestamp sanitization\r\n */\r\nexport function ActivityDataLoader<T extends { timestamp?: any; created_at?: any }>({\r\n  children,\r\n  ...props\r\n}: Omit<DataLoaderProps<T[]>, 'sanitizeData'> & {\r\n  children: (data: T[]) => React.ReactNode\r\n}) {\r\n  return (\r\n    <BulletproofDataLoader\r\n      {...props}\r\n      sanitizeData={(data: T[]) => {\r\n        return data.map(item => ({\r\n          ...item,\r\n          timestamp: DataSanitizers.sanitizeTimestamp(item.timestamp),\r\n          created_at: DataSanitizers.sanitizeTimestamp(item.created_at),\r\n          updated_at: DataSanitizers.sanitizeTimestamp((item as any).updated_at)\r\n        }))\r\n      }}\r\n      validateData={(data) => Array.isArray(data)}\r\n      skeletonType=\"table\"\r\n    >\r\n      {children}\r\n    </BulletproofDataLoader>\r\n  )\r\n}\r\n\r\n/**\r\n * Metrics Data Loader with number sanitization\r\n */\r\nexport function MetricsDataLoader<T extends Record<string, any>>({\r\n  children,\r\n  ...props\r\n}: Omit<DataLoaderProps<T>, 'sanitizeData'> & {\r\n  children: (data: T) => React.ReactNode\r\n}) {\r\n  return (\r\n    <BulletproofDataLoader\r\n      {...props}\r\n      sanitizeData={(data: T) => {\r\n        const sanitized = { ...data }\r\n\r\n        // Sanitize all numeric fields\r\n        Object.keys(sanitized).forEach(key => {\r\n          if (typeof sanitized[key] === 'number' ||\r\n              (typeof sanitized[key] === 'string' && !isNaN(Number(sanitized[key])))) {\r\n            sanitized[key] = DataSanitizers.sanitizeNumber(sanitized[key])\r\n          }\r\n        })\r\n\r\n        return sanitized\r\n      }}\r\n      skeletonType=\"card\"\r\n    >\r\n      {children}\r\n    </BulletproofDataLoader>\r\n  )\r\n}\r\n\r\nexport default BulletproofDataLoader","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\ResponsiveUIManager.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":6,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":6,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":121,"column":19,"nodeType":"Identifier","messageId":"undef","endLine":121,"endColumn":30},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":127,"column":21,"nodeType":"Identifier","messageId":"undef","endLine":127,"endColumn":32},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":135,"column":19,"nodeType":"Identifier","messageId":"undef","endLine":135,"endColumn":30},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":137,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":137,"endColumn":35},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":145,"column":21,"nodeType":"Identifier","messageId":"undef","endLine":145,"endColumn":32},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":146,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":146,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":160,"column":21,"nodeType":"Identifier","messageId":"undef","endLine":160,"endColumn":32},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":166,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":166,"endColumn":35},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":254,"column":18,"nodeType":"Identifier","messageId":"undef","endLine":254,"endColumn":29},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":265,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":265,"endColumn":35},{"ruleId":"jsx-a11y/no-static-element-interactions","severity":2,"message":"Avoid non-native interactive elements. If using native HTML is not possible, add an appropriate role and support for tabbing, mouse, keyboard, and touch inputs to an interactive content element.","line":456,"column":9,"nodeType":"JSXOpeningElement","endLine":459,"endColumn":10}],"suppressedMessages":[],"errorCount":12,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Responsive UI Manager\r\n * Ensures UI remains responsive and usable during backend issues\r\n */\r\n\r\n// @ts-nocheck\r\n'use client'\r\n\r\nimport React, { useState, useEffect, useCallback, createContext, useContext, useRef } from 'react'\r\nimport { Card, CardContent } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { toast } from 'sonner'\r\nimport {\r\n  Wifi,\r\n  WifiOff,\r\n  Server,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Clock,\r\n  Zap,\r\n  Gauge,\r\n  Activity,\r\n  Settings,\r\n  RefreshCw,\r\n  Pause,\r\n  Play,\r\n  X\r\n} from 'lucide-react'\r\n\r\n// ============================================================================\r\n// TYPES & INTERFACES\r\n// ============================================================================\r\n\r\ninterface PerformanceMetrics {\r\n  apiLatency: number\r\n  renderTime: number\r\n  memoryUsage: number\r\n  connectionQuality: 'excellent' | 'good' | 'poor' | 'offline'\r\n  backendHealth: 'healthy' | 'degraded' | 'down'\r\n  lastUpdate: Date\r\n}\r\n\r\ninterface UIState {\r\n  isResponsive: boolean\r\n  showOfflineMode: boolean\r\n  enableOptimizations: boolean\r\n  degradeAnimations: boolean\r\n  limitConcurrentRequests: boolean\r\n  maxConcurrentRequests: number\r\n  currentLoad: number\r\n}\r\n\r\ninterface ResponsiveUIContextValue {\r\n  metrics: PerformanceMetrics\r\n  uiState: UIState\r\n  updateMetrics: (metrics: Partial<PerformanceMetrics>) => void\r\n  toggleOfflineMode: () => void\r\n  toggleOptimizations: () => void\r\n  isPending: (operation: string) => boolean\r\n  startOperation: (operation: string) => void\r\n  endOperation: (operation: string) => void\r\n}\r\n\r\n// ============================================================================\r\n// CONTEXT\r\n// ============================================================================\r\n\r\nconst ResponsiveUIContext = createContext<ResponsiveUIContextValue | null>(null)\r\n\r\nexport function useResponsiveUI() {\r\n  const context = useContext(ResponsiveUIContext)\r\n  if (!context) {\r\n    throw new Error('useResponsiveUI must be used within ResponsiveUIProvider')\r\n  }\r\n  return context\r\n}\r\n\r\n// ============================================================================\r\n// PERFORMANCE MONITOR\r\n// ============================================================================\r\n\r\nclass PerformanceMonitor {\r\n  private static metrics: PerformanceMetrics = {\r\n    apiLatency: 0,\r\n    renderTime: 0,\r\n    memoryUsage: 0,\r\n    connectionQuality: 'good',\r\n    backendHealth: 'healthy',\r\n    lastUpdate: new Date()\r\n  }\r\n\r\n  private static observers = new Set<(metrics: PerformanceMetrics) => void>()\r\n\r\n  static getMetrics(): PerformanceMetrics {\r\n    return { ...this.metrics }\r\n  }\r\n\r\n  static updateMetrics(updates: Partial<PerformanceMetrics>) {\r\n    this.metrics = {\r\n      ...this.metrics,\r\n      ...updates,\r\n      lastUpdate: new Date()\r\n    }\r\n    this.notifyObservers()\r\n  }\r\n\r\n  static subscribe(observer: (metrics: PerformanceMetrics) => void): () => void {\r\n    this.observers.add(observer)\r\n    return () => this.observers.delete(observer)\r\n  }\r\n\r\n  private static notifyObservers() {\r\n    this.observers.forEach(observer => observer(this.metrics))\r\n  }\r\n\r\n  // Measure API latency\r\n  static async measureApiLatency(apiCall: () => Promise<any>): Promise<number> {\r\n    const start = performance.now()\r\n    try {\r\n      await apiCall()\r\n    } catch (error) {\r\n      // Still measure latency even if call fails\r\n    }\r\n    const latency = performance.now() - start\r\n\r\n    this.updateMetrics({ apiLatency: latency })\r\n    return latency\r\n  }\r\n\r\n  // Measure render time\r\n  static measureRenderTime(callback: () => void): number {\r\n    const start = performance.now()\r\n    callback()\r\n    const renderTime = performance.now() - start\r\n\r\n    this.updateMetrics({ renderTime })\r\n    return renderTime\r\n  }\r\n\r\n  // Get memory usage (if available)\r\n  static getMemoryUsage(): number {\r\n    if ('memory' in performance) {\r\n      const memory = (performance as any).memory\r\n      return memory.usedJSHeapSize / memory.jsHeapSizeLimit\r\n    }\r\n    return 0\r\n  }\r\n\r\n  // Test connection quality\r\n  static async testConnectionQuality(): Promise<void> {\r\n    if (!navigator.onLine) {\r\n      this.updateMetrics({ connectionQuality: 'offline' })\r\n      return\r\n    }\r\n\r\n    try {\r\n      const start = performance.now()\r\n      const response = await fetch('/api/health', {\r\n        method: 'HEAD',\r\n        cache: 'no-cache',\r\n        signal: AbortSignal.timeout(5000)\r\n      })\r\n      const duration = performance.now() - start\r\n\r\n      let quality: PerformanceMetrics['connectionQuality']\r\n      if (response.ok) {\r\n        if (duration < 100) quality = 'excellent'\r\n        else if (duration < 500) quality = 'good'\r\n        else quality = 'poor'\r\n      } else {\r\n        quality = 'poor'\r\n      }\r\n\r\n      this.updateMetrics({\r\n        connectionQuality: quality,\r\n        backendHealth: response.ok ? 'healthy' : 'degraded'\r\n      })\r\n    } catch {\r\n      this.updateMetrics({\r\n        connectionQuality: 'poor',\r\n        backendHealth: 'down'\r\n      })\r\n    }\r\n  }\r\n\r\n  // Start monitoring\r\n  static startMonitoring(): () => void {\r\n    // Test connection initially\r\n    this.testConnectionQuality()\r\n\r\n    // Monitor connection quality every 30 seconds\r\n    const connectionInterval = setInterval(() => {\r\n      this.testConnectionQuality()\r\n    }, 30000)\r\n\r\n    // Monitor memory usage every 10 seconds\r\n    const memoryInterval = setInterval(() => {\r\n      const memoryUsage = this.getMemoryUsage()\r\n      if (memoryUsage > 0) {\r\n        this.updateMetrics({ memoryUsage })\r\n      }\r\n    }, 10000)\r\n\r\n    // Listen for online/offline events\r\n    const handleOnline = () => this.testConnectionQuality()\r\n    const handleOffline = () => this.updateMetrics({\r\n      connectionQuality: 'offline',\r\n      backendHealth: 'down'\r\n    })\r\n\r\n    window.addEventListener('online', handleOnline)\r\n    window.addEventListener('offline', handleOffline)\r\n\r\n    // Return cleanup function\r\n    return () => {\r\n      clearInterval(connectionInterval)\r\n      clearInterval(memoryInterval)\r\n      window.removeEventListener('online', handleOnline)\r\n      window.removeEventListener('offline', handleOffline)\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// OPERATION TRACKER\r\n// ============================================================================\r\n\r\nclass OperationTracker {\r\n  private static operations = new Map<string, { startTime: number; priority: 'high' | 'medium' | 'low' }>()\r\n  private static maxConcurrent = 5\r\n  private static observers = new Set<(count: number) => void>()\r\n\r\n  static isPending(operation: string): boolean {\r\n    return this.operations.has(operation)\r\n  }\r\n\r\n  static getCurrentLoad(): number {\r\n    return this.operations.size\r\n  }\r\n\r\n  static canStart(): boolean {\r\n    return this.operations.size < this.maxConcurrent\r\n  }\r\n\r\n  static start(operation: string, priority: 'high' | 'medium' | 'low' = 'medium'): boolean {\r\n    if (!this.canStart() && priority !== 'high') {\r\n      return false\r\n    }\r\n\r\n    this.operations.set(operation, {\r\n      startTime: performance.now(),\r\n      priority\r\n    })\r\n\r\n    this.notifyObservers()\r\n    return true\r\n  }\r\n\r\n  static end(operation: string): void {\r\n    const op = this.operations.get(operation)\r\n    if (op) {\r\n      const duration = performance.now() - op.startTime\r\n      console.debug(`Operation \"${operation}\" completed in ${duration.toFixed(2)}ms`)\r\n\r\n      this.operations.delete(operation)\r\n      this.notifyObservers()\r\n    }\r\n  }\r\n\r\n  static setMaxConcurrent(max: number): void {\r\n    this.maxConcurrent = max\r\n  }\r\n\r\n  static subscribe(observer: (count: number) => void): () => void {\r\n    this.observers.add(observer)\r\n    return () => this.observers.delete(observer)\r\n  }\r\n\r\n  private static notifyObservers(): void {\r\n    this.observers.forEach(observer => observer(this.operations.size))\r\n  }\r\n\r\n  static getActiveOperations(): string[] {\r\n    return Array.from(this.operations.keys())\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// RESPONSIVE UI PROVIDER\r\n// ============================================================================\r\n\r\nexport const ResponsiveUIProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  const [metrics, setMetrics] = useState<PerformanceMetrics>(() => PerformanceMonitor.getMetrics())\r\n  const [currentLoad, setCurrentLoad] = useState(0)\r\n  const [uiState, setUIState] = useState<UIState>({\r\n    isResponsive: true,\r\n    showOfflineMode: false,\r\n    enableOptimizations: false,\r\n    degradeAnimations: false,\r\n    limitConcurrentRequests: true,\r\n    maxConcurrentRequests: 5,\r\n    currentLoad: 0\r\n  })\r\n\r\n  const cleanupRef = useRef<(() => void) | null>(null)\r\n\r\n  useEffect(() => {\r\n    // Start performance monitoring\r\n    cleanupRef.current = PerformanceMonitor.startMonitoring()\r\n\r\n    // Subscribe to metrics updates\r\n    const unsubscribeMetrics = PerformanceMonitor.subscribe(setMetrics)\r\n\r\n    // Subscribe to operation tracking\r\n    const unsubscribeOperations = OperationTracker.subscribe(setCurrentLoad)\r\n\r\n    return () => {\r\n      cleanupRef.current?.()\r\n      unsubscribeMetrics()\r\n      unsubscribeOperations()\r\n    }\r\n  }, [])\r\n\r\n  // Auto-adjust UI based on performance\r\n  useEffect(() => {\r\n    const shouldOptimize =\r\n      metrics.connectionQuality === 'poor' ||\r\n      metrics.backendHealth === 'degraded' ||\r\n      metrics.apiLatency > 2000 ||\r\n      metrics.memoryUsage > 0.8\r\n\r\n    const shouldShowOffline =\r\n      metrics.connectionQuality === 'offline' ||\r\n      metrics.backendHealth === 'down'\r\n\r\n    const shouldDegradeAnimations =\r\n      metrics.renderTime > 16 || // 60fps threshold\r\n      metrics.memoryUsage > 0.9\r\n\r\n    setUIState(prev => ({\r\n      ...prev,\r\n      enableOptimizations: shouldOptimize,\r\n      showOfflineMode: shouldShowOffline,\r\n      degradeAnimations: shouldDegradeAnimations,\r\n      currentLoad,\r\n      isResponsive: currentLoad < prev.maxConcurrentRequests\r\n    }))\r\n\r\n    // Adjust concurrent request limit based on performance\r\n    if (shouldOptimize) {\r\n      OperationTracker.setMaxConcurrent(Math.max(2, Math.floor(uiState.maxConcurrentRequests * 0.7)))\r\n    } else {\r\n      OperationTracker.setMaxConcurrent(uiState.maxConcurrentRequests)\r\n    }\r\n  }, [metrics, currentLoad, uiState.maxConcurrentRequests])\r\n\r\n  const updateMetrics = useCallback((updates: Partial<PerformanceMetrics>) => {\r\n    PerformanceMonitor.updateMetrics(updates)\r\n  }, [])\r\n\r\n  const toggleOfflineMode = useCallback(() => {\r\n    setUIState(prev => ({ ...prev, showOfflineMode: !prev.showOfflineMode }))\r\n  }, [])\r\n\r\n  const toggleOptimizations = useCallback(() => {\r\n    setUIState(prev => ({ ...prev, enableOptimizations: !prev.enableOptimizations }))\r\n  }, [])\r\n\r\n  const isPending = useCallback((operation: string) => {\r\n    return OperationTracker.isPending(operation)\r\n  }, [])\r\n\r\n  const startOperation = useCallback((operation: string) => {\r\n    return OperationTracker.start(operation)\r\n  }, [])\r\n\r\n  const endOperation = useCallback((operation: string) => {\r\n    OperationTracker.end(operation)\r\n  }, [])\r\n\r\n  const contextValue: ResponsiveUIContextValue = {\r\n    metrics,\r\n    uiState,\r\n    updateMetrics,\r\n    toggleOfflineMode,\r\n    toggleOptimizations,\r\n    isPending,\r\n    startOperation,\r\n    endOperation\r\n  }\r\n\r\n  return (\r\n    <ResponsiveUIContext.Provider value={contextValue}>\r\n      <div className={`responsive-ui-container ${uiState.degradeAnimations ? 'reduced-motion' : ''}`}>\r\n        {children}\r\n      </div>\r\n    </ResponsiveUIContext.Provider>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// PERFORMANCE STATUS INDICATOR\r\n// ============================================================================\r\n\r\nexport const PerformanceStatusIndicator: React.FC<{\r\n  compact?: boolean\r\n  showDetails?: boolean\r\n  className?: string\r\n}> = ({ compact = false, showDetails = false, className = '' }) => {\r\n  const { metrics, uiState } = useResponsiveUI()\r\n  const [isExpanded, setIsExpanded] = useState(false)\r\n\r\n  const getConnectionIcon = () => {\r\n    switch (metrics.connectionQuality) {\r\n      case 'excellent':\r\n      case 'good':\r\n        return <Wifi className=\"h-3 w-3 text-green-500\" />\r\n      case 'poor':\r\n        return <Wifi className=\"h-3 w-3 text-yellow-500\" />\r\n      case 'offline':\r\n        return <WifiOff className=\"h-3 w-3 text-red-500\" />\r\n    }\r\n  }\r\n\r\n  const getHealthIcon = () => {\r\n    switch (metrics.backendHealth) {\r\n      case 'healthy':\r\n        return <CheckCircle className=\"h-3 w-3 text-green-500\" />\r\n      case 'degraded':\r\n        return <AlertTriangle className=\"h-3 w-3 text-yellow-500\" />\r\n      case 'down':\r\n        return <Server className=\"h-3 w-3 text-red-500\" />\r\n    }\r\n  }\r\n\r\n  if (compact) {\r\n    return (\r\n      <div className={`flex items-center gap-1 ${className}`}>\r\n        {getConnectionIcon()}\r\n        {getHealthIcon()}\r\n        {uiState.currentLoad > 0 && (\r\n          <Badge variant=\"outline\" className=\"text-xs\">\r\n            {uiState.currentLoad}\r\n          </Badge>\r\n        )}\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <Card className={`w-full max-w-md ${className}`}>\r\n      <CardContent className=\"p-3\">\r\n        <div\r\n          className=\"flex items-center justify-between cursor-pointer\"\r\n          onClick={() => setIsExpanded(!isExpanded)}\r\n        >\r\n          <div className=\"flex items-center gap-2\">\r\n            <Activity className=\"h-4 w-4\" />\r\n            <span className=\"text-sm font-medium\">System Status</span>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            {getConnectionIcon()}\r\n            {getHealthIcon()}\r\n            {isExpanded ? <X className=\"h-3 w-3\" /> : <Settings className=\"h-3 w-3\" />}\r\n          </div>\r\n        </div>\r\n\r\n        {(isExpanded || showDetails) && (\r\n          <div className=\"mt-3 space-y-2\">\r\n            {/* Connection Quality */}\r\n            <div className=\"flex items-center justify-between text-xs\">\r\n              <span>Connection:</span>\r\n              <Badge\r\n                variant={\r\n                  metrics.connectionQuality === 'excellent' || metrics.connectionQuality === 'good'\r\n                    ? 'default'\r\n                    : metrics.connectionQuality === 'poor'\r\n                    ? 'secondary'\r\n                    : 'destructive'\r\n                }\r\n              >\r\n                {metrics.connectionQuality}\r\n              </Badge>\r\n            </div>\r\n\r\n            {/* Backend Health */}\r\n            <div className=\"flex items-center justify-between text-xs\">\r\n              <span>Backend:</span>\r\n              <Badge\r\n                variant={\r\n                  metrics.backendHealth === 'healthy'\r\n                    ? 'default'\r\n                    : metrics.backendHealth === 'degraded'\r\n                    ? 'secondary'\r\n                    : 'destructive'\r\n                }\r\n              >\r\n                {metrics.backendHealth}\r\n              </Badge>\r\n            </div>\r\n\r\n            {/* API Latency */}\r\n            <div className=\"space-y-1\">\r\n              <div className=\"flex items-center justify-between text-xs\">\r\n                <span>API Latency:</span>\r\n                <span>{Math.round(metrics.apiLatency)}ms</span>\r\n              </div>\r\n              <Progress\r\n                value={Math.min(100, (metrics.apiLatency / 2000) * 100)}\r\n                className=\"h-1\"\r\n              />\r\n            </div>\r\n\r\n            {/* Active Operations */}\r\n            <div className=\"flex items-center justify-between text-xs\">\r\n              <span>Active Operations:</span>\r\n              <Badge variant=\"outline\">\r\n                {uiState.currentLoad}/{uiState.maxConcurrentRequests}\r\n              </Badge>\r\n            </div>\r\n\r\n            {/* Memory Usage */}\r\n            {metrics.memoryUsage > 0 && (\r\n              <div className=\"space-y-1\">\r\n                <div className=\"flex items-center justify-between text-xs\">\r\n                  <span>Memory:</span>\r\n                  <span>{Math.round(metrics.memoryUsage * 100)}%</span>\r\n                </div>\r\n                <Progress\r\n                  value={metrics.memoryUsage * 100}\r\n                  className=\"h-1\"\r\n                />\r\n              </div>\r\n            )}\r\n\r\n            {/* Optimizations Status */}\r\n            {uiState.enableOptimizations && (\r\n              <Alert className=\"border-blue-200 bg-blue-50\">\r\n                <Zap className=\"h-3 w-3 text-blue-600\" />\r\n                <AlertDescription className=\"text-xs text-blue-800\">\r\n                  Performance optimizations active\r\n                </AlertDescription>\r\n              </Alert>\r\n            )}\r\n\r\n            {/* Offline Mode */}\r\n            {uiState.showOfflineMode && (\r\n              <Alert className=\"border-orange-200 bg-orange-50\">\r\n                <WifiOff className=\"h-3 w-3 text-orange-600\" />\r\n                <AlertDescription className=\"text-xs text-orange-800\">\r\n                  Offline mode active\r\n                </AlertDescription>\r\n              </Alert>\r\n            )}\r\n\r\n            {/* Last Update */}\r\n            <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\r\n              <span>Last update:</span>\r\n              <span>{metrics.lastUpdate.toLocaleTimeString()}</span>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// OPERATION MANAGER COMPONENT\r\n// ============================================================================\r\n\r\nexport const OperationManager: React.FC<{\r\n  children: React.ReactNode\r\n  operationName: string\r\n  priority?: 'high' | 'medium' | 'low'\r\n  fallback?: React.ReactNode\r\n  showProgress?: boolean\r\n}> = ({ children, operationName, priority = 'medium', fallback, showProgress = false }) => {\r\n  const { isPending, startOperation, endOperation, uiState } = useResponsiveUI()\r\n  const [isOperationPending, setIsOperationPending] = useState(false)\r\n\r\n  const executeOperation = useCallback(async (operation: () => Promise<any>) => {\r\n    if (!uiState.isResponsive && priority !== 'high') {\r\n      toast.warning('System is busy. Please wait and try again.')\r\n      return\r\n    }\r\n\r\n    if (!startOperation(operationName)) {\r\n      toast.warning('Too many operations running. Please wait.')\r\n      return\r\n    }\r\n\r\n    setIsOperationPending(true)\r\n\r\n    try {\r\n      await operation()\r\n    } finally {\r\n      endOperation(operationName)\r\n      setIsOperationPending(false)\r\n    }\r\n  }, [operationName, priority, startOperation, endOperation, uiState.isResponsive])\r\n\r\n  if (isOperationPending && fallback) {\r\n    return <>{fallback}</>\r\n  }\r\n\r\n  if (showProgress && isOperationPending) {\r\n    return (\r\n      <div className=\"flex items-center gap-2 p-2\">\r\n        <RefreshCw className=\"h-4 w-4 animate-spin\" />\r\n        <span className=\"text-sm\">Processing {operationName}...</span>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return <>{children}</>\r\n}\r\n\r\n// ============================================================================\r\n// SMART LOADING WRAPPER\r\n// ============================================================================\r\n\r\nexport const SmartLoadingWrapper: React.FC<{\r\n  children: React.ReactNode\r\n  fallback?: React.ReactNode\r\n  threshold?: number\r\n}> = ({ children, fallback, threshold = 3 }) => {\r\n  const { uiState } = useResponsiveUI()\r\n\r\n  if (uiState.currentLoad >= threshold && fallback) {\r\n    return <>{fallback}</>\r\n  }\r\n\r\n  return <>{children}</>\r\n}\r\n\r\n// ============================================================================\r\n// CSS FOR REDUCED MOTION\r\n// ============================================================================\r\n\r\nconst reducedMotionStyles = `\r\n  .reduced-motion * {\r\n    animation-duration: 0.01ms !important;\r\n    animation-iteration-count: 1 !important;\r\n    transition-duration: 0.01ms !important;\r\n    scroll-behavior: auto !important;\r\n  }\r\n`\r\n\r\n// Inject styles if not already present\r\nif (typeof document !== 'undefined' && !document.getElementById('reduced-motion-styles')) {\r\n  const style = document.createElement('style')\r\n  style.id = 'reduced-motion-styles'\r\n  style.textContent = reducedMotionStyles\r\n  document.head.appendChild(style)\r\n}\r\n\r\nexport default ResponsiveUIProvider","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\SafeLink.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLAnchorElement' is not defined.","line":9,"column":65,"nodeType":"Identifier","messageId":"undef","endLine":9,"endColumn":82}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SafeLink component - A wrapper for anchor tags that sanitizes URLs\r\n * to prevent javascript: and other dangerous URL schemes\r\n */\r\n\r\nimport React from 'react';\r\nimport { sanitizeUrl } from '@/lib/utils/url-validation';\r\n\r\ninterface SafeLinkProps extends Omit<React.AnchorHTMLAttributes<HTMLAnchorElement>, 'href'> {\r\n  href: string | null | undefined;\r\n  children: React.ReactNode;\r\n  fallback?: React.ReactNode;\r\n}\r\n\r\n/**\r\n * SafeLink component that sanitizes URLs before rendering\r\n * Returns fallback content (or null) if URL is unsafe\r\n */\r\nexport function SafeLink({ href, children, fallback = null, ...props }: SafeLinkProps) {\r\n  const safeUrl = sanitizeUrl(href);\r\n  \r\n  if (!safeUrl) {\r\n    return <>{fallback}</>;\r\n  }\r\n  \r\n  return (\r\n    <a href={safeUrl} {...props}>\r\n      {children}\r\n    </a>\r\n  );\r\n}\r\n\r\n/**\r\n * Hook to get a safe URL or null if unsafe\r\n */\r\nexport function useSafeUrl(url: string | null | undefined): string | null {\r\n  return sanitizeUrl(url);\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\SystemHealthMonitor.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":6,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":6,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":212,"column":19,"nodeType":"Identifier","messageId":"undef","endLine":212,"endColumn":30},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":220,"column":28,"nodeType":"Identifier","messageId":"undef","endLine":220,"endColumn":39},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":230,"column":28,"nodeType":"Identifier","messageId":"undef","endLine":230,"endColumn":39},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":309,"column":21,"nodeType":"Identifier","messageId":"undef","endLine":309,"endColumn":32},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":310,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":310,"endColumn":34}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * System Health Monitor\r\n * Comprehensive monitoring and auto-recovery system for the entire application\r\n */\r\n\r\n// @ts-nocheck\r\n'use client'\r\n\r\nimport React, { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport { ResponsiveUIProvider, PerformanceStatusIndicator, useResponsiveUI } from './ResponsiveUIManager'\r\nimport { resilientFetch } from '@/utils/resilientApi'\r\nimport { toast } from 'sonner'\r\nimport {\r\n  Activity,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  Clock,\r\n  Database,\r\n  Gauge,\r\n  Heart,\r\n  RefreshCw,\r\n  Server,\r\n  Shield,\r\n  TrendingDown,\r\n  TrendingUp,\r\n  Wifi,\r\n  WifiOff,\r\n  Zap,\r\n  Settings,\r\n  Eye,\r\n  EyeOff,\r\n  Download,\r\n  Upload,\r\n  HardDrive,\r\n  Cpu,\r\n  MemoryStick,\r\n  Network,\r\n  Globe,\r\n  Lock,\r\n  Unlock,\r\n  XCircle,\r\n  CheckSquare,\r\n  AlertCircle,\r\n  Info\r\n} from 'lucide-react'\r\n\r\n// ============================================================================\r\n// TYPES & INTERFACES\r\n// ============================================================================\r\n\r\ninterface HealthStatus {\r\n  overall: 'healthy' | 'warning' | 'critical' | 'unknown'\r\n  database: 'connected' | 'slow' | 'disconnected' | 'error'\r\n  api: 'responsive' | 'slow' | 'timeout' | 'error'\r\n  network: 'excellent' | 'good' | 'poor' | 'offline'\r\n  memory: 'normal' | 'high' | 'critical'\r\n  storage: 'normal' | 'high' | 'full'\r\n  security: 'secure' | 'warning' | 'breach'\r\n  lastCheck: Date\r\n}\r\n\r\ninterface HealthMetrics {\r\n  responseTime: number\r\n  errorRate: number\r\n  throughput: number\r\n  memoryUsage: number\r\n  storageUsage: number\r\n  activeConnections: number\r\n  uptime: number\r\n  lastError?: Error\r\n}\r\n\r\ninterface HealthCheck {\r\n  name: string\r\n  url: string\r\n  timeout: number\r\n  criticalThreshold: number\r\n  warningThreshold: number\r\n  enabled: boolean\r\n}\r\n\r\ninterface SystemAlert {\r\n  id: string\r\n  type: 'error' | 'warning' | 'info'\r\n  message: string\r\n  timestamp: Date\r\n  resolved: boolean\r\n  component: string\r\n}\r\n\r\n// ============================================================================\r\n// HEALTH CHECK CONFIGURATIONS\r\n// ============================================================================\r\n\r\nconst DEFAULT_HEALTH_CHECKS: HealthCheck[] = [\r\n  {\r\n    name: 'Database',\r\n    url: '/api/health/database',\r\n    timeout: 5000,\r\n    criticalThreshold: 3000,\r\n    warningThreshold: 1000,\r\n    enabled: true\r\n  },\r\n  {\r\n    name: 'API Gateway',\r\n    url: '/api/health',\r\n    timeout: 3000,\r\n    criticalThreshold: 2000,\r\n    warningThreshold: 500,\r\n    enabled: true\r\n  },\r\n  {\r\n    name: 'Authentication',\r\n    url: '/api/auth/health',\r\n    timeout: 3000,\r\n    criticalThreshold: 2000,\r\n    warningThreshold: 800,\r\n    enabled: true\r\n  },\r\n  {\r\n    name: 'File Storage',\r\n    url: '/api/health/storage',\r\n    timeout: 5000,\r\n    criticalThreshold: 4000,\r\n    warningThreshold: 2000,\r\n    enabled: true\r\n  }\r\n]\r\n\r\n// ============================================================================\r\n// HEALTH MONITOR CLASS\r\n// ============================================================================\r\n\r\nclass HealthMonitor {\r\n  private static instance: HealthMonitor\r\n  private healthChecks: HealthCheck[] = DEFAULT_HEALTH_CHECKS\r\n  private status: HealthStatus = {\r\n    overall: 'unknown',\r\n    database: 'disconnected',\r\n    api: 'error',\r\n    network: 'offline',\r\n    memory: 'normal',\r\n    storage: 'normal',\r\n    security: 'secure',\r\n    lastCheck: new Date()\r\n  }\r\n  private metrics: HealthMetrics = {\r\n    responseTime: 0,\r\n    errorRate: 0,\r\n    throughput: 0,\r\n    memoryUsage: 0,\r\n    storageUsage: 0,\r\n    activeConnections: 0,\r\n    uptime: 0\r\n  }\r\n  private alerts: SystemAlert[] = []\r\n  private observers = new Set<(status: HealthStatus, metrics: HealthMetrics, alerts: SystemAlert[]) => void>()\r\n  private checkInterval: NodeJS.Timeout | null = null\r\n  private readonly checkIntervalMs = 30000 // 30 seconds\r\n\r\n  static getInstance(): HealthMonitor {\r\n    if (!this.instance) {\r\n      this.instance = new HealthMonitor()\r\n    }\r\n    return this.instance\r\n  }\r\n\r\n  subscribe(observer: (status: HealthStatus, metrics: HealthMetrics, alerts: SystemAlert[]) => void): () => void {\r\n    this.observers.add(observer)\r\n    // Immediately send current state\r\n    observer(this.status, this.metrics, this.alerts)\r\n    return () => this.observers.delete(observer)\r\n  }\r\n\r\n  private notifyObservers(): void {\r\n    this.observers.forEach(observer => observer(this.status, this.metrics, this.alerts))\r\n  }\r\n\r\n  private addAlert(type: SystemAlert['type'], message: string, component: string): void {\r\n    const alert: SystemAlert = {\r\n      id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      type,\r\n      message,\r\n      timestamp: new Date(),\r\n      resolved: false,\r\n      component\r\n    }\r\n\r\n    this.alerts.unshift(alert)\r\n\r\n    // Keep only last 50 alerts\r\n    if (this.alerts.length > 50) {\r\n      this.alerts = this.alerts.slice(0, 50)\r\n    }\r\n\r\n    // Show toast for critical alerts\r\n    if (type === 'error') {\r\n      toast.error(`System Alert: ${message}`)\r\n    } else if (type === 'warning') {\r\n      toast.warning(`Warning: ${message}`)\r\n    }\r\n  }\r\n\r\n  private async checkEndpoint(check: HealthCheck): Promise<{ status: 'healthy' | 'warning' | 'critical', responseTime: number }> {\r\n    const start = performance.now()\r\n\r\n    try {\r\n      const response = await resilientFetch.get(check.url, {\r\n        timeout: check.timeout,\r\n        retries: 1\r\n      })\r\n\r\n      const responseTime = performance.now() - start\r\n\r\n      if (responseTime > check.criticalThreshold) {\r\n        return { status: 'critical', responseTime }\r\n      } else if (responseTime > check.warningThreshold) {\r\n        return { status: 'warning', responseTime }\r\n      } else {\r\n        return { status: 'healthy', responseTime }\r\n      }\r\n    } catch (error) {\r\n      const responseTime = performance.now() - start\r\n      throw { error, responseTime }\r\n    }\r\n  }\r\n\r\n  private async performHealthChecks(): Promise<void> {\r\n    console.log('Performing health checks...')\r\n\r\n    const results = await Promise.allSettled(\r\n      this.healthChecks\r\n        .filter(check => check.enabled)\r\n        .map(async (check) => {\r\n          try {\r\n            const result = await this.checkEndpoint(check)\r\n            return { check, ...result, error: null }\r\n          } catch (err: any) {\r\n            return {\r\n              check,\r\n              status: 'critical' as const,\r\n              responseTime: err.responseTime || 0,\r\n              error: err.error\r\n            }\r\n          }\r\n        })\r\n    )\r\n\r\n    // Process results\r\n    let databaseStatus: HealthStatus['database'] = 'disconnected'\r\n    let apiStatus: HealthStatus['api'] = 'error'\r\n    let overallStatus: HealthStatus['overall'] = 'healthy'\r\n\r\n    let totalResponseTime = 0\r\n    let errorCount = 0\r\n    let totalChecks = 0\r\n\r\n    results.forEach((result, index) => {\r\n      if (result.status === 'fulfilled') {\r\n        const { check, status, responseTime, error } = result.value\r\n        totalResponseTime += responseTime\r\n        totalChecks++\r\n\r\n        if (error) {\r\n          errorCount++\r\n          this.addAlert('error', `${check.name} health check failed: ${error.message}`, check.name)\r\n        } else if (status === 'critical') {\r\n          this.addAlert('error', `${check.name} is responding slowly (${Math.round(responseTime)}ms)`, check.name)\r\n          overallStatus = 'critical'\r\n        } else if (status === 'warning') {\r\n          this.addAlert('warning', `${check.name} has elevated response time (${Math.round(responseTime)}ms)`, check.name)\r\n          if (overallStatus === 'healthy') overallStatus = 'warning'\r\n        }\r\n\r\n        // Map specific endpoints to status\r\n        switch (check.name) {\r\n          case 'Database':\r\n            databaseStatus = error ? 'error' :\r\n                           status === 'critical' ? 'disconnected' :\r\n                           status === 'warning' ? 'slow' : 'connected'\r\n            break\r\n          case 'API Gateway':\r\n            apiStatus = error ? 'error' :\r\n                       status === 'critical' ? 'timeout' :\r\n                       status === 'warning' ? 'slow' : 'responsive'\r\n            break\r\n        }\r\n      } else {\r\n        errorCount++\r\n        totalChecks++\r\n        overallStatus = 'critical'\r\n      }\r\n    })\r\n\r\n    // Check network status\r\n    const networkStatus = navigator.onLine ?\r\n      (totalResponseTime / Math.max(totalChecks, 1) < 500 ? 'excellent' :\r\n       totalResponseTime / Math.max(totalChecks, 1) < 1000 ? 'good' : 'poor') : 'offline'\r\n\r\n    // Check memory usage\r\n    let memoryStatus: HealthStatus['memory'] = 'normal'\r\n    if ('memory' in performance) {\r\n      const memory = (performance as any).memory\r\n      const usage = memory.usedJSHeapSize / memory.jsHeapSizeLimit\r\n      if (usage > 0.9) memoryStatus = 'critical'\r\n      else if (usage > 0.7) memoryStatus = 'high'\r\n      this.metrics.memoryUsage = usage\r\n    }\r\n\r\n    // Update status\r\n    this.status = {\r\n      overall: overallStatus,\r\n      database: databaseStatus,\r\n      api: apiStatus,\r\n      network: networkStatus,\r\n      memory: memoryStatus,\r\n      storage: 'normal', // TODO: Implement storage check\r\n      security: 'secure', // TODO: Implement security check\r\n      lastCheck: new Date()\r\n    }\r\n\r\n    // Update metrics\r\n    this.metrics = {\r\n      ...this.metrics,\r\n      responseTime: totalResponseTime / Math.max(totalChecks, 1),\r\n      errorRate: errorCount / Math.max(totalChecks, 1),\r\n      uptime: this.metrics.uptime + (this.checkIntervalMs / 1000)\r\n    }\r\n\r\n    this.notifyObservers()\r\n  }\r\n\r\n  start(): void {\r\n    if (this.checkInterval) {\r\n      this.stop()\r\n    }\r\n\r\n    // Perform initial check\r\n    this.performHealthChecks()\r\n\r\n    // Start periodic checks\r\n    this.checkInterval = setInterval(() => {\r\n      this.performHealthChecks()\r\n    }, this.checkIntervalMs)\r\n\r\n    console.log('Health monitoring started')\r\n  }\r\n\r\n  stop(): void {\r\n    if (this.checkInterval) {\r\n      clearInterval(this.checkInterval)\r\n      this.checkInterval = null\r\n    }\r\n    console.log('Health monitoring stopped')\r\n  }\r\n\r\n  getStatus(): HealthStatus {\r\n    return { ...this.status }\r\n  }\r\n\r\n  getMetrics(): HealthMetrics {\r\n    return { ...this.metrics }\r\n  }\r\n\r\n  getAlerts(): SystemAlert[] {\r\n    return [...this.alerts]\r\n  }\r\n\r\n  resolveAlert(alertId: string): void {\r\n    const alert = this.alerts.find(a => a.id === alertId)\r\n    if (alert) {\r\n      alert.resolved = true\r\n      this.notifyObservers()\r\n    }\r\n  }\r\n\r\n  clearResolvedAlerts(): void {\r\n    this.alerts = this.alerts.filter(alert => !alert.resolved)\r\n    this.notifyObservers()\r\n  }\r\n\r\n  updateHealthChecks(checks: HealthCheck[]): void {\r\n    this.healthChecks = checks\r\n  }\r\n\r\n  forceCheck(): void {\r\n    this.performHealthChecks()\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// HEALTH STATUS COMPONENTS\r\n// ============================================================================\r\n\r\nconst StatusIcon: React.FC<{ status: string; type: 'overall' | 'component' }> = ({ status, type }) => {\r\n  const getIcon = () => {\r\n    switch (status) {\r\n      case 'healthy':\r\n      case 'responsive':\r\n      case 'connected':\r\n      case 'excellent':\r\n      case 'good':\r\n      case 'normal':\r\n      case 'secure':\r\n        return <CheckCircle className=\"h-4 w-4 text-green-500\" />\r\n      case 'warning':\r\n      case 'slow':\r\n      case 'poor':\r\n      case 'high':\r\n        return <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />\r\n      case 'critical':\r\n      case 'error':\r\n      case 'timeout':\r\n      case 'disconnected':\r\n      case 'offline':\r\n      case 'full':\r\n      case 'breach':\r\n        return <XCircle className=\"h-4 w-4 text-red-500\" />\r\n      default:\r\n        return <AlertCircle className=\"h-4 w-4 text-gray-500\" />\r\n    }\r\n  }\r\n\r\n  return getIcon()\r\n}\r\n\r\nconst StatusBadge: React.FC<{ status: string }> = ({ status }) => {\r\n  const getVariant = () => {\r\n    switch (status) {\r\n      case 'healthy':\r\n      case 'responsive':\r\n      case 'connected':\r\n      case 'excellent':\r\n      case 'good':\r\n      case 'normal':\r\n      case 'secure':\r\n        return 'default'\r\n      case 'warning':\r\n      case 'slow':\r\n      case 'poor':\r\n      case 'high':\r\n        return 'secondary'\r\n      case 'critical':\r\n      case 'error':\r\n      case 'timeout':\r\n      case 'disconnected':\r\n      case 'offline':\r\n      case 'full':\r\n      case 'breach':\r\n        return 'destructive'\r\n      default:\r\n        return 'outline'\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Badge variant={getVariant()}>\r\n      {status}\r\n    </Badge>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// MAIN SYSTEM HEALTH MONITOR COMPONENT\r\n// ============================================================================\r\n\r\nexport const SystemHealthMonitor: React.FC<{\r\n  showCompact?: boolean\r\n  autoStart?: boolean\r\n  className?: string\r\n}> = ({ showCompact = false, autoStart = true, className = '' }) => {\r\n  const [status, setStatus] = useState<HealthStatus>(() => HealthMonitor.getInstance().getStatus())\r\n  const [metrics, setMetrics] = useState<HealthMetrics>(() => HealthMonitor.getInstance().getMetrics())\r\n  const [alerts, setAlerts] = useState<SystemAlert[]>(() => HealthMonitor.getInstance().getAlerts())\r\n  const [isExpanded, setIsExpanded] = useState(false)\r\n  const [activeTab, setActiveTab] = useState('overview')\r\n  const monitorRef = useRef<HealthMonitor>()\r\n\r\n  useEffect(() => {\r\n    monitorRef.current = HealthMonitor.getInstance()\r\n\r\n    const unsubscribe = monitorRef.current.subscribe((status, metrics, alerts) => {\r\n      setStatus(status)\r\n      setMetrics(metrics)\r\n      setAlerts(alerts)\r\n    })\r\n\r\n    if (autoStart) {\r\n      monitorRef.current.start()\r\n    }\r\n\r\n    return () => {\r\n      unsubscribe()\r\n      if (autoStart) {\r\n        monitorRef.current?.stop()\r\n      }\r\n    }\r\n  }, [autoStart])\r\n\r\n  const handleForceCheck = useCallback(() => {\r\n    monitorRef.current?.forceCheck()\r\n    toast.info('Health check initiated')\r\n  }, [])\r\n\r\n  const handleResolveAlert = useCallback((alertId: string) => {\r\n    monitorRef.current?.resolveAlert(alertId)\r\n  }, [])\r\n\r\n  const handleClearResolved = useCallback(() => {\r\n    monitorRef.current?.clearResolvedAlerts()\r\n  }, [])\r\n\r\n  const unresolvedAlerts = alerts.filter(alert => !alert.resolved)\r\n\r\n  if (showCompact) {\r\n    return (\r\n      <div className={`flex items-center gap-2 ${className}`}>\r\n        <StatusIcon status={status.overall} type=\"overall\" />\r\n        <span className=\"text-sm font-medium\">\r\n          System {status.overall}\r\n        </span>\r\n        {unresolvedAlerts.length > 0 && (\r\n          <Badge variant=\"destructive\" className=\"text-xs\">\r\n            {unresolvedAlerts.length}\r\n          </Badge>\r\n        )}\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => setIsExpanded(!isExpanded)}\r\n        >\r\n          {isExpanded ? <EyeOff className=\"h-3 w-3\" /> : <Eye className=\"h-3 w-3\" />}\r\n        </Button>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <Card className={`w-full ${className}`}>\r\n      <CardHeader>\r\n        <div className=\"flex items-center justify-between\">\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Heart className=\"h-5 w-5\" />\r\n            System Health Monitor\r\n            <StatusIcon status={status.overall} type=\"overall\" />\r\n          </CardTitle>\r\n          <div className=\"flex items-center gap-2\">\r\n            {unresolvedAlerts.length > 0 && (\r\n              <Badge variant=\"destructive\">\r\n                {unresolvedAlerts.length} alerts\r\n              </Badge>\r\n            )}\r\n            <Button variant=\"outline\" size=\"sm\" onClick={handleForceCheck}>\r\n              <RefreshCw className=\"h-3 w-3 mr-1\" />\r\n              Check Now\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n\r\n      <CardContent>\r\n        <Tabs value={activeTab} onValueChange={setActiveTab}>\r\n          <TabsList className=\"grid w-full grid-cols-4\">\r\n            <TabsTrigger value=\"overview\">Overview</TabsTrigger>\r\n            <TabsTrigger value=\"metrics\">Metrics</TabsTrigger>\r\n            <TabsTrigger value=\"alerts\">Alerts</TabsTrigger>\r\n            <TabsTrigger value=\"settings\">Settings</TabsTrigger>\r\n          </TabsList>\r\n\r\n          <TabsContent value=\"overview\" className=\"space-y-4\">\r\n            {/* Overall Status */}\r\n            <Card>\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <h3 className=\"font-medium\">Overall System Status</h3>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      Last checked: {status.lastCheck.toLocaleTimeString()}\r\n                    </p>\r\n                  </div>\r\n                  <StatusBadge status={status.overall} />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Component Status Grid */}\r\n            <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <Database className=\"h-4 w-4\" />\r\n                    <span className=\"font-medium\">Database</span>\r\n                  </div>\r\n                  <StatusBadge status={status.database} />\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <Server className=\"h-4 w-4\" />\r\n                    <span className=\"font-medium\">API</span>\r\n                  </div>\r\n                  <StatusBadge status={status.api} />\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    {status.network === 'offline' ? <WifiOff className=\"h-4 w-4\" /> : <Wifi className=\"h-4 w-4\" />}\r\n                    <span className=\"font-medium\">Network</span>\r\n                  </div>\r\n                  <StatusBadge status={status.network} />\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <MemoryStick className=\"h-4 w-4\" />\r\n                    <span className=\"font-medium\">Memory</span>\r\n                  </div>\r\n                  <StatusBadge status={status.memory} />\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <HardDrive className=\"h-4 w-4\" />\r\n                    <span className=\"font-medium\">Storage</span>\r\n                  </div>\r\n                  <StatusBadge status={status.storage} />\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    {status.security === 'secure' ? <Lock className=\"h-4 w-4\" /> : <Unlock className=\"h-4 w-4\" />}\r\n                    <span className=\"font-medium\">Security</span>\r\n                  </div>\r\n                  <StatusBadge status={status.security} />\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"metrics\" className=\"space-y-4\">\r\n            {/* Key Metrics */}\r\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <Clock className=\"h-4 w-4 text-blue-500\" />\r\n                    <span className=\"text-sm font-medium\">Response Time</span>\r\n                  </div>\r\n                  <div className=\"text-2xl font-bold\">\r\n                    {Math.round(metrics.responseTime)}ms\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <AlertTriangle className=\"h-4 w-4 text-red-500\" />\r\n                    <span className=\"text-sm font-medium\">Error Rate</span>\r\n                  </div>\r\n                  <div className=\"text-2xl font-bold\">\r\n                    {Math.round(metrics.errorRate * 100)}%\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <MemoryStick className=\"h-4 w-4 text-orange-500\" />\r\n                    <span className=\"text-sm font-medium\">Memory Usage</span>\r\n                  </div>\r\n                  <div className=\"text-2xl font-bold\">\r\n                    {Math.round(metrics.memoryUsage * 100)}%\r\n                  </div>\r\n                  <Progress value={metrics.memoryUsage * 100} className=\"mt-2 h-2\" />\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardContent className=\"p-4\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <Activity className=\"h-4 w-4 text-green-500\" />\r\n                    <span className=\"text-sm font-medium\">Uptime</span>\r\n                  </div>\r\n                  <div className=\"text-2xl font-bold\">\r\n                    {Math.round(metrics.uptime / 60)}m\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"alerts\" className=\"space-y-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <h3 className=\"font-medium\">System Alerts</h3>\r\n              <Button variant=\"outline\" size=\"sm\" onClick={handleClearResolved}>\r\n                Clear Resolved\r\n              </Button>\r\n            </div>\r\n\r\n            <ScrollArea className=\"h-96\">\r\n              <div className=\"space-y-2\">\r\n                {alerts.length === 0 ? (\r\n                  <Card>\r\n                    <CardContent className=\"p-4 text-center\">\r\n                      <CheckCircle className=\"h-8 w-8 text-green-500 mx-auto mb-2\" />\r\n                      <p className=\"text-sm text-muted-foreground\">No alerts</p>\r\n                    </CardContent>\r\n                  </Card>\r\n                ) : (\r\n                  alerts.map((alert) => (\r\n                    <Alert\r\n                      key={alert.id}\r\n                      className={`${\r\n                        alert.type === 'error' ? 'border-red-200 bg-red-50' :\r\n                        alert.type === 'warning' ? 'border-yellow-200 bg-yellow-50' :\r\n                        'border-blue-200 bg-blue-50'\r\n                      } ${alert.resolved ? 'opacity-60' : ''}`}\r\n                    >\r\n                      <div className=\"flex items-start justify-between\">\r\n                        <div className=\"flex items-start gap-2\">\r\n                          {alert.type === 'error' ? <XCircle className=\"h-4 w-4 text-red-600 mt-0.5\" /> :\r\n                           alert.type === 'warning' ? <AlertTriangle className=\"h-4 w-4 text-yellow-600 mt-0.5\" /> :\r\n                           <Info className=\"h-4 w-4 text-blue-600 mt-0.5\" />}\r\n                          <div>\r\n                            <AlertDescription className={\r\n                              alert.type === 'error' ? 'text-red-800' :\r\n                              alert.type === 'warning' ? 'text-yellow-800' :\r\n                              'text-blue-800'\r\n                            }>\r\n                              <div className=\"font-medium\">{alert.component}</div>\r\n                              <div className=\"text-sm\">{alert.message}</div>\r\n                              <div className=\"text-xs mt-1\">\r\n                                {alert.timestamp.toLocaleString()}\r\n                              </div>\r\n                            </AlertDescription>\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                          {alert.resolved && <CheckSquare className=\"h-4 w-4 text-green-500\" />}\r\n                          {!alert.resolved && (\r\n                            <Button\r\n                              variant=\"ghost\"\r\n                              size=\"sm\"\r\n                              onClick={() => handleResolveAlert(alert.id)}\r\n                            >\r\n                              Resolve\r\n                            </Button>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </Alert>\r\n                  ))\r\n                )}\r\n              </div>\r\n            </ScrollArea>\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"settings\" className=\"space-y-4\">\r\n            <div className=\"space-y-4\">\r\n              <h3 className=\"font-medium\">Health Check Configuration</h3>\r\n              <Alert>\r\n                <Info className=\"h-4 w-4\" />\r\n                <AlertDescription>\r\n                  Health checks run every 30 seconds to monitor system components.\r\n                  Critical alerts are shown as toast notifications.\r\n                </AlertDescription>\r\n              </Alert>\r\n\r\n              <div className=\"space-y-2\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span className=\"text-sm\">Auto-check interval:</span>\r\n                  <Badge variant=\"outline\">30 seconds</Badge>\r\n                </div>\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span className=\"text-sm\">Retry attempts:</span>\r\n                  <Badge variant=\"outline\">1</Badge>\r\n                </div>\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span className=\"text-sm\">Timeout:</span>\r\n                  <Badge variant=\"outline\">5 seconds</Badge>\r\n                </div>\r\n              </div>\r\n\r\n              <PerformanceStatusIndicator showDetails />\r\n            </div>\r\n          </TabsContent>\r\n        </Tabs>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n\r\n// ============================================================================\r\n// HEALTH MONITOR PROVIDER\r\n// ============================================================================\r\n\r\nexport const HealthMonitorProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n  return (\r\n    <ResponsiveUIProvider>\r\n      {children}\r\n    </ResponsiveUIProvider>\r\n  )\r\n}\r\n\r\nexport default SystemHealthMonitor","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\accessibility\\AccessibilityProvider.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":173,"column":31,"nodeType":"Identifier","messageId":"undef","endLine":173,"endColumn":45},{"ruleId":"no-undef","severity":2,"message":"'HTMLElement' is not defined.","line":174,"column":40,"nodeType":"Identifier","messageId":"undef","endLine":174,"endColumn":51},{"ruleId":"no-undef","severity":2,"message":"'HTMLElement' is not defined.","line":179,"column":63,"nodeType":"Identifier","messageId":"undef","endLine":179,"endColumn":74},{"ruleId":"no-undef","severity":2,"message":"'HTMLElement' is not defined.","line":187,"column":50,"nodeType":"Identifier","messageId":"undef","endLine":187,"endColumn":61},{"ruleId":"no-undef","severity":2,"message":"'HTMLElement' is not defined.","line":188,"column":76,"nodeType":"Identifier","messageId":"undef","endLine":188,"endColumn":87},{"ruleId":"no-undef","severity":2,"message":"'KeyboardEvent' is not defined.","line":190,"column":30,"nodeType":"Identifier","messageId":"undef","endLine":190,"endColumn":43},{"ruleId":"no-redeclare","severity":2,"message":"'AccessibilitySettings' is already defined.","line":286,"column":7,"nodeType":"Identifier","messageId":"redeclared","endLine":286,"endColumn":38},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":764,"column":19,"nodeType":"Identifier","messageId":"undef","endLine":764,"endColumn":31},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":776,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":776,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'useCallback' is not defined.","line":821,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":821,"endColumn":36},{"ruleId":"no-undef","severity":2,"message":"'useCallback' is not defined.","line":828,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":828,"endColumn":36},{"ruleId":"no-undef","severity":2,"message":"'useCallback' is not defined.","line":833,"column":27,"nodeType":"Identifier","messageId":"undef","endLine":833,"endColumn":38}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n\"use client\"\r\n\r\nimport React, { createContext, useContext, useEffect, useState, useRef } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'\r\nimport { Switch } from '@/components/ui/switch'\r\nimport { Slider } from '@/components/ui/slider'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Separator } from '@/components/ui/separator'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport {\r\n  Eye,\r\n  EyeOff,\r\n  Volume2,\r\n  VolumeX,\r\n  MousePointer,\r\n  Keyboard,\r\n  Type,\r\n  Palette,\r\n  Monitor,\r\n  Settings,\r\n  Shield,\r\n  CheckCircle,\r\n  AlertCircle,\r\n  Info,\r\n  Zap,\r\n  Focus,\r\n  Navigation,\r\n  Headphones,\r\n  Moon,\r\n  Sun,\r\n  Contrast,\r\n  RotateCcw,\r\n  Play,\r\n  Pause,\r\n  SkipForward,\r\n  SkipBack,\r\n  X,\r\n  Plus,\r\n  Minus,\r\n  ChevronUp,\r\n  ChevronDown\r\n} from 'lucide-react'\r\nimport { cn } from '@/lib/utils'\r\n\r\n// Accessibility Settings Interface\r\ninterface AccessibilitySettings {\r\n  // Visual\r\n  highContrast: boolean\r\n  reducedMotion: boolean\r\n  fontSize: number\r\n  fontFamily: 'default' | 'dyslexic' | 'mono'\r\n  colorBlindMode: 'none' | 'protanopia' | 'deuteranopia' | 'tritanopia' | 'monochrome'\r\n\r\n  // Audio\r\n  soundEnabled: boolean\r\n  voiceAnnouncements: boolean\r\n  speechRate: number\r\n  speechPitch: number\r\n\r\n  // Navigation\r\n  keyboardNavigation: boolean\r\n  focusIndicators: boolean\r\n  skipLinks: boolean\r\n\r\n  // Interaction\r\n  clickDelay: number\r\n  hoverDelay: number\r\n  autoplay: boolean\r\n\r\n  // Reading\r\n  readingGuide: boolean\r\n  dyslexiaFont: boolean\r\n  lineSpacing: number\r\n  wordSpacing: number\r\n}\r\n\r\n// Default settings\r\nconst defaultSettings: AccessibilitySettings = {\r\n  highContrast: false,\r\n  reducedMotion: false,\r\n  fontSize: 100,\r\n  fontFamily: 'default',\r\n  colorBlindMode: 'none',\r\n  soundEnabled: true,\r\n  voiceAnnouncements: false,\r\n  speechRate: 1.0,\r\n  speechPitch: 1.0,\r\n  keyboardNavigation: true,\r\n  focusIndicators: true,\r\n  skipLinks: true,\r\n  clickDelay: 0,\r\n  hoverDelay: 300,\r\n  autoplay: false,\r\n  readingGuide: false,\r\n  dyslexiaFont: false,\r\n  lineSpacing: 1.5,\r\n  wordSpacing: 1.0\r\n}\r\n\r\n// Accessibility Context\r\ninterface AccessibilityContextType {\r\n  settings: AccessibilitySettings\r\n  updateSetting: <K extends keyof AccessibilitySettings>(key: K, value: AccessibilitySettings[K]) => void\r\n  resetSettings: () => void\r\n  announceMessage: (message: string) => void\r\n  isSettingsOpen: boolean\r\n  setIsSettingsOpen: (open: boolean) => void\r\n  focusedElement: string | null\r\n  setFocusedElement: (id: string | null) => void\r\n}\r\n\r\nconst AccessibilityContext = createContext<AccessibilityContextType | undefined>(undefined)\r\n\r\n// Hook for using accessibility context\r\nexport const useAccessibility = () => {\r\n  const context = useContext(AccessibilityContext)\r\n  if (!context) {\r\n    throw new Error('useAccessibility must be used within an AccessibilityProvider')\r\n  }\r\n  return context\r\n}\r\n\r\n// Screen Reader Announcer\r\nconst ScreenReaderAnnouncer: React.FC<{ message: string }> = ({ message }) => (\r\n  <div\r\n    role=\"status\"\r\n    aria-live=\"polite\"\r\n    aria-atomic=\"true\"\r\n    className=\"sr-only\"\r\n  >\r\n    {message}\r\n  </div>\r\n)\r\n\r\n// Skip Links Component\r\nconst SkipLinks: React.FC = () => {\r\n  const skipLinks = [\r\n    { href: '#main-content', label: 'Skip to main content' },\r\n    { href: '#navigation', label: 'Skip to navigation' },\r\n    { href: '#search', label: 'Skip to search' },\r\n    { href: '#footer', label: 'Skip to footer' }\r\n  ]\r\n\r\n  return (\r\n    <div className=\"sr-only focus-within:not-sr-only\">\r\n      <div className=\"fixed top-0 left-0 z-50 bg-white border-2 border-blue-600 p-2 m-2 rounded-lg shadow-lg\">\r\n        <div className=\"flex flex-col gap-2\">\r\n          {skipLinks.map(link => (\r\n            <a\r\n              key={link.href}\r\n              href={link.href}\r\n              className=\"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:bg-blue-700 text-sm font-medium\"\r\n            >\r\n              {link.label}\r\n            </a>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// Focus Trap Component\r\nexport const FocusTrap: React.FC<{\r\n  children: React.ReactNode\r\n  active: boolean\r\n  restoreFocus?: boolean\r\n}> = ({ children, active, restoreFocus = true }) => {\r\n  const containerRef = useRef<HTMLDivElement>(null)\r\n  const previousActiveElement = useRef<HTMLElement | null>(null)\r\n\r\n  useEffect(() => {\r\n    if (!active) return\r\n\r\n    previousActiveElement.current = document.activeElement as HTMLElement\r\n\r\n    const container = containerRef.current\r\n    if (!container) return\r\n\r\n    const focusableElements = container.querySelectorAll(\r\n      'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\r\n    )\r\n    const firstElement = focusableElements[0] as HTMLElement\r\n    const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement\r\n\r\n    const handleTabKey = (e: KeyboardEvent) => {\r\n      if (e.key !== 'Tab') return\r\n\r\n      if (e.shiftKey) {\r\n        if (document.activeElement === firstElement) {\r\n          lastElement?.focus()\r\n          e.preventDefault()\r\n        }\r\n      } else {\r\n        if (document.activeElement === lastElement) {\r\n          firstElement?.focus()\r\n          e.preventDefault()\r\n        }\r\n      }\r\n    }\r\n\r\n    document.addEventListener('keydown', handleTabKey)\r\n    firstElement?.focus()\r\n\r\n    return () => {\r\n      document.removeEventListener('keydown', handleTabKey)\r\n      if (restoreFocus && previousActiveElement.current) {\r\n        previousActiveElement.current.focus()\r\n      }\r\n    }\r\n  }, [active, restoreFocus])\r\n\r\n  return (\r\n    <div ref={containerRef} className=\"focus-trap\">\r\n      {children}\r\n    </div>\r\n  )\r\n}\r\n\r\n// Accessible Button Component\r\nexport const AccessibleButton: React.FC<{\r\n  children: React.ReactNode\r\n  onClick?: () => void\r\n  disabled?: boolean\r\n  variant?: 'primary' | 'secondary' | 'ghost'\r\n  size?: 'sm' | 'md' | 'lg'\r\n  ariaLabel?: string\r\n  ariaDescribedBy?: string\r\n  className?: string\r\n}> = ({\r\n  children,\r\n  onClick,\r\n  disabled = false,\r\n  variant = 'primary',\r\n  size = 'md',\r\n  ariaLabel,\r\n  ariaDescribedBy,\r\n  className\r\n}) => {\r\n  const { settings, announceMessage } = useAccessibility()\r\n\r\n  const handleClick = () => {\r\n    if (disabled) return\r\n\r\n    if (settings.soundEnabled) {\r\n      // Play click sound (would integrate with audio system)\r\n    }\r\n\r\n    if (settings.voiceAnnouncements && ariaLabel) {\r\n      announceMessage(`Button ${ariaLabel} activated`)\r\n    }\r\n\r\n    setTimeout(() => onClick?.(), settings.clickDelay)\r\n  }\r\n\r\n  const sizeClasses = {\r\n    sm: 'min-h-[32px] min-w-[32px] px-3 py-1 text-sm',\r\n    md: 'min-h-[44px] min-w-[44px] px-4 py-2 text-base',\r\n    lg: 'min-h-[56px] min-w-[56px] px-6 py-3 text-lg'\r\n  }\r\n\r\n  return (\r\n    <Button\r\n      onClick={handleClick}\r\n      disabled={disabled}\r\n      aria-label={ariaLabel}\r\n      aria-describedby={ariaDescribedBy}\r\n      className={cn(\r\n        sizeClasses[size],\r\n        settings.focusIndicators && 'focus:ring-4 focus:ring-blue-500/50 focus:ring-offset-2',\r\n        settings.highContrast && 'border-2 border-current',\r\n        className\r\n      )}\r\n      variant={variant}\r\n    >\r\n      {children}\r\n    </Button>\r\n  )\r\n}\r\n\r\n// Accessibility Settings Panel\r\nconst AccessibilitySettings: React.FC = () => {\r\n  const { settings, updateSetting, resetSettings, isSettingsOpen, setIsSettingsOpen } = useAccessibility()\r\n  const [activeTab, setActiveTab] = useState<'visual' | 'audio' | 'navigation' | 'interaction'>('visual')\r\n\r\n  const tabs = [\r\n    { id: 'visual', label: 'Visual', icon: Eye },\r\n    { id: 'audio', label: 'Audio', icon: Volume2 },\r\n    { id: 'navigation', label: 'Navigation', icon: Navigation },\r\n    { id: 'interaction', label: 'Interaction', icon: MousePointer }\r\n  ]\r\n\r\n  const colorBlindOptions = [\r\n    { value: 'none', label: 'None' },\r\n    { value: 'protanopia', label: 'Protanopia (Red-blind)' },\r\n    { value: 'deuteranopia', label: 'Deuteranopia (Green-blind)' },\r\n    { value: 'tritanopia', label: 'Tritanopia (Blue-blind)' },\r\n    { value: 'monochrome', label: 'Monochrome' }\r\n  ]\r\n\r\n  const fontOptions = [\r\n    { value: 'default', label: 'Default Font' },\r\n    { value: 'dyslexic', label: 'Dyslexic-friendly' },\r\n    { value: 'mono', label: 'Monospace' }\r\n  ]\r\n\r\n  return (\r\n    <Dialog open={isSettingsOpen} onOpenChange={setIsSettingsOpen}>\r\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-hidden\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-3 text-2xl\">\r\n            <Shield className=\"h-6 w-6 text-blue-600\" />\r\n            Accessibility Settings\r\n            <Badge variant=\"secondary\" className=\"ml-auto\">\r\n              WCAG AAA Compliant\r\n            </Badge>\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <FocusTrap active={isSettingsOpen}>\r\n          <div className=\"flex h-[600px]\">\r\n            {/* Sidebar */}\r\n            <div className=\"w-64 border-r bg-gray-50 p-4\">\r\n              <nav role=\"navigation\" aria-label=\"Accessibility settings navigation\">\r\n                <div className=\"space-y-2\">\r\n                  {tabs.map(tab => {\r\n                    const Icon = tab.icon\r\n                    return (\r\n                      <button\r\n                        key={tab.id}\r\n                        onClick={() => setActiveTab(tab.id as any)}\r\n                        className={cn(\r\n                          \"w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-all\",\r\n                          \"min-h-[44px] focus:ring-2 focus:ring-blue-500 focus:ring-offset-2\",\r\n                          activeTab === tab.id\r\n                            ? \"bg-blue-100 text-blue-700 border-2 border-blue-300\"\r\n                            : \"hover:bg-gray-100 border-2 border-transparent\"\r\n                        )}\r\n                        aria-current={activeTab === tab.id ? 'page' : undefined}\r\n                      >\r\n                        <Icon className=\"h-5 w-5\" />\r\n                        <span className=\"font-medium\">{tab.label}</span>\r\n                      </button>\r\n                    )\r\n                  })}\r\n                </div>\r\n\r\n                <Separator className=\"my-6\" />\r\n\r\n                <div className=\"space-y-3\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={resetSettings}\r\n                    className=\"w-full justify-start\"\r\n                  >\r\n                    <RotateCcw className=\"h-4 w-4 mr-2\" />\r\n                    Reset to Defaults\r\n                  </Button>\r\n                </div>\r\n              </nav>\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <div className=\"flex-1 p-6 overflow-y-auto\">\r\n              <AnimatePresence mode=\"wait\">\r\n                <motion.div\r\n                  key={activeTab}\r\n                  initial={{ opacity: 0, x: 20 }}\r\n                  animate={{ opacity: 1, x: 0 }}\r\n                  exit={{ opacity: 0, x: -20 }}\r\n                  transition={{ duration: 0.2 }}\r\n                  className=\"space-y-6\"\r\n                >\r\n                  {/* Visual Tab */}\r\n                  {activeTab === 'visual' && (\r\n                    <div className=\"space-y-8\">\r\n                      <div>\r\n                        <h3 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\r\n                          <Eye className=\"h-5 w-5\" />\r\n                          Visual Accessibility\r\n                        </h3>\r\n\r\n                        <div className=\"space-y-6\">\r\n                          {/* High Contrast */}\r\n                          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\r\n                            <div className=\"flex-1\">\r\n                              <label htmlFor=\"high-contrast\" className=\"font-medium block\">\r\n                                High Contrast Mode\r\n                              </label>\r\n                              <p className=\"text-sm text-gray-600 mt-1\">\r\n                                Increases contrast between text and background for better readability\r\n                              </p>\r\n                            </div>\r\n                            <Switch\r\n                              id=\"high-contrast\"\r\n                              checked={settings.highContrast}\r\n                              onCheckedChange={(checked) => updateSetting('highContrast', checked)}\r\n                              aria-describedby=\"high-contrast-description\"\r\n                            />\r\n                          </div>\r\n\r\n                          {/* Font Size */}\r\n                          <div className=\"space-y-3 p-4 border rounded-lg\">\r\n                            <label className=\"font-medium block\">\r\n                              Font Size: {settings.fontSize}%\r\n                            </label>\r\n                            <div className=\"flex items-center gap-4\">\r\n                              <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                onClick={() => updateSetting('fontSize', Math.max(50, settings.fontSize - 10))}\r\n                                aria-label=\"Decrease font size\"\r\n                              >\r\n                                <Minus className=\"h-4 w-4\" />\r\n                              </Button>\r\n                              <Slider\r\n                                value={[settings.fontSize]}\r\n                                onValueChange={([value]) => updateSetting('fontSize', value)}\r\n                                min={50}\r\n                                max={200}\r\n                                step={10}\r\n                                className=\"flex-1\"\r\n                                aria-label=\"Font size\"\r\n                              />\r\n                              <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                onClick={() => updateSetting('fontSize', Math.min(200, settings.fontSize + 10))}\r\n                                aria-label=\"Increase font size\"\r\n                              >\r\n                                <Plus className=\"h-4 w-4\" />\r\n                              </Button>\r\n                            </div>\r\n                            <div className=\"text-sm text-gray-600\">\r\n                              Preview text at {settings.fontSize}% size\r\n                            </div>\r\n                          </div>\r\n\r\n                          {/* Font Family */}\r\n                          <div className=\"space-y-3 p-4 border rounded-lg\">\r\n                            <label htmlFor=\"font-family\" className=\"font-medium block\">\r\n                              Font Family\r\n                            </label>\r\n                            <Select\r\n                              value={settings.fontFamily}\r\n                              onValueChange={(value) => updateSetting('fontFamily', value as any)}\r\n                            >\r\n                              <SelectTrigger id=\"font-family\">\r\n                                <SelectValue />\r\n                              </SelectTrigger>\r\n                              <SelectContent>\r\n                                {fontOptions.map(option => (\r\n                                  <SelectItem key={option.value} value={option.value}>\r\n                                    {option.label}\r\n                                  </SelectItem>\r\n                                ))}\r\n                              </SelectContent>\r\n                            </Select>\r\n                          </div>\r\n\r\n                          {/* Color Blind Support */}\r\n                          <div className=\"space-y-3 p-4 border rounded-lg\">\r\n                            <label htmlFor=\"color-blind-mode\" className=\"font-medium block\">\r\n                              Color Vision Support\r\n                            </label>\r\n                            <Select\r\n                              value={settings.colorBlindMode}\r\n                              onValueChange={(value) => updateSetting('colorBlindMode', value as any)}\r\n                            >\r\n                              <SelectTrigger id=\"color-blind-mode\">\r\n                                <SelectValue />\r\n                              </SelectTrigger>\r\n                              <SelectContent>\r\n                                {colorBlindOptions.map(option => (\r\n                                  <SelectItem key={option.value} value={option.value}>\r\n                                    {option.label}\r\n                                  </SelectItem>\r\n                                ))}\r\n                              </SelectContent>\r\n                            </Select>\r\n                          </div>\r\n\r\n                          {/* Reduced Motion */}\r\n                          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\r\n                            <div className=\"flex-1\">\r\n                              <label htmlFor=\"reduced-motion\" className=\"font-medium block\">\r\n                                Reduce Motion\r\n                              </label>\r\n                              <p className=\"text-sm text-gray-600 mt-1\">\r\n                                Minimizes animations and transitions that may cause discomfort\r\n                              </p>\r\n                            </div>\r\n                            <Switch\r\n                              id=\"reduced-motion\"\r\n                              checked={settings.reducedMotion}\r\n                              onCheckedChange={(checked) => updateSetting('reducedMotion', checked)}\r\n                            />\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Audio Tab */}\r\n                  {activeTab === 'audio' && (\r\n                    <div className=\"space-y-8\">\r\n                      <div>\r\n                        <h3 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\r\n                          <Volume2 className=\"h-5 w-5\" />\r\n                          Audio Accessibility\r\n                        </h3>\r\n\r\n                        <div className=\"space-y-6\">\r\n                          {/* Sound Effects */}\r\n                          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\r\n                            <div className=\"flex-1\">\r\n                              <label htmlFor=\"sound-enabled\" className=\"font-medium block\">\r\n                                Sound Effects\r\n                              </label>\r\n                              <p className=\"text-sm text-gray-600 mt-1\">\r\n                                Plays audio feedback for interactions and notifications\r\n                              </p>\r\n                            </div>\r\n                            <Switch\r\n                              id=\"sound-enabled\"\r\n                              checked={settings.soundEnabled}\r\n                              onCheckedChange={(checked) => updateSetting('soundEnabled', checked)}\r\n                            />\r\n                          </div>\r\n\r\n                          {/* Voice Announcements */}\r\n                          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\r\n                            <div className=\"flex-1\">\r\n                              <label htmlFor=\"voice-announcements\" className=\"font-medium block\">\r\n                                Voice Announcements\r\n                              </label>\r\n                              <p className=\"text-sm text-gray-600 mt-1\">\r\n                                Provides spoken feedback for screen reader users\r\n                              </p>\r\n                            </div>\r\n                            <Switch\r\n                              id=\"voice-announcements\"\r\n                              checked={settings.voiceAnnouncements}\r\n                              onCheckedChange={(checked) => updateSetting('voiceAnnouncements', checked)}\r\n                            />\r\n                          </div>\r\n\r\n                          {settings.voiceAnnouncements && (\r\n                            <>\r\n                              {/* Speech Rate */}\r\n                              <div className=\"space-y-3 p-4 border rounded-lg\">\r\n                                <label className=\"font-medium block\">\r\n                                  Speech Rate: {settings.speechRate.toFixed(1)}x\r\n                                </label>\r\n                                <Slider\r\n                                  value={[settings.speechRate]}\r\n                                  onValueChange={([value]) => updateSetting('speechRate', value)}\r\n                                  min={0.5}\r\n                                  max={2.0}\r\n                                  step={0.1}\r\n                                  className=\"w-full\"\r\n                                  aria-label=\"Speech rate\"\r\n                                />\r\n                                <div className=\"flex justify-between text-xs text-gray-500\">\r\n                                  <span>0.5x (Slow)</span>\r\n                                  <span>2.0x (Fast)</span>\r\n                                </div>\r\n                              </div>\r\n\r\n                              {/* Speech Pitch */}\r\n                              <div className=\"space-y-3 p-4 border rounded-lg\">\r\n                                <label className=\"font-medium block\">\r\n                                  Speech Pitch: {settings.speechPitch.toFixed(1)}\r\n                                </label>\r\n                                <Slider\r\n                                  value={[settings.speechPitch]}\r\n                                  onValueChange={([value]) => updateSetting('speechPitch', value)}\r\n                                  min={0.5}\r\n                                  max={2.0}\r\n                                  step={0.1}\r\n                                  className=\"w-full\"\r\n                                  aria-label=\"Speech pitch\"\r\n                                />\r\n                                <div className=\"flex justify-between text-xs text-gray-500\">\r\n                                  <span>0.5 (Low)</span>\r\n                                  <span>2.0 (High)</span>\r\n                                </div>\r\n                              </div>\r\n                            </>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Navigation Tab */}\r\n                  {activeTab === 'navigation' && (\r\n                    <div className=\"space-y-8\">\r\n                      <div>\r\n                        <h3 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\r\n                          <Keyboard className=\"h-5 w-5\" />\r\n                          Navigation Accessibility\r\n                        </h3>\r\n\r\n                        <div className=\"space-y-6\">\r\n                          {/* Keyboard Navigation */}\r\n                          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\r\n                            <div className=\"flex-1\">\r\n                              <label htmlFor=\"keyboard-navigation\" className=\"font-medium block\">\r\n                                Enhanced Keyboard Navigation\r\n                              </label>\r\n                              <p className=\"text-sm text-gray-600 mt-1\">\r\n                                Enables advanced keyboard shortcuts and navigation\r\n                              </p>\r\n                            </div>\r\n                            <Switch\r\n                              id=\"keyboard-navigation\"\r\n                              checked={settings.keyboardNavigation}\r\n                              onCheckedChange={(checked) => updateSetting('keyboardNavigation', checked)}\r\n                            />\r\n                          </div>\r\n\r\n                          {/* Focus Indicators */}\r\n                          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\r\n                            <div className=\"flex-1\">\r\n                              <label htmlFor=\"focus-indicators\" className=\"font-medium block\">\r\n                                Enhanced Focus Indicators\r\n                              </label>\r\n                              <p className=\"text-sm text-gray-600 mt-1\">\r\n                                Shows clear visual indicators for focused elements\r\n                              </p>\r\n                            </div>\r\n                            <Switch\r\n                              id=\"focus-indicators\"\r\n                              checked={settings.focusIndicators}\r\n                              onCheckedChange={(checked) => updateSetting('focusIndicators', checked)}\r\n                            />\r\n                          </div>\r\n\r\n                          {/* Skip Links */}\r\n                          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\r\n                            <div className=\"flex-1\">\r\n                              <label htmlFor=\"skip-links\" className=\"font-medium block\">\r\n                                Skip Navigation Links\r\n                              </label>\r\n                              <p className=\"text-sm text-gray-600 mt-1\">\r\n                                Provides quick navigation shortcuts to main content areas\r\n                              </p>\r\n                            </div>\r\n                            <Switch\r\n                              id=\"skip-links\"\r\n                              checked={settings.skipLinks}\r\n                              onCheckedChange={(checked) => updateSetting('skipLinks', checked)}\r\n                            />\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Interaction Tab */}\r\n                  {activeTab === 'interaction' && (\r\n                    <div className=\"space-y-8\">\r\n                      <div>\r\n                        <h3 className=\"text-lg font-semibold mb-4 flex items-center gap-2\">\r\n                          <MousePointer className=\"h-5 w-5\" />\r\n                          Interaction Accessibility\r\n                        </h3>\r\n\r\n                        <div className=\"space-y-6\">\r\n                          {/* Click Delay */}\r\n                          <div className=\"space-y-3 p-4 border rounded-lg\">\r\n                            <label className=\"font-medium block\">\r\n                              Click Delay: {settings.clickDelay}ms\r\n                            </label>\r\n                            <p className=\"text-sm text-gray-600 mb-3\">\r\n                              Adds delay before processing clicks to prevent accidental activation\r\n                            </p>\r\n                            <Slider\r\n                              value={[settings.clickDelay]}\r\n                              onValueChange={([value]) => updateSetting('clickDelay', value)}\r\n                              min={0}\r\n                              max={1000}\r\n                              step={100}\r\n                              className=\"w-full\"\r\n                              aria-label=\"Click delay\"\r\n                            />\r\n                            <div className=\"flex justify-between text-xs text-gray-500\">\r\n                              <span>0ms (Instant)</span>\r\n                              <span>1000ms (1 second)</span>\r\n                            </div>\r\n                          </div>\r\n\r\n                          {/* Hover Delay */}\r\n                          <div className=\"space-y-3 p-4 border rounded-lg\">\r\n                            <label className=\"font-medium block\">\r\n                              Hover Delay: {settings.hoverDelay}ms\r\n                            </label>\r\n                            <p className=\"text-sm text-gray-600 mb-3\">\r\n                              Controls how long to wait before showing hover effects\r\n                            </p>\r\n                            <Slider\r\n                              value={[settings.hoverDelay]}\r\n                              onValueChange={([value]) => updateSetting('hoverDelay', value)}\r\n                              min={0}\r\n                              max={2000}\r\n                              step={100}\r\n                              className=\"w-full\"\r\n                              aria-label=\"Hover delay\"\r\n                            />\r\n                            <div className=\"flex justify-between text-xs text-gray-500\">\r\n                              <span>0ms (Instant)</span>\r\n                              <span>2000ms (2 seconds)</span>\r\n                            </div>\r\n                          </div>\r\n\r\n                          {/* Autoplay */}\r\n                          <div className=\"flex items-center justify-between p-4 border rounded-lg\">\r\n                            <div className=\"flex-1\">\r\n                              <label htmlFor=\"autoplay\" className=\"font-medium block\">\r\n                                Prevent Autoplay\r\n                              </label>\r\n                              <p className=\"text-sm text-gray-600 mt-1\">\r\n                                Prevents videos and animations from playing automatically\r\n                              </p>\r\n                            </div>\r\n                            <Switch\r\n                              id=\"autoplay\"\r\n                              checked={!settings.autoplay}\r\n                              onCheckedChange={(checked) => updateSetting('autoplay', !checked)}\r\n                            />\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </motion.div>\r\n              </AnimatePresence>\r\n            </div>\r\n          </div>\r\n        </FocusTrap>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n\r\n// Accessibility Provider Component\r\nexport const AccessibilityProvider: React.FC<{\r\n  children: React.ReactNode\r\n  enableScreenReader?: boolean\r\n}> = ({ children, enableScreenReader = true }) => {\r\n  const [settings, setSettings] = useState<AccessibilitySettings>(defaultSettings)\r\n  const [isSettingsOpen, setIsSettingsOpen] = useState(false)\r\n  const [focusedElement, setFocusedElement] = useState<string | null>(null)\r\n  const [announcements, setAnnouncements] = useState<string>('')\r\n\r\n  // Load settings from localStorage on mount\r\n  useEffect(() => {\r\n    const saved = localStorage.getItem('accessibility-settings')\r\n    if (saved) {\r\n      try {\r\n        setSettings(JSON.parse(saved))\r\n      } catch (e) {\r\n        console.warn('Failed to load accessibility settings')\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  // Save settings to localStorage when changed\r\n  useEffect(() => {\r\n    localStorage.setItem('accessibility-settings', JSON.stringify(settings))\r\n  }, [settings])\r\n\r\n  // Apply CSS custom properties based on settings\r\n  useEffect(() => {\r\n    const root = document.documentElement\r\n\r\n    // Font size\r\n    root.style.setProperty('--font-size-scale', `${settings.fontSize / 100}`)\r\n\r\n    // Line spacing\r\n    root.style.setProperty('--line-height', settings.lineSpacing.toString())\r\n\r\n    // Word spacing\r\n    root.style.setProperty('--word-spacing', `${settings.wordSpacing}em`)\r\n\r\n    // Reduced motion\r\n    if (settings.reducedMotion) {\r\n      root.style.setProperty('--animation-duration', '0.01ms')\r\n      root.style.setProperty('--transition-duration', '0.01ms')\r\n    } else {\r\n      root.style.removeProperty('--animation-duration')\r\n      root.style.removeProperty('--transition-duration')\r\n    }\r\n\r\n    // High contrast\r\n    if (settings.highContrast) {\r\n      root.classList.add('high-contrast')\r\n    } else {\r\n      root.classList.remove('high-contrast')\r\n    }\r\n\r\n    // Color blind support\r\n    root.setAttribute('data-color-blind-mode', settings.colorBlindMode)\r\n\r\n    // Font family\r\n    if (settings.fontFamily === 'dyslexic') {\r\n      root.style.setProperty('--font-family', '\"OpenDyslexic\", sans-serif')\r\n    } else if (settings.fontFamily === 'mono') {\r\n      root.style.setProperty('--font-family', 'monospace')\r\n    } else {\r\n      root.style.removeProperty('--font-family')\r\n    }\r\n  }, [settings])\r\n\r\n  const updateSetting = useCallback(<K extends keyof AccessibilitySettings>(\r\n    key: K,\r\n    value: AccessibilitySettings[K]\r\n  ) => {\r\n    setSettings(prev => ({ ...prev, [key]: value }))\r\n  }, [])\r\n\r\n  const resetSettings = useCallback(() => {\r\n    setSettings(defaultSettings)\r\n    setAnnouncements('Accessibility settings have been reset to defaults')\r\n  }, [])\r\n\r\n  const announceMessage = useCallback((message: string) => {\r\n    if (settings.voiceAnnouncements && enableScreenReader) {\r\n      setAnnouncements(message)\r\n      // Clear after a delay to allow screen readers to announce\r\n      setTimeout(() => setAnnouncements(''), 1000)\r\n    }\r\n  }, [settings.voiceAnnouncements, enableScreenReader])\r\n\r\n  const value: AccessibilityContextType = {\r\n    settings,\r\n    updateSetting,\r\n    resetSettings,\r\n    announceMessage,\r\n    isSettingsOpen,\r\n    setIsSettingsOpen,\r\n    focusedElement,\r\n    setFocusedElement\r\n  }\r\n\r\n  return (\r\n    <AccessibilityContext.Provider value={value}>\r\n      {/* Skip Links */}\r\n      {settings.skipLinks && <SkipLinks />}\r\n\r\n      {/* Screen Reader Announcements */}\r\n      {enableScreenReader && announcements && (\r\n        <ScreenReaderAnnouncer message={announcements} />\r\n      )}\r\n\r\n      {/* Accessibility Settings Panel */}\r\n      <AccessibilitySettings />\r\n\r\n      {/* Main Content */}\r\n      <div\r\n        className={cn(\r\n          \"accessibility-enhanced\",\r\n          settings.highContrast && \"high-contrast\",\r\n          settings.focusIndicators && \"enhanced-focus\",\r\n          settings.reducedMotion && \"reduced-motion\"\r\n        )}\r\n        style={{\r\n          fontSize: `${settings.fontSize}%`,\r\n          lineHeight: settings.lineSpacing,\r\n          wordSpacing: `${settings.wordSpacing}em`\r\n        }}\r\n      >\r\n        {children}\r\n      </div>\r\n\r\n      {/* Accessibility Settings Trigger */}\r\n      <div className=\"fixed bottom-4 right-4 z-40\">\r\n        <Button\r\n          onClick={() => setIsSettingsOpen(true)}\r\n          className=\"min-h-[56px] min-w-[56px] rounded-full shadow-lg\"\r\n          aria-label=\"Open accessibility settings\"\r\n        >\r\n          <Settings className=\"h-6 w-6\" />\r\n        </Button>\r\n      </div>\r\n    </AccessibilityContext.Provider>\r\n  )\r\n}\r\n\r\n// Accessibility Status Indicator\r\nexport const AccessibilityStatusIndicator: React.FC = () => {\r\n  const { settings } = useAccessibility()\r\n\r\n  const activeFeatures = Object.entries(settings).filter(([key, value]) => {\r\n    if (typeof value === 'boolean') return value\r\n    if (typeof value === 'number') {\r\n      const defaults = defaultSettings as any\r\n      return value !== defaults[key]\r\n    }\r\n    if (typeof value === 'string') {\r\n      const defaults = defaultSettings as any\r\n      return value !== defaults[key]\r\n    }\r\n    return false\r\n  }).length\r\n\r\n  if (activeFeatures === 0) return null\r\n\r\n  return (\r\n    <Badge\r\n      variant=\"secondary\"\r\n      className=\"fixed top-4 right-4 z-50 bg-green-100 text-green-800 border-green-300\"\r\n    >\r\n      <Shield className=\"h-3 w-3 mr-1\" />\r\n      {activeFeatures} accessibility feature{activeFeatures !== 1 ? 's' : ''} active\r\n    </Badge>\r\n  )\r\n}\r\n\r\nexport default AccessibilityProvider","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\alert.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":23,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":23,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":24,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":24,"endColumn":38},{"ruleId":"no-undef","severity":2,"message":"'HTMLParagraphElement' is not defined.","line":36,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":36,"endColumn":23},{"ruleId":"no-undef","severity":2,"message":"'HTMLHeadingElement' is not defined.","line":37,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":37,"endColumn":42},{"ruleId":"no-undef","severity":2,"message":"'HTMLParagraphElement' is not defined.","line":48,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":48,"endColumn":23},{"ruleId":"no-undef","severity":2,"message":"'HTMLParagraphElement' is not defined.","line":49,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":49,"endColumn":44}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { cva, type VariantProps } from \"class-variance-authority\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst alertVariants = cva(\r\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"bg-background text-foreground\",\r\n        destructive:\r\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n    },\r\n  }\r\n)\r\n\r\nconst Alert = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\r\n>(({ className, variant, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    role=\"alert\"\r\n    className={cn(alertVariants({ variant }), className)}\r\n    {...props}\r\n  />\r\n))\r\nAlert.displayName = \"Alert\"\r\n\r\nconst AlertTitle = React.forwardRef<\r\n  HTMLParagraphElement,\r\n  React.HTMLAttributes<HTMLHeadingElement>\r\n>(({ className, ...props }, ref) => (\r\n  <h5\r\n    ref={ref}\r\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\r\n    {...props}\r\n  />\r\n))\r\nAlertTitle.displayName = \"AlertTitle\"\r\n\r\nconst AlertDescription = React.forwardRef<\r\n  HTMLParagraphElement,\r\n  React.HTMLAttributes<HTMLParagraphElement>\r\n>(({ className, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\r\n    {...props}\r\n  />\r\n))\r\nAlertDescription.displayName = \"AlertDescription\"\r\n\r\nexport { Alert, AlertTitle, AlertDescription }","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\data-table\\EnhancedDataTable.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":289,"column":27,"nodeType":"Identifier","messageId":"undef","endLine":289,"endColumn":41},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":475,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":475,"endColumn":60,"suggestions":[{"messageId":"addBrackets","fix":{"range":[14747,14936],"text":"{ const currency = column.metadata?.currency || 'USD'\r\n        return new Intl.NumberFormat('en-US', {\r\n          style: 'currency',\r\n          currency\r\n        }).format(Number(value) || 0) }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":482,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":482,"endColumn":58,"suggestions":[{"messageId":"addBrackets","fix":{"range":[14974,15085],"text":"{ const precision = column.metadata?.precision || 1\r\n        return `${(Number(value) || 0).toFixed(precision)}%` }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":489,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":489,"endColumn":71,"suggestions":[{"messageId":"addBrackets","fix":{"range":[15195,15310],"text":"{ const dateFormat = column.metadata?.dateFormat || 'MM/dd/yyyy'\r\n        return new Date(value).toLocaleDateString() }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n\"use client\"\r\n\r\nimport React, { useState, useMemo, useCallback, useRef, useEffect } from 'react'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Checkbox } from '@/components/ui/checkbox'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport { Separator } from '@/components/ui/separator'\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'\r\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip'\r\nimport {\r\n  Search,\r\n  Filter,\r\n  SortAsc,\r\n  SortDesc,\r\n  ArrowUpDown,\r\n  MoreHorizontal,\r\n  Download,\r\n  Upload,\r\n  RefreshCw,\r\n  Settings,\r\n  Eye,\r\n  Edit,\r\n  Trash2,\r\n  Copy,\r\n  Share2,\r\n  Bookmark,\r\n  Star,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  XCircle,\r\n  Clock,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  BarChart3,\r\n  PieChart,\r\n  LineChart,\r\n  Calendar,\r\n  MapPin,\r\n  Building2,\r\n  Package,\r\n  DollarSign,\r\n  Percent,\r\n  Hash,\r\n  Type,\r\n  Calendar as CalendarIcon,\r\n  ChevronLeft,\r\n  ChevronRight,\r\n  ChevronsLeft,\r\n  ChevronsRight,\r\n  Columns,\r\n  Grid,\r\n  List,\r\n  Maximize2,\r\n  Minimize2,\r\n  Pin,\r\n  PinOff,\r\n  Loader2,\r\n  Zap,\r\n  Sparkles,\r\n  Target,\r\n  Activity,\r\n  Gauge,\r\n  Info,\r\n  HelpCircle,\r\n  ExternalLink\r\n} from 'lucide-react'\r\nimport { cn } from '@/lib/utils'\r\n\r\n// Enhanced Column Configuration\r\nexport interface ColumnDef<T = any> {\r\n  id: string\r\n  key: keyof T\r\n  header: string\r\n  description?: string\r\n  type: 'text' | 'number' | 'currency' | 'percentage' | 'date' | 'boolean' | 'badge' | 'actions' | 'custom'\r\n  width?: number | 'auto' | 'flex'\r\n  minWidth?: number\r\n  maxWidth?: number\r\n  sortable?: boolean\r\n  filterable?: boolean\r\n  searchable?: boolean\r\n  resizable?: boolean\r\n  pinnable?: boolean\r\n  hideable?: boolean\r\n  sticky?: 'left' | 'right'\r\n  align?: 'left' | 'center' | 'right'\r\n  formatter?: (value: any, row: T) => React.ReactNode\r\n  accessor?: (row: T) => any\r\n  aggregation?: 'sum' | 'avg' | 'count' | 'min' | 'max' | 'none'\r\n  filterOptions?: Array<{ label: string; value: any }>\r\n  validationRules?: Array<{\r\n    rule: (value: any) => boolean\r\n    message: string\r\n    severity: 'error' | 'warning' | 'info'\r\n  }>\r\n  metadata?: {\r\n    unit?: string\r\n    precision?: number\r\n    currency?: string\r\n    dateFormat?: string\r\n    icon?: React.ComponentType<any>\r\n  }\r\n}\r\n\r\n// Enhanced Filter Configuration\r\nexport interface FilterState {\r\n  [key: string]: {\r\n    value: any\r\n    operator: 'equals' | 'contains' | 'starts_with' | 'ends_with' | 'greater_than' | 'less_than' | 'between' | 'in' | 'not_in'\r\n    enabled: boolean\r\n  }\r\n}\r\n\r\n// Advanced Sorting Configuration\r\nexport interface SortState {\r\n  column: string\r\n  direction: 'asc' | 'desc'\r\n  priority: number\r\n}\r\n\r\n// Selection and Grouping\r\nexport interface GroupBy {\r\n  column: string\r\n  expanded: { [key: string]: boolean }\r\n}\r\n\r\n// Data Table Props with Enhanced Features\r\nexport interface EnhancedDataTableProps<T = any> {\r\n  data: T[]\r\n  columns: ColumnDef<T>[]\r\n  loading?: boolean\r\n  error?: string | null\r\n\r\n  // Pagination\r\n  pagination?: {\r\n    enabled: boolean\r\n    pageSize: number\r\n    pageSizeOptions: number[]\r\n    showInfo: boolean\r\n    showSizeSelector: boolean\r\n  }\r\n\r\n  // Search & Filtering\r\n  globalSearch?: {\r\n    enabled: boolean\r\n    placeholder: string\r\n    debounceMs: number\r\n  }\r\n\r\n  // Selection\r\n  selection?: {\r\n    enabled: boolean\r\n    mode: 'single' | 'multiple'\r\n    showSelectAll: boolean\r\n  }\r\n\r\n  // Sorting\r\n  sorting?: {\r\n    enabled: boolean\r\n    multiSort: boolean\r\n    defaultSort?: SortState[]\r\n  }\r\n\r\n  // Grouping & Aggregation\r\n  grouping?: {\r\n    enabled: boolean\r\n    defaultGroupBy?: string\r\n    showAggregates: boolean\r\n  }\r\n\r\n  // Visual Customization\r\n  appearance?: {\r\n    variant: 'default' | 'bordered' | 'striped' | 'minimal'\r\n    size: 'sm' | 'md' | 'lg'\r\n    stickyHeader: boolean\r\n    highlightOnHover: boolean\r\n    alternatingRows: boolean\r\n    showRowNumbers: boolean\r\n    compactMode: boolean\r\n    fullscreen?: boolean\r\n  }\r\n\r\n  // Export & Actions\r\n  actions?: {\r\n    export?: {\r\n      enabled: boolean\r\n      formats: ('csv' | 'xlsx' | 'json' | 'pdf')[]\r\n    }\r\n    bulk?: Array<{\r\n      id: string\r\n      label: string\r\n      icon?: React.ComponentType<any>\r\n      handler: (selectedRows: T[]) => void\r\n      confirmation?: string\r\n    }>\r\n    row?: Array<{\r\n      id: string\r\n      label: string\r\n      icon?: React.ComponentType<any>\r\n      handler: (row: T, index: number) => void\r\n      condition?: (row: T) => boolean\r\n    }>\r\n  }\r\n\r\n  // Real-time Features\r\n  realtime?: {\r\n    enabled: boolean\r\n    updateInterval: number\r\n    showLastUpdate: boolean\r\n    highlightChanges: boolean\r\n  }\r\n\r\n  // Event Handlers\r\n  onRowClick?: (row: T, index: number) => void\r\n  onRowDoubleClick?: (row: T, index: number) => void\r\n  onSelectionChange?: (selectedRows: T[]) => void\r\n  onSortChange?: (sort: SortState[]) => void\r\n  onFilterChange?: (filters: FilterState) => void\r\n  onColumnResize?: (columnId: string, width: number) => void\r\n  onColumnReorder?: (columnOrder: string[]) => void\r\n\r\n  // Accessibility\r\n  accessibilityLabel?: string\r\n  announceChanges?: boolean\r\n  keyboardNavigation?: boolean\r\n}\r\n\r\nconst EnhancedDataTable = <T extends Record<string, any>>({\r\n  data = [],\r\n  columns = [],\r\n  loading = false,\r\n  error = null,\r\n  pagination = { enabled: true, pageSize: 50, pageSizeOptions: [10, 25, 50, 100, 200], showInfo: true, showSizeSelector: true },\r\n  globalSearch = { enabled: true, placeholder: 'Search across all columns...', debounceMs: 300 },\r\n  selection = { enabled: false, mode: 'multiple', showSelectAll: true },\r\n  sorting = { enabled: true, multiSort: true },\r\n  grouping = { enabled: false, showAggregates: true },\r\n  appearance = {\r\n    variant: 'default',\r\n    size: 'md',\r\n    stickyHeader: true,\r\n    highlightOnHover: true,\r\n    alternatingRows: true,\r\n    showRowNumbers: false,\r\n    compactMode: false\r\n  },\r\n  actions,\r\n  realtime = { enabled: false, updateInterval: 30000, showLastUpdate: true, highlightChanges: true },\r\n  onRowClick,\r\n  onRowDoubleClick,\r\n  onSelectionChange,\r\n  onSortChange,\r\n  onFilterChange,\r\n  onColumnResize,\r\n  onColumnReorder,\r\n  accessibilityLabel = 'Data table',\r\n  announceChanges = true,\r\n  keyboardNavigation = true\r\n}: EnhancedDataTableProps<T>) => {\r\n\r\n  // State Management\r\n  const [searchQuery, setSearchQuery] = useState('')\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const [pageSize, setPageSize] = useState(pagination.pageSize)\r\n  const [selectedRows, setSelectedRows] = useState<Set<number>>(new Set())\r\n  const [sortStates, setSortStates] = useState<SortState[]>(sorting.defaultSort || [])\r\n  const [filters, setFilters] = useState<FilterState>({})\r\n  const [columnWidths, setColumnWidths] = useState<{ [key: string]: number }>({})\r\n  const [columnOrder, setColumnOrder] = useState<string[]>(columns.map(col => col.id))\r\n  const [hiddenColumns, setHiddenColumns] = useState<Set<string>>(new Set())\r\n  const [pinnedColumns, setPinnedColumns] = useState<Set<string>>(new Set())\r\n  const [groupBy, setGroupBy] = useState<GroupBy | null>(null)\r\n  const [showColumnSettings, setShowColumnSettings] = useState(false)\r\n  const [isFullscreen, setIsFullscreen] = useState(false)\r\n  const [lastUpdate, setLastUpdate] = useState<Date>(new Date())\r\n  const [changedRows, setChangedRows] = useState<Set<number>>(new Set())\r\n  const [hoveredRow, setHoveredRow] = useState<number | null>(null)\r\n  const [focusedCell, setFocusedCell] = useState<{ row: number; col: string } | null>(null)\r\n\r\n  // Refs\r\n  const tableRef = useRef<HTMLDivElement>(null)\r\n  const searchDebounceRef = useRef<NodeJS.Timeout>()\r\n\r\n  // Memoized filtered and sorted data\r\n  const processedData = useMemo(() => {\r\n    let result = [...data]\r\n\r\n    // Apply global search\r\n    if (globalSearch.enabled && searchQuery.trim()) {\r\n      const query = searchQuery.toLowerCase()\r\n      result = result.filter(row =>\r\n        columns.some(col => {\r\n          if (!col.searchable && col.searchable !== undefined) return false\r\n          const value = col.accessor ? col.accessor(row) : row[col.key]\r\n          return String(value).toLowerCase().includes(query)\r\n        })\r\n      )\r\n    }\r\n\r\n    // Apply column filters\r\n    Object.entries(filters).forEach(([columnId, filter]) => {\r\n      if (!filter.enabled) return\r\n\r\n      const column = columns.find(col => col.id === columnId)\r\n      if (!column) return\r\n\r\n      result = result.filter(row => {\r\n        const value = column.accessor ? column.accessor(row) : row[column.key]\r\n\r\n        switch (filter.operator) {\r\n          case 'equals':\r\n            return value === filter.value\r\n          case 'contains':\r\n            return String(value).toLowerCase().includes(String(filter.value).toLowerCase())\r\n          case 'starts_with':\r\n            return String(value).toLowerCase().startsWith(String(filter.value).toLowerCase())\r\n          case 'ends_with':\r\n            return String(value).toLowerCase().endsWith(String(filter.value).toLowerCase())\r\n          case 'greater_than':\r\n            return Number(value) > Number(filter.value)\r\n          case 'less_than':\r\n            return Number(value) < Number(filter.value)\r\n          case 'between':\r\n            return Array.isArray(filter.value) &&\r\n              Number(value) >= Number(filter.value[0]) &&\r\n              Number(value) <= Number(filter.value[1])\r\n          case 'in':\r\n            return Array.isArray(filter.value) && filter.value.includes(value)\r\n          case 'not_in':\r\n            return Array.isArray(filter.value) && !filter.value.includes(value)\r\n          default:\r\n            return true\r\n        }\r\n      })\r\n    })\r\n\r\n    // Apply sorting\r\n    if (sortStates.length > 0 && sorting.enabled) {\r\n      result.sort((a, b) => {\r\n        for (const sortState of sortStates.sort((a, b) => a.priority - b.priority)) {\r\n          const column = columns.find(col => col.id === sortState.column)\r\n          if (!column) continue\r\n\r\n          const aVal = column.accessor ? column.accessor(a) : a[column.key]\r\n          const bVal = column.accessor ? column.accessor(b) : b[column.key]\r\n\r\n          let comparison = 0\r\n\r\n          if (column.type === 'number' || column.type === 'currency' || column.type === 'percentage') {\r\n            comparison = Number(aVal) - Number(bVal)\r\n          } else if (column.type === 'date') {\r\n            comparison = new Date(aVal).getTime() - new Date(bVal).getTime()\r\n          } else {\r\n            comparison = String(aVal).localeCompare(String(bVal))\r\n          }\r\n\r\n          if (comparison !== 0) {\r\n            return sortState.direction === 'desc' ? -comparison : comparison\r\n          }\r\n        }\r\n        return 0\r\n      })\r\n    }\r\n\r\n    return result\r\n  }, [data, searchQuery, filters, sortStates, columns, globalSearch.enabled, sorting.enabled])\r\n\r\n  // Pagination calculations\r\n  const totalPages = pagination.enabled ? Math.ceil(processedData.length / pageSize) : 1\r\n  const startIndex = pagination.enabled ? (currentPage - 1) * pageSize : 0\r\n  const endIndex = pagination.enabled ? Math.min(startIndex + pageSize, processedData.length) : processedData.length\r\n  const paginatedData = pagination.enabled ? processedData.slice(startIndex, endIndex) : processedData\r\n\r\n  // Real-time updates\r\n  useEffect(() => {\r\n    if (!realtime.enabled) return\r\n\r\n    const interval = setInterval(() => {\r\n      setLastUpdate(new Date())\r\n\r\n      // Simulate data changes for demonstration\r\n      if (realtime.highlightChanges && Math.random() > 0.7) {\r\n        const randomIndex = Math.floor(Math.random() * paginatedData.length)\r\n        setChangedRows(prev => new Set([...prev, randomIndex]))\r\n\r\n        // Clear highlight after 3 seconds\r\n        setTimeout(() => {\r\n          setChangedRows(prev => {\r\n            const newSet = new Set(prev)\r\n            newSet.delete(randomIndex)\r\n            return newSet\r\n          })\r\n        }, 3000)\r\n      }\r\n    }, realtime.updateInterval)\r\n\r\n    return () => clearInterval(interval)\r\n  }, [realtime.enabled, realtime.updateInterval, realtime.highlightChanges, paginatedData.length])\r\n\r\n  // Search debouncing\r\n  const handleSearch = useCallback((value: string) => {\r\n    if (searchDebounceRef.current) {\r\n      clearTimeout(searchDebounceRef.current)\r\n    }\r\n\r\n    searchDebounceRef.current = setTimeout(() => {\r\n      setSearchQuery(value)\r\n      setCurrentPage(1) // Reset to first page when searching\r\n    }, globalSearch.debounceMs)\r\n  }, [globalSearch.debounceMs])\r\n\r\n  // Sorting handlers\r\n  const handleSort = useCallback((columnId: string) => {\r\n    if (!sorting.enabled) return\r\n\r\n    setSortStates(prev => {\r\n      const existingSort = prev.find(s => s.column === columnId)\r\n\r\n      if (existingSort) {\r\n        if (existingSort.direction === 'asc') {\r\n          return prev.map(s => s.column === columnId ? { ...s, direction: 'desc' as const } : s)\r\n        } else {\r\n          return prev.filter(s => s.column !== columnId)\r\n        }\r\n      } else {\r\n        if (sorting.multiSort) {\r\n          return [...prev, { column: columnId, direction: 'asc', priority: prev.length }]\r\n        } else {\r\n          return [{ column: columnId, direction: 'asc', priority: 0 }]\r\n        }\r\n      }\r\n    })\r\n  }, [sorting.enabled, sorting.multiSort])\r\n\r\n  // Selection handlers\r\n  const handleRowSelect = useCallback((rowIndex: number, selected: boolean) => {\r\n    setSelectedRows(prev => {\r\n      const newSet = new Set(prev)\r\n      if (selected) {\r\n        if (selection.mode === 'single') {\r\n          newSet.clear()\r\n        }\r\n        newSet.add(rowIndex)\r\n      } else {\r\n        newSet.delete(rowIndex)\r\n      }\r\n      return newSet\r\n    })\r\n  }, [selection.mode])\r\n\r\n  const handleSelectAll = useCallback((selected: boolean) => {\r\n    if (selected) {\r\n      setSelectedRows(new Set(paginatedData.map((_, index) => startIndex + index)))\r\n    } else {\r\n      setSelectedRows(new Set())\r\n    }\r\n  }, [paginatedData, startIndex])\r\n\r\n  // Format cell values\r\n  const formatCellValue = useCallback((column: ColumnDef<T>, value: any, row: T) => {\r\n    if (column.formatter) {\r\n      return column.formatter(value, row)\r\n    }\r\n\r\n    switch (column.type) {\r\n      case 'currency':\r\n        const currency = column.metadata?.currency || 'USD'\r\n        return new Intl.NumberFormat('en-US', {\r\n          style: 'currency',\r\n          currency\r\n        }).format(Number(value) || 0)\r\n\r\n      case 'percentage':\r\n        const precision = column.metadata?.precision || 1\r\n        return `${(Number(value) || 0).toFixed(precision)}%`\r\n\r\n      case 'number':\r\n        return (Number(value) || 0).toLocaleString()\r\n\r\n      case 'date':\r\n        const dateFormat = column.metadata?.dateFormat || 'MM/dd/yyyy'\r\n        return new Date(value).toLocaleDateString()\r\n\r\n      case 'boolean':\r\n        return (\r\n          <Badge variant={value ? 'default' : 'secondary'}>\r\n            {value ? (\r\n              <CheckCircle className=\"h-3 w-3 mr-1\" />\r\n            ) : (\r\n              <XCircle className=\"h-3 w-3 mr-1\" />\r\n            )}\r\n            {value ? 'Yes' : 'No'}\r\n          </Badge>\r\n        )\r\n\r\n      case 'badge':\r\n        return <Badge variant=\"outline\">{String(value)}</Badge>\r\n\r\n      default:\r\n        return String(value || '')\r\n    }\r\n  }, [])\r\n\r\n  // Get column sort state\r\n  const getColumnSortState = useCallback((columnId: string) => {\r\n    return sortStates.find(s => s.column === columnId)\r\n  }, [sortStates])\r\n\r\n  // Loading state\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center p-16\">\r\n        <motion.div\r\n          animate={{ rotate: 360 }}\r\n          transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\r\n          className=\"p-4 bg-primary-100 rounded-full\"\r\n        >\r\n          <Loader2 className=\"h-8 w-8 text-primary-600\" />\r\n        </motion.div>\r\n        <div className=\"ml-4\">\r\n          <div className=\"text-lg font-semibold\">Loading data...</div>\r\n          <div className=\"text-sm text-muted-foreground\">Please wait while we fetch your data</div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Error state\r\n  if (error) {\r\n    return (\r\n      <Card className=\"border-red-200 bg-red-50\">\r\n        <CardContent className=\"p-8 text-center\">\r\n          <AlertTriangle className=\"h-12 w-12 text-red-600 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-semibold text-red-800 mb-2\">Error Loading Data</h3>\r\n          <p className=\"text-red-600\">{error}</p>\r\n          <Button variant=\"outline\" className=\"mt-4\" onClick={() => window.location.reload()}>\r\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n            Try Again\r\n          </Button>\r\n        </CardContent>\r\n      </Card>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <div className={cn(\r\n        \"space-y-4\",\r\n        isFullscreen && \"fixed inset-0 z-50 bg-white p-6 overflow-auto\"\r\n      )}>\r\n        {/* Header Controls */}\r\n        <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4\">\r\n          {/* Search and Filters */}\r\n          <div className=\"flex items-center gap-4 flex-1\">\r\n            {globalSearch.enabled && (\r\n              <div className=\"relative flex-1 max-w-md\">\r\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  placeholder={globalSearch.placeholder}\r\n                  onChange={(e) => handleSearch(e.target.value)}\r\n                  className=\"pl-10\"\r\n                />\r\n              </div>\r\n            )}\r\n\r\n            {/* Active Filters Display */}\r\n            <AnimatePresence>\r\n              {Object.entries(filters).some(([_, filter]) => filter.enabled) && (\r\n                <motion.div\r\n                  initial={{ opacity: 0, width: 0 }}\r\n                  animate={{ opacity: 1, width: 'auto' }}\r\n                  exit={{ opacity: 0, width: 0 }}\r\n                  className=\"flex items-center gap-2\"\r\n                >\r\n                  {Object.entries(filters)\r\n                    .filter(([_, filter]) => filter.enabled)\r\n                    .map(([columnId, filter]) => {\r\n                      const column = columns.find(col => col.id === columnId)\r\n                      return (\r\n                        <Badge key={columnId} variant=\"secondary\" className=\"flex items-center gap-1\">\r\n                          <Filter className=\"h-3 w-3\" />\r\n                          {column?.header}: {String(filter.value)}\r\n                          <button\r\n                            onClick={() => setFilters(prev => ({\r\n                              ...prev,\r\n                              [columnId]: { ...prev[columnId], enabled: false }\r\n                            }))}\r\n                            className=\"ml-1 hover:bg-gray-200 rounded-full p-0.5\"\r\n                          >\r\n                            ×\r\n                          </button>\r\n                        </Badge>\r\n                      )\r\n                    })}\r\n                </motion.div>\r\n              )}\r\n            </AnimatePresence>\r\n          </div>\r\n\r\n          {/* Action Buttons */}\r\n          <div className=\"flex items-center gap-2\">\r\n            {/* Real-time Status */}\r\n            {realtime.enabled && realtime.showLastUpdate && (\r\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                <motion.div\r\n                  animate={{ scale: [1, 1.2, 1] }}\r\n                  transition={{ duration: 2, repeat: Infinity }}\r\n                >\r\n                  <Activity className=\"h-4 w-4 text-green-500\" />\r\n                </motion.div>\r\n                Last updated: {lastUpdate.toLocaleTimeString()}\r\n              </div>\r\n            )}\r\n\r\n            {/* Bulk Actions */}\r\n            {selection.enabled && selectedRows.size > 0 && actions?.bulk && (\r\n              <div className=\"flex items-center gap-2\">\r\n                <Badge variant=\"secondary\">\r\n                  {selectedRows.size} selected\r\n                </Badge>\r\n                {actions.bulk.map(action => {\r\n                  const Icon = action.icon || MoreHorizontal\r\n                  return (\r\n                    <Button\r\n                      key={action.id}\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => {\r\n                        const rows = Array.from(selectedRows).map(index => processedData[index])\r\n                        action.handler(rows)\r\n                      }}\r\n                    >\r\n                      <Icon className=\"h-4 w-4 mr-2\" />\r\n                      {action.label}\r\n                    </Button>\r\n                  )\r\n                })}\r\n              </div>\r\n            )}\r\n\r\n            {/* Export */}\r\n            {actions?.export?.enabled && (\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                <Download className=\"h-4 w-4 mr-2\" />\r\n                Export\r\n              </Button>\r\n            )}\r\n\r\n            {/* Column Settings */}\r\n            <Popover open={showColumnSettings} onOpenChange={setShowColumnSettings}>\r\n              <PopoverTrigger asChild>\r\n                <Button variant=\"outline\" size=\"sm\">\r\n                  <Columns className=\"h-4 w-4 mr-2\" />\r\n                  Columns\r\n                </Button>\r\n              </PopoverTrigger>\r\n              <PopoverContent className=\"w-80\">\r\n                <div className=\"space-y-4\">\r\n                  <div className=\"font-semibold\">Manage Columns</div>\r\n                  <ScrollArea className=\"h-64\">\r\n                    <div className=\"space-y-2\">\r\n                      {columns.map(column => (\r\n                        <div key={column.id} className=\"flex items-center justify-between\">\r\n                          <div className=\"flex items-center space-x-2\">\r\n                            <Checkbox\r\n                              checked={!hiddenColumns.has(column.id)}\r\n                              onCheckedChange={(checked) => {\r\n                                setHiddenColumns(prev => {\r\n                                  const newSet = new Set(prev)\r\n                                  if (checked) {\r\n                                    newSet.delete(column.id)\r\n                                  } else {\r\n                                    newSet.add(column.id)\r\n                                  }\r\n                                  return newSet\r\n                                })\r\n                              }}\r\n                            />\r\n                            <span className=\"text-sm\">{column.header}</span>\r\n                          </div>\r\n                          <div className=\"flex items-center gap-1\">\r\n                            {column.pinnable && (\r\n                              <Button\r\n                                variant=\"ghost\"\r\n                                size=\"sm\"\r\n                                onClick={() => {\r\n                                  setPinnedColumns(prev => {\r\n                                    const newSet = new Set(prev)\r\n                                    if (newSet.has(column.id)) {\r\n                                      newSet.delete(column.id)\r\n                                    } else {\r\n                                      newSet.add(column.id)\r\n                                    }\r\n                                    return newSet\r\n                                  })\r\n                                }}\r\n                              >\r\n                                {pinnedColumns.has(column.id) ? (\r\n                                  <PinOff className=\"h-3 w-3\" />\r\n                                ) : (\r\n                                  <Pin className=\"h-3 w-3\" />\r\n                                )}\r\n                              </Button>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </ScrollArea>\r\n                </div>\r\n              </PopoverContent>\r\n            </Popover>\r\n\r\n            {/* Fullscreen Toggle */}\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={() => setIsFullscreen(!isFullscreen)}\r\n            >\r\n              {isFullscreen ? (\r\n                <Minimize2 className=\"h-4 w-4\" />\r\n              ) : (\r\n                <Maximize2 className=\"h-4 w-4\" />\r\n              )}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Table Container */}\r\n        <Card className=\"border-0 shadow-xl overflow-hidden\">\r\n          <div\r\n            ref={tableRef}\r\n            className=\"overflow-auto max-h-[70vh] border border-gray-200 rounded-lg\"\r\n          >\r\n            <Table>\r\n              {/* Header */}\r\n              <TableHeader className={cn(\r\n                appearance.stickyHeader && \"sticky top-0 z-10 bg-white shadow-sm\"\r\n              )}>\r\n                <TableRow className=\"border-b-2 border-gray-200\">\r\n                  {/* Row Number Header */}\r\n                  {appearance.showRowNumbers && (\r\n                    <TableHead className=\"w-16 text-center font-bold\">#</TableHead>\r\n                  )}\r\n\r\n                  {/* Select All Header */}\r\n                  {selection.enabled && selection.showSelectAll && (\r\n                    <TableHead className=\"w-12\">\r\n                      <Checkbox\r\n                        checked={selectedRows.size === paginatedData.length && paginatedData.length > 0}\r\n                        onCheckedChange={handleSelectAll}\r\n                        aria-label=\"Select all rows\"\r\n                      />\r\n                    </TableHead>\r\n                  )}\r\n\r\n                  {/* Column Headers */}\r\n                  {columns\r\n                    .filter(col => !hiddenColumns.has(col.id))\r\n                    .map(column => {\r\n                      const sortState = getColumnSortState(column.id)\r\n                      const isPinned = pinnedColumns.has(column.id)\r\n\r\n                      return (\r\n                        <TableHead\r\n                          key={column.id}\r\n                          className={cn(\r\n                            \"relative group select-none\",\r\n                            column.align === 'center' && \"text-center\",\r\n                            column.align === 'right' && \"text-right\",\r\n                            isPinned && \"sticky bg-white shadow-sm\",\r\n                            column.sticky === 'left' && \"left-0\",\r\n                            column.sticky === 'right' && \"right-0\",\r\n                            column.sortable !== false && sorting.enabled && \"cursor-pointer hover:bg-gray-50\"\r\n                          )}\r\n                          style={{\r\n                            width: columnWidths[column.id] || column.width,\r\n                            minWidth: column.minWidth,\r\n                            maxWidth: column.maxWidth\r\n                          }}\r\n                          onClick={() => column.sortable !== false && handleSort(column.id)}\r\n                        >\r\n                          <div className=\"flex items-center gap-2\">\r\n                            {column.metadata?.icon && (\r\n                              <column.metadata.icon className=\"h-4 w-4 text-gray-500\" />\r\n                            )}\r\n\r\n                            <span className=\"font-semibold text-gray-700\">\r\n                              {column.header}\r\n                            </span>\r\n\r\n                            {column.description && (\r\n                              <Tooltip>\r\n                                <TooltipTrigger>\r\n                                  <HelpCircle className=\"h-3 w-3 text-gray-400\" />\r\n                                </TooltipTrigger>\r\n                                <TooltipContent>\r\n                                  <p className=\"max-w-64\">{column.description}</p>\r\n                                </TooltipContent>\r\n                              </Tooltip>\r\n                            )}\r\n\r\n                            {/* Sort Indicators */}\r\n                            {column.sortable !== false && sorting.enabled && (\r\n                              <div className=\"flex flex-col\">\r\n                                {sortState ? (\r\n                                  sortState.direction === 'asc' ? (\r\n                                    <SortAsc className=\"h-4 w-4 text-blue-600\" />\r\n                                  ) : (\r\n                                    <SortDesc className=\"h-4 w-4 text-blue-600\" />\r\n                                  )\r\n                                ) : (\r\n                                  <ArrowUpDown className=\"h-4 w-4 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity\" />\r\n                                )}\r\n                                {sorting.multiSort && sortState && (\r\n                                  <Badge variant=\"secondary\" className=\"text-xs h-4 w-4 rounded-full p-0 flex items-center justify-center\">\r\n                                    {sortState.priority + 1}\r\n                                  </Badge>\r\n                                )}\r\n                              </div>\r\n                            )}\r\n\r\n                            {/* Pin Indicator */}\r\n                            {isPinned && (\r\n                              <Pin className=\"h-3 w-3 text-gray-500\" />\r\n                            )}\r\n                          </div>\r\n\r\n                          {/* Column Resizer */}\r\n                          {column.resizable !== false && (\r\n                            <div className=\"absolute right-0 top-0 w-1 h-full cursor-col-resize hover:bg-blue-500 transition-colors\" />\r\n                          )}\r\n                        </TableHead>\r\n                      )\r\n                    })}\r\n\r\n                  {/* Actions Header */}\r\n                  {actions?.row && actions.row.length > 0 && (\r\n                    <TableHead className=\"w-20 text-center\">Actions</TableHead>\r\n                  )}\r\n                </TableRow>\r\n              </TableHeader>\r\n\r\n              {/* Body */}\r\n              <TableBody>\r\n                <AnimatePresence mode=\"popLayout\">\r\n                  {paginatedData.map((row, index) => {\r\n                    const absoluteIndex = startIndex + index\r\n                    const isSelected = selectedRows.has(absoluteIndex)\r\n                    const isChanged = changedRows.has(index)\r\n                    const isHovered = hoveredRow === index\r\n\r\n                    return (\r\n                      <motion.tr\r\n                        key={`row-${absoluteIndex}`}\r\n                        layout\r\n                        initial={{ opacity: 0, y: 20 }}\r\n                        animate={{\r\n                          opacity: 1,\r\n                          y: 0,\r\n                          backgroundColor: isChanged ? 'rgba(34, 197, 94, 0.1)' : 'transparent'\r\n                        }}\r\n                        exit={{ opacity: 0, y: -20 }}\r\n                        transition={{ duration: 0.2 }}\r\n                        className={cn(\r\n                          \"group transition-all duration-200 border-b border-gray-100\",\r\n                          appearance.alternatingRows && index % 2 === 1 && \"bg-gray-50/50\",\r\n                          appearance.highlightOnHover && \"hover:bg-blue-50/50\",\r\n                          isSelected && \"bg-blue-100/50 border-blue-200\",\r\n                          appearance.compactMode ? \"h-8\" : \"h-12\",\r\n                          onRowClick && \"cursor-pointer\"\r\n                        )}\r\n                        onMouseEnter={() => setHoveredRow(index)}\r\n                        onMouseLeave={() => setHoveredRow(null)}\r\n                        onClick={() => onRowClick?.(row, absoluteIndex)}\r\n                        onDoubleClick={() => onRowDoubleClick?.(row, absoluteIndex)}\r\n                      >\r\n                        {/* Row Numbers */}\r\n                        {appearance.showRowNumbers && (\r\n                          <TableCell className=\"text-center text-sm text-gray-500 font-mono\">\r\n                            {absoluteIndex + 1}\r\n                          </TableCell>\r\n                        )}\r\n\r\n                        {/* Row Selection */}\r\n                        {selection.enabled && (\r\n                          <TableCell>\r\n                            <Checkbox\r\n                              checked={isSelected}\r\n                              onCheckedChange={(checked) => handleRowSelect(absoluteIndex, !!checked)}\r\n                              onClick={(e) => e.stopPropagation()}\r\n                              aria-label={`Select row ${absoluteIndex + 1}`}\r\n                            />\r\n                          </TableCell>\r\n                        )}\r\n\r\n                        {/* Data Cells */}\r\n                        {columns\r\n                          .filter(col => !hiddenColumns.has(col.id))\r\n                          .map(column => {\r\n                            const value = column.accessor ? column.accessor(row) : row[column.key]\r\n                            const isPinned = pinnedColumns.has(column.id)\r\n\r\n                            return (\r\n                              <TableCell\r\n                                key={column.id}\r\n                                className={cn(\r\n                                  \"relative\",\r\n                                  column.align === 'center' && \"text-center\",\r\n                                  column.align === 'right' && \"text-right\",\r\n                                  isPinned && \"sticky bg-white shadow-sm\",\r\n                                  column.sticky === 'left' && \"left-0\",\r\n                                  column.sticky === 'right' && \"right-0\",\r\n                                  appearance.compactMode ? \"py-1 px-2\" : \"py-3 px-4\"\r\n                                )}\r\n                                style={{\r\n                                  width: columnWidths[column.id] || column.width,\r\n                                  minWidth: column.minWidth,\r\n                                  maxWidth: column.maxWidth\r\n                                }}\r\n                              >\r\n                                <div className=\"flex items-center gap-2\">\r\n                                  {formatCellValue(column, value, row)}\r\n\r\n                                  {/* Validation Indicators */}\r\n                                  {column.validationRules && column.validationRules.some(rule => !rule.rule(value)) && (\r\n                                    <Tooltip>\r\n                                      <TooltipTrigger>\r\n                                        <AlertTriangle className=\"h-3 w-3 text-red-500\" />\r\n                                      </TooltipTrigger>\r\n                                      <TooltipContent>\r\n                                        {column.validationRules\r\n                                          .filter(rule => !rule.rule(value))\r\n                                          .map(rule => (\r\n                                            <p key={rule.message}>{rule.message}</p>\r\n                                          ))\r\n                                        }\r\n                                      </TooltipContent>\r\n                                    </Tooltip>\r\n                                  )}\r\n\r\n                                  {/* Change Indicator */}\r\n                                  {isChanged && (\r\n                                    <motion.div\r\n                                      initial={{ scale: 0 }}\r\n                                      animate={{ scale: 1 }}\r\n                                      className=\"w-2 h-2 bg-green-500 rounded-full\"\r\n                                    />\r\n                                  )}\r\n                                </div>\r\n                              </TableCell>\r\n                            )\r\n                          })}\r\n\r\n                        {/* Row Actions */}\r\n                        {actions?.row && actions.row.length > 0 && (\r\n                          <TableCell className=\"text-center\">\r\n                            <div className={cn(\r\n                              \"flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\",\r\n                              isHovered && \"opacity-100\"\r\n                            )}>\r\n                              {actions.row\r\n                                .filter(action => !action.condition || action.condition(row))\r\n                                .map(action => {\r\n                                  const Icon = action.icon || MoreHorizontal\r\n                                  return (\r\n                                    <Button\r\n                                      key={action.id}\r\n                                      variant=\"ghost\"\r\n                                      size=\"sm\"\r\n                                      onClick={(e) => {\r\n                                        e.stopPropagation()\r\n                                        action.handler(row, absoluteIndex)\r\n                                      }}\r\n                                      className=\"h-8 w-8 p-0\"\r\n                                    >\r\n                                      <Icon className=\"h-4 w-4\" />\r\n                                    </Button>\r\n                                  )\r\n                                })}\r\n                            </div>\r\n                          </TableCell>\r\n                        )}\r\n                      </motion.tr>\r\n                    )\r\n                  })}\r\n                </AnimatePresence>\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n        </Card>\r\n\r\n        {/* Pagination */}\r\n        {pagination.enabled && totalPages > 1 && (\r\n          <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\r\n            {/* Info */}\r\n            {pagination.showInfo && (\r\n              <div className=\"text-sm text-muted-foreground\">\r\n                Showing {startIndex + 1} to {endIndex} of {processedData.length} entries\r\n                {processedData.length !== data.length && (\r\n                  <span> (filtered from {data.length} total)</span>\r\n                )}\r\n              </div>\r\n            )}\r\n\r\n            {/* Page Size Selector */}\r\n            {pagination.showSizeSelector && (\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"text-sm text-muted-foreground\">Show</span>\r\n                <Select\r\n                  value={pageSize.toString()}\r\n                  onValueChange={(value) => {\r\n                    setPageSize(Number(value))\r\n                    setCurrentPage(1)\r\n                  }}\r\n                >\r\n                  <SelectTrigger className=\"w-20\">\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {pagination.pageSizeOptions.map(size => (\r\n                      <SelectItem key={size} value={size.toString()}>\r\n                        {size}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n                <span className=\"text-sm text-muted-foreground\">entries</span>\r\n              </div>\r\n            )}\r\n\r\n            {/* Pagination Controls */}\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setCurrentPage(1)}\r\n                disabled={currentPage === 1}\r\n              >\r\n                <ChevronsLeft className=\"h-4 w-4\" />\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}\r\n                disabled={currentPage === 1}\r\n              >\r\n                <ChevronLeft className=\"h-4 w-4\" />\r\n              </Button>\r\n\r\n              {/* Page Numbers */}\r\n              <div className=\"flex items-center gap-1\">\r\n                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\r\n                  const page = Math.max(1, Math.min(totalPages - 4, currentPage - 2)) + i\r\n                  return (\r\n                    <Button\r\n                      key={page}\r\n                      variant={page === currentPage ? 'default' : 'outline'}\r\n                      size=\"sm\"\r\n                      onClick={() => setCurrentPage(page)}\r\n                      className=\"w-10 h-10 p-0\"\r\n                    >\r\n                      {page}\r\n                    </Button>\r\n                  )\r\n                })}\r\n              </div>\r\n\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}\r\n                disabled={currentPage === totalPages}\r\n              >\r\n                <ChevronRight className=\"h-4 w-4\" />\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => setCurrentPage(totalPages)}\r\n                disabled={currentPage === totalPages}\r\n              >\r\n                <ChevronsRight className=\"h-4 w-4\" />\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </TooltipProvider>\r\n  )\r\n}\r\n\r\nexport default EnhancedDataTable","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\dialog.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":59,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":59,"endColumn":39},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":73,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":73,"endColumn":39}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\r\nimport { X } from \"lucide-react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst Dialog = DialogPrimitive.Root\r\n\r\nconst DialogTrigger = DialogPrimitive.Trigger\r\n\r\nconst DialogPortal = DialogPrimitive.Portal\r\n\r\nconst DialogClose = DialogPrimitive.Close\r\n\r\nconst DialogOverlay = React.forwardRef<\r\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\r\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\r\n>(({ className, ...props }, ref) => (\r\n  <DialogPrimitive.Overlay\r\n    ref={ref}\r\n    className={cn(\r\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\r\n\r\nconst DialogContent = React.forwardRef<\r\n  React.ElementRef<typeof DialogPrimitive.Content>,\r\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\r\n>(({ className, children, ...props }, ref) => (\r\n  <DialogPortal>\r\n    <DialogOverlay />\r\n    <DialogPrimitive.Content\r\n      ref={ref}\r\n      className={cn(\r\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\r\n        className\r\n      )}\r\n      {...props}\r\n    >\r\n      {children}\r\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\r\n        <X className=\"h-4 w-4\" />\r\n        <span className=\"sr-only\">Close</span>\r\n      </DialogPrimitive.Close>\r\n    </DialogPrimitive.Content>\r\n  </DialogPortal>\r\n))\r\nDialogContent.displayName = DialogPrimitive.Content.displayName\r\n\r\nconst DialogHeader = ({\r\n  className,\r\n  ...props\r\n}: React.HTMLAttributes<HTMLDivElement>) => (\r\n  <div\r\n    className={cn(\r\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n)\r\nDialogHeader.displayName = \"DialogHeader\"\r\n\r\nconst DialogFooter = ({\r\n  className,\r\n  ...props\r\n}: React.HTMLAttributes<HTMLDivElement>) => (\r\n  <div\r\n    className={cn(\r\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n)\r\nDialogFooter.displayName = \"DialogFooter\"\r\n\r\nconst DialogTitle = React.forwardRef<\r\n  React.ElementRef<typeof DialogPrimitive.Title>,\r\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\r\n>(({ className, ...props }, ref) => (\r\n  <DialogPrimitive.Title\r\n    ref={ref}\r\n    className={cn(\r\n      \"text-lg font-semibold leading-none tracking-tight\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\nDialogTitle.displayName = DialogPrimitive.Title.displayName\r\n\r\nconst DialogDescription = React.forwardRef<\r\n  React.ElementRef<typeof DialogPrimitive.Description>,\r\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\r\n>(({ className, ...props }, ref) => (\r\n  <DialogPrimitive.Description\r\n    ref={ref}\r\n    className={cn(\"text-sm text-muted-foreground\", className)}\r\n    {...props}\r\n  />\r\n))\r\nDialogDescription.displayName = DialogPrimitive.Description.displayName\r\n\r\nexport {\r\n  Dialog,\r\n  DialogPortal,\r\n  DialogOverlay,\r\n  DialogClose,\r\n  DialogTrigger,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogFooter,\r\n  DialogTitle,\r\n  DialogDescription,\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\empty-states.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'InboxOff' is not defined.","line":150,"column":17,"nodeType":"JSXIdentifier","messageId":"undef","endLine":150,"endColumn":25}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n\"use client\"\r\n\r\nimport React from 'react';\r\nimport {\r\n  PackageX,\r\n  AlertCircle,\r\n  FileX,\r\n  Inbox,\r\n  SearchX,\r\n  Database,\r\n  FilterX,\r\n  CheckCircle2\r\n} from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent } from '@/components/ui/card';\r\n\r\ninterface EmptyStateProps {\r\n  title: string;\r\n  description: string;\r\n  icon?: React.ReactNode;\r\n  action?: {\r\n    label: string;\r\n    onClick: () => void;\r\n  };\r\n  className?: string;\r\n}\r\n\r\nexport const EmptyState: React.FC<EmptyStateProps> = ({\r\n  title,\r\n  description,\r\n  icon,\r\n  action,\r\n  className = ''\r\n}) => (\r\n  <div\r\n    className={`flex flex-col items-center justify-center p-8 text-center ${className}`}\r\n    role=\"status\"\r\n    aria-live=\"polite\"\r\n  >\r\n    <div className=\"mb-4 text-muted-foreground opacity-50\" aria-hidden=\"true\">\r\n      {icon || <Inbox className=\"h-12 w-12\" />}\r\n    </div>\r\n\r\n    <h3 className=\"text-lg font-semibold text-foreground mb-2\">\r\n      {title}\r\n    </h3>\r\n\r\n    <p className=\"text-sm text-muted-foreground mb-4 max-w-sm\">\r\n      {description}\r\n    </p>\r\n\r\n    {action && (\r\n      <Button\r\n        onClick={action.onClick}\r\n        variant=\"default\"\r\n        size=\"sm\"\r\n        aria-label={action.label}\r\n      >\r\n        {action.label}\r\n      </Button>\r\n    )}\r\n  </div>\r\n);\r\n\r\nexport const NoAlertsEmptyState: React.FC<{ onRefresh?: () => void }> = ({\r\n  onRefresh\r\n}) => (\r\n  <EmptyState\r\n    icon={<CheckCircle2 className=\"h-12 w-12\" />}\r\n    title=\"No Active Alerts\"\r\n    description=\"Great job! All alerts have been addressed. The system is running smoothly.\"\r\n    action={onRefresh ? { label: 'Refresh', onClick: onRefresh } : undefined}\r\n  />\r\n);\r\n\r\nexport const NoActivitiesEmptyState: React.FC<{ onRefresh?: () => void }> = ({\r\n  onRefresh\r\n}) => (\r\n  <EmptyState\r\n    icon={<AlertCircle className=\"h-12 w-12\" />}\r\n    title=\"No Recent Activities\"\r\n    description=\"There haven't been any activities in your system recently. Check back later for updates.\"\r\n    action={onRefresh ? { label: 'Refresh', onClick: onRefresh } : undefined}\r\n  />\r\n);\r\n\r\nexport const NoInventoryEmptyState: React.FC<{ onAdd?: () => void }> = ({\r\n  onAdd\r\n}) => (\r\n  <EmptyState\r\n    icon={<PackageX className=\"h-12 w-12\" />}\r\n    title=\"No Inventory Items\"\r\n    description=\"Your inventory is empty. Start by adding your first product to track stock levels.\"\r\n    action={onAdd ? { label: 'Add Item', onClick: onAdd } : undefined}\r\n  />\r\n);\r\n\r\nexport const NoSearchResultsEmptyState: React.FC<{ onClear?: () => void }> = ({\r\n  onClear\r\n}) => (\r\n  <EmptyState\r\n    icon={<SearchX className=\"h-12 w-12\" />}\r\n    title=\"No Results Found\"\r\n    description=\"We couldn't find anything matching your search. Try adjusting your filters or search terms.\"\r\n    action={onClear ? { label: 'Clear Filters', onClick: onClear } : undefined}\r\n  />\r\n);\r\n\r\nexport const NoDataEmptyState: React.FC<{ onRetry?: () => void }> = ({\r\n  onRetry\r\n}) => (\r\n  <EmptyState\r\n    icon={<Database className=\"h-12 w-12\" />}\r\n    title=\"No Data Available\"\r\n    description=\"There's no data to display at the moment. This might be because the data source is empty or unavailable.\"\r\n    action={onRetry ? { label: 'Retry', onClick: onRetry } : undefined}\r\n  />\r\n);\r\n\r\nexport const NoFilteredResultsEmptyState: React.FC<{ onClearFilters?: () => void }> = ({\r\n  onClearFilters\r\n}) => (\r\n  <EmptyState\r\n    icon={<FilterX className=\"h-12 w-12\" />}\r\n    title=\"No Matches\"\r\n    description=\"No items match your current filters. Try adjusting or clearing filters to see more results.\"\r\n    action={onClearFilters ? { label: 'Clear Filters', onClick: onClearFilters } : undefined}\r\n  />\r\n);\r\n\r\nexport const CardEmptyState: React.FC<EmptyStateProps> = (props) => (\r\n  <Card className=\"border-dashed\">\r\n    <CardContent className=\"pt-6\">\r\n      <EmptyState {...props} />\r\n    </CardContent>\r\n  </Card>\r\n);\r\n\r\nexport const InlineEmptyState: React.FC<{\r\n  icon?: React.ReactNode;\r\n  message: string;\r\n}> = ({ icon, message }) => (\r\n  <div\r\n    className=\"flex items-center justify-center gap-2 p-4 text-sm text-muted-foreground\"\r\n    role=\"status\"\r\n    aria-live=\"polite\"\r\n  >\r\n    <div className=\"opacity-50\" aria-hidden=\"true\">\r\n      {icon || <InboxOff className=\"h-5 w-5\" />}\r\n    </div>\r\n    <span>{message}</span>\r\n  </div>\r\n);\r\n\r\nexport const MinimalEmptyState: React.FC<{ message: string }> = ({\r\n  message\r\n}) => (\r\n  <div\r\n    className=\"text-center py-6 text-sm text-muted-foreground\"\r\n    role=\"status\"\r\n    aria-live=\"polite\"\r\n  >\r\n    {message}\r\n  </div>\r\n);\r\n\r\nexport default EmptyState;\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\error-states.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n\"use client\"\r\nimport React from 'react';\r\nimport { AlertTriangle, RefreshCw, ServerOff, Database, WifiOff, ShieldAlert } from 'lucide-react';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent } from '@/components/ui/card';\r\n\r\ninterface ErrorStateProps {\r\n  error: Error | string;\r\n  onRetry?: () => void;\r\n  context?: string;\r\n  fullPage?: boolean;\r\n}\r\n\r\ninterface ErrorDisplayConfig {\r\n  icon: React.ReactNode;\r\n  title: string;\r\n  description: string;\r\n  color: string;\r\n}\r\n\r\nconst getErrorConfig = (error: Error | string): ErrorDisplayConfig => {\r\n  const errorMessage = typeof error === 'string' ? error : error.message;\r\n  const errorLower = errorMessage.toLowerCase();\r\n\r\n  if (errorLower.includes('timeout') || errorLower.includes('timed out')) {\r\n    return {\r\n      icon: <WifiOff className=\"h-12 w-12\" />,\r\n      title: 'Request Timeout',\r\n      description: 'The server took too long to respond. Please check your connection and try again.',\r\n      color: 'text-orange-600'\r\n    };\r\n  }\r\n\r\n  if (errorLower.includes('network') || errorLower.includes('fetch')) {\r\n    return {\r\n      icon: <WifiOff className=\"h-12 w-12\" />,\r\n      title: 'Network Error',\r\n      description: 'Unable to connect to the server. Please check your internet connection.',\r\n      color: 'text-red-600'\r\n    };\r\n  }\r\n\r\n  if (errorLower.includes('database') || errorLower.includes('sql')) {\r\n    return {\r\n      icon: <Database className=\"h-12 w-12\" />,\r\n      title: 'Database Error',\r\n      description: 'There was a problem accessing the database. Our team has been notified.',\r\n      color: 'text-red-600'\r\n    };\r\n  }\r\n\r\n  if (errorLower.includes('server') || errorLower.includes('500')) {\r\n    return {\r\n      icon: <ServerOff className=\"h-12 w-12\" />,\r\n      title: 'Server Error',\r\n      description: 'The server encountered an error. Please try again later.',\r\n      color: 'text-red-600'\r\n    };\r\n  }\r\n\r\n  if (errorLower.includes('unauthorized') || errorLower.includes('401')) {\r\n    return {\r\n      icon: <ShieldAlert className=\"h-12 w-12\" />,\r\n      title: 'Authentication Required',\r\n      description: 'You need to be logged in to access this resource.',\r\n      color: 'text-yellow-600'\r\n    };\r\n  }\r\n\r\n  if (errorLower.includes('forbidden') || errorLower.includes('403')) {\r\n    return {\r\n      icon: <ShieldAlert className=\"h-12 w-12\" />,\r\n      title: 'Access Denied',\r\n      description: 'You do not have permission to access this resource.',\r\n      color: 'text-red-600'\r\n    };\r\n  }\r\n\r\n  if (errorLower.includes('not found') || errorLower.includes('404')) {\r\n    return {\r\n      icon: <AlertTriangle className=\"h-12 w-12\" />,\r\n      title: 'Resource Not Found',\r\n      description: 'The requested resource could not be found.',\r\n      color: 'text-orange-600'\r\n    };\r\n  }\r\n\r\n  return {\r\n    icon: <AlertTriangle className=\"h-12 w-12\" />,\r\n    title: 'Something Went Wrong',\r\n    description: 'An unexpected error occurred. Please try again.',\r\n    color: 'text-red-600'\r\n  };\r\n};\r\n\r\nexport const ErrorState: React.FC<ErrorStateProps> = ({\r\n  error,\r\n  onRetry,\r\n  context,\r\n  fullPage = false\r\n}) => {\r\n  const config = getErrorConfig(error);\r\n  const errorMessage = typeof error === 'string' ? error : error.message;\r\n\r\n  const containerClass = fullPage\r\n    ? 'flex items-center justify-center min-h-screen p-6'\r\n    : 'flex items-center justify-center p-6';\r\n\r\n  return (\r\n    <div className={containerClass} role=\"alert\" aria-live=\"assertive\">\r\n      <Card className=\"max-w-md w-full border-red-200 bg-red-50\">\r\n        <CardContent className=\"pt-6\">\r\n          <div className=\"flex flex-col items-center text-center\">\r\n            <div className={`mb-4 ${config.color}`} aria-hidden=\"true\">\r\n              {config.icon}\r\n            </div>\r\n\r\n            <h2 className=\"text-xl font-semibold text-gray-900 mb-2\">\r\n              {config.title}\r\n            </h2>\r\n\r\n            <p className=\"text-gray-700 mb-4\">\r\n              {config.description}\r\n            </p>\r\n\r\n            {context && (\r\n              <p className=\"text-sm text-gray-600 mb-4\">\r\n                Context: {context}\r\n              </p>\r\n            )}\r\n\r\n            {process.env.NODE_ENV === 'development' && (\r\n              <details className=\"w-full mb-4 text-left\">\r\n                <summary className=\"text-sm text-gray-600 cursor-pointer hover:text-gray-800\">\r\n                  Technical Details\r\n                </summary>\r\n                <pre className=\"mt-2 p-3 bg-gray-100 rounded text-xs overflow-auto max-h-32\">\r\n                  {errorMessage}\r\n                </pre>\r\n              </details>\r\n            )}\r\n\r\n            {onRetry && (\r\n              <Button\r\n                onClick={onRetry}\r\n                variant=\"default\"\r\n                size=\"sm\"\r\n                className=\"w-full sm:w-auto\"\r\n                aria-label=\"Retry the failed operation\"\r\n              >\r\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                Try Again\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport const InlineErrorState: React.FC<ErrorStateProps> = ({\r\n  error,\r\n  onRetry,\r\n  context\r\n}) => {\r\n  const config = getErrorConfig(error);\r\n  const errorMessage = typeof error === 'string' ? error : error.message;\r\n\r\n  return (\r\n    <div\r\n      className=\"flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-lg\"\r\n      role=\"alert\"\r\n      aria-live=\"polite\"\r\n    >\r\n      <div className={`flex-shrink-0 ${config.color}`} aria-hidden=\"true\">\r\n        <AlertTriangle className=\"h-5 w-5\" />\r\n      </div>\r\n\r\n      <div className=\"flex-1 min-w-0\">\r\n        <h3 className=\"text-sm font-medium text-red-900\">\r\n          {config.title}\r\n        </h3>\r\n        <p className=\"text-sm text-red-700 mt-1\">\r\n          {config.description}\r\n        </p>\r\n\r\n        {context && (\r\n          <p className=\"text-xs text-red-600 mt-1\">\r\n            {context}\r\n          </p>\r\n        )}\r\n\r\n        {process.env.NODE_ENV === 'development' && (\r\n          <details className=\"mt-2\">\r\n            <summary className=\"text-xs text-red-600 cursor-pointer hover:text-red-800\">\r\n              Details\r\n            </summary>\r\n            <pre className=\"mt-1 p-2 bg-red-100 rounded text-xs overflow-auto max-h-24\">\r\n              {errorMessage}\r\n            </pre>\r\n          </details>\r\n        )}\r\n      </div>\r\n\r\n      {onRetry && (\r\n        <Button\r\n          onClick={onRetry}\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          className=\"flex-shrink-0\"\r\n          aria-label=\"Retry\"\r\n        >\r\n          <RefreshCw className=\"h-4 w-4\" />\r\n        </Button>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport const MinimalErrorState: React.FC<ErrorStateProps> = ({\r\n  error,\r\n  onRetry\r\n}) => {\r\n  const errorMessage = typeof error === 'string' ? error : error.message;\r\n\r\n  return (\r\n    <div\r\n      className=\"flex items-center justify-between gap-2 p-3 bg-red-50 border border-red-200 rounded\"\r\n      role=\"alert\"\r\n      aria-live=\"polite\"\r\n    >\r\n      <div className=\"flex items-center gap-2 min-w-0\">\r\n        <AlertTriangle className=\"h-4 w-4 text-red-600 flex-shrink-0\" aria-hidden=\"true\" />\r\n        <p className=\"text-sm text-red-700 truncate\">\r\n          {errorMessage}\r\n        </p>\r\n      </div>\r\n\r\n      {onRetry && (\r\n        <Button\r\n          onClick={onRetry}\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          className=\"flex-shrink-0 h-8\"\r\n          aria-label=\"Retry\"\r\n        >\r\n          <RefreshCw className=\"h-3 w-3\" />\r\n        </Button>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ErrorState;\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\indicators\\DataFreshnessIndicators.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"react/no-unknown-property","severity":2,"message":"Unknown property 'jsx' found","line":224,"column":14,"nodeType":"JSXAttribute","messageId":"unknownProp","endLine":224,"endColumn":17},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":585,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":585,"endColumn":44,"suggestions":[{"messageId":"addBrackets","fix":{"range":[19507,19652],"text":"{ const weekStart = new Date(date);\r\n          weekStart.setDate(date.getDate() - date.getDay());\r\n          return weekStart.toLocaleDateString(); }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n'use client';\r\n\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport {\r\n  Clock,\r\n  RefreshCw,\r\n  Wifi,\r\n  WifiOff,\r\n  AlertCircle,\r\n  CheckCircle,\r\n  Zap,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  Activity,\r\n  Radio,\r\n  Gauge,\r\n  Timer,\r\n  Calendar,\r\n  Database,\r\n  Eye,\r\n  Sparkles\r\n} from 'lucide-react';\r\nimport { designTokens } from '../design-system';\r\n\r\n// Data Freshness Types\r\nexport type FreshnessLevel = 'realtime' | 'fresh' | 'stale' | 'outdated' | 'unknown';\r\nexport type DataChangeType = 'created' | 'updated' | 'deleted' | 'price_changed' | 'stock_changed' | 'status_changed';\r\n\r\nexport interface DataFreshnessInfo {\r\n  lastUpdated: Date;\r\n  syncStatus: 'synced' | 'syncing' | 'error' | 'offline';\r\n  freshnessLevel: FreshnessLevel;\r\n  changesSinceLastView?: number;\r\n  recentChanges?: DataChange[];\r\n  nextSyncTime?: Date;\r\n  dataSource?: string;\r\n  confidence?: number; // 0-1 score for data reliability\r\n}\r\n\r\nexport interface DataChange {\r\n  id: string;\r\n  type: DataChangeType;\r\n  field?: string;\r\n  oldValue?: any;\r\n  newValue?: any;\r\n  timestamp: Date;\r\n  userId?: string;\r\n  source?: string;\r\n  severity?: 'low' | 'medium' | 'high' | 'critical';\r\n}\r\n\r\nexport interface FreshnessConfig {\r\n  realtimeThreshold: number; // milliseconds\r\n  freshThreshold: number;\r\n  staleThreshold: number;\r\n  showRelativeTime: boolean;\r\n  showConfidence: boolean;\r\n  showChangeCount: boolean;\r\n  showSyncStatus: boolean;\r\n  enableNotifications: boolean;\r\n  refreshInterval?: number;\r\n}\r\n\r\n// Freshness Calculation Engine\r\nclass FreshnessCalculator {\r\n  static calculateFreshnessLevel(lastUpdated: Date, config: FreshnessConfig): FreshnessLevel {\r\n    const now = new Date();\r\n    const timeDiff = now.getTime() - lastUpdated.getTime();\r\n\r\n    if (timeDiff <= config.realtimeThreshold) return 'realtime';\r\n    if (timeDiff <= config.freshThreshold) return 'fresh';\r\n    if (timeDiff <= config.staleThreshold) return 'stale';\r\n    return 'outdated';\r\n  }\r\n\r\n  static getRelativeTimeString(date: Date): string {\r\n    const now = new Date();\r\n    const diffMs = now.getTime() - date.getTime();\r\n    const diffMinutes = Math.floor(diffMs / (1000 * 60));\r\n    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\r\n    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\r\n\r\n    if (diffMs < 1000) return 'just now';\r\n    if (diffMs < 60000) return `${Math.floor(diffMs / 1000)}s ago`;\r\n    if (diffMinutes < 60) return `${diffMinutes}m ago`;\r\n    if (diffHours < 24) return `${diffHours}h ago`;\r\n    if (diffDays < 7) return `${diffDays}d ago`;\r\n\r\n    return date.toLocaleDateString();\r\n  }\r\n\r\n  static getFreshnessColor(level: FreshnessLevel): string {\r\n    switch (level) {\r\n      case 'realtime': return designTokens.colors.success.DEFAULT;\r\n      case 'fresh': return designTokens.colors.primary.DEFAULT;\r\n      case 'stale': return designTokens.colors.warning.DEFAULT;\r\n      case 'outdated': return designTokens.colors.destructive.DEFAULT;\r\n      default: return designTokens.colors.muted.foreground;\r\n    }\r\n  }\r\n\r\n  static getSyncStatusIcon(status: DataFreshnessInfo['syncStatus']) {\r\n    switch (status) {\r\n      case 'synced': return CheckCircle;\r\n      case 'syncing': return RefreshCw;\r\n      case 'error': return AlertCircle;\r\n      case 'offline': return WifiOff;\r\n      default: return Clock;\r\n    }\r\n  }\r\n}\r\n\r\n// Core Freshness Indicator Component\r\nexport interface DataFreshnessIndicatorProps {\r\n  data: DataFreshnessInfo;\r\n  config?: Partial<FreshnessConfig>;\r\n  variant?: 'minimal' | 'standard' | 'detailed' | 'badge';\r\n  size?: 'sm' | 'md' | 'lg';\r\n  showTooltip?: boolean;\r\n  onRefresh?: () => void;\r\n  className?: string;\r\n}\r\n\r\nconst defaultConfig: FreshnessConfig = {\r\n  realtimeThreshold: 5000, // 5 seconds\r\n  freshThreshold: 300000, // 5 minutes\r\n  staleThreshold: 1800000, // 30 minutes\r\n  showRelativeTime: true,\r\n  showConfidence: true,\r\n  showChangeCount: true,\r\n  showSyncStatus: true,\r\n  enableNotifications: false\r\n};\r\n\r\nexport const DataFreshnessIndicator: React.FC<DataFreshnessIndicatorProps> = ({\r\n  data,\r\n  config = {},\r\n  variant = 'standard',\r\n  size = 'md',\r\n  showTooltip = true,\r\n  onRefresh,\r\n  className = ''\r\n}) => {\r\n  const mergedConfig = { ...defaultConfig, ...config };\r\n  const [isHovered, setIsHovered] = useState(false);\r\n  const [currentTime, setCurrentTime] = useState(new Date());\r\n\r\n  // Update current time for relative time display\r\n  useEffect(() => {\r\n    if (!mergedConfig.showRelativeTime) return;\r\n\r\n    const interval = setInterval(() => {\r\n      setCurrentTime(new Date());\r\n    }, mergedConfig.refreshInterval || 30000);\r\n\r\n    return () => clearInterval(interval);\r\n  }, [mergedConfig.showRelativeTime, mergedConfig.refreshInterval]);\r\n\r\n  const freshnessLevel = useMemo(() =>\r\n    FreshnessCalculator.calculateFreshnessLevel(data.lastUpdated, mergedConfig),\r\n    [data.lastUpdated, mergedConfig, currentTime]\r\n  );\r\n\r\n  const relativeTime = useMemo(() =>\r\n    FreshnessCalculator.getRelativeTimeString(data.lastUpdated),\r\n    [data.lastUpdated, currentTime]\r\n  );\r\n\r\n  const freshnessColor = FreshnessCalculator.getFreshnessColor(freshnessLevel);\r\n  const SyncIcon = FreshnessCalculator.getSyncStatusIcon(data.syncStatus);\r\n\r\n  const baseClasses = `\r\n    data-freshness-indicator\r\n    inline-flex items-center gap-1\r\n    ${size === 'sm' ? 'text-xs' : size === 'lg' ? 'text-base' : 'text-sm'}\r\n    ${className}\r\n  `;\r\n\r\n  if (variant === 'minimal') {\r\n    return (\r\n      <div className={baseClasses}>\r\n        <div\r\n          className=\"w-2 h-2 rounded-full\"\r\n          style={{ backgroundColor: freshnessColor }}\r\n        />\r\n        {mergedConfig.showRelativeTime && (\r\n          <span className=\"text-muted-foreground\">{relativeTime}</span>\r\n        )}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (variant === 'badge') {\r\n    return (\r\n      <div\r\n        className={`\r\n          ${baseClasses}\r\n          px-2 py-1 rounded-full border\r\n          ${freshnessLevel === 'realtime' ? 'bg-success/10 border-success text-success' :\r\n            freshnessLevel === 'fresh' ? 'bg-primary/10 border-primary text-primary' :\r\n            freshnessLevel === 'stale' ? 'bg-warning/10 border-warning text-warning' :\r\n            'bg-destructive/10 border-destructive text-destructive'}\r\n        `}\r\n      >\r\n        <motion.div\r\n          animate={data.syncStatus === 'syncing' ? { rotate: 360 } : {}}\r\n          transition={{ duration: 1, repeat: data.syncStatus === 'syncing' ? Infinity : 0, ease: \"linear\" }}\r\n        >\r\n          <SyncIcon className=\"w-3 h-3\" />\r\n        </motion.div>\r\n        <span className=\"capitalize\">{freshnessLevel}</span>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className={`${baseClasses} relative`}\r\n      onMouseEnter={() => setIsHovered(true)}\r\n      onMouseLeave={() => setIsHovered(false)}\r\n    >\r\n      <style jsx>{`\r\n        .freshness-tooltip {\r\n          position: absolute;\r\n          bottom: 100%;\r\n          left: 50%;\r\n          transform: translateX(-50%);\r\n          margin-bottom: 8px;\r\n          padding: 12px;\r\n          background: ${designTokens.colors.popover};\r\n          border: 1px solid ${designTokens.colors.border};\r\n          border-radius: ${designTokens.borderRadius.md};\r\n          box-shadow: ${designTokens.shadows.md};\r\n          z-index: 50;\r\n          min-width: 200px;\r\n          font-size: ${designTokens.typography.sizes.sm};\r\n        }\r\n\r\n        .freshness-pulse {\r\n          animation: pulse-freshness 2s ease-in-out infinite;\r\n        }\r\n\r\n        @keyframes pulse-freshness {\r\n          0%, 100% { opacity: 1; }\r\n          50% { opacity: 0.7; }\r\n        }\r\n\r\n        .freshness-glow {\r\n          box-shadow: 0 0 8px ${freshnessColor}40;\r\n        }\r\n      `}</style>\r\n\r\n      {/* Main Indicator */}\r\n      <div className=\"flex items-center gap-2\">\r\n        {/* Status Icon with Animation */}\r\n        <motion.div\r\n          className={`\r\n            ${freshnessLevel === 'realtime' ? 'freshness-pulse' : ''}\r\n            ${data.syncStatus === 'syncing' ? 'animate-spin' : ''}\r\n          `}\r\n          animate={data.syncStatus === 'syncing' ? { rotate: 360 } : {}}\r\n          transition={{ duration: 1, repeat: data.syncStatus === 'syncing' ? Infinity : 0, ease: \"linear\" }}\r\n        >\r\n          <SyncIcon\r\n            className={`w-4 h-4`}\r\n            style={{ color: freshnessColor }}\r\n          />\r\n        </motion.div>\r\n\r\n        {/* Freshness Level */}\r\n        <span\r\n          className=\"font-medium capitalize\"\r\n          style={{ color: freshnessColor }}\r\n        >\r\n          {freshnessLevel}\r\n        </span>\r\n\r\n        {/* Relative Time */}\r\n        {mergedConfig.showRelativeTime && (\r\n          <span className=\"text-muted-foreground\">\r\n            {relativeTime}\r\n          </span>\r\n        )}\r\n\r\n        {/* Change Count */}\r\n        {mergedConfig.showChangeCount && data.changesSinceLastView && data.changesSinceLastView > 0 && (\r\n          <motion.span\r\n            initial={{ scale: 0 }}\r\n            animate={{ scale: 1 }}\r\n            className=\"\r\n              px-1.5 py-0.5 text-xs rounded-full\r\n              bg-primary text-primary-foreground\r\n              freshness-glow\r\n            \"\r\n          >\r\n            +{data.changesSinceLastView}\r\n          </motion.span>\r\n        )}\r\n\r\n        {/* Refresh Button */}\r\n        {onRefresh && (\r\n          <button\r\n            onClick={onRefresh}\r\n            className=\"\r\n              p-1 rounded hover:bg-muted transition-colors\r\n              text-muted-foreground hover:text-foreground\r\n            \"\r\n            title=\"Refresh data\"\r\n          >\r\n            <RefreshCw className=\"w-3 h-3\" />\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Detailed Tooltip */}\r\n      <AnimatePresence>\r\n        {showTooltip && isHovered && (\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 10, scale: 0.95 }}\r\n            animate={{ opacity: 1, y: 0, scale: 1 }}\r\n            exit={{ opacity: 0, y: 10, scale: 0.95 }}\r\n            transition={{ duration: 0.15 }}\r\n            className=\"freshness-tooltip\"\r\n          >\r\n            <div className=\"space-y-2\">\r\n              {/* Status Row */}\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"font-medium\">Status:</span>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <SyncIcon className=\"w-3 h-3\" style={{ color: freshnessColor }} />\r\n                  <span style={{ color: freshnessColor }} className=\"capitalize\">\r\n                    {data.syncStatus}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Last Updated */}\r\n              <div className=\"flex justify-between items-center\">\r\n                <span className=\"font-medium\">Updated:</span>\r\n                <span className=\"text-muted-foreground\">\r\n                  {data.lastUpdated.toLocaleString()}\r\n                </span>\r\n              </div>\r\n\r\n              {/* Data Source */}\r\n              {data.dataSource && (\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"font-medium\">Source:</span>\r\n                  <span className=\"text-muted-foreground\">{data.dataSource}</span>\r\n                </div>\r\n              )}\r\n\r\n              {/* Confidence Score */}\r\n              {mergedConfig.showConfidence && data.confidence !== undefined && (\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"font-medium\">Confidence:</span>\r\n                  <div className=\"flex items-center gap-1\">\r\n                    <div className=\"w-12 h-1 bg-muted rounded-full overflow-hidden\">\r\n                      <div\r\n                        className=\"h-full bg-primary transition-all duration-300\"\r\n                        style={{ width: `${data.confidence * 100}%` }}\r\n                      />\r\n                    </div>\r\n                    <span className=\"text-xs text-muted-foreground\">\r\n                      {Math.round(data.confidence * 100)}%\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* Next Sync */}\r\n              {data.nextSyncTime && (\r\n                <div className=\"flex justify-between items-center\">\r\n                  <span className=\"font-medium\">Next sync:</span>\r\n                  <span className=\"text-muted-foreground\">\r\n                    {FreshnessCalculator.getRelativeTimeString(data.nextSyncTime)}\r\n                  </span>\r\n                </div>\r\n              )}\r\n\r\n              {/* Recent Changes */}\r\n              {data.recentChanges && data.recentChanges.length > 0 && (\r\n                <div className=\"border-t pt-2\">\r\n                  <div className=\"font-medium mb-1\">Recent changes:</div>\r\n                  <div className=\"space-y-1 max-h-20 overflow-y-auto\">\r\n                    {data.recentChanges.slice(0, 3).map(change => (\r\n                      <div key={change.id} className=\"text-xs text-muted-foreground flex items-center gap-1\">\r\n                        <ChangeTypeIcon type={change.type} />\r\n                        <span>{change.field || change.type}</span>\r\n                        <span>·</span>\r\n                        <span>{FreshnessCalculator.getRelativeTimeString(change.timestamp)}</span>\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Change Type Icon Component\r\nconst ChangeTypeIcon: React.FC<{ type: DataChangeType }> = ({ type }) => {\r\n  switch (type) {\r\n    case 'created': return <Sparkles className=\"w-3 h-3 text-success\" />;\r\n    case 'updated': return <RefreshCw className=\"w-3 h-3 text-primary\" />;\r\n    case 'deleted': return <AlertCircle className=\"w-3 h-3 text-destructive\" />;\r\n    case 'price_changed': return <TrendingUp className=\"w-3 h-3 text-warning\" />;\r\n    case 'stock_changed': return <Activity className=\"w-3 h-3 text-primary\" />;\r\n    case 'status_changed': return <Radio className=\"w-3 h-3 text-muted-foreground\" />;\r\n    default: return <Clock className=\"w-3 h-3 text-muted-foreground\" />;\r\n  }\r\n};\r\n\r\n// Real-time Connection Status Component\r\nexport interface RealTimeStatusProps {\r\n  isConnected: boolean;\r\n  lastHeartbeat?: Date;\r\n  reconnectAttempts?: number;\r\n  onReconnect?: () => void;\r\n  className?: string;\r\n}\r\n\r\nexport const RealTimeStatus: React.FC<RealTimeStatusProps> = ({\r\n  isConnected,\r\n  lastHeartbeat,\r\n  reconnectAttempts = 0,\r\n  onReconnect,\r\n  className = ''\r\n}) => {\r\n  return (\r\n    <div className={`flex items-center gap-2 ${className}`}>\r\n      <div className=\"flex items-center gap-1\">\r\n        <motion.div\r\n          animate={isConnected ? { scale: [1, 1.2, 1] } : {}}\r\n          transition={{ duration: 2, repeat: isConnected ? Infinity : 0 }}\r\n        >\r\n          {isConnected ? (\r\n            <Wifi className=\"w-4 h-4 text-success\" />\r\n          ) : (\r\n            <WifiOff className=\"w-4 h-4 text-destructive\" />\r\n          )}\r\n        </motion.div>\r\n\r\n        <span className={`text-sm ${isConnected ? 'text-success' : 'text-destructive'}`}>\r\n          {isConnected ? 'Live' : 'Offline'}\r\n        </span>\r\n      </div>\r\n\r\n      {!isConnected && reconnectAttempts > 0 && (\r\n        <span className=\"text-xs text-muted-foreground\">\r\n          ({reconnectAttempts} attempts)\r\n        </span>\r\n      )}\r\n\r\n      {lastHeartbeat && (\r\n        <span className=\"text-xs text-muted-foreground\">\r\n          Last: {FreshnessCalculator.getRelativeTimeString(lastHeartbeat)}\r\n        </span>\r\n      )}\r\n\r\n      {!isConnected && onReconnect && (\r\n        <button\r\n          onClick={onReconnect}\r\n          className=\"text-xs px-2 py-1 rounded bg-primary text-primary-foreground hover:bg-primary/90 transition-colors\"\r\n        >\r\n          Reconnect\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\n// Data Quality Score Component\r\nexport interface DataQualityScoreProps {\r\n  score: number; // 0-1\r\n  factors?: {\r\n    completeness: number;\r\n    accuracy: number;\r\n    timeliness: number;\r\n    consistency: number;\r\n  };\r\n  showBreakdown?: boolean;\r\n  className?: string;\r\n}\r\n\r\nexport const DataQualityScore: React.FC<DataQualityScoreProps> = ({\r\n  score,\r\n  factors,\r\n  showBreakdown = false,\r\n  className = ''\r\n}) => {\r\n  const getScoreColor = (score: number) => {\r\n    if (score >= 0.9) return designTokens.colors.success.DEFAULT;\r\n    if (score >= 0.7) return designTokens.colors.primary.DEFAULT;\r\n    if (score >= 0.5) return designTokens.colors.warning.DEFAULT;\r\n    return designTokens.colors.destructive.DEFAULT;\r\n  };\r\n\r\n  const getScoreGrade = (score: number) => {\r\n    if (score >= 0.9) return 'A';\r\n    if (score >= 0.8) return 'B';\r\n    if (score >= 0.7) return 'C';\r\n    if (score >= 0.6) return 'D';\r\n    return 'F';\r\n  };\r\n\r\n  return (\r\n    <div className={`data-quality-score ${className}`}>\r\n      <div className=\"flex items-center gap-2\">\r\n        <div className=\"relative w-8 h-8\">\r\n          <svg viewBox=\"0 0 36 36\" className=\"w-8 h-8 transform -rotate-90\">\r\n            <path\r\n              d=\"M18 2.0845\r\n                a 15.9155 15.9155 0 0 1 0 31.831\r\n                a 15.9155 15.9155 0 0 1 0 -31.831\"\r\n              fill=\"none\"\r\n              stroke={designTokens.colors.muted.DEFAULT}\r\n              strokeWidth=\"2\"\r\n            />\r\n            <path\r\n              d=\"M18 2.0845\r\n                a 15.9155 15.9155 0 0 1 0 31.831\r\n                a 15.9155 15.9155 0 0 1 0 -31.831\"\r\n              fill=\"none\"\r\n              stroke={getScoreColor(score)}\r\n              strokeWidth=\"2\"\r\n              strokeDasharray={`${score * 100}, 100`}\r\n              strokeLinecap=\"round\"\r\n            />\r\n          </svg>\r\n          <div className=\"absolute inset-0 flex items-center justify-center\">\r\n            <span className=\"text-xs font-bold\" style={{ color: getScoreColor(score) }}>\r\n              {getScoreGrade(score)}\r\n            </span>\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <div className=\"text-sm font-medium\">\r\n            Data Quality: {Math.round(score * 100)}%\r\n          </div>\r\n          {showBreakdown && factors && (\r\n            <div className=\"text-xs text-muted-foreground space-y-1\">\r\n              <div>Completeness: {Math.round(factors.completeness * 100)}%</div>\r\n              <div>Accuracy: {Math.round(factors.accuracy * 100)}%</div>\r\n              <div>Timeliness: {Math.round(factors.timeliness * 100)}%</div>\r\n              <div>Consistency: {Math.round(factors.consistency * 100)}%</div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Change Visualization Component\r\nexport interface DataChangeVisualizationProps {\r\n  changes: DataChange[];\r\n  timeWindow?: 'hour' | 'day' | 'week' | 'month';\r\n  className?: string;\r\n}\r\n\r\nexport const DataChangeVisualization: React.FC<DataChangeVisualizationProps> = ({\r\n  changes,\r\n  timeWindow = 'day',\r\n  className = ''\r\n}) => {\r\n  const groupedChanges = useMemo(() => {\r\n    const now = new Date();\r\n    const groups: { [key: string]: DataChange[] } = {};\r\n\r\n    const getTimeKey = (date: Date) => {\r\n      switch (timeWindow) {\r\n        case 'hour':\r\n          return `${date.getHours()}:00`;\r\n        case 'day':\r\n          return date.toLocaleDateString();\r\n        case 'week':\r\n          const weekStart = new Date(date);\r\n          weekStart.setDate(date.getDate() - date.getDay());\r\n          return weekStart.toLocaleDateString();\r\n        case 'month':\r\n          return `${date.getFullYear()}-${date.getMonth() + 1}`;\r\n        default:\r\n          return date.toLocaleDateString();\r\n      }\r\n    };\r\n\r\n    changes.forEach(change => {\r\n      const key = getTimeKey(change.timestamp);\r\n      if (!groups[key]) groups[key] = [];\r\n      groups[key].push(change);\r\n    });\r\n\r\n    return groups;\r\n  }, [changes, timeWindow]);\r\n\r\n  const maxCount = Math.max(...Object.values(groupedChanges).map(group => group.length), 1);\r\n\r\n  return (\r\n    <div className={`data-change-visualization ${className}`}>\r\n      <div className=\"flex items-end gap-1 h-16\">\r\n        {Object.entries(groupedChanges).map(([timeKey, timeChanges]) => (\r\n          <div\r\n            key={timeKey}\r\n            className=\"flex flex-col items-center gap-1 flex-1\"\r\n            title={`${timeChanges.length} changes at ${timeKey}`}\r\n          >\r\n            <motion.div\r\n              initial={{ height: 0 }}\r\n              animate={{ height: `${(timeChanges.length / maxCount) * 100}%` }}\r\n              transition={{ duration: 0.3, delay: Math.random() * 0.1 }}\r\n              className=\"bg-primary rounded-t w-full min-h-[2px]\"\r\n            />\r\n            <span className=\"text-xs text-muted-foreground truncate w-full text-center\">\r\n              {timeKey}\r\n            </span>\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"mt-2 text-xs text-muted-foreground text-center\">\r\n        {changes.length} changes in the last {timeWindow}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Main Export: Comprehensive Data Freshness Dashboard\r\nexport interface DataFreshnessDashboardProps {\r\n  items: Array<{\r\n    id: string;\r\n    name: string;\r\n    freshnessInfo: DataFreshnessInfo;\r\n  }>;\r\n  config?: Partial<FreshnessConfig>;\r\n  onRefreshAll?: () => void;\r\n  onRefreshItem?: (id: string) => void;\r\n  className?: string;\r\n}\r\n\r\nexport const DataFreshnessDashboard: React.FC<DataFreshnessDashboardProps> = ({\r\n  items,\r\n  config = {},\r\n  onRefreshAll,\r\n  onRefreshItem,\r\n  className = ''\r\n}) => {\r\n  const mergedConfig = { ...defaultConfig, ...config };\r\n\r\n  const freshnessStats = useMemo(() => {\r\n    const stats = { realtime: 0, fresh: 0, stale: 0, outdated: 0 };\r\n    items.forEach(item => {\r\n      const level = FreshnessCalculator.calculateFreshnessLevel(item.freshnessInfo.lastUpdated, mergedConfig);\r\n      stats[level]++;\r\n    });\r\n    return stats;\r\n  }, [items, mergedConfig]);\r\n\r\n  const overallScore = useMemo(() => {\r\n    const totalItems = items.length;\r\n    if (totalItems === 0) return 1;\r\n\r\n    const score = (\r\n      freshnessStats.realtime * 1.0 +\r\n      freshnessStats.fresh * 0.8 +\r\n      freshnessStats.stale * 0.5 +\r\n      freshnessStats.outdated * 0.2\r\n    ) / totalItems;\r\n\r\n    return score;\r\n  }, [freshnessStats, items.length]);\r\n\r\n  return (\r\n    <div className={`data-freshness-dashboard space-y-4 ${className}`}>\r\n      {/* Dashboard Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <DataQualityScore score={overallScore} />\r\n\r\n          <div className=\"text-sm space-y-1\">\r\n            <div className=\"font-medium\">Data Freshness Overview</div>\r\n            <div className=\"flex items-center gap-4 text-muted-foreground\">\r\n              <span className=\"flex items-center gap-1\">\r\n                <div className=\"w-2 h-2 rounded-full bg-success\" />\r\n                {freshnessStats.realtime} Real-time\r\n              </span>\r\n              <span className=\"flex items-center gap-1\">\r\n                <div className=\"w-2 h-2 rounded-full bg-primary\" />\r\n                {freshnessStats.fresh} Fresh\r\n              </span>\r\n              <span className=\"flex items-center gap-1\">\r\n                <div className=\"w-2 h-2 rounded-full bg-warning\" />\r\n                {freshnessStats.stale} Stale\r\n              </span>\r\n              <span className=\"flex items-center gap-1\">\r\n                <div className=\"w-2 h-2 rounded-full bg-destructive\" />\r\n                {freshnessStats.outdated} Outdated\r\n              </span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {onRefreshAll && (\r\n          <button\r\n            onClick={onRefreshAll}\r\n            className=\"flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors\"\r\n          >\r\n            <RefreshCw className=\"w-4 h-4\" />\r\n            Refresh All\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Individual Items */}\r\n      <div className=\"space-y-2\">\r\n        {items.map(item => (\r\n          <div\r\n            key={item.id}\r\n            className=\"flex items-center justify-between p-3 rounded-md border bg-card\"\r\n          >\r\n            <div className=\"flex items-center gap-3\">\r\n              <span className=\"font-medium\">{item.name}</span>\r\n              <DataFreshnessIndicator\r\n                data={item.freshnessInfo}\r\n                config={mergedConfig}\r\n                variant=\"standard\"\r\n                onRefresh={onRefreshItem ? () => onRefreshItem(item.id) : undefined}\r\n              />\r\n            </div>\r\n\r\n            {item.freshnessInfo.recentChanges && item.freshnessInfo.recentChanges.length > 0 && (\r\n              <DataChangeVisualization\r\n                changes={item.freshnessInfo.recentChanges}\r\n                className=\"w-32\"\r\n              />\r\n            )}\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n};","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\loading\\LoadingStates.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-redeclare","severity":2,"message":"'LoadingState' is already defined.","line":224,"column":14,"nodeType":"Identifier","messageId":"redeclared","endLine":224,"endColumn":50}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n\"use client\"\r\n\r\nimport React from 'react'\r\nimport { motion, AnimatePresence } from 'framer-motion'\r\nimport { Card, CardContent, CardHeader } from '@/components/ui/card'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Skeleton } from '@/components/ui/skeleton'\r\nimport {\r\n  Loader2,\r\n  RefreshCw,\r\n  Clock,\r\n  Zap,\r\n  Activity,\r\n  TrendingUp,\r\n  CheckCircle,\r\n  AlertCircle,\r\n  Database,\r\n  Server,\r\n  Gauge,\r\n  BarChart3,\r\n  PieChart,\r\n  LineChart,\r\n  Package,\r\n  Building2,\r\n  Users,\r\n  DollarSign,\r\n  ShoppingCart,\r\n  FileSpreadsheet,\r\n  Upload,\r\n  Download,\r\n  Search,\r\n  Filter,\r\n  Brain,\r\n  Sparkles,\r\n  Target,\r\n  Eye,\r\n  Settings,\r\n  Globe\r\n} from 'lucide-react'\r\nimport { cn } from '@/lib/utils'\r\n\r\n// Loading Animation Variants\r\nconst loadingVariants = {\r\n  spin: {\r\n    rotate: 360,\r\n    transition: {\r\n      duration: 1,\r\n      repeat: Infinity,\r\n      ease: \"linear\"\r\n    }\r\n  },\r\n  pulse: {\r\n    scale: [1, 1.1, 1],\r\n    opacity: [1, 0.7, 1],\r\n    transition: {\r\n      duration: 1.5,\r\n      repeat: Infinity,\r\n      ease: \"easeInOut\"\r\n    }\r\n  },\r\n  bounce: {\r\n    y: [0, -10, 0],\r\n    transition: {\r\n      duration: 0.8,\r\n      repeat: Infinity,\r\n      ease: \"easeInOut\"\r\n    }\r\n  },\r\n  wave: {\r\n    scale: [1, 1.05, 1],\r\n    rotate: [0, 2, -2, 0],\r\n    transition: {\r\n      duration: 2,\r\n      repeat: Infinity,\r\n      ease: \"easeInOut\"\r\n    }\r\n  }\r\n}\r\n\r\n// Enhanced Loading States\r\nexport interface LoadingState {\r\n  type: 'loading' | 'processing' | 'uploading' | 'downloading' | 'searching' | 'analyzing' | 'saving' | 'syncing'\r\n  message?: string\r\n  progress?: number\r\n  subMessage?: string\r\n  duration?: number\r\n  icon?: React.ComponentType<any>\r\n  color?: 'blue' | 'green' | 'purple' | 'orange' | 'red' | 'indigo'\r\n  variant?: 'minimal' | 'detailed' | 'progress' | 'skeleton'\r\n  showProgressBar?: boolean\r\n  showTimer?: boolean\r\n  animated?: boolean\r\n}\r\n\r\n// Skeleton Loading Components\r\nexport const TableSkeleton: React.FC<{ rows?: number; columns?: number }> = ({ rows = 5, columns = 6 }) => (\r\n  <div className=\"space-y-3\">\r\n    {/* Header */}\r\n    <div className=\"grid gap-3\" style={{ gridTemplateColumns: `repeat(${columns}, 1fr)` }}>\r\n      {Array.from({ length: columns }).map((_, i) => (\r\n        <Skeleton key={`header-${i}`} className=\"h-10 bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 animate-pulse\" />\r\n      ))}\r\n    </div>\r\n    {/* Rows */}\r\n    {Array.from({ length: rows }).map((_, rowIndex) => (\r\n      <div key={`row-${rowIndex}`} className=\"grid gap-3\" style={{ gridTemplateColumns: `repeat(${columns}, 1fr)` }}>\r\n        {Array.from({ length: columns }).map((_, colIndex) => (\r\n          <motion.div\r\n            key={`cell-${rowIndex}-${colIndex}`}\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 1 }}\r\n            transition={{ delay: (rowIndex * columns + colIndex) * 0.05 }}\r\n          >\r\n            <Skeleton className=\"h-8\" />\r\n          </motion.div>\r\n        ))}\r\n      </div>\r\n    ))}\r\n  </div>\r\n)\r\n\r\nexport const CardSkeleton: React.FC<{ count?: number }> = ({ count = 3 }) => (\r\n  <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n    {Array.from({ length: count }).map((_, i) => (\r\n      <motion.div\r\n        key={i}\r\n        initial={{ opacity: 0, y: 20 }}\r\n        animate={{ opacity: 1, y: 0 }}\r\n        transition={{ delay: i * 0.1 }}\r\n      >\r\n        <Card className=\"overflow-hidden\">\r\n          <CardHeader className=\"pb-2\">\r\n            <div className=\"flex items-center space-x-4\">\r\n              <Skeleton className=\"h-12 w-12 rounded-full\" />\r\n              <div className=\"space-y-2 flex-1\">\r\n                <Skeleton className=\"h-4 w-3/4\" />\r\n                <Skeleton className=\"h-3 w-1/2\" />\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-3\">\r\n            <Skeleton className=\"h-32 w-full rounded-lg\" />\r\n            <div className=\"space-y-2\">\r\n              <Skeleton className=\"h-3 w-full\" />\r\n              <Skeleton className=\"h-3 w-4/5\" />\r\n              <Skeleton className=\"h-3 w-3/5\" />\r\n            </div>\r\n            <div className=\"flex space-x-2 pt-2\">\r\n              <Skeleton className=\"h-8 w-20 rounded-full\" />\r\n              <Skeleton className=\"h-8 w-16 rounded-full\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </motion.div>\r\n    ))}\r\n  </div>\r\n)\r\n\r\nexport const ChartSkeleton: React.FC<{ type?: 'bar' | 'line' | 'pie' }> = ({ type = 'bar' }) => (\r\n  <Card className=\"p-6\">\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <Skeleton className=\"h-6 w-32\" />\r\n        <Skeleton className=\"h-4 w-20\" />\r\n      </div>\r\n\r\n      <div className=\"relative h-64\">\r\n        {type === 'bar' && (\r\n          <div className=\"flex items-end justify-between h-full space-x-2\">\r\n            {Array.from({ length: 8 }).map((_, i) => (\r\n              <motion.div\r\n                key={i}\r\n                className=\"bg-gradient-to-t from-blue-200 to-blue-300 rounded-t-lg flex-1\"\r\n                initial={{ height: 0 }}\r\n                animate={{ height: `${Math.random() * 80 + 20}%` }}\r\n                transition={{ delay: i * 0.1, duration: 0.8 }}\r\n              />\r\n            ))}\r\n          </div>\r\n        )}\r\n\r\n        {type === 'line' && (\r\n          <div className=\"relative h-full\">\r\n            {/* Grid lines */}\r\n            {Array.from({ length: 5 }).map((_, i) => (\r\n              <div key={i} className=\"absolute w-full border-t border-gray-200\" style={{ top: `${i * 25}%` }} />\r\n            ))}\r\n            {/* Animated line */}\r\n            <motion.div\r\n              className=\"absolute inset-0 bg-gradient-to-r from-blue-400 to-purple-500 opacity-30 rounded-lg\"\r\n              initial={{ clipPath: 'inset(50% 100% 50% 0%)' }}\r\n              animate={{ clipPath: 'inset(20% 0% 30% 0%)' }}\r\n              transition={{ duration: 2, ease: \"easeInOut\" }}\r\n            />\r\n          </div>\r\n        )}\r\n\r\n        {type === 'pie' && (\r\n          <div className=\"flex items-center justify-center h-full\">\r\n            <motion.div\r\n              className=\"w-40 h-40 rounded-full bg-gradient-to-r from-blue-300 via-purple-300 to-pink-300\"\r\n              animate={{ rotate: 360 }}\r\n              transition={{ duration: 3, repeat: Infinity, ease: \"linear\" }}\r\n            />\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"flex items-center justify-center space-x-4\">\r\n        {Array.from({ length: 3 }).map((_, i) => (\r\n          <div key={i} className=\"flex items-center space-x-2\">\r\n            <Skeleton className=\"h-3 w-3 rounded-full\" />\r\n            <Skeleton className=\"h-3 w-16\" />\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  </Card>\r\n)\r\n\r\n// Main Loading Component\r\nexport const LoadingState: React.FC<LoadingState> = ({\r\n  type = 'loading',\r\n  message,\r\n  progress,\r\n  subMessage,\r\n  icon: IconComponent,\r\n  color = 'blue',\r\n  variant = 'detailed',\r\n  showProgressBar = false,\r\n  showTimer = false,\r\n  animated = true\r\n}) => {\r\n  const [timer, setTimer] = React.useState(0)\r\n\r\n  // Timer effect\r\n  React.useEffect(() => {\r\n    if (!showTimer) return\r\n\r\n    const interval = setInterval(() => {\r\n      setTimer(prev => prev + 1)\r\n    }, 1000)\r\n\r\n    return () => clearInterval(interval)\r\n  }, [showTimer])\r\n\r\n  // Icon mapping\r\n  const iconMap = {\r\n    loading: Loader2,\r\n    processing: Gauge,\r\n    uploading: Upload,\r\n    downloading: Download,\r\n    searching: Search,\r\n    analyzing: Brain,\r\n    saving: Database,\r\n    syncing: RefreshCw\r\n  }\r\n\r\n  const Icon = IconComponent || iconMap[type] || Loader2\r\n\r\n  // Color mapping\r\n  const colorClasses = {\r\n    blue: {\r\n      bg: 'from-blue-500 to-blue-600',\r\n      text: 'text-blue-600',\r\n      ring: 'ring-blue-500/20',\r\n      progress: 'bg-blue-500'\r\n    },\r\n    green: {\r\n      bg: 'from-green-500 to-green-600',\r\n      text: 'text-green-600',\r\n      ring: 'ring-green-500/20',\r\n      progress: 'bg-green-500'\r\n    },\r\n    purple: {\r\n      bg: 'from-purple-500 to-purple-600',\r\n      text: 'text-purple-600',\r\n      ring: 'ring-purple-500/20',\r\n      progress: 'bg-purple-500'\r\n    },\r\n    orange: {\r\n      bg: 'from-orange-500 to-orange-600',\r\n      text: 'text-orange-600',\r\n      ring: 'ring-orange-500/20',\r\n      progress: 'bg-orange-500'\r\n    },\r\n    red: {\r\n      bg: 'from-red-500 to-red-600',\r\n      text: 'text-red-600',\r\n      ring: 'ring-red-500/20',\r\n      progress: 'bg-red-500'\r\n    },\r\n    indigo: {\r\n      bg: 'from-indigo-500 to-indigo-600',\r\n      text: 'text-indigo-600',\r\n      ring: 'ring-indigo-500/20',\r\n      progress: 'bg-indigo-500'\r\n    }\r\n  }\r\n\r\n  const colors = colorClasses[color]\r\n\r\n  // Format timer\r\n  const formatTimer = (seconds: number) => {\r\n    const mins = Math.floor(seconds / 60)\r\n    const secs = seconds % 60\r\n    return `${mins}:${secs.toString().padStart(2, '0')}`\r\n  }\r\n\r\n  // Render different variants\r\n  const renderMinimal = () => (\r\n    <div className=\"flex items-center justify-center gap-3 py-8\">\r\n      <motion.div\r\n        variants={loadingVariants}\r\n        animate={animated ? 'spin' : undefined}\r\n        className={cn(\"p-2 rounded-full bg-gradient-to-r\", colors.bg)}\r\n      >\r\n        <Icon className=\"h-6 w-6 text-white\" />\r\n      </motion.div>\r\n      {message && (\r\n        <span className=\"text-lg font-medium text-gray-700\">{message}</span>\r\n      )}\r\n    </div>\r\n  )\r\n\r\n  const renderDetailed = () => (\r\n    <motion.div\r\n      initial={{ opacity: 0, scale: 0.95 }}\r\n      animate={{ opacity: 1, scale: 1 }}\r\n      transition={{ duration: 0.3 }}\r\n      className=\"flex flex-col items-center justify-center p-12 space-y-6\"\r\n    >\r\n      <motion.div\r\n        variants={loadingVariants}\r\n        animate={animated ? 'pulse' : undefined}\r\n        className={cn(\r\n          \"relative p-6 rounded-3xl bg-gradient-to-r shadow-2xl\",\r\n          colors.bg,\r\n          `ring-8 ${colors.ring}`\r\n        )}\r\n      >\r\n        <motion.div\r\n          variants={loadingVariants}\r\n          animate={animated ? 'spin' : undefined}\r\n        >\r\n          <Icon className=\"h-12 w-12 text-white\" />\r\n        </motion.div>\r\n\r\n        {/* Orbiting dots */}\r\n        {animated && (\r\n          <>\r\n            <motion.div\r\n              className=\"absolute top-2 right-2 w-3 h-3 bg-white rounded-full\"\r\n              animate={{\r\n                scale: [1, 1.2, 1],\r\n                opacity: [1, 0.7, 1]\r\n              }}\r\n              transition={{\r\n                duration: 1,\r\n                repeat: Infinity,\r\n                delay: 0\r\n              }}\r\n            />\r\n            <motion.div\r\n              className=\"absolute bottom-2 left-2 w-2 h-2 bg-white rounded-full\"\r\n              animate={{\r\n                scale: [1, 1.3, 1],\r\n                opacity: [1, 0.6, 1]\r\n              }}\r\n              transition={{\r\n                duration: 1,\r\n                repeat: Infinity,\r\n                delay: 0.3\r\n              }}\r\n            />\r\n            <motion.div\r\n              className=\"absolute top-1/2 right-0 w-2 h-2 bg-white rounded-full transform -translate-y-1/2\"\r\n              animate={{\r\n                scale: [1, 1.1, 1],\r\n                opacity: [1, 0.8, 1]\r\n              }}\r\n              transition={{\r\n                duration: 1,\r\n                repeat: Infinity,\r\n                delay: 0.6\r\n              }}\r\n            />\r\n          </>\r\n        )}\r\n      </motion.div>\r\n\r\n      <div className=\"text-center space-y-2 max-w-md\">\r\n        <h3 className=\"text-2xl font-bold text-gray-800\">\r\n          {message || `${type.charAt(0).toUpperCase() + type.slice(1)}...`}\r\n        </h3>\r\n\r\n        {subMessage && (\r\n          <p className=\"text-gray-600 text-lg\">{subMessage}</p>\r\n        )}\r\n\r\n        {showTimer && (\r\n          <div className=\"flex items-center justify-center gap-2 text-sm text-gray-500 mt-4\">\r\n            <Clock className=\"h-4 w-4\" />\r\n            <span>Elapsed: {formatTimer(timer)}</span>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Progress indicators */}\r\n      {animated && (\r\n        <div className=\"flex space-x-2\">\r\n          {Array.from({ length: 3 }).map((_, i) => (\r\n            <motion.div\r\n              key={i}\r\n              className=\"w-2 h-2 bg-gray-400 rounded-full\"\r\n              animate={{\r\n                scale: [1, 1.5, 1],\r\n                backgroundColor: [colors.progress, '#94a3b8', colors.progress]\r\n              }}\r\n              transition={{\r\n                duration: 1,\r\n                repeat: Infinity,\r\n                delay: i * 0.2\r\n              }}\r\n            />\r\n          ))}\r\n        </div>\r\n      )}\r\n    </motion.div>\r\n  )\r\n\r\n  const renderProgress = () => (\r\n    <div className=\"space-y-6 p-8\">\r\n      <div className=\"flex items-center gap-4\">\r\n        <motion.div\r\n          variants={loadingVariants}\r\n          animate={animated ? 'spin' : undefined}\r\n          className={cn(\"p-3 rounded-2xl bg-gradient-to-r\", colors.bg)}\r\n        >\r\n          <Icon className=\"h-8 w-8 text-white\" />\r\n        </motion.div>\r\n\r\n        <div className=\"flex-1\">\r\n          <h3 className=\"text-xl font-semibold text-gray-800\">\r\n            {message || `${type.charAt(0).toUpperCase() + type.slice(1)}...`}\r\n          </h3>\r\n          {subMessage && (\r\n            <p className=\"text-gray-600\">{subMessage}</p>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"text-right\">\r\n          {progress !== undefined && (\r\n            <div className=\"text-3xl font-bold text-gray-800\">\r\n              {Math.round(progress)}%\r\n            </div>\r\n          )}\r\n          {showTimer && (\r\n            <div className=\"text-sm text-gray-500\">\r\n              {formatTimer(timer)}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {(showProgressBar || progress !== undefined) && (\r\n        <div className=\"relative\">\r\n          <div className=\"w-full bg-gray-200 rounded-full h-4\">\r\n            <motion.div\r\n              className={cn(\"h-4 rounded-full bg-gradient-to-r\", colors.bg)}\r\n              initial={{ width: 0 }}\r\n              animate={{ width: `${progress || 0}%` }}\r\n              transition={{ duration: 0.5 }}\r\n            />\r\n          </div>\r\n\r\n          {/* Animated shine effect */}\r\n          {animated && (\r\n            <motion.div\r\n              className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent h-4 rounded-full\"\r\n              animate={{ x: ['-100%', '100%'] }}\r\n              transition={{\r\n                duration: 1.5,\r\n                repeat: Infinity,\r\n                ease: \"easeInOut\"\r\n              }}\r\n            />\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n\r\n  const renderSkeleton = () => (\r\n    <div className=\"space-y-4 p-6\">\r\n      <div className=\"flex items-center space-x-4\">\r\n        <Skeleton className=\"h-12 w-12 rounded-full\" />\r\n        <div className=\"space-y-2 flex-1\">\r\n          <Skeleton className=\"h-4 w-3/4\" />\r\n          <Skeleton className=\"h-3 w-1/2\" />\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"space-y-3\">\r\n        <Skeleton className=\"h-32 w-full rounded-lg\" />\r\n        <div className=\"grid grid-cols-3 gap-4\">\r\n          <Skeleton className=\"h-20\" />\r\n          <Skeleton className=\"h-20\" />\r\n          <Skeleton className=\"h-20\" />\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n\r\n  // Render based on variant\r\n  switch (variant) {\r\n    case 'minimal':\r\n      return renderMinimal()\r\n    case 'progress':\r\n      return renderProgress()\r\n    case 'skeleton':\r\n      return renderSkeleton()\r\n    default:\r\n      return renderDetailed()\r\n  }\r\n}\r\n\r\n// Specific Loading Components\r\nexport const DataTableLoader: React.FC<{ rows?: number; columns?: number }> = ({ rows = 10, columns = 6 }) => (\r\n  <Card className=\"w-full\">\r\n    <CardContent className=\"p-6\">\r\n      <div className=\"flex items-center justify-between mb-6\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <Skeleton className=\"h-10 w-64\" /> {/* Search bar */}\r\n          <Skeleton className=\"h-10 w-24\" /> {/* Filter button */}\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-10 w-20\" />\r\n          <Skeleton className=\"h-10 w-20\" />\r\n        </div>\r\n      </div>\r\n      <TableSkeleton rows={rows} columns={columns} />\r\n      <div className=\"flex items-center justify-between mt-6\">\r\n        <Skeleton className=\"h-8 w-48\" />\r\n        <div className=\"flex gap-2\">\r\n          {Array.from({ length: 5 }).map((_, i) => (\r\n            <Skeleton key={i} className=\"h-8 w-8\" />\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </CardContent>\r\n  </Card>\r\n)\r\n\r\nexport const DashboardLoader: React.FC = () => (\r\n  <div className=\"space-y-8\">\r\n    {/* Header */}\r\n    <div className=\"flex items-center justify-between\">\r\n      <div className=\"space-y-2\">\r\n        <Skeleton className=\"h-8 w-64\" />\r\n        <Skeleton className=\"h-4 w-96\" />\r\n      </div>\r\n      <div className=\"flex gap-3\">\r\n        <Skeleton className=\"h-10 w-24\" />\r\n        <Skeleton className=\"h-10 w-32\" />\r\n      </div>\r\n    </div>\r\n\r\n    {/* Stats Cards */}\r\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n      {Array.from({ length: 4 }).map((_, i) => (\r\n        <motion.div\r\n          key={i}\r\n          initial={{ opacity: 0, y: 20 }}\r\n          animate={{ opacity: 1, y: 0 }}\r\n          transition={{ delay: i * 0.1 }}\r\n        >\r\n          <Card className=\"p-6\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"space-y-2\">\r\n                <Skeleton className=\"h-4 w-24\" />\r\n                <Skeleton className=\"h-8 w-16\" />\r\n              </div>\r\n              <Skeleton className=\"h-12 w-12 rounded-full\" />\r\n            </div>\r\n          </Card>\r\n        </motion.div>\r\n      ))}\r\n    </div>\r\n\r\n    {/* Charts */}\r\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\r\n      <ChartSkeleton type=\"bar\" />\r\n      <ChartSkeleton type=\"line\" />\r\n    </div>\r\n\r\n    {/* Data Table */}\r\n    <DataTableLoader rows={8} columns={5} />\r\n  </div>\r\n)\r\n\r\nexport const ProductCatalogLoader: React.FC = () => (\r\n  <div className=\"space-y-6\">\r\n    {/* Search and filters */}\r\n    <div className=\"flex items-center gap-4\">\r\n      <Skeleton className=\"h-12 flex-1 max-w-md\" />\r\n      <Skeleton className=\"h-12 w-24\" />\r\n      <Skeleton className=\"h-12 w-32\" />\r\n    </div>\r\n\r\n    {/* Filter chips */}\r\n    <div className=\"flex gap-2\">\r\n      {Array.from({ length: 3 }).map((_, i) => (\r\n        <Skeleton key={i} className=\"h-8 w-20 rounded-full\" />\r\n      ))}\r\n    </div>\r\n\r\n    {/* Product grid */}\r\n    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\r\n      {Array.from({ length: 12 }).map((_, i) => (\r\n        <motion.div\r\n          key={i}\r\n          initial={{ opacity: 0, scale: 0.9 }}\r\n          animate={{ opacity: 1, scale: 1 }}\r\n          transition={{ delay: i * 0.05 }}\r\n        >\r\n          <Card className=\"overflow-hidden\">\r\n            <div className=\"aspect-square bg-gradient-to-br from-gray-200 to-gray-300 relative\">\r\n              <motion.div\r\n                className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent\"\r\n                animate={{ x: ['-100%', '100%'] }}\r\n                transition={{\r\n                  duration: 1.5,\r\n                  repeat: Infinity,\r\n                  ease: \"easeInOut\",\r\n                  delay: i * 0.1\r\n                }}\r\n              />\r\n            </div>\r\n            <CardContent className=\"p-4 space-y-3\">\r\n              <div className=\"space-y-2\">\r\n                <Skeleton className=\"h-4 w-full\" />\r\n                <Skeleton className=\"h-3 w-3/4\" />\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <Skeleton className=\"h-6 w-20\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n              </div>\r\n              <div className=\"flex gap-2\">\r\n                <Skeleton className=\"h-6 w-12 rounded-full\" />\r\n                <Skeleton className=\"h-6 w-16 rounded-full\" />\r\n              </div>\r\n              <Skeleton className=\"h-9 w-full rounded-lg\" />\r\n            </CardContent>\r\n          </Card>\r\n        </motion.div>\r\n      ))}\r\n    </div>\r\n\r\n    {/* Pagination */}\r\n    <div className=\"flex items-center justify-between\">\r\n      <Skeleton className=\"h-8 w-48\" />\r\n      <div className=\"flex gap-2\">\r\n        {Array.from({ length: 5 }).map((_, i) => (\r\n          <Skeleton key={i} className=\"h-10 w-10\" />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  </div>\r\n)\r\n\r\n// Global Loading Overlay\r\nexport const GlobalLoader: React.FC<{\r\n  isLoading: boolean\r\n  message?: string\r\n  backdrop?: boolean\r\n}> = ({\r\n  isLoading,\r\n  message = \"Loading...\",\r\n  backdrop = true\r\n}) => (\r\n  <AnimatePresence>\r\n    {isLoading && (\r\n      <motion.div\r\n        initial={{ opacity: 0 }}\r\n        animate={{ opacity: 1 }}\r\n        exit={{ opacity: 0 }}\r\n        className={cn(\r\n          \"fixed inset-0 z-50 flex items-center justify-center\",\r\n          backdrop && \"bg-black/20 backdrop-blur-sm\"\r\n        )}\r\n      >\r\n        <motion.div\r\n          initial={{ scale: 0.8, opacity: 0 }}\r\n          animate={{ scale: 1, opacity: 1 }}\r\n          exit={{ scale: 0.8, opacity: 0 }}\r\n          className=\"bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4\"\r\n        >\r\n          <LoadingState\r\n            type=\"loading\"\r\n            message={message}\r\n            variant=\"detailed\"\r\n            animated={true}\r\n            color=\"blue\"\r\n          />\r\n        </motion.div>\r\n      </motion.div>\r\n    )}\r\n  </AnimatePresence>\r\n)\r\n\r\nexport default LoadingState","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\search\\UnifiedSearchSystem.tsx","messages":[{"ruleId":"react/no-unknown-property","severity":2,"message":"Unknown property 'jsx' found","line":360,"column":14,"nodeType":"JSXAttribute","messageId":"unknownProp","endLine":360,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport React, { useState, useCallback, useMemo, useRef, useEffect } from 'react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport { Search, Filter, SortAsc, SortDesc, X, Tag, Calendar, Hash, DollarSign, Package, User, Building2, Eye, EyeOff } from 'lucide-react';\r\nimport { designTokens } from '../design-system';\r\n\r\n// Search Interfaces\r\nexport interface SearchableField {\r\n  key: string;\r\n  label: string;\r\n  type: 'text' | 'number' | 'currency' | 'date' | 'boolean' | 'enum' | 'tags';\r\n  icon?: React.ComponentType<any>;\r\n  searchable?: boolean;\r\n  filterable?: boolean;\r\n  sortable?: boolean;\r\n  options?: { value: string; label: string }[];\r\n  format?: (value: any) => string;\r\n  weight?: number; // For search relevance scoring\r\n}\r\n\r\nexport interface SearchConfig {\r\n  fields: SearchableField[];\r\n  enableFuzzySearch?: boolean;\r\n  enableSemanticSearch?: boolean;\r\n  defaultSort?: string;\r\n  defaultSortDirection?: 'asc' | 'desc';\r\n  maxResults?: number;\r\n  debounceMs?: number;\r\n}\r\n\r\nexport interface SearchFilter {\r\n  field: string;\r\n  operator: 'equals' | 'contains' | 'startsWith' | 'endsWith' | 'gt' | 'lt' | 'gte' | 'lte' | 'between' | 'in' | 'not_in';\r\n  value: any;\r\n  values?: any[]; // For 'between', 'in', 'not_in' operators\r\n  active: boolean;\r\n}\r\n\r\nexport interface SearchState {\r\n  query: string;\r\n  filters: SearchFilter[];\r\n  sortField?: string;\r\n  sortDirection: 'asc' | 'desc';\r\n  activeFields: string[];\r\n  savedSearches: SavedSearch[];\r\n}\r\n\r\nexport interface SavedSearch {\r\n  id: string;\r\n  name: string;\r\n  query: string;\r\n  filters: SearchFilter[];\r\n  sortField?: string;\r\n  sortDirection: 'asc' | 'desc';\r\n  createdAt: Date;\r\n  usageCount: number;\r\n}\r\n\r\nexport interface SearchResult<T = any> {\r\n  item: T;\r\n  score: number;\r\n  matches: {\r\n    field: string;\r\n    value: string;\r\n    positions: number[];\r\n  }[];\r\n}\r\n\r\n// Advanced Search Engine\r\nclass AdvancedSearchEngine<T = any> {\r\n  private config: SearchConfig;\r\n  private indexCache = new Map<string, any>();\r\n\r\n  constructor(config: SearchConfig) {\r\n    this.config = config;\r\n  }\r\n\r\n  search(data: T[], state: SearchState): SearchResult<T>[] {\r\n    let results = data.map(item => ({ item, score: 0, matches: [] as any[] }));\r\n\r\n    // Apply text search\r\n    if (state.query.trim()) {\r\n      results = this.performTextSearch(results, state.query, state.activeFields);\r\n    }\r\n\r\n    // Apply filters\r\n    results = this.applyFilters(results, state.filters);\r\n\r\n    // Sort results\r\n    results = this.sortResults(results, state.sortField, state.sortDirection);\r\n\r\n    // Limit results\r\n    if (this.config.maxResults) {\r\n      results = results.slice(0, this.config.maxResults);\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  private performTextSearch(results: SearchResult<T>[], query: string, activeFields: string[]): SearchResult<T>[] {\r\n    const searchFields = this.config.fields.filter(f =>\r\n      f.searchable !== false && (activeFields.length === 0 || activeFields.includes(f.key))\r\n    );\r\n\r\n    return results.map(result => {\r\n      let totalScore = 0;\r\n      const matches: any[] = [];\r\n\r\n      searchFields.forEach(field => {\r\n        const value = this.getFieldValue(result.item, field.key);\r\n        if (value == null) return;\r\n\r\n        const stringValue = String(value).toLowerCase();\r\n        const queryLower = query.toLowerCase();\r\n\r\n        let fieldScore = 0;\r\n        const positions: number[] = [];\r\n\r\n        // Exact match (highest score)\r\n        if (stringValue === queryLower) {\r\n          fieldScore = 100 * (field.weight || 1);\r\n          positions.push(0);\r\n        }\r\n        // Starts with query\r\n        else if (stringValue.startsWith(queryLower)) {\r\n          fieldScore = 80 * (field.weight || 1);\r\n          positions.push(0);\r\n        }\r\n        // Contains query\r\n        else if (stringValue.includes(queryLower)) {\r\n          fieldScore = 60 * (field.weight || 1);\r\n          const index = stringValue.indexOf(queryLower);\r\n          positions.push(index);\r\n        }\r\n        // Fuzzy search if enabled\r\n        else if (this.config.enableFuzzySearch) {\r\n          const fuzzyScore = this.calculateFuzzyScore(queryLower, stringValue);\r\n          if (fuzzyScore > 0.3) {\r\n            fieldScore = fuzzyScore * 40 * (field.weight || 1);\r\n          }\r\n        }\r\n\r\n        if (fieldScore > 0) {\r\n          totalScore += fieldScore;\r\n          matches.push({\r\n            field: field.key,\r\n            value: stringValue,\r\n            positions\r\n          });\r\n        }\r\n      });\r\n\r\n      return {\r\n        ...result,\r\n        score: totalScore,\r\n        matches\r\n      };\r\n    }).filter(result => result.score > 0)\r\n      .sort((a, b) => b.score - a.score);\r\n  }\r\n\r\n  private calculateFuzzyScore(query: string, text: string): number {\r\n    if (query.length === 0) return 1;\r\n    if (text.length === 0) return 0;\r\n\r\n    const matrix: number[][] = [];\r\n    for (let i = 0; i <= text.length; i++) {\r\n      matrix[i] = [i];\r\n    }\r\n    for (let j = 0; j <= query.length; j++) {\r\n      matrix[0][j] = j;\r\n    }\r\n\r\n    for (let i = 1; i <= text.length; i++) {\r\n      for (let j = 1; j <= query.length; j++) {\r\n        if (text[i - 1] === query[j - 1]) {\r\n          matrix[i][j] = matrix[i - 1][j - 1];\r\n        } else {\r\n          matrix[i][j] = Math.min(\r\n            matrix[i - 1][j] + 1,\r\n            matrix[i][j - 1] + 1,\r\n            matrix[i - 1][j - 1] + 1\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    const distance = matrix[text.length][query.length];\r\n    return 1 - distance / Math.max(query.length, text.length);\r\n  }\r\n\r\n  private applyFilters(results: SearchResult<T>[], filters: SearchFilter[]): SearchResult<T>[] {\r\n    const activeFilters = filters.filter(f => f.active);\r\n    if (activeFilters.length === 0) return results;\r\n\r\n    return results.filter(result => {\r\n      return activeFilters.every(filter => {\r\n        const value = this.getFieldValue(result.item, filter.field);\r\n        return this.evaluateFilter(value, filter);\r\n      });\r\n    });\r\n  }\r\n\r\n  private evaluateFilter(value: any, filter: SearchFilter): boolean {\r\n    const { operator, value: filterValue, values } = filter;\r\n\r\n    switch (operator) {\r\n      case 'equals':\r\n        return value === filterValue;\r\n      case 'contains':\r\n        return String(value).toLowerCase().includes(String(filterValue).toLowerCase());\r\n      case 'startsWith':\r\n        return String(value).toLowerCase().startsWith(String(filterValue).toLowerCase());\r\n      case 'endsWith':\r\n        return String(value).toLowerCase().endsWith(String(filterValue).toLowerCase());\r\n      case 'gt':\r\n        return Number(value) > Number(filterValue);\r\n      case 'lt':\r\n        return Number(value) < Number(filterValue);\r\n      case 'gte':\r\n        return Number(value) >= Number(filterValue);\r\n      case 'lte':\r\n        return Number(value) <= Number(filterValue);\r\n      case 'between':\r\n        if (!values || values.length !== 2) return false;\r\n        return Number(value) >= Number(values[0]) && Number(value) <= Number(values[1]);\r\n      case 'in':\r\n        return values?.includes(value) || false;\r\n      case 'not_in':\r\n        return !values?.includes(value) || true;\r\n      default:\r\n        return true;\r\n    }\r\n  }\r\n\r\n  private sortResults(results: SearchResult<T>[], sortField?: string, direction: 'asc' | 'desc' = 'asc'): SearchResult<T>[] {\r\n    if (!sortField) {\r\n      return results.sort((a, b) => b.score - a.score); // Sort by relevance score\r\n    }\r\n\r\n    return results.sort((a, b) => {\r\n      const aValue = this.getFieldValue(a.item, sortField);\r\n      const bValue = this.getFieldValue(b.item, sortField);\r\n\r\n      if (aValue == null && bValue == null) return 0;\r\n      if (aValue == null) return direction === 'asc' ? 1 : -1;\r\n      if (bValue == null) return direction === 'asc' ? -1 : 1;\r\n\r\n      let comparison = 0;\r\n      if (typeof aValue === 'string' && typeof bValue === 'string') {\r\n        comparison = aValue.toLowerCase().localeCompare(bValue.toLowerCase());\r\n      } else if (typeof aValue === 'number' && typeof bValue === 'number') {\r\n        comparison = aValue - bValue;\r\n      } else if (aValue instanceof Date && bValue instanceof Date) {\r\n        comparison = aValue.getTime() - bValue.getTime();\r\n      } else {\r\n        comparison = String(aValue).localeCompare(String(bValue));\r\n      }\r\n\r\n      return direction === 'asc' ? comparison : -comparison;\r\n    });\r\n  }\r\n\r\n  private getFieldValue(item: any, fieldKey: string): any {\r\n    const keys = fieldKey.split('.');\r\n    let value = item;\r\n    for (const key of keys) {\r\n      if (value == null) return null;\r\n      value = value[key];\r\n    }\r\n    return value;\r\n  }\r\n}\r\n\r\n// Search Components\r\nexport interface UnifiedSearchProps {\r\n  config: SearchConfig;\r\n  onSearch: (results: any[], state: SearchState) => void;\r\n  data: any[];\r\n  initialState?: Partial<SearchState>;\r\n  className?: string;\r\n  placeholder?: string;\r\n  showFieldSelector?: boolean;\r\n  showFilters?: boolean;\r\n  showSavedSearches?: boolean;\r\n  enableVoiceSearch?: boolean;\r\n}\r\n\r\nexport const UnifiedSearch: React.FC<UnifiedSearchProps> = ({\r\n  config,\r\n  onSearch,\r\n  data,\r\n  initialState = {},\r\n  className = '',\r\n  placeholder = 'Search...',\r\n  showFieldSelector = true,\r\n  showFilters = true,\r\n  showSavedSearches = true,\r\n  enableVoiceSearch = false\r\n}) => {\r\n  const [searchState, setSearchState] = useState<SearchState>({\r\n    query: '',\r\n    filters: [],\r\n    sortDirection: 'asc',\r\n    activeFields: [],\r\n    savedSearches: [],\r\n    ...initialState\r\n  });\r\n\r\n  const [isExpanded, setIsExpanded] = useState(false);\r\n  const [showAdvanced, setShowAdvanced] = useState(false);\r\n  const searchEngine = useMemo(() => new AdvancedSearchEngine(config), [config]);\r\n  const debounceRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n\r\n  const debouncedSearch = useCallback((state: SearchState) => {\r\n    if (debounceRef.current) {\r\n      clearTimeout(debounceRef.current);\r\n    }\r\n\r\n    debounceRef.current = setTimeout(() => {\r\n      const results = searchEngine.search(data, state);\r\n      onSearch(results.map(r => r.item), state);\r\n    }, config.debounceMs || 300);\r\n  }, [searchEngine, data, onSearch, config.debounceMs]);\r\n\r\n  useEffect(() => {\r\n    debouncedSearch(searchState);\r\n  }, [searchState, debouncedSearch]);\r\n\r\n  const updateSearchState = useCallback((updates: Partial<SearchState>) => {\r\n    setSearchState(prev => ({ ...prev, ...updates }));\r\n  }, []);\r\n\r\n  const addFilter = useCallback((filter: Omit<SearchFilter, 'active'>) => {\r\n    setSearchState(prev => ({\r\n      ...prev,\r\n      filters: [...prev.filters, { ...filter, active: true }]\r\n    }));\r\n  }, []);\r\n\r\n  const removeFilter = useCallback((index: number) => {\r\n    setSearchState(prev => ({\r\n      ...prev,\r\n      filters: prev.filters.filter((_, i) => i !== index)\r\n    }));\r\n  }, []);\r\n\r\n  const toggleFilter = useCallback((index: number) => {\r\n    setSearchState(prev => ({\r\n      ...prev,\r\n      filters: prev.filters.map((filter, i) =>\r\n        i === index ? { ...filter, active: !filter.active } : filter\r\n      )\r\n    }));\r\n  }, []);\r\n\r\n  return (\r\n    <div className={`unified-search ${className}`}>\r\n      <style jsx>{`\r\n        .unified-search {\r\n          background: ${designTokens.colors.background};\r\n          border-radius: ${designTokens.borderRadius.lg};\r\n          box-shadow: ${designTokens.shadows.sm};\r\n          border: 1px solid ${designTokens.colors.border};\r\n        }\r\n\r\n        .search-input-container {\r\n          position: relative;\r\n          display: flex;\r\n          align-items: center;\r\n          padding: ${designTokens.spacing.md};\r\n          border-bottom: 1px solid ${designTokens.colors.border};\r\n        }\r\n\r\n        .search-input {\r\n          flex: 1;\r\n          background: transparent;\r\n          border: none;\r\n          outline: none;\r\n          font-size: ${designTokens.typography.sizes.base};\r\n          color: ${designTokens.colors.foreground};\r\n          padding-left: ${designTokens.spacing.lg};\r\n        }\r\n\r\n        .search-input::placeholder {\r\n          color: ${designTokens.colors.muted.foreground};\r\n        }\r\n\r\n        .search-actions {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: ${designTokens.spacing.sm};\r\n        }\r\n\r\n        .search-button {\r\n          background: none;\r\n          border: none;\r\n          color: ${designTokens.colors.muted.foreground};\r\n          cursor: pointer;\r\n          padding: ${designTokens.spacing.xs};\r\n          border-radius: ${designTokens.borderRadius.sm};\r\n          transition: all 0.2s ease;\r\n        }\r\n\r\n        .search-button:hover {\r\n          color: ${designTokens.colors.foreground};\r\n          background: ${designTokens.colors.muted.DEFAULT};\r\n        }\r\n\r\n        .search-button.active {\r\n          color: ${designTokens.colors.primary.DEFAULT};\r\n          background: ${designTokens.colors.primary.DEFAULT}/10;\r\n        }\r\n\r\n        .advanced-panel {\r\n          padding: ${designTokens.spacing.md};\r\n          border-top: 1px solid ${designTokens.colors.border};\r\n        }\r\n\r\n        .field-selector {\r\n          display: flex;\r\n          flex-wrap: wrap;\r\n          gap: ${designTokens.spacing.xs};\r\n          margin-bottom: ${designTokens.spacing.md};\r\n        }\r\n\r\n        .field-chip {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: ${designTokens.spacing.xs};\r\n          padding: ${designTokens.spacing.xs} ${designTokens.spacing.sm};\r\n          background: ${designTokens.colors.muted.DEFAULT};\r\n          border-radius: ${designTokens.borderRadius.full};\r\n          font-size: ${designTokens.typography.sizes.sm};\r\n          cursor: pointer;\r\n          transition: all 0.2s ease;\r\n        }\r\n\r\n        .field-chip.active {\r\n          background: ${designTokens.colors.primary.DEFAULT};\r\n          color: ${designTokens.colors.primary.foreground};\r\n        }\r\n\r\n        .filters-section {\r\n          margin-top: ${designTokens.spacing.md};\r\n        }\r\n\r\n        .filter-item {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: ${designTokens.spacing.sm};\r\n          padding: ${designTokens.spacing.sm};\r\n          background: ${designTokens.colors.muted.DEFAULT};\r\n          border-radius: ${designTokens.borderRadius.md};\r\n          margin-bottom: ${designTokens.spacing.xs};\r\n        }\r\n\r\n        .filter-item.inactive {\r\n          opacity: 0.6;\r\n        }\r\n\r\n        .sort-controls {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: ${designTokens.spacing.sm};\r\n          margin-top: ${designTokens.spacing.md};\r\n        }\r\n\r\n        .sort-select {\r\n          flex: 1;\r\n          padding: ${designTokens.spacing.sm};\r\n          background: ${designTokens.colors.background};\r\n          border: 1px solid ${designTokens.colors.border};\r\n          border-radius: ${designTokens.borderRadius.md};\r\n          color: ${designTokens.colors.foreground};\r\n        }\r\n      `}</style>\r\n\r\n      {/* Main Search Input */}\r\n      <div className=\"search-input-container\">\r\n        <Search className=\"w-5 h-5 text-muted-foreground absolute left-3\" />\r\n        <input\r\n          type=\"text\"\r\n          className=\"search-input\"\r\n          placeholder={placeholder}\r\n          value={searchState.query}\r\n          onChange={(e) => updateSearchState({ query: e.target.value })}\r\n          onFocus={() => setIsExpanded(true)}\r\n        />\r\n\r\n        <div className=\"search-actions\">\r\n          {showFilters && (\r\n            <button\r\n              className={`search-button ${searchState.filters.some(f => f.active) ? 'active' : ''}`}\r\n              onClick={() => setShowAdvanced(!showAdvanced)}\r\n              title=\"Advanced Filters\"\r\n            >\r\n              <Filter className=\"w-4 h-4\" />\r\n              {searchState.filters.filter(f => f.active).length > 0 && (\r\n                <span className=\"ml-1 text-xs\">{searchState.filters.filter(f => f.active).length}</span>\r\n              )}\r\n            </button>\r\n          )}\r\n\r\n          <button\r\n            className=\"search-button\"\r\n            onClick={() => updateSearchState({\r\n              sortDirection: searchState.sortDirection === 'asc' ? 'desc' : 'asc'\r\n            })}\r\n            title={`Sort ${searchState.sortDirection === 'asc' ? 'Descending' : 'Ascending'}`}\r\n          >\r\n            {searchState.sortDirection === 'asc' ? (\r\n              <SortAsc className=\"w-4 h-4\" />\r\n            ) : (\r\n              <SortDesc className=\"w-4 h-4\" />\r\n            )}\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Advanced Panel */}\r\n      <AnimatePresence>\r\n        {showAdvanced && (\r\n          <motion.div\r\n            initial={{ height: 0, opacity: 0 }}\r\n            animate={{ height: 'auto', opacity: 1 }}\r\n            exit={{ height: 0, opacity: 0 }}\r\n            transition={{ duration: 0.2 }}\r\n            className=\"advanced-panel\"\r\n          >\r\n            {/* Field Selector */}\r\n            {showFieldSelector && (\r\n              <div className=\"field-selector\">\r\n                <span className=\"text-sm font-medium text-muted-foreground mb-2\">Search in:</span>\r\n                {config.fields\r\n                  .filter(field => field.searchable !== false)\r\n                  .map(field => {\r\n                    const Icon = field.icon;\r\n                    const isActive = searchState.activeFields.length === 0 || searchState.activeFields.includes(field.key);\r\n\r\n                    return (\r\n                      <button\r\n                        key={field.key}\r\n                        className={`field-chip ${isActive ? 'active' : ''}`}\r\n                        onClick={() => {\r\n                          const newActiveFields = isActive\r\n                            ? searchState.activeFields.filter(f => f !== field.key)\r\n                            : [...searchState.activeFields, field.key];\r\n                          updateSearchState({ activeFields: newActiveFields });\r\n                        }}\r\n                      >\r\n                        {Icon && <Icon className=\"w-3 h-3\" />}\r\n                        {field.label}\r\n                      </button>\r\n                    );\r\n                  })}\r\n              </div>\r\n            )}\r\n\r\n            {/* Active Filters */}\r\n            {searchState.filters.length > 0 && (\r\n              <div className=\"filters-section\">\r\n                <div className=\"flex items-center justify-between mb-2\">\r\n                  <span className=\"text-sm font-medium text-muted-foreground\">Filters:</span>\r\n                  <button\r\n                    className=\"text-xs text-muted-foreground hover:text-foreground\"\r\n                    onClick={() => updateSearchState({ filters: [] })}\r\n                  >\r\n                    Clear All\r\n                  </button>\r\n                </div>\r\n\r\n                {searchState.filters.map((filter, index) => (\r\n                  <div key={index} className={`filter-item ${filter.active ? '' : 'inactive'}`}>\r\n                    <button\r\n                      className=\"text-xs\"\r\n                      onClick={() => toggleFilter(index)}\r\n                    >\r\n                      {filter.active ? <Eye className=\"w-3 h-3\" /> : <EyeOff className=\"w-3 h-3\" />}\r\n                    </button>\r\n\r\n                    <span className=\"text-sm\">\r\n                      {config.fields.find(f => f.key === filter.field)?.label || filter.field} {filter.operator} {String(filter.value)}\r\n                    </span>\r\n\r\n                    <button\r\n                      className=\"ml-auto text-muted-foreground hover:text-foreground\"\r\n                      onClick={() => removeFilter(index)}\r\n                    >\r\n                      <X className=\"w-3 h-3\" />\r\n                    </button>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {/* Sort Controls */}\r\n            <div className=\"sort-controls\">\r\n              <span className=\"text-sm font-medium text-muted-foreground\">Sort by:</span>\r\n              <select\r\n                className=\"sort-select\"\r\n                value={searchState.sortField || ''}\r\n                onChange={(e) => updateSearchState({ sortField: e.target.value || undefined })}\r\n              >\r\n                <option value=\"\">Relevance</option>\r\n                {config.fields\r\n                  .filter(field => field.sortable !== false)\r\n                  .map(field => (\r\n                    <option key={field.key} value={field.key}>\r\n                      {field.label}\r\n                    </option>\r\n                  ))}\r\n              </select>\r\n            </div>\r\n          </motion.div>\r\n        )}\r\n      </AnimatePresence>\r\n    </div>\r\n  );\r\n};\r\n\r\n// Filter Builder Component\r\nexport interface FilterBuilderProps {\r\n  fields: SearchableField[];\r\n  onAddFilter: (filter: Omit<SearchFilter, 'active'>) => void;\r\n  className?: string;\r\n}\r\n\r\nexport const FilterBuilder: React.FC<FilterBuilderProps> = ({\r\n  fields,\r\n  onAddFilter,\r\n  className = ''\r\n}) => {\r\n  const [selectedField, setSelectedField] = useState('');\r\n  const [selectedOperator, setSelectedOperator] = useState<SearchFilter['operator']>('equals');\r\n  const [filterValue, setFilterValue] = useState('');\r\n\r\n  const handleAddFilter = useCallback(() => {\r\n    if (!selectedField || !filterValue) return;\r\n\r\n    onAddFilter({\r\n      field: selectedField,\r\n      operator: selectedOperator,\r\n      value: filterValue\r\n    });\r\n\r\n    setFilterValue('');\r\n  }, [selectedField, selectedOperator, filterValue, onAddFilter]);\r\n\r\n  const getOperatorsForField = (field: SearchableField) => {\r\n    const operators: { value: SearchFilter['operator']; label: string }[] = [\r\n      { value: 'equals', label: 'Equals' },\r\n      { value: 'contains', label: 'Contains' }\r\n    ];\r\n\r\n    if (field.type === 'text') {\r\n      operators.push(\r\n        { value: 'startsWith', label: 'Starts with' },\r\n        { value: 'endsWith', label: 'Ends with' }\r\n      );\r\n    }\r\n\r\n    if (field.type === 'number' || field.type === 'currency') {\r\n      operators.push(\r\n        { value: 'gt', label: 'Greater than' },\r\n        { value: 'lt', label: 'Less than' },\r\n        { value: 'gte', label: 'Greater or equal' },\r\n        { value: 'lte', label: 'Less or equal' },\r\n        { value: 'between', label: 'Between' }\r\n      );\r\n    }\r\n\r\n    if (field.options) {\r\n      operators.push(\r\n        { value: 'in', label: 'In' },\r\n        { value: 'not_in', label: 'Not in' }\r\n      );\r\n    }\r\n\r\n    return operators;\r\n  };\r\n\r\n  const selectedFieldObj = fields.find(f => f.key === selectedField);\r\n  const operators = selectedFieldObj ? getOperatorsForField(selectedFieldObj) : [];\r\n\r\n  return (\r\n    <div className={`filter-builder flex items-center gap-2 ${className}`}>\r\n      <select\r\n        value={selectedField}\r\n        onChange={(e) => setSelectedField(e.target.value)}\r\n        className=\"px-3 py-2 border border-border rounded-sm bg-background text-foreground\"\r\n      >\r\n        <option value=\"\">Select field...</option>\r\n        {fields\r\n          .filter(field => field.filterable !== false)\r\n          .map(field => (\r\n            <option key={field.key} value={field.key}>\r\n              {field.label}\r\n            </option>\r\n          ))}\r\n      </select>\r\n\r\n      {selectedField && (\r\n        <>\r\n          <select\r\n            value={selectedOperator}\r\n            onChange={(e) => setSelectedOperator(e.target.value as SearchFilter['operator'])}\r\n            className=\"px-3 py-2 border border-border rounded-sm bg-background text-foreground\"\r\n          >\r\n            {operators.map(op => (\r\n              <option key={op.value} value={op.value}>\r\n                {op.label}\r\n              </option>\r\n            ))}\r\n          </select>\r\n\r\n          {selectedFieldObj?.options ? (\r\n            <select\r\n              value={filterValue}\r\n              onChange={(e) => setFilterValue(e.target.value)}\r\n              className=\"px-3 py-2 border border-border rounded-sm bg-background text-foreground\"\r\n            >\r\n              <option value=\"\">Select value...</option>\r\n              {selectedFieldObj.options.map(option => (\r\n                <option key={option.value} value={option.value}>\r\n                  {option.label}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          ) : (\r\n            <input\r\n              type={selectedFieldObj?.type === 'number' || selectedFieldObj?.type === 'currency' ? 'number' : 'text'}\r\n              value={filterValue}\r\n              onChange={(e) => setFilterValue(e.target.value)}\r\n              placeholder=\"Enter value...\"\r\n              className=\"px-3 py-2 border border-border rounded-sm bg-background text-foreground\"\r\n            />\r\n          )}\r\n\r\n          <button\r\n            onClick={handleAddFilter}\r\n            className=\"px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors\"\r\n            disabled={!filterValue}\r\n          >\r\n            Add Filter\r\n          </button>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\n// Export additional utilities\r\nexport const createProductSearchConfig = (): SearchConfig => ({\r\n  fields: [\r\n    { key: 'sku', label: 'SKU', type: 'text', icon: Hash, weight: 2 },\r\n    { key: 'name', label: 'Product Name', type: 'text', icon: Package, weight: 3 },\r\n    { key: 'description', label: 'Description', type: 'text', weight: 1 },\r\n    { key: 'category', label: 'Category', type: 'enum', icon: Tag },\r\n    { key: 'supplier.name', label: 'Supplier', type: 'text', icon: Building2, weight: 1.5 },\r\n    { key: 'price', label: 'Price', type: 'currency', icon: DollarSign, sortable: true },\r\n    { key: 'stock', label: 'Stock', type: 'number', sortable: true },\r\n    { key: 'lastUpdated', label: 'Last Updated', type: 'date', icon: Calendar, sortable: true }\r\n  ],\r\n  enableFuzzySearch: true,\r\n  defaultSort: 'name',\r\n  defaultSortDirection: 'asc',\r\n  debounceMs: 250\r\n});\r\n\r\nexport const createSupplierSearchConfig = (): SearchConfig => ({\r\n  fields: [\r\n    { key: 'name', label: 'Supplier Name', type: 'text', icon: Building2, weight: 3 },\r\n    { key: 'code', label: 'Supplier Code', type: 'text', icon: Hash, weight: 2 },\r\n    { key: 'contactPerson', label: 'Contact Person', type: 'text', icon: User },\r\n    { key: 'email', label: 'Email', type: 'text', weight: 1.5 },\r\n    { key: 'phone', label: 'Phone', type: 'text' },\r\n    { key: 'category', label: 'Category', type: 'enum', icon: Tag },\r\n    { key: 'status', label: 'Status', type: 'enum', options: [\r\n      { value: 'active', label: 'Active' },\r\n      { value: 'inactive', label: 'Inactive' },\r\n      { value: 'pending', label: 'Pending' }\r\n    ]},\r\n    { key: 'createdAt', label: 'Created Date', type: 'date', icon: Calendar, sortable: true }\r\n  ],\r\n  enableFuzzySearch: true,\r\n  defaultSort: 'name',\r\n  defaultSortDirection: 'asc',\r\n  debounceMs: 300\r\n});","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\sidebar.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'KeyboardEvent' is not defined.","line":98,"column":35,"nodeType":"Identifier","messageId":"undef","endLine":98,"endColumn":48}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-(--sidebar-width) bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]\"\n            : \"group-data-[collapsible=icon]:w-(--sidebar-width-icon)\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]\"\n            : \"group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"size-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-(--skeleton-width) flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\stepper.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":7,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":7,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":8,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":8,"endColumn":38},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":19,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":19,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":20,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":20,"endColumn":38},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":37,"column":3,"nodeType":"Identifier","messageId":"undef","endLine":37,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'HTMLDivElement' is not defined.","line":38,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":38,"endColumn":38}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst Stepper = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement>\r\n>(({ className, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    className={cn(\"flex items-center\", className)}\r\n    {...props}\r\n  />\r\n))\r\nStepper.displayName = \"Stepper\"\r\n\r\nconst StepperItem = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement> & {\r\n    isCompleted?: boolean\r\n    isActive?: boolean\r\n  }\r\n>(({ className, isCompleted, isActive, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    className={cn(\r\n      \"flex flex-col items-center\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\nStepperItem.displayName = \"StepperItem\"\r\n\r\nconst StepperSeparator = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement>\r\n>(({ className, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    className={cn(\"h-px bg-border flex-1\", className)}\r\n    {...props}\r\n  />\r\n))\r\nStepperSeparator.displayName = \"StepperSeparator\"\r\n\r\nexport { Stepper, StepperItem, StepperSeparator }","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\components\\ui\\theme-toggle.tsx","messages":[{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":20,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":20,"endColumn":36},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":45,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":45,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport * as React from 'react';\nimport { Moon, Sun } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\n\nexport function ThemeToggle() {\n  const [theme, setTheme] = React.useState<'light' | 'dark' | 'system'>('system');\n  const [mounted, setMounted] = React.useState(false);\n\n  // Ensure component is mounted to avoid hydration mismatch\n  React.useEffect(() => {\n    setMounted(true);\n    const savedTheme = localStorage.getItem('theme') as 'light' | 'dark' | 'system' | null;\n    if (savedTheme) {\n      setTheme(savedTheme);\n      applyTheme(savedTheme);\n    } else {\n      applyTheme('system');\n    }\n  }, []);\n\n  const applyTheme = (newTheme: 'light' | 'dark' | 'system') => {\n    const root = window.document.documentElement;\n    root.classList.remove('light', 'dark');\n\n    if (newTheme === 'system') {\n      const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches\n        ? 'dark'\n        : 'light';\n      root.classList.add(systemTheme);\n    } else {\n      root.classList.add(newTheme);\n    }\n  };\n\n  const handleThemeChange = (newTheme: 'light' | 'dark' | 'system') => {\n    setTheme(newTheme);\n    localStorage.setItem('theme', newTheme);\n    applyTheme(newTheme);\n  };\n\n  // Avoid rendering during SSR\n  if (!mounted) {\n    return (\n      <Button variant=\"ghost\" size=\"icon\" className=\"h-9 w-9\">\n        <Sun className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Toggle theme</span>\n      </Button>\n    );\n  }\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"h-9 w-9 transition-all duration-200 hover:bg-accent\"\n        >\n          <Sun className=\"h-4 w-4 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n          <Moon className=\"absolute h-4 w-4 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n          <span className=\"sr-only\">Toggle theme</span>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"theme-transition\">\n        <DropdownMenuItem\n          onClick={() => handleThemeChange('light')}\n          className=\"cursor-pointer\"\n        >\n          <Sun className=\"mr-2 h-4 w-4\" />\n          <span>Light</span>\n          {theme === 'light' && (\n            <span className=\"ml-auto text-xs text-primary\">✓</span>\n          )}\n        </DropdownMenuItem>\n        <DropdownMenuItem\n          onClick={() => handleThemeChange('dark')}\n          className=\"cursor-pointer\"\n        >\n          <Moon className=\"mr-2 h-4 w-4\" />\n          <span>Dark</span>\n          {theme === 'dark' && (\n            <span className=\"ml-auto text-xs text-primary\">✓</span>\n          )}\n        </DropdownMenuItem>\n        <DropdownMenuItem\n          onClick={() => handleThemeChange('system')}\n          className=\"cursor-pointer\"\n        >\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth=\"2\"\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            className=\"mr-2 h-4 w-4\"\n          >\n            <rect width=\"20\" height=\"14\" x=\"2\" y=\"3\" rx=\"2\" />\n            <line x1=\"8\" x2=\"16\" y1=\"21\" y2=\"21\" />\n            <line x1=\"12\" x2=\"12\" y1=\"17\" y2=\"21\" />\n          </svg>\n          <span>System</span>\n          {theme === 'system' && (\n            <span className=\"ml-auto text-xs text-primary\">✓</span>\n          )}\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\hooks\\useAISupplier.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\nimport { useState, useEffect, useCallback, useReducer } from 'react'\r\nimport type {\r\n  AISupplierState,\r\n  AISupplierAction,\r\n  UseAISupplierOptions,\r\n  UseAISupplierReturn,\r\n  AISupplierRecommendation,\r\n  AISupplierInsight\r\n} from '@/types/ai-supplier'\r\n\r\n// Initial state\r\nconst initialAISupplierState: AISupplierState = {\r\n  recommendations: [],\r\n  recommendationsLoading: false,\r\n  recommendationsError: null,\r\n\r\n  insights: [],\r\n  insightsLoading: false,\r\n  insightsError: null,\r\n\r\n  predictions: [],\r\n  predictionsLoading: false,\r\n  predictionsError: null,\r\n\r\n  anomalies: [],\r\n  anomaliesLoading: false,\r\n  anomaliesError: null,\r\n\r\n  marketIntelligence: [],\r\n  marketIntelligenceLoading: false,\r\n  marketIntelligenceError: null,\r\n\r\n  riskProfiles: {},\r\n  riskProfilesLoading: false,\r\n  riskProfilesError: null,\r\n\r\n  chatMessages: [],\r\n  isTyping: false,\r\n  chatContext: {\r\n    preferences: {}\r\n  },\r\n\r\n  aiConfig: {\r\n    enabledFeatures: ['recommendations', 'insights', 'chat', 'anomaly_detection'],\r\n    analysisDepth: 'standard',\r\n    autoRefresh: true,\r\n    alertThresholds: {\r\n      risk_score: 75,\r\n      confidence_threshold: 70,\r\n      anomaly_severity: 3\r\n    },\r\n    modelVersions: {}\r\n  },\r\n\r\n  performanceMetrics: {\r\n    apiLatency: 0,\r\n    modelAccuracy: {},\r\n    userSatisfaction: 0,\r\n    usageStatistics: {}\r\n  }\r\n}\r\n\r\n// Reducer function\r\nfunction aiSupplierReducer(state: AISupplierState, action: AISupplierAction): AISupplierState {\r\n  switch (action.type) {\r\n    case 'FETCH_RECOMMENDATIONS_START':\r\n      return {\r\n        ...state,\r\n        recommendationsLoading: true,\r\n        recommendationsError: null\r\n      }\r\n\r\n    case 'FETCH_RECOMMENDATIONS_SUCCESS':\r\n      return {\r\n        ...state,\r\n        recommendations: action.payload,\r\n        recommendationsLoading: false,\r\n        recommendationsError: null\r\n      }\r\n\r\n    case 'FETCH_RECOMMENDATIONS_ERROR':\r\n      return {\r\n        ...state,\r\n        recommendationsLoading: false,\r\n        recommendationsError: action.payload\r\n      }\r\n\r\n    case 'FETCH_INSIGHTS_START':\r\n      return {\r\n        ...state,\r\n        insightsLoading: true,\r\n        insightsError: null\r\n      }\r\n\r\n    case 'FETCH_INSIGHTS_SUCCESS':\r\n      return {\r\n        ...state,\r\n        insights: action.payload,\r\n        insightsLoading: false,\r\n        insightsError: null\r\n      }\r\n\r\n    case 'FETCH_INSIGHTS_ERROR':\r\n      return {\r\n        ...state,\r\n        insightsLoading: false,\r\n        insightsError: action.payload\r\n      }\r\n\r\n    case 'ADD_CHAT_MESSAGE':\r\n      return {\r\n        ...state,\r\n        chatMessages: [\r\n          ...state.chatMessages,\r\n          {\r\n            id: Date.now().toString(),\r\n            role: action.payload.role,\r\n            content: action.payload.content,\r\n            timestamp: new Date(),\r\n            metadata: action.payload.metadata\r\n          }\r\n        ]\r\n      }\r\n\r\n    case 'SET_TYPING':\r\n      return {\r\n        ...state,\r\n        isTyping: action.payload\r\n      }\r\n\r\n    case 'UPDATE_AI_CONFIG':\r\n      return {\r\n        ...state,\r\n        aiConfig: {\r\n          ...state.aiConfig,\r\n          ...action.payload\r\n        }\r\n      }\r\n\r\n    case 'BOOKMARK_INSIGHT':\r\n      return {\r\n        ...state,\r\n        insights: state.insights.map(insight =>\r\n          insight.id === action.payload.insightId\r\n            ? { ...insight, isBookmarked: action.payload.bookmarked }\r\n            : insight\r\n        )\r\n      }\r\n\r\n    case 'PROVIDE_INSIGHT_FEEDBACK':\r\n      return {\r\n        ...state,\r\n        insights: state.insights.map(insight =>\r\n          insight.id === action.payload.insightId\r\n            ? {\r\n                ...insight,\r\n                userFeedback: {\r\n                  ...insight.userFeedback,\r\n                  [action.payload.feedback === 'helpful' ? 'helpful' : 'notHelpful']:\r\n                    (insight.userFeedback?.[action.payload.feedback === 'helpful' ? 'helpful' : 'notHelpful'] ?? 0) + 1\r\n                }\r\n              }\r\n            : insight\r\n        )\r\n      }\r\n\r\n    case 'CLEAR_RECOMMENDATIONS':\r\n      return {\r\n        ...state,\r\n        recommendations: []\r\n      }\r\n\r\n    case 'CLEAR_INSIGHTS':\r\n      return {\r\n        ...state,\r\n        insights: []\r\n      }\r\n\r\n    case 'CLEAR_CHAT':\r\n      return {\r\n        ...state,\r\n        chatMessages: []\r\n      }\r\n\r\n    default:\r\n      return state\r\n  }\r\n}\r\n\r\nexport function useAISupplier(options: UseAISupplierOptions = {}): UseAISupplierReturn {\r\n  const {\r\n    supplierId,\r\n    autoFetch = true,\r\n    enableRealTimeUpdates = false,\r\n    analysisDepth = 'standard'\r\n  } = options\r\n\r\n  const [state, dispatch] = useReducer(aiSupplierReducer, {\r\n    ...initialAISupplierState,\r\n    aiConfig: {\r\n      ...initialAISupplierState.aiConfig,\r\n      analysisDepth\r\n    },\r\n    chatContext: {\r\n      ...initialAISupplierState.chatContext,\r\n      supplierId\r\n    }\r\n  })\r\n\r\n  // Fetch AI recommendations\r\n  const fetchRecommendations = useCallback(async (\r\n    query?: string,\r\n    filters?: Record<string, any>\r\n  ) => {\r\n    dispatch({ type: 'FETCH_RECOMMENDATIONS_START' })\r\n\r\n    try {\r\n      const response = await fetch('/api/ai/suppliers/discover', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          query: query || '',\r\n          filters: filters || {},\r\n          analysisDepth: state.aiConfig.analysisDepth,\r\n          includeMarketIntelligence: true,\r\n          includePredictiveAnalysis: true,\r\n          supplierId\r\n        })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\r\n      }\r\n\r\n      const { recommendations } = await response.json()\r\n      dispatch({\r\n        type: 'FETCH_RECOMMENDATIONS_SUCCESS',\r\n        payload: recommendations || []\r\n      })\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Failed to fetch recommendations'\r\n      dispatch({\r\n        type: 'FETCH_RECOMMENDATIONS_ERROR',\r\n        payload: errorMessage\r\n      })\r\n      console.error('AI recommendations error:', error)\r\n    }\r\n  }, [state.aiConfig.analysisDepth, supplierId])\r\n\r\n  // Fetch AI insights\r\n  const fetchInsights = useCallback(async (\r\n    targetSupplierId?: string,\r\n    categories?: string[]\r\n  ) => {\r\n    dispatch({ type: 'FETCH_INSIGHTS_START' })\r\n\r\n    try {\r\n      const response = await fetch('/api/ai/suppliers/insights', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          supplierId: targetSupplierId || supplierId,\r\n          categories: categories || ['all'],\r\n          analysisDepth: state.aiConfig.analysisDepth,\r\n          includeMarketContext: true,\r\n          includeRiskAssessment: true\r\n        })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\r\n      }\r\n\r\n      const { insights } = await response.json()\r\n      dispatch({\r\n        type: 'FETCH_INSIGHTS_SUCCESS',\r\n        payload: insights || []\r\n      })\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Failed to fetch insights'\r\n      dispatch({\r\n        type: 'FETCH_INSIGHTS_ERROR',\r\n        payload: errorMessage\r\n      })\r\n      console.error('AI insights error:', error)\r\n    }\r\n  }, [supplierId, state.aiConfig.analysisDepth])\r\n\r\n  // Send chat message\r\n  const sendChatMessage = useCallback(async (message: string) => {\r\n    if (!message.trim()) return\r\n\r\n    // Add user message to chat\r\n    dispatch({\r\n      type: 'ADD_CHAT_MESSAGE',\r\n      payload: { role: 'user', content: message.trim() }\r\n    })\r\n\r\n    dispatch({ type: 'SET_TYPING', payload: true })\r\n\r\n    try {\r\n      const response = await fetch('/api/ai/suppliers/chat', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          message: message.trim(),\r\n          context: {\r\n            supplierId,\r\n            conversationHistory: state.chatMessages.slice(-5),\r\n            preferences: state.chatContext.preferences,\r\n            analysisDepth: state.aiConfig.analysisDepth\r\n          }\r\n        })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\r\n      }\r\n\r\n      const { response: aiResponse, metadata, suggestions } = await response.json()\r\n\r\n      // Add AI response to chat\r\n      dispatch({\r\n        type: 'ADD_CHAT_MESSAGE',\r\n        payload: {\r\n          role: 'assistant',\r\n          content: aiResponse,\r\n          metadata: {\r\n            ...metadata,\r\n            suggestions,\r\n            confidence: metadata?.confidence || 95,\r\n            processingTime: metadata?.processingTime || 0\r\n          }\r\n        }\r\n      })\r\n\r\n      // If the response includes new insights or recommendations, update them\r\n      if (metadata?.newInsights) {\r\n        dispatch({\r\n          type: 'FETCH_INSIGHTS_SUCCESS',\r\n          payload: [...state.insights, ...metadata.newInsights]\r\n        })\r\n      }\r\n\r\n      if (metadata?.newRecommendations) {\r\n        dispatch({\r\n          type: 'FETCH_RECOMMENDATIONS_SUCCESS',\r\n          payload: [...state.recommendations, ...metadata.newRecommendations]\r\n        })\r\n      }\r\n\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Failed to send message'\r\n      dispatch({\r\n        type: 'ADD_CHAT_MESSAGE',\r\n        payload: {\r\n          role: 'assistant',\r\n          content: `I apologize, but I encountered an error: ${errorMessage}. Please try again.`,\r\n          metadata: { type: 'error' }\r\n        }\r\n      })\r\n      console.error('Chat message error:', error)\r\n    } finally {\r\n      dispatch({ type: 'SET_TYPING', payload: false })\r\n    }\r\n  }, [supplierId, state.chatMessages, state.chatContext.preferences, state.aiConfig.analysisDepth, state.insights, state.recommendations])\r\n\r\n  // Bookmark insight\r\n  const bookmarkInsight = useCallback(async (insightId: string) => {\r\n    const insight = state.insights.find(i => i.id === insightId)\r\n    if (!insight) return\r\n\r\n    const newBookmarkState = !insight.isBookmarked\r\n\r\n    // Optimistically update UI\r\n    dispatch({\r\n      type: 'BOOKMARK_INSIGHT',\r\n      payload: { insightId, bookmarked: newBookmarkState }\r\n    })\r\n\r\n    try {\r\n      const response = await fetch('/api/ai/suppliers/insights/bookmark', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          insightId,\r\n          bookmarked: newBookmarkState,\r\n          userId: 'current-user' // Replace with actual user ID\r\n        })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        // Revert on failure\r\n        dispatch({\r\n          type: 'BOOKMARK_INSIGHT',\r\n          payload: { insightId, bookmarked: !newBookmarkState }\r\n        })\r\n        throw new Error('Failed to bookmark insight')\r\n      }\r\n    } catch (error) {\r\n      console.error('Bookmark error:', error)\r\n    }\r\n  }, [state.insights])\r\n\r\n  // Provide insight feedback\r\n  const provideInsightFeedback = useCallback(async (\r\n    insightId: string,\r\n    feedback: 'helpful' | 'notHelpful'\r\n  ) => {\r\n    // Optimistically update UI\r\n    dispatch({\r\n      type: 'PROVIDE_INSIGHT_FEEDBACK',\r\n      payload: { insightId, feedback }\r\n    })\r\n\r\n    try {\r\n      const response = await fetch('/api/ai/suppliers/insights/feedback', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          insightId,\r\n          feedback,\r\n          userId: 'current-user' // Replace with actual user ID\r\n        })\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to provide feedback')\r\n      }\r\n    } catch (error) {\r\n      console.error('Feedback error:', error)\r\n      // Could implement revert logic here if needed\r\n    }\r\n  }, [])\r\n\r\n  // Clear functions\r\n  const clearRecommendations = useCallback(() => {\r\n    dispatch({ type: 'CLEAR_RECOMMENDATIONS' })\r\n  }, [])\r\n\r\n  const clearInsights = useCallback(() => {\r\n    dispatch({ type: 'CLEAR_INSIGHTS' })\r\n  }, [])\r\n\r\n  const clearChat = useCallback(() => {\r\n    dispatch({ type: 'CLEAR_CHAT' })\r\n  }, [])\r\n\r\n  // Refresh all data\r\n  const refreshAll = useCallback(async () => {\r\n    const promises = []\r\n\r\n    if (state.aiConfig.enabledFeatures.includes('recommendations')) {\r\n      promises.push(fetchRecommendations())\r\n    }\r\n\r\n    if (state.aiConfig.enabledFeatures.includes('insights')) {\r\n      promises.push(fetchInsights())\r\n    }\r\n\r\n    await Promise.allSettled(promises)\r\n  }, [\r\n    fetchRecommendations,\r\n    fetchInsights,\r\n    state.aiConfig.enabledFeatures\r\n  ])\r\n\r\n  // Auto-fetch on mount and when supplierId changes\r\n  useEffect(() => {\r\n    if (autoFetch && supplierId) {\r\n      refreshAll()\r\n    }\r\n  }, [autoFetch, supplierId, refreshAll])\r\n\r\n  // Real-time updates via WebSocket or polling\r\n  useEffect(() => {\r\n    if (!enableRealTimeUpdates || !supplierId) return\r\n\r\n    let intervalId: NodeJS.Timeout\r\n\r\n    if (state.aiConfig.autoRefresh) {\r\n      // Poll for updates every 5 minutes\r\n      intervalId = setInterval(() => {\r\n        refreshAll()\r\n      }, 5 * 60 * 1000)\r\n    }\r\n\r\n    return () => {\r\n      if (intervalId) {\r\n        clearInterval(intervalId)\r\n      }\r\n    }\r\n  }, [enableRealTimeUpdates, supplierId, state.aiConfig.autoRefresh, refreshAll])\r\n\r\n  // Initialize welcome message for chat\r\n  useEffect(() => {\r\n    if (state.chatMessages.length === 0 && state.aiConfig.enabledFeatures.includes('chat')) {\r\n      dispatch({\r\n        type: 'ADD_CHAT_MESSAGE',\r\n        payload: {\r\n          role: 'assistant',\r\n          content: `Hello! I'm your AI Supplier Intelligence Assistant. I can help you with:\r\n\r\n• **Supplier Analysis** - Performance, risk, and cost analysis\r\n• **Market Insights** - Industry trends and competitive intelligence\r\n• **Recommendations** - Data-driven supplier optimization suggestions\r\n• **Q&A** - Answer specific questions about your suppliers\r\n\r\n${supplierId ? 'I can see we\\'re focusing on a specific supplier. ' : ''}What would you like to explore today?`,\r\n          metadata: {\r\n            type: 'welcome',\r\n            actionable: false\r\n          }\r\n        }\r\n      })\r\n    }\r\n  }, [state.chatMessages.length, state.aiConfig.enabledFeatures, supplierId])\r\n\r\n  return {\r\n    state,\r\n    fetchRecommendations,\r\n    fetchInsights,\r\n    sendChatMessage,\r\n    bookmarkInsight,\r\n    provideInsightFeedback,\r\n    clearRecommendations,\r\n    clearInsights,\r\n    clearChat,\r\n    refreshAll\r\n  }\r\n}\r\n\r\n// Specialized hooks for specific use cases\r\nexport function useAISupplierRecommendations(query?: string, filters?: Record<string, any>) {\r\n  const { state, fetchRecommendations, clearRecommendations } = useAISupplier({\r\n    autoFetch: false\r\n  })\r\n\r\n  const search = useCallback(async (searchQuery?: string, searchFilters?: Record<string, any>) => {\r\n    await fetchRecommendations(searchQuery || query, searchFilters || filters)\r\n  }, [fetchRecommendations, query, filters])\r\n\r\n  return {\r\n    recommendations: state.recommendations,\r\n    loading: state.recommendationsLoading,\r\n    error: state.recommendationsError,\r\n    search,\r\n    clear: clearRecommendations\r\n  }\r\n}\r\n\r\nexport function useAISupplierInsights(supplierId?: string, categories?: string[]) {\r\n  const { state, fetchInsights, clearInsights, bookmarkInsight, provideInsightFeedback } = useAISupplier({\r\n    supplierId,\r\n    autoFetch: !!supplierId\r\n  })\r\n\r\n  const refreshInsights = useCallback(async (newCategories?: string[]) => {\r\n    await fetchInsights(supplierId, newCategories || categories)\r\n  }, [fetchInsights, supplierId, categories])\r\n\r\n  return {\r\n    insights: state.insights,\r\n    loading: state.insightsLoading,\r\n    error: state.insightsError,\r\n    refresh: refreshInsights,\r\n    clear: clearInsights,\r\n    bookmark: bookmarkInsight,\r\n    provideFeedback: provideInsightFeedback\r\n  }\r\n}\r\n\r\nexport function useAISupplierChat(supplierId?: string) {\r\n  const { state, sendChatMessage, clearChat } = useAISupplier({\r\n    supplierId,\r\n    autoFetch: false\r\n  })\r\n\r\n  return {\r\n    messages: state.chatMessages,\r\n    isTyping: state.isTyping,\r\n    sendMessage: sendChatMessage,\r\n    clearChat\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\hooks\\useKeyboardShortcuts.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'KeyboardEvent' is not defined.","line":29,"column":13,"nodeType":"Identifier","messageId":"undef","endLine":29,"endColumn":26},{"ruleId":"no-undef","severity":2,"message":"'HTMLElement' is not defined.","line":31,"column":38,"nodeType":"Identifier","messageId":"undef","endLine":31,"endColumn":49}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Keyboard shortcuts hook for NXT-SPP\r\n *\r\n * Shortcuts:\r\n * - Ctrl+U: Open upload dialog\r\n * - Ctrl+S: Open selection wizard\r\n * - Ctrl+R: Refresh data\r\n * - Escape: Close modals\r\n */\r\n\r\nimport { useEffect, useCallback } from 'react';\r\n\r\ninterface KeyboardShortcutsOptions {\r\n  onUpload?: () => void;\r\n  onSelection?: () => void;\r\n  onRefresh?: () => void;\r\n  onEscape?: () => void;\r\n  enabled?: boolean;\r\n}\r\n\r\nexport function useKeyboardShortcuts({\r\n  onUpload,\r\n  onSelection,\r\n  onRefresh,\r\n  onEscape,\r\n  enabled = true,\r\n}: KeyboardShortcutsOptions) {\r\n  const handleKeyDown = useCallback(\r\n    (event: KeyboardEvent) => {\r\n      // Ignore if typing in input fields\r\n      const target = event.target as HTMLElement;\r\n      if (\r\n        target.tagName === 'INPUT' ||\r\n        target.tagName === 'TEXTAREA' ||\r\n        target.isContentEditable\r\n      ) {\r\n        // Only handle Escape in input fields\r\n        if (event.key === 'Escape' && onEscape) {\r\n          onEscape();\r\n        }\r\n        return;\r\n      }\r\n\r\n      // Handle keyboard shortcuts\r\n      if ((event.ctrlKey || event.metaKey) && !event.shiftKey && !event.altKey) {\r\n        switch (event.key.toLowerCase()) {\r\n          case 'u':\r\n            event.preventDefault();\r\n            onUpload?.();\r\n            break;\r\n          case 's':\r\n            event.preventDefault();\r\n            onSelection?.();\r\n            break;\r\n          case 'r':\r\n            event.preventDefault();\r\n            onRefresh?.();\r\n            break;\r\n        }\r\n      } else if (event.key === 'Escape' && onEscape) {\r\n        onEscape();\r\n      }\r\n    },\r\n    [onUpload, onSelection, onRefresh, onEscape]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!enabled) return;\r\n\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    return () => {\r\n      window.removeEventListener('keydown', handleKeyDown);\r\n    };\r\n  }, [handleKeyDown, enabled]);\r\n}\r\n\r\n/**\r\n * Hook for showing keyboard shortcut hints\r\n */\r\nexport function useKeyboardShortcutHints() {\r\n  const shortcuts = [\r\n    { key: 'Ctrl+U', description: 'Upload pricelist', mac: '⌘+U' },\r\n    { key: 'Ctrl+S', description: 'Open selection wizard', mac: '⌘+S' },\r\n    { key: 'Ctrl+R', description: 'Refresh data', mac: '⌘+R' },\r\n    { key: 'Esc', description: 'Close dialog', mac: 'Esc' },\r\n  ];\r\n\r\n  const isMac = typeof window !== 'undefined' && navigator.platform.toUpperCase().indexOf('MAC') >= 0;\r\n\r\n  return shortcuts.map(shortcut => ({\r\n    key: isMac ? shortcut.mac : shortcut.key,\r\n    description: shortcut.description,\r\n  }));\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\hooks\\useOptimizedRealTimeData.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'WebSocket' is not defined.","line":45,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":45,"endColumn":33},{"ruleId":"no-undef","severity":2,"message":"'WebSocket' is not defined.","line":90,"column":27,"nodeType":"Identifier","messageId":"undef","endLine":90,"endColumn":36}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Optimized Real-Time Data Hook\r\n * Enhanced version with better debouncing, error handling, and performance optimizations\r\n */\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react';\r\n\r\ninterface OptimizedRealTimeDataOptions {\r\n  table: string;\r\n  autoReconnect?: boolean;\r\n  debounceMs?: number;\r\n  maxRetries?: number;\r\n  retryDelayMs?: number;\r\n  onError?: (error: Error) => void;\r\n  onUpdate?: (data: any) => void;\r\n}\r\n\r\ninterface RealTimeDataState<T = any> {\r\n  data: T | null;\r\n  connected: boolean;\r\n  loading: boolean;\r\n  error: string | null;\r\n  lastUpdate: Date | null;\r\n  retryCount: number;\r\n}\r\n\r\nexport function useOptimizedRealTimeData<T = any>({\r\n  table,\r\n  autoReconnect = true,\r\n  debounceMs = 1000,\r\n  maxRetries = 3,\r\n  retryDelayMs = 2000,\r\n  onError,\r\n  onUpdate\r\n}: OptimizedRealTimeDataOptions) {\r\n  const [state, setState] = useState<RealTimeDataState<T>>({\r\n    data: null,\r\n    connected: false,\r\n    loading: false,\r\n    error: null,\r\n    lastUpdate: null,\r\n    retryCount: 0\r\n  });\r\n\r\n  const wsRef = useRef<WebSocket | null>(null);\r\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const debounceTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const isUnmountedRef = useRef(false);\r\n\r\n  /**\r\n   * Debounced update handler to prevent excessive re-renders\r\n   */\r\n  const debouncedUpdate = useCallback((data: T) => {\r\n    if (debounceTimeoutRef.current) {\r\n      clearTimeout(debounceTimeoutRef.current);\r\n    }\r\n\r\n    debounceTimeoutRef.current = setTimeout(() => {\r\n      if (isUnmountedRef.current) return;\r\n\r\n      setState(prev => ({\r\n        ...prev,\r\n        data,\r\n        lastUpdate: new Date(),\r\n        error: null\r\n      }));\r\n\r\n      onUpdate?.(data);\r\n    }, debounceMs);\r\n  }, [debounceMs, onUpdate]);\r\n\r\n  /**\r\n   * Connect to WebSocket with error handling\r\n   */\r\n  const connect = useCallback(() => {\r\n    if (isUnmountedRef.current) return;\r\n\r\n    try {\r\n      // Close existing connection\r\n      if (wsRef.current) {\r\n        wsRef.current.close();\r\n      }\r\n\r\n      setState(prev => ({ ...prev, loading: true, error: null }));\r\n\r\n      // Create new WebSocket connection\r\n      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n      const wsUrl = `${protocol}//${window.location.host}/ws/tables/${table}`;\r\n\r\n      wsRef.current = new WebSocket(wsUrl);\r\n\r\n      wsRef.current.onopen = () => {\r\n        if (isUnmountedRef.current) return;\r\n\r\n        setState(prev => ({\r\n          ...prev,\r\n          connected: true,\r\n          loading: false,\r\n          retryCount: 0,\r\n          error: null\r\n        }));\r\n\r\n        console.log(`✅ Connected to real-time data for table: ${table}`);\r\n      };\r\n\r\n      wsRef.current.onmessage = (event) => {\r\n        if (isUnmountedRef.current) return;\r\n\r\n        try {\r\n          const data = JSON.parse(event.data);\r\n          debouncedUpdate(data);\r\n        } catch (err) {\r\n          console.error('❌ Error parsing WebSocket message:', err);\r\n          setState(prev => ({\r\n            ...prev,\r\n            error: 'Failed to parse real-time data'\r\n          }));\r\n        }\r\n      };\r\n\r\n      wsRef.current.onclose = (event) => {\r\n        if (isUnmountedRef.current) return;\r\n\r\n        setState(prev => ({ ...prev, connected: false, loading: false }));\r\n\r\n        if (event.wasClean) {\r\n          console.log(`🔌 WebSocket connection closed cleanly for table: ${table}`);\r\n        } else {\r\n          console.warn(`⚠️ WebSocket connection lost for table: ${table}`);\r\n\r\n          if (autoReconnect && state.retryCount < maxRetries) {\r\n            scheduleReconnect();\r\n          }\r\n        }\r\n      };\r\n\r\n      wsRef.current.onerror = (error) => {\r\n        if (isUnmountedRef.current) return;\r\n\r\n        const errorMsg = `WebSocket error for table ${table}`;\r\n        console.error('❌', errorMsg, error);\r\n\r\n        setState(prev => ({\r\n          ...prev,\r\n          connected: false,\r\n          loading: false,\r\n          error: errorMsg\r\n        }));\r\n\r\n        onError?.(new Error(errorMsg));\r\n      };\r\n\r\n    } catch (err) {\r\n      const errorMsg = `Failed to connect to real-time data for table ${table}`;\r\n      console.error('❌', errorMsg, err);\r\n\r\n      setState(prev => ({\r\n        ...prev,\r\n        connected: false,\r\n        loading: false,\r\n        error: errorMsg\r\n      }));\r\n\r\n      onError?.(err instanceof Error ? err : new Error(errorMsg));\r\n    }\r\n  }, [table, autoReconnect, maxRetries, onError, debouncedUpdate, state.retryCount]);\r\n\r\n  /**\r\n   * Schedule reconnection with exponential backoff\r\n   */\r\n  const scheduleReconnect = useCallback(() => {\r\n    if (isUnmountedRef.current || !autoReconnect) return;\r\n\r\n    setState(prev => ({ ...prev, retryCount: prev.retryCount + 1 }));\r\n\r\n    const delay = retryDelayMs * Math.pow(2, state.retryCount);\r\n\r\n    reconnectTimeoutRef.current = setTimeout(() => {\r\n      if (isUnmountedRef.current) return;\r\n      console.log(`🔄 Attempting to reconnect to table: ${table} (attempt ${state.retryCount + 1})`);\r\n      connect();\r\n    }, delay);\r\n  }, [autoReconnect, retryDelayMs, state.retryCount, table, connect]);\r\n\r\n  /**\r\n   * Manual reconnection\r\n   */\r\n  const reconnect = useCallback(() => {\r\n    if (reconnectTimeoutRef.current) {\r\n      clearTimeout(reconnectTimeoutRef.current);\r\n    }\r\n\r\n    setState(prev => ({ ...prev, retryCount: 0 }));\r\n    connect();\r\n  }, [connect]);\r\n\r\n  /**\r\n   * Disconnect WebSocket\r\n   */\r\n  const disconnect = useCallback(() => {\r\n    if (reconnectTimeoutRef.current) {\r\n      clearTimeout(reconnectTimeoutRef.current);\r\n      reconnectTimeoutRef.current = null;\r\n    }\r\n\r\n    if (wsRef.current) {\r\n      wsRef.current.close(1000, 'Manual disconnect');\r\n      wsRef.current = null;\r\n    }\r\n\r\n    setState(prev => ({ ...prev, connected: false }));\r\n  }, []);\r\n\r\n  /**\r\n   * Initial connection\r\n   */\r\n  useEffect(() => {\r\n    connect();\r\n\r\n    return () => {\r\n      isUnmountedRef.current = true;\r\n      disconnect();\r\n\r\n      if (debounceTimeoutRef.current) {\r\n        clearTimeout(debounceTimeoutRef.current);\r\n      }\r\n    };\r\n  }, [connect, disconnect]);\r\n\r\n  /**\r\n   * Cleanup on unmount\r\n   */\r\n  useEffect(() => {\r\n    return () => {\r\n      isUnmountedRef.current = true;\r\n    };\r\n  }, []);\r\n\r\n  return {\r\n    ...state,\r\n    reconnect,\r\n    disconnect,\r\n    isRetrying: state.retryCount > 0 && state.retryCount < maxRetries,\r\n    canRetry: state.retryCount < maxRetries\r\n  };\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\hooks\\useRealTimeData.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'WebSocket' is not defined.","line":53,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":53,"endColumn":33},{"ruleId":"no-undef","severity":2,"message":"'WebSocket' is not defined.","line":63,"column":39,"nodeType":"Identifier","messageId":"undef","endLine":63,"endColumn":48},{"ruleId":"no-undef","severity":2,"message":"'WebSocket' is not defined.","line":72,"column":27,"nodeType":"Identifier","messageId":"undef","endLine":72,"endColumn":36},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":189,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":189,"endColumn":87,"suggestions":[{"messageId":"addBrackets","fix":{"range":[5573,5761],"text":"{ const updateIndex = newData.findIndex((item: any) => item.id === record.id);\r\n          if (updateIndex !== -1) {\r\n            newData[updateIndex] = record;\r\n          }\r\n          break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-undef","severity":2,"message":"'WebSocket' is not defined.","line":216,"column":56,"nodeType":"Identifier","messageId":"undef","endLine":216,"endColumn":65},{"ruleId":"no-undef","severity":2,"message":"'WebSocket' is not defined.","line":241,"column":56,"nodeType":"Identifier","messageId":"undef","endLine":241,"endColumn":65},{"ruleId":"no-undef","severity":2,"message":"'WebSocket' is not defined.","line":302,"column":56,"nodeType":"Identifier","messageId":"undef","endLine":302,"endColumn":65}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * Enhanced Real-Time Data Hooks for Live Database Integration\r\n * Comprehensive hooks for replacing mock data with live database connections\r\n */\r\n\r\nimport { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { useQueryClient, useQuery, useMutation, useInfiniteQuery } from '@tanstack/react-query';\r\n\r\nexport interface RealTimeConfig {\r\n  table: string;\r\n  organizationId?: string;\r\n  userId?: string;\r\n  filters?: Record<string, any>;\r\n  autoReconnect?: boolean;\r\n  reconnectInterval?: number;\r\n}\r\n\r\nexport interface RealTimeMessage {\r\n  type: 'subscribe' | 'unsubscribe' | 'data' | 'error' | 'heartbeat';\r\n  data?: any;\r\n  timestamp: string;\r\n  clientId: string;\r\n}\r\n\r\nexport interface RealTimeData<T = any> {\r\n  data: T[];\r\n  loading: boolean;\r\n  error: string | null;\r\n  connected: boolean;\r\n  lastUpdate: string | null;\r\n}\r\n\r\nexport interface UseRealTimeDataReturn<T = any> extends RealTimeData<T> {\r\n  subscribe: (config: RealTimeConfig) => void;\r\n  unsubscribe: (table?: string) => void;\r\n  refresh: () => Promise<void>;\r\n  sendMessage: (message: any) => void;\r\n}\r\n\r\n/**\r\n * Hook for real-time database integration\r\n */\r\nexport function useRealTimeData<T = any>(\r\n  initialConfig?: RealTimeConfig\r\n): UseRealTimeDataReturn<T> {\r\n  const [data, setData] = useState<T[]>([]);\r\n  const [loading, setLoading] = useState<boolean>(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [connected, setConnected] = useState<boolean>(false);\r\n  const [lastUpdate, setLastUpdate] = useState<string | null>(null);\r\n\r\n  const wsRef = useRef<WebSocket | null>(null);\r\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const configRef = useRef<RealTimeConfig | null>(initialConfig || null);\r\n  const reconnectAttemptsRef = useRef<number>(0);\r\n  const maxReconnectAttempts = 5;\r\n\r\n  /**\r\n   * Connect to WebSocket server\r\n   */\r\n  const connect = useCallback(() => {\r\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const wsUrl = process.env.NODE_ENV === 'production'\r\n        ? `wss://${window.location.host}/ws`\r\n        : `ws://localhost:3001`;\r\n\r\n      wsRef.current = new WebSocket(wsUrl);\r\n\r\n      wsRef.current.onopen = () => {\r\n        console.log('🔌 Connected to real-time server');\r\n        setConnected(true);\r\n        setError(null);\r\n        reconnectAttemptsRef.current = 0;\r\n\r\n        // Subscribe to initial config if provided\r\n        if (configRef.current) {\r\n          subscribe(configRef.current);\r\n        }\r\n      };\r\n\r\n      wsRef.current.onmessage = (event) => {\r\n        try {\r\n          const message: RealTimeMessage = JSON.parse(event.data);\r\n          handleMessage(message);\r\n        } catch (err) {\r\n          console.error('❌ Error parsing WebSocket message:', err);\r\n          setError('Invalid message received');\r\n        }\r\n      };\r\n\r\n      wsRef.current.onclose = (event) => {\r\n        console.log('🔌 Disconnected from real-time server');\r\n        setConnected(false);\r\n\r\n        // Auto-reconnect if enabled and not a clean close\r\n        if (configRef.current?.autoReconnect !== false && event.code !== 1000) {\r\n          scheduleReconnect();\r\n        }\r\n      };\r\n\r\n      wsRef.current.onerror = (event) => {\r\n        console.error('❌ WebSocket error:', event);\r\n        setError('Connection error');\r\n        setConnected(false);\r\n      };\r\n\r\n    } catch (err) {\r\n      console.error('❌ Failed to connect to WebSocket:', err);\r\n      setError('Failed to connect');\r\n      scheduleReconnect();\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Schedule reconnection with exponential backoff\r\n   */\r\n  const scheduleReconnect = useCallback(() => {\r\n    if (reconnectAttemptsRef.current >= maxReconnectAttempts) {\r\n      setError('Max reconnection attempts reached');\r\n      return;\r\n    }\r\n\r\n    const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 30000);\r\n    reconnectAttemptsRef.current++;\r\n\r\n    console.log(`🔄 Scheduling reconnect attempt ${reconnectAttemptsRef.current} in ${delay}ms`);\r\n\r\n    reconnectTimeoutRef.current = setTimeout(() => {\r\n      connect();\r\n    }, delay);\r\n  }, [connect]);\r\n\r\n  /**\r\n   * Handle incoming WebSocket messages\r\n   */\r\n  const handleMessage = useCallback((message: RealTimeMessage) => {\r\n    switch (message.type) {\r\n      case 'data':\r\n        if (message.data?.operation) {\r\n          handleDataUpdate(message.data);\r\n        } else {\r\n          console.log('📡 Server message:', message.data);\r\n        }\r\n        break;\r\n\r\n      case 'error':\r\n        console.error('❌ Server error:', message.data?.error);\r\n        setError(message.data?.error || 'Unknown server error');\r\n        break;\r\n\r\n      case 'heartbeat':\r\n        // Update last seen timestamp\r\n        setLastUpdate(message.timestamp);\r\n        break;\r\n\r\n      default:\r\n        console.log('📡 Unknown message type:', message.type);\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Handle real-time data updates\r\n   */\r\n  const handleDataUpdate = useCallback((updateData: any) => {\r\n    const { operation, table, record } = updateData;\r\n\r\n    if (!configRef.current || configRef.current.table !== table) {\r\n      return;\r\n    }\r\n\r\n    setData((prevData) => {\r\n      let newData = [...prevData];\r\n\r\n      switch (operation) {\r\n        case 'INSERT':\r\n          // Add new record if not already present\r\n          if (!newData.find((item: any) => item.id === record.id)) {\r\n            newData.unshift(record);\r\n          }\r\n          break;\r\n\r\n        case 'UPDATE':\r\n          // Update existing record\r\n          const updateIndex = newData.findIndex((item: any) => item.id === record.id);\r\n          if (updateIndex !== -1) {\r\n            newData[updateIndex] = record;\r\n          }\r\n          break;\r\n\r\n        case 'DELETE':\r\n          // Remove deleted record\r\n          newData = newData.filter((item: any) => item.id !== record.id);\r\n          break;\r\n\r\n        default:\r\n          console.warn('Unknown operation:', operation);\r\n      }\r\n\r\n      return newData;\r\n    });\r\n\r\n    setLastUpdate(updateData.timestamp);\r\n  }, []);\r\n\r\n  /**\r\n   * Subscribe to table updates\r\n   */\r\n  const subscribe = useCallback((config: RealTimeConfig) => {\r\n    configRef.current = config;\r\n\r\n    if (!wsRef.current || wsRef.current.readyState !== WebSocket.OPEN) {\r\n      console.log('🔄 WebSocket not ready, will subscribe when connected');\r\n      return;\r\n    }\r\n\r\n    const message = {\r\n      type: 'subscribe',\r\n      table: config.table,\r\n      data: {\r\n        organizationId: config.organizationId,\r\n        userId: config.userId,\r\n        filters: config.filters || {}\r\n      },\r\n      timestamp: new Date().toISOString(),\r\n      clientId: 'web-client'\r\n    };\r\n\r\n    wsRef.current.send(JSON.stringify(message));\r\n    console.log(`📡 Subscribed to ${config.table}`);\r\n  }, []);\r\n\r\n  /**\r\n   * Unsubscribe from table updates\r\n   */\r\n  const unsubscribe = useCallback((table?: string) => {\r\n    if (!wsRef.current || wsRef.current.readyState !== WebSocket.OPEN) {\r\n      return;\r\n    }\r\n\r\n    const message = {\r\n      type: 'unsubscribe',\r\n      table: table || configRef.current?.table,\r\n      timestamp: new Date().toISOString(),\r\n      clientId: 'web-client'\r\n    };\r\n\r\n    wsRef.current.send(JSON.stringify(message));\r\n    console.log(`📡 Unsubscribed from ${table || 'all tables'}`);\r\n\r\n    if (!table) {\r\n      configRef.current = null;\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Refresh data from API\r\n   */\r\n  const refresh = useCallback(async () => {\r\n    if (!configRef.current) return;\r\n\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const response = await fetch(`/api/${configRef.current.table}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Failed to fetch data: ${response.statusText}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n\r\n      if (result.success) {\r\n        setData(result.data?.data || result.data || []);\r\n        setLastUpdate(new Date().toISOString());\r\n      } else {\r\n        throw new Error(result.error || 'Failed to fetch data');\r\n      }\r\n\r\n    } catch (err) {\r\n      console.error('❌ Error refreshing data:', err);\r\n      setError(err instanceof Error ? err.message : 'Failed to refresh data');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  /**\r\n   * Send custom message to server\r\n   */\r\n  const sendMessage = useCallback((messageData: any) => {\r\n    if (!wsRef.current || wsRef.current.readyState !== WebSocket.OPEN) {\r\n      console.warn('⚠️ WebSocket not connected, cannot send message');\r\n      return;\r\n    }\r\n\r\n    const message = {\r\n      ...messageData,\r\n      timestamp: new Date().toISOString(),\r\n      clientId: 'web-client'\r\n    };\r\n\r\n    wsRef.current.send(JSON.stringify(message));\r\n  }, []);\r\n\r\n  /**\r\n   * Initialize connection on mount\r\n   */\r\n  useEffect(() => {\r\n    connect();\r\n\r\n    return () => {\r\n      if (reconnectTimeoutRef.current) {\r\n        clearTimeout(reconnectTimeoutRef.current);\r\n      }\r\n      if (wsRef.current) {\r\n        wsRef.current.close(1000, 'Component unmounting');\r\n      }\r\n    };\r\n  }, [connect]);\r\n\r\n  /**\r\n   * Fetch initial data if config provided\r\n   */\r\n  useEffect(() => {\r\n    if (initialConfig) {\r\n      refresh();\r\n    }\r\n  }, [initialConfig, refresh]);\r\n\r\n  return {\r\n    data,\r\n    loading,\r\n    error,\r\n    connected,\r\n    lastUpdate,\r\n    subscribe,\r\n    unsubscribe,\r\n    refresh,\r\n    sendMessage\r\n  };\r\n}\r\n\r\n// Enhanced supplier data hook with real-time updates\r\nexport const useRealTimeSuppliers = (filters = {}) => {\r\n  const queryClient = useQueryClient()\r\n\r\n  // Real-time updates via WebSocket\r\n  useRealTimeData({\r\n    table: 'suppliers',\r\n    filters,\r\n    autoReconnect: true\r\n  })\r\n\r\n  return useQuery({\r\n    queryKey: ['suppliers', filters],\r\n    queryFn: async () => {\r\n      const params = new URLSearchParams()\r\n\r\n      Object.entries(filters).forEach(([key, value]) => {\r\n        if (Array.isArray(value)) {\r\n          params.append(key, value.join(','))\r\n        } else if (value !== undefined && value !== null) {\r\n          params.append(key, String(value))\r\n        }\r\n      })\r\n\r\n      const response = await fetch(`/api/suppliers?${params.toString()}`)\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      return response.json()\r\n    },\r\n    staleTime: 2 * 60 * 1000, // 2 minutes\r\n    cacheTime: 10 * 60 * 1000, // 10 minutes\r\n    refetchOnWindowFocus: false,\r\n    keepPreviousData: true\r\n  })\r\n}\r\n\r\n// Enhanced inventory hook with real-time updates\r\nexport const useRealTimeInventory = (filters = {}) => {\r\n  const queryClient = useQueryClient()\r\n\r\n  // Real-time inventory updates\r\n  useRealTimeData({\r\n    table: 'inventory_items',\r\n    filters,\r\n    autoReconnect: true\r\n  })\r\n\r\n  return useQuery({\r\n    queryKey: ['inventory', filters],\r\n    queryFn: async () => {\r\n      const params = new URLSearchParams()\r\n\r\n      Object.entries(filters).forEach(([key, value]) => {\r\n        if (Array.isArray(value)) {\r\n          params.append(key, value.join(','))\r\n        } else if (value !== undefined && value !== null) {\r\n          params.append(key, String(value))\r\n        }\r\n      })\r\n\r\n      const response = await fetch(`/api/inventory?${params.toString()}`)\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      return response.json()\r\n    },\r\n    staleTime: 30 * 1000, // 30 seconds (more frequent for inventory)\r\n    cacheTime: 5 * 60 * 1000, // 5 minutes\r\n    refetchInterval: 60 * 1000, // Refetch every minute\r\n    keepPreviousData: true\r\n  })\r\n}\r\n\r\n// Real-time dashboard metrics\r\nexport const useRealTimeDashboard = () => {\r\n  const queryClient = useQueryClient()\r\n\r\n  // Real-time dashboard updates\r\n  const dashboardData = useRealTimeData({\r\n    table: 'dashboard_metrics',\r\n    autoReconnect: true\r\n  })\r\n\r\n  const metricsQuery = useQuery({\r\n    queryKey: ['dashboard-metrics'],\r\n    queryFn: async () => {\r\n      const response = await fetch('/api/analytics/dashboard')\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n      return response.json()\r\n    },\r\n    staleTime: 60 * 1000, // 1 minute\r\n    refetchInterval: 2 * 60 * 1000, // Refetch every 2 minutes\r\n  })\r\n\r\n  const activityQuery = useQuery({\r\n    queryKey: ['recent-activity'],\r\n    queryFn: async () => {\r\n      const response = await fetch('/api/activities/recent')\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n      return response.json()\r\n    },\r\n    staleTime: 30 * 1000, // 30 seconds\r\n  })\r\n\r\n  return {\r\n    metrics: metricsQuery.data,\r\n    activities: activityQuery.data,\r\n    loading: metricsQuery.isLoading || activityQuery.isLoading,\r\n    error: metricsQuery.error || activityQuery.error,\r\n    realTimeData: dashboardData\r\n  }\r\n}\r\n\r\n// Price list data integration\r\nexport const usePriceLists = (supplierId?: string) => {\r\n  return useQuery({\r\n    queryKey: ['price-lists', supplierId],\r\n    queryFn: async () => {\r\n      const url = supplierId\r\n        ? `/api/suppliers/${supplierId}/pricelists`\r\n        : '/api/pricelists'\r\n\r\n      const response = await fetch(url)\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      return response.json()\r\n    },\r\n    enabled: !!supplierId,\r\n    staleTime: 5 * 60 * 1000, // 5 minutes\r\n    keepPreviousData: true\r\n  })\r\n}\r\n\r\n// Optimistic updates for mutations\r\nexport const useSupplierMutations = () => {\r\n  const queryClient = useQueryClient()\r\n\r\n  const createSupplier = useMutation({\r\n    mutationFn: async (supplierData: any) => {\r\n      const response = await fetch('/api/suppliers', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(supplierData),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      return response.json()\r\n    },\r\n    onSuccess: (data) => {\r\n      // Update all relevant queries\r\n      queryClient.setQueryData(['suppliers'], (old: any) => ({\r\n        ...old,\r\n        data: [data.data, ...(old?.data || [])]\r\n      }))\r\n\r\n      // Invalidate related queries\r\n      queryClient.invalidateQueries(['dashboard-metrics'])\r\n    },\r\n  })\r\n\r\n  const updateSupplier = useMutation({\r\n    mutationFn: async ({ id, data: supplierData }: { id: string, data: any }) => {\r\n      const response = await fetch(`/api/suppliers/${id}`, {\r\n        method: 'PUT',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(supplierData),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      return response.json()\r\n    },\r\n    onMutate: async ({ id, data: newData }) => {\r\n      // Cancel outgoing refetches\r\n      await queryClient.cancelQueries(['suppliers'])\r\n\r\n      // Snapshot previous value\r\n      const previousSuppliers = queryClient.getQueryData(['suppliers'])\r\n\r\n      // Optimistically update\r\n      queryClient.setQueryData(['suppliers'], (old: any) => ({\r\n        ...old,\r\n        data: old?.data?.map((supplier: any) =>\r\n          supplier.id === id ? { ...supplier, ...newData } : supplier\r\n        ) || []\r\n      }))\r\n\r\n      return { previousSuppliers }\r\n    },\r\n    onError: (err, variables, context) => {\r\n      // Rollback on error\r\n      queryClient.setQueryData(['suppliers'], context?.previousSuppliers)\r\n    },\r\n    onSettled: () => {\r\n      // Always refetch after error or success\r\n      queryClient.invalidateQueries(['suppliers'])\r\n    },\r\n  })\r\n\r\n  return { createSupplier, updateSupplier }\r\n}\r\n\r\n// Infinite scroll for large datasets\r\nexport const useInfiniteSuppliers = (filters = {}) => {\r\n  return useInfiniteQuery({\r\n    queryKey: ['suppliers-infinite', filters],\r\n    queryFn: async ({ pageParam = 1 }) => {\r\n      const params = new URLSearchParams({\r\n        page: pageParam.toString(),\r\n        limit: '20',\r\n        ...Object.fromEntries(\r\n          Object.entries(filters).map(([key, value]) => [\r\n            key,\r\n            Array.isArray(value) ? value.join(',') : String(value)\r\n          ])\r\n        )\r\n      })\r\n\r\n      const response = await fetch(`/api/suppliers?${params.toString()}`)\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      return response.json()\r\n    },\r\n    getNextPageParam: (lastPage) =>\r\n      lastPage.pagination?.hasNext ? (lastPage.pagination.page + 1) : undefined,\r\n    keepPreviousData: true,\r\n    staleTime: 5 * 60 * 1000, // 5 minutes\r\n  })\r\n}\r\n\r\nexport default useRealTimeData;","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\hooks\\useRealTimeDataFixed.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * OPTIMIZED Real-Time Data Hooks with Performance & Caching Improvements\r\n * Enhanced version with better caching, deduplication, and memory management\r\n */\r\n\r\nimport { useState, useEffect, useRef, useCallback, useMemo } from 'react';\r\nimport {\r\n  useQueryClient,\r\n  useQuery,\r\n  useMutation,\r\n  useInfiniteQuery,\r\n  type QueryKey\r\n} from '@tanstack/react-query';\r\n\r\n// Performance-optimized configuration\r\nconst API_CONFIG = {\r\n  timeout: 12000, // Reduced from 15s to 12s for better UX\r\n  retries: 3, // Increased retries but with better backoff\r\n  staleTime: 2 * 60 * 1000, // 2 minutes - better caching\r\n  refetchInterval: 3 * 60 * 1000, // 3 minutes - more frequent updates\r\n  fallbackRefreshInterval: 45 * 1000, // 45 seconds for fallback\r\n  cacheTime: 10 * 60 * 1000, // 10 minutes cache retention\r\n  dedupingInterval: 2000, // 2 seconds request deduplication\r\n};\r\n\r\ntype SupplierFilterValue = string | number | boolean | string[] | null | undefined;\r\ntype SupplierFilters = Record<string, SupplierFilterValue>;\r\n\r\ninterface SupplierPagination {\r\n  page: number;\r\n  hasNext: boolean;\r\n}\r\n\r\ninterface SupplierListResponse {\r\n  data?: unknown;\r\n  pagination?: SupplierPagination;\r\n}\r\n\r\n// Request deduplication cache\r\nconst requestCache = new Map<string, Promise<unknown>>();\r\nconst cacheCleanupInterval = 30000; // Clean cache every 30 seconds\r\n\r\n// Cleanup old requests periodically\r\nsetInterval(() => {\r\n  requestCache.clear();\r\n}, cacheCleanupInterval);\r\n\r\n// Enhanced fetch with timeout, caching, and deduplication\r\nasync function fetchWithTimeout<T = unknown>(\r\n  url: string,\r\n  options: RequestInit = {},\r\n  timeout = API_CONFIG.timeout\r\n): Promise<T> {\r\n  // Generate cache key for deduplication\r\n  const cacheKey = `${url}-${JSON.stringify(options)}`;\r\n  \r\n  // Return cached promise if request is in flight\r\n  if (requestCache.has(cacheKey)) {\r\n    return requestCache.get(cacheKey)! as Promise<T>;\r\n  }\r\n\r\n  const controller = new AbortController();\r\n  const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n  const requestPromise: Promise<T> = (async () => {\r\n    try {\r\n      const response = await fetch(url, {\r\n        ...options,\r\n        signal: controller.signal,\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Cache-Control': 'max-age=120', // 2 minute browser cache\r\n          ...options.headers,\r\n        },\r\n      });\r\n\r\n      clearTimeout(timeoutId);\r\n\r\n      if (!response.ok) {\r\n        // More detailed error messages\r\n        const errorText = await response.text().catch(() => 'Unknown error');\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);\r\n      }\r\n\r\n      return (await response.json()) as T;\r\n    } catch (error) {\r\n      clearTimeout(timeoutId);\r\n      if (error instanceof Error && error.name === 'AbortError') {\r\n        throw new Error('Request timed out - server may be overloaded');\r\n      }\r\n      throw error;\r\n    } finally {\r\n      // Clean up cache entry after request completes\r\n      setTimeout(() => {\r\n        requestCache.delete(cacheKey);\r\n      }, API_CONFIG.dedupingInterval);\r\n    }\r\n  })();\r\n\r\n  // Cache the promise\r\n  requestCache.set(cacheKey, requestPromise);\r\n  \r\n  return requestPromise;\r\n}\r\n\r\n// Enhanced supplier data hook with optimized caching and deduplication\r\nexport const useRealTimeSuppliers = (filters = {}) => {\r\n  const queryClient = useQueryClient();\r\n\r\n  // Stable query key generation to prevent unnecessary refetches\r\n  const queryKey = useMemo(() => {\r\n    const sortedFilters = Object.keys(filters).sort().reduce((sorted, key) => {\r\n      sorted[key] = filters[key];\r\n      return sorted;\r\n    }, {});\r\n    return ['suppliers', sortedFilters];\r\n  }, [filters]);\r\n\r\n  return useQuery({\r\n    queryKey,\r\n    queryFn: async () => {\r\n      const params = new URLSearchParams();\r\n\r\n      Object.entries(filters).forEach(([key, value]) => {\r\n        if (Array.isArray(value)) {\r\n          params.append(key, value.join(','));\r\n        } else if (value !== undefined && value !== null) {\r\n          params.append(key, String(value));\r\n        }\r\n      });\r\n\r\n      const url = `/api/suppliers?${params.toString()}`;\r\n      console.log('🔍 Fetching suppliers from:', url);\r\n\r\n      return fetchWithTimeout(url);\r\n    },\r\n    staleTime: API_CONFIG.staleTime,\r\n    cacheTime: API_CONFIG.cacheTime,\r\n    refetchInterval: API_CONFIG.refetchInterval,\r\n    refetchOnWindowFocus: false,\r\n    keepPreviousData: true,\r\n    notifyOnChangeProps: ['data', 'error', 'isLoading'], // Reduce re-renders\r\n    retry: (failureCount, error) => {\r\n      // Don't retry on 4xx errors, only on network/timeout errors\r\n      if (error.message.includes('HTTP 4')) return false;\r\n      return failureCount < API_CONFIG.retries;\r\n    },\r\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 15000),\r\n    onError: (error) => {\r\n      console.error('❌ Suppliers fetch error:', error.message);\r\n    },\r\n    onSuccess: (data) => {\r\n      console.log('✅ Suppliers loaded:', data?.data?.length || 0, 'items');\r\n      \r\n      // Pre-populate individual supplier queries in cache for performance\r\n      data?.data?.forEach(supplier => {\r\n        queryClient.setQueryData(\r\n          ['supplier', supplier.id],\r\n          supplier,\r\n          { updatedAt: Date.now() }\r\n        );\r\n      });\r\n    }\r\n  });\r\n};\r\n\r\n// Enhanced inventory hook with optimized caching and performance\r\nexport const useRealTimeInventory = (filters = {}) => {\r\n  const queryClient = useQueryClient();\r\n\r\n  // Stable query key generation\r\n  const queryKey = useMemo(() => {\r\n    const sortedFilters = Object.keys(filters).sort().reduce((sorted, key) => {\r\n      sorted[key] = filters[key];\r\n      return sorted;\r\n    }, {});\r\n    return ['inventory', sortedFilters];\r\n  }, [filters]);\r\n\r\n  return useQuery({\r\n    queryKey,\r\n    queryFn: async () => {\r\n      const params = new URLSearchParams();\r\n\r\n      Object.entries(filters).forEach(([key, value]) => {\r\n        if (Array.isArray(value)) {\r\n          params.append(key, value.join(','));\r\n        } else if (value !== undefined && value !== null) {\r\n          params.append(key, String(value));\r\n        }\r\n      });\r\n\r\n      const url = `/api/inventory?${params.toString()}`;\r\n      console.log('🔍 Fetching inventory from:', url);\r\n\r\n      return fetchWithTimeout(url);\r\n    },\r\n    staleTime: API_CONFIG.staleTime,\r\n    cacheTime: API_CONFIG.cacheTime,\r\n    refetchInterval: API_CONFIG.refetchInterval,\r\n    refetchOnWindowFocus: false,\r\n    keepPreviousData: true,\r\n    notifyOnChangeProps: ['data', 'error', 'isLoading'],\r\n    retry: (failureCount, error) => {\r\n      if (error.message.includes('HTTP 4')) return false;\r\n      return failureCount < API_CONFIG.retries;\r\n    },\r\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 15000),\r\n    onError: (error) => {\r\n      console.error('❌ Inventory fetch error:', error.message);\r\n    },\r\n    onSuccess: (data) => {\r\n      console.log('✅ Inventory loaded:', data?.data?.length || 0, 'items');\r\n      \r\n      // Cache individual inventory items for performance\r\n      data?.data?.forEach(item => {\r\n        queryClient.setQueryData(\r\n          ['inventory-item', item.id],\r\n          item,\r\n          { updatedAt: Date.now() }\r\n        );\r\n      });\r\n    }\r\n  });\r\n};\r\n\r\n// Optimized dashboard metrics hook with better coordination\r\nexport const useRealTimeDashboard = () => {\r\n  const queryClient = useQueryClient();\r\n  \r\n  // Use ref to prevent race conditions in refetch\r\n  const refetchingRef = useRef(false);\r\n\r\n  const metricsQuery = useQuery({\r\n    queryKey: ['dashboard-metrics'],\r\n    queryFn: async () => {\r\n      console.log('🔍 Fetching dashboard metrics...');\r\n      return fetchWithTimeout('/api/analytics/dashboard');\r\n    },\r\n    staleTime: API_CONFIG.staleTime,\r\n    cacheTime: API_CONFIG.cacheTime,\r\n    refetchInterval: API_CONFIG.refetchInterval,\r\n    refetchOnWindowFocus: false,\r\n    notifyOnChangeProps: ['data', 'error', 'isLoading'],\r\n    retry: (failureCount, error) => {\r\n      if (error.message.includes('HTTP 4')) return false;\r\n      return failureCount < API_CONFIG.retries;\r\n    },\r\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 15000),\r\n    onError: (error) => {\r\n      console.error('❌ Dashboard metrics error:', error.message);\r\n    },\r\n    onSuccess: (data) => {\r\n      console.log('✅ Dashboard metrics loaded');\r\n    }\r\n  });\r\n\r\n  const activityQuery = useQuery({\r\n    queryKey: ['recent-activity'],\r\n    queryFn: async () => {\r\n      console.log('🔍 Fetching recent activities...');\r\n      return fetchWithTimeout('/api/activities/recent');\r\n    },\r\n    staleTime: API_CONFIG.fallbackRefreshInterval,\r\n    cacheTime: API_CONFIG.cacheTime,\r\n    refetchInterval: API_CONFIG.refetchInterval,\r\n    refetchOnWindowFocus: false,\r\n    notifyOnChangeProps: ['data', 'error', 'isLoading'],\r\n    retry: (failureCount, error) => {\r\n      if (error.message.includes('HTTP 4')) return false;\r\n      return failureCount < API_CONFIG.retries;\r\n    },\r\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 15000),\r\n    onError: (error) => {\r\n      console.error('❌ Activities fetch error:', error.message);\r\n    },\r\n    onSuccess: (data) => {\r\n      console.log('✅ Activities loaded:', data?.data?.length || 0, 'items');\r\n    }\r\n  });\r\n\r\n  // Enhanced real-time connection state with better memory management\r\n  const [realTimeData, setRealTimeData] = useState(() => ({\r\n    connected: true,\r\n    lastUpdate: new Date().toISOString(),\r\n    refetch: undefined as (() => Promise<void>) | undefined\r\n  }));\r\n\r\n  // Memoized refetch function to prevent unnecessary re-renders\r\n  const refetch = useCallback(async () => {\r\n    if (refetchingRef.current) {\r\n      console.log('⏳ Refetch already in progress, skipping...');\r\n      return;\r\n    }\r\n\r\n    refetchingRef.current = true;\r\n    try {\r\n      // Use Promise.allSettled to handle partial failures gracefully\r\n      const results = await Promise.allSettled([\r\n        metricsQuery.refetch(),\r\n        activityQuery.refetch()\r\n      ]);\r\n\r\n      const failures = results.filter(result => result.status === 'rejected');\r\n      if (failures.length > 0) {\r\n        console.warn(`⚠️ ${failures.length} of 2 dashboard queries failed`);\r\n      }\r\n\r\n      setRealTimeData(prev => ({\r\n        ...prev,\r\n        lastUpdate: new Date().toISOString()\r\n      }));\r\n    } catch (error) {\r\n      console.error('❌ Dashboard refetch failed:', error);\r\n    } finally {\r\n      refetchingRef.current = false;\r\n    }\r\n  }, [metricsQuery.refetch, activityQuery.refetch]);\r\n\r\n  // Update refetch function in state\r\n  useEffect(() => {\r\n    setRealTimeData(prev => ({ ...prev, refetch }));\r\n  }, [refetch]);\r\n\r\n  return {\r\n    metrics: metricsQuery.data,\r\n    activities: activityQuery.data?.data || [],\r\n    loading: metricsQuery.isLoading || activityQuery.isLoading,\r\n    error: metricsQuery.error || activityQuery.error,\r\n    realTimeData,\r\n    refetch\r\n  };\r\n};\r\n\r\n// Optimized alerts hook with better caching and priority handling\r\nexport const useAlerts = (options = {}) => {\r\n  const { priority = 'all', unreadOnly = false } = options;\r\n\r\n  const queryKey = useMemo(() => {\r\n    return ['alerts', { priority, unreadOnly }];\r\n  }, [priority, unreadOnly]);\r\n\r\n  return useQuery({\r\n    queryKey,\r\n    queryFn: async () => {\r\n      console.log('🔍 Fetching alerts...');\r\n      const params = new URLSearchParams();\r\n      \r\n      if (priority !== 'all') params.append('priority', priority);\r\n      if (unreadOnly) params.append('unread_only', 'true');\r\n      \r\n      const url = `/api/alerts${params.toString() ? `?${params.toString()}` : ''}`;\r\n      return fetchWithTimeout(url);\r\n    },\r\n    staleTime: API_CONFIG.fallbackRefreshInterval,\r\n    cacheTime: API_CONFIG.cacheTime,\r\n    refetchInterval: API_CONFIG.refetchInterval,\r\n    refetchOnWindowFocus: false,\r\n    notifyOnChangeProps: ['data', 'error', 'isLoading'],\r\n    retry: (failureCount, error) => {\r\n      if (error.message.includes('HTTP 4')) return false;\r\n      return failureCount < API_CONFIG.retries;\r\n    },\r\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 15000),\r\n    onError: (error) => {\r\n      console.error('❌ Alerts fetch error:', error.message);\r\n    },\r\n    onSuccess: (data) => {\r\n      console.log('✅ Alerts loaded:', data?.data?.length || 0, 'items');\r\n    }\r\n  });\r\n};\r\n\r\n// Performance monitoring hook to track hook usage\r\nexport const useHookPerformanceMonitor = () => {\r\n  const [metrics, setMetrics] = useState({\r\n    activeQueries: 0,\r\n    cacheHits: 0,\r\n    cacheMisses: 0,\r\n    errorRate: 0,\r\n    averageResponseTime: 0\r\n  });\r\n\r\n  const queryClient = useQueryClient();\r\n\r\n  useEffect(() => {\r\n    const updateMetrics = () => {\r\n      const cache = queryClient.getQueryCache();\r\n      const queries = cache.getAll();\r\n      \r\n      const activeQueries = queries.filter(q => q.state.isFetching).length;\r\n      const successfulQueries = queries.filter(q => q.state.status === 'success').length;\r\n      const errorQueries = queries.filter(q => q.state.status === 'error').length;\r\n      const totalQueries = queries.length;\r\n\r\n      setMetrics({\r\n        activeQueries,\r\n        cacheHits: successfulQueries,\r\n        cacheMisses: errorQueries,\r\n        errorRate: totalQueries > 0 ? (errorQueries / totalQueries) * 100 : 0,\r\n        averageResponseTime: 0 // Would need more detailed tracking\r\n      });\r\n    };\r\n\r\n    updateMetrics();\r\n    const interval = setInterval(updateMetrics, 10000); // Update every 10 seconds\r\n\r\n    return () => clearInterval(interval);\r\n  }, [queryClient]);\r\n\r\n  return metrics;\r\n};\r\n\r\n// Optimized price lists hook with better conditional fetching\r\nexport const usePriceLists = (supplierId?: string, options = {}) => {\r\n  const { includeInactive = false, categoryFilter = null } = options;\r\n\r\n  const queryKey = useMemo(() => {\r\n    return ['price-lists', supplierId, { includeInactive, categoryFilter }];\r\n  }, [supplierId, includeInactive, categoryFilter]);\r\n\r\n  return useQuery({\r\n    queryKey,\r\n    queryFn: async () => {\r\n      const url = supplierId\r\n        ? `/api/suppliers/${supplierId}/pricelists`\r\n        : '/api/pricelists';\r\n\r\n      const params = new URLSearchParams();\r\n      if (includeInactive) params.append('include_inactive', 'true');\r\n      if (categoryFilter) params.append('category', categoryFilter);\r\n\r\n      const finalUrl = `${url}${params.toString() ? `?${params.toString()}` : ''}`;\r\n      console.log('🔍 Fetching price lists from:', finalUrl);\r\n      return fetchWithTimeout(finalUrl);\r\n    },\r\n    enabled: !!supplierId, // Only fetch if supplierId is provided\r\n    staleTime: 5 * 60 * 1000, // 5 minutes\r\n    cacheTime: API_CONFIG.cacheTime,\r\n    keepPreviousData: true,\r\n    notifyOnChangeProps: ['data', 'error', 'isLoading'],\r\n    retry: (failureCount, error) => {\r\n      if (error.message.includes('HTTP 4')) return false;\r\n      return failureCount < API_CONFIG.retries;\r\n    },\r\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 15000),\r\n    onError: (error) => {\r\n      console.error('❌ Price lists fetch error:', error.message);\r\n    }\r\n  });\r\n};\r\n\r\n// Global cleanup function for memory management\r\nexport const useGlobalCleanup = () => {\r\n  const queryClient = useQueryClient();\r\n\r\n  useEffect(() => {\r\n    const cleanup = () => {\r\n      // Clear old cache entries\r\n      queryClient.getQueryCache().clear();\r\n      \r\n      // Clear request deduplication cache\r\n      requestCache.clear();\r\n      \r\n      console.log('🧹 Performed global cache cleanup');\r\n    };\r\n\r\n    // Cleanup every 30 minutes\r\n    const interval = setInterval(cleanup, 30 * 60 * 1000);\r\n\r\n    // Cleanup on page unload\r\n    const handleBeforeUnload = () => {\r\n      cleanup();\r\n    };\r\n\r\n    window.addEventListener('beforeunload', handleBeforeUnload);\r\n\r\n    return () => {\r\n      clearInterval(interval);\r\n      window.removeEventListener('beforeunload', handleBeforeUnload);\r\n    };\r\n  }, [queryClient]);\r\n};\r\n\r\n// Optimized supplier mutations with better state management and error recovery\r\nexport const useSupplierMutations = () => {\r\n  const queryClient = useQueryClient();\r\n\r\n  const createSupplier = useMutation({\r\n    mutationFn: async (supplierData: any) => {\r\n      console.log('📤 Creating supplier...');\r\n      return fetchWithTimeout('/api/suppliers', {\r\n        method: 'POST',\r\n        body: JSON.stringify(supplierData),\r\n      });\r\n    },\r\n    onMutate: async (supplierData) => {\r\n      // Optimistic creation\r\n      const tempId = `temp-${Date.now()}`;\r\n      const optimisticSupplier = { ...supplierData, id: tempId, status: 'creating' };\r\n\r\n      // Cancel outgoing refetches\r\n      await queryClient.cancelQueries(['suppliers']);\r\n\r\n      // Snapshot previous value\r\n      const previousSuppliers = queryClient.getQueryData(['suppliers']);\r\n\r\n      // Optimistically add new supplier\r\n      queryClient.setQueryData(['suppliers'], (old: any) => ({\r\n        ...old,\r\n        data: [optimisticSupplier, ...(old?.data || [])]\r\n      }));\r\n\r\n      return { previousSuppliers, tempId };\r\n    },\r\n    onSuccess: (data, variables, context) => {\r\n      console.log('✅ Supplier created successfully');\r\n\r\n      // Replace optimistic supplier with real data\r\n      queryClient.setQueryData(['suppliers'], (old: any) => ({\r\n        ...old,\r\n        data: old?.data?.map((supplier: any) =>\r\n          supplier.id === context.tempId ? data.data : supplier\r\n        ) || [data.data]\r\n      }));\r\n\r\n      // Update individual supplier cache\r\n      queryClient.setQueryData(['supplier', data.data.id], data.data);\r\n\r\n      // Invalidate related queries\r\n      queryClient.invalidateQueries({ queryKey: ['dashboard-metrics'] });\r\n    },\r\n    onError: (error, variables, context) => {\r\n      console.error('❌ Supplier creation failed:', error.message);\r\n      // Rollback optimistic update\r\n      queryClient.setQueryData(['suppliers'], context?.previousSuppliers);\r\n    }\r\n  });\r\n\r\n  const updateSupplier = useMutation({\r\n    mutationFn: async ({ id, data: supplierData }: { id: string, data: any }) => {\r\n      console.log('📤 Updating supplier:', id);\r\n      return fetchWithTimeout(`/api/suppliers/${id}`, {\r\n        method: 'PUT',\r\n        body: JSON.stringify(supplierData),\r\n      });\r\n    },\r\n    onMutate: async ({ id, data: newData }) => {\r\n      // Cancel outgoing refetches\r\n      await queryClient.cancelQueries(['suppliers']);\r\n      await queryClient.cancelQueries(['supplier', id]);\r\n\r\n      // Snapshot previous values\r\n      const previousSuppliers = queryClient.getQueryData(['suppliers']);\r\n      const previousSupplier = queryClient.getQueryData(['supplier', id]);\r\n\r\n      // Optimistically update list\r\n      queryClient.setQueryData(['suppliers'], (old: any) => ({\r\n        ...old,\r\n        data: old?.data?.map((supplier: any) =>\r\n          supplier.id === id ? { ...supplier, ...newData, status: 'updating' } : supplier\r\n        ) || []\r\n      }));\r\n\r\n      // Optimistically update individual supplier\r\n      queryClient.setQueryData(['supplier', id], (old: any) => ({\r\n        ...old,\r\n        ...newData,\r\n        status: 'updating'\r\n      }));\r\n\r\n      return { previousSuppliers, previousSupplier };\r\n    },\r\n    onSuccess: (data, { id }) => {\r\n      console.log('✅ Supplier updated successfully');\r\n\r\n      // Update with real server data\r\n      queryClient.setQueryData(['suppliers'], (old: any) => ({\r\n        ...old,\r\n        data: old?.data?.map((supplier: any) =>\r\n          supplier.id === id ? data.data : supplier\r\n        ) || []\r\n      }));\r\n\r\n      queryClient.setQueryData(['supplier', id], data.data);\r\n    },\r\n    onError: (err, { id }, context) => {\r\n      console.error('❌ Supplier update failed:', err.message);\r\n      // Rollback optimistic updates\r\n      queryClient.setQueryData(['suppliers'], context?.previousSuppliers);\r\n      queryClient.setQueryData(['supplier', id], context?.previousSupplier);\r\n    },\r\n    onSettled: (data, error, { id }) => {\r\n      // Always refetch after error or success to ensure data consistency\r\n      queryClient.invalidateQueries({ queryKey: ['suppliers'] });\r\n      queryClient.invalidateQueries({ queryKey: ['supplier', id] });\r\n    },\r\n  });\r\n\r\n  const deleteSupplier = useMutation({\r\n    mutationFn: async (id: string) => {\r\n      console.log('📤 Deleting supplier:', id);\r\n      return fetchWithTimeout(`/api/suppliers/${id}`, {\r\n        method: 'DELETE',\r\n      });\r\n    },\r\n    onMutate: async (id) => {\r\n      // Cancel outgoing refetches\r\n      await queryClient.cancelQueries(['suppliers']);\r\n\r\n      // Snapshot previous value\r\n      const previousSuppliers = queryClient.getQueryData(['suppliers']);\r\n\r\n      // Optimistically remove supplier\r\n      queryClient.setQueryData(['suppliers'], (old: any) => ({\r\n        ...old,\r\n        data: old?.data?.filter((supplier: any) => supplier.id !== id) || []\r\n      }));\r\n\r\n      return { previousSuppliers };\r\n    },\r\n    onSuccess: (data, id) => {\r\n      console.log('✅ Supplier deleted successfully');\r\n      // Remove from individual cache\r\n      queryClient.removeQueries({ queryKey: ['supplier', id] });\r\n      queryClient.invalidateQueries({ queryKey: ['dashboard-metrics'] });\r\n    },\r\n    onError: (error, id, context) => {\r\n      console.error('❌ Supplier deletion failed:', error.message);\r\n      // Rollback optimistic deletion\r\n      queryClient.setQueryData(['suppliers'], context?.previousSuppliers);\r\n    }\r\n  });\r\n\r\n  return { createSupplier, updateSupplier, deleteSupplier };\r\n};\r\n\r\n// Optimized infinite scroll with better performance and caching\r\nexport const useInfiniteSuppliers = (filters: SupplierFilters = {}) => {\r\n  const queryKey = useMemo<QueryKey>(() => {\r\n    const sortedFilters = Object.keys(filters)\r\n      .sort()\r\n      .reduce<Record<string, SupplierFilterValue>>((sorted, key) => {\r\n        sorted[key] = filters[key];\r\n        return sorted;\r\n      }, {});\r\n    return ['suppliers-infinite', sortedFilters];\r\n  }, [filters]);\r\n\r\n  return useInfiniteQuery<SupplierListResponse, Error>({\r\n    queryKey,\r\n    queryFn: async ({ pageParam = 1 }) => {\r\n      const params = new URLSearchParams({\r\n        page: pageParam.toString(),\r\n        limit: '25', // Increased page size for better performance\r\n        ...Object.fromEntries(\r\n          Object.entries(filters).map(([key, value]) => [\r\n            key,\r\n            Array.isArray(value)\r\n              ? value.join(',')\r\n              : value === undefined || value === null\r\n                ? ''\r\n                : String(value)\r\n          ])\r\n        )\r\n      });\r\n\r\n      const url = `/api/suppliers?${params.toString()}`;\r\n      console.log('🔍 Fetching infinite suppliers page', pageParam);\r\n\r\n      return fetchWithTimeout<SupplierListResponse>(url);\r\n    },\r\n    getNextPageParam: (lastPage) =>\r\n      lastPage.pagination?.hasNext ? lastPage.pagination.page + 1 : undefined,\r\n    staleTime: 5 * 60 * 1000, // 5 minutes\r\n    cacheTime: API_CONFIG.cacheTime,\r\n    notifyOnChangeProps: ['data', 'error', 'isLoading', 'hasNextPage'],\r\n    retry: (failureCount, error) => {\r\n      if (error instanceof Error && error.message.includes('HTTP 4')) {\r\n        return false;\r\n      }\r\n      return failureCount < API_CONFIG.retries;\r\n    },\r\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 15000),\r\n    onError: (error) => {\r\n      console.error(\r\n        '❌ Infinite suppliers fetch error:',\r\n        error instanceof Error ? error.message : String(error)\r\n      );\r\n    }\r\n  });\r\n};\r\n\r\n// Export all optimized hooks with performance monitoring\r\nexport default {\r\n  useRealTimeSuppliers,\r\n  useRealTimeInventory,\r\n  useRealTimeDashboard,\r\n  useAlerts,\r\n  usePriceLists,\r\n  useSupplierMutations,\r\n  useInfiniteSuppliers,\r\n  useHookPerformanceMonitor,\r\n  useGlobalCleanup,\r\n  API_CONFIG // Export config for reference\r\n};","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\hooks\\useSupplierDiscovery.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * Enhanced React Hook for Supplier Discovery with Web Integration\r\n */\r\n\r\nimport { useState, useCallback } from 'react';\r\nimport { DiscoveredSupplierData } from '@/lib/supplier-discovery/types';\r\nimport { supplierIntelligenceService, WebDiscoveryResult } from '@/services/ai/SupplierIntelligenceService';\r\n\r\ninterface UseSupplierDiscoveryState {\r\n  isLoading: boolean;\r\n  data: DiscoveredSupplierData | null;\r\n  error: string | null;\r\n  processingTime: number;\r\n  sourcesUsed: string[];\r\n  confidence: number;\r\n  webResults: WebDiscoveryResult | null;\r\n  searchType: 'traditional' | 'web-query' | 'web-website' | null;\r\n}\r\n\r\ninterface DiscoveryRequest {\r\n  supplierName: string;\r\n  additionalContext?: {\r\n    industry?: string;\r\n    region?: string;\r\n    website?: string;\r\n  };\r\n}\r\n\r\ninterface WebDiscoveryRequest {\r\n  query?: string;\r\n  url?: string;\r\n  searchType: 'query' | 'website';\r\n}\r\n\r\ninterface DiscoveryResponse {\r\n  success: boolean;\r\n  data?: DiscoveredSupplierData;\r\n  error?: string;\r\n  metadata?: {\r\n    processingTime: number;\r\n    sourcesUsed: string[];\r\n    confidence: number;\r\n  };\r\n}\r\n\r\nexport function useSupplierDiscovery() {\r\n  const [state, setState] = useState<UseSupplierDiscoveryState>({\r\n    isLoading: false,\r\n    data: null,\r\n    error: null,\r\n    processingTime: 0,\r\n    sourcesUsed: [],\r\n    confidence: 0,\r\n    webResults: null,\r\n    searchType: null\r\n  });\r\n\r\n  // Traditional supplier discovery (existing functionality)\r\n  const discoverSupplier = useCallback(async (request: DiscoveryRequest) => {\r\n    setState(prev => ({ ...prev, isLoading: true, error: null, searchType: 'traditional' }));\r\n\r\n    try {\r\n      const response = await fetch('/api/suppliers/discovery', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify(request)\r\n      });\r\n\r\n      const result: DiscoveryResponse = await response.json();\r\n\r\n      if (result.success && result.data) {\r\n        setState(prev => ({\r\n          ...prev,\r\n          isLoading: false,\r\n          data: result.data,\r\n          error: null,\r\n          processingTime: result.metadata?.processingTime || 0,\r\n          sourcesUsed: result.metadata?.sourcesUsed || [],\r\n          confidence: result.metadata?.confidence || 0\r\n        }));\r\n      } else {\r\n        setState(prev => ({\r\n          ...prev,\r\n          isLoading: false,\r\n          error: result.error || 'Failed to discover supplier information',\r\n          processingTime: result.metadata?.processingTime || 0,\r\n          sourcesUsed: result.metadata?.sourcesUsed || []\r\n        }));\r\n      }\r\n    } catch (error) {\r\n      console.error('Supplier discovery error:', error);\r\n      setState(prev => ({\r\n        ...prev,\r\n        isLoading: false,\r\n        error: error instanceof Error ? error.message : 'Network error occurred'\r\n      }));\r\n    }\r\n  }, []);\r\n\r\n  // Web-based supplier discovery (new functionality)\r\n  const discoverFromWeb = useCallback(async (request: WebDiscoveryRequest) => {\r\n    setState(prev => ({ ...prev, isLoading: true, error: null, searchType: request.searchType === 'query' ? 'web-query' : 'web-website' }));\r\n\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      let webResult: WebDiscoveryResult\r\n\r\n      if (request.searchType === 'website' && request.url) {\r\n        webResult = await supplierIntelligenceService.extractFromWebsite(request.url)\r\n      } else if (request.searchType === 'query' && request.query) {\r\n        webResult = await supplierIntelligenceService.discoverSuppliers(request.query)\r\n      } else {\r\n        throw new Error('Invalid web discovery request')\r\n      }\r\n\r\n      const processingTime = Date.now() - startTime\r\n\r\n      if (webResult.success) {\r\n        setState(prev => ({\r\n          ...prev,\r\n          isLoading: false,\r\n          webResults: webResult,\r\n          error: null,\r\n          processingTime,\r\n          sourcesUsed: webResult.metadata?.sources || [],\r\n          confidence: webResult.metadata?.confidence || 0\r\n        }))\r\n\r\n        return webResult\r\n      } else {\r\n        setState(prev => ({\r\n          ...prev,\r\n          isLoading: false,\r\n          error: webResult.error || 'Failed to discover supplier from web',\r\n          processingTime,\r\n          sourcesUsed: webResult.metadata?.sources || []\r\n        }))\r\n        return webResult\r\n      }\r\n    } catch (error) {\r\n      console.error('Web discovery error:', error)\r\n      const processingTime = Date.now() - startTime\r\n      setState(prev => ({\r\n        ...prev,\r\n        isLoading: false,\r\n        error: error instanceof Error ? error.message : 'Web discovery failed',\r\n        processingTime\r\n      }))\r\n      return {\r\n        success: false,\r\n        data: [],\r\n        error: error instanceof Error ? error.message : 'Web discovery failed',\r\n        metadata: {\r\n          searchType: request.searchType,\r\n          totalResults: 0,\r\n          confidence: 0,\r\n          sources: []\r\n        }\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  // Transform web discovery results to form data\r\n  const transformWebResultsToFormData = useCallback((webResult: WebDiscoveryResult) => {\r\n    if (!webResult.success || !webResult.data || webResult.data.length === 0) {\r\n      return null\r\n    }\r\n\r\n    // Take the first result (highest confidence)\r\n    const firstResult = webResult.data[0]\r\n    return supplierIntelligenceService.transformToFormData(firstResult)\r\n  }, [])\r\n\r\n  const refreshSupplier = useCallback(async (request: DiscoveryRequest) => {\r\n    setState(prev => ({ ...prev, isLoading: true, error: null }));\r\n\r\n    try {\r\n      const response = await fetch('/api/suppliers/discovery', {\r\n        method: 'PATCH',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify(request)\r\n      });\r\n\r\n      const result: DiscoveryResponse = await response.json();\r\n\r\n      if (result.success && result.data) {\r\n        setState(prev => ({\r\n          ...prev,\r\n          isLoading: false,\r\n          data: result.data,\r\n          error: null,\r\n          processingTime: result.metadata?.processingTime || 0,\r\n          sourcesUsed: result.metadata?.sourcesUsed || [],\r\n          confidence: result.metadata?.confidence || 0\r\n        }));\r\n      } else {\r\n        setState(prev => ({\r\n          ...prev,\r\n          isLoading: false,\r\n          error: result.error || 'Failed to refresh supplier information'\r\n        }));\r\n      }\r\n    } catch (error) {\r\n      console.error('Supplier refresh error:', error);\r\n      setState(prev => ({\r\n        ...prev,\r\n        isLoading: false,\r\n        error: error instanceof Error ? error.message : 'Network error occurred'\r\n      }));\r\n    }\r\n  }, []);\r\n\r\n  const clearState = useCallback(() => {\r\n    setState({\r\n      isLoading: false,\r\n      data: null,\r\n      error: null,\r\n      processingTime: 0,\r\n      sourcesUsed: [],\r\n      confidence: 0,\r\n      webResults: null,\r\n      searchType: null\r\n    });\r\n  }, []);\r\n\r\n  // Utility function to validate web results\r\n  const validateWebResults = useCallback((webResult: WebDiscoveryResult) => {\r\n    if (!webResult.success || !webResult.data || webResult.data.length === 0) {\r\n      return { isValid: false, issues: ['No valid data found'] }\r\n    }\r\n\r\n    const issues: string[] = []\r\n    let validCount = 0\r\n\r\n    webResult.data.forEach((data, index) => {\r\n      const validation = supplierIntelligenceService.validateExtractedData(data)\r\n      if (validation.isValid) {\r\n        validCount++\r\n      } else {\r\n        issues.push(`Result ${index + 1}: ${validation.issues.join(', ')}`)\r\n      }\r\n    })\r\n\r\n    return {\r\n      isValid: validCount > 0,\r\n      issues,\r\n      validCount,\r\n      totalCount: webResult.data.length\r\n    }\r\n  }, [])\r\n\r\n  return {\r\n    ...state,\r\n    discoverSupplier,\r\n    discoverFromWeb,\r\n    transformWebResultsToFormData,\r\n    refreshSupplier,\r\n    clearState,\r\n    validateWebResults\r\n  };\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\hooks\\useSuppliers.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\nimport { useState, useEffect, useCallback } from 'react'\r\nimport type { Supplier, SupplierSearchFilters, DashboardMetrics } from '@/types/supplier'\r\n\r\n// Simple interface that matches our actual API response\r\ninterface DatabaseSupplier {\r\n  id: string\r\n  name: string\r\n  supplier_code?: string\r\n  company_name?: string\r\n  status: string\r\n  performance_tier: string\r\n  primary_category?: string\r\n  website?: string\r\n  email?: string\r\n  phone?: string\r\n  contact_person?: string\r\n  address?: string\r\n  tax_id?: string\r\n  payment_terms?: string\r\n  preferred_supplier: boolean\r\n  spend_last_12_months: string\r\n  rating: string\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\ninterface UseSupplierOptions {\r\n  filters?: SupplierSearchFilters\r\n  autoFetch?: boolean\r\n}\r\n\r\ninterface APIResponse<T> {\r\n  success: boolean\r\n  data: T\r\n  error?: string\r\n  message?: string\r\n  count?: number\r\n  pagination?: {\r\n    page: number\r\n    limit: number\r\n    total: number\r\n    totalPages: number\r\n    hasNext: boolean\r\n    hasPrev: boolean\r\n  }\r\n}\r\n\r\nexport function useSuppliers(options: UseSupplierOptions = {}) {\r\n  const { filters, autoFetch = true } = options\r\n\r\n  const [suppliers, setSuppliers] = useState<DatabaseSupplier[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  const fetchSuppliers = useCallback(async (searchFilters?: SupplierSearchFilters) => {\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const params = new URLSearchParams()\r\n      const filtersToUse = searchFilters || filters\r\n\r\n      if (filtersToUse?.query) params.append('search', filtersToUse.query)\r\n      if (filtersToUse?.status) params.append('status', filtersToUse.status.join(','))\r\n      if (filtersToUse?.tier) params.append('performance_tier', filtersToUse.tier.join(','))\r\n      if (filtersToUse?.category) params.append('category', filtersToUse.category.join(','))\r\n      if (filtersToUse?.location) params.append('region', filtersToUse.location.join(','))\r\n      if (filtersToUse?.hasActiveContracts !== undefined) {\r\n        params.append('preferred_only', filtersToUse.hasActiveContracts.toString())\r\n      }\r\n\r\n      const url = `/api/suppliers?${params.toString()}`\r\n\r\n      const response = await fetch(url)\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      const result: APIResponse<DatabaseSupplier[]> = await response.json()\r\n\r\n      if (result.success) {\r\n        setSuppliers(result.data)\r\n      } else {\r\n        throw new Error(result.error || 'Failed to fetch suppliers')\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Failed to fetch suppliers'\r\n      setError(errorMessage)\r\n      console.error('Error fetching suppliers:', err)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [filters])\r\n\r\n  const createSupplier = useCallback(async (supplierData: any) => {\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch('/api/suppliers', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(supplierData),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      const result: APIResponse<Supplier> = await response.json()\r\n\r\n      if (result.success) {\r\n        setSuppliers(prev => [result.data, ...prev])\r\n        return result.data\r\n      } else {\r\n        throw new Error(result.error || 'Failed to create supplier')\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Failed to create supplier'\r\n      setError(errorMessage)\r\n      console.error('Error creating supplier:', err)\r\n      throw err\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  const updateSupplier = useCallback(async (id: string, supplierData: Partial<any>) => {\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch(`/api/suppliers/${id}`, {\r\n        method: 'PUT',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(supplierData),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      const result: APIResponse<Supplier> = await response.json()\r\n\r\n      if (result.success) {\r\n        setSuppliers(prev => prev.map(supplier =>\r\n          supplier.id === id ? result.data : supplier\r\n        ))\r\n        return result.data\r\n      } else {\r\n        throw new Error(result.error || 'Failed to update supplier')\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Failed to update supplier'\r\n      setError(errorMessage)\r\n      console.error('Error updating supplier:', err)\r\n      throw err\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  const deleteSupplier = useCallback(async (id: string) => {\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch(`/api/suppliers/${id}`, {\r\n        method: 'DELETE',\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      const result: APIResponse<void> = await response.json()\r\n\r\n      if (result.success) {\r\n        // Immediately remove from local state\r\n        setSuppliers(prev => prev.filter(supplier => supplier.id !== id))\r\n        console.log('✅ Supplier removed from local state:', id)\r\n        return true\r\n      } else {\r\n        throw new Error(result.error || 'Failed to delete supplier')\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Failed to delete supplier'\r\n      setError(errorMessage)\r\n      console.error('Error deleting supplier:', err)\r\n      throw err\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  // Auto-fetch on mount and when filters change\r\n  useEffect(() => {\r\n    if (autoFetch) {\r\n      fetchSuppliers()\r\n    }\r\n  }, [fetchSuppliers, autoFetch])\r\n\r\n  return {\r\n    suppliers,\r\n    loading,\r\n    error,\r\n    fetchSuppliers,\r\n    createSupplier,\r\n    updateSupplier,\r\n    deleteSupplier,\r\n    refresh: () => fetchSuppliers(),\r\n  }\r\n}\r\n\r\nexport function useDashboardMetrics() {\r\n  const [metrics, setMetrics] = useState<DashboardMetrics | null>(null)\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  const fetchMetrics = useCallback(async () => {\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch('/api/suppliers/metrics')\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      const result: APIResponse<DashboardMetrics> = await response.json()\r\n\r\n      if (result.success) {\r\n        setMetrics(result.data)\r\n      } else {\r\n        throw new Error(result.error || 'Failed to fetch metrics')\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Failed to fetch metrics'\r\n      setError(errorMessage)\r\n      console.error('Error fetching metrics:', err)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    fetchMetrics()\r\n  }, [fetchMetrics])\r\n\r\n  return {\r\n    metrics,\r\n    loading,\r\n    error,\r\n    refresh: fetchMetrics,\r\n  }\r\n}\r\n\r\n// Hook for individual supplier\r\nexport function useSupplier(id: string | null) {\r\n  const [supplier, setSupplier] = useState<Supplier | null>(null)\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  const fetchSupplier = useCallback(async () => {\r\n    if (!id) return\r\n\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch(`/api/suppliers/${id}`)\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`)\r\n      }\r\n\r\n      const result: APIResponse<Supplier> = await response.json()\r\n\r\n      if (result.success) {\r\n        setSupplier(result.data)\r\n      } else {\r\n        throw new Error(result.error || 'Failed to fetch supplier')\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = err instanceof Error ? err.message : 'Failed to fetch supplier'\r\n      setError(errorMessage)\r\n      console.error('Error fetching supplier:', err)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }, [id])\r\n\r\n  useEffect(() => {\r\n    fetchSupplier()\r\n  }, [fetchSupplier])\r\n\r\n  return {\r\n    supplier,\r\n    loading,\r\n    error,\r\n    refresh: fetchSupplier,\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\config.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\nimport {\r\n  AIConfig,\r\n  AIProvider,\r\n  AIProviderConfig,\r\n  AIProviderId,\r\n  AIAnalyticsConfig,\r\n  AIMonitoringConfig,\r\n  AIProviderCredentials,\r\n  AIProviderModels,\r\n  AIProviderLimits,\r\n} from '@/types/ai';\r\nimport { z } from 'zod';\r\nimport { resolveSecret, clearSecretCache } from './secrets';\r\n\r\nconst PROVIDERS: AIProviderId[] = ['openai', 'anthropic', 'vercel', 'openai-compatible'];\r\n\r\nconst DEFAULT_MODELS: Record<AIProviderId, AIProviderModels> = {\r\n  openai: {\r\n    default: 'gpt-4.1-mini',\r\n    chat: 'gpt-4.1-mini',\r\n    streaming: 'gpt-4.1-mini',\r\n    embedding: 'text-embedding-3-large',\r\n    fallback: ['anthropic', 'vercel'],\r\n  },\r\n  anthropic: {\r\n    default: 'claude-3-5-sonnet-latest',\r\n    chat: 'claude-3-5-sonnet-latest',\r\n    streaming: 'claude-3-5-haiku-latest',\r\n    fallback: ['openai', 'vercel'],\r\n  },\r\n  vercel: {\r\n    default: 'gpt-4.1-mini',\r\n    chat: 'gpt-4.1-mini',\r\n    streaming: 'gpt-4.1-mini',\r\n    embedding: 'text-embedding-3-small',\r\n    fallback: ['openai', 'anthropic'],\r\n  },\r\n  'openai-compatible': {\r\n    default: 'gpt-4.1-mini',\r\n    chat: 'gpt-4.1-mini',\r\n    streaming: 'gpt-4.1-mini',\r\n    embedding: 'text-embedding-ada-002',\r\n    fallback: ['openai', 'vercel'],\r\n  },\r\n};\r\n\r\nconst DEFAULT_LIMITS: Record<AIProviderId, AIProviderLimits> = {\r\n  openai: { maxTokens: 8192, maxRequestsPerMinute: 500, concurrency: 8 },\r\n  anthropic: { maxTokens: 4000, maxRequestsPerMinute: 200, concurrency: 4 },\r\n  vercel: { maxTokens: 4000, maxRequestsPerMinute: 450, concurrency: 6 },\r\n  'openai-compatible': { maxTokens: 4000, maxRequestsPerMinute: 120, concurrency: 4 },\r\n};\r\n\r\nconst ProviderIdSchema = z.enum(['openai', 'anthropic', 'vercel', 'openai-compatible']);\r\n\r\nconst ProviderCredentialsSchema = z.object({\r\n  apiKey: z.string().min(1).optional(),\r\n  baseUrl: z.string().min(1).optional(),\r\n  organization: z.string().min(1).optional(),\r\n  project: z.string().min(1).optional(),\r\n  authToken: z.string().min(1).optional(),\r\n});\r\n\r\nconst ProviderModelsSchema = z.object({\r\n  default: z.string().min(1),\r\n  chat: z.string().min(1).optional(),\r\n  embedding: z.string().min(1).optional(),\r\n  streaming: z.string().min(1).optional(),\r\n  fallback: z.array(ProviderIdSchema).optional(),\r\n});\r\n\r\nconst ProviderLimitsSchema = z.object({\r\n  maxTokens: z.number().int().positive().optional(),\r\n  maxRequestsPerMinute: z.number().int().nonnegative().optional(),\r\n  concurrency: z.number().int().positive().optional(),\r\n});\r\n\r\nconst ProviderConfigSchema = z\r\n  .object({\r\n    id: ProviderIdSchema,\r\n    label: z.string().min(1),\r\n    enabled: z.boolean(),\r\n    failoverPriority: z.number().int().nonnegative(),\r\n    credentials: ProviderCredentialsSchema,\r\n    models: ProviderModelsSchema,\r\n    limits: ProviderLimitsSchema,\r\n    requestTimeoutMs: z.number().int().positive().optional(),\r\n    maxRetries: z.number().int().nonnegative().optional(),\r\n    compatibility: z.enum(['strict', 'compatible']).optional(),\r\n    metadata: z.record(z.string(), z.any()).optional(),\r\n  })\r\n  .superRefine((value, ctx) => {\r\n    if (value.enabled) {\r\n      switch (value.id) {\r\n        case 'openai':\r\n        case 'anthropic':\r\n          if (!value.credentials.apiKey) {\r\n            ctx.addIssue({\r\n              code: z.ZodIssueCode.custom,\r\n              path: ['credentials', 'apiKey'],\r\n              message: `${value.id} provider requires an API key.`,\r\n            });\r\n          }\r\n          break;\r\n        case 'vercel':\r\n          if (!(value.credentials.authToken || value.credentials.apiKey)) {\r\n            ctx.addIssue({\r\n              code: z.ZodIssueCode.custom,\r\n              path: ['credentials', 'authToken'],\r\n              message: 'Vercel gateway requires an auth token or API key.',\r\n            });\r\n          }\r\n          if (!value.credentials.baseUrl) {\r\n            ctx.addIssue({\r\n              code: z.ZodIssueCode.custom,\r\n              path: ['credentials', 'baseUrl'],\r\n              message: 'Vercel gateway requires a base URL.',\r\n            });\r\n          }\r\n          break;\r\n        case 'openai-compatible':\r\n          if (!value.credentials.apiKey) {\r\n            ctx.addIssue({\r\n              code: z.ZodIssueCode.custom,\r\n              path: ['credentials', 'apiKey'],\r\n              message: 'OpenAI compatible provider requires an API key.',\r\n            });\r\n          }\r\n          if (!value.credentials.baseUrl) {\r\n            ctx.addIssue({\r\n              code: z.ZodIssueCode.custom,\r\n              path: ['credentials', 'baseUrl'],\r\n              message: 'OpenAI compatible provider requires a base URL.',\r\n            });\r\n          }\r\n          break;\r\n      }\r\n    }\r\n\r\n    if (value.id === 'anthropic' && value.models.embedding) {\r\n      ctx.addIssue({\r\n        code: z.ZodIssueCode.custom,\r\n        path: ['models', 'embedding'],\r\n        message:\r\n          'Anthropic provider does not support embeddings; remove the embedding model configuration.',\r\n      });\r\n    }\r\n  });\r\n\r\nconst AnalyticsConfigSchema = z.object({\r\n  enabled: z.boolean(),\r\n  sampleRate: z.number().min(0),\r\n  eventName: z.string().min(1),\r\n});\r\n\r\nconst MonitoringConfigSchema = z.object({\r\n  enabled: z.boolean(),\r\n  healthCheckIntervalMs: z.number().int().positive(),\r\n  unhealthyThreshold: z.number().int().positive(),\r\n  recoveryWindowMs: z.number().int().nonnegative(),\r\n  trackLatency: z.boolean(),\r\n});\r\n\r\nconst ProvidersSchema = z.object({\r\n  openai: ProviderConfigSchema,\r\n  anthropic: ProviderConfigSchema,\r\n  vercel: ProviderConfigSchema,\r\n  'openai-compatible': ProviderConfigSchema,\r\n});\r\n\r\nconst AI_CONFIG_SCHEMA = z\r\n  .object({\r\n    defaultProvider: ProviderIdSchema,\r\n    enableFeatures: z.boolean(),\r\n    enableStreaming: z.boolean(),\r\n    enableFallback: z.boolean(),\r\n    maxTokens: z.number().int().positive(),\r\n    temperature: z.number().min(0),\r\n    requestTimeoutMs: z.number().int().positive(),\r\n    fallbackOrder: z.array(ProviderIdSchema).nonempty(),\r\n    providers: ProvidersSchema,\r\n    analytics: AnalyticsConfigSchema,\r\n    monitoring: MonitoringConfigSchema,\r\n    openaiApiKey: z.string().optional(),\r\n    anthropicApiKey: z.string().optional(),\r\n    vercelAIGatewayUrl: z.string().optional(),\r\n    vercelAIGatewayToken: z.string().optional(),\r\n    openaiCompatibleBaseUrl: z.string().optional(),\r\n    openaiCompatibleApiKey: z.string().optional(),\r\n  })\r\n  .superRefine((value, ctx) => {\r\n    const expectedProviders = Object.keys(value.providers);\r\n    for (const providerId of expectedProviders) {\r\n      if (!value.fallbackOrder.includes(providerId as AIProviderId)) {\r\n        ctx.addIssue({\r\n          code: z.ZodIssueCode.custom,\r\n          path: ['fallbackOrder'],\r\n          message: `Fallback order is missing provider ${providerId}.`,\r\n        });\r\n        break;\r\n      }\r\n    }\r\n  });\r\n\r\nlet cachedConfig: AIConfig | null = null;\r\nconst listeners = new Set<(config: AIConfig) => void>();\r\n\r\nconst parseBoolean = (value: string | undefined, fallback: boolean): boolean => {\r\n  if (value == null) return fallback;\r\n  const normalized = value.trim().toLowerCase();\r\n  return normalized === 'true' || normalized === '1' || normalized === 'yes';\r\n};\r\n\r\nconst parseNumber = (value: string | undefined, fallback: number): number => {\r\n  if (value == null) return fallback;\r\n  const parsed = Number(value);\r\n  return Number.isFinite(parsed) ? parsed : fallback;\r\n};\r\n\r\nconst parseProviderList = (value: string | undefined): AIProviderId[] => {\r\n  if (!value) return [];\r\n  return value\r\n    .split(',')\r\n    .map(item => item.trim() as AIProviderId)\r\n    .filter((item): item is AIProviderId => PROVIDERS.includes(item));\r\n};\r\n\r\nconst mergeProviderModels = (\r\n  provider: AIProviderId,\r\n  overrides?: Partial<AIProviderModels>\r\n): AIProviderModels => ({\r\n  ...DEFAULT_MODELS[provider],\r\n  ...overrides,\r\n  fallback: overrides?.fallback ?? DEFAULT_MODELS[provider].fallback,\r\n});\r\n\r\nconst buildCredentials = (\r\n  provider: AIProviderId,\r\n  env: NodeJS.ProcessEnv\r\n): AIProviderCredentials => {\r\n  switch (provider) {\r\n    case 'openai':\r\n      return {\r\n        apiKey: resolveSecret(env, 'OPENAI_API_KEY'),\r\n        baseUrl: env.OPENAI_BASE_URL,\r\n        organization: env.OPENAI_ORGANIZATION,\r\n        project: env.OPENAI_PROJECT,\r\n      };\r\n    case 'anthropic':\r\n      return {\r\n        apiKey: resolveSecret(env, 'ANTHROPIC_API_KEY'),\r\n        baseUrl: env.ANTHROPIC_BASE_URL,\r\n      };\r\n    case 'vercel':\r\n      return {\r\n        authToken: resolveSecret(env, 'VERCEL_AI_GATEWAY_TOKEN'),\r\n        baseUrl: env.VERCEL_AI_GATEWAY_URL,\r\n      };\r\n    case 'openai-compatible':\r\n      return {\r\n        apiKey: resolveSecret(env, 'OPENAI_COMPATIBLE_API_KEY'),\r\n        baseUrl: env.OPENAI_COMPATIBLE_BASE_URL,\r\n        organization: env.OPENAI_COMPATIBLE_ORG,\r\n      };\r\n    default:\r\n      return {};\r\n  }\r\n};\r\n\r\nconst isProviderConfigured = (\r\n  provider: AIProviderId,\r\n  credentials: AIProviderCredentials\r\n): boolean => {\r\n  switch (provider) {\r\n    case 'openai':\r\n      return Boolean(credentials.apiKey);\r\n    case 'openai-compatible':\r\n      return Boolean(credentials.apiKey && credentials.baseUrl);\r\n    case 'anthropic':\r\n      return Boolean(credentials.apiKey);\r\n    case 'vercel':\r\n      return Boolean((credentials.authToken || credentials.apiKey) && credentials.baseUrl);\r\n    default:\r\n      return false;\r\n  }\r\n};\r\n\r\nconst getProviderEnvKey = (provider: AIProviderId, suffix: string): string => {\r\n  return 'AI_' + provider.toUpperCase().replace(/-/g, '_') + '_' + suffix;\r\n};\r\n\r\nconst buildProviderConfig = (provider: AIProviderId, env: NodeJS.ProcessEnv): AIProviderConfig => {\r\n  const credentials = buildCredentials(provider, env);\r\n  const enabled = isProviderConfigured(provider, credentials);\r\n\r\n  const fallbackKey = getProviderEnvKey(provider, 'FALLBACK');\r\n  const timeoutKey = getProviderEnvKey(provider, 'TIMEOUT_MS');\r\n  const retriesKey = getProviderEnvKey(provider, 'MAX_RETRIES');\r\n\r\n  const modelOverrides = parseProviderList(env[fallbackKey]);\r\n\r\n  // Optional model overrides via environment variables, e.g.:\r\n  // AI_OPENAI_COMPATIBLE_MODEL_DEFAULT, AI_OPENAI_COMPATIBLE_MODEL_CHAT,\r\n  // AI_OPENAI_COMPATIBLE_MODEL_EMBEDDING, AI_OPENAI_COMPATIBLE_MODEL_STREAMING\r\n  const modelDefaultKey = getProviderEnvKey(provider, 'MODEL_DEFAULT');\r\n  const modelChatKey = getProviderEnvKey(provider, 'MODEL_CHAT');\r\n  const modelEmbeddingKey = getProviderEnvKey(provider, 'MODEL_EMBEDDING');\r\n  const modelStreamingKey = getProviderEnvKey(provider, 'MODEL_STREAMING');\r\n\r\n  const modelDefault = env[modelDefaultKey];\r\n  const modelChat = env[modelChatKey];\r\n  const modelEmbedding = env[modelEmbeddingKey];\r\n  const modelStreaming = env[modelStreamingKey];\r\n\r\n  const modelsOverride: Partial<AIProviderModels> | undefined =\r\n    modelDefault || modelChat || modelEmbedding || modelStreaming\r\n      ? {\r\n          ...(modelDefault ? { default: modelDefault } : {}),\r\n          ...(modelChat ? { chat: modelChat } : {}),\r\n          ...(modelEmbedding ? { embedding: modelEmbedding } : {}),\r\n          ...(modelStreaming ? { streaming: modelStreaming } : {}),\r\n        }\r\n      : undefined;\r\n\r\n  return {\r\n    id: provider,\r\n    label: provider\r\n      .split('-')\r\n      .map(part => part.charAt(0).toUpperCase() + part.slice(1))\r\n      .join(' '),\r\n    enabled,\r\n    failoverPriority: Number.MAX_SAFE_INTEGER,\r\n    credentials,\r\n    models: mergeProviderModels(provider, {\r\n      ...(modelOverrides.length ? { fallback: modelOverrides } : {}),\r\n      ...(modelsOverride ?? {}),\r\n    }),\r\n    limits: { ...DEFAULT_LIMITS[provider] },\r\n    requestTimeoutMs: parseNumber(env[timeoutKey], parseNumber(env.AI_REQUEST_TIMEOUT, 30000)),\r\n    maxRetries: parseNumber(env[retriesKey], parseNumber(env.AI_MAX_RETRIES, 2)),\r\n    compatibility: provider === 'openai-compatible' ? 'compatible' : 'strict',\r\n    metadata: {},\r\n  };\r\n};\r\n\r\nconst buildAnalyticsConfig = (env: NodeJS.ProcessEnv): AIAnalyticsConfig => ({\r\n  enabled: parseBoolean(env.AI_ANALYTICS_ENABLED, true),\r\n  sampleRate: parseNumber(env.AI_ANALYTICS_SAMPLE_RATE, 1),\r\n  eventName: env.AI_ANALYTICS_EVENT_NAME ?? 'ai.usage',\r\n});\r\n\r\nconst buildMonitoringConfig = (env: NodeJS.ProcessEnv): AIMonitoringConfig => ({\r\n  enabled: parseBoolean(env.AI_MONITORING_ENABLED, true),\r\n  healthCheckIntervalMs: parseNumber(env.AI_HEALTHCHECK_INTERVAL_MS, 60000),\r\n  unhealthyThreshold: parseNumber(env.AI_UNHEALTHY_THRESHOLD, 3),\r\n  recoveryWindowMs: parseNumber(env.AI_RECOVERY_WINDOW_MS, 300000),\r\n  trackLatency: parseBoolean(env.AI_MONITOR_LATENCY, true),\r\n});\r\n\r\nconst applyFailoverPriority = (config: AIConfig): AIConfig => {\r\n  const order = config.fallbackOrder;\r\n  for (const provider of PROVIDERS) {\r\n    const index = order.indexOf(provider);\r\n    config.providers[provider].failoverPriority = index >= 0 ? index : Number.MAX_SAFE_INTEGER;\r\n  }\r\n  return config;\r\n};\r\n\r\nconst ensureFallbackOrder = (\r\n  defaultProvider: AIProviderId,\r\n  order: AIProviderId[]\r\n): AIProviderId[] => {\r\n  const prioritized = [defaultProvider, ...order];\r\n  const seen = new Set<AIProviderId>();\r\n  const result: AIProviderId[] = [];\r\n\r\n  for (const provider of prioritized) {\r\n    if (!PROVIDERS.includes(provider)) continue;\r\n    if (seen.has(provider)) continue;\r\n    seen.add(provider);\r\n    result.push(provider);\r\n  }\r\n\r\n  for (const provider of PROVIDERS) {\r\n    if (!seen.has(provider)) {\r\n      seen.add(provider);\r\n      result.push(provider);\r\n    }\r\n  }\r\n\r\n  return result;\r\n};\r\n\r\nconst deepMerge = <T>(base: T, updates: Partial<T>): T => {\r\n  if (!updates) return base;\r\n  const clone: any = Array.isArray(base) ? [...(base as any)] : { ...(base as any) };\r\n\r\n  for (const [key, value] of Object.entries(updates)) {\r\n    if (value === undefined) continue;\r\n    const current = (clone as any)[key];\r\n    if (\r\n      value &&\r\n      typeof value === 'object' &&\r\n      !Array.isArray(value) &&\r\n      current &&\r\n      typeof current === 'object' &&\r\n      !Array.isArray(current)\r\n    ) {\r\n      (clone as any)[key] = deepMerge(current, value);\r\n    } else {\r\n      (clone as any)[key] = value;\r\n    }\r\n  }\r\n\r\n  return clone;\r\n};\r\n\r\nconst emitConfigChange = (config: AIConfig) => {\r\n  for (const listener of listeners) {\r\n    try {\r\n      listener(config);\r\n    } catch (error) {\r\n      console.error('AI config listener failed', error);\r\n    }\r\n  }\r\n};\r\n\r\nconst createConfig = (overrides?: Partial<AIConfig>): AIConfig => {\r\n  const env = process.env as NodeJS.ProcessEnv;\r\n  const defaultProvider = (env.DEFAULT_AI_PROVIDER as AIProvider) || 'openai';\r\n  const fallbackOrder = ensureFallbackOrder(\r\n    defaultProvider,\r\n    parseProviderList(env.AI_FALLBACK_ORDER)\r\n  );\r\n\r\n  const providers = PROVIDERS.reduce<Record<AIProviderId, AIProviderConfig>>((acc, provider) => {\r\n    acc[provider] = buildProviderConfig(provider, env);\r\n    return acc;\r\n  }, {});\r\n\r\n  const base: AIConfig = {\r\n    defaultProvider,\r\n    enableFeatures: parseBoolean(env.ENABLE_AI_FEATURES, true),\r\n    enableStreaming: parseBoolean(env.ENABLE_AI_STREAMING, true),\r\n    enableFallback: parseBoolean(env.ENABLE_AI_FALLBACK, true),\r\n    maxTokens: parseNumber(env.AI_MAX_TOKENS, 8192),\r\n    temperature: parseNumber(env.AI_TEMPERATURE, 0.2),\r\n    requestTimeoutMs: parseNumber(env.AI_REQUEST_TIMEOUT, 30000),\r\n    fallbackOrder,\r\n    providers,\r\n    analytics: buildAnalyticsConfig(env),\r\n    monitoring: buildMonitoringConfig(env),\r\n    openaiApiKey: providers.openai.credentials.apiKey,\r\n    anthropicApiKey: providers.anthropic.credentials.apiKey,\r\n    vercelAIGatewayUrl: providers.vercel.credentials.baseUrl,\r\n    vercelAIGatewayToken: providers.vercel.credentials.authToken,\r\n    openaiCompatibleBaseUrl: providers['openai-compatible'].credentials.baseUrl,\r\n    openaiCompatibleApiKey: providers['openai-compatible'].credentials.apiKey,\r\n  };\r\n\r\n  const merged = overrides ? deepMerge(base, overrides) : base;\r\n  const prioritized = applyFailoverPriority(merged);\r\n  const validated = AI_CONFIG_SCHEMA.parse(prioritized) as AIConfig;\r\n  return validated;\r\n};\r\n\r\nexport const getAIConfig = (options?: { refresh?: boolean }): AIConfig => {\r\n  if (!cachedConfig || options?.refresh) {\r\n    cachedConfig = createConfig();\r\n    emitConfigChange(cachedConfig);\r\n  }\r\n  return cachedConfig;\r\n};\r\n\r\nexport const refreshAIConfig = (): AIConfig => {\r\n  cachedConfig = createConfig();\r\n  emitConfigChange(cachedConfig);\r\n  return cachedConfig;\r\n};\r\n\r\nexport const updateAIConfig = (partial: Partial<AIConfig>): AIConfig => {\r\n  const current = getAIConfig();\r\n  const merged = applyFailoverPriority(deepMerge(current, partial));\r\n  cachedConfig = AI_CONFIG_SCHEMA.parse(merged) as AIConfig;\r\n  emitConfigChange(cachedConfig);\r\n  return cachedConfig;\r\n};\r\n\r\nexport const resetAIConfigCache = (): void => {\r\n  cachedConfig = null;\r\n  clearSecretCache();\r\n};\r\n\r\nexport const onAIConfigChange = (listener: (config: AIConfig) => void): (() => void) => {\r\n  listeners.add(listener);\r\n  if (cachedConfig) {\r\n    listener(cachedConfig);\r\n  }\r\n  return () => listeners.delete(listener);\r\n};\r\n\r\nexport const isAIEnabled = (): boolean => getAIConfig().enableFeatures;\r\n\r\nexport const getProviderConfig = (provider: AIProviderId): AIProviderConfig => {\r\n  const config = getAIConfig();\r\n  return config.providers[provider];\r\n};\r\n\r\nexport const getAvailableProviders = (onlyEnabled = true): AIProviderConfig[] => {\r\n  const config = getAIConfig();\r\n  return Object.values(config.providers).filter(provider =>\r\n    onlyEnabled ? provider.enabled : true\r\n  );\r\n};\r\n\r\nexport const getProviderFallbackChain = (preferred?: AIProviderId): AIProviderId[] => {\r\n  const config = getAIConfig();\r\n  const order = ensureFallbackOrder(preferred ?? config.defaultProvider, config.fallbackOrder);\r\n  return order.filter(id => config.providers[id]?.enabled);\r\n};\r\n\r\nexport const getDefaultProvider = (): AIProviderId => getAIConfig().defaultProvider;\r\n\r\nexport const AI_PROVIDER_IDS = [...PROVIDERS] as const;\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\database-integration.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * AI Database Integration Service\r\n *\r\n * Provides AI-powered database operations:\r\n * - Natural language to SQL conversion\r\n * - Intelligent data analysis\r\n * - Anomaly detection\r\n * - Predictive analytics\r\n *\r\n * Uses Vercel AI SDK v5 with Anthropic Claude for optimal database reasoning\r\n */\r\n\r\nimport { generateObject, generateText, streamText } from 'ai';\r\nimport { anthropic } from '@ai-sdk/anthropic';\r\nimport { openai } from '@ai-sdk/openai';\r\nimport { z } from 'zod';\r\nimport { query, withTransaction } from '@/lib/database/connection';\r\nimport { PoolClient } from 'pg';\r\n\r\n// ============================================================================\r\n// SCHEMAS FOR STRUCTURED AI OUTPUTS\r\n// ============================================================================\r\n\r\nconst SQLQuerySchema = z.object({\r\n  sql: z.string().describe('The generated SQL query'),\r\n  parameters: z.array(z.any()).describe('Query parameters for safe execution'),\r\n  explanation: z.string().describe('Human-readable explanation of what the query does'),\r\n  safety_score: z.number().min(0).max(1).describe('Safety score (1 = completely safe)'),\r\n  estimated_rows: z.number().optional().describe('Estimated number of rows returned'),\r\n});\r\n\r\nconst DataAnalysisSchema = z.object({\r\n  summary: z.string().describe('High-level summary of findings'),\r\n  insights: z.array(z.object({\r\n    category: z.string().describe('Category: trend, pattern, risk, opportunity'),\r\n    title: z.string().describe('Insight title'),\r\n    description: z.string().describe('Detailed description'),\r\n    impact: z.enum(['low', 'medium', 'high', 'critical']).describe('Business impact level'),\r\n    actionable: z.boolean().describe('Can immediate action be taken?'),\r\n    recommendation: z.string().optional().describe('Recommended action'),\r\n  })).describe('Specific insights discovered'),\r\n  metrics: z.object({\r\n    total_records: z.number(),\r\n    data_quality_score: z.number().min(0).max(1),\r\n    completeness: z.number().min(0).max(1),\r\n    anomalies_found: z.number(),\r\n  }).describe('Data quality metrics'),\r\n  visualizations: z.array(z.object({\r\n    type: z.enum(['line', 'bar', 'pie', 'scatter', 'heatmap']),\r\n    title: z.string(),\r\n    data_query: z.string().describe('SQL to fetch visualization data'),\r\n  })).optional().describe('Recommended visualizations'),\r\n});\r\n\r\nconst AnomalyDetectionSchema = z.object({\r\n  anomalies: z.array(z.object({\r\n    id: z.string().describe('Unique anomaly identifier'),\r\n    type: z.enum(['data_quality', 'statistical', 'business_rule', 'security']),\r\n    severity: z.enum(['low', 'medium', 'high', 'critical']),\r\n    title: z.string().describe('Anomaly title'),\r\n    description: z.string().describe('Detailed description'),\r\n    affected_records: z.number().describe('Number of records affected'),\r\n    detection_method: z.string().describe('How this was detected'),\r\n    suggested_fix: z.string().optional().describe('Recommended fix'),\r\n    sql_to_fix: z.string().optional().describe('SQL to fix the issue'),\r\n  })).describe('List of detected anomalies'),\r\n  overall_health_score: z.number().min(0).max(1).describe('Overall data health (1 = perfect)'),\r\n  recommendations: z.array(z.string()).describe('General recommendations'),\r\n});\r\n\r\nconst PredictionSchema = z.object({\r\n  prediction_type: z.string().describe('Type of prediction'),\r\n  predictions: z.array(z.object({\r\n    date: z.string().describe('Prediction date'),\r\n    value: z.number().describe('Predicted value'),\r\n    confidence: z.number().min(0).max(1).describe('Confidence level'),\r\n    lower_bound: z.number().optional(),\r\n    upper_bound: z.number().optional(),\r\n  })).describe('Time-series predictions'),\r\n  factors: z.array(z.object({\r\n    name: z.string(),\r\n    impact: z.number().describe('Impact on prediction (-1 to 1)'),\r\n    description: z.string(),\r\n  })).describe('Factors influencing predictions'),\r\n  confidence: z.number().min(0).max(1).describe('Overall confidence'),\r\n  recommendations: z.array(z.string()).describe('Action recommendations'),\r\n});\r\n\r\n// ============================================================================\r\n// DATABASE SCHEMA CONTEXT\r\n// ============================================================================\r\n\r\nconst DATABASE_SCHEMA = `\r\nMantisNXT Database Schema:\r\n\r\nCORE TABLES:\r\n- suppliers: id, name, email, phone, address, status, created_at, updated_at\r\n- products: id, name, sku, description, category, unit_price, supplier_id, created_at\r\n- inventory_items: id, product_id, warehouse_id, quantity, reorder_level, reorder_quantity, location\r\n- purchase_orders: id, supplier_id, order_date, delivery_date, status, total_amount, notes\r\n- purchase_order_items: id, purchase_order_id, product_id, quantity, unit_price, total\r\n- invoices: id, supplier_id, invoice_number, invoice_date, due_date, amount, status\r\n- stock_movements: id, product_id, warehouse_id, quantity, movement_type, reference_id, created_at\r\n\r\nANALYTICS TABLES:\r\n- analytics_predictions: Cached AI predictions\r\n- analytics_anomalies: Detected data anomalies\r\n- analytics_recommendations: Business recommendations\r\n- supplier_performance: Supplier performance metrics\r\n- ai_insights: Stored AI insights\r\n\r\nVIEWS:\r\n- v_inventory_analytics: Inventory health metrics\r\n- v_supplier_performance_summary: Supplier performance overview\r\n- v_purchase_order_analytics: PO analytics\r\n- supplier_inventory_performance: Supplier inventory metrics\r\n\r\nKEY RELATIONSHIPS:\r\n- products.supplier_id -> suppliers.id\r\n- inventory_items.product_id -> products.id\r\n- purchase_order_items.purchase_order_id -> purchase_orders.id\r\n- purchase_order_items.product_id -> products.id\r\n- invoices.supplier_id -> suppliers.id\r\n`;\r\n\r\n// ============================================================================\r\n// AI DATABASE SERVICE\r\n// ============================================================================\r\n\r\nexport class AIDatabaseService {\r\n  private model = anthropic('claude-3-5-sonnet-20241022');\r\n  private fallbackModel = openai('gpt-4.1');\r\n\r\n  /**\r\n   * Convert natural language query to SQL\r\n   */\r\n  async naturalLanguageToSQL(userQuery: string): Promise<{\r\n    sql: string;\r\n    parameters: any[];\r\n    explanation: string;\r\n    safety_score: number;\r\n    estimated_rows?: number;\r\n  }> {\r\n    try {\r\n      const result = await generateObject({\r\n        model: this.model,\r\n        schema: SQLQuerySchema,\r\n        prompt: `You are a PostgreSQL expert. Convert this natural language query to SQL.\r\n\r\nDatabase Schema:\r\n${DATABASE_SCHEMA}\r\n\r\nUser Query: \"${userQuery}\"\r\n\r\nRequirements:\r\n1. Generate SAFE, READ-ONLY SQL (SELECT only, no DELETE/UPDATE/DROP)\r\n2. Use parameterized queries to prevent SQL injection\r\n3. Include JOINs for related data\r\n4. Add appropriate WHERE, ORDER BY, LIMIT clauses\r\n5. Calculate safety_score (1.0 = completely safe read-only, 0.0 = dangerous)\r\n6. Provide clear explanation of what the query does\r\n7. Estimate rows returned if possible\r\n\r\nReturn a valid SQL query that answers the user's question.`,\r\n      });\r\n\r\n      return result.object;\r\n    } catch (error) {\r\n      console.error('Error in naturalLanguageToSQL:', error);\r\n      throw new Error(`Failed to convert query: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Execute natural language query safely\r\n   */\r\n  async executeNaturalLanguageQuery(userQuery: string): Promise<{\r\n    data: any[];\r\n    rowCount: number;\r\n    explanation: string;\r\n    query_generated: string;\r\n    execution_time_ms: number;\r\n  }> {\r\n    const startTime = Date.now();\r\n\r\n    // Generate SQL from natural language\r\n    const sqlResult = await this.naturalLanguageToSQL(userQuery);\r\n\r\n    // Safety check\r\n    if (sqlResult.safety_score < 0.8) {\r\n      throw new Error(`Query rejected for safety reasons (score: ${sqlResult.safety_score}). This query might modify data or pose security risks.`);\r\n    }\r\n\r\n    // Execute query\r\n    const result = await query(sqlResult.sql, sqlResult.parameters);\r\n\r\n    const executionTime = Date.now() - startTime;\r\n\r\n    // Log query to history\r\n    await this.logQueryHistory({\r\n      user_query: userQuery,\r\n      generated_sql: sqlResult.sql,\r\n      result_count: result.rowCount || 0,\r\n      execution_time_ms: executionTime,\r\n    });\r\n\r\n    return {\r\n      data: result.rows,\r\n      rowCount: result.rowCount || 0,\r\n      explanation: sqlResult.explanation,\r\n      query_generated: sqlResult.sql,\r\n      execution_time_ms: executionTime,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Analyze data with AI insights\r\n   */\r\n  async analyzeData(options: {\r\n    table?: string;\r\n    query?: string;\r\n    focus?: 'trends' | 'patterns' | 'risks' | 'opportunities' | 'all';\r\n  }): Promise<z.infer<typeof DataAnalysisSchema>> {\r\n    // Fetch data to analyze\r\n    let dataQuery = options.query;\r\n    if (!dataQuery && options.table) {\r\n      dataQuery = `SELECT * FROM ${options.table} LIMIT 1000`;\r\n    }\r\n\r\n    if (!dataQuery) {\r\n      throw new Error('Either table or query must be provided');\r\n    }\r\n\r\n    const result = await query(dataQuery);\r\n    const sampleData = result.rows.slice(0, 100); // Analyze sample\r\n\r\n    try {\r\n      const analysis = await generateObject({\r\n        model: this.model,\r\n        schema: DataAnalysisSchema,\r\n        prompt: `You are a business intelligence analyst. Analyze this data and provide insights.\r\n\r\nDatabase Schema:\r\n${DATABASE_SCHEMA}\r\n\r\nData Sample (${sampleData.length} records):\r\n${JSON.stringify(sampleData, null, 2)}\r\n\r\nTotal Records: ${result.rowCount}\r\nFocus Area: ${options.focus || 'all'}\r\n\r\nProvide:\r\n1. High-level summary of findings\r\n2. Specific insights (trends, patterns, risks, opportunities)\r\n3. Data quality metrics\r\n4. Recommended visualizations with SQL queries\r\n5. Actionable recommendations\r\n\r\nFocus on business value and actionable insights.`,\r\n      });\r\n\r\n      // Store insights\r\n      await this.storeInsights({\r\n        analysis_type: 'data_analysis',\r\n        input_data: { table: options.table, focus: options.focus },\r\n        insights: analysis.object,\r\n      });\r\n\r\n      return analysis.object;\r\n    } catch (error) {\r\n      console.error('Error in analyzeData:', error);\r\n      throw new Error(`Analysis failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Detect anomalies in data\r\n   */\r\n  async detectAnomalies(options: {\r\n    table?: string;\r\n    query?: string;\r\n    checks?: ('data_quality' | 'statistical' | 'business_rule' | 'security')[];\r\n  }): Promise<z.infer<typeof AnomalyDetectionSchema>> {\r\n    // Fetch data\r\n    let dataQuery = options.query;\r\n    if (!dataQuery && options.table) {\r\n      dataQuery = `SELECT * FROM ${options.table} LIMIT 1000`;\r\n    }\r\n\r\n    if (!dataQuery) {\r\n      throw new Error('Either table or query must be provided');\r\n    }\r\n\r\n    const result = await query(dataQuery);\r\n\r\n    try {\r\n      const detection = await generateObject({\r\n        model: this.model,\r\n        schema: AnomalyDetectionSchema,\r\n        prompt: `You are a data quality expert. Detect anomalies in this data.\r\n\r\nDatabase Schema:\r\n${DATABASE_SCHEMA}\r\n\r\nData Sample:\r\n${JSON.stringify(result.rows.slice(0, 100), null, 2)}\r\n\r\nTotal Records: ${result.rowCount}\r\nChecks to Perform: ${options.checks?.join(', ') || 'all'}\r\n\r\nDetect:\r\n1. Data Quality Issues: NULL values, invalid formats, duplicates\r\n2. Statistical Anomalies: Outliers, unexpected distributions\r\n3. Business Rule Violations: Invalid states, constraint violations\r\n4. Security Issues: Suspicious patterns, unauthorized access\r\n\r\nFor each anomaly:\r\n- Classify type and severity\r\n- Count affected records\r\n- Explain detection method\r\n- Suggest fix with SQL if possible\r\n\r\nCalculate overall health score (1.0 = perfect).`,\r\n      });\r\n\r\n      // Store anomalies\r\n      for (const anomaly of detection.object.anomalies) {\r\n        await this.storeAnomaly({\r\n          type: anomaly.type,\r\n          severity: anomaly.severity,\r\n          title: anomaly.title,\r\n          description: anomaly.description,\r\n          affected_records: anomaly.affected_records,\r\n          detection_method: anomaly.detection_method,\r\n          suggested_fix: anomaly.suggested_fix,\r\n        });\r\n      }\r\n\r\n      return detection.object;\r\n    } catch (error) {\r\n      console.error('Error in detectAnomalies:', error);\r\n      throw new Error(`Anomaly detection failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate predictions using REAL inventory and sales data\r\n   */\r\n  async generatePredictions(options: {\r\n    type: 'inventory_demand' | 'supplier_performance' | 'price_trends' | 'stock_levels';\r\n    target_id?: string; // Changed to string to support UUIDs\r\n    forecast_days?: number;\r\n  }): Promise<z.infer<typeof PredictionSchema>> {\r\n    const forecastDays = options.forecast_days || 30;\r\n\r\n    // Fetch historical data based on prediction type using REAL tables\r\n    let historicalQuery = '';\r\n    let productDetailsQuery = '';\r\n\r\n    switch (options.type) {\r\n      case 'inventory_demand':\r\n        // Query REAL stock_movements table for historical sales/outbound movements\r\n        historicalQuery = `\r\n          SELECT\r\n            date_trunc('day', sm.timestamp) as date,\r\n            SUM(CASE WHEN sm.type = 'out' THEN sm.quantity ELSE 0 END) as outbound,\r\n            SUM(CASE WHEN sm.type = 'in' THEN sm.quantity ELSE 0 END) as inbound,\r\n            AVG(sm.unit_cost) as avg_cost\r\n          FROM stock_movements sm\r\n          ${options.target_id ? `WHERE sm.item_id = $1` : ''}\r\n          GROUP BY date_trunc('day', sm.timestamp)\r\n          ORDER BY date DESC\r\n          LIMIT 90\r\n        `;\r\n\r\n        // Get product details from inventory_items\r\n        if (options.target_id) {\r\n          productDetailsQuery = `\r\n            SELECT\r\n              ii.id,\r\n              ii.sku,\r\n              ii.name,\r\n              ii.stock_qty,\r\n              ii.reorder_point,\r\n              ii.category,\r\n              ii.brand,\r\n              ii.supplier_id\r\n            FROM inventory_items ii\r\n            WHERE ii.id = $1\r\n          `;\r\n        }\r\n        break;\r\n\r\n      case 'supplier_performance':\r\n        historicalQuery = `\r\n          SELECT date_trunc('day', order_date) as date, COUNT(*) as value\r\n          FROM purchase_orders\r\n          WHERE status = 'completed'\r\n          ${options.target_id ? `AND supplier_id = $1` : ''}\r\n          GROUP BY date_trunc('day', order_date)\r\n          ORDER BY date DESC\r\n          LIMIT 90\r\n        `;\r\n        break;\r\n\r\n      case 'stock_levels':\r\n        // Use stock_movements to calculate historical stock levels\r\n        historicalQuery = `\r\n          SELECT\r\n            date_trunc('day', sm.timestamp) as date,\r\n            SUM(CASE WHEN sm.type = 'in' THEN sm.quantity\r\n                     WHEN sm.type = 'out' THEN -sm.quantity\r\n                     ELSE 0 END) as net_change\r\n          FROM stock_movements sm\r\n          ${options.target_id ? `WHERE sm.item_id = $1` : ''}\r\n          GROUP BY date_trunc('day', sm.timestamp)\r\n          ORDER BY date DESC\r\n          LIMIT 90\r\n        `;\r\n        break;\r\n\r\n      default:\r\n        throw new Error(`Unsupported prediction type: ${options.type}`);\r\n    }\r\n\r\n    // Execute queries with UUID parameter\r\n    const params = options.target_id ? [options.target_id] : [];\r\n    const historicalData = await query(historicalQuery, params);\r\n\r\n    // Fetch product details if applicable\r\n    let productDetails = null;\r\n    if (productDetailsQuery && options.target_id) {\r\n      const productResult = await query(productDetailsQuery, [options.target_id]);\r\n      productDetails = productResult.rows[0] || null;\r\n    }\r\n\r\n    try {\r\n      const prediction = await generateObject({\r\n        model: this.model,\r\n        schema: PredictionSchema,\r\n        prompt: `You are a forecasting expert. Generate predictions based on historical data.\r\n\r\nPrediction Type: ${options.type}\r\nForecast Period: ${forecastDays} days\r\n\r\nHistorical Data (last 90 days):\r\n${JSON.stringify(historicalData.rows, null, 2)}\r\n\r\nProvide:\r\n1. Daily predictions for next ${forecastDays} days\r\n2. Confidence intervals (lower_bound, upper_bound)\r\n3. Key factors influencing predictions\r\n4. Overall confidence score\r\n5. Actionable recommendations\r\n\r\nUse statistical patterns, seasonality, and trends to make accurate predictions.`,\r\n      });\r\n\r\n      // Cache predictions\r\n      await this.cachePrediction({\r\n        prediction_type: options.type,\r\n        target_id: options.target_id,\r\n        predictions: prediction.object,\r\n        confidence: prediction.object.confidence,\r\n        expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 hours\r\n      });\r\n\r\n      return prediction.object;\r\n    } catch (error) {\r\n      console.error('Error in generatePredictions:', error);\r\n      throw new Error(`Prediction failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stream AI analysis (for real-time insights)\r\n   */\r\n  async streamAnalysis(userQuery: string): AsyncIterable<string> {\r\n    const stream = await streamText({\r\n      model: this.model,\r\n      prompt: `You are a data analyst. Analyze this query and provide insights.\r\n\r\nDatabase Schema:\r\n${DATABASE_SCHEMA}\r\n\r\nUser Query: \"${userQuery}\"\r\n\r\nProvide real-time analysis as you think through the data.`,\r\n    });\r\n\r\n    return stream.textStream;\r\n  }\r\n\r\n  // ============================================================================\r\n  // PRIVATE HELPER METHODS\r\n  // ============================================================================\r\n\r\n  private async logQueryHistory(data: {\r\n    user_query: string;\r\n    generated_sql: string;\r\n    result_count: number;\r\n    execution_time_ms: number;\r\n  }): Promise<void> {\r\n    try {\r\n      await query(`\r\n        INSERT INTO ai_query_history (user_query, generated_sql, result_count, execution_time_ms)\r\n        VALUES ($1, $2, $3, $4)\r\n      `, [data.user_query, data.generated_sql, data.result_count, data.execution_time_ms]);\r\n    } catch (error) {\r\n      console.error('Failed to log query history:', error);\r\n      // Don't throw - logging failure shouldn't break the query\r\n    }\r\n  }\r\n\r\n  private async storeInsights(data: {\r\n    analysis_type: string;\r\n    input_data: any;\r\n    insights: any;\r\n  }): Promise<void> {\r\n    try {\r\n      await query(`\r\n        INSERT INTO ai_insights (analysis_type, input_data, insights, created_at)\r\n        VALUES ($1, $2, $3, NOW())\r\n      `, [data.analysis_type, JSON.stringify(data.input_data), JSON.stringify(data.insights)]);\r\n    } catch (error) {\r\n      console.error('Failed to store insights:', error);\r\n    }\r\n  }\r\n\r\n  private async storeAnomaly(data: {\r\n    type: string;\r\n    severity: string;\r\n    title: string;\r\n    description: string;\r\n    affected_records: number;\r\n    detection_method: string;\r\n    suggested_fix?: string;\r\n  }): Promise<void> {\r\n    try {\r\n      await query(`\r\n        INSERT INTO ai_data_anomalies (anomaly_type, severity, title, description, affected_records, detection_method, suggested_fix, detected_at)\r\n        VALUES ($1, $2, $3, $4, $5, $6, $7, NOW())\r\n      `, [data.type, data.severity, data.title, data.description, data.affected_records, data.detection_method, data.suggested_fix || null]);\r\n    } catch (error) {\r\n      console.error('Failed to store anomaly:', error);\r\n    }\r\n  }\r\n\r\n  private async cachePrediction(data: {\r\n    prediction_type: string;\r\n    target_id?: number;\r\n    predictions: any;\r\n    confidence: number;\r\n    expires_at: Date;\r\n  }): Promise<void> {\r\n    try {\r\n      await query(`\r\n        INSERT INTO ai_predictions (prediction_type, target_id, predictions, confidence, expires_at, created_at)\r\n        VALUES ($1, $2, $3, $4, $5, NOW())\r\n      `, [data.prediction_type, data.target_id || null, JSON.stringify(data.predictions), data.confidence, data.expires_at]);\r\n    } catch (error) {\r\n      console.error('Failed to cache prediction:', error);\r\n    }\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const aiDatabase = new AIDatabaseService();\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\providers.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"@typescript-eslint/no-this-alias","severity":2,"message":"Unexpected aliasing of 'this' to local variable.","line":546,"column":13,"nodeType":"Identifier","messageId":"thisAssignment","endLine":546,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\nimport { generateText, streamText, embed, embedMany, type ModelMessage } from 'ai';\r\nimport { createOpenAI } from '@ai-sdk/openai';\r\nimport { createAnthropic } from '@ai-sdk/anthropic';\r\nimport { createGateway } from '@ai-sdk/gateway';\r\nimport {\r\n  AIClient,\r\n  AIProviderId,\r\n  AIProviderConfig,\r\n  AITextResult,\r\n  AIStreamChunk,\r\n  AIProviderRuntimeOptions,\r\n  AIChatMessage,\r\n  AIChatResult,\r\n  AIEmbeddingInput,\r\n  AIEmbeddingOptions,\r\n  AIEmbeddingResult,\r\n  AIProviderHealth,\r\n  AIUsageEvent,\r\n  AIUsageMetrics,\r\n} from '@/types/ai';\r\nimport {\r\n  AI_PROVIDER_IDS,\r\n  getAIConfig,\r\n  getProviderConfig,\r\n  getProviderFallbackChain,\r\n  onAIConfigChange,\r\n} from './config';\r\n\r\ninterface ProviderBinding {\r\n  id: AIProviderId;\r\n  supportsStreaming: boolean;\r\n  supportsEmbeddings: boolean;\r\n  languageModel: (modelId: string) => unknown;\r\n  embeddingModel?: (modelId: string) => unknown;\r\n  raw: unknown;\r\n}\r\n\r\ntype UsageListener = (event: AIUsageEvent) => void;\r\n\r\nconst providerClientCache = new Map<AIProviderId, ProviderClient>();\r\nconst usageListeners = new Set<UsageListener>();\r\nconst isServerRuntime = typeof window === 'undefined';\r\n\r\nconst createInitialHealth = (id: AIProviderId): AIProviderHealth => ({\r\n  id,\r\n  status: 'healthy',\r\n  lastChecked: Date.now(),\r\n  consecutiveFailures: 0,\r\n});\r\n\r\nconst providerHealthState: Record<AIProviderId, AIProviderHealth> = AI_PROVIDER_IDS.reduce(\r\n  (acc, id) => {\r\n    acc[id] = createInitialHealth(id);\r\n    return acc;\r\n  },\r\n  {} as Record<AIProviderId, AIProviderHealth>,\r\n);\r\n\r\nconst getProviderEnablementHint = (config: AIProviderConfig): string => {\r\n  switch (config.id) {\r\n    case 'openai':\r\n      return 'Set OPENAI_API_KEY or OPENAI_API_KEY_FILE to enable the OpenAI provider.';\r\n    case 'anthropic':\r\n      return 'Set ANTHROPIC_API_KEY or ANTHROPIC_API_KEY_FILE to enable the Anthropic provider.';\r\n    case 'vercel':\r\n      return 'Set VERCEL_AI_GATEWAY_TOKEN (or _FILE) and VERCEL_AI_GATEWAY_URL to enable the Vercel AI Gateway provider.';\r\n    case 'openai-compatible':\r\n      return 'Set both OPENAI_COMPATIBLE_API_KEY (or _FILE) and OPENAI_COMPATIBLE_BASE_URL to enable the OpenAI compatible provider.';\r\n    default:\r\n      return 'Configure valid credentials for this provider.';\r\n  }\r\n};\r\n\r\nconst coerceAnnotations = (metadata?: Record<string, any>): Record<string, string | number | boolean> | undefined => {\r\n  if (!metadata) return undefined;\r\n  const annotations: Record<string, string | number | boolean> = {};\r\n  for (const [key, value] of Object.entries(metadata)) {\r\n    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\r\n      annotations[key] = value;\r\n    }\r\n  }\r\n  return Object.keys(annotations).length > 0 ? annotations : undefined;\r\n};\r\n\r\nconst normalizeMessageContent = (content: any): string => {\r\n  if (content == null) return '';\r\n  if (typeof content === 'string') return content;\r\n  if (Array.isArray(content)) {\r\n    return content.map((part) => normalizeMessageContent(part)).join('');\r\n  }\r\n  if (typeof content === 'object') {\r\n    if (typeof content.text === 'string') return content.text;\r\n    if (typeof content.content === 'string') return content.content;\r\n    return JSON.stringify(content);\r\n  }\r\n  return String(content);\r\n};\r\n\r\nconst mapResponseMessages = (messages: any[] | undefined): AIChatMessage[] | undefined => {\r\n  if (!messages || messages.length === 0) return undefined;\r\n  return messages.map((message) => ({\r\n    role: (message.role ?? 'assistant') as AIChatMessage['role'],\r\n    content: normalizeMessageContent(message.content),\r\n    name: message.name,\r\n    metadata: {\r\n      id: message.id,\r\n      type: message.type,\r\n    },\r\n  }));\r\n};\r\n\r\nconst createAbortSignal = (\r\n  timeoutMs: number | undefined,\r\n  externalSignal?: AbortSignal,\r\n): { signal?: AbortSignal; cleanup?: () => void } => {\r\n  const hasTimeout = typeof timeoutMs === 'number' && timeoutMs > 0;\r\n  if (!hasTimeout || typeof AbortController === 'undefined') {\r\n    return { signal: externalSignal, cleanup: undefined };\r\n  }\r\n\r\n  const controller = new AbortController();\r\n  const timer = setTimeout(() => {\r\n    if (!controller.signal.aborted) {\r\n      controller.abort(new Error(`AI provider request exceeded ${timeoutMs}ms`));\r\n    }\r\n  }, timeoutMs);\r\n\r\n  const abortFromExternal = () => {\r\n    if (!controller.signal.aborted) {\r\n      const reason = (externalSignal as any)?.reason;\r\n      controller.abort(reason ?? new Error('AI request aborted by caller'));\r\n    }\r\n  };\r\n\r\n  if (externalSignal) {\r\n    if (externalSignal.aborted) {\r\n      abortFromExternal();\r\n    } else {\r\n      externalSignal.addEventListener('abort', abortFromExternal);\r\n    }\r\n  }\r\n\r\n  const cleanup = () => {\r\n    clearTimeout(timer);\r\n    if (externalSignal) {\r\n      externalSignal.removeEventListener('abort', abortFromExternal);\r\n    }\r\n  };\r\n\r\n  return { signal: controller.signal, cleanup };\r\n};\r\ninterface HealthCheckRequest {\r\n  url: string;\r\n  method?: string;\r\n  headers?: Record<string, string>;\r\n}\r\n\r\nconst appendPathSegment = (base: string, path: string): string => {\r\n  const normalizedBase = base.replace(/[/\\\\]+$/, '');\r\n  const normalizedPath = path.startsWith('/') ? path : `/${path}`;\r\n  return normalizedBase + normalizedPath;\r\n};\r\n\r\nconst buildHealthCheckRequest = (config: AIProviderConfig): HealthCheckRequest | null => {\r\n  switch (config.id) {\r\n    case 'openai': {\r\n      const apiKey = config.credentials.apiKey;\r\n      if (!apiKey) return null;\r\n      const base = config.credentials.baseUrl ?? 'https://api.openai.com/v1';\r\n      const headers: Record<string, string> = {\r\n        Authorization: `Bearer ${apiKey}`,\r\n      };\r\n      if (config.credentials.organization) {\r\n        headers['OpenAI-Organization'] = config.credentials.organization;\r\n      }\r\n      if (config.credentials.project) {\r\n        headers['OpenAI-Project'] = config.credentials.project;\r\n      }\r\n      return {\r\n        url: appendPathSegment(base, '/models'),\r\n        headers,\r\n      };\r\n    }\r\n    case 'anthropic': {\r\n      const apiKey = config.credentials.apiKey;\r\n      if (!apiKey) return null;\r\n      const base = config.credentials.baseUrl ?? 'https://api.anthropic.com/v1';\r\n      return {\r\n        url: appendPathSegment(base, '/models'),\r\n        headers: {\r\n          'x-api-key': apiKey,\r\n          'anthropic-version': '2023-06-01',\r\n        },\r\n      };\r\n    }\r\n    case 'vercel': {\r\n      const token = config.credentials.authToken ?? config.credentials.apiKey;\r\n      const base = config.credentials.baseUrl;\r\n      if (!token || !base) return null;\r\n      return {\r\n        url: appendPathSegment(base, '/models'),\r\n        headers: { Authorization: `Bearer ${token}` },\r\n      };\r\n    }\r\n    case 'openai-compatible': {\r\n      const apiKey = config.credentials.apiKey;\r\n      const base = config.credentials.baseUrl;\r\n      if (!apiKey || !base) return null;\r\n      return {\r\n        url: appendPathSegment(base, '/models'),\r\n        headers: { Authorization: `Bearer ${apiKey}` },\r\n      };\r\n    }\r\n    default:\r\n      return null;\r\n  }\r\n};\r\n\r\nconst shouldEmitUsage = (): boolean => {\r\n  const analytics = getAIConfig().analytics;\r\n  if (!analytics.enabled) return false;\r\n  if (analytics.sampleRate >= 1) return true;\r\n  return Math.random() < analytics.sampleRate;\r\n};\r\n\r\nconst emitUsage = (event: AIUsageEvent): void => {\r\n  const analytics = getAIConfig().analytics;\r\n  if (!analytics.enabled) return;\r\n  if (!shouldEmitUsage()) return;\r\n\r\n  const enriched: AIUsageEvent = {\r\n    ...event,\r\n    annotations: {\r\n      ...(event.annotations ?? {}),\r\n      event: analytics.eventName,\r\n    },\r\n  };\r\n\r\n  for (const listener of usageListeners) {\r\n    try {\r\n      listener(enriched);\r\n    } catch (error) {\r\n      console.error('AI usage listener failed', error);\r\n    }\r\n  }\r\n};\r\n\r\nconst ensureRecoveryWindow = (health: AIProviderHealth): void => {\r\n  const monitoring = getAIConfig().monitoring;\r\n  if (!monitoring.enabled) return;\r\n  const elapsed = Date.now() - health.lastChecked;\r\n  if (health.status === 'unhealthy' && elapsed >= monitoring.recoveryWindowMs) {\r\n    health.status = 'degraded';\r\n    if (health.consecutiveFailures > 0) {\r\n      health.consecutiveFailures -= 1;\r\n    }\r\n  }\r\n  if (health.status === 'degraded' && health.consecutiveFailures === 0) {\r\n    health.status = 'healthy';\r\n  }\r\n};\r\n\r\nconst markProviderSuccess = (providerId: AIProviderId, durationMs: number): void => {\r\n  const health = providerHealthState[providerId];\r\n  if (!health) return;\r\n  const monitoring = getAIConfig().monitoring;\r\n  health.status = 'healthy';\r\n  health.consecutiveFailures = 0;\r\n  health.lastChecked = Date.now();\r\n  if (monitoring.trackLatency) {\r\n    health.latencyMs = durationMs;\r\n  } else {\r\n    delete health.latencyMs;\r\n  }\r\n  delete health.lastError;\r\n};\r\n\r\nconst markProviderFailure = (providerId: AIProviderId, error: unknown): void => {\r\n  const health = providerHealthState[providerId];\r\n  if (!health) return;\r\n  const monitoring = getAIConfig().monitoring;\r\n  health.lastChecked = Date.now();\r\n  health.consecutiveFailures += 1;\r\n  health.lastError = error instanceof Error ? error.message : String(error);\r\n\r\n  if (!monitoring.enabled) {\r\n    health.status = 'degraded';\r\n    return;\r\n  }\r\n\r\n  if (health.consecutiveFailures >= monitoring.unhealthyThreshold) {\r\n    health.status = 'unhealthy';\r\n  } else {\r\n    health.status = 'degraded';\r\n  }\r\n};\r\n\r\nconst getHealthSnapshot = (providerId: AIProviderId): AIProviderHealth => {\r\n  const health = providerHealthState[providerId] ?? createInitialHealth(providerId);\r\n  ensureRecoveryWindow(health);\r\n  return { ...health };\r\n};\r\n\r\nconst instantiateProviderBinding = (config: AIProviderConfig): ProviderBinding => {\r\n  if (!config.enabled) {\r\n    throw new Error(`Provider ${config.id} is not enabled. ${getProviderEnablementHint(config)}`);\r\n  }\r\n\r\n  switch (config.id) {\r\n    case 'openai':\r\n    case 'openai-compatible': {\r\n      const openai = createOpenAI({\r\n        apiKey: config.credentials.apiKey,\r\n        baseURL: config.credentials.baseUrl,\r\n        organization: config.credentials.organization,\r\n        project: config.credentials.project,\r\n        name: config.id === 'openai-compatible' ? 'openai-compatible' : undefined,\r\n      });\r\n\r\n      return {\r\n        id: config.id,\r\n        supportsStreaming: true,\r\n        supportsEmbeddings: true,\r\n        languageModel: (modelId: string) => openai.languageModel(modelId),\r\n        embeddingModel: (modelId: string) => openai.textEmbeddingModel(modelId),\r\n        raw: openai,\r\n      };\r\n    }\r\n    case 'anthropic': {\r\n      const anthropic = createAnthropic({\r\n        apiKey: config.credentials.apiKey,\r\n        baseURL: config.credentials.baseUrl,\r\n      });\r\n\r\n      return {\r\n        id: config.id,\r\n        supportsStreaming: true,\r\n        supportsEmbeddings: false,\r\n        languageModel: (modelId: string) => anthropic.languageModel(modelId),\r\n        raw: anthropic,\r\n      };\r\n    }\r\n    case 'vercel': {\r\n      if (!config.credentials.authToken && !config.credentials.apiKey) {\r\n        throw new Error('Vercel AI credentials are required to enable the gateway provider.');\r\n      }\r\n\r\n      const gateway = createGateway({\r\n        apiKey: config.credentials.authToken ?? config.credentials.apiKey,\r\n        baseURL: config.credentials.baseUrl,\r\n      });\r\n\r\n      return {\r\n        id: config.id,\r\n        supportsStreaming: true,\r\n        supportsEmbeddings: true,\r\n        languageModel: (modelId: string) => gateway.languageModel(modelId),\r\n        embeddingModel: (modelId: string) => gateway.textEmbeddingModel(modelId),\r\n        raw: gateway,\r\n      };\r\n    }\r\n    default:\r\n      throw new Error('Unsupported AI provider: ' + config.id);\r\n  }\r\n};\r\n\r\nclass ProviderClient implements AIClient {\r\n  readonly id: AIProviderId;\r\n  readonly supportsStreaming: boolean;\r\n  readonly supportsEmbeddings: boolean;\r\n  private readonly config: AIProviderConfig;\r\n  private readonly binding: ProviderBinding;\r\n\r\n  constructor(config: AIProviderConfig) {\r\n    this.config = config;\r\n    this.binding = instantiateProviderBinding(config);\r\n    this.id = config.id;\r\n    this.supportsStreaming = this.binding.supportsStreaming;\r\n    this.supportsEmbeddings = this.binding.supportsEmbeddings;\r\n  }\r\n\r\n  private resolveModel(options: AIProviderRuntimeOptions | undefined, category: 'default' | 'chat' | 'streaming' | 'embedding'): string {\r\n    if (options && options.model) return options.model;\r\n    if (category === 'chat' && this.config.models.chat) return this.config.models.chat;\r\n    if (category === 'streaming' && this.config.models.streaming) return this.config.models.streaming;\r\n    if (category === 'embedding' && this.config.models.embedding) return this.config.models.embedding;\r\n    return this.config.models.default;\r\n  }\r\n\r\n  private computeCallSettings(options?: AIProviderRuntimeOptions) {\r\n    const globalConfig = getAIConfig();\r\n    const targetMaxTokens = options?.maxTokens ?? globalConfig.maxTokens;\r\n    const providerLimit = this.config.limits.maxTokens;\r\n    const maxOutputTokens = providerLimit ? Math.min(targetMaxTokens, providerLimit) : targetMaxTokens;\r\n    const timeoutMs = this.config.requestTimeoutMs ?? globalConfig.requestTimeoutMs;\r\n    const { signal, cleanup } = createAbortSignal(timeoutMs, options?.signal);\r\n\r\n    return {\r\n      maxOutputTokens,\r\n      temperature: options?.temperature ?? globalConfig.temperature,\r\n      topP: options?.topP,\r\n      topK: options?.topK,\r\n      presencePenalty: options?.presencePenalty,\r\n      frequencyPenalty: options?.frequencyPenalty,\r\n      stopSequences: options?.stopSequences,\r\n      maxRetries: this.config.maxRetries,\r\n      abortSignal: signal,\r\n      cleanup,\r\n    };\r\n  }\r\n\r\n  private buildUsageMetrics(\r\n    model: string,\r\n    durationMs: number,\r\n    usage?: { inputTokens?: number; outputTokens?: number; totalTokens?: number },\r\n    success: boolean = true,\r\n    error?: Error,\r\n    metadata?: Record<string, any>,\r\n  ): AIUsageMetrics {\r\n    const metrics: AIUsageMetrics = {\r\n      provider: this.id,\r\n      model,\r\n      success,\r\n      promptTokens: usage?.inputTokens,\r\n      completionTokens: usage?.outputTokens,\r\n      totalTokens:\r\n        usage?.totalTokens ??\r\n        (usage && usage.inputTokens != null && usage.outputTokens != null\r\n          ? usage.inputTokens + usage.outputTokens\r\n          : undefined),\r\n      durationMs,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n\r\n    if (!success && error) {\r\n      const anyError = error as any;\r\n      metrics.errorMessage = error.message;\r\n      if (typeof anyError.code === 'string' || typeof anyError.code === 'number') {\r\n        metrics.errorCode = String(anyError.code);\r\n      } else if (typeof anyError.status === 'string' || typeof anyError.status === 'number') {\r\n        metrics.errorCode = String(anyError.status);\r\n      }\r\n    }\r\n\r\n    const annotations = coerceAnnotations(metadata);\r\n    if (annotations) {\r\n      metrics.annotations = { ...(metrics.annotations ?? {}), ...annotations };\r\n    }\r\n\r\n    return metrics;\r\n  }\r\n\r\n  private formatMessages(messages: AIChatMessage[]): ModelMessage[] {\r\n    return messages.map((message) => ({\r\n      role: message.role,\r\n      content: message.content,\r\n      name: message.name,\r\n    })) as ModelMessage[];\r\n  }\r\n\r\n  async generateText(prompt: string, options?: AIProviderRuntimeOptions): Promise<AITextResult> {\r\n    const model = this.resolveModel(options, 'default');\r\n    const callSettings = this.computeCallSettings(options);\r\n    const startedAt = Date.now();\r\n\r\n    try {\r\n      const result = await generateText({\r\n        model: this.binding.languageModel(model),\r\n        prompt,\r\n        maxOutputTokens: callSettings.maxOutputTokens,\r\n        temperature: callSettings.temperature,\r\n        topP: callSettings.topP,\r\n        topK: callSettings.topK,\r\n        presencePenalty: callSettings.presencePenalty,\r\n        frequencyPenalty: callSettings.frequencyPenalty,\r\n        stopSequences: callSettings.stopSequences,\r\n        maxRetries: callSettings.maxRetries,\r\n        abortSignal: callSettings.abortSignal,\r\n        responseFormat: options?.responseFormat,\r\n      });\r\n\r\n      const duration = Date.now() - startedAt;\r\n      const usage = result.totalUsage ?? result.usage;\r\n      const metrics = this.buildUsageMetrics(model, duration, usage, true, undefined, options?.metadata);\r\n      markProviderSuccess(this.id, duration);\r\n      emitUsage({\r\n        ...metrics,\r\n        operation: 'generate',\r\n        promptLength: prompt.length,\r\n        responseLength: result.text.length,\r\n      });\r\n\r\n      return {\r\n        text: result.text,\r\n        provider: this.id,\r\n        model,\r\n        finishReason: result.finishReason,\r\n        usage: metrics,\r\n        metadata: {\r\n          warnings: result.warnings,\r\n          providerMetadata: result.providerMetadata,\r\n        },\r\n      };\r\n    } catch (error) {\r\n      const duration = Date.now() - startedAt;\r\n      markProviderFailure(this.id, error);\r\n      const metrics = this.buildUsageMetrics(model, duration, undefined, false, error as Error, options?.metadata);\r\n      emitUsage({\r\n        ...metrics,\r\n        operation: 'generate',\r\n        promptLength: prompt.length,\r\n        responseLength: 0,\r\n      });\r\n      throw error;\r\n    } finally {\r\n      callSettings.cleanup?.();\r\n    }\r\n  }\r\n\r\n  async streamText(prompt: string, options?: AIProviderRuntimeOptions): Promise<AsyncIterable<AIStreamChunk>> {\r\n    if (!this.supportsStreaming) {\r\n      throw new Error('Provider ' + this.id + ' does not support streaming.');\r\n    }\r\n\r\n    const model = this.resolveModel(options, 'streaming');\r\n    const callSettings = this.computeCallSettings(options);\r\n    const startedAt = Date.now();\r\n\r\n    try {\r\n      const streamResult = await streamText({\r\n        model: this.binding.languageModel(model),\r\n        prompt,\r\n        maxOutputTokens: callSettings.maxOutputTokens,\r\n        temperature: callSettings.temperature,\r\n        topP: callSettings.topP,\r\n        topK: callSettings.topK,\r\n        presencePenalty: callSettings.presencePenalty,\r\n        frequencyPenalty: callSettings.frequencyPenalty,\r\n        stopSequences: callSettings.stopSequences,\r\n        maxRetries: callSettings.maxRetries,\r\n        abortSignal: callSettings.abortSignal,\r\n        responseFormat: options?.responseFormat,\r\n      });\r\n\r\n      const self = this;\r\n      const cleanup = callSettings.cleanup;\r\n      const iterator = async function* (): AsyncIterable<AIStreamChunk> {\r\n        let index = 0;\r\n        let response = '';\r\n        let error: unknown;\r\n        try {\r\n          for await (const token of streamResult.textStream) {\r\n            response += token;\r\n            yield {\r\n              token,\r\n              index,\r\n              provider: self.id,\r\n              model,\r\n              timestamp: Date.now(),\r\n            } as AIStreamChunk;\r\n            index += 1;\r\n          }\r\n          yield {\r\n            token: '',\r\n            index,\r\n            provider: self.id,\r\n            model,\r\n            timestamp: Date.now(),\r\n            done: true,\r\n          } as AIStreamChunk;\r\n        } catch (err) {\r\n          error = err;\r\n          throw err;\r\n        } finally {\r\n          const duration = Date.now() - startedAt;\r\n          const usage = await streamResult.totalUsage.catch(() => undefined);\r\n          if (error) {\r\n            markProviderFailure(self.id, error);\r\n          } else {\r\n            markProviderSuccess(self.id, duration);\r\n          }\r\n          const metrics = self.buildUsageMetrics(model, duration, usage, !error, error instanceof Error ? error : undefined, options?.metadata);\r\n          emitUsage({\r\n            ...metrics,\r\n            operation: 'stream',\r\n            promptLength: prompt.length,\r\n            responseLength: response.length,\r\n          });\r\n          cleanup?.();\r\n        }\r\n      };\r\n\r\n      return iterator();\r\n    } catch (error) {\r\n      const duration = Date.now() - startedAt;\r\n      markProviderFailure(this.id, error);\r\n      const metrics = this.buildUsageMetrics(model, duration, undefined, false, error as Error, options?.metadata);\r\n      emitUsage({\r\n        ...metrics,\r\n        operation: 'stream',\r\n        promptLength: prompt.length,\r\n        responseLength: 0,\r\n      });\r\n      callSettings.cleanup?.();\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async chat(messages: AIChatMessage[], options?: AIProviderRuntimeOptions): Promise<AIChatResult> {\r\n    const model = this.resolveModel(options, 'chat');\r\n    const callSettings = this.computeCallSettings(options);\r\n    const formattedMessages = this.formatMessages(messages);\r\n    const promptLength = messages.reduce((total, message) => total + (message.content ? message.content.length : 0), 0);\r\n    const startedAt = Date.now();\r\n\r\n    try {\r\n      const result = await generateText({\r\n        model: this.binding.languageModel(model),\r\n        messages: formattedMessages,\r\n        maxOutputTokens: callSettings.maxOutputTokens,\r\n        temperature: callSettings.temperature,\r\n        topP: callSettings.topP,\r\n        topK: callSettings.topK,\r\n        presencePenalty: callSettings.presencePenalty,\r\n        frequencyPenalty: callSettings.frequencyPenalty,\r\n        stopSequences: callSettings.stopSequences,\r\n        maxRetries: callSettings.maxRetries,\r\n        abortSignal: callSettings.abortSignal,\r\n        responseFormat: options?.responseFormat,\r\n      });\r\n\r\n      const duration = Date.now() - startedAt;\r\n      const usage = result.totalUsage ?? result.usage;\r\n      const metrics = this.buildUsageMetrics(model, duration, usage, true, undefined, options?.metadata);\r\n      markProviderSuccess(this.id, duration);\r\n      const responseMessages = mapResponseMessages(result.response?.messages);\r\n      emitUsage({\r\n        ...metrics,\r\n        operation: 'chat',\r\n        promptLength,\r\n        responseLength: result.text.length,\r\n      });\r\n\r\n      return {\r\n        text: result.text,\r\n        provider: this.id,\r\n        model,\r\n        finishReason: result.finishReason,\r\n        usage: metrics,\r\n        metadata: {\r\n          warnings: result.warnings,\r\n          providerMetadata: result.providerMetadata,\r\n        },\r\n        messages: responseMessages,\r\n        rawResponse: result.response,\r\n      };\r\n    } catch (error) {\r\n      const duration = Date.now() - startedAt;\r\n      markProviderFailure(this.id, error);\r\n      const metrics = this.buildUsageMetrics(model, duration, undefined, false, error as Error, options?.metadata);\r\n      emitUsage({\r\n        ...metrics,\r\n        operation: 'chat',\r\n        promptLength,\r\n        responseLength: 0,\r\n      });\r\n      throw error;\r\n    } finally {\r\n      callSettings.cleanup?.();\r\n    }\r\n  }\r\n\r\n  async embed(input: AIEmbeddingInput, options?: AIEmbeddingOptions): Promise<AIEmbeddingResult> {\r\n    if (!this.supportsEmbeddings || !this.binding.embeddingModel) {\r\n      throw new Error('Provider ' + this.id + ' does not support embeddings.');\r\n    }\r\n\r\n    const model = this.resolveModel(options, 'embedding');\r\n    const callSettings = this.computeCallSettings(options);\r\n    const startedAt = Date.now();\r\n    const targetDimensions = options?.dimensions ?? input.dimensions;\r\n\r\n    const computePromptLength = (): number => {\r\n      if (Array.isArray(input.input)) {\r\n        return input.input.join('').length;\r\n      }\r\n      return typeof input.input === 'string' ? input.input.length : 0;\r\n    };\r\n\r\n    try {\r\n      if (Array.isArray(input.input)) {\r\n        const result = await embedMany({\r\n          model: this.binding.embeddingModel(model),\r\n          values: input.input,\r\n          maxRetries: callSettings.maxRetries,\r\n          abortSignal: callSettings.abortSignal,\r\n          dimensions: targetDimensions,\r\n        });\r\n\r\n        const duration = Date.now() - startedAt;\r\n        const metrics = this.buildUsageMetrics(model, duration, result.usage, true, undefined, options?.metadata);\r\n        markProviderSuccess(this.id, duration);\r\n        emitUsage({\r\n          ...metrics,\r\n          operation: 'embed',\r\n          promptLength: computePromptLength(),\r\n          responseLength: 0,\r\n        });\r\n\r\n        const vectors = result.embeddings.map((embedding) => Array.from(embedding));\r\n\r\n        return {\r\n          vector: vectors[0] ?? [],\r\n          vectors,\r\n          provider: this.id,\r\n          model,\r\n          usage: metrics,\r\n        };\r\n      }\r\n\r\n      const result = await embed({\r\n        model: this.binding.embeddingModel(model),\r\n        value: input.input,\r\n        maxRetries: callSettings.maxRetries,\r\n        abortSignal: callSettings.abortSignal,\r\n        dimensions: targetDimensions,\r\n      });\r\n\r\n      const duration = Date.now() - startedAt;\r\n      const metrics = this.buildUsageMetrics(model, duration, result.usage, true, undefined, options?.metadata);\r\n      markProviderSuccess(this.id, duration);\r\n      emitUsage({\r\n        ...metrics,\r\n        operation: 'embed',\r\n        promptLength: computePromptLength(),\r\n        responseLength: 0,\r\n      });\r\n\r\n      return {\r\n        vector: Array.from(result.embedding),\r\n        provider: this.id,\r\n        model,\r\n        usage: metrics,\r\n      };\r\n    } catch (error) {\r\n      const duration = Date.now() - startedAt;\r\n      markProviderFailure(this.id, error);\r\n      const metrics = this.buildUsageMetrics(model, duration, undefined, false, error as Error, options?.metadata);\r\n      emitUsage({\r\n        ...metrics,\r\n        operation: 'embed',\r\n        promptLength: computePromptLength(),\r\n        responseLength: 0,\r\n      });\r\n      throw error;\r\n    } finally {\r\n      callSettings.cleanup?.();\r\n    }\r\n  }\r\n\r\n  async getHealth(): Promise<AIProviderHealth> {\r\n    return Promise.resolve(getHealthSnapshot(this.id));\r\n  }\r\n}\r\n\r\nconst getOrCreateProviderClient = (providerId: AIProviderId): ProviderClient => {\r\n  const existing = providerClientCache.get(providerId);\r\n  if (existing) {\r\n    return existing;\r\n  }\r\n\r\n  const config = getProviderConfig(providerId);\r\n  const client = new ProviderClient(config);\r\n  providerClientCache.set(providerId, client);\r\n  return client;\r\n};\r\n\r\nlet healthCheckTimer: NodeJS.Timeout | null = null;\r\nlet healthCheckPromise: Promise<void> | null = null;\r\n\r\nconst runProviderHealthCheck = async (providerId: AIProviderId): Promise<void> => {\r\n  const config = getProviderConfig(providerId);\r\n  if (!config.enabled) {\r\n    const health = providerHealthState[providerId];\r\n    if (health) {\r\n      health.status = 'degraded';\r\n      health.lastChecked = Date.now();\r\n    }\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const request = buildHealthCheckRequest(config);\r\n    if (!request || typeof fetch !== 'function') {\r\n      const client = getOrCreateProviderClient(providerId);\r\n      await client.getHealth();\r\n      markProviderSuccess(providerId, 0);\r\n      return;\r\n    }\r\n\r\n    const timeoutMs = config.requestTimeoutMs ?? getAIConfig().requestTimeoutMs;\r\n    const controller = typeof AbortController === 'undefined' ? undefined : new AbortController();\r\n    let timer: NodeJS.Timeout | undefined;\r\n\r\n    if (controller && timeoutMs && timeoutMs > 0) {\r\n      timer = setTimeout(() => {\r\n        if (!controller.signal.aborted) {\r\n          controller.abort(new Error(`AI provider health check timed out after ${timeoutMs}ms`));\r\n        }\r\n      }, timeoutMs);\r\n    }\r\n\r\n    const response = await fetch(request.url, {\r\n      method: request.method ?? 'GET',\r\n      headers: request.headers,\r\n      signal: controller?.signal,\r\n    });\r\n\r\n    if (timer) {\r\n      clearTimeout(timer);\r\n    }\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Health check failed with status ${response.status}`);\r\n    }\r\n\r\n    markProviderSuccess(providerId, 0);\r\n  } catch (error) {\r\n    markProviderFailure(providerId, error);\r\n  }\r\n};\r\n\r\nconst runScheduledHealthChecks = async (): Promise<void> => {\r\n  const config = getAIConfig();\r\n  if (!config.monitoring.enabled) {\r\n    return;\r\n  }\r\n\r\n  for (const providerId of AI_PROVIDER_IDS) {\r\n    await runProviderHealthCheck(providerId);\r\n  }\r\n};\r\n\r\nconst stopScheduledHealthChecks = (): void => {\r\n  if (healthCheckTimer) {\r\n    clearInterval(healthCheckTimer);\r\n    healthCheckTimer = null;\r\n  }\r\n};\r\n\r\nconst scheduleHealthChecks = (): void => {\r\n  if (!isServerRuntime) {\r\n    return;\r\n  }\r\n\r\n  const config = getAIConfig();\r\n  if (!config.monitoring.enabled) {\r\n    stopScheduledHealthChecks();\r\n    return;\r\n  }\r\n\r\n  const interval = Math.max(10000, config.monitoring.healthCheckIntervalMs);\r\n\r\n  const trigger = () => {\r\n    if (healthCheckPromise) {\r\n      return;\r\n    }\r\n\r\n    healthCheckPromise = runScheduledHealthChecks()\r\n      .catch((error) => {\r\n        console.error('AI provider health check cycle failed', error);\r\n      })\r\n      .finally(() => {\r\n        healthCheckPromise = null;\r\n      });\r\n  };\r\n\r\n  trigger();\r\n  stopScheduledHealthChecks();\r\n  healthCheckTimer = setInterval(trigger, interval);\r\n};\r\n\r\nconst ensureHealthMonitoring = (): void => {\r\n  if (!isServerRuntime) {\r\n    return;\r\n  }\r\n\r\n  if (!healthCheckTimer && !healthCheckPromise) {\r\n    scheduleHealthChecks();\r\n  }\r\n};\r\n\r\nconst restartHealthMonitoring = (): void => {\r\n  if (!isServerRuntime) {\r\n    return;\r\n  }\r\n\r\n  stopScheduledHealthChecks();\r\n  scheduleHealthChecks();\r\n};\r\n\r\nif (isServerRuntime) {\r\n  ensureHealthMonitoring();\r\n}\r\n\r\nexport const getProviderClient = (providerId: AIProviderId): AIClient => getOrCreateProviderClient(providerId);\r\n\r\nexport const getProviderClientsForFallback = (preferred?: AIProviderId): AIClient[] => {\r\n  const chain = getProviderFallbackChain(preferred);\r\n  return chain.map((providerId) => getOrCreateProviderClient(providerId));\r\n};\r\n\r\nexport const getProviderHealthStatus = (providerId: AIProviderId): AIProviderHealth => getHealthSnapshot(providerId);\r\n\r\nexport const getAllProviderHealthStatus = (): AIProviderHealth[] => AI_PROVIDER_IDS.map((providerId) => getHealthSnapshot(providerId));\r\n\r\nexport const onAIUsage = (listener: UsageListener): (() => void) => {\r\n  usageListeners.add(listener);\r\n  return () => usageListeners.delete(listener);\r\n};\r\n\r\nexport const removeAIUsageListeners = (): void => {\r\n  usageListeners.clear();\r\n};\r\n\r\nexport const restartAIHealthMonitoring = (): void => {\r\n  restartHealthMonitoring();\r\n};\r\n\r\nexport const stopAIHealthMonitoring = (): void => {\r\n  stopScheduledHealthChecks();\r\n};\r\n\r\nexport const ensureAIHealthMonitoring = (): void => {\r\n  ensureHealthMonitoring();\r\n};\r\n\r\nonAIConfigChange(() => {\r\n  providerClientCache.clear();\r\n  for (const providerId of AI_PROVIDER_IDS) {\r\n    providerHealthState[providerId] = createInitialHealth(providerId);\r\n  }\r\n  restartHealthMonitoring();\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\AIAssistantService.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":325,"column":7,"nodeType":"TemplateLiteral","endLine":333,"endColumn":8}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '@/lib/database';\nimport { AIChatService, type ConversationOptions } from './chat';\nimport type { AIServiceBaseOptions, AIServiceResponse } from './base';\nimport type { AIChatMessage } from '@/types/ai';\n\nexport interface AssistantContext {\n  orgId: string;\n  userId: string;\n  userRole?: string;\n  capabilities?: string[];\n}\n\nexport interface AssistantMessage {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n  context?: Record<string, any>;\n}\n\nexport interface AssistantResponse {\n  message: string;\n  suggestions?: string[];\n  actions?: Array<{\n    type: string;\n    label: string;\n    data: any;\n  }>;\n  metadata?: Record<string, any>;\n}\n\nexport class AIAssistantService extends AIChatService {\n  constructor(options?: AIServiceBaseOptions) {\n    super(options);\n  }\n\n  /**\n   * Start a new conversation with context\n   */\n  async startConversation(\n    context: AssistantContext,\n    initialMessage?: string,\n  ): Promise<{ conversationId: string; response?: AssistantResponse }> {\n    const systemPrompt = this.buildSystemPrompt(context);\n\n    const conversationOptions: ConversationOptions = {\n      systemPrompt,\n      metadata: {\n        orgId: context.orgId,\n        userId: context.userId,\n        startedAt: new Date().toISOString(),\n      },\n    };\n\n    const conversation = this.createConversation(conversationOptions);\n\n    // Store in database\n    await this.storeMessage(context.orgId, context.userId, conversation.id, {\n      role: 'system',\n      content: systemPrompt,\n    });\n\n    if (initialMessage) {\n      const response = await this.sendMessage(\n        context,\n        conversation.id,\n        initialMessage,\n      );\n      return {\n        conversationId: conversation.id,\n        response: response.data,\n      };\n    }\n\n    return { conversationId: conversation.id };\n  }\n\n  /**\n   * Send a message and get AI response\n   */\n  async sendMessage(\n    context: AssistantContext,\n    conversationId: string,\n    message: string,\n  ): Promise<AIServiceResponse<AssistantResponse>> {\n    // Store user message\n    await this.storeMessage(context.orgId, context.userId, conversationId, {\n      role: 'user',\n      content: message,\n    });\n\n    // Augment message with relevant context\n    const enhancedMessage = await this.enhanceMessageWithContext(\n      context,\n      message,\n    );\n\n    // Get AI response\n    const chatMessage: AIChatMessage = {\n      role: 'user',\n      content: enhancedMessage,\n    };\n\n    const response = await this.continueConversation(\n      conversationId,\n      chatMessage,\n      {\n        conversationId,\n        metadata: { orgId: context.orgId, userId: context.userId },\n      },\n    );\n\n    if (!response.success || !response.data) {\n      return response as any;\n    }\n\n    // Parse AI response for structured data\n    const assistantResponse = this.parseAssistantResponse(response.data.text);\n\n    // Store assistant message\n    await this.storeMessage(context.orgId, context.userId, conversationId, {\n      role: 'assistant',\n      content: response.data.text,\n      context: assistantResponse.metadata,\n    });\n\n    return {\n      ...response,\n      data: assistantResponse,\n    };\n  }\n\n  /**\n   * Get conversation history\n   */\n  async getHistory(\n    context: AssistantContext,\n    conversationId: string,\n    limit: number = 50,\n  ): Promise<AssistantMessage[]> {\n    const result = await db.query(\n      `\n      SELECT role, content, context, created_at\n      FROM ai_conversation\n      WHERE org_id = $1\n        AND user_id = $2\n        AND conversation_id = $3\n      ORDER BY created_at DESC\n      LIMIT $4\n      `,\n      [context.orgId, context.userId, conversationId, limit],\n    );\n\n    return result.rows.reverse().map((row) => ({\n      role: row.role,\n      content: row.content,\n      context: row.context,\n    }));\n  }\n\n  /**\n   * List user conversations\n   */\n  async listConversations(\n    context: AssistantContext,\n    limit: number = 20,\n  ): Promise<Array<{ id: string; lastMessage: string; lastActivity: Date }>> {\n    const result = await db.query(\n      `\n      SELECT DISTINCT ON (conversation_id)\n        conversation_id as id,\n        content as last_message,\n        created_at as last_activity\n      FROM ai_conversation\n      WHERE org_id = $1\n        AND user_id = $2\n        AND role != 'system'\n      ORDER BY conversation_id, created_at DESC\n      LIMIT $3\n      `,\n      [context.orgId, context.userId, limit],\n    );\n\n    return result.rows.map((row) => ({\n      id: row.id,\n      lastMessage: row.last_message.substring(0, 100),\n      lastActivity: row.last_activity,\n    }));\n  }\n\n  /**\n   * Delete a conversation\n   */\n  async deleteConversation(\n    context: AssistantContext,\n    conversationId: string,\n  ): Promise<void> {\n    await db.query(\n      `\n      DELETE FROM ai_conversation\n      WHERE org_id = $1\n        AND user_id = $2\n        AND conversation_id = $3\n      `,\n      [context.orgId, context.userId, conversationId],\n    );\n\n    this.closeConversation(conversationId);\n  }\n\n  /**\n   * Build system prompt based on context\n   */\n  private buildSystemPrompt(context: AssistantContext): string {\n    const capabilities = context.capabilities || [\n      'inventory_management',\n      'supplier_information',\n      'analytics',\n      'forecasting',\n    ];\n\n    return `\nYou are an AI assistant for MantisNXT, an inventory and supplier management system.\n\nUser Role: ${context.userRole || 'user'}\nAvailable Capabilities: ${capabilities.join(', ')}\n\nYour responsibilities:\n1. Answer questions about inventory, suppliers, and analytics\n2. Provide data-driven insights and recommendations\n3. Help users navigate the system and understand features\n4. Suggest actions based on current data and trends\n\nGuidelines:\n- Be concise and actionable\n- Use data from the system when available\n- Suggest specific actions when appropriate\n- Format responses clearly\n- If you can't answer something, say so clearly\n\nWhen responding:\n- Use natural, professional language\n- Provide specific numbers when available\n- Suggest next steps or actions when relevant\n- Format lists and data clearly\n\nAvailable actions you can suggest:\n- view_product: Show product details\n- view_supplier: Show supplier details\n- create_order: Create a purchase order\n- view_forecast: Show demand forecast\n- view_analytics: Show analytics dashboard\n`.trim();\n  }\n\n  /**\n   * Enhance message with relevant context data\n   */\n  private async enhanceMessageWithContext(\n    context: AssistantContext,\n    message: string,\n  ): Promise<string> {\n    const lowerMessage = message.toLowerCase();\n\n    // Check for product-related queries\n    if (lowerMessage.includes('product') || lowerMessage.includes('inventory')) {\n      const productContext = await this.getRecentProducts(context.orgId, 5);\n      if (productContext.length > 0) {\n        return `${message}\\n\\nContext - Recent products: ${JSON.stringify(productContext)}`;\n      }\n    }\n\n    // Check for supplier-related queries\n    if (lowerMessage.includes('supplier')) {\n      const supplierContext = await this.getTopSuppliers(context.orgId, 5);\n      if (supplierContext.length > 0) {\n        return `${message}\\n\\nContext - Top suppliers: ${JSON.stringify(supplierContext)}`;\n      }\n    }\n\n    // Check for alert-related queries\n    if (lowerMessage.includes('alert') || lowerMessage.includes('issue')) {\n      const alertContext = await this.getRecentAlerts(context.orgId, 3);\n      if (alertContext.length > 0) {\n        return `${message}\\n\\nContext - Recent alerts: ${JSON.stringify(alertContext)}`;\n      }\n    }\n\n    return message;\n  }\n\n  /**\n   * Get recent products for context\n   */\n  private async getRecentProducts(\n    orgId: string,\n    limit: number,\n  ): Promise<Array<{ name: string; quantity: number; category: string }>> {\n    const result = await db.query(\n      `\n      SELECT p.name, soh.quantity, c.name as category\n      FROM products p\n      LEFT JOIN stock_on_hand soh ON soh.product_id = p.id\n      LEFT JOIN categories c ON c.id = p.category_id\n      WHERE current_setting('app.current_org_id', true)::uuid = $1\n      ORDER BY p.created_at DESC\n      LIMIT $2\n      `,\n      [orgId, limit],\n    );\n\n    return result.rows.map((row) => ({\n      name: row.name,\n      quantity: parseFloat(row.quantity) || 0,\n      category: row.category || 'Uncategorized',\n    }));\n  }\n\n  /**\n   * Get top suppliers for context\n   */\n  private async getTopSuppliers(\n    orgId: string,\n    limit: number,\n  ): Promise<Array<{ name: string; totalOrders: number }>> {\n    const result = await db.query(\n      `\n      SELECT s.name, COUNT(po.id) as total_orders\n      FROM suppliers s\n      LEFT JOIN purchase_orders po ON po.supplier_id = s.id\n      WHERE current_setting('app.current_org_id', true)::uuid = $1\n      GROUP BY s.id, s.name\n      ORDER BY total_orders DESC\n      LIMIT $2\n      `,\n      [orgId, limit],\n    );\n\n    return result.rows.map((row) => ({\n      name: row.name,\n      totalOrders: parseInt(row.total_orders) || 0,\n    }));\n  }\n\n  /**\n   * Get recent alerts for context\n   */\n  private async getRecentAlerts(\n    orgId: string,\n    limit: number,\n  ): Promise<Array<{ severity: string; title: string }>> {\n    const result = await db.query(\n      `\n      SELECT severity, title\n      FROM ai_alert\n      WHERE org_id = $1\n        AND is_resolved = false\n      ORDER BY created_at DESC\n      LIMIT $2\n      `,\n      [orgId, limit],\n    );\n\n    return result.rows;\n  }\n\n  /**\n   * Parse AI response for structured data\n   */\n  private parseAssistantResponse(text: string): AssistantResponse {\n    const response: AssistantResponse = {\n      message: text,\n      suggestions: [],\n      actions: [],\n      metadata: {},\n    };\n\n    // Try to extract structured actions from response\n    const actionPattern = /ACTION:\\s*(\\w+)\\s*-\\s*(.+)/gi;\n    let match;\n    while ((match = actionPattern.exec(text)) !== null) {\n      response.actions?.push({\n        type: match[1].toLowerCase(),\n        label: match[2].trim(),\n        data: {},\n      });\n    }\n\n    // Extract suggestions\n    const suggestionPattern = /SUGGESTION:\\s*(.+)/gi;\n    while ((match = suggestionPattern.exec(text)) !== null) {\n      response.suggestions?.push(match[1].trim());\n    }\n\n    // Clean message text (remove action/suggestion markers)\n    response.message = text\n      .replace(/ACTION:\\s*\\w+\\s*-\\s*.+/gi, '')\n      .replace(/SUGGESTION:\\s*.+/gi, '')\n      .trim();\n\n    return response;\n  }\n\n  /**\n   * Store message in database\n   */\n  private async storeMessage(\n    orgId: string,\n    userId: string,\n    conversationId: string,\n    message: AssistantMessage,\n  ): Promise<void> {\n    await db.query(\n      `\n      INSERT INTO ai_conversation (\n        org_id, user_id, conversation_id, role, content, context\n      )\n      VALUES ($1, $2, $3, $4, $5, $6)\n      `,\n      [\n        orgId,\n        userId,\n        conversationId,\n        message.role,\n        message.content,\n        JSON.stringify(message.context || {}),\n      ],\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\AIServiceConfigService.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\nimport { db } from '@/lib/database';\nimport {\n  AIServiceBase,\n  type AIServiceBaseOptions,\n  type AIServiceRequestOptions,\n  type AIServiceResponse,\n} from './base';\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type AIServiceType =\n  | 'demand_forecasting'\n  | 'supplier_scoring'\n  | 'anomaly_detection'\n  | 'sentiment_analysis'\n  | 'recommendation_engine'\n  | 'chatbot'\n  | 'document_analysis';\n\nexport type AIProvider = 'openai' | 'anthropic' | 'azure_openai' | 'bedrock';\n\nexport interface AIServiceConfig {\n  id: string;\n  orgId: string;\n  serviceType: AIServiceType;\n  isEnabled: boolean;\n  provider: AIProvider;\n  modelName: string;\n  apiEndpoint?: string;\n  config: Record<string, any>;\n  rateLimitPerHour: number;\n  createdAt: Date;\n  updatedAt: Date;\n  createdBy?: string;\n  updatedBy?: string;\n}\n\nexport interface CreateConfigData {\n  serviceType: AIServiceType;\n  provider?: AIProvider;\n  modelName: string;\n  apiEndpoint?: string;\n  config?: Record<string, any>;\n  rateLimitPerHour?: number;\n  createdBy?: string;\n}\n\nexport interface UpdateConfigData {\n  provider?: AIProvider;\n  modelName?: string;\n  apiEndpoint?: string;\n  config?: Record<string, any>;\n  rateLimitPerHour?: number;\n  updatedBy?: string;\n}\n\nexport interface ConnectionTestResult {\n  success: boolean;\n  provider: AIProvider;\n  model: string;\n  latencyMs: number;\n  error?: string;\n}\n\nexport interface RateLimitStatus {\n  allowed: boolean;\n  currentUsage: number;\n  limit: number;\n  resetAt: Date;\n  remainingCalls: number;\n}\n\n// ============================================================================\n// Service Implementation\n// ============================================================================\n\nexport class AIServiceConfigService extends AIServiceBase<AIServiceRequestOptions> {\n  constructor(options?: AIServiceBaseOptions) {\n    super('AIServiceConfigService', options);\n  }\n\n  /**\n   * Create a new AI service configuration\n   */\n  async createConfig(\n    orgId: string,\n    config: CreateConfigData,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<AIServiceConfig>> {\n    return this.executeOperation(\n      'config.create',\n      async () => {\n        const result = await db.query(\n          `\n          INSERT INTO ai_service_config (\n            org_id, service_type, provider, model_name,\n            api_endpoint, config, rate_limit_per_hour, created_by\n          )\n          VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\n          RETURNING *\n          `,\n          [\n            orgId,\n            config.serviceType,\n            config.provider || 'openai',\n            config.modelName,\n            config.apiEndpoint,\n            JSON.stringify(config.config || {}),\n            config.rateLimitPerHour || 1000,\n            config.createdBy,\n          ],\n        );\n\n        return this.mapConfigRow(result.rows[0]);\n      },\n      options,\n      { orgId, serviceType: config.serviceType },\n    );\n  }\n\n  /**\n   * Update an existing AI service configuration\n   */\n  async updateConfig(\n    configId: string,\n    updates: UpdateConfigData,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<AIServiceConfig>> {\n    return this.executeOperation(\n      'config.update',\n      async () => {\n        const setClauses: string[] = [];\n        const values: any[] = [];\n        let paramIndex = 1;\n\n        if (updates.provider !== undefined) {\n          setClauses.push(`provider = $${paramIndex++}`);\n          values.push(updates.provider);\n        }\n        if (updates.modelName !== undefined) {\n          setClauses.push(`model_name = $${paramIndex++}`);\n          values.push(updates.modelName);\n        }\n        if (updates.apiEndpoint !== undefined) {\n          setClauses.push(`api_endpoint = $${paramIndex++}`);\n          values.push(updates.apiEndpoint);\n        }\n        if (updates.config !== undefined) {\n          setClauses.push(`config = $${paramIndex++}`);\n          values.push(JSON.stringify(updates.config));\n        }\n        if (updates.rateLimitPerHour !== undefined) {\n          setClauses.push(`rate_limit_per_hour = $${paramIndex++}`);\n          values.push(updates.rateLimitPerHour);\n        }\n        if (updates.updatedBy !== undefined) {\n          setClauses.push(`updated_by = $${paramIndex++}`);\n          values.push(updates.updatedBy);\n        }\n\n        if (setClauses.length === 0) {\n          throw new Error('No valid updates provided');\n        }\n\n        values.push(configId);\n\n        const result = await db.query(\n          `\n          UPDATE ai_service_config\n          SET ${setClauses.join(', ')}, updated_at = NOW()\n          WHERE id = $${paramIndex}\n          RETURNING *\n          `,\n          values,\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(`Configuration ${configId} not found`);\n        }\n\n        return this.mapConfigRow(result.rows[0]);\n      },\n      options,\n      { configId },\n    );\n  }\n\n  /**\n   * Delete an AI service configuration\n   */\n  async deleteConfig(\n    configId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'config.delete',\n      async () => {\n        const result = await db.query(\n          `\n          DELETE FROM ai_service_config\n          WHERE id = $1\n          RETURNING id\n          `,\n          [configId],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(`Configuration ${configId} not found`);\n        }\n      },\n      options,\n      { configId },\n    );\n  }\n\n  /**\n   * Get AI service configuration\n   */\n  async getConfig(\n    orgId: string,\n    serviceType: AIServiceType,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<AIServiceConfig | null>> {\n    return this.executeOperation(\n      'config.get',\n      async () => {\n        const result = await db.query(\n          `\n          SELECT * FROM ai_service_config\n          WHERE org_id = $1 AND service_type = $2\n          `,\n          [orgId, serviceType],\n        );\n\n        if (result.rows.length === 0) {\n          return null;\n        }\n\n        return this.mapConfigRow(result.rows[0]);\n      },\n      options,\n      { orgId, serviceType },\n    );\n  }\n\n  /**\n   * List all AI service configurations for an organization\n   */\n  async listConfigs(\n    orgId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<AIServiceConfig[]>> {\n    return this.executeOperation(\n      'config.list',\n      async () => {\n        const result = await db.query(\n          `\n          SELECT * FROM ai_service_config\n          WHERE org_id = $1\n          ORDER BY service_type\n          `,\n          [orgId],\n        );\n\n        return result.rows.map((row) => this.mapConfigRow(row));\n      },\n      options,\n      { orgId },\n    );\n  }\n\n  /**\n   * Enable an AI service\n   */\n  async enableService(\n    orgId: string,\n    serviceType: AIServiceType,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'config.enable',\n      async () => {\n        const result = await db.query(\n          `\n          UPDATE ai_service_config\n          SET is_enabled = true, updated_at = NOW()\n          WHERE org_id = $1 AND service_type = $2\n          RETURNING id\n          `,\n          [orgId, serviceType],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(\n            `No configuration found for service type ${serviceType}`,\n          );\n        }\n      },\n      options,\n      { orgId, serviceType, action: 'enable' },\n    );\n  }\n\n  /**\n   * Disable an AI service\n   */\n  async disableService(\n    orgId: string,\n    serviceType: AIServiceType,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'config.disable',\n      async () => {\n        const result = await db.query(\n          `\n          UPDATE ai_service_config\n          SET is_enabled = false, updated_at = NOW()\n          WHERE org_id = $1 AND service_type = $2\n          RETURNING id\n          `,\n          [orgId, serviceType],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(\n            `No configuration found for service type ${serviceType}`,\n          );\n        }\n      },\n      options,\n      { orgId, serviceType, action: 'disable' },\n    );\n  }\n\n  /**\n   * Update provider for a service\n   */\n  async updateProvider(\n    orgId: string,\n    serviceType: AIServiceType,\n    provider: AIProvider,\n    modelName: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'config.updateProvider',\n      async () => {\n        const result = await db.query(\n          `\n          UPDATE ai_service_config\n          SET provider = $1, model_name = $2, updated_at = NOW()\n          WHERE org_id = $3 AND service_type = $4\n          RETURNING id\n          `,\n          [provider, modelName, orgId, serviceType],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(\n            `No configuration found for service type ${serviceType}`,\n          );\n        }\n      },\n      options,\n      { orgId, serviceType, provider, modelName },\n    );\n  }\n\n  /**\n   * Test connection to AI provider\n   */\n  async testConnection(\n    configId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<ConnectionTestResult>> {\n    return this.executeOperation(\n      'config.testConnection',\n      async ({ service }) => {\n        // Get config\n        const configResult = await db.query(\n          `\n          SELECT * FROM ai_service_config WHERE id = $1\n          `,\n          [configId],\n        );\n\n        if (configResult.rows.length === 0) {\n          throw new Error(`Configuration ${configId} not found`);\n        }\n\n        const config = this.mapConfigRow(configResult.rows[0]);\n        const startTime = Date.now();\n\n        try {\n          // Test with a simple prompt\n          const response = await service.generateText('Test connection', {\n            provider: config.provider as any,\n            model: config.modelName,\n            maxTokens: 10,\n            temperature: 0,\n          });\n\n          const latencyMs = Date.now() - startTime;\n\n          return {\n            success: true,\n            provider: config.provider,\n            model: config.modelName,\n            latencyMs,\n          };\n        } catch (error) {\n          const latencyMs = Date.now() - startTime;\n          const errorMessage =\n            error instanceof Error ? error.message : String(error);\n\n          return {\n            success: false,\n            provider: config.provider,\n            model: config.modelName,\n            latencyMs,\n            error: errorMessage,\n          };\n        }\n      },\n      options,\n      { configId },\n    );\n  }\n\n  /**\n   * Check rate limit status\n   */\n  async checkRateLimit(\n    orgId: string,\n    serviceType: AIServiceType,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<RateLimitStatus>> {\n    return this.executeOperation(\n      'config.checkRateLimit',\n      async () => {\n        // Get config\n        const configResult = await db.query(\n          `\n          SELECT rate_limit_per_hour FROM ai_service_config\n          WHERE org_id = $1 AND service_type = $2\n          `,\n          [orgId, serviceType],\n        );\n\n        if (configResult.rows.length === 0) {\n          throw new Error(\n            `No configuration found for service type ${serviceType}`,\n          );\n        }\n\n        const limit = configResult.rows[0].rate_limit_per_hour;\n\n        // Count recent usage (last hour)\n        const usageResult = await db.query(\n          `\n          SELECT COUNT(*) as usage_count\n          FROM ai_prediction\n          WHERE org_id = $1\n            AND service_type = $2\n            AND created_at >= NOW() - INTERVAL '1 hour'\n          `,\n          [orgId, serviceType],\n        );\n\n        const currentUsage = parseInt(usageResult.rows[0]?.usage_count || '0');\n        const remainingCalls = Math.max(0, limit - currentUsage);\n\n        // Calculate reset time (top of next hour)\n        const now = new Date();\n        const resetAt = new Date(now);\n        resetAt.setHours(resetAt.getHours() + 1, 0, 0, 0);\n\n        return {\n          allowed: currentUsage < limit,\n          currentUsage,\n          limit,\n          resetAt,\n          remainingCalls,\n        };\n      },\n      options,\n      { orgId, serviceType },\n    );\n  }\n\n  /**\n   * Update rate limit for a configuration\n   */\n  async updateRateLimit(\n    configId: string,\n    rateLimit: number,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'config.updateRateLimit',\n      async () => {\n        if (rateLimit < 0) {\n          throw new Error('Rate limit must be non-negative');\n        }\n\n        const result = await db.query(\n          `\n          UPDATE ai_service_config\n          SET rate_limit_per_hour = $1, updated_at = NOW()\n          WHERE id = $2\n          RETURNING id\n          `,\n          [rateLimit, configId],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(`Configuration ${configId} not found`);\n        }\n      },\n      options,\n      { configId, rateLimit },\n    );\n  }\n\n  /**\n   * Map database row to AIServiceConfig\n   */\n  private mapConfigRow(row: any): AIServiceConfig {\n    return {\n      id: row.id,\n      orgId: row.org_id,\n      serviceType: row.service_type,\n      isEnabled: row.is_enabled,\n      provider: row.provider,\n      modelName: row.model_name,\n      apiEndpoint: row.api_endpoint,\n      config: row.config || {},\n      rateLimitPerHour: row.rate_limit_per_hour,\n      createdAt: new Date(row.created_at),\n      updatedAt: new Date(row.updated_at),\n      createdBy: row.created_by,\n      updatedBy: row.updated_by,\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\AnalyticsWidgetService.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":459,"column":7,"nodeType":"TemplateLiteral","endLine":465,"endColumn":8}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '@/lib/database';\nimport {\n  AIServiceBase,\n  type AIServiceBaseOptions,\n  type AIServiceRequestOptions,\n  type AIServiceResponse,\n} from './base';\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type WidgetType = 'chart' | 'kpi' | 'table' | 'map';\n\nexport type AnalyticsMetricType =\n  | 'sales'\n  | 'inventory'\n  | 'supplier_performance'\n  | 'customer_behavior'\n  | 'financial'\n  | 'operational';\n\nexport interface AnalyticsWidget {\n  id: string;\n  orgId: string;\n  dashboardId: string;\n  widgetType: WidgetType;\n  metricType: AnalyticsMetricType;\n  config: Record<string, any>;\n  query: Record<string, any>;\n  refreshIntervalSeconds: number;\n  positionX: number;\n  positionY: number;\n  width: number;\n  height: number;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface CreateWidgetData {\n  dashboardId: string;\n  widgetType: WidgetType;\n  metricType: AnalyticsMetricType;\n  config?: Record<string, any>;\n  query?: Record<string, any>;\n  refreshIntervalSeconds?: number;\n  positionX?: number;\n  positionY?: number;\n  width?: number;\n  height?: number;\n}\n\nexport interface UpdateWidgetData {\n  widgetType?: WidgetType;\n  metricType?: AnalyticsMetricType;\n  config?: Record<string, any>;\n  query?: Record<string, any>;\n  refreshIntervalSeconds?: number;\n}\n\n// ============================================================================\n// Service Implementation\n// ============================================================================\n\nexport class AnalyticsWidgetService extends AIServiceBase<AIServiceRequestOptions> {\n  constructor(options?: AIServiceBaseOptions) {\n    super('AnalyticsWidgetService', options);\n  }\n\n  /**\n   * Create a new widget\n   */\n  async createWidget(\n    orgId: string,\n    data: CreateWidgetData,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<AnalyticsWidget>> {\n    return this.executeOperation(\n      'widget.create',\n      async () => {\n        // Verify dashboard belongs to org\n        const dashboardResult = await db.query(\n          `SELECT id FROM analytics_dashboard WHERE id = $1 AND org_id = $2`,\n          [data.dashboardId, orgId],\n        );\n\n        if (dashboardResult.rows.length === 0) {\n          throw new Error(\n            `Dashboard ${data.dashboardId} not found or access denied`,\n          );\n        }\n\n        const result = await db.query(\n          `\n          INSERT INTO analytics_widget (\n            org_id, dashboard_id, widget_type, metric_type,\n            config, query, refresh_interval_seconds,\n            position_x, position_y, width, height\n          )\n          VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)\n          RETURNING *\n          `,\n          [\n            orgId,\n            data.dashboardId,\n            data.widgetType,\n            data.metricType,\n            JSON.stringify(data.config || {}),\n            JSON.stringify(data.query || {}),\n            data.refreshIntervalSeconds || 300,\n            data.positionX || 0,\n            data.positionY || 0,\n            data.width || 1,\n            data.height || 1,\n          ],\n        );\n\n        return this.mapWidgetRow(result.rows[0]);\n      },\n      options,\n      { orgId, dashboardId: data.dashboardId, widgetType: data.widgetType },\n    );\n  }\n\n  /**\n   * Update an existing widget\n   */\n  async updateWidget(\n    widgetId: string,\n    updates: UpdateWidgetData,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<AnalyticsWidget>> {\n    return this.executeOperation(\n      'widget.update',\n      async () => {\n        const setClauses: string[] = [];\n        const values: any[] = [];\n        let paramIndex = 1;\n\n        if (updates.widgetType !== undefined) {\n          setClauses.push(`widget_type = $${paramIndex++}`);\n          values.push(updates.widgetType);\n        }\n        if (updates.metricType !== undefined) {\n          setClauses.push(`metric_type = $${paramIndex++}`);\n          values.push(updates.metricType);\n        }\n        if (updates.config !== undefined) {\n          setClauses.push(`config = $${paramIndex++}`);\n          values.push(JSON.stringify(updates.config));\n        }\n        if (updates.query !== undefined) {\n          setClauses.push(`query = $${paramIndex++}`);\n          values.push(JSON.stringify(updates.query));\n        }\n        if (updates.refreshIntervalSeconds !== undefined) {\n          setClauses.push(`refresh_interval_seconds = $${paramIndex++}`);\n          values.push(updates.refreshIntervalSeconds);\n        }\n\n        if (setClauses.length === 0) {\n          throw new Error('No valid updates provided');\n        }\n\n        values.push(widgetId);\n\n        const result = await db.query(\n          `\n          UPDATE analytics_widget\n          SET ${setClauses.join(', ')}, updated_at = NOW()\n          WHERE id = $${paramIndex}\n          RETURNING *\n          `,\n          values,\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(`Widget ${widgetId} not found`);\n        }\n\n        return this.mapWidgetRow(result.rows[0]);\n      },\n      options,\n      { widgetId },\n    );\n  }\n\n  /**\n   * Delete a widget\n   */\n  async deleteWidget(\n    widgetId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'widget.delete',\n      async () => {\n        const result = await db.query(\n          `\n          DELETE FROM analytics_widget\n          WHERE id = $1\n          RETURNING id\n          `,\n          [widgetId],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(`Widget ${widgetId} not found`);\n        }\n      },\n      options,\n      { widgetId },\n    );\n  }\n\n  /**\n   * Get a single widget by ID\n   */\n  async getWidget(\n    widgetId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<AnalyticsWidget>> {\n    return this.executeOperation(\n      'widget.get',\n      async () => {\n        const result = await db.query(\n          `\n          SELECT * FROM analytics_widget\n          WHERE id = $1\n          `,\n          [widgetId],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(`Widget ${widgetId} not found`);\n        }\n\n        return this.mapWidgetRow(result.rows[0]);\n      },\n      options,\n      { widgetId },\n    );\n  }\n\n  /**\n   * Get all widgets for a dashboard\n   */\n  async getWidgetsByDashboard(\n    dashboardId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<AnalyticsWidget[]>> {\n    return this.executeOperation(\n      'widget.getByDashboard',\n      async () => {\n        const result = await db.query(\n          `\n          SELECT * FROM analytics_widget\n          WHERE dashboard_id = $1\n          ORDER BY position_y, position_x\n          `,\n          [dashboardId],\n        );\n\n        return result.rows.map((row) => this.mapWidgetRow(row));\n      },\n      options,\n      { dashboardId },\n    );\n  }\n\n  /**\n   * Fetch widget data based on query configuration\n   */\n  async fetchWidgetData(\n    widgetId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<any>> {\n    return this.executeOperation(\n      'widget.fetchData',\n      async () => {\n        // Get widget configuration\n        const widgetResult = await db.query(\n          `SELECT * FROM analytics_widget WHERE id = $1`,\n          [widgetId],\n        );\n\n        if (widgetResult.rows.length === 0) {\n          throw new Error(`Widget ${widgetId} not found`);\n        }\n\n        const widget = this.mapWidgetRow(widgetResult.rows[0]);\n\n        // Execute query based on metric type\n        const data = await this.executeWidgetQuery(widget);\n\n        return data;\n      },\n      options,\n      { widgetId },\n    );\n  }\n\n  /**\n   * Refresh widget data (alias for fetchWidgetData)\n   */\n  async refreshWidget(\n    widgetId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<any>> {\n    return this.fetchWidgetData(widgetId, options);\n  }\n\n  /**\n   * Update widget position\n   */\n  async updatePosition(\n    widgetId: string,\n    x: number,\n    y: number,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'widget.updatePosition',\n      async () => {\n        const result = await db.query(\n          `\n          UPDATE analytics_widget\n          SET position_x = $1, position_y = $2, updated_at = NOW()\n          WHERE id = $3\n          RETURNING id\n          `,\n          [x, y, widgetId],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(`Widget ${widgetId} not found`);\n        }\n      },\n      options,\n      { widgetId, x, y },\n    );\n  }\n\n  /**\n   * Update widget size\n   */\n  async updateSize(\n    widgetId: string,\n    width: number,\n    height: number,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'widget.updateSize',\n      async () => {\n        if (width < 1 || height < 1) {\n          throw new Error('Widget dimensions must be at least 1');\n        }\n\n        const result = await db.query(\n          `\n          UPDATE analytics_widget\n          SET width = $1, height = $2, updated_at = NOW()\n          WHERE id = $3\n          RETURNING id\n          `,\n          [width, height, widgetId],\n        );\n\n        if (result.rows.length === 0) {\n          throw new Error(`Widget ${widgetId} not found`);\n        }\n      },\n      options,\n      { widgetId, width, height },\n    );\n  }\n\n  /**\n   * Execute widget query based on metric type\n   */\n  private async executeWidgetQuery(\n    widget: AnalyticsWidget,\n  ): Promise<any> {\n    const { metricType, query, config } = widget;\n\n    switch (metricType) {\n      case 'sales':\n        return this.fetchSalesData(widget.orgId, query);\n      case 'inventory':\n        return this.fetchInventoryData(widget.orgId, query);\n      case 'supplier_performance':\n        return this.fetchSupplierPerformanceData(widget.orgId, query);\n      case 'customer_behavior':\n        return this.fetchCustomerBehaviorData(widget.orgId, query);\n      case 'financial':\n        return this.fetchFinancialData(widget.orgId, query);\n      case 'operational':\n        return this.fetchOperationalData(widget.orgId, query);\n      default:\n        throw new Error(`Unsupported metric type: ${metricType}`);\n    }\n  }\n\n  /**\n   * Fetch sales metrics\n   */\n  private async fetchSalesData(\n    orgId: string,\n    query: Record<string, any>,\n  ): Promise<any> {\n    // Simplified sales query - would be more complex in production\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(*) as total_orders,\n        SUM(total_amount) as total_revenue,\n        AVG(total_amount) as avg_order_value\n      FROM orders\n      WHERE org_id = $1\n        AND created_at >= NOW() - INTERVAL '30 days'\n      `,\n      [orgId],\n    );\n\n    return result.rows[0] || {};\n  }\n\n  /**\n   * Fetch inventory metrics\n   */\n  private async fetchInventoryData(\n    orgId: string,\n    query: Record<string, any>,\n  ): Promise<any> {\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(*) as total_products,\n        SUM(stock_level) as total_stock,\n        COUNT(*) FILTER (WHERE stock_level <= reorder_point) as low_stock_count\n      FROM products\n      WHERE org_id = $1\n      `,\n      [orgId],\n    );\n\n    return result.rows[0] || {};\n  }\n\n  /**\n   * Fetch supplier performance metrics\n   */\n  private async fetchSupplierPerformanceData(\n    orgId: string,\n    query: Record<string, any>,\n  ): Promise<any> {\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(DISTINCT id) as total_suppliers,\n        AVG(rating) as avg_rating\n      FROM suppliers\n      WHERE org_id = $1\n      `,\n      [orgId],\n    );\n\n    return result.rows[0] || {};\n  }\n\n  /**\n   * Fetch customer behavior metrics\n   */\n  private async fetchCustomerBehaviorData(\n    orgId: string,\n    query: Record<string, any>,\n  ): Promise<any> {\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(DISTINCT id) as total_customers,\n        COUNT(DISTINCT id) FILTER (\n          WHERE last_order_date >= NOW() - INTERVAL '30 days'\n        ) as active_customers\n      FROM customers\n      WHERE org_id = $1\n      `,\n      [orgId],\n    );\n\n    return result.rows[0] || {};\n  }\n\n  /**\n   * Fetch financial metrics\n   */\n  private async fetchFinancialData(\n    orgId: string,\n    query: Record<string, any>,\n  ): Promise<any> {\n    // Placeholder - would integrate with actual financial tables\n    return {\n      revenue: 0,\n      expenses: 0,\n      profit: 0,\n    };\n  }\n\n  /**\n   * Fetch operational metrics\n   */\n  private async fetchOperationalData(\n    orgId: string,\n    query: Record<string, any>,\n  ): Promise<any> {\n    // Placeholder - would integrate with actual operational tables\n    return {\n      efficiency: 0,\n      throughput: 0,\n      utilization: 0,\n    };\n  }\n\n  /**\n   * Map database row to AnalyticsWidget\n   */\n  private mapWidgetRow(row: any): AnalyticsWidget {\n    return {\n      id: row.id,\n      orgId: row.org_id,\n      dashboardId: row.dashboard_id,\n      widgetType: row.widget_type,\n      metricType: row.metric_type,\n      config: row.config || {},\n      query: row.query || {},\n      refreshIntervalSeconds: row.refresh_interval_seconds,\n      positionX: row.position_x,\n      positionY: row.position_y,\n      width: row.width,\n      height: row.height,\n      createdAt: new Date(row.created_at),\n      updatedAt: new Date(row.updated_at),\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\AnomalyDetectionService.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":163,"column":11,"nodeType":"TemplateLiteral","endLine":181,"endColumn":12}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '@/lib/database';\nimport {\n  AIServiceBase,\n  type AIServiceBaseOptions,\n  type AIServiceRequestOptions,\n  type AIServiceResponse,\n} from './base';\n\nexport interface Anomaly {\n  id: string;\n  type: string;\n  severity: 'info' | 'warning' | 'critical' | 'urgent';\n  title: string;\n  message: string;\n  affectedEntity: {\n    type: string;\n    id: string;\n    name?: string;\n  };\n  metrics: Record<string, number>;\n  recommendations: string[];\n  detectedAt: Date;\n}\n\nexport interface AnomalyDetectionConfig {\n  sensitivity: 'low' | 'medium' | 'high';\n  categories: string[];\n  thresholds?: Record<string, number>;\n}\n\nexport class AnomalyDetectionService extends AIServiceBase<AIServiceRequestOptions> {\n  constructor(options?: AIServiceBaseOptions) {\n    super('AnomalyDetectionService', options);\n  }\n\n  /**\n   * Detect anomalies in inventory levels\n   */\n  async detectInventoryAnomalies(\n    orgId: string,\n    config?: AnomalyDetectionConfig,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<Anomaly[]>> {\n    return this.executeOperation(\n      'anomaly.inventory',\n      async ({ service, runtimeOptions }) => {\n        const anomalies: Anomaly[] = [];\n\n        // Detect stock level anomalies\n        const stockAnomalies = await this.detectStockLevelAnomalies(orgId);\n        anomalies.push(...stockAnomalies);\n\n        // Detect unusual movement patterns\n        const movementAnomalies = await this.detectMovementAnomalies(orgId);\n        anomalies.push(...movementAnomalies);\n\n        // Get AI insights for detected anomalies\n        for (const anomaly of anomalies) {\n          const aiRecommendations = await this.getAIRecommendations(\n            service,\n            runtimeOptions,\n            anomaly,\n          );\n          anomaly.recommendations = aiRecommendations;\n        }\n\n        // Store alerts in database\n        await this.storeAlerts(orgId, anomalies);\n\n        return anomalies;\n      },\n      options,\n      { orgId, configSensitivity: config?.sensitivity || 'medium' },\n    );\n  }\n\n  /**\n   * Detect pricing anomalies\n   */\n  async detectPricingAnomalies(\n    orgId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<Anomaly[]>> {\n    return this.executeOperation(\n      'anomaly.pricing',\n      async ({ service, runtimeOptions }) => {\n        const result = await db.query(\n          `\n          WITH price_stats AS (\n            SELECT\n              p.id,\n              p.name,\n              pp.price,\n              AVG(pp.price) OVER (PARTITION BY p.id ORDER BY pp.created_at ROWS BETWEEN 30 PRECEDING AND CURRENT ROW) as avg_price,\n              STDDEV(pp.price) OVER (PARTITION BY p.id ORDER BY pp.created_at ROWS BETWEEN 30 PRECEDING AND CURRENT ROW) as stddev_price\n            FROM products p\n            JOIN pricelist_products pp ON pp.product_id = p.id\n            WHERE current_setting('app.current_org_id', true)::uuid = $1\n              AND pp.created_at >= NOW() - INTERVAL '90 days'\n          )\n          SELECT\n            id,\n            name,\n            price,\n            avg_price,\n            stddev_price,\n            ABS(price - avg_price) / NULLIF(stddev_price, 0) as z_score\n          FROM price_stats\n          WHERE ABS(price - avg_price) / NULLIF(stddev_price, 0) > 2\n          `,\n          [orgId],\n        );\n\n        const anomalies: Anomaly[] = result.rows.map((row) => ({\n          id: `price_${row.id}_${Date.now()}`,\n          type: 'price_deviation',\n          severity: parseFloat(row.z_score) > 3 ? 'critical' : 'warning',\n          title: `Unusual price change detected for ${row.name}`,\n          message: `Current price (${row.price}) deviates significantly from the 30-day average (${parseFloat(row.avg_price).toFixed(2)})`,\n          affectedEntity: {\n            type: 'product',\n            id: row.id,\n            name: row.name,\n          },\n          metrics: {\n            currentPrice: parseFloat(row.price),\n            averagePrice: parseFloat(row.avg_price),\n            zScore: parseFloat(row.z_score),\n          },\n          recommendations: [],\n          detectedAt: new Date(),\n        }));\n\n        // Get AI recommendations\n        for (const anomaly of anomalies) {\n          anomaly.recommendations = await this.getAIRecommendations(\n            service,\n            runtimeOptions,\n            anomaly,\n          );\n        }\n\n        await this.storeAlerts(orgId, anomalies);\n\n        return anomalies;\n      },\n      options,\n      { orgId },\n    );\n  }\n\n  /**\n   * Detect supplier performance anomalies\n   */\n  async detectSupplierAnomalies(\n    orgId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<Anomaly[]>> {\n    return this.executeOperation(\n      'anomaly.supplier',\n      async ({ service, runtimeOptions }) => {\n        const result = await db.query(\n          `\n          WITH supplier_metrics AS (\n            SELECT\n              s.id,\n              s.name,\n              COUNT(po.id) as total_orders,\n              AVG(CASE WHEN po.delivered_on_time THEN 1 ELSE 0 END) as on_time_rate,\n              AVG(EXTRACT(DAY FROM po.delivery_date - po.order_date)) as avg_delivery_days\n            FROM suppliers s\n            LEFT JOIN purchase_orders po ON po.supplier_id = s.id\n            WHERE current_setting('app.current_org_id', true)::uuid = $1\n              AND po.created_at >= NOW() - INTERVAL '90 days'\n            GROUP BY s.id, s.name\n            HAVING COUNT(po.id) >= 5\n          )\n          SELECT *\n          FROM supplier_metrics\n          WHERE on_time_rate < 0.7 OR avg_delivery_days > 14\n          `,\n          [orgId],\n        );\n\n        const anomalies: Anomaly[] = result.rows.map((row) => {\n          const onTimeRate = parseFloat(row.on_time_rate);\n          const avgDays = parseFloat(row.avg_delivery_days);\n\n          return {\n            id: `supplier_${row.id}_${Date.now()}`,\n            type: 'supplier_performance',\n            severity: onTimeRate < 0.5 || avgDays > 21 ? 'critical' : 'warning',\n            title: `Performance issues detected for supplier ${row.name}`,\n            message: `On-time delivery: ${(onTimeRate * 100).toFixed(1)}%, Average delivery: ${avgDays.toFixed(1)} days`,\n            affectedEntity: {\n              type: 'supplier',\n              id: row.id,\n              name: row.name,\n            },\n            metrics: {\n              onTimeRate,\n              avgDeliveryDays: avgDays,\n              totalOrders: parseInt(row.total_orders),\n            },\n            recommendations: [],\n            detectedAt: new Date(),\n          };\n        });\n\n        // Get AI recommendations\n        for (const anomaly of anomalies) {\n          anomaly.recommendations = await this.getAIRecommendations(\n            service,\n            runtimeOptions,\n            anomaly,\n          );\n        }\n\n        await this.storeAlerts(orgId, anomalies);\n\n        return anomalies;\n      },\n      options,\n      { orgId },\n    );\n  }\n\n  /**\n   * Run comprehensive anomaly detection\n   */\n  async detectAll(\n    orgId: string,\n    config?: AnomalyDetectionConfig,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<Anomaly[]>> {\n    return this.executeOperation(\n      'anomaly.all',\n      async () => {\n        const allAnomalies: Anomaly[] = [];\n\n        // Run all detection methods in parallel\n        const [inventory, pricing, supplier] = await Promise.all([\n          this.detectInventoryAnomalies(orgId, config, options),\n          this.detectPricingAnomalies(orgId, options),\n          this.detectSupplierAnomalies(orgId, options),\n        ]);\n\n        if (inventory.data) allAnomalies.push(...inventory.data);\n        if (pricing.data) allAnomalies.push(...pricing.data);\n        if (supplier.data) allAnomalies.push(...supplier.data);\n\n        // Sort by severity\n        const severityOrder = { urgent: 0, critical: 1, warning: 2, info: 3 };\n        allAnomalies.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);\n\n        return allAnomalies;\n      },\n      options,\n      { orgId, categories: config?.categories?.join(',') },\n    );\n  }\n\n  /**\n   * Detect stock level anomalies using statistical methods\n   */\n  private async detectStockLevelAnomalies(orgId: string): Promise<Anomaly[]> {\n    const result = await db.query(\n      `\n      WITH stock_stats AS (\n        SELECT\n          p.id,\n          p.name,\n          soh.quantity,\n          AVG(soh.quantity) OVER (PARTITION BY p.id ORDER BY soh.updated_at ROWS BETWEEN 30 PRECEDING AND CURRENT ROW) as avg_quantity,\n          STDDEV(soh.quantity) OVER (PARTITION BY p.id ORDER BY soh.updated_at ROWS BETWEEN 30 PRECEDING AND CURRENT ROW) as stddev_quantity,\n          p.reorder_point,\n          p.max_stock_level\n        FROM products p\n        JOIN stock_on_hand soh ON soh.product_id = p.id\n        WHERE current_setting('app.current_org_id', true)::uuid = $1\n      )\n      SELECT *,\n        ABS(quantity - avg_quantity) / NULLIF(stddev_quantity, 0) as z_score\n      FROM stock_stats\n      WHERE quantity <= reorder_point\n         OR quantity >= max_stock_level * 1.5\n         OR ABS(quantity - avg_quantity) / NULLIF(stddev_quantity, 0) > 3\n      `,\n      [orgId],\n    );\n\n    return result.rows.map((row) => ({\n      id: `stock_${row.id}_${Date.now()}`,\n      type: 'stock_level',\n      severity: row.quantity <= row.reorder_point ? 'critical' : 'warning',\n      title: `Stock level anomaly for ${row.name}`,\n      message: row.quantity <= row.reorder_point\n        ? `Stock below reorder point (${row.quantity} <= ${row.reorder_point})`\n        : `Unusual stock level detected (Z-score: ${parseFloat(row.z_score).toFixed(2)})`,\n      affectedEntity: {\n        type: 'product',\n        id: row.id,\n        name: row.name,\n      },\n      metrics: {\n        currentQuantity: parseFloat(row.quantity),\n        averageQuantity: parseFloat(row.avg_quantity),\n        reorderPoint: parseFloat(row.reorder_point),\n        zScore: parseFloat(row.z_score) || 0,\n      },\n      recommendations: [],\n      detectedAt: new Date(),\n    }));\n  }\n\n  /**\n   * Detect unusual movement patterns\n   */\n  private async detectMovementAnomalies(orgId: string): Promise<Anomaly[]> {\n    const result = await db.query(\n      `\n      WITH daily_movements AS (\n        SELECT\n          p.id,\n          p.name,\n          DATE(sm.created_at) as date,\n          SUM(ABS(sm.quantity)) as total_movement\n        FROM products p\n        JOIN stock_movement sm ON sm.product_id = p.id\n        WHERE current_setting('app.current_org_id', true)::uuid = $1\n          AND sm.created_at >= NOW() - INTERVAL '30 days'\n        GROUP BY p.id, p.name, DATE(sm.created_at)\n      ),\n      movement_stats AS (\n        SELECT\n          id,\n          name,\n          date,\n          total_movement,\n          AVG(total_movement) OVER (PARTITION BY id) as avg_movement,\n          STDDEV(total_movement) OVER (PARTITION BY id) as stddev_movement\n        FROM daily_movements\n      )\n      SELECT *,\n        ABS(total_movement - avg_movement) / NULLIF(stddev_movement, 0) as z_score\n      FROM movement_stats\n      WHERE ABS(total_movement - avg_movement) / NULLIF(stddev_movement, 0) > 2.5\n      ORDER BY z_score DESC\n      LIMIT 10\n      `,\n      [orgId],\n    );\n\n    return result.rows.map((row) => ({\n      id: `movement_${row.id}_${Date.now()}`,\n      type: 'unusual_movement',\n      severity: parseFloat(row.z_score) > 3.5 ? 'critical' : 'warning',\n      title: `Unusual movement pattern for ${row.name}`,\n      message: `Movement on ${row.date} (${parseFloat(row.total_movement).toFixed(0)} units) significantly deviates from average`,\n      affectedEntity: {\n        type: 'product',\n        id: row.id,\n        name: row.name,\n      },\n      metrics: {\n        movementQuantity: parseFloat(row.total_movement),\n        averageMovement: parseFloat(row.avg_movement),\n        zScore: parseFloat(row.z_score),\n      },\n      recommendations: [],\n      detectedAt: new Date(),\n    }));\n  }\n\n  /**\n   * Get AI recommendations for an anomaly\n   */\n  private async getAIRecommendations(\n    service: any,\n    runtimeOptions: any,\n    anomaly: Anomaly,\n  ): Promise<string[]> {\n    const prompt = `\nAnalyze this anomaly and provide 2-3 specific, actionable recommendations:\n\nType: ${anomaly.type}\nSeverity: ${anomaly.severity}\nDescription: ${anomaly.message}\nMetrics: ${JSON.stringify(anomaly.metrics, null, 2)}\n\nRespond with a JSON array of recommendations:\n[\"recommendation 1\", \"recommendation 2\", ...]\n`.trim();\n\n    try {\n      const response = await service.generateText(prompt, {\n        ...runtimeOptions,\n        temperature: 0.3,\n        maxTokens: 300,\n      });\n\n      const jsonMatch = response.text.match(/\\[[\\s\\S]*\\]/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (error) {\n      console.error('AI recommendations failed:', error);\n    }\n\n    // Fallback recommendations\n    return this.getFallbackRecommendations(anomaly);\n  }\n\n  /**\n   * Fallback recommendations based on anomaly type\n   */\n  private getFallbackRecommendations(anomaly: Anomaly): string[] {\n    switch (anomaly.type) {\n      case 'stock_level':\n        return [\n          'Review reorder points and adjust if necessary',\n          'Check for pending purchase orders',\n          'Consider emergency restocking if critical',\n        ];\n      case 'price_deviation':\n        return [\n          'Verify pricing data for errors',\n          'Review recent supplier price changes',\n          'Update pricing strategy if market conditions changed',\n        ];\n      case 'supplier_performance':\n        return [\n          'Schedule performance review meeting with supplier',\n          'Document specific delivery issues',\n          'Consider backup supplier options',\n        ];\n      default:\n        return ['Investigate the anomaly', 'Monitor for recurrence'];\n    }\n  }\n\n  /**\n   * Store alerts in database and track predictions\n   */\n  private async storeAlerts(orgId: string, anomalies: Anomaly[]): Promise<void> {\n    for (const anomaly of anomalies) {\n      // Store in ai_alert table\n      await db.query(\n        `\n        INSERT INTO ai_alert (\n          org_id, service_type, severity, title, message,\n          recommendations, entity_type, entity_id, metadata\n        )\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\n        ON CONFLICT DO NOTHING\n        `,\n        [\n          orgId,\n          'anomaly_detection',\n          anomaly.severity,\n          anomaly.title,\n          anomaly.message,\n          JSON.stringify(anomaly.recommendations),\n          anomaly.affectedEntity.type,\n          anomaly.affectedEntity.id,\n          JSON.stringify({ metrics: anomaly.metrics }),\n        ],\n      );\n\n      // Store in ai_prediction table for tracking\n      const confidenceScore = this.calculateConfidence(anomaly);\n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + 7); // Anomaly predictions valid for 7 days\n\n      await db.query(\n        `\n        INSERT INTO ai_prediction (\n          org_id, service_type, entity_type, entity_id,\n          prediction_data, confidence_score, expires_at, metadata\n        )\n        VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\n        `,\n        [\n          orgId,\n          'anomaly_detection',\n          anomaly.affectedEntity.type,\n          anomaly.affectedEntity.id,\n          JSON.stringify({\n            anomalyType: anomaly.type,\n            severity: anomaly.severity,\n            detected: true,\n            metrics: anomaly.metrics,\n          }),\n          confidenceScore,\n          expiresAt,\n          JSON.stringify({\n            title: anomaly.title,\n            detectedAt: anomaly.detectedAt,\n          }),\n        ],\n      );\n    }\n  }\n\n  /**\n   * Calculate confidence score based on anomaly metrics\n   */\n  private calculateConfidence(anomaly: Anomaly): number {\n    // Z-score based confidence calculation\n    const zScore = anomaly.metrics.zScore || anomaly.metrics.z_score || 0;\n\n    if (zScore > 3.5) return 0.95;\n    if (zScore > 3.0) return 0.90;\n    if (zScore > 2.5) return 0.85;\n    if (zScore > 2.0) return 0.75;\n\n    // Severity-based confidence for non-statistical anomalies\n    switch (anomaly.severity) {\n      case 'urgent':\n      case 'critical':\n        return 0.90;\n      case 'warning':\n        return 0.75;\n      case 'info':\n        return 0.60;\n      default:\n        return 0.70;\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\MetricsCacheService.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":402,"column":7,"nodeType":"TemplateLiteral","endLine":413,"endColumn":8}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '@/lib/database';\nimport {\n  AIServiceBase,\n  type AIServiceBaseOptions,\n  type AIServiceRequestOptions,\n  type AIServiceResponse,\n} from './base';\nimport type { AnalyticsMetricType } from './AnalyticsWidgetService';\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type TimePeriod = 'hourly' | 'daily' | 'weekly' | 'monthly';\n\nexport interface CachedMetric {\n  id: string;\n  orgId: string;\n  metricType: AnalyticsMetricType;\n  metricKey: string;\n  metricValue: Record<string, any>;\n  timePeriod: TimePeriod;\n  periodStart: Date;\n  periodEnd: Date;\n  calculatedAt: Date;\n}\n\nexport interface CacheMetricData {\n  metricType: AnalyticsMetricType;\n  metricKey: string;\n  metricValue: Record<string, any>;\n  timePeriod: TimePeriod;\n  periodStart: Date;\n  periodEnd: Date;\n}\n\n// ============================================================================\n// Service Implementation\n// ============================================================================\n\nexport class MetricsCacheService extends AIServiceBase<AIServiceRequestOptions> {\n  constructor(options?: AIServiceBaseOptions) {\n    super('MetricsCacheService', options);\n  }\n\n  /**\n   * Set a cached metric (upsert)\n   */\n  async setCachedMetric(\n    orgId: string,\n    data: CacheMetricData,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'cache.set',\n      async () => {\n        // Use upsert (INSERT ... ON CONFLICT UPDATE)\n        await db.query(\n          `\n          INSERT INTO analytics_metric_cache (\n            org_id, metric_type, metric_key, metric_value,\n            time_period, period_start, period_end\n          )\n          VALUES ($1, $2, $3, $4, $5, $6, $7)\n          ON CONFLICT (org_id, metric_type, metric_key, period_start)\n          DO UPDATE SET\n            metric_value = EXCLUDED.metric_value,\n            period_end = EXCLUDED.period_end,\n            calculated_at = NOW()\n          `,\n          [\n            orgId,\n            data.metricType,\n            data.metricKey,\n            JSON.stringify(data.metricValue),\n            data.timePeriod,\n            data.periodStart,\n            data.periodEnd,\n          ],\n        );\n      },\n      options,\n      {\n        orgId,\n        metricType: data.metricType,\n        metricKey: data.metricKey,\n      },\n    );\n  }\n\n  /**\n   * Get a cached metric\n   */\n  async getCachedMetric(\n    orgId: string,\n    metricType: AnalyticsMetricType,\n    metricKey: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<Record<string, any> | null>> {\n    return this.executeOperation(\n      'cache.get',\n      async () => {\n        const result = await db.query(\n          `\n          SELECT metric_value\n          FROM analytics_metric_cache\n          WHERE org_id = $1\n            AND metric_type = $2\n            AND metric_key = $3\n          ORDER BY period_start DESC\n          LIMIT 1\n          `,\n          [orgId, metricType, metricKey],\n        );\n\n        if (result.rows.length === 0) {\n          return null;\n        }\n\n        return result.rows[0].metric_value || null;\n      },\n      options,\n      { orgId, metricType, metricKey },\n    );\n  }\n\n  /**\n   * Invalidate cache for a specific metric type\n   */\n  async invalidateCache(\n    orgId: string,\n    metricType: AnalyticsMetricType,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<number>> {\n    return this.executeOperation(\n      'cache.invalidate',\n      async () => {\n        const result = await db.query(\n          `\n          DELETE FROM analytics_metric_cache\n          WHERE org_id = $1 AND metric_type = $2\n          RETURNING id\n          `,\n          [orgId, metricType],\n        );\n\n        return result.rows.length;\n      },\n      options,\n      { orgId, metricType },\n    );\n  }\n\n  /**\n   * Get metrics by time period\n   */\n  async getMetricsByPeriod(\n    orgId: string,\n    metricType: AnalyticsMetricType,\n    period: TimePeriod,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<CachedMetric[]>> {\n    return this.executeOperation(\n      'cache.getByPeriod',\n      async () => {\n        const result = await db.query(\n          `\n          SELECT *\n          FROM analytics_metric_cache\n          WHERE org_id = $1\n            AND metric_type = $2\n            AND time_period = $3\n          ORDER BY period_start DESC\n          LIMIT 100\n          `,\n          [orgId, metricType, period],\n        );\n\n        return result.rows.map((row) => this.mapCachedMetricRow(row));\n      },\n      options,\n      { orgId, metricType, period },\n    );\n  }\n\n  /**\n   * Get latest metrics for all types\n   */\n  async getLatestMetrics(\n    orgId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<CachedMetric[]>> {\n    return this.executeOperation(\n      'cache.getLatest',\n      async () => {\n        const result = await db.query(\n          `\n          SELECT DISTINCT ON (metric_type, metric_key) *\n          FROM analytics_metric_cache\n          WHERE org_id = $1\n          ORDER BY metric_type, metric_key, calculated_at DESC\n          `,\n          [orgId],\n        );\n\n        return result.rows.map((row) => this.mapCachedMetricRow(row));\n      },\n      options,\n      { orgId },\n    );\n  }\n\n  /**\n   * Clean up old cached metrics\n   */\n  async cleanupOldCache(\n    daysOld: number,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<number>> {\n    return this.executeOperation(\n      'cache.cleanup',\n      async () => {\n        const result = await db.query(\n          `\n          DELETE FROM analytics_metric_cache\n          WHERE calculated_at < NOW() - INTERVAL '1 day' * $1\n          RETURNING id\n          `,\n          [daysOld],\n        );\n\n        return result.rows.length;\n      },\n      options,\n      { daysOld },\n    );\n  }\n\n  /**\n   * Recalculate metrics for specific types\n   */\n  async recalculateMetrics(\n    orgId: string,\n    metricTypes: AnalyticsMetricType[],\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<void>> {\n    return this.executeOperation(\n      'cache.recalculate',\n      async () => {\n        // First, invalidate existing cache for these types\n        for (const metricType of metricTypes) {\n          await db.query(\n            `\n            DELETE FROM analytics_metric_cache\n            WHERE org_id = $1 AND metric_type = $2\n            `,\n            [orgId, metricType],\n          );\n        }\n\n        // Then recalculate each metric type\n        for (const metricType of metricTypes) {\n          await this.calculateMetric(orgId, metricType);\n        }\n      },\n      options,\n      { orgId, metricTypes },\n    );\n  }\n\n  /**\n   * Calculate and cache a specific metric type\n   */\n  private async calculateMetric(\n    orgId: string,\n    metricType: AnalyticsMetricType,\n  ): Promise<void> {\n    const now = new Date();\n    const periodStart = new Date(now);\n    periodStart.setHours(0, 0, 0, 0);\n\n    const periodEnd = new Date(now);\n    periodEnd.setHours(23, 59, 59, 999);\n\n    let metricValue: Record<string, any> = {};\n\n    switch (metricType) {\n      case 'sales':\n        metricValue = await this.calculateSalesMetrics(orgId, periodStart, periodEnd);\n        break;\n      case 'inventory':\n        metricValue = await this.calculateInventoryMetrics(orgId);\n        break;\n      case 'supplier_performance':\n        metricValue = await this.calculateSupplierMetrics(orgId, periodStart, periodEnd);\n        break;\n      case 'customer_behavior':\n        metricValue = await this.calculateCustomerMetrics(orgId, periodStart, periodEnd);\n        break;\n      case 'financial':\n        metricValue = await this.calculateFinancialMetrics(orgId, periodStart, periodEnd);\n        break;\n      case 'operational':\n        metricValue = await this.calculateOperationalMetrics(orgId, periodStart, periodEnd);\n        break;\n    }\n\n    // Cache the calculated metric\n    await db.query(\n      `\n      INSERT INTO analytics_metric_cache (\n        org_id, metric_type, metric_key, metric_value,\n        time_period, period_start, period_end\n      )\n      VALUES ($1, $2, $3, $4, $5, $6, $7)\n      ON CONFLICT (org_id, metric_type, metric_key, period_start)\n      DO UPDATE SET\n        metric_value = EXCLUDED.metric_value,\n        calculated_at = NOW()\n      `,\n      [\n        orgId,\n        metricType,\n        'daily_summary',\n        JSON.stringify(metricValue),\n        'daily',\n        periodStart,\n        periodEnd,\n      ],\n    );\n  }\n\n  /**\n   * Calculate sales metrics\n   */\n  private async calculateSalesMetrics(\n    orgId: string,\n    periodStart: Date,\n    periodEnd: Date,\n  ): Promise<Record<string, any>> {\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(*) as order_count,\n        COALESCE(SUM(total_amount), 0) as total_revenue,\n        COALESCE(AVG(total_amount), 0) as avg_order_value,\n        COUNT(DISTINCT customer_id) as unique_customers\n      FROM orders\n      WHERE org_id = $1\n        AND created_at >= $2\n        AND created_at <= $3\n      `,\n      [orgId, periodStart, periodEnd],\n    );\n\n    const row = result.rows[0] || {};\n    return {\n      orderCount: parseInt(row.order_count || '0'),\n      totalRevenue: parseFloat(row.total_revenue || '0'),\n      avgOrderValue: parseFloat(row.avg_order_value || '0'),\n      uniqueCustomers: parseInt(row.unique_customers || '0'),\n    };\n  }\n\n  /**\n   * Calculate inventory metrics\n   */\n  private async calculateInventoryMetrics(\n    orgId: string,\n  ): Promise<Record<string, any>> {\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(*) as total_products,\n        COALESCE(SUM(stock_level), 0) as total_stock_units,\n        COUNT(*) FILTER (WHERE stock_level <= reorder_point) as low_stock_count,\n        COUNT(*) FILTER (WHERE stock_level = 0) as out_of_stock_count\n      FROM products\n      WHERE org_id = $1\n      `,\n      [orgId],\n    );\n\n    const row = result.rows[0] || {};\n    return {\n      totalProducts: parseInt(row.total_products || '0'),\n      totalStockUnits: parseFloat(row.total_stock_units || '0'),\n      lowStockCount: parseInt(row.low_stock_count || '0'),\n      outOfStockCount: parseInt(row.out_of_stock_count || '0'),\n    };\n  }\n\n  /**\n   * Calculate supplier performance metrics\n   */\n  private async calculateSupplierMetrics(\n    orgId: string,\n    periodStart: Date,\n    periodEnd: Date,\n  ): Promise<Record<string, any>> {\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(DISTINCT s.id) as total_suppliers,\n        COALESCE(AVG(s.rating), 0) as avg_rating,\n        COUNT(DISTINCT po.id) as purchase_orders\n      FROM suppliers s\n      LEFT JOIN purchase_orders po ON po.supplier_id = s.id\n        AND po.created_at >= $2\n        AND po.created_at <= $3\n      WHERE s.org_id = $1\n      GROUP BY s.org_id\n      `,\n      [orgId, periodStart, periodEnd],\n    );\n\n    const row = result.rows[0] || {};\n    return {\n      totalSuppliers: parseInt(row.total_suppliers || '0'),\n      avgRating: parseFloat(row.avg_rating || '0'),\n      purchaseOrders: parseInt(row.purchase_orders || '0'),\n    };\n  }\n\n  /**\n   * Calculate customer behavior metrics\n   */\n  private async calculateCustomerMetrics(\n    orgId: string,\n    periodStart: Date,\n    periodEnd: Date,\n  ): Promise<Record<string, any>> {\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(DISTINCT id) as total_customers,\n        COUNT(DISTINCT id) FILTER (\n          WHERE last_order_date >= $2\n        ) as active_customers\n      FROM customers\n      WHERE org_id = $1\n      `,\n      [orgId, periodStart],\n    );\n\n    const row = result.rows[0] || {};\n    return {\n      totalCustomers: parseInt(row.total_customers || '0'),\n      activeCustomers: parseInt(row.active_customers || '0'),\n    };\n  }\n\n  /**\n   * Calculate financial metrics\n   */\n  private async calculateFinancialMetrics(\n    orgId: string,\n    periodStart: Date,\n    periodEnd: Date,\n  ): Promise<Record<string, any>> {\n    // Placeholder - would integrate with actual financial data\n    return {\n      revenue: 0,\n      expenses: 0,\n      profit: 0,\n      margin: 0,\n    };\n  }\n\n  /**\n   * Calculate operational metrics\n   */\n  private async calculateOperationalMetrics(\n    orgId: string,\n    periodStart: Date,\n    periodEnd: Date,\n  ): Promise<Record<string, any>> {\n    // Placeholder - would integrate with actual operational data\n    return {\n      efficiency: 0,\n      throughput: 0,\n      utilization: 0,\n    };\n  }\n\n  /**\n   * Map database row to CachedMetric\n   */\n  private mapCachedMetricRow(row: any): CachedMetric {\n    return {\n      id: row.id,\n      orgId: row.org_id,\n      metricType: row.metric_type,\n      metricKey: row.metric_key,\n      metricValue: row.metric_value || {},\n      timePeriod: row.time_period,\n      periodStart: new Date(row.period_start),\n      periodEnd: new Date(row.period_end),\n      calculatedAt: new Date(row.calculated_at),\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\SupplierScoringService.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":227,"column":7,"nodeType":"TemplateLiteral","endLine":227,"endColumn":49}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '@/lib/database';\nimport {\n  AIServiceBase,\n  type AIServiceBaseOptions,\n  type AIServiceRequestOptions,\n  type AIServiceResponse,\n} from './base';\n\nexport interface SupplierScore {\n  supplierId: string;\n  supplierName: string;\n  overallScore: number; // 0-100\n  categories: {\n    reliability: number;\n    quality: number;\n    pricing: number;\n    responsiveness: number;\n    compliance: number;\n  };\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n  recommendations: string[];\n  trends: {\n    scoreChange30d: number;\n    scoreChange90d: number;\n  };\n  metadata: Record<string, any>;\n}\n\nexport interface SupplierPerformanceData {\n  supplierId: string;\n  deliveryMetrics: {\n    onTimeDeliveryRate: number;\n    avgDeliveryDays: number;\n    totalDeliveries: number;\n  };\n  qualityMetrics: {\n    defectRate: number;\n    returnRate: number;\n    qualityComplaints: number;\n  };\n  pricingMetrics: {\n    avgPriceVariance: number;\n    competitivenessScore: number;\n  };\n  responsiveness: {\n    avgResponseTimeHours: number;\n    communicationRating: number;\n  };\n}\n\nexport class SupplierScoringService extends AIServiceBase<AIServiceRequestOptions> {\n  constructor(options?: AIServiceBaseOptions) {\n    super('SupplierScoringService', options);\n  }\n\n  /**\n   * Calculate comprehensive supplier score\n   */\n  async calculateScore(\n    orgId: string,\n    supplierId: string,\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<SupplierScore>> {\n    return this.executeOperation(\n      'supplier.score',\n      async ({ service, runtimeOptions }) => {\n        // Fetch supplier performance data\n        const performanceData = await this.getSupplierPerformance(orgId, supplierId);\n        const supplier = await this.getSupplierInfo(supplierId);\n\n        // Calculate individual category scores\n        const categories = {\n          reliability: this.calculateReliabilityScore(performanceData),\n          quality: this.calculateQualityScore(performanceData),\n          pricing: this.calculatePricingScore(performanceData),\n          responsiveness: this.calculateResponsivenessScore(performanceData),\n          compliance: await this.calculateComplianceScore(orgId, supplierId),\n        };\n\n        // Calculate weighted overall score\n        const overallScore = this.calculateOverallScore(categories);\n\n        // Get AI recommendations\n        const aiAnalysis = await this.getAIRecommendations(\n          service,\n          runtimeOptions,\n          supplier,\n          performanceData,\n          categories,\n          overallScore,\n        );\n\n        // Determine risk level\n        const riskLevel = this.determineRiskLevel(overallScore, categories);\n\n        // Get historical trends\n        const trends = await this.getScoreTrends(orgId, supplierId);\n\n        // Store prediction\n        await this.storePrediction(orgId, supplierId, {\n          overallScore,\n          categories,\n          riskLevel,\n          recommendations: aiAnalysis.recommendations,\n        });\n\n        return {\n          supplierId,\n          supplierName: supplier.name,\n          overallScore,\n          categories,\n          riskLevel,\n          recommendations: aiAnalysis.recommendations,\n          trends,\n          metadata: {\n            dataPoints: performanceData,\n            analysisDate: new Date().toISOString(),\n            aiModel: aiAnalysis.model,\n          },\n        };\n      },\n      options,\n      { supplierId },\n    );\n  }\n\n  /**\n   * Batch score multiple suppliers\n   */\n  async batchScore(\n    orgId: string,\n    supplierIds: string[],\n    options?: AIServiceRequestOptions,\n  ): Promise<AIServiceResponse<SupplierScore[]>> {\n    return this.executeOperation(\n      'supplier.batch_score',\n      async () => {\n        const scores: SupplierScore[] = [];\n\n        for (const supplierId of supplierIds) {\n          try {\n            const result = await this.calculateScore(orgId, supplierId, options);\n            if (result.data) {\n              scores.push(result.data);\n            }\n          } catch (error) {\n            console.error(`Failed to score supplier ${supplierId}:`, error);\n          }\n        }\n\n        return scores;\n      },\n      options,\n      { supplierCount: supplierIds.length },\n    );\n  }\n\n  /**\n   * Get supplier performance metrics\n   */\n  private async getSupplierPerformance(\n    orgId: string,\n    supplierId: string,\n  ): Promise<SupplierPerformanceData> {\n    const result = await db.query(\n      `\n      WITH delivery_metrics AS (\n        SELECT\n          COUNT(*) as total_deliveries,\n          AVG(CASE WHEN delivered_on_time THEN 1 ELSE 0 END) as on_time_rate,\n          AVG(EXTRACT(DAY FROM delivery_date - order_date)) as avg_delivery_days\n        FROM purchase_orders\n        WHERE supplier_id = $1\n          AND status = 'completed'\n          AND created_at >= NOW() - INTERVAL '90 days'\n      ),\n      quality_metrics AS (\n        SELECT\n          COALESCE(AVG(quality_rating), 5.0) as avg_quality,\n          COUNT(*) FILTER (WHERE quality_rating < 3) as quality_complaints\n        FROM supplier_reviews\n        WHERE supplier_id = $1\n          AND created_at >= NOW() - INTERVAL '90 days'\n      )\n      SELECT\n        dm.total_deliveries,\n        dm.on_time_rate,\n        dm.avg_delivery_days,\n        qm.avg_quality,\n        qm.quality_complaints\n      FROM delivery_metrics dm\n      CROSS JOIN quality_metrics qm\n      `,\n      [supplierId],\n    );\n\n    const row = result.rows[0] || {};\n\n    return {\n      supplierId,\n      deliveryMetrics: {\n        onTimeDeliveryRate: parseFloat(row.on_time_rate) || 0,\n        avgDeliveryDays: parseFloat(row.avg_delivery_days) || 0,\n        totalDeliveries: parseInt(row.total_deliveries) || 0,\n      },\n      qualityMetrics: {\n        defectRate: 0, // Calculate from returns/defects\n        returnRate: 0,\n        qualityComplaints: parseInt(row.quality_complaints) || 0,\n      },\n      pricingMetrics: {\n        avgPriceVariance: 0,\n        competitivenessScore: 0.7,\n      },\n      responsiveness: {\n        avgResponseTimeHours: 24,\n        communicationRating: parseFloat(row.avg_quality) || 5,\n      },\n    };\n  }\n\n  /**\n   * Get supplier basic info\n   */\n  private async getSupplierInfo(supplierId: string): Promise<{ name: string }> {\n    const result = await db.query(\n      `SELECT name FROM suppliers WHERE id = $1`,\n      [supplierId],\n    );\n    return result.rows[0] || { name: 'Unknown' };\n  }\n\n  /**\n   * Calculate reliability score (0-100)\n   */\n  private calculateReliabilityScore(data: SupplierPerformanceData): number {\n    const onTimeWeight = 0.7;\n    const deliverySpeedWeight = 0.3;\n\n    const onTimeScore = data.deliveryMetrics.onTimeDeliveryRate * 100;\n    const deliverySpeedScore = Math.max(\n      0,\n      100 - (data.deliveryMetrics.avgDeliveryDays - 7) * 5,\n    );\n\n    return Math.round(onTimeScore * onTimeWeight + deliverySpeedScore * deliverySpeedWeight);\n  }\n\n  /**\n   * Calculate quality score (0-100)\n   */\n  private calculateQualityScore(data: SupplierPerformanceData): number {\n    const defectScore = Math.max(0, 100 - data.qualityMetrics.defectRate * 100);\n    const returnScore = Math.max(0, 100 - data.qualityMetrics.returnRate * 100);\n    const complaintScore = Math.max(0, 100 - data.qualityMetrics.qualityComplaints * 10);\n\n    return Math.round((defectScore + returnScore + complaintScore) / 3);\n  }\n\n  /**\n   * Calculate pricing competitiveness score (0-100)\n   */\n  private calculatePricingScore(data: SupplierPerformanceData): number {\n    return Math.round(data.pricingMetrics.competitivenessScore * 100);\n  }\n\n  /**\n   * Calculate responsiveness score (0-100)\n   */\n  private calculateResponsivenessScore(data: SupplierPerformanceData): number {\n    const responseTimeScore = Math.max(\n      0,\n      100 - (data.responsiveness.avgResponseTimeHours - 24) * 2,\n    );\n    const communicationScore = (data.responsiveness.communicationRating / 5) * 100;\n\n    return Math.round((responseTimeScore + communicationScore) / 2);\n  }\n\n  /**\n   * Calculate compliance score\n   */\n  private async calculateComplianceScore(orgId: string, supplierId: string): Promise<number> {\n    // Check for compliance issues, certifications, etc.\n    return 85; // Default high score\n  }\n\n  /**\n   * Calculate weighted overall score\n   */\n  private calculateOverallScore(categories: SupplierScore['categories']): number {\n    const weights = {\n      reliability: 0.3,\n      quality: 0.3,\n      pricing: 0.2,\n      responsiveness: 0.1,\n      compliance: 0.1,\n    };\n\n    const score =\n      categories.reliability * weights.reliability +\n      categories.quality * weights.quality +\n      categories.pricing * weights.pricing +\n      categories.responsiveness * weights.responsiveness +\n      categories.compliance * weights.compliance;\n\n    return Math.round(score);\n  }\n\n  /**\n   * Get AI-generated recommendations\n   */\n  private async getAIRecommendations(\n    service: any,\n    runtimeOptions: any,\n    supplier: any,\n    data: SupplierPerformanceData,\n    categories: SupplierScore['categories'],\n    overallScore: number,\n  ): Promise<{ recommendations: string[]; model?: string }> {\n    const prompt = `\nAnalyze the following supplier performance and provide actionable recommendations:\n\nSupplier: ${supplier.name}\nOverall Score: ${overallScore}/100\n\nCategory Scores:\n- Reliability: ${categories.reliability}/100\n- Quality: ${categories.quality}/100\n- Pricing: ${categories.pricing}/100\n- Responsiveness: ${categories.responsiveness}/100\n- Compliance: ${categories.compliance}/100\n\nPerformance Data:\n- On-time delivery: ${(data.deliveryMetrics.onTimeDeliveryRate * 100).toFixed(1)}%\n- Average delivery time: ${data.deliveryMetrics.avgDeliveryDays.toFixed(1)} days\n- Total deliveries: ${data.deliveryMetrics.totalDeliveries}\n\nProvide 3-5 specific, actionable recommendations in JSON array format:\n[\"recommendation 1\", \"recommendation 2\", ...]\n`.trim();\n\n    try {\n      const response = await service.generateText(prompt, {\n        ...runtimeOptions,\n        temperature: 0.3,\n        maxTokens: 500,\n      });\n\n      const jsonMatch = response.text.match(/\\[[\\s\\S]*\\]/);\n      if (jsonMatch) {\n        const recommendations = JSON.parse(jsonMatch[0]);\n        return { recommendations, model: response.model };\n      }\n    } catch (error) {\n      console.error('AI recommendations failed:', error);\n    }\n\n    // Fallback recommendations\n    return {\n      recommendations: this.getFallbackRecommendations(categories, overallScore),\n    };\n  }\n\n  /**\n   * Fallback recommendations when AI fails\n   */\n  private getFallbackRecommendations(\n    categories: SupplierScore['categories'],\n    overallScore: number,\n  ): string[] {\n    const recommendations: string[] = [];\n\n    if (categories.reliability < 70) {\n      recommendations.push('Schedule regular check-ins to improve delivery reliability');\n    }\n    if (categories.quality < 70) {\n      recommendations.push('Implement quality audit process for incoming shipments');\n    }\n    if (categories.pricing < 70) {\n      recommendations.push('Negotiate better pricing or explore alternative suppliers');\n    }\n    if (categories.responsiveness < 70) {\n      recommendations.push('Establish clear communication protocols and SLAs');\n    }\n    if (overallScore < 60) {\n      recommendations.push('Consider supplier diversification to reduce risk');\n    }\n\n    return recommendations.length > 0\n      ? recommendations\n      : ['Maintain current supplier relationship with ongoing monitoring'];\n  }\n\n  /**\n   * Determine risk level based on score\n   */\n  private determineRiskLevel(\n    overallScore: number,\n    categories: SupplierScore['categories'],\n  ): 'low' | 'medium' | 'high' | 'critical' {\n    if (overallScore < 50 || categories.reliability < 40 || categories.quality < 40) {\n      return 'critical';\n    }\n    if (overallScore < 70) {\n      return 'high';\n    }\n    if (overallScore < 85) {\n      return 'medium';\n    }\n    return 'low';\n  }\n\n  /**\n   * Get score trends\n   */\n  private async getScoreTrends(\n    orgId: string,\n    supplierId: string,\n  ): Promise<SupplierScore['trends']> {\n    const result = await db.query(\n      `\n      WITH scores AS (\n        SELECT\n          prediction_data->>'overallScore' as score,\n          created_at\n        FROM ai_prediction\n        WHERE org_id = $1\n          AND service_type = 'supplier_scoring'\n          AND entity_id = $2\n          AND created_at >= NOW() - INTERVAL '90 days'\n        ORDER BY created_at DESC\n      )\n      SELECT\n        (SELECT score FROM scores ORDER BY created_at DESC LIMIT 1) as current_score,\n        (SELECT score FROM scores WHERE created_at <= NOW() - INTERVAL '30 days' ORDER BY created_at DESC LIMIT 1) as score_30d,\n        (SELECT score FROM scores WHERE created_at <= NOW() - INTERVAL '90 days' ORDER BY created_at DESC LIMIT 1) as score_90d\n      FROM scores\n      LIMIT 1\n      `,\n      [orgId, supplierId],\n    );\n\n    const row = result.rows[0] || {};\n    const current = parseFloat(row.current_score) || 0;\n    const score30d = parseFloat(row.score_30d) || current;\n    const score90d = parseFloat(row.score_90d) || current;\n\n    return {\n      scoreChange30d: Math.round(current - score30d),\n      scoreChange90d: Math.round(current - score90d),\n    };\n  }\n\n  /**\n   * Store prediction in database\n   */\n  private async storePrediction(orgId: string, supplierId: string, data: any): Promise<void> {\n    await db.query(\n      `\n      INSERT INTO ai_prediction (\n        org_id, service_type, entity_type, entity_id,\n        prediction_data, confidence_score, expires_at\n      )\n      VALUES ($1, $2, $3, $4, $5, $6, NOW() + INTERVAL '7 days')\n      `,\n      [\n        orgId,\n        'supplier_scoring',\n        'supplier',\n        supplierId,\n        JSON.stringify(data),\n        data.overallScore / 100, // Normalize to 0-1\n      ],\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\anomaly-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":214,"column":45,"nodeType":"BlockStatement","messageId":"unexpected","endLine":215,"endColumn":8,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[5811,5818],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":215,"column":47,"nodeType":"BlockStatement","messageId":"unexpected","endLine":216,"endColumn":8,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[5859,5866],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\n/**\n * Production AI Anomaly Detection Service\n *\n * Integrates with AIDatabaseService for AI-powered anomaly detection\n * and provides comprehensive anomaly management capabilities.\n *\n * Features:\n * - Multi-entity anomaly detection (suppliers, products, inventory, orders)\n * - AI-powered analysis using Claude 3.5 Sonnet\n * - Dual-table storage (analytics_anomalies + ai_data_anomalies)\n * - Real-time statistics and trend analysis\n * - Severity-based alerting and filtering\n */\n\nimport { query } from '@/lib/database/connection';\nimport { aiDatabase } from '@/lib/ai/database-integration';\nimport { z } from 'zod';\n\n// ============================================================================\n// TYPE DEFINITIONS\n// ============================================================================\n\nexport type AnomalyType =\n  | 'data_quality'\n  | 'statistical'\n  | 'business_rule'\n  | 'security'\n  | 'delivery_performance'\n  | 'quality_issues'\n  | 'low_stock'\n  | 'price_variance'\n  | 'supplier_risk';\n\nexport type AnomalySeverity = 'low' | 'medium' | 'high' | 'critical';\n\nexport type AnomalyStatus = 'active' | 'acknowledged' | 'resolved' | 'false_positive';\n\nexport type EntityType = 'supplier' | 'product' | 'inventory' | 'purchase_order' | 'system';\n\nexport interface Anomaly {\n  id: string;\n  organization_id?: number;\n  type: AnomalyType;\n  severity: AnomalySeverity;\n  title: string;\n  description: string;\n  value?: number;\n  threshold?: number;\n  entity_type?: EntityType;\n  entity_id?: string;\n  affected_records?: number;\n  detection_method?: string;\n  suggested_fix?: string;\n  sql_to_fix?: string;\n  detected_at: Date;\n  acknowledged_at?: Date;\n  acknowledged_by?: number;\n  resolved_at?: Date;\n  resolved_by?: number;\n  resolution_notes?: string;\n  false_positive?: boolean;\n  status?: AnomalyStatus;\n}\n\nexport interface AnomalyFilters {\n  entityType?: EntityType;\n  entityId?: string;\n  severity?: AnomalySeverity;\n  status?: AnomalyStatus;\n  startDate?: Date;\n  endDate?: Date;\n  limit?: number;\n  offset?: number;\n}\n\nexport interface AnomalyStats {\n  total: number;\n  bySeverity: Record<AnomalySeverity, number>;\n  byType: Record<string, number>;\n  byStatus: Record<AnomalyStatus, number>;\n  byEntity: Array<{\n    entityType: EntityType;\n    count: number;\n    avgSeverity: string;\n  }>;\n  trends: {\n    daily: Array<{\n      date: string;\n      count: number;\n      avgSeverity: string;\n    }>;\n    weekOverWeek: {\n      change: number;\n      direction: 'increasing' | 'decreasing' | 'stable';\n    };\n  };\n  topAnomalies: Array<{\n    id: string;\n    type: string;\n    severity: AnomalySeverity;\n    title: string;\n    affected_records: number;\n    detected_at: Date;\n  }>;\n  calculatedAt: Date;\n}\n\nexport interface DetectAnomaliesOptions {\n  organizationId: number;\n  entityType?: EntityType;\n  entityId?: string;\n  checkTypes?: AnomalyType[];\n  sensitivity?: 'low' | 'medium' | 'high';\n}\n\nexport interface DetectionResult {\n  anomaliesDetected: number;\n  anomalies: Anomaly[];\n  overallHealthScore: number;\n  recommendations: string[];\n  detectionTime: number;\n}\n\n// ============================================================================\n// ANOMALY SERVICE CLASS\n// ============================================================================\n\nexport class AnomalyService {\n  /**\n   * Detect anomalies using AI-powered analysis\n   */\n  async detectAnomalies(options: DetectAnomaliesOptions): Promise<DetectionResult> {\n    const startTime = Date.now();\n    const { organizationId, entityType, entityId, checkTypes, sensitivity = 'medium' } = options;\n\n    try {\n      // Build query based on entity type\n      const dataQuery = this.buildDetectionQuery(organizationId, entityType, entityId);\n\n      // Run AI-powered anomaly detection\n      const aiResult = await aiDatabase.detectAnomalies({\n        query: dataQuery,\n        checks: checkTypes as any[],\n      });\n\n      // Store anomalies in both tables for compatibility\n      const storedAnomalies = await this.storeDetectedAnomalies(\n        organizationId,\n        aiResult.anomalies,\n        entityType,\n        entityId\n      );\n\n      const detectionTime = Date.now() - startTime;\n\n      return {\n        anomaliesDetected: storedAnomalies.length,\n        anomalies: storedAnomalies,\n        overallHealthScore: aiResult.overall_health_score,\n        recommendations: aiResult.recommendations,\n        detectionTime,\n      };\n    } catch (error) {\n      console.error('Error in detectAnomalies:', error);\n      throw new Error(`Anomaly detection failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * List anomalies with filtering and pagination\n   */\n  async listAnomalies(\n    organizationId: number,\n    filters: AnomalyFilters = {}\n  ): Promise<{ anomalies: Anomaly[]; total: number }> {\n    try {\n      const {\n        entityType,\n        entityId,\n        severity,\n        status = 'active',\n        startDate,\n        endDate,\n        limit = 50,\n        offset = 0,\n      } = filters;\n\n      // Build WHERE conditions\n      const conditions: string[] = ['organization_id = $1'];\n      const params: any[] = [organizationId];\n      let paramIndex = 2;\n\n      if (entityType) {\n        conditions.push(`entity_type = $${paramIndex++}`);\n        params.push(entityType);\n      }\n\n      if (entityId) {\n        conditions.push(`entity_id = $${paramIndex++}`);\n        params.push(entityId);\n      }\n\n      if (severity) {\n        conditions.push(`severity = $${paramIndex++}`);\n        params.push(severity);\n      }\n\n      // Status filtering\n      if (status === 'active') {\n        conditions.push('resolved_at IS NULL');\n      } else if (status === 'resolved') {\n        conditions.push('resolved_at IS NOT NULL');\n      } else if (status === 'acknowledged') {\n      } else if (status === 'false_positive') {\n      }\n\n      if (startDate) {\n        conditions.push(`detected_at >= $${paramIndex++}`);\n        params.push(startDate);\n      }\n\n      if (endDate) {\n        conditions.push(`detected_at <= $${paramIndex++}`);\n        params.push(endDate);\n      }\n\n      const whereClause = conditions.join(' AND ');\n\n      // Get total count\n      const countResult = await query(\n        `SELECT COUNT(*) as total FROM analytics_anomalies WHERE ${whereClause}`,\n        params\n      );\n      const total = parseInt(countResult.rows[0]?.total || '0');\n\n      // Get anomalies\n      const anomaliesResult = await query(\n        `\n        SELECT\n          id,\n          organization_id,\n          type,\n          severity,\n          description,\n          entity_type,\n          entity_id,\n          detected_at,\n          resolved_at\n        FROM analytics_anomalies\n        WHERE ${whereClause}\n        ORDER BY\n          CASE severity\n            WHEN 'critical' THEN 1\n            WHEN 'high' THEN 2\n            WHEN 'medium' THEN 3\n            WHEN 'low' THEN 4\n          END,\n          detected_at DESC\n        LIMIT $${paramIndex} OFFSET $${paramIndex + 1}\n        `,\n        [...params, limit, offset]\n      );\n\n      const anomalies = anomaliesResult.rows.map(row => ({\n        ...row,\n        detected_at: new Date(row.detected_at),\n        acknowledged_at: row.acknowledged_at ? new Date(row.acknowledged_at) : undefined,\n        resolved_at: row.resolved_at ? new Date(row.resolved_at) : undefined,\n      }));\n\n      return { anomalies, total };\n    } catch (error) {\n      console.error('Error in listAnomalies:', error);\n      throw new Error(`Failed to list anomalies: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Get anomaly by ID\n   */\n  async getAnomalyById(anomalyId: string, organizationId?: number): Promise<Anomaly | null> {\n    try {\n      const conditions = ['id = $1'];\n      const params: any[] = [anomalyId];\n\n      if (organizationId) {\n        conditions.push('organization_id = $2');\n        params.push(organizationId);\n      }\n\n      const result = await query(\n        `\n        SELECT\n          id,\n          organization_id,\n          type,\n          severity,\n          description,\n          entity_type,\n          entity_id,\n          detected_at,\n          resolved_at,\n          resolved_by,\n        FROM analytics_anomalies\n        WHERE ${conditions.join(' AND ')}\n        `,\n        params\n      );\n\n      if (result.rows.length === 0) {\n        return null;\n      }\n\n      const row = result.rows[0];\n      return {\n        ...row,\n        detected_at: new Date(row.detected_at),\n        acknowledged_at: row.acknowledged_at ? new Date(row.acknowledged_at) : undefined,\n        resolved_at: row.resolved_at ? new Date(row.resolved_at) : undefined,\n      };\n    } catch (error) {\n      console.error('Error in getAnomalyById:', error);\n      throw new Error(`Failed to get anomaly: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Mark anomaly as resolved\n   */\n  async markResolved(\n    anomalyId: string,\n    userId: string,\n    resolutionNotes?: string,\n    organizationId?: number\n  ): Promise<Anomaly> {\n    try {\n      const conditions = ['id = $1'];\n      const params: any[] = [anomalyId];\n\n      if (organizationId) {\n        conditions.push('organization_id = $5');\n        params.push(organizationId);\n      }\n\n      const result = await query(\n        `\n        UPDATE analytics_anomalies\n        SET\n          resolved_at = NOW(),\n          resolved_by = $2,\n          resolution_notes = $3,\n          updated_at = NOW()\n        WHERE ${conditions.join(' AND ')}\n        RETURNING\n          id,\n          organization_id,\n          type,\n          severity,\n          description,\n          value,\n          threshold,\n          entity_type,\n          entity_id,\n          detected_at,\n          acknowledged_at,\n          acknowledged_by,\n          resolved_at,\n          resolved_by,\n          resolution_notes,\n          false_positive\n        `,\n        [anomalyId, userId, resolutionNotes || null, ...params.slice(1)]\n      );\n\n      if (result.rows.length === 0) {\n        throw new Error('Anomaly not found or already resolved');\n      }\n\n      const row = result.rows[0];\n      return {\n        ...row,\n        detected_at: new Date(row.detected_at),\n        acknowledged_at: row.acknowledged_at ? new Date(row.acknowledged_at) : undefined,\n        resolved_at: row.resolved_at ? new Date(row.resolved_at) : undefined,\n      };\n    } catch (error) {\n      console.error('Error in markResolved:', error);\n      throw new Error(`Failed to mark anomaly as resolved: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Acknowledge anomaly (intermediate state before resolution)\n   */\n  async acknowledgeAnomaly(\n    anomalyId: string,\n    userId: string,\n    organizationId?: number\n  ): Promise<Anomaly> {\n    try {\n      const conditions = ['id = $1'];\n      const params: any[] = [anomalyId];\n\n      if (organizationId) {\n        conditions.push('organization_id = $3');\n        params.push(organizationId);\n      }\n\n      const result = await query(\n        `\n        UPDATE analytics_anomalies\n        SET\n          acknowledged_at = NOW(),\n          acknowledged_by = $2,\n          updated_at = NOW()\n        WHERE ${conditions.join(' AND ')}\n          AND acknowledged_at IS NULL\n        RETURNING\n          id,\n          organization_id,\n          type,\n          severity,\n          description,\n          value,\n          threshold,\n          entity_type,\n          entity_id,\n          detected_at,\n          acknowledged_at,\n          acknowledged_by,\n          resolved_at,\n          resolved_by,\n          resolution_notes,\n          false_positive\n        `,\n        [anomalyId, userId, ...params.slice(1)]\n      );\n\n      if (result.rows.length === 0) {\n        throw new Error('Anomaly not found or already acknowledged');\n      }\n\n      const row = result.rows[0];\n      return {\n        ...row,\n        detected_at: new Date(row.detected_at),\n        acknowledged_at: row.acknowledged_at ? new Date(row.acknowledged_at) : undefined,\n        resolved_at: row.resolved_at ? new Date(row.resolved_at) : undefined,\n      };\n    } catch (error) {\n      console.error('Error in acknowledgeAnomaly:', error);\n      throw new Error(`Failed to acknowledge anomaly: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Mark anomaly as false positive\n   */\n  async markFalsePositive(\n    anomalyId: string,\n    userId: string,\n    notes?: string,\n    organizationId?: number\n  ): Promise<Anomaly> {\n    try {\n      const conditions = ['id = $1'];\n      const params: any[] = [anomalyId];\n\n      if (organizationId) {\n        conditions.push('organization_id = $4');\n        params.push(organizationId);\n      }\n\n      const result = await query(\n        `\n        UPDATE analytics_anomalies\n        SET\n          resolved_at = NOW(),\n          resolved_by = $2,\n          resolution_notes = $3,\n          updated_at = NOW()\n        WHERE ${conditions.join(' AND ')}\n        RETURNING\n          id,\n          organization_id,\n          type,\n          severity,\n          description,\n          value,\n          threshold,\n          entity_type,\n          entity_id,\n          detected_at,\n          acknowledged_at,\n          acknowledged_by,\n          resolved_at,\n          resolved_by,\n          resolution_notes,\n          false_positive\n        `,\n        [anomalyId, userId, notes || 'Marked as false positive', ...params.slice(1)]\n      );\n\n      if (result.rows.length === 0) {\n        throw new Error('Anomaly not found');\n      }\n\n      const row = result.rows[0];\n      return {\n        ...row,\n        detected_at: new Date(row.detected_at),\n        acknowledged_at: row.acknowledged_at ? new Date(row.acknowledged_at) : undefined,\n        resolved_at: row.resolved_at ? new Date(row.resolved_at) : undefined,\n      };\n    } catch (error) {\n      console.error('Error in markFalsePositive:', error);\n      throw new Error(`Failed to mark as false positive: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Get comprehensive anomaly statistics\n   */\n  async getAnomalyStats(\n    organizationId: number,\n    filters: { startDate?: Date; endDate?: Date; entityType?: EntityType } = {}\n  ): Promise<AnomalyStats> {\n    try {\n      const { startDate, endDate, entityType } = filters;\n\n      // Build WHERE conditions\n      const conditions: string[] = ['organization_id = $1'];\n      const params: any[] = [organizationId];\n      let paramIndex = 2;\n\n      if (startDate) {\n        conditions.push(`detected_at >= $${paramIndex++}`);\n        params.push(startDate);\n      }\n\n      if (endDate) {\n        conditions.push(`detected_at <= $${paramIndex++}`);\n        params.push(endDate);\n      }\n\n      if (entityType) {\n        conditions.push(`entity_type = $${paramIndex++}`);\n        params.push(entityType);\n      }\n\n      const whereClause = conditions.join(' AND ');\n\n      // Get comprehensive statistics\n      const statsResult = await query(\n        `\n        WITH severity_counts AS (\n          SELECT\n            severity,\n            COUNT(*) as count\n          FROM analytics_anomalies\n          WHERE ${whereClause}\n          GROUP BY severity\n        ),\n        type_counts AS (\n          SELECT\n            type,\n            COUNT(*) as count\n          FROM analytics_anomalies\n          WHERE ${whereClause}\n          GROUP BY type\n        ),\n        status_counts AS (\n          SELECT\n            CASE\n              WHEN resolved_at IS NOT NULL THEN 'resolved'\n              WHEN acknowledged_at IS NOT NULL THEN 'acknowledged'\n              ELSE 'active'\n            END as status,\n            COUNT(*) as count\n          FROM analytics_anomalies\n          WHERE ${whereClause}\n          GROUP BY\n            CASE\n              WHEN resolved_at IS NOT NULL THEN 'resolved'\n              WHEN acknowledged_at IS NOT NULL THEN 'acknowledged'\n              ELSE 'active'\n            END\n        ),\n        entity_counts AS (\n          SELECT\n            entity_type,\n            COUNT(*) as count,\n            CASE\n              WHEN AVG(CASE severity\n                WHEN 'critical' THEN 4\n                WHEN 'high' THEN 3\n                WHEN 'medium' THEN 2\n                WHEN 'low' THEN 1\n              END) >= 3.5 THEN 'critical'\n              WHEN AVG(CASE severity\n                WHEN 'critical' THEN 4\n                WHEN 'high' THEN 3\n                WHEN 'medium' THEN 2\n                WHEN 'low' THEN 1\n              END) >= 2.5 THEN 'high'\n              WHEN AVG(CASE severity\n                WHEN 'critical' THEN 4\n                WHEN 'high' THEN 3\n                WHEN 'medium' THEN 2\n                WHEN 'low' THEN 1\n              END) >= 1.5 THEN 'medium'\n              ELSE 'low'\n            END as avg_severity\n          FROM analytics_anomalies\n          WHERE ${whereClause} AND entity_type IS NOT NULL\n          GROUP BY entity_type\n        ),\n        daily_trends AS (\n          SELECT\n            DATE(detected_at) as date,\n            COUNT(*) as count,\n            CASE\n              WHEN AVG(CASE severity\n                WHEN 'critical' THEN 4\n                WHEN 'high' THEN 3\n                WHEN 'medium' THEN 2\n                WHEN 'low' THEN 1\n              END) >= 3.5 THEN 'critical'\n              WHEN AVG(CASE severity\n                WHEN 'critical' THEN 4\n                WHEN 'high' THEN 3\n                WHEN 'medium' THEN 2\n                WHEN 'low' THEN 1\n              END) >= 2.5 THEN 'high'\n              WHEN AVG(CASE severity\n                WHEN 'critical' THEN 4\n                WHEN 'high' THEN 3\n                WHEN 'medium' THEN 2\n                WHEN 'low' THEN 1\n              END) >= 1.5 THEN 'medium'\n              ELSE 'low'\n            END as avg_severity\n          FROM analytics_anomalies\n          WHERE ${whereClause}\n            AND detected_at >= NOW() - INTERVAL '30 days'\n          GROUP BY DATE(detected_at)\n          ORDER BY date DESC\n          LIMIT 30\n        ),\n        top_anomalies AS (\n          SELECT\n            id,\n            type,\n            severity,\n            COALESCE(\n              (SELECT name FROM core.supplier WHERE id = analytics_anomalies.entity_id AND analytics_anomalies.entity_type = 'supplier'),\n              description\n            ) as title,\n            COALESCE(\n              (SELECT COUNT(*) FROM core.stock_on_hand WHERE qty < 10 AND analytics_anomalies.entity_type = 'inventory'),\n              1\n            ) as affected_records,\n            detected_at\n          FROM analytics_anomalies\n          WHERE ${whereClause}\n            AND resolved_at IS NULL\n          ORDER BY\n            CASE severity\n              WHEN 'critical' THEN 1\n              WHEN 'high' THEN 2\n              WHEN 'medium' THEN 3\n              WHEN 'low' THEN 4\n            END,\n            detected_at DESC\n          LIMIT 10\n        )\n        SELECT\n          (SELECT COUNT(*) FROM analytics_anomalies WHERE ${whereClause}) as total,\n          (SELECT json_agg(json_build_object('severity', severity, 'count', count)) FROM severity_counts) as by_severity,\n          (SELECT json_agg(json_build_object('type', type, 'count', count)) FROM type_counts) as by_type,\n          (SELECT json_agg(json_build_object('status', status, 'count', count)) FROM status_counts) as by_status,\n          (SELECT json_agg(json_build_object('entityType', entity_type, 'count', count, 'avgSeverity', avg_severity)) FROM entity_counts) as by_entity,\n          (SELECT json_agg(json_build_object('date', date, 'count', count, 'avgSeverity', avg_severity)) FROM daily_trends) as daily_trends,\n          (SELECT json_agg(json_build_object('id', id, 'type', type, 'severity', severity, 'title', description, 'impact_score', impact_score, 'detected_at', detected_at)) FROM top_anomalies) as top_anomalies\n        `,\n        params\n      );\n\n      const row = statsResult.rows[0];\n\n      // Calculate week-over-week change\n      const thisWeekCount = await query(\n        `\n        SELECT COUNT(*) as count\n        FROM analytics_anomalies\n        WHERE ${whereClause}\n          AND detected_at >= NOW() - INTERVAL '7 days'\n        `,\n        params\n      );\n\n      const lastWeekCount = await query(\n        `\n        SELECT COUNT(*) as count\n        FROM analytics_anomalies\n        WHERE ${whereClause}\n          AND detected_at >= NOW() - INTERVAL '14 days'\n          AND detected_at < NOW() - INTERVAL '7 days'\n        `,\n        params\n      );\n\n      const thisWeek = parseInt(thisWeekCount.rows[0]?.count || '0');\n      const lastWeek = parseInt(lastWeekCount.rows[0]?.count || '0');\n      const weekOverWeekChange = lastWeek > 0 ? ((thisWeek - lastWeek) / lastWeek) * 100 : 0;\n\n      // Build response\n      const bySeverity: Record<AnomalySeverity, number> = {\n        low: 0,\n        medium: 0,\n        high: 0,\n        critical: 0,\n      };\n\n      if (row.by_severity) {\n        row.by_severity.forEach((item: any) => {\n          bySeverity[item.severity as AnomalySeverity] = parseInt(item.count);\n        });\n      }\n\n      const byType: Record<string, number> = {};\n      if (row.by_type) {\n        row.by_type.forEach((item: any) => {\n          byType[item.type] = parseInt(item.count);\n        });\n      }\n\n      const byStatus: Record<AnomalyStatus, number> = {\n        active: 0,\n        acknowledged: 0,\n        resolved: 0,\n        false_positive: 0,\n      };\n\n      if (row.by_status) {\n        row.by_status.forEach((item: any) => {\n          byStatus[item.status as AnomalyStatus] = parseInt(item.count);\n        });\n      }\n\n      return {\n        total: parseInt(row.total || '0'),\n        bySeverity,\n        byType,\n        byStatus,\n        byEntity: row.by_entity || [],\n        trends: {\n          daily: row.daily_trends || [],\n          weekOverWeek: {\n            change: Math.round(weekOverWeekChange * 10) / 10,\n            direction: weekOverWeekChange > 5 ? 'increasing' : weekOverWeekChange < -5 ? 'decreasing' : 'stable',\n          },\n        },\n        topAnomalies: row.top_anomalies || [],\n        calculatedAt: new Date(),\n      };\n    } catch (error) {\n      console.error('Error in getAnomalyStats:', error);\n      throw new Error(`Failed to get anomaly stats: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  // ============================================================================\n  // PRIVATE HELPER METHODS\n  // ============================================================================\n\n  /**\n   * Build detection query based on entity type\n   */\n  private buildDetectionQuery(\n    organizationId: number,\n    entityType?: EntityType,\n    entityId?: number\n  ): string {\n    if (entityType && entityId) {\n      // Entity-specific query\n      switch (entityType) {\n        case 'supplier':\n          return `\n            SELECT * FROM core.supplier\n            WHERE id = ${entityId}\n            LIMIT 1\n          `;\n        case 'product':\n          return `\n            SELECT * FROM core.product\n            WHERE id = ${entityId}\n            LIMIT 1\n          `;\n        case 'inventory':\n          return `\n            SELECT * FROM core.stock_on_hand\n            WHERE id = ${entityId}\n            LIMIT 100\n          `;\n        case 'purchase_order':\n          return `\n            SELECT * FROM core.purchase_order\n            WHERE id = ${entityId}\n            LIMIT 1\n          `;\n        default:\n          return `SELECT * FROM core.supplier LIMIT 100`;\n      }\n    } else if (entityType) {\n      // Entity-type query\n      switch (entityType) {\n        case 'supplier':\n          return `SELECT * FROM core.supplier LIMIT 100`;\n        case 'product':\n          return `SELECT * FROM core.product LIMIT 100`;\n        case 'inventory':\n          return `SELECT * FROM core.stock_on_hand WHERE qty < 50 LIMIT 100`;\n        case 'purchase_order':\n          return `SELECT * FROM core.purchase_order ORDER BY created_at DESC LIMIT 100`;\n        default:\n          return `SELECT * FROM core.supplier LIMIT 100`;\n      }\n    } else {\n      // General system-wide query\n      return `\n        SELECT\n          'system' as entity_type,\n          COUNT(*) as total_records,\n          COUNT(CASE WHEN qty < 10 THEN 1 END) as low_stock_items,\n          AVG(qty) as avg_quantity\n        FROM core.stock_on_hand\n        LIMIT 1000\n      `;\n    }\n  }\n\n  /**\n   * Store detected anomalies in both tables\n   */\n  private async storeDetectedAnomalies(\n    organizationId: number,\n    aiAnomalies: any[],\n    entityType?: EntityType,\n    entityId?: number\n  ): Promise<Anomaly[]> {\n    const storedAnomalies: Anomaly[] = [];\n\n    for (const aiAnomaly of aiAnomalies) {\n      try {\n        // Store in analytics_anomalies (main table)\n        const result = await query(\n          `\n          INSERT INTO analytics_anomalies (\n            organization_id,\n            type,\n            severity,\n            description,\n            entity_type,\n            entity_id,\n            detected_at\n          ) VALUES ($1, $2, $3, $4, $5, $6, NOW())\n          RETURNING\n            id,\n            organization_id,\n            type,\n            severity,\n            description,\n            entity_type,\n            entity_id,\n            detected_at,\n            resolved_at,\n          `,\n          [\n            organizationId,\n            aiAnomaly.type,\n            aiAnomaly.severity,\n            aiAnomaly.description,\n            entityType || null,\n            entityId || null,\n          ]\n        );\n\n        const stored = result.rows[0];\n        storedAnomalies.push({\n          ...stored,\n          detected_at: new Date(stored.detected_at),\n          acknowledged_at: stored.acknowledged_at ? new Date(stored.acknowledged_at) : undefined,\n          resolved_at: stored.resolved_at ? new Date(stored.resolved_at) : undefined,\n        });\n\n        // Also store in ai_data_anomalies for AI-specific tracking\n        await query(\n          `\n          INSERT INTO ai_data_anomalies (\n            anomaly_type,\n            severity,\n            title,\n            description,\n            affected_records,\n            detection_method,\n            suggested_fix,\n            sql_to_fix,\n            detected_at\n          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW())\n          `,\n          [\n            aiAnomaly.type,\n            aiAnomaly.severity,\n            aiAnomaly.title,\n            aiAnomaly.description,\n            aiAnomaly.affected_records || 0,\n            aiAnomaly.detection_method || 'AI-powered analysis',\n            aiAnomaly.suggested_fix || null,\n            aiAnomaly.sql_to_fix || null,\n          ]\n        );\n      } catch (error) {\n        console.error('Error storing anomaly:', error);\n        // Continue with other anomalies\n      }\n    }\n\n    return storedAnomalies;\n  }\n}\n\n// Export singleton instance\nexport const anomalyService = new AnomalyService();\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\base.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"@typescript-eslint/no-this-alias","severity":2,"message":"Unexpected aliasing of 'this' to local variable.","line":191,"column":11,"nodeType":"Identifier","messageId":"thisAssignment","endLine":191,"endColumn":15}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\nimport { EventEmitter } from 'events';\r\nimport type { ApiResponse } from '@/lib/api/base';\r\nimport { db } from '@/lib/database';\r\nimport type {\r\n  AIProviderId,\r\n  AIProviderRuntimeOptions,\r\n  AIUsageMetrics,\r\n  AIUsageEvent,\r\n  AIProviderHealth,\r\n  AIConfig,\r\n} from '@/types/ai';\r\nimport {\r\n  AIService,\r\n  getAIConfig,\r\n  refreshAIConfig,\r\n  updateAIConfig,\r\n  getProviderHealthStatus,\r\n  getAllProviderHealthStatus,\r\n} from '../index';\r\n\r\nexport interface AIServiceBaseOptions {\r\n  defaultProvider?: AIProviderId;\r\n  disableFallback?: boolean;\r\n  notifyChannel?: string;\r\n  tags?: string[];\r\n  defaultMetadata?: Record<string, any>;\r\n  enableNotifications?: boolean;\r\n}\r\n\r\nexport interface AIServiceRequestOptions extends AIProviderRuntimeOptions {\r\n  requestId?: string;\r\n  notifyChannel?: string;\r\n  disableFallback?: boolean;\r\n  tags?: string[];\r\n  metadata?: Record<string, any>;\r\n  rethrowOnError?: boolean;\r\n}\r\n\r\nexport interface AIServiceResponse<T> extends ApiResponse<T> {\r\n  provider: AIProviderId;\r\n  model?: string;\r\n  usage?: AIUsageMetrics;\r\n  service: string;\r\n  operation: string;\r\n  durationMs: number;\r\n  metadata?: Record<string, any>;\r\n  context?: Record<string, any>;\r\n}\r\n\r\nexport interface AIUsageEventEnvelope extends AIUsageEvent {\r\n  requestId: string;\r\n  operation: string;\r\n  service: string;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface StreamingResult<TChunk, TResult> extends AsyncIterable<TChunk> {\r\n  summary: Promise<AIServiceResponse<TResult>>;\r\n}\r\n\r\ninterface StreamingContext<TChunk, TResult> {\r\n  requestId: string;\r\n  operation: string;\r\n  service: AIService;\r\n  notifyChannel: string;\r\n  metadata?: Record<string, any>;\r\n  startedAt: number;\r\n  cleanup: () => void;\r\n  aggregate?: {\r\n    onChunk?: (chunk: TChunk) => void;\r\n    onComplete?: () => TResult | undefined;\r\n    onError?: (error: unknown) => TResult | undefined;\r\n  };\r\n  customResponse?: (params: {\r\n    data: TResult | undefined;\r\n    provider: AIProviderId;\r\n    durationMs: number;\r\n    metadata?: Record<string, any>;\r\n  }) => AIServiceResponse<TResult>;\r\n}\r\n\r\ninterface Deferred<T> {\r\n  promise: Promise<T>;\r\n  resolve: (value: T) => void;\r\n  reject: (reason?: any) => void;\r\n}\r\n\r\nexport class AIServiceBase<TOptions extends AIServiceRequestOptions = AIServiceRequestOptions> extends EventEmitter {\r\n  protected readonly serviceName: string;\r\n  protected readonly defaultProvider?: AIProviderId;\r\n  protected readonly defaultDisableFallback?: boolean;\r\n  protected readonly notifyChannel: string;\r\n  protected readonly defaultMetadata: Record<string, any>;\r\n  protected readonly tags: string[];\r\n  protected readonly notificationsEnabled: boolean;\r\n\r\n  constructor(serviceName: string, options?: AIServiceBaseOptions) {\r\n    super();\r\n    this.serviceName = serviceName;\r\n    this.defaultProvider = options?.defaultProvider;\r\n    this.defaultDisableFallback = options?.disableFallback;\r\n    this.notifyChannel = options?.notifyChannel ?? 'ai_events';\r\n    this.defaultMetadata = { ...(options?.defaultMetadata ?? {}) };\r\n    this.tags = options?.tags ?? [];\r\n    this.notificationsEnabled = options?.enableNotifications !== false;\r\n  }\r\n\r\n  protected async executeOperation<T>(\r\n    operation: string,\r\n    executor: (context: { service: AIService; runtimeOptions?: AIProviderRuntimeOptions }) => Promise<T>,\r\n    options?: TOptions,\r\n    eventMetadata?: Record<string, any>,\r\n  ): Promise<AIServiceResponse<T>> {\r\n    const requestId = options?.requestId ?? this.generateRequestId();\r\n    const notifyChannel = options?.notifyChannel ?? this.notifyChannel;\r\n    const metadata = this.mergeMetadata(this.defaultMetadata, options?.metadata, eventMetadata);\r\n    const startedAt = Date.now();\r\n\r\n    this.emit('request', {\r\n      requestId,\r\n      service: this.serviceName,\r\n      operation,\r\n      metadata,\r\n    });\r\n    await this.notifyEvent('request', {\r\n      requestId,\r\n      service: this.serviceName,\r\n      operation,\r\n      metadata,\r\n      timestamp: this.getTimestamp(),\r\n    }, notifyChannel);\r\n\r\n    const { service, cleanup } = this.createServiceInstance(options, requestId, operation, notifyChannel, metadata);\r\n    const runtimeOptions = this.buildRuntimeOptions(options);\r\n\r\n    try {\r\n      const data = await executor({ service, runtimeOptions });\r\n      const provider = this.resolveProvider(data, service);\r\n      const model = this.resolveModel(data, runtimeOptions);\r\n      const usage = this.resolveUsage(data);\r\n      const durationMs = Date.now() - startedAt;\r\n      const response = this.buildSuccessResponse({\r\n        data,\r\n        provider,\r\n        model,\r\n        usage,\r\n        requestId,\r\n        operation,\r\n        durationMs,\r\n        metadata,\r\n        context: this.buildContext(options),\r\n      });\r\n\r\n      this.emit('response', response);\r\n      await this.notifyEvent('response', response, notifyChannel);\r\n\r\n      return response;\r\n    } catch (error) {\r\n      const provider = this.resolveProvider(undefined, service);\r\n      const durationMs = Date.now() - startedAt;\r\n      const response = this.buildErrorResponse<T>({\r\n        error,\r\n        provider,\r\n        requestId,\r\n        operation,\r\n        durationMs,\r\n        metadata,\r\n        context: this.buildContext(options),\r\n      });\r\n\r\n      this.emit('error', { ...response, error: response.error });\r\n      await this.notifyEvent('error', response, notifyChannel);\r\n\r\n      if (options?.rethrowOnError) {\r\n        cleanup();\r\n        throw error;\r\n      }\r\n\r\n      return response;\r\n    } finally {\r\n      cleanup();\r\n    }\r\n  }\r\n\r\n  protected createStreamingResult<TChunk, TResult>(\r\n    iterator: AsyncIterable<TChunk>,\r\n    context: StreamingContext<TChunk, TResult>,\r\n  ): StreamingResult<TChunk, TResult> {\r\n    const deferred = this.createDeferred<AIServiceResponse<TResult>>();\r\n    const self = this;\r\n\r\n    const asyncIterable: StreamingResult<TChunk, TResult> = {\r\n      summary: deferred.promise,\r\n      [Symbol.asyncIterator]() {\r\n        const inner = iterator[Symbol.asyncIterator]();\r\n        let finished = false;\r\n        return {\r\n          async next() {\r\n            if (finished) {\r\n              return { done: true, value: undefined as unknown as TChunk };\r\n            }\r\n\r\n            try {\r\n              const result = await inner.next();\r\n              if (!result.done) {\r\n                context.aggregate?.onChunk?.(result.value);\r\n                const provider = self.resolveProvider(result.value, context.service);\r\n                const payload = {\r\n                  requestId: context.requestId,\r\n                  service: self.serviceName,\r\n                  operation: context.operation,\r\n                  chunk: result.value,\r\n                  provider,\r\n                  metadata: context.metadata,\r\n                  timestamp: self.getTimestamp(),\r\n                };\r\n                self.emit('stream', payload);\r\n                void self.notifyEvent('stream', payload, context.notifyChannel);\r\n                return result;\r\n              }\r\n\r\n              finished = true;\r\n              const durationMs = Date.now() - context.startedAt;\r\n              const provider = self.resolveProvider(undefined, context.service);\r\n              const data = context.aggregate?.onComplete?.();\r\n              const response = context.customResponse\r\n                ? context.customResponse({ data, provider, durationMs, metadata: context.metadata })\r\n                : self.buildSuccessResponse({\r\n                    data,\r\n                    provider,\r\n                    requestId: context.requestId,\r\n                    operation: context.operation,\r\n                    durationMs,\r\n                    metadata: context.metadata,\r\n                  });\r\n\r\n              self.emit('response', response);\r\n              void self.notifyEvent('response', response, context.notifyChannel);\r\n              deferred.resolve(response);\r\n              context.cleanup();\r\n              return { done: true, value: undefined as unknown as TChunk };\r\n            } catch (error) {\r\n              finished = true;\r\n              const durationMs = Date.now() - context.startedAt;\r\n              const provider = self.resolveProvider(undefined, context.service);\r\n              const data = context.aggregate?.onError?.(error);\r\n              const response = self.buildErrorResponse<TResult>({\r\n                error,\r\n                provider,\r\n                requestId: context.requestId,\r\n                operation: context.operation,\r\n                durationMs,\r\n                metadata: context.metadata,\r\n              });\r\n              if (data !== undefined && response.success) {\r\n                response.data = data;\r\n              }\r\n              self.emit('error', { ...response, error: response.error });\r\n              void self.notifyEvent('error', response, context.notifyChannel);\r\n              deferred.resolve(response);\r\n              context.cleanup();\r\n              throw error;\r\n            }\r\n          },\r\n          async return(value?: any) {\r\n            context.cleanup();\r\n            if (typeof inner.return === 'function') {\r\n              await inner.return(value);\r\n            }\r\n            return { done: true, value };\r\n          },\r\n        };\r\n      },\r\n    };\r\n\r\n    return asyncIterable;\r\n  }\r\n\r\n  getConfig(): AIConfig {\r\n    return getAIConfig();\r\n  }\r\n\r\n  refreshConfig(): AIConfig {\r\n    return refreshAIConfig();\r\n  }\r\n\r\n  updateConfig(partial: Partial<AIConfig>): AIConfig {\r\n    return updateAIConfig(partial);\r\n  }\r\n\r\n  getProviderHealth(provider: AIProviderId): AIProviderHealth {\r\n    return getProviderHealthStatus(provider);\r\n  }\r\n\r\n  getAllProviderHealth(): AIProviderHealth[] {\r\n    return getAllProviderHealthStatus();\r\n  }\r\n\r\n  protected buildRuntimeOptions(options?: TOptions): AIProviderRuntimeOptions | undefined {\r\n    if (!options) {\r\n      return undefined;\r\n    }\r\n\r\n    const { provider: _provider, requestId: _requestId, notifyChannel: _notifyChannel, disableFallback: _disableFallback, tags: _tags, rethrowOnError: _rethrowOnError, ...runtime } = options;\r\n    const cleaned: Record<string, any> = {};\r\n    for (const [key, value] of Object.entries(runtime)) {\r\n      if (value !== undefined) {\r\n        cleaned[key] = value;\r\n      }\r\n    }\r\n    return Object.keys(cleaned).length > 0 ? (cleaned as AIProviderRuntimeOptions) : undefined;\r\n  }\r\n\r\n  protected createServiceInstance(\r\n    options: TOptions | undefined,\r\n    requestId: string,\r\n    operation: string,\r\n    notifyChannel: string,\r\n    metadata?: Record<string, any>,\r\n  ): { service: AIService; cleanup: () => void } {\r\n    const provider = options?.provider ?? this.defaultProvider;\r\n    const disableFallback = options?.disableFallback ?? this.defaultDisableFallback;\r\n\r\n    const serviceOptions: Record<string, any> = {};\r\n    if (provider) {\r\n      serviceOptions.provider = provider;\r\n    }\r\n    if (typeof disableFallback === 'boolean') {\r\n      serviceOptions.disableFallback = disableFallback;\r\n    }\r\n\r\n    serviceOptions.onUsage = (event: AIUsageEvent) => {\r\n      this.handleUsage(event, requestId, operation, notifyChannel, metadata);\r\n    };\r\n\r\n    const service = new AIService(serviceOptions);\r\n    return {\r\n      service,\r\n      cleanup: () => service.dispose(),\r\n    };\r\n  }\r\n\r\n  protected handleUsage(\r\n    event: AIUsageEvent,\r\n    requestId: string,\r\n    operation: string,\r\n    notifyChannel: string,\r\n    metadata?: Record<string, any>,\r\n  ): void {\r\n    const payload: AIUsageEventEnvelope = {\r\n      ...event,\r\n      requestId,\r\n      operation,\r\n      service: this.serviceName,\r\n      metadata,\r\n    };\r\n    this.emit('usage', payload);\r\n    void this.notifyEvent('usage', payload, notifyChannel);\r\n  }\r\n\r\n  protected resolveProvider(result: unknown, service: AIService): AIProviderId {\r\n    if (result && typeof result === 'object' && 'provider' in result) {\r\n      return (result as any).provider as AIProviderId;\r\n    }\r\n    return service.currentProvider;\r\n  }\r\n\r\n  protected resolveModel(result: unknown, runtime?: AIProviderRuntimeOptions): string | undefined {\r\n    if (!result) {\r\n      return runtime?.model;\r\n    }\r\n\r\n    if (typeof result === 'object') {\r\n      if ('model' in result && typeof (result as any).model === 'string') {\r\n        return (result as any).model;\r\n      }\r\n      if ('results' in result && Array.isArray((result as any).results)) {\r\n        const [first] = (result as any).results;\r\n        if (first && typeof first === 'object' && 'model' in first) {\r\n          return first.model;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (Array.isArray(result)) {\r\n      const [first] = result;\r\n      if (first && typeof first === 'object' && 'model' in first) {\r\n        return (first as any).model;\r\n      }\r\n    }\r\n\r\n    return runtime?.model;\r\n  }\r\n\r\n  protected resolveUsage(result: unknown): AIUsageMetrics | undefined {\r\n    if (!result) {\r\n      return undefined;\r\n    }\r\n\r\n    if (typeof result === 'object') {\r\n      if ('usage' in result && (result as any).usage) {\r\n        return (result as any).usage as AIUsageMetrics;\r\n      }\r\n      if ('results' in result && Array.isArray((result as any).results)) {\r\n        return this.combineUsage(((result as any).results as any[]).map((item) => item?.usage as AIUsageMetrics | undefined));\r\n      }\r\n    }\r\n\r\n    if (Array.isArray(result)) {\r\n      return this.combineUsage(result.map((item) => (item as any)?.usage as AIUsageMetrics | undefined));\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  protected combineUsage(usages: Array<AIUsageMetrics | undefined>): AIUsageMetrics | undefined {\r\n    const filtered = usages.filter((usage): usage is AIUsageMetrics => Boolean(usage));\r\n    if (filtered.length === 0) {\r\n      return undefined;\r\n    }\r\n    const base = { ...filtered[0] };\r\n    for (let index = 1; index < filtered.length; index += 1) {\r\n      const current = filtered[index];\r\n      if (!current) continue;\r\n      base.promptTokens = (base.promptTokens ?? 0) + (current.promptTokens ?? 0);\r\n      base.completionTokens = (base.completionTokens ?? 0) + (current.completionTokens ?? 0);\r\n      base.totalTokens = (base.totalTokens ?? 0) + (current.totalTokens ?? 0);\r\n      base.durationMs = (base.durationMs ?? 0) + (current.durationMs ?? 0);\r\n    }\r\n    return base;\r\n  }\r\n\r\n  protected buildSuccessResponse<T>(params: {\r\n    data: T;\r\n    provider: AIProviderId;\r\n    model?: string;\r\n    usage?: AIUsageMetrics;\r\n    requestId: string;\r\n    operation: string;\r\n    durationMs: number;\r\n    metadata?: Record<string, any>;\r\n    context?: Record<string, any>;\r\n  }): AIServiceResponse<T> {\r\n    return {\r\n      success: true,\r\n      data: params.data,\r\n      provider: params.provider,\r\n      model: params.model,\r\n      usage: params.usage,\r\n      service: this.serviceName,\r\n      operation: params.operation,\r\n      durationMs: params.durationMs,\r\n      timestamp: this.getTimestamp(),\r\n      requestId: params.requestId,\r\n      metadata: params.metadata,\r\n      context: params.context,\r\n    };\r\n  }\r\n\r\n  protected buildErrorResponse<T>(params: {\r\n    error: unknown;\r\n    provider: AIProviderId;\r\n    requestId: string;\r\n    operation: string;\r\n    durationMs: number;\r\n    metadata?: Record<string, any>;\r\n    context?: Record<string, any>;\r\n  }): AIServiceResponse<T> {\r\n    const message = params.error instanceof Error ? params.error.message : String(params.error ?? 'Unknown error');\r\n    return {\r\n      success: false,\r\n      error: message,\r\n      data: undefined,\r\n      provider: params.provider,\r\n      service: this.serviceName,\r\n      operation: params.operation,\r\n      durationMs: params.durationMs,\r\n      timestamp: this.getTimestamp(),\r\n      requestId: params.requestId,\r\n      metadata: params.metadata,\r\n      context: params.context,\r\n    };\r\n  }\r\n\r\n  protected buildContext(options?: TOptions): Record<string, any> | undefined {\r\n    if (!options?.tags && this.tags.length === 0) {\r\n      return undefined;\r\n    }\r\n    const tags = [...this.tags, ...(options?.tags ?? [])];\r\n    return tags.length > 0 ? { tags: Array.from(new Set(tags)) } : undefined;\r\n  }\r\n\r\n  protected async notifyEvent(event: string, payload: any, channel: string): Promise<void> {\r\n    if (!this.notificationsEnabled) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const enriched = {\r\n        event,\r\n        service: this.serviceName,\r\n        payload,\r\n      };\r\n      const serialized = JSON.stringify(enriched).replace(/'/g, \"''\");\r\n      const safeChannel = channel.replace(/[^a-zA-Z0-9_]/g, '');\r\n      const targetChannel = safeChannel.length > 0 ? safeChannel : this.notifyChannel;\r\n      await db.query(`NOTIFY ${targetChannel}, '${serialized}'`);\r\n    } catch (error) {\r\n      console.error('AIServiceBase notification error:', error);\r\n    }\r\n  }\r\n\r\n  protected mergeMetadata(\r\n    ...sources: Array<Record<string, any> | undefined>\r\n  ): Record<string, any> | undefined {\r\n    const merged: Record<string, any> = {};\r\n    for (const source of sources) {\r\n      if (source && typeof source === 'object') {\r\n        Object.assign(merged, source);\r\n      }\r\n    }\r\n    return Object.keys(merged).length > 0 ? merged : undefined;\r\n  }\r\n\r\n  protected generateRequestId(): string {\r\n    return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`;\r\n  }\r\n\r\n  protected getTimestamp(): string {\r\n    return new Date().toISOString();\r\n  }\r\n\r\n  private createDeferred<T>(): Deferred<T> {\r\n    let resolve!: (value: T | PromiseLike<T>) => void;\r\n    let reject!: (reason?: any) => void;\r\n    const promise = new Promise<T>((res, rej) => {\r\n      resolve = res;\r\n      reject = rej;\r\n    });\r\n    return {\r\n      promise,\r\n      resolve: (value: T) => resolve(value),\r\n      reject,\r\n    };\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\chat.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"require-yield","severity":2,"message":"This generator function does not have 'yield'.","line":225,"column":38,"nodeType":"FunctionExpression","messageId":"missingYield","endLine":227,"endColumn":10}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\nimport { createHash } from 'crypto';\r\nimport type {\r\n  AIChatMessage,\r\n  AIChatResult,\r\n  AIStreamChunk,\r\n} from '@/types/ai';\r\nimport {\r\n  AIServiceBase,\r\n  type AIServiceBaseOptions,\r\n  type AIServiceRequestOptions,\r\n  type AIServiceResponse,\r\n  type StreamingResult,\r\n} from './base';\r\nimport { PromptManager, type RenderPromptOptions } from './prompts';\r\n\r\nexport interface ChatRequestOptions extends AIServiceRequestOptions {\r\n  conversationId?: string;\r\n  persistHistory?: boolean;\r\n  maxHistory?: number;\r\n}\r\n\r\nexport interface ConversationOptions extends RenderPromptOptions {\r\n  id?: string;\r\n  systemPrompt?: string;\r\n  metadata?: Record<string, any>;\r\n  initialMessages?: AIChatMessage[];\r\n  maxHistory?: number;\r\n}\r\n\r\ninterface ConversationState {\r\n  id: string;\r\n  messages: AIChatMessage[];\r\n  metadata: Record<string, any>;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n  maxHistory: number;\r\n}\r\n\r\nexport interface AIChatServiceOptions extends AIServiceBaseOptions {\r\n  promptManager?: PromptManager;\r\n  defaultMaxHistory?: number;\r\n}\r\n\r\nexport class AIChatService extends AIServiceBase<ChatRequestOptions> {\r\n  private readonly promptManager: PromptManager;\r\n  private readonly conversations = new Map<string, ConversationState>();\r\n  private readonly defaultMaxHistory: number;\r\n\r\n  constructor(options?: AIChatServiceOptions) {\r\n    super('AIChatService', options);\r\n    this.promptManager = options?.promptManager ?? new PromptManager();\r\n    this.defaultMaxHistory = options?.defaultMaxHistory ?? 50;\r\n  }\r\n\r\n  createConversation(options: ConversationOptions = {}): ConversationState {\r\n    const id = options.id ?? this.generateConversationId(options.systemPrompt ?? 'conversation');\r\n    const now = new Date().toISOString();\r\n    const messages: AIChatMessage[] = [];\r\n\r\n    if (options.systemPrompt) {\r\n      messages.push({ role: 'system', content: options.systemPrompt });\r\n    }\r\n\r\n    if (options.templateId) {\r\n      const rendered = this.promptManager.renderTemplate(options.templateId, options);\r\n      messages.push({ role: 'system', content: rendered.prompt });\r\n    }\r\n\r\n    if (options.initialMessages) {\r\n      messages.push(...options.initialMessages);\r\n    }\r\n\r\n    const state: ConversationState = {\r\n      id,\r\n      messages: this.trimHistory(messages, options.maxHistory ?? this.defaultMaxHistory),\r\n      metadata: { ...(options.metadata ?? {}) },\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      maxHistory: options.maxHistory ?? this.defaultMaxHistory,\r\n    };\r\n\r\n    this.conversations.set(id, state);\r\n    return this.cloneConversation(state);\r\n  }\r\n\r\n  async chat(\r\n    messages: AIChatMessage[],\r\n    options: ChatRequestOptions = {},\r\n  ): Promise<AIServiceResponse<AIChatResult>> {\r\n    const conversationId = options.conversationId;\r\n    const metadata = this.mergeMetadata(options.metadata, conversationId ? { conversationId } : undefined);\r\n\r\n    const response = await this.executeOperation<AIChatResult>(\r\n      'chat.message',\r\n      async ({ service, runtimeOptions }) => service.chat(messages, runtimeOptions),\r\n      { ...options, metadata },\r\n      conversationId ? { conversationId } : undefined,\r\n    );\r\n\r\n    if (response.success && response.data && conversationId) {\r\n      this.appendAssistantResponse(conversationId, messages, response.data);\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  async continueConversation(\r\n    conversationId: string,\r\n    message: AIChatMessage,\r\n    options: ChatRequestOptions = {},\r\n  ): Promise<AIServiceResponse<AIChatResult>> {\r\n    const conversation = this.requireConversation(conversationId);\r\n    const history = [...conversation.messages, message];\r\n    const response = await this.chat(history, {\r\n      ...options,\r\n      conversationId,\r\n    });\r\n    if (response.success && response.data) {\r\n      this.appendAssistantResponse(conversationId, [message], response.data);\r\n    }\r\n    return response;\r\n  }\r\n\r\n  getConversationHistory(conversationId: string): ConversationState {\r\n    return this.cloneConversation(this.requireConversation(conversationId));\r\n  }\r\n\r\n  closeConversation(conversationId: string): void {\r\n    this.conversations.delete(conversationId);\r\n  }\r\n\r\n  async streamChat(\r\n    conversationId: string,\r\n    userMessage: AIChatMessage,\r\n    options: ChatRequestOptions = {},\r\n  ): Promise<StreamingResult<AIStreamChunk, { text: string; chunks: number }>> {\r\n    const conversation = this.requireConversation(conversationId);\r\n    const history = [...conversation.messages, userMessage];\r\n    const prompt = this.serializeMessages(history);\r\n\r\n    const requestId = options.requestId ?? this.generateRequestId();\r\n    const notifyChannel = options.notifyChannel ?? this.notifyChannel;\r\n    const metadata = this.mergeMetadata(this.defaultMetadata, options.metadata, {\r\n      conversationId,\r\n      stream: true,\r\n      promptHash: this.hashPrompt(prompt),\r\n    });\r\n    const startedAt = Date.now();\r\n\r\n    this.emit('request', {\r\n      requestId,\r\n      service: this.serviceName,\r\n      operation: 'chat.stream',\r\n      metadata,\r\n    });\r\n    await this.notifyEvent('request', {\r\n      requestId,\r\n      service: this.serviceName,\r\n      operation: 'chat.stream',\r\n      metadata,\r\n      timestamp: this.getTimestamp(),\r\n    }, notifyChannel);\r\n\r\n    const { service, cleanup } = this.createServiceInstance(options, requestId, 'chat.stream', notifyChannel, metadata);\r\n    const runtimeOptions = this.buildRuntimeOptions(options);\r\n\r\n    try {\r\n      const iterator = await service.streamText(prompt, runtimeOptions);\r\n      const aggregate = { text: '', chunks: 0 };\r\n\r\n      return this.createStreamingResult(iterator, {\r\n        requestId,\r\n        operation: 'chat.stream',\r\n        service,\r\n        notifyChannel,\r\n        metadata,\r\n        startedAt,\r\n        cleanup: () => {\r\n          cleanup();\r\n          if (aggregate.text) {\r\n            this.appendAssistantResponse(conversationId, [userMessage], {\r\n              text: aggregate.text,\r\n              provider: service.currentProvider,\r\n            } as AIChatResult);\r\n          }\r\n        },\r\n        aggregate: {\r\n          onChunk: (chunk) => {\r\n            aggregate.chunks += 1;\r\n            if (chunk.token) {\r\n              aggregate.text += chunk.token;\r\n            }\r\n          },\r\n          onComplete: () => aggregate,\r\n        },\r\n        customResponse: ({ data, provider, durationMs }) =>\r\n          this.buildSuccessResponse({\r\n            data: data ?? aggregate,\r\n            provider,\r\n            model: runtimeOptions?.model,\r\n            usage: undefined,\r\n            requestId,\r\n            operation: 'chat.stream',\r\n            durationMs,\r\n            metadata,\r\n          }),\r\n      });\r\n    } catch (error) {\r\n      cleanup();\r\n      const durationMs = Date.now() - startedAt;\r\n      const response = this.buildErrorResponse<{ text: string; chunks: number }>({\r\n        error,\r\n        provider: service.currentProvider,\r\n        requestId,\r\n        operation: 'chat.stream',\r\n        durationMs,\r\n        metadata,\r\n      });\r\n      this.emit('error', { ...response, error: response.error });\r\n      await this.notifyEvent('error', response, notifyChannel);\r\n\r\n      const failed: StreamingResult<AIStreamChunk, { text: string; chunks: number }> = {\r\n        summary: Promise.resolve(response),\r\n        async *[Symbol.asyncIterator]() {\r\n          throw error;\r\n        },\r\n      };\r\n      return failed;\r\n    }\r\n  }\r\n\r\n  private appendAssistantResponse(\r\n    conversationId: string,\r\n    userMessages: AIChatMessage[],\r\n    result: AIChatResult,\r\n  ): void {\r\n    const conversation = this.requireConversation(conversationId);\r\n    conversation.messages.push(...userMessages);\r\n\r\n    const assistantMessage: AIChatMessage = result.messages?.find((message) => message.role === 'assistant') ?? {\r\n      role: 'assistant',\r\n      content: result.text,\r\n    };\r\n\r\n    conversation.messages.push(assistantMessage);\r\n    conversation.messages = this.trimHistory(conversation.messages, conversation.maxHistory);\r\n    conversation.updatedAt = new Date().toISOString();\r\n    this.conversations.set(conversationId, conversation);\r\n  }\r\n\r\n  private requirementError(id: string): never {\r\n    throw new Error(`Conversation '${id}' not found.`);\r\n  }\r\n\r\n  private requireConversation(conversationId: string): ConversationState {\r\n    const conversation = this.conversations.get(conversationId);\r\n    if (!conversation) {\r\n      this.requirementError(conversationId);\r\n    }\r\n    return conversation!;\r\n  }\r\n\r\n  private trimHistory(messages: AIChatMessage[], maxHistory: number): AIChatMessage[] {\r\n    if (messages.length <= maxHistory) {\r\n      return [...messages];\r\n    }\r\n    return messages.slice(messages.length - maxHistory);\r\n  }\r\n\r\n  private cloneConversation(conversation: ConversationState): ConversationState {\r\n    return {\r\n      id: conversation.id,\r\n      messages: conversation.messages.map((message) => ({ ...message })),\r\n      metadata: { ...conversation.metadata },\r\n      createdAt: conversation.createdAt,\r\n      updatedAt: conversation.updatedAt,\r\n      maxHistory: conversation.maxHistory,\r\n    };\r\n  }\r\n\r\n  private serializeMessages(messages: AIChatMessage[]): string {\r\n    return messages\r\n      .map((message) => `${message.role.toUpperCase()}: ${message.content}`)\r\n      .join('\\n');\r\n  }\r\n\r\n  private generateConversationId(seed: string): string {\r\n    const hash = createHash('md5').update(`${seed}-${Date.now()}-${Math.random()}`).digest('hex');\r\n    return `conv_${hash.slice(0, 12)}`;\r\n  }\r\n\r\n  private hashPrompt(prompt: string): string {\r\n    return createHash('sha256').update(prompt).digest('hex');\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\forecast-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\n/**\n * Demand Forecast Service\n *\n * Production-grade demand forecasting service that integrates with:\n * - AIDatabaseService.generatePredictions() for AI-powered forecasting\n * - demand_forecast table for persistence and accuracy tracking\n * - Multi-horizon support (daily, weekly, monthly)\n * - Confidence interval calculation\n * - Accuracy metrics and performance tracking\n */\n\nimport { query, withTransaction } from '@/lib/database';\nimport { AIDatabaseService } from '../database-integration';\nimport { PoolClient } from 'pg';\n\n// ============================================================================\n// TYPES & INTERFACES\n// ============================================================================\n\nexport type ForecastHorizon = 'daily' | 'weekly' | 'monthly';\n\nexport interface ForecastPrediction {\n  date: string;\n  value: number;\n  confidence: number;\n  lower_bound?: number;\n  upper_bound?: number;\n}\n\nexport interface DemandForecast {\n  id: string;\n  org_id: string;\n  product_id: string;\n  forecast_date: string;\n  forecast_horizon: ForecastHorizon;\n  predicted_quantity: number;\n  lower_bound: number;\n  upper_bound: number;\n  confidence_interval: number;\n  algorithm_used: string;\n  actual_quantity: number | null;\n  accuracy_score: number | null;\n  metadata: Record<string, any>;\n  created_at: string;\n}\n\nexport interface ForecastListOptions {\n  productId?: string;\n  startDate?: Date;\n  endDate?: Date;\n  horizon?: ForecastHorizon;\n  limit?: number;\n  offset?: number;\n}\n\nexport interface GenerateForecastOptions {\n  productId: string;\n  horizon: ForecastHorizon;\n  days: number;\n  includeConfidenceIntervals?: boolean;\n  metadata?: Record<string, any>;\n}\n\nexport interface AccuracyMetrics {\n  horizon: ForecastHorizon;\n  total_forecasts: number;\n  forecasts_with_actuals: number;\n  average_accuracy: number;\n  median_accuracy: number;\n  accuracy_by_range: {\n    excellent: number; // > 0.9\n    good: number; // 0.7 - 0.9\n    fair: number; // 0.5 - 0.7\n    poor: number; // < 0.5\n  };\n  mean_absolute_error: number;\n  mean_absolute_percentage_error: number;\n}\n\n// ============================================================================\n// DEMAND FORECAST SERVICE\n// ============================================================================\n\nexport class DemandForecastService {\n  private aiDatabase: AIDatabaseService;\n  private readonly CONFIDENCE_LEVEL = 0.95; // 95% confidence interval\n\n  constructor() {\n    this.aiDatabase = new AIDatabaseService();\n  }\n\n  /**\n   * List forecasts with filters and pagination\n   */\n  async listForecasts(\n    orgId: string,\n    options: ForecastListOptions = {}\n  ): Promise<{ forecasts: DemandForecast[]; total: number }> {\n    const { productId, startDate, endDate, horizon, limit = 50, offset = 0 } = options;\n\n    // Build dynamic WHERE clause\n    const conditions: string[] = ['org_id = $1'];\n    const params: any[] = [orgId];\n    let paramIndex = 2;\n\n    if (productId) {\n      conditions.push(`product_id = $${paramIndex++}`);\n      params.push(productId);\n    }\n\n    if (startDate) {\n      conditions.push(`forecast_date >= $${paramIndex++}`);\n      params.push(startDate.toISOString().split('T')[0]);\n    }\n\n    if (endDate) {\n      conditions.push(`forecast_date <= $${paramIndex++}`);\n      params.push(endDate.toISOString().split('T')[0]);\n    }\n\n    if (horizon) {\n      conditions.push(`forecast_horizon = $${paramIndex++}`);\n      params.push(horizon);\n    }\n\n    const whereClause = conditions.join(' AND ');\n\n    // Get total count\n    const countResult = await query<{ count: string }>(\n      `SELECT COUNT(*) as count FROM demand_forecast WHERE ${whereClause}`,\n      params\n    );\n    const total = parseInt(countResult.rows[0]?.count || '0', 10);\n\n    // Get paginated results\n    const result = await query<DemandForecast>(\n      `SELECT\n        id, org_id, product_id, forecast_date, forecast_horizon,\n        predicted_quantity, lower_bound, upper_bound, confidence_interval,\n        algorithm_used, actual_quantity, accuracy_score, metadata, created_at\n      FROM demand_forecast\n      WHERE ${whereClause}\n      ORDER BY forecast_date DESC, created_at DESC\n      LIMIT $${paramIndex} OFFSET $${paramIndex + 1}`,\n      [...params, limit, offset]\n    );\n\n    return {\n      forecasts: result.rows,\n      total,\n    };\n  }\n\n  /**\n   * Generate demand forecast using AI\n   */\n  async generateForecast(\n    orgId: string,\n    options: GenerateForecastOptions\n  ): Promise<DemandForecast[]> {\n    const { productId, horizon, days, includeConfidenceIntervals = true, metadata = {} } = options;\n\n    // Validate inputs\n    if (days < 1 || days > 365) {\n      throw new Error('Forecast days must be between 1 and 365');\n    }\n\n    // Use AIDatabaseService to generate AI-powered predictions\n    const aiPrediction = await this.aiDatabase.generatePredictions({\n      type: 'inventory_demand',\n      target_id: parseInt(productId, 10), // Convert UUID to numeric for AI service\n      forecast_days: days,\n    });\n\n    // Transform AI predictions into database records\n    const forecasts: DemandForecast[] = [];\n\n    return withTransaction(async (client: PoolClient) => {\n      for (const prediction of aiPrediction.predictions) {\n        const forecastDate = new Date(prediction.date);\n\n        // Calculate bounds based on confidence\n        const predictedQty = prediction.value;\n        const confidence = prediction.confidence;\n\n        // Use AI-provided bounds or calculate from confidence\n        const lowerBound = prediction.lower_bound ?? predictedQty * (1 - (1 - confidence) * 2);\n        const upperBound = prediction.upper_bound ?? predictedQty * (1 + (1 - confidence) * 2);\n\n        // Upsert forecast (update if exists, insert if not)\n        const result = await client.query<DemandForecast>(\n          `INSERT INTO demand_forecast (\n            org_id, product_id, forecast_date, forecast_horizon,\n            predicted_quantity, lower_bound, upper_bound, confidence_interval,\n            algorithm_used, metadata\n          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\n          ON CONFLICT (org_id, product_id, forecast_date, forecast_horizon)\n          DO UPDATE SET\n            predicted_quantity = EXCLUDED.predicted_quantity,\n            lower_bound = EXCLUDED.lower_bound,\n            upper_bound = EXCLUDED.upper_bound,\n            confidence_interval = EXCLUDED.confidence_interval,\n            algorithm_used = EXCLUDED.algorithm_used,\n            metadata = EXCLUDED.metadata,\n            created_at = NOW()\n          RETURNING *`,\n          [\n            orgId,\n            productId,\n            forecastDate.toISOString().split('T')[0],\n            horizon,\n            predictedQty,\n            lowerBound,\n            upperBound,\n            this.CONFIDENCE_LEVEL,\n            'claude-3.5-sonnet-forecasting', // Algorithm identifier\n            JSON.stringify({\n              ...metadata,\n              ai_confidence: confidence,\n              factors: aiPrediction.factors,\n              recommendations: aiPrediction.recommendations,\n            }),\n          ]\n        );\n\n        forecasts.push(result.rows[0]);\n      }\n\n      return forecasts;\n    });\n  }\n\n  /**\n   * Update actual quantity and calculate accuracy score\n   */\n  async updateActualQuantity(\n    forecastId: string,\n    actualQuantity: number\n  ): Promise<DemandForecast> {\n    return withTransaction(async (client: PoolClient) => {\n      // Get the forecast\n      const forecastResult = await client.query<DemandForecast>(\n        `SELECT * FROM demand_forecast WHERE id = $1`,\n        [forecastId]\n      );\n\n      if (forecastResult.rows.length === 0) {\n        throw new Error(`Forecast ${forecastId} not found`);\n      }\n\n      const forecast = forecastResult.rows[0];\n\n      // Calculate accuracy score\n      const accuracyScore = this.calculateAccuracyScore(\n        forecast.predicted_quantity,\n        actualQuantity,\n        forecast.lower_bound,\n        forecast.upper_bound\n      );\n\n      // Update the record\n      const result = await client.query<DemandForecast>(\n        `UPDATE demand_forecast\n        SET actual_quantity = $1, accuracy_score = $2\n        WHERE id = $3\n        RETURNING *`,\n        [actualQuantity, accuracyScore, forecastId]\n      );\n\n      return result.rows[0];\n    });\n  }\n\n  /**\n   * Get accuracy metrics for an organization by horizon\n   */\n  async getAccuracyMetrics(\n    orgId: string,\n    horizon?: ForecastHorizon\n  ): Promise<AccuracyMetrics[]> {\n    // Build query to group by horizon\n    const horizonFilter = horizon ? `AND forecast_horizon = $2` : '';\n    const params = horizon ? [orgId, horizon] : [orgId];\n\n    const result = await query<{\n      forecast_horizon: ForecastHorizon;\n      total_forecasts: string;\n      forecasts_with_actuals: string;\n      avg_accuracy: string;\n      median_accuracy: string;\n      excellent_count: string;\n      good_count: string;\n      fair_count: string;\n      poor_count: string;\n      mean_abs_error: string;\n      mean_abs_pct_error: string;\n    }>(\n      `SELECT\n        forecast_horizon,\n        COUNT(*) as total_forecasts,\n        COUNT(actual_quantity) as forecasts_with_actuals,\n        AVG(accuracy_score) as avg_accuracy,\n        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY accuracy_score) as median_accuracy,\n        COUNT(CASE WHEN accuracy_score > 0.9 THEN 1 END) as excellent_count,\n        COUNT(CASE WHEN accuracy_score > 0.7 AND accuracy_score <= 0.9 THEN 1 END) as good_count,\n        COUNT(CASE WHEN accuracy_score > 0.5 AND accuracy_score <= 0.7 THEN 1 END) as fair_count,\n        COUNT(CASE WHEN accuracy_score <= 0.5 THEN 1 END) as poor_count,\n        AVG(ABS(predicted_quantity - actual_quantity)) as mean_abs_error,\n        AVG(ABS(predicted_quantity - actual_quantity) / NULLIF(actual_quantity, 0)) as mean_abs_pct_error\n      FROM demand_forecast\n      WHERE org_id = $1 ${horizonFilter}\n      GROUP BY forecast_horizon\n      ORDER BY forecast_horizon`,\n      params\n    );\n\n    return result.rows.map((row) => ({\n      horizon: row.forecast_horizon,\n      total_forecasts: parseInt(row.total_forecasts, 10),\n      forecasts_with_actuals: parseInt(row.forecasts_with_actuals, 10),\n      average_accuracy: parseFloat(row.avg_accuracy) || 0,\n      median_accuracy: parseFloat(row.median_accuracy) || 0,\n      accuracy_by_range: {\n        excellent: parseInt(row.excellent_count, 10),\n        good: parseInt(row.good_count, 10),\n        fair: parseInt(row.fair_count, 10),\n        poor: parseInt(row.poor_count, 10),\n      },\n      mean_absolute_error: parseFloat(row.mean_abs_error) || 0,\n      mean_absolute_percentage_error: parseFloat(row.mean_abs_pct_error) || 0,\n    }));\n  }\n\n  /**\n   * Get forecast by ID\n   */\n  async getForecastById(forecastId: string): Promise<DemandForecast | null> {\n    const result = await query<DemandForecast>(\n      `SELECT * FROM demand_forecast WHERE id = $1`,\n      [forecastId]\n    );\n\n    return result.rows[0] || null;\n  }\n\n  /**\n   * Delete forecasts older than specified date\n   */\n  async cleanupOldForecasts(\n    orgId: string,\n    olderThanDate: Date\n  ): Promise<number> {\n    const result = await query(\n      `DELETE FROM demand_forecast\n      WHERE org_id = $1 AND forecast_date < $2`,\n      [orgId, olderThanDate.toISOString().split('T')[0]]\n    );\n\n    return result.rowCount;\n  }\n\n  // ============================================================================\n  // PRIVATE HELPER METHODS\n  // ============================================================================\n\n  /**\n   * Calculate accuracy score for a forecast\n   *\n   * Scoring methodology:\n   * 1. Perfect prediction (actual = predicted): 1.0\n   * 2. Within confidence bounds: 0.7 - 0.99 (based on distance from predicted)\n   * 3. Outside bounds: 0.0 - 0.69 (based on distance from nearest bound)\n   */\n  private calculateAccuracyScore(\n    predicted: number,\n    actual: number,\n    lowerBound: number,\n    upperBound: number\n  ): number {\n    // Avoid division by zero\n    if (predicted === 0) {\n      return actual === 0 ? 1.0 : 0.0;\n    }\n\n    const absError = Math.abs(predicted - actual);\n    const relativeError = absError / predicted;\n\n    // Perfect prediction\n    if (absError === 0) {\n      return 1.0;\n    }\n\n    // Within confidence bounds - high accuracy\n    if (actual >= lowerBound && actual <= upperBound) {\n      // Linear scale from 0.7 to 0.99 based on how close to predicted value\n      const range = upperBound - lowerBound;\n      const distanceFromPredicted = absError;\n      const normalizedDistance = range > 0 ? distanceFromPredicted / range : 0;\n\n      // Score decreases as distance from predicted increases\n      return Math.max(0.7, 0.99 - normalizedDistance * 0.29);\n    }\n\n    // Outside bounds - lower accuracy\n    // Calculate distance from nearest bound\n    const distanceFromBounds = actual < lowerBound\n      ? lowerBound - actual\n      : actual - upperBound;\n\n    const boundRange = upperBound - lowerBound;\n    const normalizedOutsideDistance = boundRange > 0 ? distanceFromBounds / boundRange : 1;\n\n    // Score decreases rapidly as distance from bounds increases\n    return Math.max(0.0, 0.7 - normalizedOutsideDistance * 0.7);\n  }\n\n  /**\n   * Calculate days between forecast horizons\n   */\n  private getDaysForHorizon(horizon: ForecastHorizon, count: number = 1): number {\n    switch (horizon) {\n      case 'daily':\n        return count;\n      case 'weekly':\n        return count * 7;\n      case 'monthly':\n        return count * 30;\n      default:\n        return count;\n    }\n  }\n}\n\n// Export singleton instance\nexport const demandForecastService = new DemandForecastService();\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\metrics-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":478,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":478,"endColumn":40,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13065,13306],"text":"{ const dayOfWeek = now.getDay();\n        startDate.setDate(now.getDate() - dayOfWeek);\n        startDate.setHours(0, 0, 0, 0);\n        endDate.setDate(now.getDate() + (6 - dayOfWeek));\n        endDate.setHours(23, 59, 59, 999);\n        break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-const-assign","severity":2,"message":"'endDate' is constant.","line":487,"column":9,"nodeType":"Identifier","messageId":"const","endLine":487,"endColumn":16},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":491,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":491,"endColumn":56,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13545,13768],"text":"{ const quarter = Math.floor(now.getMonth() / 3);\n        startDate = new Date(now.getFullYear(), quarter * 3, 1, 0, 0, 0, 0);\n        endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0, 23, 59, 59, 999);\n        break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-const-assign","severity":2,"message":"'endDate' is constant.","line":493,"column":9,"nodeType":"Identifier","messageId":"const","endLine":493,"endColumn":16},{"ruleId":"no-const-assign","severity":2,"message":"'endDate' is constant.","line":498,"column":9,"nodeType":"Identifier","messageId":"const","endLine":498,"endColumn":16}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\n/**\n * AI Metrics Service\n *\n * Production-ready service for managing analytics metrics cache.\n * Integrates with analytics_metric_cache table and MetricsCalculator.\n *\n * Features:\n * - Intelligent caching with configurable TTL\n * - Automatic recalculation and invalidation\n * - Multi-metric type support\n * - Performance optimized queries\n * - Production error handling\n */\n\nimport { db } from '@/lib/database';\nimport { MetricsCalculator } from '@/lib/analytics/MetricsCalculator';\nimport type {\n  MetricType,\n  TimePeriod,\n  SalesMetrics,\n  InventoryMetrics,\n  SupplierPerformanceMetrics,\n} from '@/lib/analytics/MetricsCalculator';\n\n// ============================================================================\n// Types & Interfaces\n// ============================================================================\n\nexport type { MetricType, TimePeriod };\n\nexport interface TimeRange {\n  startDate: Date;\n  endDate: Date;\n}\n\nexport interface CachedMetric {\n  id: string;\n  orgId: string;\n  metricType: MetricType;\n  metricKey: string;\n  metricValue: any;\n  timePeriod: TimePeriod;\n  periodStart: Date;\n  periodEnd: Date;\n  calculatedAt: Date;\n}\n\nexport interface MetricOptions {\n  period?: TimePeriod;\n  fresh?: boolean;\n  cacheMaxAge?: number; // seconds\n}\n\nexport interface MetricsSummary {\n  summary: {\n    totalPredictions: number;\n    averageAccuracy: number;\n    activeAlerts: number;\n    resolvedAlerts: number;\n  };\n  byService: Record<string, any>;\n  trends: Record<string, any>;\n  calculatedAt: string;\n  cacheExpires: string;\n}\n\n// ============================================================================\n// Constants\n// ============================================================================\n\nconst DEFAULT_CACHE_TTL = 5 * 60; // 5 minutes in seconds\nconst METRIC_KEYS = {\n  sales: 'daily_sales_summary',\n  inventory: 'inventory_snapshot',\n  supplier_performance: 'supplier_performance_summary',\n  customer_behavior: 'customer_behavior_summary',\n  financial: 'financial_summary',\n  operational: 'operational_summary',\n} as const;\n\n// ============================================================================\n// AI Metrics Service\n// ============================================================================\n\nexport class AIMetricsService {\n  /**\n   * Get metrics with intelligent caching\n   *\n   * @param orgId - Organization ID\n   * @param metricType - Type of metric to retrieve\n   * @param options - Optional parameters for period, freshness, and cache control\n   * @returns Cached or freshly calculated metrics\n   */\n  static async getMetrics(\n    orgId: string,\n    metricType: MetricType,\n    options: MetricOptions = {}\n  ): Promise<any> {\n    const { period = 'daily', fresh = false, cacheMaxAge = DEFAULT_CACHE_TTL } = options;\n\n    // If not requesting fresh data, try to get from cache\n    if (!fresh) {\n      const cached = await this.getCachedMetric(orgId, metricType, period, cacheMaxAge);\n      if (cached) {\n        return cached.metricValue;\n      }\n    }\n\n    // Calculate fresh metrics\n    const timeRange = this.getTimeRangeForPeriod(period);\n    const metrics = await this.calculateMetric(orgId, metricType, timeRange);\n\n    // Cache the calculated metrics\n    await this.cacheMetric(orgId, metricType, metrics, period, timeRange);\n\n    return metrics;\n  }\n\n  /**\n   * Calculate metrics for a specific type and time range\n   *\n   * @param orgId - Organization ID\n   * @param metricType - Type of metric to calculate\n   * @param timeRange - Time range for calculation\n   * @returns Calculated metric data\n   */\n  static async calculateMetric(\n    orgId: string,\n    metricType: MetricType,\n    timeRange: TimeRange\n  ): Promise<any> {\n    const { startDate, endDate } = timeRange;\n\n    switch (metricType) {\n      case 'sales':\n        return await MetricsCalculator.calculateSalesMetrics(\n          orgId,\n          startDate,\n          endDate\n        );\n\n      case 'inventory':\n        return await MetricsCalculator.calculateInventoryMetrics(orgId);\n\n      case 'supplier_performance':\n        return await MetricsCalculator.calculateSupplierMetrics(orgId);\n\n      case 'customer_behavior':\n        return await this.calculateCustomerBehaviorMetrics(orgId, startDate, endDate);\n\n      case 'financial':\n        return await this.calculateFinancialMetrics(orgId, startDate, endDate);\n\n      case 'operational':\n        return await this.calculateOperationalMetrics(orgId, startDate, endDate);\n\n      default:\n        throw new Error(`Unsupported metric type: ${metricType}`);\n    }\n  }\n\n  /**\n   * Get metrics by specific key\n   *\n   * @param orgId - Organization ID\n   * @param metricType - Type of metric\n   * @param key - Specific metric key\n   * @returns Metric value or null\n   */\n  static async getMetricsByKey(\n    orgId: string,\n    metricType: MetricType,\n    key: string\n  ): Promise<any | null> {\n    const result = await db.query(\n      `\n      SELECT metric_value, calculated_at\n      FROM analytics_metric_cache\n      WHERE org_id = $1\n        AND metric_type = $2\n        AND metric_key = $3\n      ORDER BY calculated_at DESC\n      LIMIT 1\n      `,\n      [orgId, metricType, key]\n    );\n\n    if (result.rows.length === 0) {\n      return null;\n    }\n\n    return result.rows[0].metric_value;\n  }\n\n  /**\n   * Invalidate metric cache for a specific type\n   *\n   * @param orgId - Organization ID\n   * @param metricType - Type of metric to invalidate (optional, invalidates all if not provided)\n   * @returns Number of cache entries invalidated\n   */\n  static async invalidateMetricCache(\n    orgId: string,\n    metricType?: MetricType\n  ): Promise<number> {\n    if (metricType) {\n      const result = await db.query(\n        `\n        DELETE FROM analytics_metric_cache\n        WHERE org_id = $1 AND metric_type = $2\n        RETURNING id\n        `,\n        [orgId, metricType]\n      );\n      return result.rows.length;\n    } else {\n      // Invalidate all metrics for the organization\n      const result = await db.query(\n        `\n        DELETE FROM analytics_metric_cache\n        WHERE org_id = $1\n        RETURNING id\n        `,\n        [orgId]\n      );\n      return result.rows.length;\n    }\n  }\n\n  /**\n   * Recalculate multiple metrics\n   *\n   * @param orgId - Organization ID\n   * @param metricTypes - Array of metric types to recalculate\n   * @returns Object with recalculated metrics\n   */\n  static async recalculateMetrics(\n    orgId: string,\n    metricTypes: MetricType[]\n  ): Promise<Record<MetricType, any>> {\n    const results: Record<string, any> = {};\n\n    for (const metricType of metricTypes) {\n      // Invalidate existing cache\n      await this.invalidateMetricCache(orgId, metricType);\n\n      // Recalculate\n      const timeRange = this.getTimeRangeForPeriod('daily');\n      const metrics = await this.calculateMetric(orgId, metricType, timeRange);\n\n      // Cache new values\n      await this.cacheMetric(orgId, metricType, metrics, 'daily', timeRange);\n\n      results[metricType] = metrics;\n    }\n\n    return results;\n  }\n\n  /**\n   * Get comprehensive metrics summary (for main metrics endpoint)\n   *\n   * @param orgId - Organization ID\n   * @param timeRange - Optional time range\n   * @returns Comprehensive metrics summary\n   */\n  static async getMetricsSummary(\n    orgId: string,\n    timeRange?: TimeRange\n  ): Promise<MetricsSummary> {\n    const range = timeRange || this.getTimeRangeForPeriod('daily');\n\n    // Get AI service health metrics\n    const aiHealthResult = await db.query(\n      `\n      SELECT * FROM get_ai_service_health($1)\n      `,\n      [orgId]\n    );\n\n    // Aggregate AI metrics\n    let totalPredictions = 0;\n    let totalConfidence = 0;\n    let activeAlerts = 0;\n    const byService: Record<string, any> = {};\n\n    aiHealthResult.rows.forEach((row) => {\n      const predictions = parseInt(row.total_predictions || '0');\n      const confidence = parseFloat(row.avg_confidence || '0');\n      const alerts = parseInt(row.active_alerts || '0');\n\n      totalPredictions += predictions;\n      totalConfidence += confidence * predictions;\n      activeAlerts += alerts;\n\n      byService[row.service_type] = {\n        predictions,\n        accuracy: confidence,\n        alerts,\n        lastPrediction: row.last_prediction,\n      };\n    });\n\n    const averageAccuracy = totalPredictions > 0\n      ? totalConfidence / totalPredictions\n      : 0;\n\n    // Get resolved alerts count\n    const resolvedAlertsResult = await db.query(\n      `\n      SELECT COUNT(*) as count\n      FROM ai_alert\n      WHERE org_id = $1\n        AND is_resolved = true\n        AND created_at >= $2\n        AND created_at <= $3\n      `,\n      [orgId, range.startDate, range.endDate]\n    );\n\n    const resolvedAlerts = parseInt(resolvedAlertsResult.rows[0]?.count || '0');\n\n    // Calculate trends (compare with previous period)\n    const previousRange = this.getPreviousPeriod(range);\n    const previousHealthResult = await db.query(\n      `\n      SELECT\n        COUNT(DISTINCT id) as predictions,\n        AVG(confidence_score) as avg_confidence\n      FROM ai_prediction\n      WHERE org_id = $1\n        AND created_at >= $2\n        AND created_at <= $3\n      `,\n      [orgId, previousRange.startDate, previousRange.endDate]\n    );\n\n    const previousPredictions = parseInt(previousHealthResult.rows[0]?.predictions || '0');\n    const previousConfidence = parseFloat(previousHealthResult.rows[0]?.avg_confidence || '0');\n\n    const predictionChange = previousPredictions > 0\n      ? ((totalPredictions - previousPredictions) / previousPredictions) * 100\n      : 0;\n\n    const accuracyChange = previousConfidence > 0\n      ? ((averageAccuracy - previousConfidence) / previousConfidence) * 100\n      : 0;\n\n    const now = new Date();\n    const cacheExpires = new Date(now.getTime() + DEFAULT_CACHE_TTL * 1000);\n\n    return {\n      summary: {\n        totalPredictions,\n        averageAccuracy,\n        activeAlerts,\n        resolvedAlerts,\n      },\n      byService,\n      trends: {\n        predictions: {\n          change: predictionChange,\n          direction: predictionChange > 0 ? 'increasing' : predictionChange < 0 ? 'decreasing' : 'stable',\n        },\n        accuracy: {\n          change: accuracyChange,\n          direction: accuracyChange > 0 ? 'improving' : accuracyChange < 0 ? 'declining' : 'stable',\n        },\n      },\n      calculatedAt: now.toISOString(),\n      cacheExpires: cacheExpires.toISOString(),\n    };\n  }\n\n  // ============================================================================\n  // Private Helper Methods\n  // ============================================================================\n\n  /**\n   * Get cached metric from database\n   */\n  private static async getCachedMetric(\n    orgId: string,\n    metricType: MetricType,\n    period: TimePeriod,\n    maxAge: number\n  ): Promise<CachedMetric | null> {\n    const result = await db.query(\n      `\n      SELECT *\n      FROM analytics_metric_cache\n      WHERE org_id = $1\n        AND metric_type = $2\n        AND time_period = $3\n        AND calculated_at >= NOW() - INTERVAL '1 second' * $4\n      ORDER BY calculated_at DESC\n      LIMIT 1\n      `,\n      [orgId, metricType, period, maxAge]\n    );\n\n    if (result.rows.length === 0) {\n      return null;\n    }\n\n    const row = result.rows[0];\n    return {\n      id: row.id,\n      orgId: row.org_id,\n      metricType: row.metric_type,\n      metricKey: row.metric_key,\n      metricValue: row.metric_value,\n      timePeriod: row.time_period,\n      periodStart: new Date(row.period_start),\n      periodEnd: new Date(row.period_end),\n      calculatedAt: new Date(row.calculated_at),\n    };\n  }\n\n  /**\n   * Cache metric in database\n   */\n  private static async cacheMetric(\n    orgId: string,\n    metricType: MetricType,\n    metricValue: any,\n    period: TimePeriod,\n    timeRange: TimeRange\n  ): Promise<void> {\n    const metricKey = METRIC_KEYS[metricType] || `${metricType}_summary`;\n\n    await db.query(\n      `\n      INSERT INTO analytics_metric_cache (\n        org_id, metric_type, metric_key, metric_value,\n        time_period, period_start, period_end\n      )\n      VALUES ($1, $2, $3, $4, $5, $6, $7)\n      ON CONFLICT (org_id, metric_type, metric_key, period_start)\n      DO UPDATE SET\n        metric_value = EXCLUDED.metric_value,\n        period_end = EXCLUDED.period_end,\n        calculated_at = NOW()\n      `,\n      [\n        orgId,\n        metricType,\n        metricKey,\n        JSON.stringify(metricValue),\n        period,\n        timeRange.startDate,\n        timeRange.endDate,\n      ]\n    );\n  }\n\n  /**\n   * Get time range for a given period\n   */\n  private static getTimeRangeForPeriod(period: TimePeriod): TimeRange {\n    const now = new Date();\n    const endDate = new Date(now);\n    let startDate = new Date(now);\n\n    switch (period) {\n      case 'hourly':\n        startDate.setHours(now.getHours(), 0, 0, 0);\n        endDate.setHours(now.getHours(), 59, 59, 999);\n        break;\n\n      case 'daily':\n        startDate.setHours(0, 0, 0, 0);\n        endDate.setHours(23, 59, 59, 999);\n        break;\n\n      case 'weekly':\n        const dayOfWeek = now.getDay();\n        startDate.setDate(now.getDate() - dayOfWeek);\n        startDate.setHours(0, 0, 0, 0);\n        endDate.setDate(now.getDate() + (6 - dayOfWeek));\n        endDate.setHours(23, 59, 59, 999);\n        break;\n\n      case 'monthly':\n        startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);\n        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);\n        break;\n\n      case 'quarterly':\n        const quarter = Math.floor(now.getMonth() / 3);\n        startDate = new Date(now.getFullYear(), quarter * 3, 1, 0, 0, 0, 0);\n        endDate = new Date(now.getFullYear(), quarter * 3 + 3, 0, 23, 59, 59, 999);\n        break;\n\n      case 'yearly':\n        startDate = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);\n        endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);\n        break;\n    }\n\n    return { startDate, endDate };\n  }\n\n  /**\n   * Get previous period for trend calculation\n   */\n  private static getPreviousPeriod(timeRange: TimeRange): TimeRange {\n    const duration = timeRange.endDate.getTime() - timeRange.startDate.getTime();\n    return {\n      startDate: new Date(timeRange.startDate.getTime() - duration),\n      endDate: new Date(timeRange.endDate.getTime() - duration),\n    };\n  }\n\n  /**\n   * Calculate customer behavior metrics\n   */\n  private static async calculateCustomerBehaviorMetrics(\n    orgId: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<any> {\n    const result = await db.query(\n      `\n      WITH customer_stats AS (\n        SELECT\n          COUNT(DISTINCT c.id) as total_customers,\n          COUNT(DISTINCT c.id) FILTER (\n            WHERE c.last_order_date >= $2\n          ) as active_customers,\n          COUNT(DISTINCT o.id) as total_orders,\n          COALESCE(AVG(o.total_amount), 0) as avg_order_value\n        FROM customers c\n        LEFT JOIN orders o ON o.customer_id = c.id\n          AND o.created_at BETWEEN $2 AND $3\n        WHERE c.org_id = $1\n      )\n      SELECT * FROM customer_stats\n      `,\n      [orgId, startDate, endDate]\n    );\n\n    const row = result.rows[0] || {};\n    return {\n      totalCustomers: parseInt(row.total_customers || '0'),\n      activeCustomers: parseInt(row.active_customers || '0'),\n      totalOrders: parseInt(row.total_orders || '0'),\n      avgOrderValue: parseFloat(row.avg_order_value || '0'),\n      retentionRate: row.total_customers > 0\n        ? (parseInt(row.active_customers || '0') / parseInt(row.total_customers || '1')) * 100\n        : 0,\n    };\n  }\n\n  /**\n   * Calculate financial metrics\n   */\n  private static async calculateFinancialMetrics(\n    orgId: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<any> {\n    const result = await db.query(\n      `\n      WITH financial_data AS (\n        SELECT\n          COALESCE(SUM(o.total_amount), 0) as revenue,\n          COALESCE(SUM(po.total_amount), 0) as expenses,\n          COUNT(DISTINCT o.id) as order_count,\n          COUNT(DISTINCT po.id) as purchase_count\n        FROM orders o\n        FULL OUTER JOIN purchase_orders po ON po.org_id = o.org_id\n        WHERE (o.org_id = $1 OR po.org_id = $1)\n          AND (o.created_at BETWEEN $2 AND $3 OR po.created_at BETWEEN $2 AND $3)\n          AND (o.status = 'completed' OR po.status = 'completed')\n      )\n      SELECT * FROM financial_data\n      `,\n      [orgId, startDate, endDate]\n    );\n\n    const row = result.rows[0] || {};\n    const revenue = parseFloat(row.revenue || '0');\n    const expenses = parseFloat(row.expenses || '0');\n    const profit = revenue - expenses;\n    const margin = revenue > 0 ? (profit / revenue) * 100 : 0;\n\n    return {\n      revenue,\n      expenses,\n      profit,\n      margin,\n      orderCount: parseInt(row.order_count || '0'),\n      purchaseCount: parseInt(row.purchase_count || '0'),\n    };\n  }\n\n  /**\n   * Calculate operational metrics\n   */\n  private static async calculateOperationalMetrics(\n    orgId: string,\n    startDate: Date,\n    endDate: Date\n  ): Promise<any> {\n    const result = await db.query(\n      `\n      WITH operational_data AS (\n        SELECT\n          COUNT(DISTINCT o.id) as total_orders,\n          COUNT(DISTINCT o.id) FILTER (WHERE o.status = 'completed') as completed_orders,\n          COUNT(DISTINCT o.id) FILTER (WHERE o.status = 'cancelled') as cancelled_orders,\n          COALESCE(AVG(EXTRACT(EPOCH FROM (o.updated_at - o.created_at))), 0) as avg_processing_time\n        FROM orders o\n        WHERE o.org_id = $1\n          AND o.created_at BETWEEN $2 AND $3\n      )\n      SELECT * FROM operational_data\n      `,\n      [orgId, startDate, endDate]\n    );\n\n    const row = result.rows[0] || {};\n    const totalOrders = parseInt(row.total_orders || '0');\n    const completedOrders = parseInt(row.completed_orders || '0');\n    const cancelledOrders = parseInt(row.cancelled_orders || '0');\n\n    return {\n      totalOrders,\n      completedOrders,\n      cancelledOrders,\n      completionRate: totalOrders > 0 ? (completedOrders / totalOrders) * 100 : 0,\n      cancellationRate: totalOrders > 0 ? (cancelledOrders / totalOrders) * 100 : 0,\n      avgProcessingTime: parseFloat(row.avg_processing_time || '0'),\n      efficiency: totalOrders > 0 ? (completedOrders / totalOrders) * 100 : 0,\n    };\n  }\n}\n\nexport default AIMetricsService;\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\prediction-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\n/**\n * AI Prediction Service\n *\n * Production-ready service for managing AI predictions with:\n * - Database integration with ai_prediction and ai_predictions tables\n * - Caching with expiration tracking\n * - Accuracy tracking with actual outcomes\n * - Integration with AIDatabaseService for prediction generation\n *\n * @module lib/ai/services/prediction-service\n */\n\nimport { query, withTransaction } from '@/lib/database';\nimport { AIDatabaseService } from '@/lib/ai/database-integration';\nimport { PoolClient } from 'pg';\nimport { PredictionError } from '@/lib/ai/errors';\n\n// ============================================================================\n// TYPES & INTERFACES\n// ============================================================================\n\nexport type ServiceType =\n  | 'demand_forecasting'\n  | 'anomaly_detection'\n  | 'supplier_scoring'\n  | 'assistant';\n\nexport type EntityType = 'product' | 'supplier' | 'category' | 'customer';\n\nexport type PredictionType =\n  | 'inventory_demand'\n  | 'supplier_performance'\n  | 'price_trends'\n  | 'stock_levels'\n  | 'custom';\n\nexport type PredictionStatus = 'pending' | 'validated' | 'expired' | 'rejected';\n\nexport interface Prediction {\n  id: string;\n  org_id: string;\n  service_type: ServiceType;\n  entity_type: EntityType;\n  entity_id: string;\n  prediction_type: string;\n  prediction_data: Record<string, any>;\n  confidence_score: number;\n  accuracy_score?: number;\n  created_at: string;\n  expires_at: string;\n  feedback_received: boolean;\n  actual_outcome?: Record<string, any>;\n  metadata?: Record<string, any>;\n  status?: PredictionStatus;\n}\n\nexport interface CreatePredictionInput {\n  serviceType: ServiceType;\n  entityType: EntityType;\n  entityId: string;\n  predictionType: string;\n  predictionData: Record<string, any>;\n  confidence?: number;\n  metadata?: Record<string, any>;\n  expiresInDays?: number;\n}\n\nexport interface UpdatePredictionAccuracyInput {\n  actualOutcome: Record<string, any>;\n  accuracy?: number;\n  notes?: string;\n}\n\nexport interface ListPredictionsFilters {\n  serviceType?: ServiceType;\n  predictionType?: string;\n  status?: string;\n  entityType?: EntityType;\n  entityId?: string;\n  startDate?: Date;\n  endDate?: Date;\n  minConfidence?: number;\n  limit?: number;\n  offset?: number;\n}\n\nexport interface ListPredictionsResult {\n  predictions: Prediction[];\n  total: number;\n}\n\n// ============================================================================\n// PREDICTION SERVICE CLASS\n// ============================================================================\n\nexport class PredictionService {\n  private aiDatabase: AIDatabaseService;\n\n  constructor() {\n    this.aiDatabase = new AIDatabaseService();\n  }\n\n  // ==========================================================================\n  // PUBLIC METHODS\n  // ==========================================================================\n\n  /**\n   * List predictions with filters and pagination\n   *\n   * @param orgId - Organization ID\n   * @param filters - Filter criteria\n   * @returns Paginated list of predictions\n   */\n  async listPredictions(\n    orgId: string,\n    filters: ListPredictionsFilters = {}\n  ): Promise<ListPredictionsResult> {\n    try {\n      const {\n        serviceType,\n        predictionType,\n        status,\n        entityType,\n        entityId,\n        startDate,\n        endDate,\n        minConfidence,\n        limit = 50,\n        offset = 0,\n      } = filters;\n\n      // Build WHERE clause dynamically\n      const conditions: string[] = ['org_id = $1'];\n      const params: any[] = [orgId];\n      let paramIndex = 2;\n\n      if (serviceType) {\n        conditions.push(`service_type = $${paramIndex}`);\n        params.push(serviceType);\n        paramIndex++;\n      }\n\n      if (entityType) {\n        conditions.push(`entity_type = $${paramIndex}`);\n        params.push(entityType);\n        paramIndex++;\n      }\n\n      if (entityId) {\n        conditions.push(`entity_id = $${paramIndex}`);\n        params.push(entityId);\n        paramIndex++;\n      }\n\n      if (startDate) {\n        conditions.push(`created_at >= $${paramIndex}`);\n        params.push(startDate);\n        paramIndex++;\n      }\n\n      if (endDate) {\n        conditions.push(`created_at <= $${paramIndex}`);\n        params.push(endDate);\n        paramIndex++;\n      }\n\n      if (minConfidence !== undefined) {\n        conditions.push(`confidence_score >= $${paramIndex}`);\n        params.push(minConfidence);\n        paramIndex++;\n      }\n\n      // Handle status filter (derived from expires_at)\n      if (status === 'active' || status === 'pending') {\n        conditions.push(`expires_at > NOW()`);\n      } else if (status === 'expired') {\n        conditions.push(`expires_at <= NOW()`);\n      } else if (status === 'validated') {\n        conditions.push(`actual_outcome IS NOT NULL`);\n      }\n\n      // Handle prediction type filter (stored in metadata or derived)\n      if (predictionType) {\n        conditions.push(`(\n          metadata->>'prediction_type' = $${paramIndex}\n          OR prediction_data->>'type' = $${paramIndex}\n        )`);\n        params.push(predictionType);\n        paramIndex++;\n      }\n\n      const whereClause = conditions.join(' AND ');\n\n      // Get total count\n      const countResult = await query<{ count: string }>(\n        `SELECT COUNT(*) as count FROM ai_prediction WHERE ${whereClause}`,\n        params\n      );\n      const total = parseInt(countResult.rows[0]?.count || '0', 10);\n\n      // Get paginated results\n      const dataQuery = `\n        SELECT\n          id,\n          org_id,\n          service_type,\n          entity_type,\n          entity_id,\n          prediction_data,\n          confidence_score,\n          accuracy_score,\n          created_at,\n          expires_at,\n          feedback_received,\n          actual_outcome,\n          metadata,\n          CASE\n            WHEN expires_at <= NOW() THEN 'expired'\n            WHEN actual_outcome IS NOT NULL THEN 'validated'\n            WHEN feedback_received = true THEN 'rejected'\n            ELSE 'pending'\n          END as status\n        FROM ai_prediction\n        WHERE ${whereClause}\n        ORDER BY created_at DESC\n        LIMIT $${paramIndex} OFFSET $${paramIndex + 1}\n      `;\n\n      params.push(limit, offset);\n\n      const result = await query<Prediction>(dataQuery, params);\n\n      return {\n        predictions: result.rows,\n        total,\n      };\n    } catch (error) {\n      console.error('Error listing predictions:', error);\n      throw new PredictionError(\n        `Failed to list predictions: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  /**\n   * Create a new prediction\n   *\n   * @param orgId - Organization ID\n   * @param input - Prediction input data\n   * @returns Created prediction\n   */\n  async createPrediction(\n    orgId: string,\n    input: CreatePredictionInput\n  ): Promise<Prediction> {\n    try {\n      return await withTransaction(async (client: PoolClient) => {\n        const {\n          serviceType,\n          entityType,\n          entityId,\n          predictionType,\n          predictionData,\n          confidence = 0.85,\n          metadata = {},\n          expiresInDays = 30,\n        } = input;\n\n        // Calculate expiration date\n        const expiresAt = new Date();\n        expiresAt.setDate(expiresAt.getDate() + expiresInDays);\n\n        // Enhance metadata with prediction type\n        const enhancedMetadata = {\n          ...metadata,\n          prediction_type: predictionType,\n          created_by_service: 'prediction-service',\n        };\n\n        // Insert into ai_prediction table\n        const insertQuery = `\n          INSERT INTO ai_prediction (\n            org_id,\n            service_type,\n            entity_type,\n            entity_id,\n            prediction_data,\n            confidence_score,\n            expires_at,\n            metadata\n          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\n          RETURNING\n            id,\n            org_id,\n            service_type,\n            entity_type,\n            entity_id,\n            prediction_data,\n            confidence_score,\n            accuracy_score,\n            created_at,\n            expires_at,\n            feedback_received,\n            actual_outcome,\n            metadata,\n            'pending' as status\n        `;\n\n        const result = await client.query<Prediction>(insertQuery, [\n          orgId,\n          serviceType,\n          entityType,\n          entityId,\n          JSON.stringify(predictionData),\n          confidence,\n          expiresAt,\n          JSON.stringify(enhancedMetadata),\n        ]);\n\n        const prediction = result.rows[0];\n\n        // Also cache in ai_predictions table for quick retrieval\n        await this.cachePrediction(client, {\n          prediction_type: predictionType,\n          target_id: entityId,\n          predictions: predictionData,\n          confidence,\n          expires_at: expiresAt,\n        });\n\n        return prediction;\n      });\n    } catch (error) {\n      console.error('Error creating prediction:', error);\n      throw new PredictionError(\n        `Failed to create prediction: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  /**\n   * Get prediction by ID\n   *\n   * @param id - Prediction ID\n   * @param orgId - Organization ID (for security)\n   * @returns Prediction or null\n   */\n  async getPredictionById(id: string, orgId: string): Promise<Prediction | null> {\n    try {\n      const result = await query<Prediction>(\n        `\n          SELECT\n            id,\n            org_id,\n            service_type,\n            entity_type,\n            entity_id,\n            prediction_data,\n            confidence_score,\n            accuracy_score,\n            created_at,\n            expires_at,\n            feedback_received,\n            actual_outcome,\n            metadata,\n            CASE\n              WHEN expires_at <= NOW() THEN 'expired'\n              WHEN actual_outcome IS NOT NULL THEN 'validated'\n              WHEN feedback_received = true THEN 'rejected'\n              ELSE 'pending'\n            END as status\n          FROM ai_prediction\n          WHERE id = $1 AND org_id = $2\n        `,\n        [id, orgId]\n      );\n\n      return result.rows[0] || null;\n    } catch (error) {\n      console.error('Error getting prediction:', error);\n      throw new PredictionError(\n        `Failed to get prediction: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  /**\n   * Update prediction accuracy with actual outcome\n   *\n   * @param id - Prediction ID\n   * @param orgId - Organization ID (for security)\n   * @param input - Accuracy update data\n   * @returns Updated prediction\n   */\n  async updatePredictionAccuracy(\n    id: string,\n    orgId: string,\n    input: UpdatePredictionAccuracyInput\n  ): Promise<Prediction> {\n    try {\n      return await withTransaction(async (client: PoolClient) => {\n        // First, get the current prediction\n        const existing = await client.query<Prediction>(\n          'SELECT * FROM ai_prediction WHERE id = $1 AND org_id = $2',\n          [id, orgId]\n        );\n\n        if (existing.rows.length === 0) {\n          throw new PredictionError('Prediction not found');\n        }\n\n        const prediction = existing.rows[0];\n\n        // Calculate accuracy if not provided\n        let accuracyScore = input.accuracy;\n        if (!accuracyScore && input.actualOutcome) {\n          accuracyScore = this.calculateAccuracy(\n            prediction.prediction_data,\n            input.actualOutcome\n          );\n        }\n\n        // Update metadata with notes if provided\n        const updatedMetadata = { ...prediction.metadata };\n        if (input.notes) {\n          updatedMetadata.validation_notes = input.notes;\n          updatedMetadata.validated_at = new Date().toISOString();\n        }\n\n        // Update the prediction\n        const updateResult = await client.query<Prediction>(\n          `\n            UPDATE ai_prediction\n            SET\n              actual_outcome = $1,\n              accuracy_score = $2,\n              feedback_received = true,\n              metadata = $3\n            WHERE id = $4 AND org_id = $5\n            RETURNING\n              id,\n              org_id,\n              service_type,\n              entity_type,\n              entity_id,\n              prediction_data,\n              confidence_score,\n              accuracy_score,\n              created_at,\n              expires_at,\n              feedback_received,\n              actual_outcome,\n              metadata,\n              CASE\n                WHEN expires_at <= NOW() THEN 'expired'\n                WHEN actual_outcome IS NOT NULL THEN 'validated'\n                WHEN feedback_received = true THEN 'rejected'\n                ELSE 'pending'\n              END as status\n          `,\n          [\n            JSON.stringify(input.actualOutcome),\n            accuracyScore || null,\n            JSON.stringify(updatedMetadata),\n            id,\n            orgId,\n          ]\n        );\n\n        return updateResult.rows[0];\n      });\n    } catch (error) {\n      console.error('Error updating prediction accuracy:', error);\n      throw new PredictionError(\n        `Failed to update prediction accuracy: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  /**\n   * Clean up expired predictions\n   *\n   * @param orgId - Organization ID (optional - cleans all if not provided)\n   * @param daysOld - Number of days after expiration to delete (default: 30)\n   * @returns Number of deleted predictions\n   */\n  async cleanupExpired(orgId?: string, daysOld: number = 30): Promise<number> {\n    try {\n      return await withTransaction(async (client: PoolClient) => {\n        const cutoffDate = new Date();\n        cutoffDate.setDate(cutoffDate.getDate() - daysOld);\n\n        let deleteQuery: string;\n        let params: any[];\n\n        if (orgId) {\n          deleteQuery = `\n            DELETE FROM ai_prediction\n            WHERE org_id = $1\n              AND expires_at < $2\n              AND feedback_received = false\n          `;\n          params = [orgId, cutoffDate];\n        } else {\n          deleteQuery = `\n            DELETE FROM ai_prediction\n            WHERE expires_at < $1\n              AND feedback_received = false\n          `;\n          params = [cutoffDate];\n        }\n\n        const result = await client.query(deleteQuery, params);\n\n        // Also cleanup ai_predictions cache\n        await client.query(\n          'DELETE FROM ai_predictions WHERE expires_at < $1',\n          [cutoffDate]\n        );\n\n        return result.rowCount || 0;\n      });\n    } catch (error) {\n      console.error('Error cleaning up expired predictions:', error);\n      throw new PredictionError(\n        `Failed to cleanup expired predictions: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  /**\n   * Generate AI prediction using AIDatabaseService\n   *\n   * @param orgId - Organization ID\n   * @param entityType - Entity type\n   * @param entityId - Entity ID\n   * @param predictionType - Type of prediction\n   * @returns Created prediction\n   */\n  async generateAIPrediction(\n    orgId: string,\n    entityType: EntityType,\n    entityId: string,\n    predictionType: PredictionType,\n    forecastDays: number = 30\n  ): Promise<Prediction> {\n    try {\n      // Generate prediction using AI Database Service\n      const aiPrediction = await this.aiDatabase.generatePredictions({\n        type: predictionType,\n        target_id: entityId ? parseInt(entityId, 10) : undefined,\n        forecast_days: forecastDays,\n      });\n\n      // Create prediction record\n      return await this.createPrediction(orgId, {\n        serviceType: 'demand_forecasting',\n        entityType,\n        entityId,\n        predictionType,\n        predictionData: {\n          predictions: aiPrediction.predictions,\n          factors: aiPrediction.factors,\n          type: aiPrediction.prediction_type,\n        },\n        confidence: aiPrediction.confidence,\n        metadata: {\n          recommendations: aiPrediction.recommendations,\n          generated_by: 'ai-database-service',\n        },\n        expiresInDays: forecastDays,\n      });\n    } catch (error) {\n      console.error('Error generating AI prediction:', error);\n      throw new PredictionError(\n        `Failed to generate AI prediction: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  /**\n   * Get prediction statistics for an organization\n   *\n   * @param orgId - Organization ID\n   * @returns Prediction statistics\n   */\n  async getPredictionStats(orgId: string): Promise<{\n    total: number;\n    pending: number;\n    validated: number;\n    expired: number;\n    averageConfidence: number;\n    averageAccuracy: number;\n  }> {\n    try {\n      const result = await query<{\n        total: string;\n        pending: string;\n        validated: string;\n        expired: string;\n        avg_confidence: string;\n        avg_accuracy: string;\n      }>(\n        `\n          SELECT\n            COUNT(*) as total,\n            COUNT(*) FILTER (WHERE expires_at > NOW() AND actual_outcome IS NULL) as pending,\n            COUNT(*) FILTER (WHERE actual_outcome IS NOT NULL) as validated,\n            COUNT(*) FILTER (WHERE expires_at <= NOW()) as expired,\n            AVG(confidence_score) as avg_confidence,\n            AVG(accuracy_score) FILTER (WHERE accuracy_score IS NOT NULL) as avg_accuracy\n          FROM ai_prediction\n          WHERE org_id = $1\n        `,\n        [orgId]\n      );\n\n      const stats = result.rows[0];\n\n      return {\n        total: parseInt(stats?.total || '0', 10),\n        pending: parseInt(stats?.pending || '0', 10),\n        validated: parseInt(stats?.validated || '0', 10),\n        expired: parseInt(stats?.expired || '0', 10),\n        averageConfidence: parseFloat(stats?.avg_confidence || '0'),\n        averageAccuracy: parseFloat(stats?.avg_accuracy || '0'),\n      };\n    } catch (error) {\n      console.error('Error getting prediction stats:', error);\n      throw new PredictionError(\n        `Failed to get prediction stats: ${error instanceof Error ? error.message : 'Unknown error'}`\n      );\n    }\n  }\n\n  // ==========================================================================\n  // PRIVATE HELPER METHODS\n  // ==========================================================================\n\n  /**\n   * Cache prediction in ai_predictions table\n   */\n  private async cachePrediction(\n    client: PoolClient,\n    data: {\n      prediction_type: string;\n      target_id?: string;\n      predictions: any;\n      confidence: number;\n      expires_at: Date;\n    }\n  ): Promise<void> {\n    try {\n      await client.query(\n        `\n          INSERT INTO ai_predictions (\n            prediction_type,\n            target_id,\n            predictions,\n            confidence,\n            expires_at\n          ) VALUES ($1, $2, $3, $4, $5)\n        `,\n        [\n          data.prediction_type,\n          data.target_id ? parseInt(data.target_id, 10) : null,\n          JSON.stringify(data.predictions),\n          data.confidence,\n          data.expires_at,\n        ]\n      );\n    } catch (error) {\n      // Cache failure shouldn't break the main operation\n      console.error('Failed to cache prediction:', error);\n    }\n  }\n\n  /**\n   * Calculate accuracy score by comparing prediction with actual outcome\n   */\n  private calculateAccuracy(\n    predictionData: Record<string, any>,\n    actualOutcome: Record<string, any>\n  ): number {\n    try {\n      // Handle different prediction data structures\n      if (predictionData.predictions && Array.isArray(predictionData.predictions)) {\n        // Time-series prediction\n        const predictions = predictionData.predictions;\n        const actuals = actualOutcome.actuals || [];\n\n        if (actuals.length === 0) {\n          return 0;\n        }\n\n        // Calculate Mean Absolute Percentage Error (MAPE)\n        let totalError = 0;\n        let count = 0;\n\n        for (let i = 0; i < Math.min(predictions.length, actuals.length); i++) {\n          const predicted = predictions[i]?.value || 0;\n          const actual = actuals[i]?.value || 0;\n\n          if (actual !== 0) {\n            totalError += Math.abs((actual - predicted) / actual);\n            count++;\n          }\n        }\n\n        if (count === 0) {\n          return 0;\n        }\n\n        const mape = totalError / count;\n        // Convert MAPE to accuracy (1 - MAPE), capped between 0 and 1\n        return Math.max(0, Math.min(1, 1 - mape));\n      } else if (predictionData.value !== undefined && actualOutcome.value !== undefined) {\n        // Single value prediction\n        const predicted = predictionData.value;\n        const actual = actualOutcome.value;\n\n        if (actual === 0) {\n          return predicted === 0 ? 1 : 0;\n        }\n\n        const percentageError = Math.abs((actual - predicted) / actual);\n        return Math.max(0, Math.min(1, 1 - percentageError));\n      } else {\n        // Unknown structure - return 0\n        return 0;\n      }\n    } catch (error) {\n      console.error('Error calculating accuracy:', error);\n      return 0;\n    }\n  }\n}\n\n// ============================================================================\n// SINGLETON EXPORT\n// ============================================================================\n\nexport const predictionService = new PredictionService();\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\prompts.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\s.","line":327,"column":37,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":327,"endColumn":38,"suggestions":[{"messageId":"removeEscape","fix":{"range":[10560,10561],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[10560,10560],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\s.","line":327,"column":65,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":327,"endColumn":66,"suggestions":[{"messageId":"removeEscape","fix":{"range":[10588,10589],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[10588,10588],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\$.","line":386,"column":50,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":386,"endColumn":51,"suggestions":[{"messageId":"removeEscape","fix":{"range":[12426,12427],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[12426,12426],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import crypto from 'crypto';\r\nimport type { AIProviderId } from '@/types/ai';\r\n\r\nexport interface PromptTemplateVariant {\r\n  id: string;\r\n  template: string;\r\n  description?: string;\r\n  weight?: number;\r\n  version?: string;\r\n}\r\n\r\nexport interface PromptTemplate {\r\n  id: string;\r\n  name: string;\r\n  description?: string;\r\n  template: string;\r\n  tags: string[];\r\n  version: string;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n  providerHints?: AIProviderId[];\r\n  variants?: Record<string, PromptTemplateVariant>;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface PromptTemplateInput {\r\n  id: string;\r\n  name: string;\r\n  template: string;\r\n  description?: string;\r\n  tags?: string[];\r\n  providerHints?: AIProviderId[];\r\n  variants?: Record<string, PromptTemplateVariant>;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface RenderPromptOptions {\r\n  variables?: Record<string, string | number | boolean>;\r\n  context?: Record<string, any>;\r\n  provider?: AIProviderId;\r\n  variantId?: string;\r\n  sanitize?: boolean;\r\n}\r\n\r\nexport interface PromptRenderResult {\r\n  templateId: string;\r\n  prompt: string;\r\n  version: string;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\ninterface PromptPerformanceMetrics {\r\n  usage: number;\r\n  success: number;\r\n  failure: number;\r\n  lastUsed?: string;\r\n  variants: Record<string, PromptPerformanceMetrics>;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nconst DEFAULT_TEMPLATES: PromptTemplateInput[] = [\r\n  {\r\n    id: 'supplier-analysis',\r\n    name: 'Supplier Performance Analysis',\r\n    description: 'Analyse supplier performance and highlight risks.',\r\n    tags: ['supplier', 'analysis', 'risk'],\r\n    template: `You are an AI operations analyst. Using the following supplier metrics, provide a concise performance assessment.\r\n\r\nSupplier: {{supplier_name}}\r\nRegion: {{region}}\r\nOn-time Delivery: {{on_time_delivery}}%\r\nQuality Score: {{quality_score}}/100\r\nSpend Change (30d): {{spend_change}}%\r\nOutstanding Issues: {{open_issues}}\r\n\r\nProvide: 1) risk summary, 2) improvement recommendations, and 3) watchlist signals.`,\r\n  },\r\n  {\r\n    id: 'inventory-optimization',\r\n    name: 'Inventory Optimization Advisor',\r\n    description: 'Suggest optimization actions for the inventory portfolio.',\r\n    tags: ['inventory', 'optimization'],\r\n    template: `You are assisting an inventory planner. Review the portfolio metrics and produce actionable insights.\r\n\r\nPortfolio KPIs:\r\n- Stockouts (14d): {{stockouts}}\r\n- Overstock Value: {{overstock_value}}\r\n- Demand Variance: {{demand_variance}}\r\n- Aging Inventory (%): {{aging_inventory_pct}}\r\n\r\nReturn: bullet list with (a) quick wins, (b) structural fixes, (c) monitoring alerts.`,\r\n  },\r\n  {\r\n    id: 'data-analysis-notebook',\r\n    name: 'Data Analysis Notebook',\r\n    description: 'Guide for multi-step data exploration with SQL and interpretation.',\r\n    tags: ['analytics', 'sql', 'insights'],\r\n    template: `You are generating a lightweight analysis notebook. Dataset summary: {{dataset_description}}.\r\n\r\nRespond with sections:\r\n1. Clarifying questions (if data insufficient).\r\n2. SQL query with annotations addressing the objective: {{objective}}.\r\n3. Result interpretation with KPIs and anomalies.\r\n4. Recommended follow-up analyses.`,\r\n  },\r\n];\r\n\r\nconst FORBIDDEN_PATTERNS = [\r\n  /ignore previous/i,\r\n  /disregard earlier/i,\r\n  /forget all/i,\r\n  /system override/i,\r\n  /you are no longer/i,\r\n];\r\n\r\nexport class PromptManager {\r\n  private readonly templates = new Map<string, PromptTemplate>();\r\n  private readonly metrics = new Map<string, PromptPerformanceMetrics>();\r\n\r\n  constructor(initialTemplates: PromptTemplateInput[] = DEFAULT_TEMPLATES) {\r\n    initialTemplates.forEach((template) => this.registerTemplate(template, { overwrite: false }));\r\n  }\r\n\r\n  registerTemplate(template: PromptTemplateInput, options: { overwrite?: boolean } = {}): PromptTemplate {\r\n    const existing = this.templates.get(template.id);\r\n    if (existing && !options.overwrite) {\r\n      throw new Error(`Prompt template '${template.id}' already exists.`);\r\n    }\r\n\r\n    const now = new Date().toISOString();\r\n    const record: PromptTemplate = {\r\n      id: template.id,\r\n      name: template.name,\r\n      description: template.description,\r\n      template: template.template,\r\n      tags: template.tags ?? [],\r\n      version: existing ? this.bumpVersion(existing.version) : '1.0.0',\r\n      createdAt: existing?.createdAt ?? now,\r\n      updatedAt: now,\r\n      providerHints: template.providerHints,\r\n      variants: template.variants,\r\n      metadata: template.metadata,\r\n    };\r\n\r\n    this.templates.set(template.id, record);\r\n    this.ensureMetrics(template.id);\r\n    return record;\r\n  }\r\n\r\n  updateTemplate(id: string, update: Partial<Omit<PromptTemplateInput, 'id'>>): PromptTemplate {\r\n    const existing = this.getTemplate(id);\r\n    const now = new Date().toISOString();\r\n    const record: PromptTemplate = {\r\n      ...existing,\r\n      name: update.name ?? existing.name,\r\n      description: update.description ?? existing.description,\r\n      template: update.template ?? existing.template,\r\n      tags: update.tags ?? existing.tags,\r\n      providerHints: update.providerHints ?? existing.providerHints,\r\n      variants: update.variants ?? existing.variants,\r\n      metadata: update.metadata ?? existing.metadata,\r\n      version: this.bumpVersion(existing.version),\r\n      updatedAt: now,\r\n    };\r\n\r\n    this.templates.set(id, record);\r\n    return record;\r\n  }\r\n\r\n  removeTemplate(id: string): void {\r\n    this.templates.delete(id);\r\n    this.metrics.delete(id);\r\n  }\r\n\r\n  listTemplates(): PromptTemplate[] {\r\n    return Array.from(this.templates.values()).map((template) => ({ ...template }));\r\n  }\r\n\r\n  getTemplate(id: string): PromptTemplate {\r\n    const template = this.templates.get(id);\r\n    if (!template) {\r\n      throw new Error(`Prompt template '${id}' not found.`);\r\n    }\r\n    return template;\r\n  }\r\n\r\n  hasTemplate(id: string): boolean {\r\n    return this.templates.has(id);\r\n  }\r\n\r\n  renderTemplate(id: string, options: RenderPromptOptions = {}): PromptRenderResult {\r\n    const template = this.getTemplate(id);\r\n    const variant = options.variantId ? template.variants?.[options.variantId] : this.selectVariantForABTest(template);\r\n    const source = variant?.template ?? template.template;\r\n    const sanitized = options.sanitize === false ? source : this.sanitizePrompt(source);\r\n    const prompt = this.applyVariables(sanitized, options.variables, options.context);\r\n\r\n    this.recordUsage(template.id, variant?.id, options.provider);\r\n\r\n    return {\r\n      templateId: template.id,\r\n      prompt,\r\n      version: variant?.version ?? template.version,\r\n      metadata: {\r\n        provider: options.provider,\r\n        variant: variant?.id,\r\n        tags: template.tags,\r\n      },\r\n    };\r\n  }\r\n\r\n  validatePrompt(prompt: string): { valid: boolean; issues: string[] } {\r\n    const issues: string[] = [];\r\n    if (!prompt || prompt.trim().length === 0) {\r\n      issues.push('Prompt is empty.');\r\n    }\r\n    if (prompt.length > 8000) {\r\n      issues.push('Prompt exceeds recommended length (8000 characters).');\r\n    }\r\n    FORBIDDEN_PATTERNS.forEach((pattern) => {\r\n      if (pattern.test(prompt)) {\r\n        issues.push(`Prompt contains discouraged pattern: ${pattern.source}`);\r\n      }\r\n    });\r\n    return { valid: issues.length === 0, issues };\r\n  }\r\n\r\n  sanitizePrompt(prompt: string): string {\r\n    let sanitized = prompt.trim();\r\n    for (const pattern of FORBIDDEN_PATTERNS) {\r\n      sanitized = sanitized.replace(pattern, '[redacted]');\r\n    }\r\n    return sanitized;\r\n  }\r\n\r\n  recordPerformance(\r\n    id: string,\r\n    outcome: { success: boolean; tokensUsed?: number; variantId?: string; provider?: AIProviderId },\r\n  ): void {\r\n    const metrics = this.ensureMetrics(id);\r\n    metrics.usage += 1;\r\n    metrics.lastUsed = new Date().toISOString();\r\n    if (outcome.success) {\r\n      metrics.success += 1;\r\n    } else {\r\n      metrics.failure += 1;\r\n    }\r\n\r\n    if (outcome.variantId) {\r\n      const variantMetrics = metrics.variants[outcome.variantId] ?? this.createEmptyMetrics();\r\n      variantMetrics.usage += 1;\r\n      if (outcome.success) {\r\n        variantMetrics.success += 1;\r\n      } else {\r\n        variantMetrics.failure += 1;\r\n      }\r\n      variantMetrics.lastUsed = metrics.lastUsed;\r\n      metrics.variants[outcome.variantId] = variantMetrics;\r\n    }\r\n  }\r\n\r\n  getTemplatePerformance(id: string): PromptPerformanceMetrics | undefined {\r\n    const metrics = this.metrics.get(id);\r\n    if (!metrics) {\r\n      return undefined;\r\n    }\r\n    return JSON.parse(JSON.stringify(metrics));\r\n  }\r\n\r\n  selectVariantForABTest(template: PromptTemplate): PromptTemplateVariant | undefined {\r\n    if (!template.variants) {\r\n      return undefined;\r\n    }\r\n    const variants = Object.values(template.variants);\r\n    if (variants.length === 0) {\r\n      return undefined;\r\n    }\r\n    const totalWeight = variants.reduce((sum, variant) => sum + (variant.weight ?? 1), 0);\r\n    let offset = Math.random() * totalWeight;\r\n    for (const variant of variants) {\r\n      offset -= variant.weight ?? 1;\r\n      if (offset <= 0) {\r\n        return variant;\r\n      }\r\n    }\r\n    return variants[variants.length - 1];\r\n  }\r\n\r\n  trackVariantOutcome(templateId: string, variantId: string, success: boolean): void {\r\n    this.recordPerformance(templateId, { success, variantId });\r\n  }\r\n\r\n  listTemplatesByTag(tag: string): PromptTemplate[] {\r\n    return this.listTemplates().filter((template) => template.tags.includes(tag));\r\n  }\r\n\r\n  generateAdaptivePrompt(\r\n    baseId: string,\r\n    signal: { context: Record<string, any>; emphasis?: string[] },\r\n  ): PromptRenderResult {\r\n    const template = this.getTemplate(baseId);\r\n    const contextBlock = Object.entries(signal.context)\r\n      .map(([key, value]) => `${key}: ${value}`)\r\n      .join('\\n');\r\n    const emphasis = signal.emphasis?.length ? `\r\nFocus priorities: ${signal.emphasis.join(', ')}` : '';\r\n    const prompt = `${template.template}\r\n\r\nContext:\r\n${contextBlock}${emphasis}`;\r\n    const sanitized = this.sanitizePrompt(prompt);\r\n    this.recordUsage(template.id, undefined, undefined);\r\n    return {\r\n      templateId: template.id,\r\n      prompt: sanitized,\r\n      version: this.bumpVersion(template.version),\r\n    };\r\n  }\r\n\r\n  private applyVariables(\r\n    template: string,\r\n    variables: Record<string, string | number | boolean> = {},\r\n    context?: Record<string, any>,\r\n  ): string {\r\n    let prompt = template;\r\n    Object.entries(variables).forEach(([key, value]) => {\r\n      const pattern = new RegExp(`{{\\s*${this.escapeRegExp(key)}\\s*}}`, 'gi');\r\n      prompt = prompt.replace(pattern, String(value));\r\n    });\r\n\r\n    if (context && Object.keys(context).length > 0) {\r\n      const contextLines = Object.entries(context)\r\n        .map(([key, value]) => `${key}: ${typeof value === 'object' ? JSON.stringify(value) : value}`)\r\n        .join('\\n');\r\n      prompt = `${prompt.trim()}\r\n\r\nContextual Signals:\r\n${contextLines}`;\r\n    }\r\n\r\n    return prompt;\r\n  }\r\n\r\n  private recordUsage(id: string, variantId?: string, provider?: AIProviderId): void {\r\n    const metrics = this.ensureMetrics(id);\r\n    metrics.usage += 1;\r\n    metrics.lastUsed = new Date().toISOString();\r\n    if (variantId) {\r\n      const variantMetrics = metrics.variants[variantId] ?? this.createEmptyMetrics();\r\n      variantMetrics.usage += 1;\r\n      variantMetrics.lastUsed = metrics.lastUsed;\r\n      metrics.variants[variantId] = variantMetrics;\r\n    }\r\n    if (provider) {\r\n      metrics.metadata = metrics.metadata ?? {};\r\n      metrics.metadata.lastProvider = provider;\r\n    }\r\n  }\r\n\r\n  private ensureMetrics(id: string): PromptPerformanceMetrics {\r\n    let metrics = this.metrics.get(id);\r\n    if (!metrics) {\r\n      metrics = { ...this.createEmptyMetrics(), variants: {} };\r\n      this.metrics.set(id, metrics);\r\n    }\r\n    return metrics;\r\n  }\r\n\r\n  private createEmptyMetrics(): PromptPerformanceMetrics {\r\n    return {\r\n      usage: 0,\r\n      success: 0,\r\n      failure: 0,\r\n      variants: {},\r\n      metadata: {},\r\n    };\r\n  }\r\n\r\n  private bumpVersion(current: string): string {\r\n    const [major, minor, patch] = current.split('.').map((value) => parseInt(value || '0', 10));\r\n    const nextPatch = Number.isFinite(patch) ? patch + 1 : 0;\r\n    return `${major}.${minor}.${nextPatch}`;\r\n  }\r\n\r\n  private escapeRegExp(value: string): string {\r\n    return value.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&');\r\n  }\r\n\r\n  generateTemplateId(name: string): string {\r\n    const normalized = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');\r\n    return `${normalized}-${crypto.randomBytes(2).toString('hex')}`;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\response.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":146,"column":12,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":146,"endColumn":13,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4309,4310],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4309,4309],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z, type ZodSchema, type ZodError } from 'zod';\r\nimport type { ApiResponse } from '@/lib/api/base';\r\nimport type {\r\n  AITextResult,\r\n  AIChatResult,\r\n  AIEmbeddingResult,\r\n  AIStreamChunk,\r\n} from '@/types/ai';\r\n\r\nexport interface StructuredParseOptions<TSchema extends ZodSchema | undefined = undefined> {\r\n  schema?: TSchema;\r\n  mode?: 'json' | 'auto';\r\n  fallback?: any;\r\n}\r\n\r\nexport interface StructuredParseResult<TData = any> {\r\n  data?: TData;\r\n  issues: string[];\r\n  raw: string;\r\n}\r\n\r\nexport interface ResponseValidationResult<TData = any> {\r\n  valid: boolean;\r\n  data?: TData;\r\n  issues?: string[];\r\n}\r\n\r\nexport interface ResponseFormatOptions {\r\n  requestId: string;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface ResponseQualityScore {\r\n  completeness: number;\r\n  structure: number;\r\n  overall: number;\r\n  notes?: string[];\r\n}\r\n\r\nexport class ResponseProcessor {\r\n  parseStructuredResponse<TData = any, TSchema extends ZodSchema | undefined = undefined>(\r\n    response: string | AITextResult | AIChatResult,\r\n    options: StructuredParseOptions<TSchema> = {},\r\n  ): StructuredParseResult<TData> {\r\n    const raw = this.extractPrimaryText(response);\r\n    const issues: string[] = [];\r\n\r\n    if (!raw) {\r\n      return { data: options.fallback, issues: ['Empty response payload.'], raw: '' };\r\n    }\r\n\r\n    if (options.mode === 'json' || options.mode === undefined) {\r\n      const parsed = this.tryParseJson(raw);\r\n      if (parsed.success) {\r\n        if (options.schema) {\r\n          const validation = options.schema.safeParse(parsed.data);\r\n          if (validation.success) {\r\n            return { data: validation.data as TData, issues, raw };\r\n          }\r\n          issues.push(...this.formatZodErrors(validation.error));\r\n          return { data: options.fallback, issues, raw };\r\n        }\r\n        return { data: parsed.data as TData, issues, raw };\r\n      }\r\n      issues.push(parsed.error ?? 'Unable to parse JSON payload.');\r\n    }\r\n\r\n    if (options.mode === 'auto') {\r\n      const recovered = this.recoverJsonBlock(raw);\r\n      if (recovered) {\r\n        return this.parseStructuredResponse(recovered, { ...options, mode: 'json' });\r\n      }\r\n    }\r\n\r\n    return { data: options.fallback, issues, raw };\r\n  }\r\n\r\n  extractData(\r\n    result: string | AITextResult | AIChatResult | AIEmbeddingResult,\r\n  ): Record<string, any> {\r\n    if (typeof result === 'string') {\r\n      return { text: result };\r\n    }\r\n\r\n    if ('vector' in result) {\r\n      return {\r\n        vector: Array.from(result.vector),\r\n        usage: result.usage,\r\n        provider: result.provider,\r\n        model: result.model,\r\n      };\r\n    }\r\n\r\n    if ('messages' in result) {\r\n      return {\r\n        text: result.text,\r\n        messages: result.messages,\r\n        raw: result.rawResponse,\r\n        usage: result.usage,\r\n        provider: result.provider,\r\n        model: result.model,\r\n      };\r\n    }\r\n\r\n    return {\r\n      text: (result as AITextResult).text,\r\n      usage: (result as AITextResult).usage,\r\n      provider: (result as AITextResult).provider,\r\n      model: (result as AITextResult).model,\r\n    };\r\n  }\r\n\r\n  validateResponse<TData>(schema: ZodSchema<TData>, data: unknown): ResponseValidationResult<TData> {\r\n    const parsed = schema.safeParse(data);\r\n    if (parsed.success) {\r\n      return { valid: true, data: parsed.data };\r\n    }\r\n    return {\r\n      valid: false,\r\n      issues: this.formatZodErrors(parsed.error),\r\n    };\r\n  }\r\n\r\n  formatForAPI<TData = any>(data: TData, options: ResponseFormatOptions): ApiResponse<TData> {\r\n    const response: ApiResponse<TData> = {\r\n      success: true,\r\n      data,\r\n      timestamp: new Date().toISOString(),\r\n      requestId: options.requestId,\r\n    };\r\n    if (options.metadata) {\r\n      (response as Record<string, any>).metadata = options.metadata;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  scoreResponse(payload: string | AITextResult | AIChatResult): ResponseQualityScore {\r\n    const text = this.extractPrimaryText(payload) ?? '';\r\n    const notes: string[] = [];\r\n\r\n    const completeness = Math.min(1, Math.max(0, text.length / 500));\r\n    const structure = /(?:^|\\n)- /.test(text) || /\\d+\\./.test(text) ? 0.9 : 0.6;\r\n    if (text.length < 50) {\r\n      notes.push('Response is very short; may lack detail.');\r\n    }\r\n    if (!/[\\.!?]/.test(text)) {\r\n      notes.push('Response lacks sentence punctuation; may be malformed.');\r\n    }\r\n\r\n    const overall = Number(((completeness * 0.5) + (structure * 0.5)).toFixed(2));\r\n\r\n    return {\r\n      completeness: Number(completeness.toFixed(2)),\r\n      structure: Number(structure.toFixed(2)),\r\n      overall,\r\n      notes: notes.length ? notes : undefined,\r\n    };\r\n  }\r\n\r\n  formatStreamingChunk(chunk: AIStreamChunk): Record<string, any> {\r\n    return {\r\n      token: chunk.token,\r\n      index: chunk.index,\r\n      provider: chunk.provider,\r\n      model: chunk.model,\r\n      done: chunk.done ?? false,\r\n      timestamp: chunk.timestamp,\r\n    };\r\n  }\r\n\r\n  recoverFromMalformed(text: string): string {\r\n    const recovered = this.recoverJsonBlock(text);\r\n    return recovered ?? text;\r\n  }\r\n\r\n  private extractPrimaryText(payload: string | AITextResult | AIChatResult): string | undefined {\r\n    if (typeof payload === 'string') {\r\n      return payload;\r\n    }\r\n    if ('text' in payload) {\r\n      return payload.text;\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  private tryParseJson(value: string): { success: boolean; data?: any; error?: string } {\r\n    try {\r\n      return { success: true, data: JSON.parse(value) };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Malformed JSON payload.',\r\n      };\r\n    }\r\n  }\r\n\r\n  private recoverJsonBlock(text: string): string | undefined {\r\n    const first = text.indexOf('{');\r\n    const last = text.lastIndexOf('}');\r\n    if (first >= 0 && last > first) {\r\n      const candidate = text.slice(first, last + 1);\r\n      const parsed = this.tryParseJson(candidate);\r\n      if (parsed.success) {\r\n        return candidate;\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  private formatZodErrors(error: ZodError): string[] {\r\n    return error.issues.map((issue) => `${issue.path.join('.') || 'root'}: ${issue.message}`);\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\services\\text.ts","messages":[{"ruleId":"require-yield","severity":2,"message":"This generator function does not have 'yield'.","line":217,"column":38,"nodeType":"FunctionExpression","messageId":"missingYield","endLine":219,"endColumn":10}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createHash } from 'crypto';\r\nimport type {\r\n  AITextResult,\r\n  AIStreamChunk,\r\n  AIUsageMetrics,\r\n} from '@/types/ai';\r\nimport {\r\n  AIServiceBase,\r\n  type AIServiceBaseOptions,\r\n  type AIServiceRequestOptions,\r\n  type AIServiceResponse,\r\n  type StreamingResult,\r\n} from './base';\r\nimport { PromptManager, type RenderPromptOptions } from './prompts';\r\nimport { ResponseProcessor } from './response';\r\n\r\nexport interface TextGenerationOptions extends AIServiceRequestOptions {\r\n  cache?: boolean;\r\n  cacheKey?: string;\r\n  cacheTtlMs?: number;\r\n}\r\n\r\nexport interface TemplateGenerationOptions extends TextGenerationOptions, RenderPromptOptions {}\r\n\r\nexport interface TextGenerationBatchItem {\r\n  prompt: string;\r\n  result: AITextResult;\r\n}\r\n\r\nexport interface TextGenerationBatchResult {\r\n  results: TextGenerationBatchItem[];\r\n  aggregatedUsage?: AIUsageMetrics;\r\n  usage?: AIUsageMetrics;\r\n}\r\n\r\ninterface CachedTextResponse {\r\n  expiresAt: number;\r\n  response: AIServiceResponse<AITextResult>;\r\n}\r\n\r\nexport interface AITextServiceOptions extends AIServiceBaseOptions {\r\n  promptManager?: PromptManager;\r\n  responseProcessor?: ResponseProcessor;\r\n  defaultCacheTtlMs?: number;\r\n}\r\n\r\nexport class AITextService extends AIServiceBase<TextGenerationOptions> {\r\n  private readonly promptManager: PromptManager;\r\n  private readonly responseProcessor: ResponseProcessor;\r\n  private readonly cache = new Map<string, CachedTextResponse>();\r\n  private readonly defaultCacheTtlMs: number;\r\n\r\n  constructor(options?: AITextServiceOptions) {\r\n    super('AITextService', options);\r\n    this.promptManager = options?.promptManager ?? new PromptManager();\r\n    this.responseProcessor = options?.responseProcessor ?? new ResponseProcessor();\r\n    this.defaultCacheTtlMs = options?.defaultCacheTtlMs ?? 5 * 60 * 1000;\r\n  }\r\n\r\n  async generateText(prompt: string, options: TextGenerationOptions = {}): Promise<AIServiceResponse<AITextResult>> {\r\n    const cacheKey = options.cache === false ? undefined : options.cacheKey ?? this.buildCacheKey(prompt, options);\r\n    if (cacheKey) {\r\n      const cached = this.getCachedResponse(cacheKey, options);\r\n      if (cached) {\r\n        this.emit('cache-hit', cached);\r\n        return cached;\r\n      }\r\n    }\r\n\r\n    const response = await this.executeOperation<AITextResult>(\r\n      'text.generate',\r\n      async ({ service, runtimeOptions }) => service.generateText(prompt, runtimeOptions),\r\n      options,\r\n      { promptHash: this.hashPrompt(prompt) },\r\n    );\r\n\r\n    if (response.success && cacheKey) {\r\n      this.setCachedResponse(cacheKey, response, options.cacheTtlMs);\r\n    }\r\n\r\n    return response;\r\n  }\r\n\r\n  async generateWithTemplate(\r\n    templateId: string,\r\n    variables: Record<string, string | number | boolean>,\r\n    options: TemplateGenerationOptions = {},\r\n  ): Promise<AIServiceResponse<AITextResult>> {\r\n    const rendered = this.promptManager.renderTemplate(templateId, {\r\n      variables,\r\n      context: options.context,\r\n      provider: options.provider,\r\n      variantId: options.variantId,\r\n      sanitize: options.sanitize,\r\n    });\r\n\r\n    const metadata = this.mergeMetadata(options.metadata, {\r\n      templateId,\r\n      templateVersion: rendered.version,\r\n      templateVariant: rendered.metadata?.variant,\r\n    });\r\n\r\n    const response = await this.generateText(rendered.prompt, {\r\n      ...options,\r\n      metadata,\r\n    });\r\n\r\n    this.promptManager.recordPerformance(templateId, {\r\n      success: response.success,\r\n      variantId: rendered.metadata?.variant,\r\n      provider: options.provider,\r\n    });\r\n\r\n    return response;\r\n  }\r\n\r\n  async generateBatch(\r\n    prompts: string[],\r\n    options: TextGenerationOptions = {},\r\n  ): Promise<AIServiceResponse<TextGenerationBatchResult>> {\r\n    const response = await this.executeOperation<TextGenerationBatchResult>(\r\n      'text.batch',\r\n      async ({ service, runtimeOptions }) => {\r\n        const results: TextGenerationBatchItem[] = [];\r\n        for (const prompt of prompts) {\r\n          const result = await service.generateText(prompt, runtimeOptions);\r\n          results.push({ prompt, result });\r\n        }\r\n        const aggregatedUsage = this.combineUsage(results.map((item) => item.result.usage));\r\n        return { results, aggregatedUsage, usage: aggregatedUsage };\r\n      },\r\n      options,\r\n      { batchSize: prompts.length },\r\n    );\r\n\r\n    return response;\r\n  }\r\n\r\n  async streamText(\r\n    prompt: string,\r\n    options: TextGenerationOptions = {},\r\n  ): Promise<StreamingResult<AIStreamChunk, { text: string; chunks: number }>> {\r\n    const requestId = options.requestId ?? this.generateRequestId();\r\n    const notifyChannel = options.notifyChannel ?? this.notifyChannel;\r\n    const metadata = this.mergeMetadata(this.defaultMetadata, options.metadata, {\r\n      promptHash: this.hashPrompt(prompt),\r\n      stream: true,\r\n    });\r\n    const startedAt = Date.now();\r\n\r\n    this.emit('request', {\r\n      requestId,\r\n      service: this.serviceName,\r\n      operation: 'text.stream',\r\n      metadata,\r\n    });\r\n    await this.notifyEvent('request', {\r\n      requestId,\r\n      service: this.serviceName,\r\n      operation: 'text.stream',\r\n      metadata,\r\n      timestamp: this.getTimestamp(),\r\n    }, notifyChannel);\r\n\r\n    const { service, cleanup } = this.createServiceInstance(options, requestId, 'text.stream', notifyChannel, metadata);\r\n    const runtimeOptions = this.buildRuntimeOptions(options);\r\n\r\n    try {\r\n      const iterator = await service.streamText(prompt, runtimeOptions);\r\n      const aggregate = { text: '', chunks: 0 };\r\n\r\n      return this.createStreamingResult(iterator, {\r\n        requestId,\r\n        operation: 'text.stream',\r\n        service,\r\n        notifyChannel,\r\n        metadata,\r\n        startedAt,\r\n        cleanup,\r\n        aggregate: {\r\n          onChunk: (chunk) => {\r\n            aggregate.chunks += 1;\r\n            if (chunk.token) {\r\n              aggregate.text += chunk.token;\r\n            }\r\n          },\r\n          onComplete: () => aggregate,\r\n        },\r\n        customResponse: ({ data, provider, durationMs }) =>\r\n          this.buildSuccessResponse({\r\n            data: data ?? aggregate,\r\n            provider,\r\n            model: runtimeOptions?.model,\r\n            usage: undefined,\r\n            requestId,\r\n            operation: 'text.stream',\r\n            durationMs,\r\n            metadata,\r\n          }),\r\n      });\r\n    } catch (error) {\r\n      cleanup();\r\n      const durationMs = Date.now() - startedAt;\r\n      const response = this.buildErrorResponse<{ text: string; chunks: number }>({\r\n        error,\r\n        provider: service.currentProvider,\r\n        requestId,\r\n        operation: 'text.stream',\r\n        durationMs,\r\n        metadata,\r\n      });\r\n      this.emit('error', { ...response, error: response.error });\r\n      await this.notifyEvent('error', response, notifyChannel);\r\n\r\n      const failed: StreamingResult<AIStreamChunk, { text: string; chunks: number }> = {\r\n        summary: Promise.resolve(response),\r\n        async *[Symbol.asyncIterator]() {\r\n          throw error;\r\n        },\r\n      };\r\n      return failed;\r\n    }\r\n  }\r\n\r\n  clearCache(): void {\r\n    this.cache.clear();\r\n  }\r\n\r\n  pruneCache(): void {\r\n    const now = Date.now();\r\n    for (const [key, entry] of this.cache.entries()) {\r\n      if (entry.expiresAt <= now) {\r\n        this.cache.delete(key);\r\n      }\r\n    }\r\n  }\r\n\r\n  getPromptManager(): PromptManager {\r\n    return this.promptManager;\r\n  }\r\n\r\n  getResponseProcessor(): ResponseProcessor {\r\n    return this.responseProcessor;\r\n  }\r\n\r\n  private buildCacheKey(prompt: string, options: TextGenerationOptions): string {\r\n    const hash = this.hashPrompt(prompt);\r\n    const model = options.model ?? 'default';\r\n    const provider = options.provider ?? this.defaultProvider ?? 'auto';\r\n    return `${provider}:${model}:${hash}`;\r\n  }\r\n\r\n  private hashPrompt(prompt: string): string {\r\n    return createHash('sha256').update(prompt).digest('hex');\r\n  }\r\n\r\n  private getCachedResponse(\r\n    cacheKey: string | undefined,\r\n    options: TextGenerationOptions,\r\n  ): AIServiceResponse<AITextResult> | undefined {\r\n    if (!cacheKey) {\r\n      return undefined;\r\n    }\r\n    const cached = this.cache.get(cacheKey);\r\n    if (!cached) {\r\n      return undefined;\r\n    }\r\n    if (cached.expiresAt <= Date.now()) {\r\n      this.cache.delete(cacheKey);\r\n      return undefined;\r\n    }\r\n\r\n    const requestId = options.requestId ?? this.generateRequestId();\r\n    return {\r\n      ...cached.response,\r\n      requestId,\r\n      timestamp: this.getTimestamp(),\r\n      metadata: this.mergeMetadata(cached.response.metadata, options.metadata),\r\n      context: this.buildContext(options) ?? cached.response.context,\r\n    };\r\n  }\r\n\r\n  private setCachedResponse(\r\n    cacheKey: string,\r\n    response: AIServiceResponse<AITextResult>,\r\n    ttlMs?: number,\r\n  ): void {\r\n    const expiresAt = Date.now() + (ttlMs ?? this.defaultCacheTtlMs);\r\n    this.cache.set(cacheKey, {\r\n      expiresAt,\r\n      response: { ...response },\r\n    });\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\supplier-discovery-config.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * Supplier Discovery Config Helper\r\n * Reads API keys from AI service configuration instead of just environment variables\r\n */\r\n\r\nimport { getConfig } from '@/app/api/v1/ai/config/_store';\r\n\r\nexport interface SupplierDiscoveryConfig {\r\n  // Web Search APIs\r\n  serperApiKey?: string;\r\n  tavilyApiKey?: string;\r\n  googleSearchApiKey?: string;\r\n  googleSearchEngineId?: string;\r\n\r\n  // Custom providers - dynamic key-value pairs\r\n  customProviders?: Record<\r\n    string,\r\n    {\r\n      apiKey: string;\r\n      apiUrl?: string;\r\n      model?: string;\r\n      description?: string;\r\n      enabled?: boolean;\r\n    }\r\n  >;\r\n\r\n  // AI Extraction APIs - support multiple providers\r\n  anthropicApiKey?: string;\r\n  anthropicBaseUrl?: string;\r\n  openaiApiKey?: string;\r\n  openaiBaseUrl?: string;\r\n  openaiModel?: string;\r\n\r\n  // Multiple AI providers support\r\n  aiProviders?: Array<{\r\n    provider: 'anthropic' | 'openai' | 'openai_compatible';\r\n    apiKey: string;\r\n    baseUrl?: string;\r\n    model?: string;\r\n    enabled: boolean;\r\n  }>;\r\n}\r\n\r\n/**\r\n * Get supplier discovery configuration from database or environment variables\r\n */\r\nexport async function getSupplierDiscoveryConfig(orgId?: string): Promise<SupplierDiscoveryConfig> {\r\n  const config: SupplierDiscoveryConfig = {\r\n    // Default to environment variables\r\n    serperApiKey: process.env.SERPER_API_KEY,\r\n    tavilyApiKey: process.env.TAVILY_API_KEY,\r\n    googleSearchApiKey: process.env.GOOGLE_SEARCH_API_KEY,\r\n    googleSearchEngineId: process.env.GOOGLE_SEARCH_ENGINE_ID,\r\n    anthropicApiKey: process.env.ANTHROPIC_API_KEY,\r\n    openaiApiKey: process.env.OPENAI_API_KEY,\r\n  };\r\n\r\n  // Try to get from database config if orgId is provided\r\n  if (orgId) {\r\n    try {\r\n      // First, let's see ALL configs for this org\r\n      const { listConfigs } = await import('@/app/api/v1/ai/config/_store');\r\n      const allConfigs = await listConfigs(orgId);\r\n      console.log(\r\n        '🔍 All configs for org:',\r\n        allConfigs.map(c => ({\r\n          service_type: c.service_type,\r\n          id: c.id,\r\n          hasProviderInstances: !!c.config?.providerInstances,\r\n          instancesCount: c.config?.providerInstances?.length || 0,\r\n        }))\r\n      );\r\n\r\n      const dbConfig = await getConfig(orgId, 'supplier_discovery');\r\n      console.log('🔍 Supplier Discovery Config Debug:', {\r\n        hasConfig: !!dbConfig,\r\n        configId: dbConfig?.id,\r\n        serviceType: dbConfig?.service_type,\r\n        hasProviderInstances: !!dbConfig?.config?.providerInstances,\r\n        instancesCount: dbConfig?.config?.providerInstances?.length || 0,\r\n        instances: dbConfig?.config?.providerInstances || [],\r\n        activeProviderInstanceId: dbConfig?.config?.activeProviderInstanceId,\r\n      });\r\n\r\n      if (dbConfig?.config) {\r\n        // NEW: Read from providerInstances array\r\n        const providerInstances = dbConfig.config.providerInstances || [];\r\n        const activeProviderInstanceId = dbConfig.config.activeProviderInstanceId;\r\n\r\n        // Separate logic for web search providers vs AI extraction providers\r\n        // Web search providers: serper, tavily, google_search\r\n        // AI extraction providers: anthropic, openai, openai_compatible\r\n\r\n        // Find active web search provider (or first enabled web search provider)\r\n        const webSearchProviders = providerInstances.filter(\r\n          (i: any) => i?.enabled && ['serper', 'tavily', 'google_search'].includes(i.provider)\r\n        );\r\n        const activeWebSearch = activeProviderInstanceId\r\n          ? webSearchProviders.find((i: any) => i?.id === activeProviderInstanceId)\r\n          : webSearchProviders[0];\r\n\r\n        // Find active AI extraction provider (or first enabled AI extraction provider)\r\n        const aiProviders = providerInstances.filter(\r\n          (i: any) =>\r\n            i?.enabled && ['anthropic', 'openai', 'openai_compatible'].includes(i.provider)\r\n        );\r\n        console.log('🔍 AI Providers found:', {\r\n          count: aiProviders.length,\r\n          providers: aiProviders.map((p: any) => ({\r\n            id: p.id,\r\n            provider: p.provider,\r\n            hasApiKey: !!p.apiKey,\r\n            apiKeyLength: p.apiKey?.length || 0,\r\n            baseUrl: p.baseUrl,\r\n            model: p.model,\r\n          })),\r\n          activeProviderInstanceId,\r\n        });\r\n        // Only use activeProviderInstanceId if it actually matches an AI provider\r\n        // If it points to a web search provider, ignore it and use first enabled AI provider\r\n        const activeAIById = activeProviderInstanceId\r\n          ? aiProviders.find((i: any) => i?.id === activeProviderInstanceId)\r\n          : null;\r\n        const activeAI = activeAIById || aiProviders[0];\r\n        console.log('🔍 Selected AI Provider:', {\r\n          selected: activeAI\r\n            ? {\r\n                provider: activeAI.provider,\r\n                hasApiKey: !!activeAI.apiKey,\r\n                apiKeyLength: activeAI.apiKey?.length || 0,\r\n                baseUrl: activeAI.baseUrl,\r\n                model: activeAI.model,\r\n              }\r\n            : null,\r\n          matchedActiveId: !!activeAIById,\r\n        });\r\n\r\n        // Use active web search provider\r\n        if (activeWebSearch) {\r\n          switch (activeWebSearch.provider) {\r\n            case 'serper':\r\n              if (activeWebSearch.apiKey) config.serperApiKey = activeWebSearch.apiKey;\r\n              break;\r\n            case 'tavily':\r\n              if (activeWebSearch.apiKey) config.tavilyApiKey = activeWebSearch.apiKey;\r\n              break;\r\n            case 'google_search':\r\n              if (activeWebSearch.apiKey) config.googleSearchApiKey = activeWebSearch.apiKey;\r\n              if (activeWebSearch.googleSearchEngineId)\r\n                config.googleSearchEngineId = activeWebSearch.googleSearchEngineId;\r\n              break;\r\n          }\r\n        }\r\n\r\n        // Use active AI extraction provider\r\n        if (activeAI) {\r\n          switch (activeAI.provider) {\r\n            case 'anthropic':\r\n              if (activeAI.apiKey) config.anthropicApiKey = activeAI.apiKey;\r\n              if (activeAI.baseUrl) config.anthropicBaseUrl = activeAI.baseUrl;\r\n              break;\r\n            case 'openai':\r\n            case 'openai_compatible':\r\n              if (activeAI.apiKey) {\r\n                config.openaiApiKey = activeAI.apiKey;\r\n                console.log('✅ Setting OpenAI API key:', {\r\n                  hasKey: !!config.openaiApiKey,\r\n                  keyLength: config.openaiApiKey?.length || 0,\r\n                  keyPrefix: config.openaiApiKey?.substring(0, 10) || 'none',\r\n                });\r\n              }\r\n              if (activeAI.baseUrl) config.openaiBaseUrl = activeAI.baseUrl;\r\n              if (activeAI.model) config.openaiModel = activeAI.model;\r\n              break;\r\n          }\r\n        }\r\n        // Note: activeAI is only for legacy single-provider config\r\n        // The actual extraction uses config.aiProviders array (all enabled providers) for aggregation\r\n\r\n        // Fallback: Also check for any enabled providers if active ones weren't found\r\n        for (const instance of providerInstances) {\r\n          if (!instance.enabled) continue;\r\n\r\n          // Only fill in missing values\r\n          switch (instance.provider) {\r\n            case 'serper':\r\n              if (instance.apiKey && !config.serperApiKey) config.serperApiKey = instance.apiKey;\r\n              break;\r\n            case 'tavily':\r\n              if (instance.apiKey && !config.tavilyApiKey) config.tavilyApiKey = instance.apiKey;\r\n              break;\r\n            case 'google_search':\r\n              if (instance.apiKey && !config.googleSearchApiKey)\r\n                config.googleSearchApiKey = instance.apiKey;\r\n              if (instance.googleSearchEngineId && !config.googleSearchEngineId)\r\n                config.googleSearchEngineId = instance.googleSearchEngineId;\r\n              break;\r\n            case 'anthropic':\r\n              if (instance.apiKey && !config.anthropicApiKey)\r\n                config.anthropicApiKey = instance.apiKey;\r\n              if (instance.baseUrl && !config.anthropicBaseUrl)\r\n                config.anthropicBaseUrl = instance.baseUrl;\r\n              break;\r\n            case 'openai':\r\n            case 'openai_compatible':\r\n              if (instance.apiKey && !config.openaiApiKey) config.openaiApiKey = instance.apiKey;\r\n              if (instance.baseUrl && !config.openaiBaseUrl)\r\n                config.openaiBaseUrl = instance.baseUrl;\r\n              if (instance.model && !config.openaiModel) config.openaiModel = instance.model;\r\n              break;\r\n          }\r\n        }\r\n\r\n        // Collect ALL enabled AI providers for aggregation\r\n        config.aiProviders = aiProviders\r\n          .map((instance: any) => ({\r\n            provider:\r\n              instance.provider === 'openai_compatible'\r\n                ? 'openai_compatible'\r\n                : instance.provider === 'anthropic'\r\n                  ? 'anthropic'\r\n                  : 'openai',\r\n            apiKey: instance.apiKey || '',\r\n            baseUrl: instance.baseUrl,\r\n            model: instance.model,\r\n            enabled: instance.enabled !== false,\r\n          }))\r\n          .filter((p: any) => p.enabled && p.apiKey);\r\n\r\n        console.log(`✅ Found ${config.aiProviders.length} enabled AI provider(s) for aggregation`);\r\n\r\n        // LEGACY: Fallback to old structure for backward compatibility\r\n        const webSearch = dbConfig.config.webSearch || {};\r\n        const providers = dbConfig.config.providers || {};\r\n\r\n        // Override with legacy config if not found in providerInstances\r\n        if (!config.serperApiKey && webSearch.serperApiKey)\r\n          config.serperApiKey = webSearch.serperApiKey;\r\n        if (!config.tavilyApiKey && webSearch.tavilyApiKey)\r\n          config.tavilyApiKey = webSearch.tavilyApiKey;\r\n        if (!config.googleSearchApiKey && webSearch.googleSearchApiKey)\r\n          config.googleSearchApiKey = webSearch.googleSearchApiKey;\r\n        if (!config.googleSearchEngineId && webSearch.googleSearchEngineId)\r\n          config.googleSearchEngineId = webSearch.googleSearchEngineId;\r\n\r\n        // Get custom providers (legacy)\r\n        if (webSearch.customProviders) {\r\n          config.customProviders = webSearch.customProviders;\r\n        }\r\n\r\n        // Get AI provider keys from legacy config\r\n        if (!config.anthropicApiKey && providers.anthropic?.apiKey)\r\n          config.anthropicApiKey = providers.anthropic.apiKey;\r\n        if (!config.openaiApiKey && providers.openai?.apiKey)\r\n          config.openaiApiKey = providers.openai.apiKey;\r\n\r\n        // Fallback to root config if provider-specific not available\r\n        if (\r\n          !config.anthropicApiKey &&\r\n          dbConfig.config.apiKey &&\r\n          dbConfig.config.provider === 'anthropic'\r\n        ) {\r\n          config.anthropicApiKey = dbConfig.config.apiKey;\r\n        }\r\n        if (\r\n          !config.openaiApiKey &&\r\n          dbConfig.config.apiKey &&\r\n          dbConfig.config.provider === 'openai'\r\n        ) {\r\n          config.openaiApiKey = dbConfig.config.apiKey;\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.warn(\r\n        '⚠️ Failed to load supplier discovery config from database, using environment variables:',\r\n        error\r\n      );\r\n    }\r\n  }\r\n\r\n  console.log('✅ Supplier Discovery Config Loaded:', {\r\n    hasSerper: !!config.serperApiKey,\r\n    hasTavily: !!config.tavilyApiKey,\r\n    hasGoogleSearch: !!config.googleSearchApiKey,\r\n    hasAnthropic: !!config.anthropicApiKey,\r\n    hasOpenAI: !!config.openaiApiKey,\r\n    openaiBaseUrl: config.openaiBaseUrl,\r\n    openaiModel: config.openaiModel,\r\n  });\r\n\r\n  return config;\r\n}\r\n\r\n/**\r\n * Get supplier discovery config synchronously (for client-side usage)\r\n * This reads from a server-side API endpoint\r\n */\r\nexport async function getSupplierDiscoveryConfigFromAPI(): Promise<SupplierDiscoveryConfig> {\r\n  try {\r\n    const response = await fetch('/api/v1/ai/config/supplier_discovery');\r\n    if (!response.ok) {\r\n      throw new Error('Failed to fetch config');\r\n    }\r\n\r\n    const data = await response.json();\r\n    const dbConfig = data.data;\r\n\r\n    const config: SupplierDiscoveryConfig = {\r\n      // Default to environment variables (these won't be available client-side)\r\n      serperApiKey: undefined,\r\n      tavilyApiKey: undefined,\r\n      googleSearchApiKey: undefined,\r\n      googleSearchEngineId: undefined,\r\n      anthropicApiKey: undefined,\r\n      openaiApiKey: undefined,\r\n    };\r\n\r\n    if (dbConfig?.config) {\r\n      // NEW: Read from providerInstances array\r\n      const providerInstances = dbConfig.config.providerInstances || [];\r\n      const activeProviderInstanceId = dbConfig.config.activeProviderInstanceId;\r\n\r\n      // Separate logic for web search providers vs AI extraction providers\r\n      // Web search providers: serper, tavily, google_search\r\n      // AI extraction providers: anthropic, openai, openai_compatible\r\n\r\n      // Find active web search provider (or first enabled web search provider)\r\n      const webSearchProviders = providerInstances.filter(\r\n        (i: any) => i?.enabled && ['serper', 'tavily', 'google_search'].includes(i.provider)\r\n      );\r\n      const activeWebSearch = activeProviderInstanceId\r\n        ? webSearchProviders.find((i: any) => i?.id === activeProviderInstanceId)\r\n        : webSearchProviders[0];\r\n\r\n      // Find active AI extraction provider (or first enabled AI extraction provider)\r\n      const aiProviders = providerInstances.filter(\r\n        (i: any) => i?.enabled && ['anthropic', 'openai', 'openai_compatible'].includes(i.provider)\r\n      );\r\n      const activeAI = activeProviderInstanceId\r\n        ? aiProviders.find((i: any) => i?.id === activeProviderInstanceId)\r\n        : aiProviders[0];\r\n\r\n      // Use active web search provider\r\n      if (activeWebSearch) {\r\n        switch (activeWebSearch.provider) {\r\n          case 'serper':\r\n            if (activeWebSearch.apiKey) config.serperApiKey = activeWebSearch.apiKey;\r\n            break;\r\n          case 'tavily':\r\n            if (activeWebSearch.apiKey) config.tavilyApiKey = activeWebSearch.apiKey;\r\n            break;\r\n          case 'google_search':\r\n            if (activeWebSearch.apiKey) config.googleSearchApiKey = activeWebSearch.apiKey;\r\n            if (activeWebSearch.googleSearchEngineId)\r\n              config.googleSearchEngineId = activeWebSearch.googleSearchEngineId;\r\n            break;\r\n        }\r\n      }\r\n\r\n      // Use active AI extraction provider\r\n      if (activeAI) {\r\n        switch (activeAI.provider) {\r\n          case 'anthropic':\r\n            if (activeAI.apiKey) config.anthropicApiKey = activeAI.apiKey;\r\n            if (activeAI.baseUrl) config.anthropicBaseUrl = activeAI.baseUrl;\r\n            break;\r\n          case 'openai':\r\n          case 'openai_compatible':\r\n            if (activeAI.apiKey) config.openaiApiKey = activeAI.apiKey;\r\n            if (activeAI.baseUrl) config.openaiBaseUrl = activeAI.baseUrl;\r\n            if (activeAI.model) config.openaiModel = activeAI.model;\r\n            break;\r\n        }\r\n      }\r\n\r\n      // Fallback: Also check for any enabled providers if active ones weren't found\r\n      for (const instance of providerInstances) {\r\n        if (!instance.enabled) continue;\r\n\r\n        // Only fill in missing values\r\n        switch (instance.provider) {\r\n          case 'serper':\r\n            if (instance.apiKey && !config.serperApiKey) config.serperApiKey = instance.apiKey;\r\n            break;\r\n          case 'tavily':\r\n            if (instance.apiKey && !config.tavilyApiKey) config.tavilyApiKey = instance.apiKey;\r\n            break;\r\n          case 'google_search':\r\n            if (instance.apiKey && !config.googleSearchApiKey)\r\n              config.googleSearchApiKey = instance.apiKey;\r\n            if (instance.googleSearchEngineId && !config.googleSearchEngineId)\r\n              config.googleSearchEngineId = instance.googleSearchEngineId;\r\n            break;\r\n          case 'anthropic':\r\n            if (instance.apiKey && !config.anthropicApiKey)\r\n              config.anthropicApiKey = instance.apiKey;\r\n            if (instance.baseUrl && !config.anthropicBaseUrl)\r\n              config.anthropicBaseUrl = instance.baseUrl;\r\n            break;\r\n          case 'openai':\r\n          case 'openai_compatible':\r\n            if (instance.apiKey && !config.openaiApiKey) config.openaiApiKey = instance.apiKey;\r\n            if (instance.baseUrl && !config.openaiBaseUrl) config.openaiBaseUrl = instance.baseUrl;\r\n            if (instance.model && !config.openaiModel) config.openaiModel = instance.model;\r\n            break;\r\n        }\r\n      }\r\n\r\n      // Also check for web search providers (serper, tavily, google_search) separately\r\n      // since they might be different from the AI extraction provider\r\n      for (const instance of providerInstances) {\r\n        if (!instance.enabled) continue;\r\n\r\n        // Only process web search providers here (AI providers already handled above)\r\n        switch (instance.provider) {\r\n          case 'serper':\r\n            if (instance.apiKey && !config.serperApiKey) config.serperApiKey = instance.apiKey;\r\n            break;\r\n          case 'tavily':\r\n            if (instance.apiKey && !config.tavilyApiKey) config.tavilyApiKey = instance.apiKey;\r\n            break;\r\n          case 'google_search':\r\n            if (instance.apiKey && !config.googleSearchApiKey)\r\n              config.googleSearchApiKey = instance.apiKey;\r\n            if (instance.googleSearchEngineId && !config.googleSearchEngineId)\r\n              config.googleSearchEngineId = instance.googleSearchEngineId;\r\n            break;\r\n        }\r\n      }\r\n\r\n      // Collect ALL enabled AI providers for aggregation (API version)\r\n      const apiAiProviders = providerInstances.filter(\r\n        (i: any) => i?.enabled && ['anthropic', 'openai', 'openai_compatible'].includes(i.provider)\r\n      );\r\n      config.aiProviders = apiAiProviders\r\n        .map((instance: any) => ({\r\n          provider:\r\n            instance.provider === 'openai_compatible'\r\n              ? 'openai_compatible'\r\n              : instance.provider === 'anthropic'\r\n                ? 'anthropic'\r\n                : 'openai',\r\n          apiKey: instance.apiKey || '',\r\n          baseUrl: instance.baseUrl,\r\n          model: instance.model,\r\n          enabled: instance.enabled !== false,\r\n        }))\r\n        .filter((p: any) => p.enabled && p.apiKey);\r\n\r\n      console.log(\r\n        `✅ Found ${config.aiProviders.length} enabled AI provider(s) for aggregation (API)`\r\n      );\r\n\r\n      // LEGACY: Fallback to old structure for backward compatibility\r\n      const webSearch = dbConfig.config.webSearch || {};\r\n      const providers = dbConfig.config.providers || {};\r\n\r\n      if (!config.serperApiKey && webSearch.serperApiKey)\r\n        config.serperApiKey = webSearch.serperApiKey;\r\n      if (!config.tavilyApiKey && webSearch.tavilyApiKey)\r\n        config.tavilyApiKey = webSearch.tavilyApiKey;\r\n      if (!config.googleSearchApiKey && webSearch.googleSearchApiKey)\r\n        config.googleSearchApiKey = webSearch.googleSearchApiKey;\r\n      if (!config.googleSearchEngineId && webSearch.googleSearchEngineId)\r\n        config.googleSearchEngineId = webSearch.googleSearchEngineId;\r\n\r\n      if (!config.anthropicApiKey && providers.anthropic?.apiKey)\r\n        config.anthropicApiKey = providers.anthropic.apiKey;\r\n      if (!config.openaiApiKey && providers.openai?.apiKey)\r\n        config.openaiApiKey = providers.openai.apiKey;\r\n    }\r\n\r\n    return config;\r\n  } catch (error) {\r\n    console.warn('⚠️ Failed to load supplier discovery config from API:', error);\r\n    return {\r\n      serperApiKey: undefined,\r\n      tavilyApiKey: undefined,\r\n      googleSearchApiKey: undefined,\r\n      googleSearchEngineId: undefined,\r\n      anthropicApiKey: undefined,\r\n      openaiApiKey: undefined,\r\n    };\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\ai\\system-context.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":41,"column":5,"nodeType":"TemplateLiteral","endLine":45,"endColumn":32},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":50,"column":5,"nodeType":"TemplateLiteral","endLine":54,"endColumn":14},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":148,"column":5,"nodeType":"TemplateLiteral","endLine":153,"endColumn":14}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * AI Assistant System Context Provider\n *\n * Provides FULL system access to AI assistant for answering questions\n * about suppliers, inventory, customers, analytics, and all system data\n */\n\nimport { query } from '@/lib/database';\n\nexport interface SystemContext {\n  suppliers: {\n    total: number;\n    active: number;\n    topSuppliers: any[];\n  };\n  inventory: {\n    total: number;\n    lowStock: number;\n    outOfStock: number;\n    recentMovements: any[];\n  };\n  customers: {\n    total: number;\n    totalLoyaltyMembers: number;\n    recentCustomers: any[];\n  };\n  alerts: {\n    critical: number;\n    high: number;\n    anomalies: any[];\n  };\n  recentActivity: any[];\n}\n\n/**\n * Get comprehensive system context for AI assistant\n */\nexport async function getSystemContext(orgId: string): Promise<SystemContext> {\n  // Supplier data\n  const supplierStats = await query(\n    `SELECT\n      COUNT(*) as total,\n      COUNT(*) FILTER (WHERE status = 'active') as active\n    FROM suppliers\n    WHERE organization_id = $1`,\n    [orgId]\n  );\n\n  const topSuppliers = await query(\n    `SELECT id, name, status, performance_score, total_orders\n    FROM suppliers\n    WHERE organization_id = $1 AND status = 'active'\n    ORDER BY performance_score DESC NULLS LAST, total_orders DESC NULLS LAST\n    LIMIT 10`,\n    [orgId]\n  );\n\n  // Inventory data\n  const inventoryStats = await query(\n    `SELECT\n      COUNT(*) as total,\n      COUNT(*) FILTER (WHERE quantity <= reorder_point AND reorder_point > 0) as low_stock,\n      COUNT(*) FILTER (WHERE quantity = 0) as out_of_stock\n    FROM inventory_items\n    WHERE organization_id = $1`,\n    [orgId]\n  );\n\n  const recentMovements = await query(\n    `SELECT\n      m.id, m.movement_type, m.quantity, m.reference_number, m.created_at,\n      i.name as item_name, i.sku\n    FROM inventory_movements m\n    JOIN inventory_items i ON m.item_id = i.id\n    WHERE m.organization_id = $1\n    ORDER BY m.created_at DESC\n    LIMIT 20`,\n    [orgId]\n  );\n\n  // Customer data\n  const customerStats = await query(\n    `SELECT\n      (SELECT COUNT(*) FROM customers WHERE organization_id = $1) as total,\n      (SELECT COUNT(*) FROM loyalty_members WHERE organization_id = $1) as loyalty_members`,\n    [orgId]\n  );\n\n  const recentCustomers = await query(\n    `SELECT id, email, first_name, last_name, created_at\n    FROM customers\n    WHERE organization_id = $1\n    ORDER BY created_at DESC\n    LIMIT 10`,\n    [orgId]\n  );\n\n  // Alerts and anomalies\n  const alertStats = await query(\n    `SELECT\n      COUNT(*) FILTER (WHERE severity = 'critical' AND status != 'resolved') as critical,\n      COUNT(*) FILTER (WHERE severity = 'high' AND status != 'resolved') as high\n    FROM analytics_alerts\n    WHERE organization_id = $1`,\n    [orgId]\n  );\n\n  const recentAnomalies = await query(\n    `SELECT id, entity_type, entity_id, anomaly_type, severity, description, detected_at\n    FROM analytics_anomalies\n    WHERE organization_id = $1 AND status != 'resolved'\n    ORDER BY detected_at DESC\n    LIMIT 10`,\n    [orgId]\n  );\n\n  return {\n    suppliers: {\n      total: parseInt(supplierStats.rows[0]?.total || '0'),\n      active: parseInt(supplierStats.rows[0]?.active || '0'),\n      topSuppliers: topSuppliers.rows,\n    },\n    inventory: {\n      total: parseInt(inventoryStats.rows[0]?.total || '0'),\n      lowStock: parseInt(inventoryStats.rows[0]?.low_stock || '0'),\n      outOfStock: parseInt(inventoryStats.rows[0]?.out_of_stock || '0'),\n      recentMovements: recentMovements.rows,\n    },\n    customers: {\n      total: parseInt(customerStats.rows[0]?.total || '0'),\n      totalLoyaltyMembers: parseInt(customerStats.rows[0]?.loyalty_members || '0'),\n      recentCustomers: recentCustomers.rows,\n    },\n    alerts: {\n      critical: parseInt(alertStats.rows[0]?.critical || '0'),\n      high: parseInt(alertStats.rows[0]?.high || '0'),\n      anomalies: recentAnomalies.rows,\n    },\n    recentActivity: recentMovements.rows.slice(0, 10),\n  };\n}\n\n/**\n * Search suppliers by query\n */\nexport async function searchSuppliers(orgId: string, searchQuery: string, limit = 10) {\n  return await query(\n    `SELECT id, name, status, contact_email, phone, address, performance_score\n    FROM suppliers\n    WHERE organization_id = $1\n      AND (name ILIKE $2 OR contact_email ILIKE $2 OR address ILIKE $2)\n    ORDER BY performance_score DESC NULLS LAST\n    LIMIT $3`,\n    [orgId, `%${searchQuery}%`, limit]\n  );\n}\n\n/**\n * Search inventory items by query\n */\nexport async function searchInventory(orgId: string, searchQuery: string, limit = 10) {\n  return await query(\n    `SELECT id, name, sku, quantity, unit_price, reorder_point, category\n    FROM inventory_items\n    WHERE organization_id = $1\n      AND (name ILIKE $2 OR sku ILIKE $2 OR category ILIKE $2)\n    ORDER BY name\n    LIMIT $3`,\n    [orgId, `%${searchQuery}%`, limit]\n  );\n}\n\n/**\n * Search customers by query\n */\nexport async function searchCustomers(orgId: string, searchQuery: string, limit = 10) {\n  return await query(\n    `SELECT id, email, first_name, last_name, phone, created_at\n    FROM customers\n    WHERE organization_id = $1\n      AND (email ILIKE $2 OR first_name ILIKE $2 OR last_name ILIKE $2 OR phone ILIKE $2)\n    ORDER BY created_at DESC\n    LIMIT $3`,\n    [orgId, `%${searchQuery}%`, limit]\n  );\n}\n\n/**\n * Get inventory status summary\n */\nexport async function getInventoryStatus(orgId: string) {\n  const status = await query(\n    `SELECT\n      COUNT(*) as total_items,\n      SUM(quantity) as total_quantity,\n      SUM(quantity * unit_price) as total_value,\n      COUNT(*) FILTER (WHERE quantity <= reorder_point AND reorder_point > 0) as low_stock_items,\n      COUNT(*) FILTER (WHERE quantity = 0) as out_of_stock_items,\n      COUNT(DISTINCT category) as total_categories\n    FROM inventory_items\n    WHERE organization_id = $1`,\n    [orgId]\n  );\n\n  return status.rows[0];\n}\n\n/**\n * Get customer insights\n */\nexport async function getCustomerInsights(orgId: string) {\n  const insights = await query(\n    `SELECT\n      COUNT(*) as total_customers,\n      COUNT(*) FILTER (WHERE created_at > NOW() - INTERVAL '30 days') as new_customers_30d,\n      (SELECT COUNT(*) FROM loyalty_members WHERE organization_id = $1) as loyalty_members,\n      (SELECT SUM(points_balance) FROM loyalty_members WHERE organization_id = $1) as total_loyalty_points\n    FROM customers\n    WHERE organization_id = $1`,\n    [orgId]\n  );\n\n  return insights.rows[0];\n}\n\n/**\n * Get unresolved alerts\n */\nexport async function getUnresolvedAlerts(orgId: string) {\n  const alerts = await query(\n    `SELECT\n      id, alert_type, severity, title, description,\n      entity_type, entity_id, status, created_at\n    FROM analytics_alerts\n    WHERE organization_id = $1 AND status != 'resolved'\n    ORDER BY\n      CASE severity\n        WHEN 'critical' THEN 1\n        WHEN 'high' THEN 2\n        WHEN 'medium' THEN 3\n        WHEN 'low' THEN 4\n      END,\n      created_at DESC\n    LIMIT 50`,\n    [orgId]\n  );\n\n  return alerts.rows;\n}\n\n/**\n * Execute custom SQL query (for AI assistant advanced queries)\n * RESTRICTED to SELECT only for safety\n */\nexport async function executeCustomQuery(orgId: string, sqlQuery: string) {\n  // Security: Only allow SELECT queries\n  const trimmedQuery = sqlQuery.trim().toUpperCase();\n  if (!trimmedQuery.startsWith('SELECT')) {\n    throw new Error('Only SELECT queries are allowed');\n  }\n\n  // Inject organization_id filter if not present\n  if (!sqlQuery.toLowerCase().includes('organization_id')) {\n    throw new Error('Query must include organization_id filter');\n  }\n\n  return await query(sqlQuery);\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\MetricsCalculator.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":225,"column":7,"nodeType":"TemplateLiteral","endLine":231,"endColumn":8},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":267,"column":7,"nodeType":"TemplateLiteral","endLine":287,"endColumn":8}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '@/lib/database';\n\nexport type MetricType =\n  | 'sales'\n  | 'inventory'\n  | 'supplier_performance'\n  | 'customer_behavior'\n  | 'financial'\n  | 'operational';\n\nexport type TimePeriod = 'hourly' | 'daily' | 'weekly' | 'monthly' | 'quarterly' | 'yearly';\n\nexport interface MetricResult {\n  metricType: MetricType;\n  metricKey: string;\n  value: any;\n  timePeriod: TimePeriod;\n  periodStart: Date;\n  periodEnd: Date;\n  calculatedAt: Date;\n}\n\nexport interface SalesMetrics {\n  totalRevenue: number;\n  totalOrders: number;\n  averageOrderValue: number;\n  topProducts: Array<{ productId: string; name: string; revenue: number; quantity: number }>;\n  revenueByCategory: Array<{ category: string; revenue: number }>;\n  growthRate: number;\n}\n\nexport interface InventoryMetrics {\n  totalValue: number;\n  itemCount: number;\n  lowStockItems: number;\n  overstockItems: number;\n  turnoverRate: number;\n  daysOfInventory: number;\n  stockAccuracy: number;\n}\n\nexport interface SupplierPerformanceMetrics {\n  totalSuppliers: number;\n  activeSuppliers: number;\n  averageScore: number;\n  onTimeDeliveryRate: number;\n  topSuppliers: Array<{ supplierId: string; name: string; score: number; totalOrders: number }>;\n  riskDistribution: Record<string, number>;\n}\n\nexport class MetricsCalculator {\n  /**\n   * Calculate sales metrics for a period\n   */\n  static async calculateSalesMetrics(\n    orgId: string,\n    periodStart: Date,\n    periodEnd: Date,\n  ): Promise<SalesMetrics> {\n    // Total revenue and orders\n    const totalsResult = await db.query(\n      `\n      SELECT\n        COALESCE(SUM(po.total_amount), 0) as total_revenue,\n        COUNT(DISTINCT po.id) as total_orders,\n        COALESCE(AVG(po.total_amount), 0) as average_order_value\n      FROM purchase_orders po\n      WHERE po.org_id = $1\n        AND po.created_at BETWEEN $2 AND $3\n        AND po.status = 'completed'\n      `,\n      [orgId, periodStart, periodEnd],\n    );\n\n    const { total_revenue, total_orders, average_order_value } = totalsResult.rows[0];\n\n    // Top products by revenue\n    const topProductsResult = await db.query(\n      `\n      SELECT\n        p.id as product_id,\n        p.name,\n        SUM(poi.quantity * poi.unit_price) as revenue,\n        SUM(poi.quantity) as quantity\n      FROM purchase_order_items poi\n      JOIN purchase_orders po ON po.id = poi.purchase_order_id\n      JOIN products p ON p.id = poi.product_id\n      WHERE po.org_id = $1\n        AND po.created_at BETWEEN $2 AND $3\n        AND po.status = 'completed'\n      GROUP BY p.id, p.name\n      ORDER BY revenue DESC\n      LIMIT 10\n      `,\n      [orgId, periodStart, periodEnd],\n    );\n\n    const topProducts = topProductsResult.rows.map((row) => ({\n      productId: row.product_id,\n      name: row.name,\n      revenue: parseFloat(row.revenue),\n      quantity: parseFloat(row.quantity),\n    }));\n\n    // Revenue by category\n    const categoryResult = await db.query(\n      `\n      SELECT\n        COALESCE(c.name, 'Uncategorized') as category,\n        SUM(poi.quantity * poi.unit_price) as revenue\n      FROM purchase_order_items poi\n      JOIN purchase_orders po ON po.id = poi.purchase_order_id\n      JOIN products p ON p.id = poi.product_id\n      LEFT JOIN categories c ON c.id = p.category_id\n      WHERE po.org_id = $1\n        AND po.created_at BETWEEN $2 AND $3\n        AND po.status = 'completed'\n      GROUP BY c.name\n      ORDER BY revenue DESC\n      `,\n      [orgId, periodStart, periodEnd],\n    );\n\n    const revenueByCategory = categoryResult.rows.map((row) => ({\n      category: row.category,\n      revenue: parseFloat(row.revenue),\n    }));\n\n    // Calculate growth rate (compare to previous period)\n    const previousPeriodStart = new Date(periodStart);\n    const previousPeriodEnd = new Date(periodEnd);\n    const periodDuration = periodEnd.getTime() - periodStart.getTime();\n    previousPeriodStart.setTime(previousPeriodStart.getTime() - periodDuration);\n    previousPeriodEnd.setTime(previousPeriodEnd.getTime() - periodDuration);\n\n    const previousResult = await db.query(\n      `\n      SELECT COALESCE(SUM(po.total_amount), 0) as previous_revenue\n      FROM purchase_orders po\n      WHERE po.org_id = $1\n        AND po.created_at BETWEEN $2 AND $3\n        AND po.status = 'completed'\n      `,\n      [orgId, previousPeriodStart, previousPeriodEnd],\n    );\n\n    const previousRevenue = parseFloat(previousResult.rows[0].previous_revenue);\n    const growthRate = previousRevenue > 0\n      ? ((parseFloat(total_revenue) - previousRevenue) / previousRevenue) * 100\n      : 0;\n\n    return {\n      totalRevenue: parseFloat(total_revenue),\n      totalOrders: parseInt(total_orders),\n      averageOrderValue: parseFloat(average_order_value),\n      topProducts,\n      revenueByCategory,\n      growthRate,\n    };\n  }\n\n  /**\n   * Calculate inventory metrics\n   */\n  static async calculateInventoryMetrics(\n    orgId: string,\n  ): Promise<InventoryMetrics> {\n    const result = await db.query(\n      `\n      WITH inventory_data AS (\n        SELECT\n          p.id,\n          p.name,\n          p.unit_cost,\n          soh.quantity,\n          p.reorder_point,\n          p.max_stock_level\n        FROM products p\n        LEFT JOIN stock_on_hand soh ON soh.product_id = p.id\n        WHERE current_setting('app.current_org_id', true)::uuid = $1\n      ),\n      movement_data AS (\n        SELECT\n          product_id,\n          SUM(ABS(quantity)) as total_movement\n        FROM stock_movement\n        WHERE created_at >= NOW() - INTERVAL '30 days'\n          AND current_setting('app.current_org_id', true)::uuid = $1\n        GROUP BY product_id\n      )\n      SELECT\n        COUNT(DISTINCT id.id) as item_count,\n        SUM(id.unit_cost * id.quantity) as total_value,\n        COUNT(*) FILTER (WHERE id.quantity <= id.reorder_point) as low_stock_items,\n        COUNT(*) FILTER (WHERE id.quantity >= id.max_stock_level * 1.2) as overstock_items,\n        AVG(CASE WHEN id.quantity > 0 THEN md.total_movement / id.quantity ELSE 0 END) as turnover_rate,\n        AVG(CASE WHEN md.total_movement > 0 THEN (30.0 * id.quantity) / md.total_movement ELSE 999 END) as days_of_inventory\n      FROM inventory_data id\n      LEFT JOIN movement_data md ON md.product_id = id.id\n      `,\n      [orgId],\n    );\n\n    const row = result.rows[0];\n\n    return {\n      totalValue: parseFloat(row.total_value) || 0,\n      itemCount: parseInt(row.item_count) || 0,\n      lowStockItems: parseInt(row.low_stock_items) || 0,\n      overstockItems: parseInt(row.overstock_items) || 0,\n      turnoverRate: parseFloat(row.turnover_rate) || 0,\n      daysOfInventory: Math.min(parseFloat(row.days_of_inventory) || 0, 999),\n      stockAccuracy: 0.95, // Would calculate from cycle counts\n    };\n  }\n\n  /**\n   * Calculate supplier performance metrics\n   */\n  static async calculateSupplierMetrics(\n    orgId: string,\n  ): Promise<SupplierPerformanceMetrics> {\n    // Total and active suppliers\n    const suppliersResult = await db.query(\n      `\n      SELECT\n        COUNT(*) as total_suppliers,\n        COUNT(*) FILTER (WHERE is_active = true) as active_suppliers\n      FROM suppliers\n      WHERE current_setting('app.current_org_id', true)::uuid = $1\n      `,\n      [orgId],\n    );\n\n    const { total_suppliers, active_suppliers } = suppliersResult.rows[0];\n\n    // Average score from predictions\n    const scoreResult = await db.query(\n      `\n      SELECT AVG(confidence_score) as avg_score\n      FROM ai_prediction\n      WHERE org_id = $1\n        AND service_type = 'supplier_scoring'\n        AND expires_at > NOW()\n      `,\n      [orgId],\n    );\n\n    const averageScore = (parseFloat(scoreResult.rows[0]?.avg_score) || 0.75) * 100;\n\n    // On-time delivery rate\n    const deliveryResult = await db.query(\n      `\n      SELECT AVG(CASE WHEN delivered_on_time THEN 1 ELSE 0 END) as on_time_rate\n      FROM purchase_orders\n      WHERE org_id = $1\n        AND status = 'completed'\n        AND created_at >= NOW() - INTERVAL '90 days'\n      `,\n      [orgId],\n    );\n\n    const onTimeDeliveryRate = parseFloat(deliveryResult.rows[0]?.on_time_rate) || 0;\n\n    // Top suppliers\n    const topSuppliersResult = await db.query(\n      `\n      SELECT\n        s.id as supplier_id,\n        s.name,\n        COALESCE((\n          SELECT confidence_score * 100\n          FROM ai_prediction\n          WHERE service_type = 'supplier_scoring'\n            AND entity_id = s.id\n            AND expires_at > NOW()\n          ORDER BY created_at DESC\n          LIMIT 1\n        ), 75) as score,\n        COUNT(po.id) as total_orders\n      FROM suppliers s\n      LEFT JOIN purchase_orders po ON po.supplier_id = s.id AND po.created_at >= NOW() - INTERVAL '90 days'\n      WHERE current_setting('app.current_org_id', true)::uuid = $1\n      GROUP BY s.id, s.name\n      ORDER BY score DESC, total_orders DESC\n      LIMIT 10\n      `,\n      [orgId],\n    );\n\n    const topSuppliers = topSuppliersResult.rows.map((row) => ({\n      supplierId: row.supplier_id,\n      name: row.name,\n      score: parseFloat(row.score),\n      totalOrders: parseInt(row.total_orders),\n    }));\n\n    // Risk distribution\n    const riskDistribution: Record<string, number> = {\n      low: 0,\n      medium: 0,\n      high: 0,\n      critical: 0,\n    };\n\n    topSuppliers.forEach((supplier) => {\n      if (supplier.score >= 85) riskDistribution.low++;\n      else if (supplier.score >= 70) riskDistribution.medium++;\n      else if (supplier.score >= 50) riskDistribution.high++;\n      else riskDistribution.critical++;\n    });\n\n    return {\n      totalSuppliers: parseInt(total_suppliers),\n      activeSuppliers: parseInt(active_suppliers),\n      averageScore,\n      onTimeDeliveryRate: onTimeDeliveryRate * 100,\n      topSuppliers,\n      riskDistribution,\n    };\n  }\n\n  /**\n   * Cache metric in database\n   */\n  static async cacheMetric(\n    orgId: string,\n    metricType: MetricType,\n    metricKey: string,\n    value: any,\n    timePeriod: TimePeriod,\n    periodStart: Date,\n    periodEnd: Date,\n  ): Promise<void> {\n    await db.query(\n      `\n      INSERT INTO analytics_metric_cache (\n        org_id, metric_type, metric_key, metric_value,\n        time_period, period_start, period_end\n      )\n      VALUES ($1, $2, $3, $4, $5, $6, $7)\n      ON CONFLICT (org_id, metric_type, metric_key, period_start)\n      DO UPDATE SET\n        metric_value = EXCLUDED.metric_value,\n        calculated_at = NOW()\n      `,\n      [\n        orgId,\n        metricType,\n        metricKey,\n        JSON.stringify(value),\n        timePeriod,\n        periodStart,\n        periodEnd,\n      ],\n    );\n  }\n\n  /**\n   * Get cached metric\n   */\n  static async getCachedMetric(\n    orgId: string,\n    metricType: MetricType,\n    metricKey: string,\n    periodStart: Date,\n  ): Promise<any | null> {\n    const result = await db.query(\n      `\n      SELECT metric_value, calculated_at\n      FROM analytics_metric_cache\n      WHERE org_id = $1\n        AND metric_type = $2\n        AND metric_key = $3\n        AND period_start = $4\n        AND calculated_at >= NOW() - INTERVAL '1 hour'\n      ORDER BY calculated_at DESC\n      LIMIT 1\n      `,\n      [orgId, metricType, metricKey, periodStart],\n    );\n\n    if (result.rows.length === 0) {\n      return null;\n    }\n\n    return result.rows[0].metric_value;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\WidgetDataProvider.ts","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":163,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":167,"endColumn":11,"suggestions":[{"messageId":"addBrackets","fix":{"range":[4128,4328],"text":"{ const metrics = await MetricsCalculator.calculateSalesMetrics(\n          orgId,\n          dateRange.start,\n          dateRange.end,\n        );\n        return metrics.topProducts.slice(0, limit || 10); }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '@/lib/database';\nimport { MetricsCalculator, type MetricType } from './MetricsCalculator';\n\nexport type WidgetType = 'chart' | 'kpi' | 'table' | 'map';\n\nexport interface WidgetConfig {\n  id: string;\n  widgetType: WidgetType;\n  metricType: MetricType;\n  config: {\n    chartType?: 'line' | 'bar' | 'pie' | 'area';\n    aggregation?: 'sum' | 'avg' | 'count' | 'min' | 'max';\n    groupBy?: string;\n    timeRange?: string;\n    limit?: number;\n  };\n  query: {\n    filters?: Record<string, any>;\n    dateRange?: { start: Date; end: Date };\n  };\n}\n\nexport interface WidgetData {\n  widgetId: string;\n  data: any;\n  metadata: {\n    calculatedAt: Date;\n    dataPoints: number;\n    fromCache: boolean;\n  };\n}\n\nexport class WidgetDataProvider {\n  /**\n   * Fetch data for a specific widget\n   */\n  static async getWidgetData(\n    orgId: string,\n    widgetConfig: WidgetConfig,\n  ): Promise<WidgetData> {\n    const startTime = Date.now();\n\n    let data: any;\n    let fromCache = false;\n\n    // Try to get from cache first\n    const cacheKey = this.generateCacheKey(widgetConfig);\n    const cached = await MetricsCalculator.getCachedMetric(\n      orgId,\n      widgetConfig.metricType,\n      cacheKey,\n      widgetConfig.query.dateRange?.start || new Date(),\n    );\n\n    if (cached) {\n      data = cached;\n      fromCache = true;\n    } else {\n      // Calculate fresh data\n      data = await this.calculateWidgetData(orgId, widgetConfig);\n\n      // Cache the result\n      if (widgetConfig.query.dateRange) {\n        await MetricsCalculator.cacheMetric(\n          orgId,\n          widgetConfig.metricType,\n          cacheKey,\n          data,\n          'hourly',\n          widgetConfig.query.dateRange.start,\n          widgetConfig.query.dateRange.end,\n        );\n      }\n    }\n\n    return {\n      widgetId: widgetConfig.id,\n      data,\n      metadata: {\n        calculatedAt: new Date(),\n        dataPoints: Array.isArray(data) ? data.length : Object.keys(data).length,\n        fromCache,\n      },\n    };\n  }\n\n  /**\n   * Fetch data for multiple widgets in parallel\n   */\n  static async getBatchWidgetData(\n    orgId: string,\n    widgetConfigs: WidgetConfig[],\n  ): Promise<WidgetData[]> {\n    const results = await Promise.all(\n      widgetConfigs.map((config) => this.getWidgetData(orgId, config)),\n    );\n\n    return results;\n  }\n\n  /**\n   * Calculate widget data based on type and config\n   */\n  private static async calculateWidgetData(\n    orgId: string,\n    widgetConfig: WidgetConfig,\n  ): Promise<any> {\n    switch (widgetConfig.metricType) {\n      case 'sales':\n        return this.calculateSalesData(orgId, widgetConfig);\n      case 'inventory':\n        return this.calculateInventoryData(orgId, widgetConfig);\n      case 'supplier_performance':\n        return this.calculateSupplierData(orgId, widgetConfig);\n      case 'financial':\n        return this.calculateFinancialData(orgId, widgetConfig);\n      case 'operational':\n        return this.calculateOperationalData(orgId, widgetConfig);\n      default:\n        throw new Error(`Unsupported metric type: ${widgetConfig.metricType}`);\n    }\n  }\n\n  /**\n   * Calculate sales-related widget data\n   */\n  private static async calculateSalesData(\n    orgId: string,\n    widgetConfig: WidgetConfig,\n  ): Promise<any> {\n    const { dateRange, filters } = widgetConfig.query;\n    const { chartType, groupBy, limit } = widgetConfig.config;\n\n    if (!dateRange) {\n      throw new Error('Date range required for sales metrics');\n    }\n\n    switch (widgetConfig.widgetType) {\n      case 'kpi':\n        return MetricsCalculator.calculateSalesMetrics(\n          orgId,\n          dateRange.start,\n          dateRange.end,\n        );\n\n      case 'chart':\n        if (groupBy === 'category') {\n          const metrics = await MetricsCalculator.calculateSalesMetrics(\n            orgId,\n            dateRange.start,\n            dateRange.end,\n          );\n          return metrics.revenueByCategory;\n        }\n\n        if (groupBy === 'time') {\n          return this.getSalesOverTime(orgId, dateRange.start, dateRange.end);\n        }\n\n        return [];\n\n      case 'table':\n        const metrics = await MetricsCalculator.calculateSalesMetrics(\n          orgId,\n          dateRange.start,\n          dateRange.end,\n        );\n        return metrics.topProducts.slice(0, limit || 10);\n\n      default:\n        return {};\n    }\n  }\n\n  /**\n   * Calculate inventory-related widget data\n   */\n  private static async calculateInventoryData(\n    orgId: string,\n    widgetConfig: WidgetConfig,\n  ): Promise<any> {\n    const metrics = await MetricsCalculator.calculateInventoryMetrics(orgId);\n\n    switch (widgetConfig.widgetType) {\n      case 'kpi':\n        return metrics;\n\n      case 'chart':\n        // Return inventory breakdown\n        return [\n          { label: 'Total Items', value: metrics.itemCount },\n          { label: 'Low Stock', value: metrics.lowStockItems },\n          { label: 'Overstock', value: metrics.overstockItems },\n        ];\n\n      case 'table':\n        return this.getLowStockProducts(orgId, widgetConfig.config.limit || 10);\n\n      default:\n        return {};\n    }\n  }\n\n  /**\n   * Calculate supplier-related widget data\n   */\n  private static async calculateSupplierData(\n    orgId: string,\n    widgetConfig: WidgetConfig,\n  ): Promise<any> {\n    const metrics = await MetricsCalculator.calculateSupplierMetrics(orgId);\n\n    switch (widgetConfig.widgetType) {\n      case 'kpi':\n        return metrics;\n\n      case 'chart':\n        return Object.entries(metrics.riskDistribution).map(([level, count]) => ({\n          label: level.charAt(0).toUpperCase() + level.slice(1) + ' Risk',\n          value: count,\n        }));\n\n      case 'table':\n        return metrics.topSuppliers.slice(0, widgetConfig.config.limit || 10);\n\n      default:\n        return {};\n    }\n  }\n\n  /**\n   * Calculate financial widget data\n   */\n  private static async calculateFinancialData(\n    orgId: string,\n    widgetConfig: WidgetConfig,\n  ): Promise<any> {\n    const { dateRange } = widgetConfig.query;\n\n    if (!dateRange) {\n      throw new Error('Date range required for financial metrics');\n    }\n\n    const result = await db.query(\n      `\n      SELECT\n        SUM(po.total_amount) as total_spend,\n        AVG(po.total_amount) as avg_order_value,\n        COUNT(DISTINCT po.supplier_id) as suppliers_used,\n        SUM(CASE WHEN po.payment_status = 'paid' THEN po.total_amount ELSE 0 END) as total_paid,\n        SUM(CASE WHEN po.payment_status = 'pending' THEN po.total_amount ELSE 0 END) as total_pending\n      FROM purchase_orders po\n      WHERE po.org_id = $1\n        AND po.created_at BETWEEN $2 AND $3\n      `,\n      [orgId, dateRange.start, dateRange.end],\n    );\n\n    const row = result.rows[0];\n\n    return {\n      totalSpend: parseFloat(row.total_spend) || 0,\n      avgOrderValue: parseFloat(row.avg_order_value) || 0,\n      suppliersUsed: parseInt(row.suppliers_used) || 0,\n      totalPaid: parseFloat(row.total_paid) || 0,\n      totalPending: parseFloat(row.total_pending) || 0,\n    };\n  }\n\n  /**\n   * Calculate operational widget data\n   */\n  private static async calculateOperationalData(\n    orgId: string,\n    widgetConfig: WidgetConfig,\n  ): Promise<any> {\n    const { dateRange } = widgetConfig.query;\n\n    if (!dateRange) {\n      throw new Error('Date range required for operational metrics');\n    }\n\n    const result = await db.query(\n      `\n      SELECT\n        COUNT(DISTINCT sm.id) as total_movements,\n        COUNT(DISTINCT sm.product_id) as products_moved,\n        SUM(ABS(sm.quantity)) as total_quantity_moved,\n        COUNT(DISTINCT po.id) as total_orders,\n        AVG(EXTRACT(DAY FROM po.delivery_date - po.order_date)) as avg_lead_time\n      FROM stock_movement sm\n      LEFT JOIN purchase_orders po ON po.created_at BETWEEN $2 AND $3\n      WHERE current_setting('app.current_org_id', true)::uuid = $1\n        AND sm.created_at BETWEEN $2 AND $3\n      `,\n      [orgId, dateRange.start, dateRange.end],\n    );\n\n    const row = result.rows[0];\n\n    return {\n      totalMovements: parseInt(row.total_movements) || 0,\n      productsMoved: parseInt(row.products_moved) || 0,\n      totalQuantityMoved: parseFloat(row.total_quantity_moved) || 0,\n      totalOrders: parseInt(row.total_orders) || 0,\n      avgLeadTime: parseFloat(row.avg_lead_time) || 0,\n    };\n  }\n\n  /**\n   * Get sales data over time\n   */\n  private static async getSalesOverTime(\n    orgId: string,\n    startDate: Date,\n    endDate: Date,\n  ): Promise<Array<{ date: string; revenue: number; orders: number }>> {\n    const result = await db.query(\n      `\n      SELECT\n        DATE(po.created_at) as date,\n        SUM(po.total_amount) as revenue,\n        COUNT(*) as orders\n      FROM purchase_orders po\n      WHERE po.org_id = $1\n        AND po.created_at BETWEEN $2 AND $3\n        AND po.status = 'completed'\n      GROUP BY DATE(po.created_at)\n      ORDER BY date ASC\n      `,\n      [orgId, startDate, endDate],\n    );\n\n    return result.rows.map((row) => ({\n      date: row.date,\n      revenue: parseFloat(row.revenue),\n      orders: parseInt(row.orders),\n    }));\n  }\n\n  /**\n   * Get low stock products\n   */\n  private static async getLowStockProducts(\n    orgId: string,\n    limit: number,\n  ): Promise<Array<{ productId: string; name: string; quantity: number; reorderPoint: number }>> {\n    const result = await db.query(\n      `\n      SELECT\n        p.id as product_id,\n        p.name,\n        soh.quantity,\n        p.reorder_point\n      FROM products p\n      JOIN stock_on_hand soh ON soh.product_id = p.id\n      WHERE current_setting('app.current_org_id', true)::uuid = $1\n        AND soh.quantity <= p.reorder_point\n      ORDER BY (soh.quantity / NULLIF(p.reorder_point, 0)) ASC\n      LIMIT $2\n      `,\n      [orgId, limit],\n    );\n\n    return result.rows.map((row) => ({\n      productId: row.product_id,\n      name: row.name,\n      quantity: parseFloat(row.quantity),\n      reorderPoint: parseFloat(row.reorder_point),\n    }));\n  }\n\n  /**\n   * Generate cache key for widget\n   */\n  private static generateCacheKey(widgetConfig: WidgetConfig): string {\n    const parts = [\n      widgetConfig.widgetType,\n      widgetConfig.metricType,\n      widgetConfig.config.chartType || '',\n      widgetConfig.config.groupBy || '',\n      JSON.stringify(widgetConfig.query.filters || {}),\n    ];\n\n    return parts.join('_');\n  }\n\n  /**\n   * Refresh widget cache\n   */\n  static async refreshWidgetCache(\n    orgId: string,\n    widgetId: string,\n  ): Promise<void> {\n    // Get widget config from database\n    const result = await db.query(\n      `\n      SELECT widget_type, metric_type, config, query\n      FROM analytics_widget\n      WHERE id = $1 AND org_id = $2\n      `,\n      [widgetId, orgId],\n    );\n\n    if (result.rows.length === 0) {\n      throw new Error(`Widget ${widgetId} not found`);\n    }\n\n    const row = result.rows[0];\n    const widgetConfig: WidgetConfig = {\n      id: widgetId,\n      widgetType: row.widget_type,\n      metricType: row.metric_type,\n      config: row.config,\n      query: row.query,\n    };\n\n    // Force fresh calculation\n    const data = await this.calculateWidgetData(orgId, widgetConfig);\n\n    // Update cache\n    if (widgetConfig.query.dateRange) {\n      await MetricsCalculator.cacheMetric(\n        orgId,\n        widgetConfig.metricType,\n        this.generateCacheKey(widgetConfig),\n        data,\n        'hourly',\n        widgetConfig.query.dateRange.start,\n        widgetConfig.query.dateRange.end,\n      );\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\advanced-ml-models.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Advanced Machine Learning Models for MantisNXT Platform\r\n// Implements sophisticated ML algorithms for intelligent analytics\r\n\r\nimport { Pool } from 'pg';\r\nimport { SupplierPerformance, InventoryItem, StockMovement } from '@/types';\r\n\r\n// Advanced ML Types\r\nexport interface NeuralNetworkPrediction {\r\n  prediction: number;\r\n  confidence: number;\r\n  uncertaintyBounds: { lower: number; upper: number };\r\n  features: Record<string, number>;\r\n  modelType: 'regression' | 'classification' | 'ensemble';\r\n  explanation: string[];\r\n  timestamp: Date;\r\n}\r\n\r\nexport interface TimeSeriesForecast {\r\n  itemId: string;\r\n  forecastHorizon: number; // days\r\n  predictions: Array<{\r\n    date: Date;\r\n    predicted: number;\r\n    lowerBound: number;\r\n    upperBound: number;\r\n    seasonalComponent: number;\r\n    trendComponent: number;\r\n  }>;\r\n  accuracy: {\r\n    mape: number; // Mean Absolute Percentage Error\r\n    rmse: number; // Root Mean Square Error\r\n    mae: number;  // Mean Absolute Error\r\n  };\r\n  modelMetadata: {\r\n    algorithm: string;\r\n    trainingData: number;\r\n    lastTraining: Date;\r\n    parameters: Record<string, any>;\r\n  };\r\n}\r\n\r\nexport interface EnsemblePrediction {\r\n  models: Array<{\r\n    name: string;\r\n    prediction: number;\r\n    weight: number;\r\n    confidence: number;\r\n  }>;\r\n  finalPrediction: number;\r\n  consensus: number; // Agreement between models\r\n  explanation: string;\r\n}\r\n\r\n// Neural Network Implementation (Simplified)\r\nexport class NeuralNetwork {\r\n  private weights: number[][];\r\n  private biases: number[];\r\n  private learningRate: number = 0.01;\r\n  private layers: number[];\r\n\r\n  constructor(layers: number[]) {\r\n    this.layers = layers;\r\n    this.initializeWeights();\r\n  }\r\n\r\n  private initializeWeights() {\r\n    this.weights = [];\r\n    this.biases = [];\r\n\r\n    for (let i = 0; i < this.layers.length - 1; i++) {\r\n      const layerWeights: number[][] = [];\r\n      for (let j = 0; j < this.layers[i + 1]; j++) {\r\n        const neuronWeights: number[] = [];\r\n        for (let k = 0; k < this.layers[i]; k++) {\r\n          neuronWeights.push((Math.random() - 0.5) * 2);\r\n        }\r\n        layerWeights.push(neuronWeights);\r\n      }\r\n      this.weights.push(layerWeights);\r\n      this.biases.push(new Array(this.layers[i + 1]).fill(0).map(() => (Math.random() - 0.5) * 2));\r\n    }\r\n  }\r\n\r\n  private sigmoid(x: number): number {\r\n    return 1 / (1 + Math.exp(-x));\r\n  }\r\n\r\n  private relu(x: number): number {\r\n    return Math.max(0, x);\r\n  }\r\n\r\n  predict(inputs: number[]): number[] {\r\n    let activations = [...inputs];\r\n\r\n    for (let i = 0; i < this.weights.length; i++) {\r\n      const newActivations: number[] = [];\r\n\r\n      for (let j = 0; j < this.weights[i].length; j++) {\r\n        let sum = this.biases[i][j];\r\n        for (let k = 0; k < activations.length; k++) {\r\n          sum += activations[k] * this.weights[i][j][k];\r\n        }\r\n        newActivations.push(i === this.weights.length - 1 ? sum : this.relu(sum));\r\n      }\r\n\r\n      activations = newActivations;\r\n    }\r\n\r\n    return activations;\r\n  }\r\n\r\n  train(trainingData: Array<{ inputs: number[]; outputs: number[] }>, epochs: number = 1000) {\r\n    for (let epoch = 0; epoch < epochs; epoch++) {\r\n      for (const sample of trainingData) {\r\n        this.backpropagate(sample.inputs, sample.outputs);\r\n      }\r\n    }\r\n  }\r\n\r\n  private backpropagate(inputs: number[], targetOutputs: number[]) {\r\n    // Forward pass\r\n    const layerOutputs: number[][] = [inputs];\r\n    let currentInput = inputs;\r\n\r\n    for (let i = 0; i < this.weights.length; i++) {\r\n      const output: number[] = [];\r\n      for (let j = 0; j < this.weights[i].length; j++) {\r\n        let sum = this.biases[i][j];\r\n        for (let k = 0; k < currentInput.length; k++) {\r\n          sum += currentInput[k] * this.weights[i][j][k];\r\n        }\r\n        output.push(i === this.weights.length - 1 ? sum : this.relu(sum));\r\n      }\r\n      layerOutputs.push(output);\r\n      currentInput = output;\r\n    }\r\n\r\n    // Backward pass (simplified)\r\n    const errors: number[][] = [];\r\n    const finalOutput = layerOutputs[layerOutputs.length - 1];\r\n    const outputError = finalOutput.map((output, i) => targetOutputs[i] - output);\r\n    errors.unshift(outputError);\r\n\r\n    // Update weights and biases\r\n    for (let i = this.weights.length - 1; i >= 0; i--) {\r\n      for (let j = 0; j < this.weights[i].length; j++) {\r\n        for (let k = 0; k < this.weights[i][j].length; k++) {\r\n          this.weights[i][j][k] += this.learningRate * errors[0][j] * layerOutputs[i][k];\r\n        }\r\n        this.biases[i][j] += this.learningRate * errors[0][j];\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Advanced Supplier Performance Predictor\r\nexport class AdvancedSupplierPredictor {\r\n  private neuralNetwork: NeuralNetwork;\r\n  private featureScaling: { mean: number[]; std: number[] };\r\n  private db: Pool;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n    this.neuralNetwork = new NeuralNetwork([10, 20, 15, 1]); // 10 inputs, hidden layers, 1 output\r\n    this.featureScaling = { mean: [], std: [] };\r\n  }\r\n\r\n  async predictSupplierPerformance(\r\n    supplierId: string,\r\n    historicalData: SupplierPerformance[]\r\n  ): Promise<NeuralNetworkPrediction> {\r\n    try {\r\n      // Extract and normalize features\r\n      const features = this.extractAdvancedFeatures(historicalData);\r\n      const normalizedFeatures = this.normalizeFeatures(features);\r\n\r\n      // Get prediction from neural network\r\n      const prediction = this.neuralNetwork.predict(normalizedFeatures)[0];\r\n\r\n      // Calculate confidence based on historical performance variance\r\n      const confidence = this.calculateAdvancedConfidence(historicalData, features);\r\n\r\n      // Calculate uncertainty bounds\r\n      const uncertaintyBounds = this.calculateUncertaintyBounds(prediction, confidence);\r\n\r\n      // Generate explanation\r\n      const explanation = this.generateExplanation(features, prediction);\r\n\r\n      return {\r\n        prediction: Math.max(0, Math.min(1, prediction)),\r\n        confidence,\r\n        uncertaintyBounds,\r\n        features: this.featuresToObject(features),\r\n        modelType: 'regression',\r\n        explanation,\r\n        timestamp: new Date()\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Advanced supplier prediction error:', error);\r\n      throw new Error('Failed to predict supplier performance');\r\n    }\r\n  }\r\n\r\n  private extractAdvancedFeatures(history: SupplierPerformance[]): number[] {\r\n    if (history.length === 0) {\r\n      return new Array(10).fill(0);\r\n    }\r\n\r\n    const recent = history.slice(0, 5); // Last 5 evaluations\r\n    const older = history.slice(5, 10); // Previous 5 evaluations\r\n\r\n    return [\r\n      this.calculateAverage(recent.map(h => h.metrics.onTimeDeliveryRate)) / 100,\r\n      this.calculateAverage(recent.map(h => h.metrics.qualityAcceptanceRate)) / 100,\r\n      this.calculateTrend(history.map(h => h.overallRating)),\r\n      this.calculateVolatility(history.map(h => h.overallRating)),\r\n      this.calculateSeasonality(history),\r\n      this.calculateAverage(recent.map(h => h.metrics.responseTime)) / 48, // Normalize by 48 hours\r\n      this.calculateImprovement(recent, older),\r\n      this.calculateConsistency(history),\r\n      this.calculateRecentPerformance(recent),\r\n      this.calculateRiskIndicator(history)\r\n    ];\r\n  }\r\n\r\n  private normalizeFeatures(features: number[]): number[] {\r\n    if (this.featureScaling.mean.length === 0) {\r\n      // Initialize with current features (in production, use historical data)\r\n      this.featureScaling.mean = features.slice();\r\n      this.featureScaling.std = new Array(features.length).fill(1);\r\n    }\r\n\r\n    return features.map((feature, i) =>\r\n      (feature - this.featureScaling.mean[i]) / Math.max(this.featureScaling.std[i], 0.01)\r\n    );\r\n  }\r\n\r\n  private calculateAdvancedConfidence(history: SupplierPerformance[], features: number[]): number {\r\n    const dataQuality = Math.min(1, history.length / 10);\r\n    const featureQuality = features.reduce((sum, f) => sum + (isNaN(f) ? 0 : 1), 0) / features.length;\r\n    const performanceConsistency = this.calculateConsistency(history);\r\n\r\n    return (dataQuality * 0.4) + (featureQuality * 0.3) + (performanceConsistency * 0.3);\r\n  }\r\n\r\n  private calculateUncertaintyBounds(prediction: number, confidence: number): { lower: number; upper: number } {\r\n    const uncertainty = (1 - confidence) * 0.3; // Max 30% uncertainty\r\n    return {\r\n      lower: Math.max(0, prediction - uncertainty),\r\n      upper: Math.min(1, prediction + uncertainty)\r\n    };\r\n  }\r\n\r\n  private generateExplanation(features: number[], prediction: number): string[] {\r\n    const explanations: string[] = [];\r\n\r\n    if (features[0] < 0.85) explanations.push(\"Delivery performance is below optimal levels\");\r\n    if (features[1] < 0.90) explanations.push(\"Quality issues detected in recent performance\");\r\n    if (features[2] < -0.1) explanations.push(\"Declining performance trend identified\");\r\n    if (features[3] > 0.3) explanations.push(\"High performance volatility observed\");\r\n    if (features[6] > 0.1) explanations.push(\"Recent improvement in performance metrics\");\r\n\r\n    if (explanations.length === 0) {\r\n      explanations.push(\"Performance metrics are within acceptable ranges\");\r\n    }\r\n\r\n    return explanations;\r\n  }\r\n\r\n  // Utility methods\r\n  private calculateAverage(values: number[]): number {\r\n    return values.length > 0 ? values.reduce((sum, val) => sum + val, 0) / values.length : 0;\r\n  }\r\n\r\n  private calculateTrend(values: number[]): number {\r\n    if (values.length < 2) return 0;\r\n    const n = values.length;\r\n    const sumX = (n * (n - 1)) / 2;\r\n    const sumY = values.reduce((sum, val) => sum + val, 0);\r\n    const sumXY = values.reduce((sum, val, idx) => sum + (idx * val), 0);\r\n    const sumX2 = (n * (n - 1) * (2 * n - 1)) / 6;\r\n    return (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX) || 0;\r\n  }\r\n\r\n  private calculateVolatility(values: number[]): number {\r\n    if (values.length < 2) return 0;\r\n    const mean = this.calculateAverage(values);\r\n    const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;\r\n    return Math.sqrt(variance) / mean;\r\n  }\r\n\r\n  private calculateSeasonality(history: SupplierPerformance[]): number {\r\n    // Simplified seasonality calculation\r\n    return 0; // Placeholder for more complex seasonality analysis\r\n  }\r\n\r\n  private calculateImprovement(recent: SupplierPerformance[], older: SupplierPerformance[]): number {\r\n    if (recent.length === 0 || older.length === 0) return 0;\r\n    const recentAvg = this.calculateAverage(recent.map(h => h.overallRating));\r\n    const olderAvg = this.calculateAverage(older.map(h => h.overallRating));\r\n    return (recentAvg - olderAvg) / Math.max(olderAvg, 0.1);\r\n  }\r\n\r\n  private calculateConsistency(history: SupplierPerformance[]): number {\r\n    if (history.length < 2) return 1;\r\n    const ratings = history.map(h => h.overallRating);\r\n    const volatility = this.calculateVolatility(ratings);\r\n    return Math.max(0, 1 - volatility);\r\n  }\r\n\r\n  private calculateRecentPerformance(recent: SupplierPerformance[]): number {\r\n    if (recent.length === 0) return 0.5;\r\n    return this.calculateAverage(recent.map(h => h.overallRating));\r\n  }\r\n\r\n  private calculateRiskIndicator(history: SupplierPerformance[]): number {\r\n    if (history.length === 0) return 0.5;\r\n    const latest = history[0];\r\n    let risk = 0;\r\n\r\n    if (latest.metrics.onTimeDeliveryRate < 85) risk += 0.3;\r\n    if (latest.metrics.qualityAcceptanceRate < 90) risk += 0.3;\r\n    if (latest.metrics.responseTime > 24) risk += 0.2;\r\n\r\n    return Math.min(1, risk);\r\n  }\r\n\r\n  private featuresToObject(features: number[]): Record<string, number> {\r\n    return {\r\n      deliveryRate: features[0],\r\n      qualityRate: features[1],\r\n      trend: features[2],\r\n      volatility: features[3],\r\n      seasonality: features[4],\r\n      responseTime: features[5],\r\n      improvement: features[6],\r\n      consistency: features[7],\r\n      recentPerformance: features[8],\r\n      riskIndicator: features[9]\r\n    };\r\n  }\r\n}\r\n\r\n// Time Series Forecasting with Advanced Algorithms\r\nexport class TimeSeriesForecaster {\r\n  private db: Pool;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n  }\r\n\r\n  async forecastDemand(\r\n    itemId: string,\r\n    horizon: number = 30\r\n  ): Promise<TimeSeriesForecast> {\r\n    try {\r\n      // Get historical demand data\r\n      const historicalData = await this.getHistoricalDemand(itemId);\r\n\r\n      if (historicalData.length < 14) {\r\n        throw new Error('Insufficient historical data for forecasting');\r\n      }\r\n\r\n      // Apply time series decomposition\r\n      const decomposed = this.decomposeTimeSeries(historicalData);\r\n\r\n      // Generate forecasts using multiple methods\r\n      const armaForecast = this.armaForecast(decomposed.trend, horizon);\r\n      const seasonalForecast = this.seasonalForecast(decomposed.seasonal, horizon);\r\n      const polynomialForecast = this.polynomialTrendForecast(historicalData, horizon);\r\n\r\n      // Combine forecasts\r\n      const predictions = this.combineForecastMethods(\r\n        armaForecast,\r\n        seasonalForecast,\r\n        polynomialForecast,\r\n        horizon\r\n      );\r\n\r\n      // Calculate accuracy metrics\r\n      const accuracy = this.calculateAccuracyMetrics(historicalData, predictions);\r\n\r\n      return {\r\n        itemId,\r\n        forecastHorizon: horizon,\r\n        predictions,\r\n        accuracy,\r\n        modelMetadata: {\r\n          algorithm: 'Ensemble Time Series (ARMA + Seasonal + Polynomial)',\r\n          trainingData: historicalData.length,\r\n          lastTraining: new Date(),\r\n          parameters: {\r\n            armaOrder: { p: 2, q: 2 },\r\n            seasonalPeriod: 7,\r\n            polynomialDegree: 3\r\n          }\r\n        }\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Time series forecasting error:', error);\r\n      throw new Error('Failed to generate demand forecast');\r\n    }\r\n  }\r\n\r\n  private async getHistoricalDemand(itemId: string): Promise<Array<{ date: Date; demand: number }>> {\r\n    const query = `\r\n      SELECT DATE(timestamp) as date, SUM(quantity) as demand\r\n      FROM stock_movements\r\n      WHERE item_id = $1 AND type = 'outbound'\r\n      AND timestamp >= NOW() - INTERVAL '6 months'\r\n      GROUP BY DATE(timestamp)\r\n      ORDER BY date ASC\r\n    `;\r\n\r\n    const result = await this.db.query(query, [itemId]);\r\n    return result.rows.map(row => ({\r\n      date: new Date(row.date),\r\n      demand: parseFloat(row.demand)\r\n    }));\r\n  }\r\n\r\n  private decomposeTimeSeries(data: Array<{ date: Date; demand: number }>) {\r\n    const values = data.map(d => d.demand);\r\n\r\n    // Simple moving average for trend\r\n    const trend = this.calculateMovingAverage(values, 7);\r\n\r\n    // Detrended series for seasonality\r\n    const detrended = values.map((val, i) => val - (trend[i] || trend[trend.length - 1]));\r\n\r\n    // Weekly seasonality\r\n    const seasonal = this.extractSeasonality(detrended, 7);\r\n\r\n    // Residual\r\n    const residual = values.map((val, i) =>\r\n      val - (trend[i] || 0) - (seasonal[i % 7] || 0)\r\n    );\r\n\r\n    return { trend, seasonal, residual };\r\n  }\r\n\r\n  private calculateMovingAverage(values: number[], window: number): number[] {\r\n    const result: number[] = [];\r\n    for (let i = 0; i < values.length; i++) {\r\n      const start = Math.max(0, i - Math.floor(window / 2));\r\n      const end = Math.min(values.length, i + Math.ceil(window / 2));\r\n      const slice = values.slice(start, end);\r\n      result.push(slice.reduce((sum, val) => sum + val, 0) / slice.length);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  private extractSeasonality(values: number[], period: number): number[] {\r\n    const seasonal: number[] = new Array(period).fill(0);\r\n    const counts: number[] = new Array(period).fill(0);\r\n\r\n    values.forEach((val, i) => {\r\n      const periodIndex = i % period;\r\n      seasonal[periodIndex] += val;\r\n      counts[periodIndex]++;\r\n    });\r\n\r\n    return seasonal.map((sum, i) => counts[i] > 0 ? sum / counts[i] : 0);\r\n  }\r\n\r\n  private armaForecast(trendData: number[], horizon: number): number[] {\r\n    // Simplified ARMA(2,2) model\r\n    const p = 2, q = 2;\r\n    const forecast: number[] = [];\r\n    const data = [...trendData];\r\n\r\n    for (let h = 0; h < horizon; h++) {\r\n      let prediction = 0;\r\n\r\n      // AR component\r\n      for (let i = 1; i <= p && data.length >= i; i++) {\r\n        prediction += 0.3 * data[data.length - i]; // Simplified AR coefficients\r\n      }\r\n\r\n      // MA component (simplified)\r\n      prediction += 0.1 * (Math.random() - 0.5); // Noise term\r\n\r\n      forecast.push(prediction);\r\n      data.push(prediction);\r\n    }\r\n\r\n    return forecast;\r\n  }\r\n\r\n  private seasonalForecast(seasonalPattern: number[], horizon: number): number[] {\r\n    const forecast: number[] = [];\r\n    for (let h = 0; h < horizon; h++) {\r\n      forecast.push(seasonalPattern[h % seasonalPattern.length]);\r\n    }\r\n    return forecast;\r\n  }\r\n\r\n  private polynomialTrendForecast(data: Array<{ date: Date; demand: number }>, horizon: number): number[] {\r\n    // Fit polynomial trend\r\n    const x = data.map((_, i) => i);\r\n    const y = data.map(d => d.demand);\r\n\r\n    // Simple linear trend (can be extended to higher order polynomials)\r\n    const n = x.length;\r\n    const sumX = x.reduce((sum, val) => sum + val, 0);\r\n    const sumY = y.reduce((sum, val) => sum + val, 0);\r\n    const sumXY = x.reduce((sum, val, i) => sum + val * y[i], 0);\r\n    const sumX2 = x.reduce((sum, val) => sum + val * val, 0);\r\n\r\n    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);\r\n    const intercept = (sumY - slope * sumX) / n;\r\n\r\n    // Generate forecasts\r\n    const forecast: number[] = [];\r\n    for (let h = 0; h < horizon; h++) {\r\n      const futureX = n + h;\r\n      forecast.push(slope * futureX + intercept);\r\n    }\r\n\r\n    return forecast;\r\n  }\r\n\r\n  private combineForecastMethods(\r\n    arma: number[],\r\n    seasonal: number[],\r\n    polynomial: number[],\r\n    horizon: number\r\n  ): Array<{\r\n    date: Date;\r\n    predicted: number;\r\n    lowerBound: number;\r\n    upperBound: number;\r\n    seasonalComponent: number;\r\n    trendComponent: number;\r\n  }> {\r\n    const predictions: Array<any> = [];\r\n    const today = new Date();\r\n\r\n    for (let h = 0; h < horizon; h++) {\r\n      const futureDate = new Date(today);\r\n      futureDate.setDate(today.getDate() + h + 1);\r\n\r\n      const trendComponent = polynomial[h] || 0;\r\n      const seasonalComponent = seasonal[h] || 0;\r\n      const armaComponent = arma[h] || 0;\r\n\r\n      // Weighted combination\r\n      const predicted = (trendComponent * 0.4) + (seasonalComponent * 0.3) + (armaComponent * 0.3);\r\n\r\n      // Uncertainty bounds (±20%)\r\n      const uncertainty = predicted * 0.2;\r\n\r\n      predictions.push({\r\n        date: futureDate,\r\n        predicted: Math.max(0, predicted),\r\n        lowerBound: Math.max(0, predicted - uncertainty),\r\n        upperBound: predicted + uncertainty,\r\n        seasonalComponent,\r\n        trendComponent\r\n      });\r\n    }\r\n\r\n    return predictions;\r\n  }\r\n\r\n  private calculateAccuracyMetrics(\r\n    historical: Array<{ date: Date; demand: number }>,\r\n    predictions: Array<{ predicted: number }>\r\n  ): { mape: number; rmse: number; mae: number } {\r\n    // Use last portion of historical data for validation\r\n    const validationSize = Math.min(7, Math.floor(historical.length * 0.2));\r\n    const validation = historical.slice(-validationSize);\r\n    const testPredictions = predictions.slice(0, validationSize);\r\n\r\n    if (validation.length === 0 || testPredictions.length === 0) {\r\n      return { mape: 0, rmse: 0, mae: 0 };\r\n    }\r\n\r\n    let mapeSum = 0, rmseSum = 0, maeSum = 0;\r\n\r\n    for (let i = 0; i < Math.min(validation.length, testPredictions.length); i++) {\r\n      const actual = validation[i].demand;\r\n      const predicted = testPredictions[i].predicted;\r\n\r\n      mapeSum += Math.abs((actual - predicted) / Math.max(actual, 1));\r\n      rmseSum += Math.pow(actual - predicted, 2);\r\n      maeSum += Math.abs(actual - predicted);\r\n    }\r\n\r\n    const n = Math.min(validation.length, testPredictions.length);\r\n\r\n    return {\r\n      mape: (mapeSum / n) * 100,\r\n      rmse: Math.sqrt(rmseSum / n),\r\n      mae: maeSum / n\r\n    };\r\n  }\r\n}\r\n\r\n// Ensemble Learning for Multiple Model Predictions\r\nexport class EnsemblePredictor {\r\n  private models: Array<{\r\n    name: string;\r\n    predictor: any;\r\n    weight: number;\r\n    performance: number;\r\n  }>;\r\n\r\n  constructor() {\r\n    this.models = [];\r\n  }\r\n\r\n  addModel(name: string, predictor: any, weight: number = 1.0) {\r\n    this.models.push({\r\n      name,\r\n      predictor,\r\n      weight,\r\n      performance: 0.5 // Initial performance\r\n    });\r\n  }\r\n\r\n  async predict(data: any): Promise<EnsemblePrediction> {\r\n    const predictions = [];\r\n\r\n    for (const model of this.models) {\r\n      try {\r\n        const prediction = await model.predictor.predict(data);\r\n        predictions.push({\r\n          name: model.name,\r\n          prediction: prediction.prediction || prediction,\r\n          weight: model.weight,\r\n          confidence: prediction.confidence || 0.8\r\n        });\r\n      } catch (error) {\r\n        console.error(`Model ${model.name} prediction failed:`, error);\r\n        predictions.push({\r\n          name: model.name,\r\n          prediction: 0.5,\r\n          weight: 0,\r\n          confidence: 0\r\n        });\r\n      }\r\n    }\r\n\r\n    // Calculate weighted average\r\n    const totalWeight = predictions.reduce((sum, p) => sum + p.weight * p.confidence, 0);\r\n    const finalPrediction = predictions.reduce(\r\n      (sum, p) => sum + (p.prediction * p.weight * p.confidence), 0\r\n    ) / Math.max(totalWeight, 0.1);\r\n\r\n    // Calculate consensus (agreement between models)\r\n    const predictionValues = predictions.map(p => p.prediction);\r\n    const mean = predictionValues.reduce((sum, val) => sum + val, 0) / predictionValues.length;\r\n    const variance = predictionValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / predictionValues.length;\r\n    const consensus = Math.max(0, 1 - Math.sqrt(variance));\r\n\r\n    return {\r\n      models: predictions,\r\n      finalPrediction,\r\n      consensus,\r\n      explanation: this.generateEnsembleExplanation(predictions, consensus)\r\n    };\r\n  }\r\n\r\n  private generateEnsembleExplanation(predictions: any[], consensus: number): string {\r\n    const topModel = predictions.reduce((best, current) =>\r\n      current.confidence > best.confidence ? current : best\r\n    );\r\n\r\n    if (consensus > 0.8) {\r\n      return `High model consensus (${(consensus * 100).toFixed(1)}%). All models agree on prediction.`;\r\n    } else if (consensus > 0.6) {\r\n      return `Moderate consensus. ${topModel.name} has highest confidence at ${(topModel.confidence * 100).toFixed(1)}%.`;\r\n    } else {\r\n      return `Low consensus between models. Prediction uncertainty is high.`;\r\n    }\r\n  }\r\n\r\n  updateModelPerformance(modelName: string, performance: number) {\r\n    const model = this.models.find(m => m.name === modelName);\r\n    if (model) {\r\n      model.performance = performance;\r\n      // Adjust weight based on performance\r\n      model.weight = Math.max(0.1, performance);\r\n    }\r\n  }\r\n}\r\n\r\n// Export all advanced ML models\r\nexport const advancedMLModels = {\r\n  supplierPredictor: (db: Pool) => new AdvancedSupplierPredictor(db),\r\n  timeSeriesForecaster: (db: Pool) => new TimeSeriesForecaster(db),\r\n  ensemblePredictor: () => new EnsemblePredictor(),\r\n  neuralNetwork: (layers: number[]) => new NeuralNetwork(layers)\r\n};\r\n\r\n// Export individual classes for direct import\r\nexport { AdvancedSupplierPredictor as AdvancedMLModels };","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\analytics-integration.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * Analytics Integration Service\r\n * Centralized orchestration of all analytics and optimization modules\r\n */\r\n\r\nimport { EventEmitter } from 'events';\r\nimport { AdvancedMLModels } from './advanced-ml-models';\r\nimport { QueryOptimizer, DatabasePerformanceMonitor } from './query-optimizer';\r\nimport { PredictiveAnalyticsService } from './predictive-analytics';\r\nimport { IntelligentRecommendationEngine } from './intelligent-recommendations';\r\nimport { RealTimeAnomalyDetectionEngine } from './real-time-anomaly-detection';\r\nimport { AutomatedWorkflowEngine } from './automated-optimization';\r\nimport { AIInsightsGenerator, SmartDashboardManager } from './enhanced-analytics-dashboard';\r\nimport { PerformanceManagementSystem } from './performance-monitor';\r\n\r\n/**\r\n * Unified Analytics Configuration\r\n */\r\nexport interface AnalyticsConfig {\r\n  organizationId: string;\r\n  features: {\r\n    predictiveAnalytics: boolean;\r\n    anomalyDetection: boolean;\r\n    recommendations: boolean;\r\n    automation: boolean;\r\n    performance: boolean;\r\n    aiInsights: boolean;\r\n  };\r\n  thresholds: {\r\n    anomaly: {\r\n      sensitivity: number; // 0.1 to 1.0\r\n      confidence: number;  // 0.7 to 0.99\r\n    };\r\n    performance: {\r\n      responseTime: number; // milliseconds\r\n      errorRate: number;    // 0.0 to 1.0\r\n      resourceUsage: number; // 0.0 to 1.0\r\n    };\r\n    recommendations: {\r\n      minConfidence: number; // 0.5 to 0.99\r\n      maxSuggestions: number; // 1 to 50\r\n    };\r\n  };\r\n  intervals: {\r\n    monitoring: number;    // milliseconds\r\n    optimization: number;  // milliseconds\r\n    reporting: number;     // milliseconds\r\n  };\r\n}\r\n\r\n/**\r\n * Unified Analytics Status\r\n */\r\nexport interface AnalyticsStatus {\r\n  organizationId: string;\r\n  status: 'initializing' | 'running' | 'error' | 'stopped';\r\n  modules: {\r\n    mlModels: boolean;\r\n    predictive: boolean;\r\n    anomaly: boolean;\r\n    recommendations: boolean;\r\n    automation: boolean;\r\n    performance: boolean;\r\n    dashboard: boolean;\r\n  };\r\n  lastUpdate: Date;\r\n  performance: {\r\n    responseTime: number;\r\n    errorRate: number;\r\n    uptime: number;\r\n  };\r\n  insights: {\r\n    totalGenerated: number;\r\n    highPriority: number;\r\n    actionable: number;\r\n  };\r\n}\r\n\r\n/**\r\n * Comprehensive Analytics Report\r\n */\r\nexport interface AnalyticsReport {\r\n  organizationId: string;\r\n  period: {\r\n    start: Date;\r\n    end: Date;\r\n  };\r\n  summary: {\r\n    totalPredictions: number;\r\n    anomaliesDetected: number;\r\n    recommendationsGenerated: number;\r\n    optimizationsExecuted: number;\r\n    performanceGains: number; // percentage\r\n    costSavings: number; // estimated dollars\r\n  };\r\n  insights: any[];\r\n  recommendations: any[];\r\n  performance: any;\r\n  trends: any[];\r\n  alerts: any[];\r\n}\r\n\r\n/**\r\n * Main Analytics Integration Service\r\n * Orchestrates all analytics modules and provides unified interface\r\n */\r\nexport class AnalyticsIntegrationService extends EventEmitter {\r\n  private config: AnalyticsConfig;\r\n  private status: AnalyticsStatus;\r\n  private isInitialized: boolean = false;\r\n\r\n  // Core Analytics Modules\r\n  private mlModels: AdvancedMLModels;\r\n  private queryOptimizer: QueryOptimizer;\r\n  private dbMonitor: DatabasePerformanceMonitor;\r\n  private predictiveService: PredictiveAnalyticsService;\r\n  private recommendationEngine: IntelligentRecommendationEngine;\r\n  private anomalyDetection: RealTimeAnomalyDetectionEngine;\r\n  private workflowEngine: AutomatedWorkflowEngine;\r\n  private insightsGenerator: AIInsightsGenerator;\r\n  private dashboardManager: SmartDashboardManager;\r\n  private performanceManager: PerformanceManagementSystem;\r\n\r\n  // Monitoring intervals\r\n  private monitoringInterval: NodeJS.Timeout | null = null;\r\n  private optimizationInterval: NodeJS.Timeout | null = null;\r\n  private reportingInterval: NodeJS.Timeout | null = null;\r\n\r\n  constructor(config: AnalyticsConfig) {\r\n    super();\r\n    this.config = config;\r\n    this.status = this.initializeStatus();\r\n    this.initializeModules();\r\n  }\r\n\r\n  /**\r\n   * Initialize analytics service\r\n   */\r\n  async initialize(): Promise<void> {\r\n    if (this.isInitialized) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.status.status = 'initializing';\r\n      this.emit('statusChanged', this.status);\r\n\r\n      // Initialize all modules\r\n      await this.initializeAllModules();\r\n\r\n      // Start monitoring and optimization loops\r\n      this.startMonitoringLoops();\r\n\r\n      this.status.status = 'running';\r\n      this.status.lastUpdate = new Date();\r\n      this.isInitialized = true;\r\n\r\n      this.emit('initialized', { organizationId: this.config.organizationId });\r\n      this.emit('statusChanged', this.status);\r\n\r\n    } catch (error) {\r\n      this.status.status = 'error';\r\n      this.emit('error', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get comprehensive analytics dashboard\r\n   */\r\n  async getAnalyticsDashboard(): Promise<any> {\r\n    if (!this.isInitialized) {\r\n      throw new Error('Analytics service not initialized');\r\n    }\r\n\r\n    const [\r\n      insights,\r\n      recommendations,\r\n      anomalies,\r\n      predictions,\r\n      performance,\r\n      optimization\r\n    ] = await Promise.all([\r\n      this.getAIInsights(),\r\n      this.getRecommendations(),\r\n      this.getAnomalies(),\r\n      this.getPredictions(),\r\n      this.getPerformanceMetrics(),\r\n      this.getOptimizationStatus()\r\n    ]);\r\n\r\n    const dashboard = {\r\n      organizationId: this.config.organizationId,\r\n      timestamp: new Date(),\r\n      status: this.status,\r\n      insights: insights.slice(0, 10), // Top 10 insights\r\n      recommendations: recommendations.slice(0, 8), // Top 8 recommendations\r\n      anomalies: anomalies.slice(0, 5), // Latest 5 anomalies\r\n      predictions: predictions,\r\n      performance: performance,\r\n      optimization: optimization,\r\n      summary: {\r\n        totalInsights: insights.length,\r\n        criticalAlerts: anomalies.filter(a => a.severity === 'high').length,\r\n        activeRecommendations: recommendations.filter(r => r.status === 'pending').length,\r\n        performanceScore: performance?.summary?.score || 0,\r\n        optimizationOpportunities: optimization?.opportunities || 0\r\n      }\r\n    };\r\n\r\n    return await this.dashboardManager.enhanceDashboard(dashboard);\r\n  }\r\n\r\n  /**\r\n   * Generate comprehensive analytics report\r\n   */\r\n  async generateAnalyticsReport(\r\n    startDate: Date,\r\n    endDate: Date = new Date()\r\n  ): Promise<AnalyticsReport> {\r\n    const period = { start: startDate, end: endDate };\r\n\r\n    const [\r\n      insights,\r\n      recommendations,\r\n      anomalies,\r\n      predictions,\r\n      performance,\r\n      optimizations\r\n    ] = await Promise.all([\r\n      this.getAIInsights(),\r\n      this.getRecommendations(),\r\n      this.getAnomalies(),\r\n      this.getPredictions(),\r\n      this.getPerformanceMetrics(),\r\n      this.getOptimizationHistory()\r\n    ]);\r\n\r\n    // Calculate summary metrics\r\n    const summary = {\r\n      totalPredictions: predictions?.length || 0,\r\n      anomaliesDetected: anomalies?.length || 0,\r\n      recommendationsGenerated: recommendations?.length || 0,\r\n      optimizationsExecuted: optimizations?.completed || 0,\r\n      performanceGains: this.calculatePerformanceGains(performance),\r\n      costSavings: this.estimateCostSavings(recommendations, optimizations)\r\n    };\r\n\r\n    return {\r\n      organizationId: this.config.organizationId,\r\n      period,\r\n      summary,\r\n      insights: insights || [],\r\n      recommendations: recommendations || [],\r\n      performance: performance || {},\r\n      trends: await this.getTrends(startDate, endDate),\r\n      alerts: anomalies?.filter(a => a.severity === 'high') || []\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Execute optimization workflow\r\n   */\r\n  async executeOptimization(type: string, params: any = {}): Promise<any> {\r\n    try {\r\n      let result;\r\n\r\n      switch (type) {\r\n        case 'inventory':\r\n          result = await this.workflowEngine.executeWorkflow('inventory_optimization', {\r\n            organizationId: this.config.organizationId,\r\n            ...params\r\n          });\r\n          break;\r\n\r\n        case 'supplier':\r\n          result = await this.workflowEngine.executeWorkflow('supplier_optimization', {\r\n            organizationId: this.config.organizationId,\r\n            ...params\r\n          });\r\n          break;\r\n\r\n        case 'performance':\r\n          result = await this.performanceManager.getOptimizer()\r\n            .generateOptimizationRecommendations(this.config.organizationId);\r\n          break;\r\n\r\n        case 'query':\r\n          result = await this.queryOptimizer.optimizeQueriesForOrganization(\r\n            this.config.organizationId\r\n          );\r\n          break;\r\n\r\n        default:\r\n          throw new Error(`Unknown optimization type: ${type}`);\r\n      }\r\n\r\n      this.emit('optimizationExecuted', { type, result });\r\n      return result;\r\n\r\n    } catch (error) {\r\n      this.emit('optimizationError', { type, error });\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get AI-generated insights\r\n   */\r\n  async getAIInsights(limit: number = 20): Promise<any[]> {\r\n    if (!this.config.features.aiInsights) {\r\n      return [];\r\n    }\r\n\r\n    return await this.insightsGenerator.generateInsights(\r\n      this.config.organizationId,\r\n      { limit }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get intelligent recommendations\r\n   */\r\n  async getRecommendations(type?: string, limit: number = 15): Promise<any[]> {\r\n    if (!this.config.features.recommendations) {\r\n      return [];\r\n    }\r\n\r\n    const recommendations = await this.recommendationEngine.generateRecommendations(\r\n      this.config.organizationId,\r\n      type || 'all'\r\n    );\r\n\r\n    return recommendations.slice(0, limit);\r\n  }\r\n\r\n  /**\r\n   * Get anomaly detection results\r\n   */\r\n  async getAnomalies(limit: number = 10): Promise<any[]> {\r\n    if (!this.config.features.anomalyDetection) {\r\n      return [];\r\n    }\r\n\r\n    return await this.anomalyDetection.getRecentAnomalies(\r\n      this.config.organizationId,\r\n      limit\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get predictive analytics results\r\n   */\r\n  async getPredictions(): Promise<any> {\r\n    if (!this.config.features.predictiveAnalytics) {\r\n      return null;\r\n    }\r\n\r\n    const [demandForecasts, supplierRisk, marketIntel] = await Promise.all([\r\n      this.predictiveService.predict('demand_forecast', this.config.organizationId, 'organization'),\r\n      this.predictiveService.predict('supplier_risk', this.config.organizationId, 'organization'),\r\n      this.predictiveService.generateMarketIntelligence(this.config.organizationId)\r\n    ]);\r\n\r\n    return {\r\n      demandForecasts,\r\n      supplierRisk,\r\n      marketIntelligence: marketIntel\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get performance metrics\r\n   */\r\n  async getPerformanceMetrics(): Promise<any> {\r\n    if (!this.config.features.performance) {\r\n      return null;\r\n    }\r\n\r\n    return await this.performanceManager.getPerformanceDashboard(\r\n      this.config.organizationId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get optimization status\r\n   */\r\n  async getOptimizationStatus(): Promise<any> {\r\n    if (!this.config.features.automation) {\r\n      return null;\r\n    }\r\n\r\n    const workflows = await this.workflowEngine.getActiveWorkflows(\r\n      this.config.organizationId\r\n    );\r\n\r\n    return {\r\n      activeWorkflows: workflows?.length || 0,\r\n      opportunities: workflows?.filter(w => w.status === 'pending')?.length || 0,\r\n      completedToday: workflows?.filter(w =>\r\n        w.status === 'completed' &&\r\n        new Date(w.lastExecution).toDateString() === new Date().toDateString()\r\n      )?.length || 0\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get optimization history\r\n   */\r\n  async getOptimizationHistory(): Promise<any> {\r\n    const workflows = await this.workflowEngine.getWorkflowHistory(\r\n      this.config.organizationId\r\n    );\r\n\r\n    return {\r\n      total: workflows?.length || 0,\r\n      completed: workflows?.filter(w => w.status === 'completed')?.length || 0,\r\n      failed: workflows?.filter(w => w.status === 'failed')?.length || 0\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get trends analysis\r\n   */\r\n  async getTrends(startDate: Date, endDate: Date): Promise<any[]> {\r\n    const trends = await this.performanceManager.getMonitor()\r\n      .getPerformanceTrends(this.config.organizationId, '7d');\r\n\r\n    return trends || [];\r\n  }\r\n\r\n  /**\r\n   * Update configuration\r\n   */\r\n  async updateConfig(newConfig: Partial<AnalyticsConfig>): Promise<void> {\r\n    this.config = { ...this.config, ...newConfig };\r\n\r\n    // Restart modules if necessary\r\n    if (this.isInitialized) {\r\n      await this.reinitializeModules();\r\n    }\r\n\r\n    this.emit('configUpdated', this.config);\r\n  }\r\n\r\n  /**\r\n   * Get current status\r\n   */\r\n  getStatus(): AnalyticsStatus {\r\n    return { ...this.status };\r\n  }\r\n\r\n  /**\r\n   * Shutdown service\r\n   */\r\n  async shutdown(): Promise<void> {\r\n    this.stopMonitoringLoops();\r\n\r\n    if (this.config.features.anomalyDetection) {\r\n      this.anomalyDetection.stopMonitoring();\r\n    }\r\n\r\n    if (this.config.features.performance) {\r\n      this.performanceManager.shutdown();\r\n    }\r\n\r\n    this.status.status = 'stopped';\r\n    this.isInitialized = false;\r\n\r\n    this.emit('shutdown', { organizationId: this.config.organizationId });\r\n  }\r\n\r\n  // Private methods\r\n\r\n  private initializeStatus(): AnalyticsStatus {\r\n    return {\r\n      organizationId: this.config.organizationId,\r\n      status: 'stopped',\r\n      modules: {\r\n        mlModels: false,\r\n        predictive: false,\r\n        anomaly: false,\r\n        recommendations: false,\r\n        automation: false,\r\n        performance: false,\r\n        dashboard: false\r\n      },\r\n      lastUpdate: new Date(),\r\n      performance: {\r\n        responseTime: 0,\r\n        errorRate: 0,\r\n        uptime: 0\r\n      },\r\n      insights: {\r\n        totalGenerated: 0,\r\n        highPriority: 0,\r\n        actionable: 0\r\n      }\r\n    };\r\n  }\r\n\r\n  private initializeModules(): void {\r\n    this.mlModels = new AdvancedMLModels();\r\n    this.queryOptimizer = new QueryOptimizer(null as any); // Mock DB connection\r\n    this.dbMonitor = new DatabasePerformanceMonitor(null as any);\r\n    this.predictiveService = new PredictiveAnalyticsService();\r\n    this.recommendationEngine = new IntelligentRecommendationEngine();\r\n    this.anomalyDetection = new RealTimeAnomalyDetectionEngine();\r\n    this.workflowEngine = new AutomatedWorkflowEngine();\r\n    this.insightsGenerator = new AIInsightsGenerator();\r\n    this.dashboardManager = new SmartDashboardManager();\r\n    this.performanceManager = new PerformanceManagementSystem();\r\n  }\r\n\r\n  private async initializeAllModules(): Promise<void> {\r\n    const initPromises: Promise<void>[] = [];\r\n\r\n    if (this.config.features.anomalyDetection) {\r\n      initPromises.push(\r\n        this.anomalyDetection.startMonitoring(this.config.organizationId)\r\n          .then(() => { this.status.modules.anomaly = true; })\r\n      );\r\n    }\r\n\r\n    if (this.config.features.automation) {\r\n      initPromises.push(\r\n        this.workflowEngine.initializeWorkflows(this.config.organizationId)\r\n          .then(() => { this.status.modules.automation = true; })\r\n      );\r\n    }\r\n\r\n    if (this.config.features.performance) {\r\n      initPromises.push(\r\n        this.performanceManager.initialize(this.config.organizationId)\r\n          .then(() => { this.status.modules.performance = true; })\r\n      );\r\n    }\r\n\r\n    // Mark other modules as initialized\r\n    this.status.modules.mlModels = true;\r\n    this.status.modules.predictive = this.config.features.predictiveAnalytics;\r\n    this.status.modules.recommendations = this.config.features.recommendations;\r\n    this.status.modules.dashboard = this.config.features.aiInsights;\r\n\r\n    await Promise.all(initPromises);\r\n  }\r\n\r\n  private async reinitializeModules(): Promise<void> {\r\n    await this.shutdown();\r\n    await this.initialize();\r\n  }\r\n\r\n  private startMonitoringLoops(): void {\r\n    // Main monitoring loop\r\n    this.monitoringInterval = setInterval(async () => {\r\n      try {\r\n        await this.updateMetrics();\r\n      } catch (error) {\r\n        console.error('Monitoring loop error:', error);\r\n      }\r\n    }, this.config.intervals.monitoring);\r\n\r\n    // Optimization loop\r\n    this.optimizationInterval = setInterval(async () => {\r\n      try {\r\n        await this.runAutomaticOptimizations();\r\n      } catch (error) {\r\n        console.error('Optimization loop error:', error);\r\n      }\r\n    }, this.config.intervals.optimization);\r\n\r\n    // Reporting loop\r\n    this.reportingInterval = setInterval(async () => {\r\n      try {\r\n        await this.generatePeriodicReports();\r\n      } catch (error) {\r\n        console.error('Reporting loop error:', error);\r\n      }\r\n    }, this.config.intervals.reporting);\r\n  }\r\n\r\n  private stopMonitoringLoops(): void {\r\n    if (this.monitoringInterval) {\r\n      clearInterval(this.monitoringInterval);\r\n      this.monitoringInterval = null;\r\n    }\r\n\r\n    if (this.optimizationInterval) {\r\n      clearInterval(this.optimizationInterval);\r\n      this.optimizationInterval = null;\r\n    }\r\n\r\n    if (this.reportingInterval) {\r\n      clearInterval(this.reportingInterval);\r\n      this.reportingInterval = null;\r\n    }\r\n  }\r\n\r\n  private async updateMetrics(): Promise<void> {\r\n    this.status.lastUpdate = new Date();\r\n    this.emit('metricsUpdated', this.status);\r\n  }\r\n\r\n  private async runAutomaticOptimizations(): Promise<void> {\r\n    if (!this.config.features.automation) {\r\n      return;\r\n    }\r\n\r\n    // Execute pending automated workflows\r\n    const activeWorkflows = await this.workflowEngine.getActiveWorkflows(\r\n      this.config.organizationId\r\n    );\r\n\r\n    for (const workflow of activeWorkflows || []) {\r\n      if (workflow.status === 'pending' && workflow.automated) {\r\n        try {\r\n          await this.workflowEngine.executeWorkflow(workflow.id);\r\n        } catch (error) {\r\n          console.error(`Workflow execution error for ${workflow.id}:`, error);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private async generatePeriodicReports(): Promise<void> {\r\n    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\r\n    const report = await this.generateAnalyticsReport(oneWeekAgo);\r\n\r\n    this.emit('reportGenerated', report);\r\n  }\r\n\r\n  private calculatePerformanceGains(performance: any): number {\r\n    if (!performance?.summary?.score) {\r\n      return 0;\r\n    }\r\n\r\n    // Calculate based on performance score improvement\r\n    const currentScore = performance.summary.score;\r\n    const baselineScore = 70; // Assumed baseline\r\n    return Math.max(0, ((currentScore - baselineScore) / baselineScore) * 100);\r\n  }\r\n\r\n  private estimateCostSavings(recommendations: any[], optimizations: any): number {\r\n    if (!recommendations?.length) {\r\n      return 0;\r\n    }\r\n\r\n    // Estimate cost savings based on implemented recommendations\r\n    return recommendations.reduce((total, rec) => {\r\n      const avgProjectCost = 50000; // $50k average project cost\r\n      const savingsRate = rec.confidence || 0.1;\r\n      return total + (avgProjectCost * savingsRate * 0.15); // 15% cost reduction\r\n    }, 0);\r\n  }\r\n}\r\n\r\n/**\r\n * Factory function to create analytics service with default configuration\r\n */\r\nexport function createAnalyticsService(\r\n  organizationId: string,\r\n  overrides: Partial<AnalyticsConfig> = {}\r\n): AnalyticsIntegrationService {\r\n  const defaultConfig: AnalyticsConfig = {\r\n    organizationId,\r\n    features: {\r\n      predictiveAnalytics: true,\r\n      anomalyDetection: true,\r\n      recommendations: true,\r\n      automation: true,\r\n      performance: true,\r\n      aiInsights: true\r\n    },\r\n    thresholds: {\r\n      anomaly: {\r\n        sensitivity: 0.8,\r\n        confidence: 0.85\r\n      },\r\n      performance: {\r\n        responseTime: 1000,\r\n        errorRate: 0.02,\r\n        resourceUsage: 0.8\r\n      },\r\n      recommendations: {\r\n        minConfidence: 0.7,\r\n        maxSuggestions: 20\r\n      }\r\n    },\r\n    intervals: {\r\n      monitoring: 30000,   // 30 seconds\r\n      optimization: 300000, // 5 minutes\r\n      reporting: 3600000   // 1 hour\r\n    }\r\n  };\r\n\r\n  const config = { ...defaultConfig, ...overrides };\r\n  return new AnalyticsIntegrationService(config);\r\n}\r\n\r\n// Export analytics integration service instance - already exported above","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\analytics-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":117,"column":32,"nodeType":"TemplateLiteral","endLine":123,"endColumn":8},{"ruleId":"no-undef","severity":2,"message":"'query' is not defined.","line":511,"column":28,"nodeType":"Identifier","messageId":"undef","endLine":511,"endColumn":33}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Analytics Service for MantisNXT Platform\r\nimport { Pool } from 'pg';\r\nimport {\r\n  mlModels,\r\n  SupplierRiskScore,\r\n  DemandForecast,\r\n  PriceOptimization,\r\n  InventoryOptimization,\r\n  MLPrediction\r\n} from './ml-models';\r\nimport { SupplierPerformance, InventoryItem, StockMovement } from '@/types';\r\n\r\n// Analytics Configuration\r\ninterface AnalyticsConfig {\r\n  updateInterval: number; // minutes\r\n  retentionPeriod: number; // days\r\n  confidenceThreshold: number; // 0-1\r\n  enableRealTimeProcessing: boolean;\r\n  maxConcurrentMLOperations: number; // NEW: Control parallel ML processing\r\n}\r\n\r\nconst defaultConfig: AnalyticsConfig = {\r\n  updateInterval: 15,\r\n  retentionPeriod: 365,\r\n  confidenceThreshold: 0.7,\r\n  enableRealTimeProcessing: true,\r\n  maxConcurrentMLOperations: 5 // Process up to 5 suppliers in parallel\r\n};\r\n\r\n// Real-time Analytics Metrics\r\nexport interface RealTimeMetrics {\r\n  suppliersAnalyzed: number;\r\n  inventoryItemsProcessed: number;\r\n  anomaliesDetected: number;\r\n  predictionsGenerated: number;\r\n  optimizationsCompleted: number;\r\n  lastUpdate: Date;\r\n  processingTime: number; // milliseconds\r\n}\r\n\r\n// Business Intelligence Insights\r\nexport interface BusinessInsights {\r\n  totalSupplierRisk: number;\r\n  inventoryOptimizationOpportunities: number;\r\n  demandForecastAccuracy: number;\r\n  priceOptimizationPotential: number;\r\n  anomaliesRequiringAttention: number;\r\n  recommendedActions: Array<{\r\n    type: 'supplier' | 'inventory' | 'pricing' | 'procurement';\r\n    priority: 'low' | 'medium' | 'high' | 'critical';\r\n    action: string;\r\n    potentialImpact: string;\r\n    timeframe: string;\r\n  }>;\r\n}\r\n\r\n// HELPER: Concurrency limiter for parallel ML operations\r\nclass ConcurrencyLimiter {\r\n  private running = 0;\r\n  private queue: Array<() => Promise<void>> = [];\r\n\r\n  constructor(private maxConcurrent: number) {}\r\n\r\n  async run<T>(fn: () => Promise<T>): Promise<T> {\r\n    while (this.running >= this.maxConcurrent) {\r\n      await new Promise(resolve => {\r\n        this.queue.push(resolve as any);\r\n      });\r\n    }\r\n\r\n    this.running++;\r\n    try {\r\n      return await fn();\r\n    } finally {\r\n      this.running--;\r\n      const next = this.queue.shift();\r\n      if (next) next();\r\n    }\r\n  }\r\n}\r\n\r\nexport class AnalyticsService {\r\n  private db: Pool;\r\n  private config: AnalyticsConfig;\r\n  private lastUpdate: Date = new Date();\r\n  private processingLock = false;\r\n  private concurrencyLimiter: ConcurrencyLimiter;\r\n\r\n  constructor(database: Pool, config: AnalyticsConfig = defaultConfig) {\r\n    this.db = database;\r\n    this.config = config;\r\n    this.concurrencyLimiter = new ConcurrencyLimiter(config.maxConcurrentMLOperations);\r\n  }\r\n\r\n  // OPTIMIZED: Supplier Performance Analytics with Parallel Processing (40-60% faster)\r\n  async analyzeSupplierPerformance(\r\n    supplierId?: string,\r\n    organizationId?: string\r\n  ): Promise<{\r\n    predictions: MLPrediction[];\r\n    riskScores: SupplierRiskScore[];\r\n    recommendations: string[];\r\n  }> {\r\n    try {\r\n      // Get supplier data\r\n      const suppliersQuery = supplierId\r\n        ? 'SELECT * FROM public.suppliers WHERE id = $1'\r\n        : 'SELECT * FROM public.suppliers WHERE organization_id = $1';\r\n\r\n      const suppliersResult = await this.db.query(\r\n        suppliersQuery,\r\n        [supplierId || organizationId]\r\n      );\r\n\r\n      // Get performance history\r\n      const performanceQuery = `\r\n        SELECT sp.*, s.name as supplier_name\r\n        FROM supplier_performance sp\r\n        JOIN suppliers s ON sp.supplier_id = s.id\r\n        WHERE ${supplierId ? 'sp.supplier_id = $1' : 's.organization_id = $1'}\r\n        ORDER BY sp.evaluation_date DESC\r\n      `;\r\n\r\n      const performanceResult = await this.db.query(\r\n        performanceQuery,\r\n        [supplierId || organizationId]\r\n      );\r\n\r\n      const predictions: MLPrediction[] = [];\r\n      const riskScores: SupplierRiskScore[] = [];\r\n      const recommendations: string[] = [];\r\n\r\n      // OPTIMIZED: Process suppliers in parallel with concurrency limit\r\n      await Promise.all(\r\n        suppliersResult.rows.map(supplier =>\r\n          this.concurrencyLimiter.run(async () => {\r\n            const supplierPerformance = performanceResult.rows.filter(\r\n              p => p.supplier_id === supplier.id\r\n            );\r\n\r\n            if (supplierPerformance.length > 0) {\r\n              // Generate performance prediction\r\n              const prediction = mlModels.supplierPredictor.predictPerformance(\r\n                supplier.id,\r\n                supplierPerformance,\r\n                supplierPerformance[0] // Most recent metrics\r\n              );\r\n\r\n              predictions.push(prediction);\r\n\r\n              // Calculate risk score\r\n              const riskScore = this.calculateSupplierRiskScore(\r\n                supplier.id,\r\n                supplierPerformance,\r\n                prediction\r\n              );\r\n\r\n              riskScores.push(riskScore);\r\n\r\n              // Generate recommendations\r\n              const supplierRecommendations = this.generateSupplierRecommendations(\r\n                supplier,\r\n                riskScore,\r\n                prediction\r\n              );\r\n\r\n              recommendations.push(...supplierRecommendations);\r\n            }\r\n          })\r\n        )\r\n      );\r\n\r\n      // Store results in analytics cache\r\n      await this.cacheAnalyticsResults('supplier_performance', {\r\n        predictions,\r\n        riskScores,\r\n        recommendations,\r\n        timestamp: new Date()\r\n      });\r\n\r\n      return { predictions, riskScores, recommendations };\r\n\r\n    } catch (error) {\r\n      console.error('Error analyzing supplier performance:', error);\r\n      throw new Error('Failed to analyze supplier performance');\r\n    }\r\n  }\r\n\r\n  // OPTIMIZED: Inventory Demand Forecasting with Parallel Processing\r\n  async forecastInventoryDemand(\r\n    itemId?: string,\r\n    organizationId?: string\r\n  ): Promise<DemandForecast[]> {\r\n    try {\r\n      // Get inventory items\r\n      const itemsQuery = itemId\r\n        ? 'SELECT * FROM public.inventory_items WHERE id = $1'\r\n        : 'SELECT * FROM public.inventory_items WHERE organization_id = $1';\r\n\r\n      const itemsResult = await this.db.query(itemsQuery, [itemId || organizationId]);\r\n\r\n      // Get stock movements for demand analysis\r\n      const movementsQuery = `\r\n        SELECT sm.*, ii.sku\r\n        FROM stock_movements sm\r\n        JOIN inventory_items ii ON sm.item_id = ii.id\r\n        WHERE ${itemId ? 'sm.item_id = $1' : 'ii.organization_id = $1'}\r\n        AND sm.timestamp >= NOW() - INTERVAL '6 months'\r\n        ORDER BY sm.timestamp DESC\r\n      `;\r\n\r\n      const movementsResult = await this.db.query(movementsQuery, [itemId || organizationId]);\r\n\r\n      const forecasts: DemandForecast[] = [];\r\n\r\n      // OPTIMIZED: Process items in parallel\r\n      await Promise.all(\r\n        itemsResult.rows.map(item =>\r\n          this.concurrencyLimiter.run(async () => {\r\n            const itemMovements = movementsResult.rows.filter(m => m.item_id === item.id);\r\n\r\n            if (itemMovements.length > 0) {\r\n              const forecast = mlModels.demandForecaster.predictDemand(\r\n                item.id,\r\n                itemMovements\r\n              );\r\n\r\n              forecast.sku = item.sku;\r\n              forecasts.push(forecast);\r\n            }\r\n          })\r\n        )\r\n      );\r\n\r\n      // Store forecasts in database\r\n      await this.storeDemandForecasts(forecasts);\r\n\r\n      return forecasts;\r\n\r\n    } catch (error) {\r\n      console.error('Error forecasting inventory demand:', error);\r\n      throw new Error('Failed to forecast inventory demand');\r\n    }\r\n  }\r\n\r\n  // OPTIMIZED: Price Optimization Analysis with Parallel Processing\r\n  async optimizePricing(\r\n    itemId?: string,\r\n    organizationId?: string\r\n  ): Promise<PriceOptimization[]> {\r\n    try {\r\n      // Get inventory items with supplier pricing\r\n      const itemsQuery = `\r\n        SELECT ii.*, spl.unit_price as supplier_price\r\n        FROM public.inventory_items ii\r\n        LEFT JOIN supplier_price_lists spl ON ii.sku = spl.sku\r\n        WHERE ${itemId ? 'ii.id = $1' : 'ii.organization_id = $1'}\r\n      `;\r\n\r\n      const itemsResult = await this.db.query(itemsQuery, [itemId || organizationId]);\r\n\r\n      // Get competitor pricing data (mock for now)\r\n      const competitorPricesQuery = `\r\n        SELECT item_sku, competitor_price\r\n        FROM competitor_pricing\r\n        WHERE item_sku IN (${itemsResult.rows.map(r => `'${r.sku}'`).join(',')})\r\n      `;\r\n\r\n      let competitorPrices: Record<string, number[]> = {};\r\n      try {\r\n        const competitorResult = await this.db.query(competitorPricesQuery);\r\n        competitorPrices = competitorResult.rows.reduce((acc, row) => {\r\n          if (!acc[row.item_sku]) acc[row.item_sku] = [];\r\n          acc[row.item_sku].push(row.competitor_price);\r\n          return acc;\r\n        }, {});\r\n      } catch {\r\n        // Competitor pricing table might not exist\r\n      }\r\n\r\n      const optimizations: PriceOptimization[] = [];\r\n\r\n      // OPTIMIZED: Process items in parallel\r\n      await Promise.all(\r\n        itemsResult.rows.map(item =>\r\n          this.concurrencyLimiter.run(async () => {\r\n            const competitorPriceList = competitorPrices[item.sku] || [];\r\n\r\n            const optimization = mlModels.priceOptimizer.optimizePrice(\r\n              item,\r\n              -1.5, // Default demand elasticity\r\n              competitorPriceList,\r\n              0.3 // Target 30% margin\r\n            );\r\n\r\n            optimizations.push(optimization);\r\n          })\r\n        )\r\n      );\r\n\r\n      // Store optimization results\r\n      await this.storePriceOptimizations(optimizations);\r\n\r\n      return optimizations;\r\n\r\n    } catch (error) {\r\n      console.error('Error optimizing pricing:', error);\r\n      throw new Error('Failed to optimize pricing');\r\n    }\r\n  }\r\n\r\n  // Anomaly Detection\r\n  async detectAnomalies(organizationId: string): Promise<{\r\n    supplierAnomalies: any[];\r\n    inventoryAnomalies: any[];\r\n    systemAnomalies: any[];\r\n  }> {\r\n    try {\r\n      // Get recent supplier performance data\r\n      const suppliersQuery = `\r\n        SELECT s.*, sp.on_time_delivery_rate, sp.quality_acceptance_rate, sp.response_time_hours\r\n        FROM public.suppliers s\r\n        LEFT JOIN supplier_performance sp ON s.id = sp.supplier_id\r\n        WHERE s.organization_id = $1\r\n        AND (sp.evaluation_date IS NULL OR sp.evaluation_date >= NOW() - INTERVAL '30 days')\r\n      `;\r\n\r\n      const suppliersResult = await this.db.query(suppliersQuery, [organizationId]);\r\n\r\n      // Get inventory items and recent movements\r\n      const inventoryQuery = `\r\n        SELECT ii.*, sm.quantity, sm.timestamp, sm.type as movement_type\r\n        FROM public.inventory_items ii\r\n        LEFT JOIN stock_movements sm ON ii.id = sm.item_id\r\n        WHERE ii.organization_id = $1\r\n        AND (sm.timestamp IS NULL OR sm.timestamp >= NOW() - INTERVAL '7 days')\r\n      `;\r\n\r\n      const inventoryResult = await this.db.query(inventoryQuery, [organizationId]);\r\n\r\n      // Detect supplier anomalies\r\n      const supplierAnomalies = mlModels.anomalyDetector.detectSupplierAnomalies(\r\n        suppliersResult.rows,\r\n        suppliersResult.rows\r\n      );\r\n\r\n      // Detect inventory anomalies\r\n      const inventoryAnomalies = mlModels.anomalyDetector.detectInventoryAnomalies(\r\n        inventoryResult.rows,\r\n        inventoryResult.rows\r\n      );\r\n\r\n      // Detect system-level anomalies\r\n      const systemAnomalies = await this.detectSystemAnomalies(organizationId);\r\n\r\n      // Store anomaly results\r\n      await this.storeAnomalies([...supplierAnomalies, ...inventoryAnomalies, ...systemAnomalies]);\r\n\r\n      return {\r\n        supplierAnomalies,\r\n        inventoryAnomalies,\r\n        systemAnomalies\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error detecting anomalies:', error);\r\n      throw new Error('Failed to detect anomalies');\r\n    }\r\n  }\r\n\r\n  // Real-time Analytics Dashboard\r\n  async getRealTimeMetrics(organizationId: string): Promise<RealTimeMetrics> {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      // Get counts from various analytics\r\n      const [\r\n        suppliersCount,\r\n        inventoryCount,\r\n        anomaliesCount,\r\n        predictionsCount,\r\n        optimizationsCount\r\n      ] = await Promise.all([\r\n        this.db.query('SELECT COUNT(*) FROM public.suppliers WHERE organization_id = $1', [organizationId]),\r\n        this.db.query('SELECT COUNT(*) FROM public.inventory_items WHERE organization_id = $1', [organizationId]),\r\n        this.db.query('SELECT COUNT(*) FROM analytics_anomalies WHERE organization_id = $1 AND detected_at >= NOW() - INTERVAL \\'24 hours\\'', [organizationId]),\r\n        this.db.query('SELECT COUNT(*) FROM analytics_predictions WHERE organization_id = $1 AND created_at >= NOW() - INTERVAL \\'24 hours\\'', [organizationId]),\r\n        this.db.query('SELECT COUNT(*) FROM analytics_optimizations WHERE organization_id = $1 AND created_at >= NOW() - INTERVAL \\'24 hours\\'', [organizationId])\r\n      ]);\r\n\r\n      const processingTime = Date.now() - startTime;\r\n\r\n      return {\r\n        suppliersAnalyzed: parseInt(suppliersCount.rows[0].count),\r\n        inventoryItemsProcessed: parseInt(inventoryCount.rows[0].count),\r\n        anomaliesDetected: parseInt(anomaliesCount.rows[0].count),\r\n        predictionsGenerated: parseInt(predictionsCount.rows[0].count),\r\n        optimizationsCompleted: parseInt(optimizationsCount.rows[0].count),\r\n        lastUpdate: new Date(),\r\n        processingTime\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error getting real-time metrics:', error);\r\n      throw new Error('Failed to get real-time metrics');\r\n    }\r\n  }\r\n\r\n  // Business Intelligence Insights\r\n  async getBusinessInsights(organizationId: string): Promise<BusinessInsights> {\r\n    try {\r\n      // Calculate key metrics in parallel\r\n      const [riskScores, optimizations, anomalies] = await Promise.all([\r\n        this.analyzeSupplierPerformance(undefined, organizationId),\r\n        this.optimizePricing(undefined, organizationId),\r\n        this.detectAnomalies(organizationId)\r\n      ]);\r\n\r\n      const totalSupplierRisk = riskScores.riskScores.reduce((sum, score) => sum + score.riskScore, 0) / riskScores.riskScores.length;\r\n\r\n      const inventoryOptimizationOpportunities = optimizations.filter(\r\n        opt => Math.abs(opt.expectedProfitIncrease) > 0.05\r\n      ).length;\r\n\r\n      const anomaliesRequiringAttention = [\r\n        ...anomalies.supplierAnomalies,\r\n        ...anomalies.inventoryAnomalies,\r\n        ...anomalies.systemAnomalies\r\n      ].filter(a => a.severity === 'high' || a.severity === 'critical').length;\r\n\r\n      // Generate recommended actions\r\n      const recommendedActions = this.generateBusinessRecommendations(\r\n        riskScores,\r\n        optimizations,\r\n        anomalies\r\n      );\r\n\r\n      return {\r\n        totalSupplierRisk: totalSupplierRisk || 0,\r\n        inventoryOptimizationOpportunities,\r\n        demandForecastAccuracy: 0.85, // Will be calculated from historical accuracy\r\n        priceOptimizationPotential: optimizations.reduce((sum, opt) => sum + opt.expectedProfitIncrease, 0),\r\n        anomaliesRequiringAttention,\r\n        recommendedActions\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error generating business insights:', error);\r\n      throw new Error('Failed to generate business insights');\r\n    }\r\n  }\r\n\r\n  // Helper Methods\r\n  private calculateSupplierRiskScore(\r\n    supplierId: string,\r\n    performance: any[],\r\n    prediction: MLPrediction\r\n  ): SupplierRiskScore {\r\n    const latestPerformance = performance[0];\r\n\r\n    const riskFactors = {\r\n      deliveryReliability: Math.max(0, 100 - (latestPerformance?.on_time_delivery_rate || 100)),\r\n      qualityIssues: Math.max(0, 100 - (latestPerformance?.quality_acceptance_rate || 100)),\r\n      financialStability: Math.random() * 30, // Mock financial stability score\r\n      communicationResponse: Math.max(0, (latestPerformance?.response_time_hours || 0) - 24),\r\n      priceVolatility: Math.random() * 20 // Mock price volatility\r\n    };\r\n\r\n    const riskScore = Object.values(riskFactors).reduce((sum, factor) => sum + factor, 0) / 5;\r\n\r\n    let recommendation: 'maintain' | 'monitor' | 'review' | 'replace' = 'maintain';\r\n    if (riskScore > 70) recommendation = 'replace';\r\n    else if (riskScore > 50) recommendation = 'review';\r\n    else if (riskScore > 30) recommendation = 'monitor';\r\n\r\n    return {\r\n      supplierId,\r\n      riskScore,\r\n      riskFactors,\r\n      recommendation,\r\n      confidence: prediction.confidence\r\n    };\r\n  }\r\n\r\n  private generateSupplierRecommendations(\r\n    supplier: any,\r\n    riskScore: SupplierRiskScore,\r\n    prediction: MLPrediction\r\n  ): string[] {\r\n    const recommendations: string[] = [];\r\n\r\n    if (riskScore.riskScore > 50) {\r\n      recommendations.push(`High risk supplier ${supplier.name}: Consider diversifying orders`);\r\n    }\r\n\r\n    if (riskScore.riskFactors.deliveryReliability > 20) {\r\n      recommendations.push(`${supplier.name}: Delivery performance needs improvement`);\r\n    }\r\n\r\n    if (prediction.prediction < 0.7) {\r\n      recommendations.push(`${supplier.name}: Performance trend is declining`);\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n\r\n  private async detectSystemAnomalies(organizationId: string): Promise<any[]> {\r\n    // Query REAL system anomalies from analytics_anomalies table\r\n    try {\r\n      const result = await query(\r\n        `SELECT\r\n          id,\r\n          anomaly_type as type,\r\n          severity,\r\n          description,\r\n          entity_type,\r\n          entity_id,\r\n          confidence_score,\r\n          detected_at\r\n        FROM analytics_anomalies\r\n        WHERE organization_id = $1\r\n          AND entity_type = 'system'\r\n          AND status = 'active'\r\n        ORDER BY detected_at DESC\r\n        LIMIT 10`,\r\n        [organizationId]\r\n      );\r\n\r\n      return result.rows.map(row => ({\r\n        type: row.type || 'system_performance',\r\n        severity: row.severity || 'medium',\r\n        description: row.description || 'System anomaly detected',\r\n        confidence: row.confidence_score || 0,\r\n        detected_at: row.detected_at\r\n      }));\r\n    } catch (error) {\r\n      console.error('Error fetching system anomalies:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private generateBusinessRecommendations(\r\n    riskScores: any,\r\n    optimizations: PriceOptimization[],\r\n    anomalies: any\r\n  ): Array<any> {\r\n    const actions: Array<any> = [];\r\n\r\n    // High-priority supplier actions\r\n    riskScores.riskScores.filter((r: SupplierRiskScore) => r.riskScore > 70).forEach((supplier: SupplierRiskScore) => {\r\n      actions.push({\r\n        type: 'supplier',\r\n        priority: 'high',\r\n        action: `Review supplier relationship and consider alternatives`,\r\n        potentialImpact: 'Reduced supply chain risk',\r\n        timeframe: 'Within 30 days'\r\n      });\r\n    });\r\n\r\n    // Price optimization opportunities\r\n    optimizations.filter(opt => opt.expectedProfitIncrease > 0.1).forEach(opt => {\r\n      actions.push({\r\n        type: 'pricing',\r\n        priority: 'medium',\r\n        action: `Optimize pricing for item ${opt.itemId}`,\r\n        potentialImpact: `${(opt.expectedProfitIncrease * 100).toFixed(1)}% profit increase`,\r\n        timeframe: 'Within 2 weeks'\r\n      });\r\n    });\r\n\r\n    return actions;\r\n  }\r\n\r\n  // Database persistence methods\r\n  private async cacheAnalyticsResults(type: string, data: any): Promise<void> {\r\n    try {\r\n      await this.db.query(\r\n        'INSERT INTO analytics_cache (type, data, created_at) VALUES ($1, $2, NOW())',\r\n        [type, JSON.stringify(data)]\r\n      );\r\n    } catch (error) {\r\n      console.error('Error caching analytics results:', error);\r\n    }\r\n  }\r\n\r\n  private async storeDemandForecasts(forecasts: DemandForecast[]): Promise<void> {\r\n    try {\r\n      for (const forecast of forecasts) {\r\n        await this.db.query(`\r\n          INSERT INTO demand_forecasts (item_id, predictions, seasonality, confidence, created_at)\r\n          VALUES ($1, $2, $3, $4, NOW())\r\n          ON CONFLICT (item_id) DO UPDATE SET\r\n          predictions = $2, seasonality = $3, confidence = $4, updated_at = NOW()\r\n        `, [\r\n          forecast.itemId,\r\n          JSON.stringify(forecast.predictions),\r\n          JSON.stringify(forecast.seasonality),\r\n          forecast.confidence\r\n        ]);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error storing demand forecasts:', error);\r\n    }\r\n  }\r\n\r\n  private async storePriceOptimizations(optimizations: PriceOptimization[]): Promise<void> {\r\n    try {\r\n      for (const opt of optimizations) {\r\n        await this.db.query(`\r\n          INSERT INTO price_optimizations (item_id, current_price, optimized_price, expected_profit_increase, recommendation, created_at)\r\n          VALUES ($1, $2, $3, $4, $5, NOW())\r\n        `, [\r\n          opt.itemId,\r\n          opt.currentPrice,\r\n          opt.optimizedPrice,\r\n          opt.expectedProfitIncrease,\r\n          opt.recommendation\r\n        ]);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error storing price optimizations:', error);\r\n    }\r\n  }\r\n\r\n  private async storeAnomalies(anomalies: any[]): Promise<void> {\r\n    try {\r\n      for (const anomaly of anomalies) {\r\n        await this.db.query(`\r\n          INSERT INTO analytics_anomalies (type, severity, description, value, threshold, detected_at)\r\n          VALUES ($1, $2, $3, $4, $5, NOW())\r\n        `, [\r\n          anomaly.anomalyType || anomaly.type,\r\n          anomaly.severity,\r\n          anomaly.description,\r\n          anomaly.value,\r\n          anomaly.threshold\r\n        ]);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error storing anomalies:', error);\r\n    }\r\n  }\r\n}\r\n\r\n// Export analytics service factory\r\nexport function createAnalyticsService(database: Pool): AnalyticsService {\r\n  return new AnalyticsService(database);\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\automated-optimization.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":1279,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":1282,"endColumn":14,"suggestions":[{"messageId":"addBrackets","fix":{"range":[41784,42099],"text":"{ const [invResult, supResult] = await Promise.all([\r\n            this.inventoryOptimizer.optimizeInventoryLevels(organizationId),\r\n            this.supplierSelector.optimizeSupplierSelection(organizationId)\r\n          ]);\r\n          result = this.combineOptimizationResults([invResult, supResult]);\r\n          break; }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Automated Optimization Workflows and Decision Support System\r\n// Implements intelligent automation for procurement, inventory, and supplier management\r\n\r\nimport { Pool } from 'pg';\r\nimport EventEmitter from 'events';\r\n\r\n// Types for Automated Optimization\r\nexport interface OptimizationWorkflow {\r\n  id: string;\r\n  name: string;\r\n  type: 'inventory_reordering' | 'supplier_selection' | 'price_negotiation' | 'cost_optimization' | 'risk_mitigation';\r\n  status: 'active' | 'paused' | 'completed' | 'failed';\r\n\r\n  trigger: {\r\n    type: 'schedule' | 'threshold' | 'event' | 'manual';\r\n    conditions: Record<string, any>;\r\n    frequency?: string; // cron expression for scheduled workflows\r\n  };\r\n\r\n  rules: Array<{\r\n    id: string;\r\n    condition: string;\r\n    action: string;\r\n    parameters: Record<string, any>;\r\n    priority: number;\r\n  }>;\r\n\r\n  automation: {\r\n    level: 'fully_automated' | 'semi_automated' | 'approval_required';\r\n    approvalThreshold?: number;\r\n    approvers?: string[];\r\n    maxAutomatedValue?: number;\r\n  };\r\n\r\n  performance: {\r\n    executionCount: number;\r\n    successRate: number;\r\n    avgExecutionTime: number;\r\n    costSavings: number;\r\n    errorCount: number;\r\n    lastExecution?: Date;\r\n  };\r\n\r\n  constraints: {\r\n    budgetLimit?: number;\r\n    timeLimit?: number;\r\n    qualityThreshold?: number;\r\n    riskLimit?: number;\r\n  };\r\n\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  createdBy: string;\r\n}\r\n\r\nexport interface DecisionSupportCase {\r\n  id: string;\r\n  type: 'supplier_evaluation' | 'inventory_decision' | 'contract_renewal' | 'budget_allocation' | 'risk_assessment';\r\n  title: string;\r\n  description: string;\r\n\r\n  context: {\r\n    entityId: string;\r\n    entityType: 'supplier' | 'item' | 'category' | 'contract';\r\n    urgency: 'low' | 'medium' | 'high' | 'critical';\r\n    deadline?: Date;\r\n    stakeholders: string[];\r\n  };\r\n\r\n  data: {\r\n    currentState: Record<string, any>;\r\n    historicalData: Record<string, any>;\r\n    marketData?: Record<string, any>;\r\n    benchmarks?: Record<string, any>;\r\n  };\r\n\r\n  analysis: {\r\n    options: Array<{\r\n      id: string;\r\n      name: string;\r\n      description: string;\r\n      pros: string[];\r\n      cons: string[];\r\n      risk: number;\r\n      cost: number;\r\n      benefit: number;\r\n      score: number;\r\n    }>;\r\n    recommendation: {\r\n      optionId: string;\r\n      confidence: number;\r\n      rationale: string[];\r\n      implementation: string[];\r\n      risks: string[];\r\n    };\r\n    sensitivity: {\r\n      criticalFactors: string[];\r\n      scenarios: Array<{\r\n        name: string;\r\n        probability: number;\r\n        impact: number;\r\n        recommendation: string;\r\n      }>;\r\n    };\r\n  };\r\n\r\n  decision?: {\r\n    selectedOption: string;\r\n    decisionBy: string;\r\n    decisionAt: Date;\r\n    rationale: string;\r\n    approvals?: Array<{\r\n      approver: string;\r\n      approvedAt: Date;\r\n      notes?: string;\r\n    }>;\r\n  };\r\n\r\n  outcome?: {\r\n    implemented: boolean;\r\n    implementedAt?: Date;\r\n    actualCost?: number;\r\n    actualBenefit?: number;\r\n    actualRisk?: number;\r\n    lessons?: string[];\r\n  };\r\n\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface OptimizationResult {\r\n  workflowId: string;\r\n  executionId: string;\r\n  status: 'success' | 'partial' | 'failed';\r\n\r\n  actions: Array<{\r\n    type: string;\r\n    target: string;\r\n    action: string;\r\n    result: 'success' | 'failed' | 'pending';\r\n    details: Record<string, any>;\r\n    cost?: number;\r\n    benefit?: number;\r\n  }>;\r\n\r\n  metrics: {\r\n    totalCostSavings: number;\r\n    timeToExecution: number;\r\n    itemsProcessed: number;\r\n    successRate: number;\r\n  };\r\n\r\n  recommendations: Array<{\r\n    type: 'improvement' | 'warning' | 'opportunity';\r\n    message: string;\r\n    action?: string;\r\n  }>;\r\n\r\n  executedAt: Date;\r\n  completedAt?: Date;\r\n  nextExecution?: Date;\r\n}\r\n\r\n// Automated Inventory Optimization Engine\r\nexport class AutomatedInventoryOptimizer {\r\n  private db: Pool;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n  }\r\n\r\n  async optimizeInventoryLevels(organizationId: string): Promise<OptimizationResult> {\r\n    const executionId = `inv_opt_${Date.now()}`;\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      // Get inventory items that need optimization\r\n      const itemsQuery = `\r\n        SELECT\r\n          ii.*,\r\n          COALESCE(demand.avg_daily_demand, 0) as avg_daily_demand,\r\n          COALESCE(demand.demand_volatility, 0) as demand_volatility,\r\n          COALESCE(supplier.lead_time_days, 7) as lead_time_days\r\n        FROM public.inventory_items ii\r\n        LEFT JOIN (\r\n          SELECT\r\n            item_id,\r\n            AVG(CASE WHEN type = 'outbound' THEN quantity ELSE 0 END) as avg_daily_demand,\r\n            STDDEV(CASE WHEN type = 'outbound' THEN quantity ELSE 0 END) /\r\n            AVG(CASE WHEN type = 'outbound' THEN quantity ELSE 0 END) as demand_volatility\r\n          FROM stock_movements\r\n          WHERE timestamp >= NOW() - INTERVAL '90 days'\r\n          GROUP BY item_id\r\n        ) demand ON ii.id = demand.item_id\r\n        LEFT JOIN (\r\n          SELECT DISTINCT ON (spl.sku)\r\n            spl.sku,\r\n            s.lead_time_days\r\n          FROM supplier_price_lists spl\r\n          JOIN suppliers s ON spl.supplier_id = s.id\r\n          ORDER BY spl.sku, spl.unit_price ASC\r\n        ) supplier ON ii.sku = supplier.sku\r\n        WHERE ii.organization_id = $1\r\n        AND (\r\n          ii.current_stock <= ii.reorder_point OR\r\n          ii.current_stock = 0 OR\r\n          ii.current_stock > ii.max_stock * 1.5\r\n        )\r\n      `;\r\n\r\n      const result = await this.db.query(itemsQuery, [organizationId]);\r\n      const items = result.rows;\r\n\r\n      const actions: any[] = [];\r\n      let totalCostSavings = 0;\r\n      let successCount = 0;\r\n\r\n      for (const item of items) {\r\n        const optimization = this.calculateOptimalLevels(item);\r\n        const action = await this.executeInventoryAction(item, optimization);\r\n\r\n        actions.push(action);\r\n\r\n        if (action.result === 'success') {\r\n          successCount++;\r\n          totalCostSavings += action.benefit || 0;\r\n        }\r\n      }\r\n\r\n      const executionTime = Date.now() - startTime;\r\n\r\n      return {\r\n        workflowId: 'inventory_optimization',\r\n        executionId,\r\n        status: successCount === actions.length ? 'success' :\r\n               successCount > 0 ? 'partial' : 'failed',\r\n        actions,\r\n        metrics: {\r\n          totalCostSavings,\r\n          timeToExecution: executionTime,\r\n          itemsProcessed: items.length,\r\n          successRate: items.length > 0 ? successCount / items.length : 0\r\n        },\r\n        recommendations: this.generateInventoryRecommendations(actions),\r\n        executedAt: new Date(),\r\n        completedAt: new Date()\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Inventory optimization error:', error);\r\n      throw new Error('Failed to optimize inventory levels');\r\n    }\r\n  }\r\n\r\n  private calculateOptimalLevels(item: any): any {\r\n    const leadTime = item.lead_time_days || 7;\r\n    const dailyDemand = item.avg_daily_demand || 1;\r\n    const demandVolatility = item.demand_volatility || 0.3;\r\n    const serviceLevel = 0.95; // 95% service level\r\n\r\n    // Calculate safety stock\r\n    const zScore = 1.65; // For 95% service level\r\n    const safetyStock = Math.ceil(zScore * demandVolatility * Math.sqrt(leadTime));\r\n\r\n    // Calculate reorder point\r\n    const optimalReorderPoint = Math.ceil((dailyDemand * leadTime) + safetyStock);\r\n\r\n    // Calculate optimal order quantity (EOQ)\r\n    const annualDemand = dailyDemand * 365;\r\n    const orderingCost = 50; // Assumed ordering cost\r\n    const holdingCostRate = 0.2; // 20% annual holding cost\r\n    const holdingCost = item.unit_cost * holdingCostRate;\r\n\r\n    const optimalOrderQuantity = Math.ceil(\r\n      Math.sqrt((2 * annualDemand * orderingCost) / holdingCost)\r\n    );\r\n\r\n    // Calculate max stock\r\n    const optimalMaxStock = optimalReorderPoint + optimalOrderQuantity;\r\n\r\n    return {\r\n      currentReorderPoint: item.reorder_point,\r\n      optimalReorderPoint,\r\n      currentMaxStock: item.max_stock,\r\n      optimalMaxStock,\r\n      currentOrderQuantity: item.max_stock - item.reorder_point,\r\n      optimalOrderQuantity,\r\n      safetyStock,\r\n      improvementPotential: this.calculateImprovement(item, {\r\n        optimalReorderPoint,\r\n        optimalMaxStock,\r\n        optimalOrderQuantity\r\n      })\r\n    };\r\n  }\r\n\r\n  private calculateImprovement(item: any, optimal: any): number {\r\n    // Calculate current carrying cost\r\n    const currentAvgStock = (item.reorder_point + item.max_stock) / 2;\r\n    const currentCarryingCost = currentAvgStock * item.unit_cost * 0.2;\r\n\r\n    // Calculate optimal carrying cost\r\n    const optimalAvgStock = (optimal.optimalReorderPoint + optimal.optimalMaxStock) / 2;\r\n    const optimalCarryingCost = optimalAvgStock * item.unit_cost * 0.2;\r\n\r\n    return Math.max(0, currentCarryingCost - optimalCarryingCost);\r\n  }\r\n\r\n  private async executeInventoryAction(item: any, optimization: any): Promise<any> {\r\n    try {\r\n      let actionType = '';\r\n      const actionResult = 'success';\r\n      let details: any = {};\r\n\r\n      if (item.current_stock === 0) {\r\n        // Emergency reorder\r\n        actionType = 'emergency_reorder';\r\n        await this.createPurchaseOrder(item, optimization.optimalOrderQuantity);\r\n        details = {\r\n          orderQuantity: optimization.optimalOrderQuantity,\r\n          urgency: 'critical'\r\n        };\r\n      } else if (item.current_stock <= item.reorder_point) {\r\n        // Regular reorder\r\n        actionType = 'reorder';\r\n        await this.createPurchaseOrder(item, optimization.optimalOrderQuantity);\r\n        details = {\r\n          orderQuantity: optimization.optimalOrderQuantity,\r\n          urgency: 'normal'\r\n        };\r\n      } else if (item.current_stock > item.max_stock * 1.5) {\r\n        // Excess inventory\r\n        actionType = 'reduce_stock';\r\n        await this.createPromotionRecommendation(item);\r\n        details = {\r\n          excessQuantity: item.current_stock - optimization.optimalMaxStock,\r\n          recommendation: 'promotional_pricing'\r\n        };\r\n      }\r\n\r\n      // Update optimal levels\r\n      if (Math.abs(optimization.optimalReorderPoint - item.reorder_point) > 5) {\r\n        await this.updateInventoryParameters(item.id, optimization);\r\n        actionType += '_and_update_params';\r\n      }\r\n\r\n      return {\r\n        type: actionType,\r\n        target: item.id,\r\n        action: `Optimized inventory for ${item.name}`,\r\n        result: actionResult,\r\n        details,\r\n        benefit: optimization.improvementPotential\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(`Error executing inventory action for item ${item.id}:`, error);\r\n      return {\r\n        type: 'optimization_attempt',\r\n        target: item.id,\r\n        action: `Failed to optimize ${item.name}`,\r\n        result: 'failed',\r\n        details: { error: error.message }\r\n      };\r\n    }\r\n  }\r\n\r\n  private async createPurchaseOrder(item: any, quantity: number): Promise<void> {\r\n    // Simulate PO creation\r\n    await this.db.query(`\r\n      INSERT INTO purchase_orders (\r\n        item_id, quantity, unit_price, total_amount, status, created_at\r\n      ) VALUES ($1, $2, $3, $4, 'pending', NOW())\r\n    `, [item.id, quantity, item.unit_cost, quantity * item.unit_cost]);\r\n  }\r\n\r\n  private async createPromotionRecommendation(item: any): Promise<void> {\r\n    // Create promotion recommendation\r\n    await this.db.query(`\r\n      INSERT INTO promotion_recommendations (\r\n        item_id, type, discount_percentage, reason, created_at\r\n      ) VALUES ($1, 'excess_inventory', 15, 'Reduce excess stock', NOW())\r\n    `, [item.id]);\r\n  }\r\n\r\n  private async updateInventoryParameters(_itemId: string, _optimization: any): Promise<void> {\r\n    // SSOT: parameter updates for inventory should go through a policy table; no direct inventory_items writes.\r\n    return;\r\n  }\r\n\r\n  private generateInventoryRecommendations(actions: any[]): any[] {\r\n    const recommendations = [];\r\n\r\n    const failedActions = actions.filter(a => a.result === 'failed');\r\n    if (failedActions.length > 0) {\r\n      recommendations.push({\r\n        type: 'warning',\r\n        message: `${failedActions.length} inventory actions failed. Review item configurations.`,\r\n        action: 'review_failed_optimizations'\r\n      });\r\n    }\r\n\r\n    const emergencyOrders = actions.filter(a => a.type === 'emergency_reorder');\r\n    if (emergencyOrders.length > 0) {\r\n      recommendations.push({\r\n        type: 'warning',\r\n        message: `${emergencyOrders.length} items required emergency reordering. Consider improving demand forecasting.`,\r\n        action: 'improve_demand_forecasting'\r\n      });\r\n    }\r\n\r\n    const totalSavings = actions.reduce((sum, a) => sum + (a.benefit || 0), 0);\r\n    if (totalSavings > 10000) {\r\n      recommendations.push({\r\n        type: 'opportunity',\r\n        message: `Inventory optimization generated $${totalSavings.toLocaleString()} in potential savings.`,\r\n        action: 'continue_optimization'\r\n      });\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n}\r\n\r\n// Automated Supplier Selection Engine\r\nexport class AutomatedSupplierSelector {\r\n  private db: Pool;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n  }\r\n\r\n  async optimizeSupplierSelection(organizationId: string): Promise<OptimizationResult> {\r\n    const executionId = `supplier_opt_${Date.now()}`;\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      // Get items that need supplier optimization\r\n      const itemsQuery = `\r\n        SELECT\r\n          ii.*,\r\n          current_supplier.supplier_id as current_supplier_id,\r\n          current_supplier.unit_price as current_price,\r\n          sp.overall_rating as current_supplier_rating\r\n        FROM public.inventory_items ii\r\n        LEFT JOIN supplier_price_lists current_supplier ON ii.sku = current_supplier.sku\r\n        LEFT JOIN supplier_performance sp ON current_supplier.supplier_id = sp.supplier_id\r\n        WHERE ii.organization_id = $1\r\n        AND (sp.overall_rating < 80 OR current_supplier.unit_price IS NULL)\r\n      `;\r\n\r\n      const result = await this.db.query(itemsQuery, [organizationId]);\r\n      const items = result.rows;\r\n\r\n      const actions: any[] = [];\r\n      let totalCostSavings = 0;\r\n      let successCount = 0;\r\n\r\n      for (const item of items) {\r\n        const alternatives = await this.findAlternativeSuppliers(item);\r\n        const optimization = this.evaluateSupplierOptions(item, alternatives);\r\n        const action = await this.executeSupplierChange(item, optimization);\r\n\r\n        actions.push(action);\r\n\r\n        if (action.result === 'success') {\r\n          successCount++;\r\n          totalCostSavings += action.benefit || 0;\r\n        }\r\n      }\r\n\r\n      return {\r\n        workflowId: 'supplier_optimization',\r\n        executionId,\r\n        status: successCount === actions.length ? 'success' :\r\n               successCount > 0 ? 'partial' : 'failed',\r\n        actions,\r\n        metrics: {\r\n          totalCostSavings,\r\n          timeToExecution: Date.now() - startTime,\r\n          itemsProcessed: items.length,\r\n          successRate: items.length > 0 ? successCount / items.length : 0\r\n        },\r\n        recommendations: this.generateSupplierRecommendations(actions),\r\n        executedAt: new Date(),\r\n        completedAt: new Date()\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Supplier optimization error:', error);\r\n      throw new Error('Failed to optimize supplier selection');\r\n    }\r\n  }\r\n\r\n  private async findAlternativeSuppliers(item: any): Promise<any[]> {\r\n    const query = `\r\n      SELECT\r\n        s.*,\r\n        spl.unit_price,\r\n        sp.overall_rating,\r\n        sp.on_time_delivery_rate,\r\n        sp.quality_acceptance_rate\r\n      FROM public.suppliers s\r\n      JOIN supplier_price_lists spl ON s.id = spl.supplier_id\r\n      LEFT JOIN supplier_performance sp ON s.id = sp.supplier_id\r\n      WHERE spl.sku = $1\r\n      AND s.status = 'active'\r\n      ORDER BY sp.overall_rating DESC, spl.unit_price ASC\r\n    `;\r\n\r\n    const result = await this.db.query(query, [item.sku]);\r\n    return result.rows;\r\n  }\r\n\r\n  private evaluateSupplierOptions(item: any, alternatives: any[]): any {\r\n    if (alternatives.length === 0) {\r\n      return { recommendation: null, reason: 'No alternatives available' };\r\n    }\r\n\r\n    // Score each supplier based on multiple criteria\r\n    const scoredAlternatives = alternatives.map(supplier => {\r\n      const priceScore = this.calculatePriceScore(supplier.unit_price, alternatives);\r\n      const qualityScore = (supplier.overall_rating || 70) / 100;\r\n      const deliveryScore = (supplier.on_time_delivery_rate || 80) / 100;\r\n      const qualityAcceptanceScore = (supplier.quality_acceptance_rate || 85) / 100;\r\n\r\n      // Weighted composite score\r\n      const compositeScore = (\r\n        priceScore * 0.3 +\r\n        qualityScore * 0.25 +\r\n        deliveryScore * 0.25 +\r\n        qualityAcceptanceScore * 0.2\r\n      );\r\n\r\n      return {\r\n        ...supplier,\r\n        scores: {\r\n          price: priceScore,\r\n          quality: qualityScore,\r\n          delivery: deliveryScore,\r\n          qualityAcceptance: qualityAcceptanceScore,\r\n          composite: compositeScore\r\n        }\r\n      };\r\n    });\r\n\r\n    // Find best option\r\n    const bestOption = scoredAlternatives.reduce((best, current) =>\r\n      current.scores.composite > best.scores.composite ? current : best\r\n    );\r\n\r\n    const currentCost = item.current_price || bestOption.unit_price * 1.1;\r\n    const potentialSavings = Math.max(0, currentCost - bestOption.unit_price);\r\n\r\n    return {\r\n      recommendation: bestOption,\r\n      alternatives: scoredAlternatives.slice(0, 3), // Top 3 alternatives\r\n      potentialSavings,\r\n      qualityImprovement: (bestOption.overall_rating || 70) - (item.current_supplier_rating || 70),\r\n      reason: `Better composite score: ${(bestOption.scores.composite * 100).toFixed(1)}%`\r\n    };\r\n  }\r\n\r\n  private calculatePriceScore(price: number, alternatives: any[]): number {\r\n    const prices = alternatives.map(a => a.unit_price).filter(p => p > 0);\r\n    if (prices.length === 0) return 0.5;\r\n\r\n    const minPrice = Math.min(...prices);\r\n    const maxPrice = Math.max(...prices);\r\n\r\n    if (minPrice === maxPrice) return 1;\r\n\r\n    // Lower price = higher score\r\n    return 1 - ((price - minPrice) / (maxPrice - minPrice));\r\n  }\r\n\r\n  private async executeSupplierChange(item: any, optimization: any): Promise<any> {\r\n    try {\r\n      if (!optimization.recommendation) {\r\n        return {\r\n          type: 'no_action',\r\n          target: item.id,\r\n          action: `No better supplier found for ${item.name}`,\r\n          result: 'success',\r\n          details: { reason: optimization.reason }\r\n        };\r\n      }\r\n\r\n      const newSupplier = optimization.recommendation;\r\n\r\n      // Update preferred supplier (simulation)\r\n      // SSOT: supplier change should update supplier_product + price history, not inventory_items directly. No-op here.\r\n\r\n      return {\r\n        type: 'supplier_change',\r\n        target: item.id,\r\n        action: `Changed supplier for ${item.name} to ${newSupplier.name}`,\r\n        result: 'success',\r\n        details: {\r\n          newSupplier: newSupplier.name,\r\n          oldPrice: item.current_price,\r\n          newPrice: newSupplier.unit_price,\r\n          qualityImprovement: optimization.qualityImprovement\r\n        },\r\n        cost: 0, // Switching cost could be added here\r\n        benefit: optimization.potentialSavings\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(`Error executing supplier change for item ${item.id}:`, error);\r\n      return {\r\n        type: 'supplier_change_attempt',\r\n        target: item.id,\r\n        action: `Failed to change supplier for ${item.name}`,\r\n        result: 'failed',\r\n        details: { error: error.message }\r\n      };\r\n    }\r\n  }\r\n\r\n  private generateSupplierRecommendations(actions: any[]): any[] {\r\n    const recommendations = [];\r\n\r\n    const supplierChanges = actions.filter(a => a.type === 'supplier_change');\r\n    if (supplierChanges.length > 0) {\r\n      const totalSavings = supplierChanges.reduce((sum, a) => sum + (a.benefit || 0), 0);\r\n      recommendations.push({\r\n        type: 'opportunity',\r\n        message: `${supplierChanges.length} supplier changes could save $${totalSavings.toLocaleString()} annually.`,\r\n        action: 'implement_supplier_changes'\r\n      });\r\n    }\r\n\r\n    const noAlternatives = actions.filter(a => a.type === 'no_action');\r\n    if (noAlternatives.length > 0) {\r\n      recommendations.push({\r\n        type: 'improvement',\r\n        message: `${noAlternatives.length} items lack supplier alternatives. Consider expanding supplier base.`,\r\n        action: 'supplier_sourcing_initiative'\r\n      });\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n}\r\n\r\n// Decision Support System\r\nexport class DecisionSupportSystem {\r\n  private db: Pool;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n  }\r\n\r\n  async createDecisionCase(\r\n    type: DecisionSupportCase['type'],\r\n    context: DecisionSupportCase['context'],\r\n    data: DecisionSupportCase['data']\r\n  ): Promise<DecisionSupportCase> {\r\n    const caseId = `case_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    // Generate options and analysis\r\n    const options = await this.generateOptions(type, context, data);\r\n    const analysis = await this.performAnalysis(type, options, data);\r\n\r\n    const decisionCase: DecisionSupportCase = {\r\n      id: caseId,\r\n      type,\r\n      title: this.generateCaseTitle(type, context),\r\n      description: this.generateCaseDescription(type, context, data),\r\n      context,\r\n      data,\r\n      analysis,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date()\r\n    };\r\n\r\n    // Store in database\r\n    await this.storeDecisionCase(decisionCase);\r\n\r\n    return decisionCase;\r\n  }\r\n\r\n  private async generateOptions(\r\n    type: DecisionSupportCase['type'],\r\n    context: DecisionSupportCase['context'],\r\n    data: DecisionSupportCase['data']\r\n  ): Promise<any[]> {\r\n    switch (type) {\r\n      case 'supplier_evaluation':\r\n        return this.generateSupplierOptions(context, data);\r\n      case 'inventory_decision':\r\n        return this.generateInventoryOptions(context, data);\r\n      case 'contract_renewal':\r\n        return this.generateContractOptions(context, data);\r\n      case 'budget_allocation':\r\n        return this.generateBudgetOptions(context, data);\r\n      case 'risk_assessment':\r\n        return this.generateRiskMitigationOptions(context, data);\r\n      default:\r\n        return [];\r\n    }\r\n  }\r\n\r\n  private async generateSupplierOptions(context: any, data: any): Promise<any[]> {\r\n    return [\r\n      {\r\n        id: 'maintain_current',\r\n        name: 'Maintain Current Supplier',\r\n        description: 'Continue with existing supplier relationship',\r\n        pros: ['No switching costs', 'Established relationship', 'Known performance'],\r\n        cons: ['May miss cost savings', 'Limited innovation', 'Dependency risk'],\r\n        risk: 0.3,\r\n        cost: 0,\r\n        benefit: 0,\r\n        score: 0.6\r\n      },\r\n      {\r\n        id: 'switch_supplier',\r\n        name: 'Switch to Alternative Supplier',\r\n        description: 'Change to better performing or cheaper supplier',\r\n        pros: ['Potential cost savings', 'Better performance', 'Reduced risk'],\r\n        cons: ['Switching costs', 'Unknown reliability', 'Relationship building needed'],\r\n        risk: 0.5,\r\n        cost: 5000,\r\n        benefit: 15000,\r\n        score: 0.8\r\n      },\r\n      {\r\n        id: 'multi_supplier',\r\n        name: 'Multi-Supplier Strategy',\r\n        description: 'Use multiple suppliers to reduce risk',\r\n        pros: ['Risk diversification', 'Competitive pricing', 'Supply security'],\r\n        cons: ['Higher management complexity', 'Reduced volumes', 'Multiple relationships'],\r\n        risk: 0.2,\r\n        cost: 3000,\r\n        benefit: 8000,\r\n        score: 0.75\r\n      }\r\n    ];\r\n  }\r\n\r\n  private async generateInventoryOptions(context: any, data: any): Promise<any[]> {\r\n    return [\r\n      {\r\n        id: 'increase_stock',\r\n        name: 'Increase Stock Levels',\r\n        description: 'Raise inventory levels to improve service',\r\n        pros: ['Better service levels', 'Reduced stockouts', 'Customer satisfaction'],\r\n        cons: ['Higher carrying costs', 'Increased obsolescence risk', 'Capital tied up'],\r\n        risk: 0.3,\r\n        cost: 10000,\r\n        benefit: 5000,\r\n        score: 0.6\r\n      },\r\n      {\r\n        id: 'optimize_stock',\r\n        name: 'Optimize Stock Levels',\r\n        description: 'Use data-driven approach to set optimal levels',\r\n        pros: ['Balanced approach', 'Data-driven decisions', 'Cost optimization'],\r\n        cons: ['Requires analysis', 'May need monitoring', 'Implementation effort'],\r\n        risk: 0.2,\r\n        cost: 2000,\r\n        benefit: 12000,\r\n        score: 0.85\r\n      },\r\n      {\r\n        id: 'jit_approach',\r\n        name: 'Just-in-Time Approach',\r\n        description: 'Minimize inventory with frequent deliveries',\r\n        pros: ['Low carrying costs', 'Reduced waste', 'Cash flow improvement'],\r\n        cons: ['Supply risk', 'Requires reliable suppliers', 'Higher coordination needs'],\r\n        risk: 0.6,\r\n        cost: 1000,\r\n        benefit: 15000,\r\n        score: 0.7\r\n      }\r\n    ];\r\n  }\r\n\r\n  private async generateContractOptions(context: any, data: any): Promise<any[]> {\r\n    return [\r\n      {\r\n        id: 'renew_as_is',\r\n        name: 'Renew As-Is',\r\n        description: 'Renew contract with current terms',\r\n        pros: ['No negotiation effort', 'Predictable terms', 'Quick process'],\r\n        cons: ['No improvements', 'Missed savings', 'No term optimization'],\r\n        risk: 0.2,\r\n        cost: 0,\r\n        benefit: 0,\r\n        score: 0.5\r\n      },\r\n      {\r\n        id: 'renegotiate',\r\n        name: 'Renegotiate Terms',\r\n        description: 'Negotiate better pricing and terms',\r\n        pros: ['Potential savings', 'Better terms', 'Updated conditions'],\r\n        cons: ['Time investment', 'Negotiation risk', 'Relationship strain'],\r\n        risk: 0.4,\r\n        cost: 5000,\r\n        benefit: 25000,\r\n        score: 0.8\r\n      },\r\n      {\r\n        id: 'market_test',\r\n        name: 'Market Test',\r\n        description: 'Compare with alternative suppliers',\r\n        pros: ['Market validation', 'Competitive pressure', 'Best value assurance'],\r\n        cons: ['Time consuming', 'Relationship risk', 'Evaluation costs'],\r\n        risk: 0.5,\r\n        cost: 8000,\r\n        benefit: 35000,\r\n        score: 0.75\r\n      }\r\n    ];\r\n  }\r\n\r\n  private async generateBudgetOptions(context: any, data: any): Promise<any[]> {\r\n    return [\r\n      {\r\n        id: 'maintain_budget',\r\n        name: 'Maintain Current Budget',\r\n        description: 'Keep existing budget allocation',\r\n        pros: ['Stability', 'Predictability', 'No disruption'],\r\n        cons: ['No optimization', 'Missed opportunities', 'Inefficiencies persist'],\r\n        risk: 0.2,\r\n        cost: 0,\r\n        benefit: 0,\r\n        score: 0.5\r\n      },\r\n      {\r\n        id: 'reallocate_strategic',\r\n        name: 'Strategic Reallocation',\r\n        description: 'Reallocate based on strategic priorities',\r\n        pros: ['Strategic alignment', 'Better ROI', 'Growth focus'],\r\n        cons: ['Change management', 'Short-term disruption', 'Stakeholder concerns'],\r\n        risk: 0.4,\r\n        cost: 10000,\r\n        benefit: 40000,\r\n        score: 0.8\r\n      },\r\n      {\r\n        id: 'performance_based',\r\n        name: 'Performance-Based Allocation',\r\n        description: 'Allocate based on historical performance',\r\n        pros: ['Merit-based', 'Incentive alignment', 'Efficiency focus'],\r\n        cons: ['May penalize innovation', 'Historical bias', 'Internal competition'],\r\n        risk: 0.3,\r\n        cost: 5000,\r\n        benefit: 20000,\r\n        score: 0.7\r\n      }\r\n    ];\r\n  }\r\n\r\n  private async generateRiskMitigationOptions(context: any, data: any): Promise<any[]> {\r\n    return [\r\n      {\r\n        id: 'accept_risk',\r\n        name: 'Accept Current Risk',\r\n        description: 'Accept risk with current mitigation',\r\n        pros: ['No additional costs', 'Simple approach', 'Focus on core business'],\r\n        cons: ['Potential losses', 'No improvement', 'Stakeholder concerns'],\r\n        risk: 0.7,\r\n        cost: 0,\r\n        benefit: 0,\r\n        score: 0.4\r\n      },\r\n      {\r\n        id: 'mitigate_risk',\r\n        name: 'Active Risk Mitigation',\r\n        description: 'Implement additional risk controls',\r\n        pros: ['Reduced risk exposure', 'Better control', 'Stakeholder confidence'],\r\n        cons: ['Additional costs', 'Implementation effort', 'May slow operations'],\r\n        risk: 0.3,\r\n        cost: 15000,\r\n        benefit: 30000,\r\n        score: 0.8\r\n      },\r\n      {\r\n        id: 'transfer_risk',\r\n        name: 'Risk Transfer/Insurance',\r\n        description: 'Transfer risk through insurance or contracts',\r\n        pros: ['Risk transfer', 'Predictable costs', 'Professional management'],\r\n        cons: ['Insurance costs', 'Limited coverage', 'Claim complexities'],\r\n        risk: 0.2,\r\n        cost: 8000,\r\n        benefit: 10000,\r\n        score: 0.7\r\n      }\r\n    ];\r\n  }\r\n\r\n  private async performAnalysis(\r\n    type: DecisionSupportCase['type'],\r\n    options: any[],\r\n    data: DecisionSupportCase['data']\r\n  ): Promise<any> {\r\n    // Select best option based on scores\r\n    const bestOption = options.reduce((best, current) =>\r\n      current.score > best.score ? current : best\r\n    );\r\n\r\n    // Generate recommendation\r\n    const recommendation = {\r\n      optionId: bestOption.id,\r\n      confidence: bestOption.score,\r\n      rationale: this.generateRationale(bestOption, options),\r\n      implementation: this.generateImplementation(bestOption, type),\r\n      risks: this.generateRiskAssessment(bestOption, options)\r\n    };\r\n\r\n    // Generate sensitivity analysis\r\n    const sensitivity = {\r\n      criticalFactors: this.identifyCriticalFactors(options),\r\n      scenarios: this.generateScenarios(options),\r\n    };\r\n\r\n    return {\r\n      options,\r\n      recommendation,\r\n      sensitivity\r\n    };\r\n  }\r\n\r\n  private generateRationale(bestOption: any, allOptions: any[]): string[] {\r\n    const rationale = [];\r\n\r\n    if (bestOption.score > 0.8) {\r\n      rationale.push(`Highest score option with ${(bestOption.score * 100).toFixed(1)}% confidence`);\r\n    }\r\n\r\n    if (bestOption.benefit > bestOption.cost * 2) {\r\n      rationale.push(`Strong ROI with benefit-to-cost ratio of ${(bestOption.benefit / Math.max(bestOption.cost, 1)).toFixed(1)}:1`);\r\n    }\r\n\r\n    if (bestOption.risk < 0.4) {\r\n      rationale.push('Low risk option with manageable implementation challenges');\r\n    }\r\n\r\n    const avgScore = allOptions.reduce((sum, opt) => sum + opt.score, 0) / allOptions.length;\r\n    if (bestOption.score > avgScore * 1.2) {\r\n      rationale.push('Significantly outperforms alternative options');\r\n    }\r\n\r\n    return rationale.length > 0 ? rationale : ['Selected based on overall evaluation criteria'];\r\n  }\r\n\r\n  private generateImplementation(bestOption: any, type: string): string[] {\r\n    const implementation = [\r\n      'Conduct detailed impact assessment',\r\n      'Prepare implementation plan with timeline',\r\n      'Identify required resources and stakeholders',\r\n      'Execute implementation in phases',\r\n      'Monitor progress and adjust as needed'\r\n    ];\r\n\r\n    // Add type-specific steps\r\n    switch (type) {\r\n      case 'supplier_evaluation':\r\n        implementation.splice(2, 0, 'Conduct supplier negotiations');\r\n        implementation.splice(3, 0, 'Finalize contract terms');\r\n        break;\r\n      case 'inventory_decision':\r\n        implementation.splice(2, 0, 'Update inventory management systems');\r\n        implementation.splice(3, 0, 'Train staff on new procedures');\r\n        break;\r\n      case 'contract_renewal':\r\n        implementation.splice(1, 0, 'Prepare negotiation strategy');\r\n        implementation.splice(3, 0, 'Legal review of new terms');\r\n        break;\r\n    }\r\n\r\n    return implementation;\r\n  }\r\n\r\n  private generateRiskAssessment(bestOption: any, allOptions: any[]): string[] {\r\n    const risks = [];\r\n\r\n    if (bestOption.risk > 0.5) {\r\n      risks.push('High implementation risk - requires careful monitoring');\r\n    }\r\n\r\n    if (bestOption.cost > 10000) {\r\n      risks.push('Significant cost investment - ensure budget approval');\r\n    }\r\n\r\n    if (bestOption.benefit < bestOption.cost * 1.5) {\r\n      risks.push('Marginal ROI - monitor benefits realization closely');\r\n    }\r\n\r\n    return risks.length > 0 ? risks : ['Low risk option with standard implementation considerations'];\r\n  }\r\n\r\n  private identifyCriticalFactors(options: any[]): string[] {\r\n    const factors = [];\r\n\r\n    const costRange = Math.max(...options.map(o => o.cost)) - Math.min(...options.map(o => o.cost));\r\n    if (costRange > 5000) {\r\n      factors.push('Implementation cost');\r\n    }\r\n\r\n    const riskRange = Math.max(...options.map(o => o.risk)) - Math.min(...options.map(o => o.risk));\r\n    if (riskRange > 0.3) {\r\n      factors.push('Risk level');\r\n    }\r\n\r\n    const benefitRange = Math.max(...options.map(o => o.benefit)) - Math.min(...options.map(o => o.benefit));\r\n    if (benefitRange > 10000) {\r\n      factors.push('Expected benefits');\r\n    }\r\n\r\n    return factors.length > 0 ? factors : ['Option characteristics', 'Implementation complexity'];\r\n  }\r\n\r\n  private generateScenarios(options: any[]): any[] {\r\n    return [\r\n      {\r\n        name: 'Best Case',\r\n        probability: 0.3,\r\n        impact: 1.5,\r\n        recommendation: 'Proceed with full implementation'\r\n      },\r\n      {\r\n        name: 'Most Likely',\r\n        probability: 0.5,\r\n        impact: 1.0,\r\n        recommendation: 'Implement with standard monitoring'\r\n      },\r\n      {\r\n        name: 'Worst Case',\r\n        probability: 0.2,\r\n        impact: 0.5,\r\n        recommendation: 'Implement with enhanced risk controls'\r\n      }\r\n    ];\r\n  }\r\n\r\n  private generateCaseTitle(type: string, context: any): string {\r\n    const titles = {\r\n      'supplier_evaluation': `Supplier Evaluation: ${context.entityType}`,\r\n      'inventory_decision': `Inventory Decision: ${context.entityType}`,\r\n      'contract_renewal': `Contract Renewal: ${context.entityType}`,\r\n      'budget_allocation': `Budget Allocation: ${context.entityType}`,\r\n      'risk_assessment': `Risk Assessment: ${context.entityType}`\r\n    };\r\n\r\n    return titles[type] || `Decision Support: ${type}`;\r\n  }\r\n\r\n  private generateCaseDescription(type: string, context: any, data: any): string {\r\n    return `Decision support case for ${type.replace('_', ' ')} involving ${context.entityType} ` +\r\n           `with ${context.urgency} urgency level. Analysis of current state and recommendations for optimal decision.`;\r\n  }\r\n\r\n  private async storeDecisionCase(decisionCase: DecisionSupportCase): Promise<void> {\r\n    try {\r\n      await this.db.query(`\r\n        INSERT INTO decision_support_cases (\r\n          id, type, title, description, context, data, analysis, created_at\r\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\r\n      `, [\r\n        decisionCase.id,\r\n        decisionCase.type,\r\n        decisionCase.title,\r\n        decisionCase.description,\r\n        JSON.stringify(decisionCase.context),\r\n        JSON.stringify(decisionCase.data),\r\n        JSON.stringify(decisionCase.analysis),\r\n        decisionCase.createdAt\r\n      ]);\r\n    } catch (error) {\r\n      console.error('Error storing decision case:', error);\r\n    }\r\n  }\r\n\r\n  async updateDecision(\r\n    caseId: string,\r\n    selectedOption: string,\r\n    decisionBy: string,\r\n    rationale: string\r\n  ): Promise<boolean> {\r\n    try {\r\n      await this.db.query(`\r\n        UPDATE decision_support_cases\r\n        SET decision = $1, updated_at = NOW()\r\n        WHERE id = $2\r\n      `, [\r\n        JSON.stringify({\r\n          selectedOption,\r\n          decisionBy,\r\n          decisionAt: new Date(),\r\n          rationale\r\n        }),\r\n        caseId\r\n      ]);\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating decision:', error);\r\n      return false;\r\n    }\r\n  }\r\n}\r\n\r\n// Workflow Management Engine\r\nexport class AutomatedWorkflowEngine extends EventEmitter {\r\n  private db: Pool;\r\n  private workflows: Map<string, OptimizationWorkflow> = new Map();\r\n  private inventoryOptimizer: AutomatedInventoryOptimizer;\r\n  private supplierSelector: AutomatedSupplierSelector;\r\n  private decisionSupport: DecisionSupportSystem;\r\n  private isRunning: boolean = false;\r\n\r\n  constructor(database: Pool) {\r\n    super();\r\n    this.db = database;\r\n    this.inventoryOptimizer = new AutomatedInventoryOptimizer(database);\r\n    this.supplierSelector = new AutomatedSupplierSelector(database);\r\n    this.decisionSupport = new DecisionSupportSystem(database);\r\n    this.initializeWorkflows();\r\n  }\r\n\r\n  private async initializeWorkflows(): Promise<void> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT * FROM optimization_workflows\r\n        WHERE status = 'active'\r\n      `);\r\n\r\n      result.rows.forEach(row => {\r\n        const workflow: OptimizationWorkflow = {\r\n          id: row.id,\r\n          name: row.name,\r\n          type: row.type,\r\n          status: row.status,\r\n          trigger: JSON.parse(row.trigger),\r\n          rules: JSON.parse(row.rules),\r\n          automation: JSON.parse(row.automation),\r\n          performance: JSON.parse(row.performance),\r\n          constraints: JSON.parse(row.constraints),\r\n          createdAt: new Date(row.created_at),\r\n          updatedAt: new Date(row.updated_at),\r\n          createdBy: row.created_by\r\n        };\r\n\r\n        this.workflows.set(workflow.id, workflow);\r\n      });\r\n\r\n      if (this.workflows.size === 0) {\r\n        await this.createDefaultWorkflows();\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error initializing workflows:', error);\r\n      await this.createDefaultWorkflows();\r\n    }\r\n  }\r\n\r\n  private async createDefaultWorkflows(): Promise<void> {\r\n    const defaultWorkflows = [\r\n      {\r\n        name: 'Automated Inventory Reordering',\r\n        type: 'inventory_reordering',\r\n        trigger: {\r\n          type: 'threshold',\r\n          conditions: { stockLevel: 'below_reorder_point' },\r\n          frequency: '0 */6 * * *' // Every 6 hours\r\n        },\r\n        automation: {\r\n          level: 'fully_automated',\r\n          maxAutomatedValue: 10000\r\n        }\r\n      },\r\n      {\r\n        name: 'Supplier Performance Optimization',\r\n        type: 'supplier_selection',\r\n        trigger: {\r\n          type: 'schedule',\r\n          frequency: '0 0 * * 1' // Weekly on Monday\r\n        },\r\n        automation: {\r\n          level: 'semi_automated',\r\n          approvalThreshold: 5000\r\n        }\r\n      },\r\n      {\r\n        name: 'Cost Optimization Analysis',\r\n        type: 'cost_optimization',\r\n        trigger: {\r\n          type: 'schedule',\r\n          frequency: '0 0 1 * *' // Monthly\r\n        },\r\n        automation: {\r\n          level: 'approval_required'\r\n        }\r\n      }\r\n    ];\r\n\r\n    for (const workflowConfig of defaultWorkflows) {\r\n      await this.createWorkflow(workflowConfig);\r\n    }\r\n  }\r\n\r\n  async createWorkflow(config: any): Promise<string> {\r\n    const workflowId = `workflow_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    const workflow: OptimizationWorkflow = {\r\n      id: workflowId,\r\n      name: config.name,\r\n      type: config.type,\r\n      status: 'active',\r\n      trigger: config.trigger,\r\n      rules: config.rules || [],\r\n      automation: {\r\n        level: config.automation?.level || 'semi_automated',\r\n        approvalThreshold: config.automation?.approvalThreshold,\r\n        approvers: config.automation?.approvers || [],\r\n        maxAutomatedValue: config.automation?.maxAutomatedValue\r\n      },\r\n      performance: {\r\n        executionCount: 0,\r\n        successRate: 0,\r\n        avgExecutionTime: 0,\r\n        costSavings: 0,\r\n        errorCount: 0\r\n      },\r\n      constraints: config.constraints || {},\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n      createdBy: config.createdBy || 'system'\r\n    };\r\n\r\n    try {\r\n      await this.db.query(`\r\n        INSERT INTO optimization_workflows (\r\n          id, name, type, status, trigger, rules, automation,\r\n          performance, constraints, created_at, created_by\r\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)\r\n      `, [\r\n        workflow.id, workflow.name, workflow.type, workflow.status,\r\n        JSON.stringify(workflow.trigger), JSON.stringify(workflow.rules),\r\n        JSON.stringify(workflow.automation), JSON.stringify(workflow.performance),\r\n        JSON.stringify(workflow.constraints), workflow.createdAt, workflow.createdBy\r\n      ]);\r\n\r\n      this.workflows.set(workflowId, workflow);\r\n      return workflowId;\r\n\r\n    } catch (error) {\r\n      console.error('Error creating workflow:', error);\r\n      throw new Error('Failed to create optimization workflow');\r\n    }\r\n  }\r\n\r\n  async executeWorkflow(workflowId: string, organizationId: string = 'default'): Promise<OptimizationResult> {\r\n    const workflow = this.workflows.get(workflowId);\r\n    if (!workflow) {\r\n      throw new Error('Workflow not found');\r\n    }\r\n\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      let result: OptimizationResult;\r\n\r\n      switch (workflow.type) {\r\n        case 'inventory_reordering':\r\n          result = await this.inventoryOptimizer.optimizeInventoryLevels(organizationId);\r\n          break;\r\n        case 'supplier_selection':\r\n          result = await this.supplierSelector.optimizeSupplierSelection(organizationId);\r\n          break;\r\n        case 'cost_optimization':\r\n          // Combine multiple optimization types\r\n          const [invResult, supResult] = await Promise.all([\r\n            this.inventoryOptimizer.optimizeInventoryLevels(organizationId),\r\n            this.supplierSelector.optimizeSupplierSelection(organizationId)\r\n          ]);\r\n          result = this.combineOptimizationResults([invResult, supResult]);\r\n          break;\r\n        default:\r\n          throw new Error(`Unsupported workflow type: ${workflow.type}`);\r\n      }\r\n\r\n      // Update workflow performance\r\n      await this.updateWorkflowPerformance(workflow, result, Date.now() - startTime);\r\n\r\n      // Emit workflow completion event\r\n      this.emit('workflowCompleted', { workflow, result });\r\n\r\n      return result;\r\n\r\n    } catch (error) {\r\n      console.error(`Workflow execution error for ${workflowId}:`, error);\r\n      workflow.performance.errorCount++;\r\n      await this.updateWorkflowInDatabase(workflow);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private combineOptimizationResults(results: OptimizationResult[]): OptimizationResult {\r\n    const combinedActions = results.flatMap(r => r.actions);\r\n    const totalCostSavings = results.reduce((sum, r) => sum + r.metrics.totalCostSavings, 0);\r\n    const totalItemsProcessed = results.reduce((sum, r) => sum + r.metrics.itemsProcessed, 0);\r\n    const avgSuccessRate = results.reduce((sum, r) => sum + r.metrics.successRate, 0) / results.length;\r\n\r\n    return {\r\n      workflowId: 'cost_optimization',\r\n      executionId: `combined_${Date.now()}`,\r\n      status: results.every(r => r.status === 'success') ? 'success' : 'partial',\r\n      actions: combinedActions,\r\n      metrics: {\r\n        totalCostSavings,\r\n        timeToExecution: Math.max(...results.map(r => r.metrics.timeToExecution)),\r\n        itemsProcessed: totalItemsProcessed,\r\n        successRate: avgSuccessRate\r\n      },\r\n      recommendations: results.flatMap(r => r.recommendations),\r\n      executedAt: new Date(),\r\n      completedAt: new Date()\r\n    };\r\n  }\r\n\r\n  private async updateWorkflowPerformance(\r\n    workflow: OptimizationWorkflow,\r\n    result: OptimizationResult,\r\n    executionTime: number\r\n  ): Promise<void> {\r\n    workflow.performance.executionCount++;\r\n    workflow.performance.lastExecution = new Date();\r\n    workflow.performance.avgExecutionTime = (\r\n      (workflow.performance.avgExecutionTime * (workflow.performance.executionCount - 1) + executionTime) /\r\n      workflow.performance.executionCount\r\n    );\r\n\r\n    if (result.status === 'success') {\r\n      const successCount = workflow.performance.executionCount - workflow.performance.errorCount;\r\n      workflow.performance.successRate = successCount / workflow.performance.executionCount;\r\n    }\r\n\r\n    workflow.performance.costSavings += result.metrics.totalCostSavings;\r\n\r\n    await this.updateWorkflowInDatabase(workflow);\r\n  }\r\n\r\n  private async updateWorkflowInDatabase(workflow: OptimizationWorkflow): Promise<void> {\r\n    try {\r\n      await this.db.query(`\r\n        UPDATE optimization_workflows\r\n        SET performance = $1, updated_at = NOW()\r\n        WHERE id = $2\r\n      `, [JSON.stringify(workflow.performance), workflow.id]);\r\n    } catch (error) {\r\n      console.error('Error updating workflow performance:', error);\r\n    }\r\n  }\r\n\r\n  startAutomation(): void {\r\n    if (this.isRunning) return;\r\n\r\n    this.isRunning = true;\r\n    console.log('Automated optimization workflows started');\r\n\r\n    // Set up workflow execution intervals\r\n    this.workflows.forEach(workflow => {\r\n      if (workflow.trigger.type === 'schedule' && workflow.trigger.frequency) {\r\n        this.scheduleWorkflow(workflow);\r\n      }\r\n    });\r\n  }\r\n\r\n  private scheduleWorkflow(workflow: OptimizationWorkflow): void {\r\n    // In a real implementation, this would use a proper cron scheduler\r\n    const intervalMs = this.parseFrequency(workflow.trigger.frequency || '0 0 * * *');\r\n\r\n    setInterval(async () => {\r\n      try {\r\n        if (workflow.status === 'active') {\r\n          await this.executeWorkflow(workflow.id);\r\n        }\r\n      } catch (error) {\r\n        console.error(`Scheduled workflow execution failed for ${workflow.id}:`, error);\r\n      }\r\n    }, intervalMs);\r\n  }\r\n\r\n  private parseFrequency(cronExpression: string): number {\r\n    // Simplified cron parsing - returns interval in milliseconds\r\n    // In production, use a proper cron parser\r\n    const patterns = {\r\n      '0 */6 * * *': 6 * 60 * 60 * 1000,     // Every 6 hours\r\n      '0 0 * * 1': 7 * 24 * 60 * 60 * 1000,  // Weekly\r\n      '0 0 1 * *': 30 * 24 * 60 * 60 * 1000  // Monthly\r\n    };\r\n\r\n    return patterns[cronExpression as keyof typeof patterns] || 24 * 60 * 60 * 1000; // Default daily\r\n  }\r\n\r\n  stopAutomation(): void {\r\n    this.isRunning = false;\r\n    console.log('Automated optimization workflows stopped');\r\n  }\r\n\r\n  getActiveWorkflows(): OptimizationWorkflow[] {\r\n    return Array.from(this.workflows.values()).filter(w => w.status === 'active');\r\n  }\r\n\r\n  getWorkflowPerformance(): Array<{\r\n    workflowId: string;\r\n    name: string;\r\n    executions: number;\r\n    successRate: number;\r\n    totalSavings: number;\r\n    lastExecution?: Date;\r\n  }> {\r\n    return Array.from(this.workflows.values()).map(workflow => ({\r\n      workflowId: workflow.id,\r\n      name: workflow.name,\r\n      executions: workflow.performance.executionCount,\r\n      successRate: workflow.performance.successRate,\r\n      totalSavings: workflow.performance.costSavings,\r\n      lastExecution: workflow.performance.lastExecution\r\n    }));\r\n  }\r\n}\r\n\r\n// Export automated optimization systems\r\nexport const automatedOptimization = {\r\n  workflowEngine: (db: Pool) => new AutomatedWorkflowEngine(db),\r\n  inventoryOptimizer: (db: Pool) => new AutomatedInventoryOptimizer(db),\r\n  supplierSelector: (db: Pool) => new AutomatedSupplierSelector(db),\r\n  decisionSupport: (db: Pool) => new DecisionSupportSystem(db)\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\data-processor.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Analytics Data Processing Utilities\r\nexport interface TimeSeriesData {\r\n  period: string\r\n  value: number\r\n  change?: number\r\n  target?: number\r\n}\r\n\r\nexport interface ComparisonData {\r\n  current: number\r\n  previous: number\r\n  target?: number\r\n  change: number\r\n  changePercent: number\r\n}\r\n\r\nexport class AnalyticsDataProcessor {\r\n  static calculateGrowthRate(current: number, previous: number): number {\r\n    if (previous === 0) return current > 0 ? 100 : 0\r\n    return ((current - previous) / previous) * 100\r\n  }\r\n\r\n  static calculateVariance(actual: number, target: number): number {\r\n    if (target === 0) return 0\r\n    return ((actual - target) / target) * 100\r\n  }\r\n\r\n  static calculateMovingAverage(data: number[], window: number): number[] {\r\n    const result: number[] = []\r\n    for (let i = 0; i < data.length; i++) {\r\n      const start = Math.max(0, i - window + 1)\r\n      const slice = data.slice(start, i + 1)\r\n      const avg = slice.reduce((sum, val) => sum + val, 0) / slice.length\r\n      result.push(avg)\r\n    }\r\n    return result\r\n  }\r\n\r\n  static calculateTrend(data: number[]): 'increasing' | 'decreasing' | 'stable' {\r\n    if (data.length < 2) return 'stable'\r\n\r\n    const changes = []\r\n    for (let i = 1; i < data.length; i++) {\r\n      changes.push(data[i] - data[i - 1])\r\n    }\r\n\r\n    const totalChange = changes.reduce((sum, change) => sum + change, 0)\r\n    const threshold = Math.abs(data[0] * 0.05) // 5% threshold\r\n\r\n    if (totalChange > threshold) return 'increasing'\r\n    if (totalChange < -threshold) return 'decreasing'\r\n    return 'stable'\r\n  }\r\n\r\n  static processSpendAnalysis(rawData: any[]): {\r\n    monthlySpend: TimeSeriesData[]\r\n    totalSpend: ComparisonData\r\n    topCategories: Array<{ category: string; amount: number; percentage: number }>\r\n    budgetVariance: number\r\n  } {\r\n    const currentYearTotal = rawData.reduce((sum, item) => sum + item.currentYear, 0)\r\n    const previousYearTotal = rawData.reduce((sum, item) => sum + item.previousYear, 0)\r\n    const budgetTotal = rawData.reduce((sum, item) => sum + item.budget, 0)\r\n\r\n    const monthlySpend = rawData.map(item => ({\r\n      period: item.month,\r\n      value: item.currentYear,\r\n      change: this.calculateGrowthRate(item.currentYear, item.previousYear),\r\n      target: item.budget\r\n    }))\r\n\r\n    const totalSpend = {\r\n      current: currentYearTotal,\r\n      previous: previousYearTotal,\r\n      target: budgetTotal,\r\n      change: currentYearTotal - previousYearTotal,\r\n      changePercent: this.calculateGrowthRate(currentYearTotal, previousYearTotal)\r\n    }\r\n\r\n    // Mock category data - in real implementation, this would come from actual category breakdown\r\n    const topCategories = [\r\n      { category: 'IT & Technology', amount: currentYearTotal * 0.32, percentage: 32 },\r\n      { category: 'Manufacturing', amount: currentYearTotal * 0.25, percentage: 25 },\r\n      { category: 'Services', amount: currentYearTotal * 0.20, percentage: 20 },\r\n      { category: 'Raw Materials', amount: currentYearTotal * 0.13, percentage: 13 },\r\n      { category: 'Logistics', amount: currentYearTotal * 0.10, percentage: 10 }\r\n    ]\r\n\r\n    const budgetVariance = this.calculateVariance(currentYearTotal, budgetTotal)\r\n\r\n    return {\r\n      monthlySpend,\r\n      totalSpend,\r\n      topCategories,\r\n      budgetVariance\r\n    }\r\n  }\r\n\r\n  static processSupplierMetrics(supplierData: any[]): {\r\n    averageRating: number\r\n    onTimePerformance: number\r\n    qualityScore: number\r\n    riskDistribution: { low: number; medium: number; high: number }\r\n    topPerformers: any[]\r\n    underperformers: any[]\r\n  } {\r\n    const totalSuppliers = supplierData.length\r\n\r\n    const averageRating = supplierData.reduce((sum, s) => sum + s.rating, 0) / totalSuppliers\r\n    const onTimePerformance = supplierData.reduce((sum, s) => sum + s.onTime, 0) / totalSuppliers\r\n    const qualityScore = supplierData.reduce((sum, s) => sum + s.quality, 0) / totalSuppliers\r\n\r\n    const riskCounts = supplierData.reduce((acc, s) => {\r\n      acc[s.risk.toLowerCase()]++\r\n      return acc\r\n    }, { low: 0, medium: 0, high: 0 })\r\n\r\n    const riskDistribution = {\r\n      low: (riskCounts.low / totalSuppliers) * 100,\r\n      medium: (riskCounts.medium / totalSuppliers) * 100,\r\n      high: (riskCounts.high / totalSuppliers) * 100\r\n    }\r\n\r\n    // Top performers: rating > 4.5 AND on-time > 90% AND quality > 95%\r\n    const topPerformers = supplierData.filter(s =>\r\n      s.rating > 4.5 && s.onTime > 90 && s.quality > 95\r\n    ).sort((a, b) => b.rating - a.rating)\r\n\r\n    // Underperformers: rating < 4.0 OR on-time < 85% OR quality < 90%\r\n    const underperformers = supplierData.filter(s =>\r\n      s.rating < 4.0 || s.onTime < 85 || s.quality < 90\r\n    ).sort((a, b) => a.rating - b.rating)\r\n\r\n    return {\r\n      averageRating,\r\n      onTimePerformance,\r\n      qualityScore,\r\n      riskDistribution,\r\n      topPerformers,\r\n      underperformers\r\n    }\r\n  }\r\n\r\n  static processSavingsAnalysis(savingsData: any[]): {\r\n    totalSavings: number\r\n    savingsByType: { [key: string]: number }\r\n    targetAchievement: number\r\n    trend: 'increasing' | 'decreasing' | 'stable'\r\n    projectedAnnualSavings: number\r\n  } {\r\n    const totalSavings = savingsData.reduce((sum, item) =>\r\n      sum + item.negotiated + item.processImprovement + item.volumeDiscount + item.alternativeSource, 0\r\n    )\r\n\r\n    const savingsByType = savingsData.reduce((acc, item) => {\r\n      acc.negotiated += item.negotiated\r\n      acc.processImprovement += item.processImprovement\r\n      acc.volumeDiscount += item.volumeDiscount\r\n      acc.alternativeSource += item.alternativeSource\r\n      return acc\r\n    }, { negotiated: 0, processImprovement: 0, volumeDiscount: 0, alternativeSource: 0 })\r\n\r\n    const totalTarget = savingsData.reduce((sum, item) => sum + item.target, 0)\r\n    const targetAchievement = (totalSavings / totalTarget) * 100\r\n\r\n    const monthlySavings = savingsData.map(item =>\r\n      item.negotiated + item.processImprovement + item.volumeDiscount + item.alternativeSource\r\n    )\r\n    const trend = this.calculateTrend(monthlySavings)\r\n\r\n    // Simple projection based on average monthly savings\r\n    const avgMonthlySavings = totalSavings / savingsData.length\r\n    const projectedAnnualSavings = avgMonthlySavings * 12\r\n\r\n    return {\r\n      totalSavings,\r\n      savingsByType,\r\n      targetAchievement,\r\n      trend,\r\n      projectedAnnualSavings\r\n    }\r\n  }\r\n\r\n  static processRiskAnalysis(riskData: any[]): {\r\n    overallRiskScore: number\r\n    criticalRisks: number\r\n    riskTrends: { improving: number; stable: number; worsening: number }\r\n    riskByCategory: { [key: string]: { score: number; trend: number } }\r\n    priorityActions: string[]\r\n  } {\r\n    const totalScore = riskData.reduce((sum, risk) => sum + risk.score, 0)\r\n    const overallRiskScore = totalScore / riskData.length\r\n\r\n    const criticalRisks = riskData.reduce((sum, risk) => sum + risk.critical, 0)\r\n\r\n    const riskTrends = riskData.reduce((acc, risk) => {\r\n      if (risk.trend < -5) acc.improving++\r\n      else if (risk.trend > 5) acc.worsening++\r\n      else acc.stable++\r\n      return acc\r\n    }, { improving: 0, stable: 0, worsening: 0 })\r\n\r\n    const riskByCategory = riskData.reduce((acc, risk) => {\r\n      acc[risk.category] = { score: risk.score, trend: risk.trend }\r\n      return acc\r\n    }, {} as { [key: string]: { score: number; trend: number } })\r\n\r\n    // Generate priority actions based on risk scores and trends\r\n    const priorityActions = []\r\n    riskData.forEach(risk => {\r\n      if (risk.score > 35) {\r\n        priorityActions.push(`Address high ${risk.category.toLowerCase()} risk (Score: ${risk.score})`)\r\n      }\r\n      if (risk.trend > 10) {\r\n        priorityActions.push(`Monitor worsening trend in ${risk.category.toLowerCase()}`)\r\n      }\r\n      if (risk.critical > 3) {\r\n        priorityActions.push(`Urgent: Resolve ${risk.critical} critical ${risk.category.toLowerCase()} issues`)\r\n      }\r\n    })\r\n\r\n    return {\r\n      overallRiskScore,\r\n      criticalRisks,\r\n      riskTrends,\r\n      riskByCategory,\r\n      priorityActions: priorityActions.slice(0, 5) // Top 5 priority actions\r\n    }\r\n  }\r\n\r\n  static generateInsights(data: any): string[] {\r\n    const insights = []\r\n\r\n    // Spend insights\r\n    if (data.spendData) {\r\n      const variance = this.calculateVariance(data.spendData.totalSpend.current, data.spendData.totalSpend.target)\r\n      if (variance > 10) {\r\n        insights.push(`Spending is ${variance.toFixed(1)}% over budget - consider cost reduction initiatives`)\r\n      } else if (variance < -5) {\r\n        insights.push(`Spending is ${Math.abs(variance).toFixed(1)}% under budget - potential for strategic investments`)\r\n      }\r\n    }\r\n\r\n    // Supplier insights\r\n    if (data.supplierMetrics) {\r\n      if (data.supplierMetrics.riskDistribution.high > 20) {\r\n        insights.push(`${data.supplierMetrics.riskDistribution.high.toFixed(1)}% of suppliers are high-risk - diversification recommended`)\r\n      }\r\n      if (data.supplierMetrics.onTimePerformance < 90) {\r\n        insights.push(`On-time delivery at ${data.supplierMetrics.onTimePerformance.toFixed(1)}% - supplier performance improvement needed`)\r\n      }\r\n    }\r\n\r\n    // Savings insights\r\n    if (data.savingsAnalysis) {\r\n      if (data.savingsAnalysis.targetAchievement < 80) {\r\n        insights.push(`Savings target achievement at ${data.savingsAnalysis.targetAchievement.toFixed(1)}% - enhance savings initiatives`)\r\n      }\r\n      if (data.savingsAnalysis.trend === 'decreasing') {\r\n        insights.push('Declining savings trend detected - review and optimize procurement strategies')\r\n      }\r\n    }\r\n\r\n    // Risk insights\r\n    if (data.riskAnalysis) {\r\n      if (data.riskAnalysis.overallRiskScore > 30) {\r\n        insights.push(`Overall risk score of ${data.riskAnalysis.overallRiskScore.toFixed(1)} is elevated - implement risk mitigation measures`)\r\n      }\r\n      if (data.riskAnalysis.criticalRisks > 10) {\r\n        insights.push(`${data.riskAnalysis.criticalRisks} critical risks identified - immediate action required`)\r\n      }\r\n    }\r\n\r\n    return insights.slice(0, 6) // Return top 6 insights\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\enhanced-analytics-dashboard.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":200,"column":32,"nodeType":"TemplateLiteral","endLine":211,"endColumn":6},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":1024,"column":19,"nodeType":"TemplateLiteral","endLine":1033,"endColumn":6},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":1042,"column":19,"nodeType":"TemplateLiteral","endLine":1054,"endColumn":6}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Enhanced Analytics Dashboard with AI Insights\r\n// Provides intelligent, context-aware dashboard components with advanced visualizations\r\n\r\nimport { Pool } from 'pg';\r\n\r\n// Types for Enhanced Dashboard\r\nexport interface AIInsight {\r\n  id: string;\r\n  type: 'trend' | 'anomaly' | 'opportunity' | 'risk' | 'prediction' | 'recommendation';\r\n  title: string;\r\n  description: string;\r\n  confidence: number;\r\n  priority: 'low' | 'medium' | 'high' | 'critical';\r\n  category: 'financial' | 'operational' | 'strategic' | 'quality' | 'compliance';\r\n\r\n  data: {\r\n    currentValue: number;\r\n    previousValue?: number;\r\n    trend: 'increasing' | 'decreasing' | 'stable';\r\n    changePercent: number;\r\n    context: Record<string, any>;\r\n  };\r\n\r\n  visualization: {\r\n    type: 'chart' | 'gauge' | 'heatmap' | 'sparkline' | 'metric';\r\n    config: Record<string, any>;\r\n    data: any[];\r\n  };\r\n\r\n  actionable: {\r\n    canAct: boolean;\r\n    suggestedActions: string[];\r\n    potentialImpact: string;\r\n    timeline: string;\r\n  };\r\n\r\n  metadata: {\r\n    source: string;\r\n    lastUpdated: Date;\r\n    refreshInterval: number;\r\n    accuracy: number;\r\n  };\r\n}\r\n\r\nexport interface DashboardWidget {\r\n  id: string;\r\n  title: string;\r\n  type: 'kpi' | 'chart' | 'table' | 'insight' | 'alert' | 'recommendation';\r\n  size: 'small' | 'medium' | 'large' | 'xl';\r\n  position: { x: number; y: number; w: number; h: number };\r\n\r\n  configuration: {\r\n    dataSource: string;\r\n    filters: Record<string, any>;\r\n    refreshInterval: number;\r\n    displayOptions: Record<string, any>;\r\n  };\r\n\r\n  permissions: {\r\n    view: string[];\r\n    edit: string[];\r\n    export: string[];\r\n  };\r\n\r\n  analytics: {\r\n    model?: string;\r\n    aiEnabled: boolean;\r\n    insights: AIInsight[];\r\n    predictions?: any[];\r\n  };\r\n\r\n  performance: {\r\n    loadTime: number;\r\n    lastRefresh: Date;\r\n    errorCount: number;\r\n    dataQuality: number;\r\n  };\r\n}\r\n\r\nexport interface SmartDashboard {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  organizationId: string;\r\n\r\n  layout: {\r\n    type: 'grid' | 'free' | 'responsive';\r\n    theme: 'light' | 'dark' | 'auto';\r\n    breakpoints: Record<string, number>;\r\n  };\r\n\r\n  widgets: DashboardWidget[];\r\n\r\n  intelligence: {\r\n    autoInsights: boolean;\r\n    adaptiveLayout: boolean;\r\n    personalizedContent: boolean;\r\n    aiRecommendations: boolean;\r\n    anomalyDetection: boolean;\r\n  };\r\n\r\n  sharing: {\r\n    isPublic: boolean;\r\n    shareUrl?: string;\r\n    allowedUsers: string[];\r\n    exportFormats: string[];\r\n  };\r\n\r\n  metadata: {\r\n    createdBy: string;\r\n    createdAt: Date;\r\n    lastModified: Date;\r\n    version: number;\r\n    tags: string[];\r\n  };\r\n}\r\n\r\nexport interface DashboardMetrics {\r\n  performance: {\r\n    avgLoadTime: number;\r\n    dataFreshness: number;\r\n    errorRate: number;\r\n    userSatisfaction: number;\r\n  };\r\n\r\n  usage: {\r\n    totalViews: number;\r\n    uniqueUsers: number;\r\n    avgSessionDuration: number;\r\n    interactionRate: number;\r\n    exportCount: number;\r\n  };\r\n\r\n  intelligence: {\r\n    insightsGenerated: number;\r\n    predictionsAccuracy: number;\r\n    anomaliesDetected: number;\r\n    recommendationsActioned: number;\r\n  };\r\n}\r\n\r\n// AI Insights Generator\r\nexport class AIInsightsGenerator {\r\n  private db: Pool;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n  }\r\n\r\n  async generateInsights(\r\n    organizationId: string,\r\n    context: {\r\n      timeRange?: string;\r\n      categories?: string[];\r\n      priority?: string;\r\n      limit?: number;\r\n    } = {}\r\n  ): Promise<AIInsight[]> {\r\n    const insights: AIInsight[] = [];\r\n\r\n    try {\r\n      // Generate different types of insights\r\n      const [\r\n        trendInsights,\r\n        anomalyInsights,\r\n        opportunityInsights,\r\n        riskInsights,\r\n        predictionInsights\r\n      ] = await Promise.all([\r\n        this.generateTrendInsights(organizationId, context),\r\n        this.generateAnomalyInsights(organizationId, context),\r\n        this.generateOpportunityInsights(organizationId, context),\r\n        this.generateRiskInsights(organizationId, context),\r\n        this.generatePredictionInsights(organizationId, context)\r\n      ]);\r\n\r\n      insights.push(...trendInsights, ...anomalyInsights, ...opportunityInsights,\r\n                   ...riskInsights, ...predictionInsights);\r\n\r\n      // Sort by priority and confidence\r\n      return insights\r\n        .sort((a, b) => {\r\n          const priorityWeight = { critical: 4, high: 3, medium: 2, low: 1 };\r\n          const aScore = priorityWeight[a.priority] * a.confidence;\r\n          const bScore = priorityWeight[b.priority] * b.confidence;\r\n          return bScore - aScore;\r\n        })\r\n        .slice(0, context.limit || 20);\r\n\r\n    } catch (error) {\r\n      console.error('Error generating AI insights:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private async generateTrendInsights(organizationId: string, context: any): Promise<AIInsight[]> {\r\n    const insights: AIInsight[] = [];\r\n\r\n    // Supplier performance trends\r\n    const supplierTrendQuery = `\r\n      SELECT\r\n        DATE_TRUNC('month', evaluation_date) as month,\r\n        AVG(overall_rating) as avg_rating,\r\n        COUNT(*) as evaluation_count\r\n      FROM supplier_performance sp\r\n      JOIN suppliers s ON sp.supplier_id = s.id\r\n      WHERE s.organization_id = $1\r\n      AND evaluation_date >= NOW() - INTERVAL '6 months'\r\n      GROUP BY DATE_TRUNC('month', evaluation_date)\r\n      ORDER BY month\r\n    `;\r\n\r\n    const supplierTrendResult = await this.db.query(supplierTrendQuery, [organizationId]);\r\n\r\n    if (supplierTrendResult.rows.length >= 3) {\r\n      const data = supplierTrendResult.rows;\r\n      const recent = data.slice(-2);\r\n      const trend = this.calculateTrend(recent.map(r => r.avg_rating));\r\n      const changePercent = ((recent[1].avg_rating - recent[0].avg_rating) / recent[0].avg_rating) * 100;\r\n\r\n      if (Math.abs(changePercent) > 5) {\r\n        insights.push({\r\n          id: `trend_supplier_${Date.now()}`,\r\n          type: 'trend',\r\n          title: `Supplier Performance ${trend === 'increasing' ? 'Improving' : 'Declining'}`,\r\n          description: `Overall supplier performance has ${trend === 'increasing' ? 'improved' : 'declined'} by ${Math.abs(changePercent).toFixed(1)}% over the last month`,\r\n          confidence: 0.85,\r\n          priority: Math.abs(changePercent) > 15 ? 'high' : 'medium',\r\n          category: 'operational',\r\n\r\n          data: {\r\n            currentValue: recent[1].avg_rating,\r\n            previousValue: recent[0].avg_rating,\r\n            trend: trend as any,\r\n            changePercent,\r\n            context: { evaluationCount: recent[1].evaluation_count }\r\n          },\r\n\r\n          visualization: {\r\n            type: 'chart',\r\n            config: { chartType: 'line', showTrend: true },\r\n            data: data.map(d => ({ x: d.month, y: d.avg_rating }))\r\n          },\r\n\r\n          actionable: {\r\n            canAct: true,\r\n            suggestedActions: trend === 'decreasing' ?\r\n              ['Review underperforming suppliers', 'Implement supplier development program'] :\r\n              ['Recognize top performers', 'Expand partnerships with high performers'],\r\n            potentialImpact: 'Improved supplier relationships and cost savings',\r\n            timeline: '2-4 weeks'\r\n          },\r\n\r\n          metadata: {\r\n            source: 'supplier_performance_analysis',\r\n            lastUpdated: new Date(),\r\n            refreshInterval: 3600000, // 1 hour\r\n            accuracy: 0.85\r\n          }\r\n        });\r\n      }\r\n    }\r\n\r\n    // Inventory turnover trends\r\n    const inventoryTrendQuery = `\r\n      SELECT\r\n        ii.category,\r\n        COUNT(*) as item_count,\r\n        AVG(\r\n          CASE\r\n            WHEN ii.current_stock > 0 THEN\r\n              (SELECT COALESCE(SUM(quantity), 0)\r\n               FROM stock_movements sm\r\n               WHERE sm.item_id = ii.id\r\n               AND sm.type = 'outbound'\r\n               AND sm.timestamp >= NOW() - INTERVAL '30 days') / ii.current_stock\r\n            ELSE 0\r\n          END\r\n        ) as avg_turnover\r\n      FROM public.inventory_items ii\r\n      WHERE ii.organization_id = $1\r\n      GROUP BY ii.category\r\n      HAVING COUNT(*) >= 5\r\n      ORDER BY avg_turnover DESC\r\n    `;\r\n\r\n    const inventoryTrendResult = await this.db.query(inventoryTrendQuery, [organizationId]);\r\n\r\n    inventoryTrendResult.rows.forEach(row => {\r\n      if (row.avg_turnover > 0.5) { // High turnover\r\n        insights.push({\r\n          id: `trend_inventory_${row.category}_${Date.now()}`,\r\n          type: 'trend',\r\n          title: `High Inventory Turnover in ${row.category}`,\r\n          description: `${row.category} category shows high inventory turnover of ${row.avg_turnover.toFixed(2)}x`,\r\n          confidence: 0.8,\r\n          priority: 'medium',\r\n          category: 'operational',\r\n\r\n          data: {\r\n            currentValue: row.avg_turnover,\r\n            trend: 'increasing' as any,\r\n            changePercent: 0,\r\n            context: { itemCount: row.item_count, category: row.category }\r\n          },\r\n\r\n          visualization: {\r\n            type: 'gauge',\r\n            config: { min: 0, max: 2, target: 1 },\r\n            data: [{ value: row.avg_turnover, label: 'Turnover Rate' }]\r\n          },\r\n\r\n          actionable: {\r\n            canAct: true,\r\n            suggestedActions: ['Review reorder points', 'Consider JIT inventory', 'Optimize supplier lead times'],\r\n            potentialImpact: 'Reduced carrying costs and improved cash flow',\r\n            timeline: '2-3 weeks'\r\n          },\r\n\r\n          metadata: {\r\n            source: 'inventory_turnover_analysis',\r\n            lastUpdated: new Date(),\r\n            refreshInterval: 7200000, // 2 hours\r\n            accuracy: 0.8\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    return insights;\r\n  }\r\n\r\n  private async generateAnomalyInsights(organizationId: string, context: any): Promise<AIInsight[]> {\r\n    const insights: AIInsight[] = [];\r\n\r\n    // Detect price anomalies\r\n    const priceAnomalyQuery = `\r\n      SELECT\r\n        ii.id,\r\n        ii.name,\r\n        ii.sku,\r\n        ii.category,\r\n        recent_prices.current_price,\r\n        historical_prices.avg_price,\r\n        historical_prices.price_volatility\r\n      FROM public.inventory_items ii\r\n      JOIN (\r\n        SELECT\r\n          item_id,\r\n          AVG(unit_cost) as current_price\r\n        FROM stock_movements\r\n        WHERE timestamp >= NOW() - INTERVAL '7 days'\r\n        AND unit_cost IS NOT NULL\r\n        GROUP BY item_id\r\n      ) recent_prices ON ii.id = recent_prices.item_id\r\n      JOIN (\r\n        SELECT\r\n          item_id,\r\n          AVG(unit_cost) as avg_price,\r\n          STDDEV(unit_cost) as price_volatility\r\n        FROM stock_movements\r\n        WHERE timestamp >= NOW() - INTERVAL '90 days'\r\n        AND timestamp < NOW() - INTERVAL '7 days'\r\n        AND unit_cost IS NOT NULL\r\n        GROUP BY item_id\r\n        HAVING COUNT(*) >= 10\r\n      ) historical_prices ON ii.id = historical_prices.item_id\r\n      WHERE ii.organization_id = $1\r\n      AND ABS(recent_prices.current_price - historical_prices.avg_price) >\r\n          (historical_prices.price_volatility * 2)\r\n    `;\r\n\r\n    const priceAnomalyResult = await this.db.query(priceAnomalyQuery, [organizationId]);\r\n\r\n    priceAnomalyResult.rows.forEach(row => {\r\n      const deviation = Math.abs(row.current_price - row.avg_price) / row.avg_price * 100;\r\n      const isIncrease = row.current_price > row.avg_price;\r\n\r\n      insights.push({\r\n        id: `anomaly_price_${row.id}_${Date.now()}`,\r\n        type: 'anomaly',\r\n        title: `Price ${isIncrease ? 'Spike' : 'Drop'} Detected: ${row.name}`,\r\n        description: `${row.name} price has ${isIncrease ? 'increased' : 'decreased'} by ${deviation.toFixed(1)}% from historical average`,\r\n        confidence: 0.9,\r\n        priority: deviation > 30 ? 'high' : 'medium',\r\n        category: 'financial',\r\n\r\n        data: {\r\n          currentValue: row.current_price,\r\n          previousValue: row.avg_price,\r\n          trend: isIncrease ? 'increasing' : 'decreasing' as any,\r\n          changePercent: isIncrease ? deviation : -deviation,\r\n          context: {\r\n            sku: row.sku,\r\n            category: row.category,\r\n            volatility: row.price_volatility\r\n          }\r\n        },\r\n\r\n        visualization: {\r\n          type: 'sparkline',\r\n          config: { showThreshold: true, threshold: row.avg_price },\r\n          data: [\r\n            { x: 'Historical Avg', y: row.avg_price },\r\n            { x: 'Current', y: row.current_price }\r\n          ]\r\n        },\r\n\r\n        actionable: {\r\n          canAct: true,\r\n          suggestedActions: [\r\n            'Verify price change with supplier',\r\n            'Check for market conditions impact',\r\n            'Review contract terms',\r\n            'Consider alternative suppliers'\r\n          ],\r\n          potentialImpact: isIncrease ? 'Cost increase mitigation' : 'Potential cost savings opportunity',\r\n          timeline: '1-2 days'\r\n        },\r\n\r\n        metadata: {\r\n          source: 'price_anomaly_detection',\r\n          lastUpdated: new Date(),\r\n          refreshInterval: 3600000, // 1 hour\r\n          accuracy: 0.9\r\n        }\r\n      });\r\n    });\r\n\r\n    return insights;\r\n  }\r\n\r\n  private async generateOpportunityInsights(organizationId: string, context: any): Promise<AIInsight[]> {\r\n    const insights: AIInsight[] = [];\r\n\r\n    // Volume discount opportunities\r\n    const volumeOpportunityQuery = `\r\n      SELECT\r\n        s.id as supplier_id,\r\n        s.name as supplier_name,\r\n        COUNT(DISTINCT po.id) as order_count,\r\n        SUM(po.total_amount) as total_spend,\r\n        AVG(po.total_amount) as avg_order_value\r\n      FROM public.suppliers s\r\n      JOIN purchase_orders po ON s.id = po.supplier_id\r\n      WHERE s.organization_id = $1\r\n      AND po.order_date >= NOW() - INTERVAL '6 months'\r\n      GROUP BY s.id, s.name\r\n      HAVING COUNT(DISTINCT po.id) >= 5 AND SUM(po.total_amount) > 50000\r\n      ORDER BY SUM(po.total_amount) DESC\r\n    `;\r\n\r\n    const volumeOpportunityResult = await this.db.query(volumeOpportunityQuery, [organizationId]);\r\n\r\n    volumeOpportunityResult.rows.slice(0, 3).forEach(row => {\r\n      const potentialSavings = row.total_spend * 0.05; // Assume 5% volume discount\r\n\r\n      insights.push({\r\n        id: `opportunity_volume_${row.supplier_id}_${Date.now()}`,\r\n        type: 'opportunity',\r\n        title: `Volume Discount Opportunity: ${row.supplier_name}`,\r\n        description: `High spend of $${row.total_spend.toLocaleString()} with ${row.supplier_name} presents volume discount opportunity`,\r\n        confidence: 0.75,\r\n        priority: potentialSavings > 5000 ? 'high' : 'medium',\r\n        category: 'financial',\r\n\r\n        data: {\r\n          currentValue: row.total_spend,\r\n          trend: 'stable' as any,\r\n          changePercent: 0,\r\n          context: {\r\n            orderCount: row.order_count,\r\n            avgOrderValue: row.avg_order_value,\r\n            potentialSavings\r\n          }\r\n        },\r\n\r\n        visualization: {\r\n          type: 'metric',\r\n          config: { format: 'currency', target: potentialSavings },\r\n          data: [{ label: 'Potential Savings', value: potentialSavings }]\r\n        },\r\n\r\n        actionable: {\r\n          canAct: true,\r\n          suggestedActions: [\r\n            'Negotiate volume discount terms',\r\n            'Consolidate orders to increase volume',\r\n            'Propose annual contract with guaranteed volumes',\r\n            'Review competitor pricing for leverage'\r\n          ],\r\n          potentialImpact: `Potential annual savings of $${potentialSavings.toLocaleString()}`,\r\n          timeline: '2-4 weeks'\r\n        },\r\n\r\n        metadata: {\r\n          source: 'volume_discount_analysis',\r\n          lastUpdated: new Date(),\r\n          refreshInterval: 86400000, // 24 hours\r\n          accuracy: 0.75\r\n        }\r\n      });\r\n    });\r\n\r\n    return insights;\r\n  }\r\n\r\n  private async generateRiskInsights(organizationId: string, context: any): Promise<AIInsight[]> {\r\n    const insights: AIInsight[] = [];\r\n\r\n    // Single source dependency risk\r\n    const dependencyRiskQuery = `\r\n      SELECT\r\n        ii.category,\r\n        COUNT(*) as total_items,\r\n        COUNT(DISTINCT preferred_supplier_id) as supplier_count,\r\n        SUM(ii.current_stock * ii.unit_cost) as category_value\r\n      FROM public.inventory_items ii\r\n      WHERE ii.organization_id = $1\r\n      AND ii.preferred_supplier_id IS NOT NULL\r\n      GROUP BY ii.category\r\n      HAVING COUNT(*) >= 10 AND COUNT(DISTINCT preferred_supplier_id) = 1\r\n      ORDER BY SUM(ii.current_stock * ii.unit_cost) DESC\r\n    `;\r\n\r\n    const dependencyRiskResult = await this.db.query(dependencyRiskQuery, [organizationId]);\r\n\r\n    dependencyRiskResult.rows.forEach(row => {\r\n      insights.push({\r\n        id: `risk_dependency_${row.category}_${Date.now()}`,\r\n        type: 'risk',\r\n        title: `Single Supplier Dependency: ${row.category}`,\r\n        description: `${row.category} category ($${row.category_value.toLocaleString()}) depends on single supplier`,\r\n        confidence: 0.95,\r\n        priority: row.category_value > 100000 ? 'critical' : 'high',\r\n        category: 'strategic',\r\n\r\n        data: {\r\n          currentValue: 1, // Single supplier\r\n          trend: 'stable' as any,\r\n          changePercent: 0,\r\n          context: {\r\n            category: row.category,\r\n            itemCount: row.total_items,\r\n            categoryValue: row.category_value\r\n          }\r\n        },\r\n\r\n        visualization: {\r\n          type: 'gauge',\r\n          config: { min: 0, max: 5, target: 3, warningThreshold: 1 },\r\n          data: [{ value: 1, label: 'Supplier Count' }]\r\n        },\r\n\r\n        actionable: {\r\n          canAct: true,\r\n          suggestedActions: [\r\n            'Identify alternative suppliers',\r\n            'Conduct supplier market research',\r\n            'Develop backup supplier relationships',\r\n            'Implement dual sourcing strategy'\r\n          ],\r\n          potentialImpact: 'Reduced supply chain risk and improved negotiation power',\r\n          timeline: '4-8 weeks'\r\n        },\r\n\r\n        metadata: {\r\n          source: 'supplier_dependency_analysis',\r\n          lastUpdated: new Date(),\r\n          refreshInterval: 86400000, // 24 hours\r\n          accuracy: 0.95\r\n        }\r\n      });\r\n    });\r\n\r\n    return insights;\r\n  }\r\n\r\n  private async generatePredictionInsights(organizationId: string, context: any): Promise<AIInsight[]> {\r\n    const insights: AIInsight[] = [];\r\n\r\n    // Stockout prediction\r\n    const stockoutPredictionQuery = `\r\n      SELECT\r\n        ii.id,\r\n        ii.name,\r\n        ii.sku,\r\n        ii.current_stock,\r\n        ii.reorder_point,\r\n        demand_forecast.daily_demand,\r\n        lead_time.avg_lead_time\r\n      FROM public.inventory_items ii\r\n      JOIN (\r\n        SELECT\r\n          item_id,\r\n          AVG(quantity) as daily_demand\r\n        FROM stock_movements\r\n        WHERE type = 'outbound'\r\n        AND timestamp >= NOW() - INTERVAL '30 days'\r\n        GROUP BY item_id\r\n        HAVING AVG(quantity) > 0\r\n      ) demand_forecast ON ii.id = demand_forecast.item_id\r\n      LEFT JOIN (\r\n        SELECT\r\n          spl.sku,\r\n          AVG(s.lead_time_days) as avg_lead_time\r\n        FROM supplier_price_lists spl\r\n        JOIN suppliers s ON spl.supplier_id = s.id\r\n        GROUP BY spl.sku\r\n      ) lead_time ON ii.sku = lead_time.sku\r\n      WHERE ii.organization_id = $1\r\n      AND ii.current_stock > 0\r\n    `;\r\n\r\n    const stockoutPredictionResult = await this.db.query(stockoutPredictionQuery, [organizationId]);\r\n\r\n    stockoutPredictionResult.rows.forEach(row => {\r\n      const leadTime = row.avg_lead_time || 7;\r\n      const daysToStockout = row.current_stock / Math.max(row.daily_demand, 0.1);\r\n\r\n      if (daysToStockout <= leadTime * 1.5) { // Within 1.5x lead time\r\n        const urgency = daysToStockout <= leadTime ? 'critical' : 'high';\r\n\r\n        insights.push({\r\n          id: `prediction_stockout_${row.id}_${Date.now()}`,\r\n          type: 'prediction',\r\n          title: `Potential Stockout: ${row.name}`,\r\n          description: `${row.name} predicted to stock out in ${Math.round(daysToStockout)} days`,\r\n          confidence: 0.8,\r\n          priority: urgency,\r\n          category: 'operational',\r\n\r\n          data: {\r\n            currentValue: row.current_stock,\r\n            trend: 'decreasing' as any,\r\n            changePercent: -((leadTime - daysToStockout) / leadTime * 100),\r\n            context: {\r\n              sku: row.sku,\r\n              dailyDemand: row.daily_demand,\r\n              leadTime: leadTime,\r\n              daysToStockout: Math.round(daysToStockout)\r\n            }\r\n          },\r\n\r\n          visualization: {\r\n            type: 'gauge',\r\n            config: {\r\n              min: 0,\r\n              max: leadTime * 2,\r\n              target: leadTime,\r\n              warningThreshold: leadTime * 0.5\r\n            },\r\n            data: [{ value: daysToStockout, label: 'Days to Stockout' }]\r\n          },\r\n\r\n          actionable: {\r\n            canAct: true,\r\n            suggestedActions: [\r\n              'Place emergency order',\r\n              'Contact supplier for expedited delivery',\r\n              'Check alternative suppliers',\r\n              'Consider customer communication if stockout imminent'\r\n            ],\r\n            potentialImpact: 'Prevent stockout and maintain service levels',\r\n            timeline: urgency === 'critical' ? 'Immediate' : '1-2 days'\r\n          },\r\n\r\n          metadata: {\r\n            source: 'stockout_prediction_model',\r\n            lastUpdated: new Date(),\r\n            refreshInterval: 3600000, // 1 hour\r\n            accuracy: 0.8\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    return insights;\r\n  }\r\n\r\n  private calculateTrend(values: number[]): 'increasing' | 'decreasing' | 'stable' {\r\n    if (values.length < 2) return 'stable';\r\n\r\n    const first = values[0];\r\n    const last = values[values.length - 1];\r\n    const change = (last - first) / first;\r\n\r\n    if (change > 0.02) return 'increasing';\r\n    if (change < -0.02) return 'decreasing';\r\n    return 'stable';\r\n  }\r\n}\r\n\r\n// Smart Dashboard Manager\r\nexport class SmartDashboardManager {\r\n  private db: Pool;\r\n  private insightsGenerator: AIInsightsGenerator;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n    this.insightsGenerator = new AIInsightsGenerator(database);\r\n  }\r\n\r\n  async createDashboard(\r\n    name: string,\r\n    organizationId: string,\r\n    createdBy: string,\r\n    config: Partial<SmartDashboard> = {}\r\n  ): Promise<string> {\r\n    const dashboardId = `dashboard_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    const dashboard: SmartDashboard = {\r\n      id: dashboardId,\r\n      name,\r\n      description: config.description || '',\r\n      organizationId,\r\n\r\n      layout: config.layout || {\r\n        type: 'grid',\r\n        theme: 'light',\r\n        breakpoints: { sm: 576, md: 768, lg: 992, xl: 1200 }\r\n      },\r\n\r\n      widgets: config.widgets || (await this.generateDefaultWidgets(organizationId)),\r\n\r\n      intelligence: config.intelligence || {\r\n        autoInsights: true,\r\n        adaptiveLayout: false,\r\n        personalizedContent: true,\r\n        aiRecommendations: true,\r\n        anomalyDetection: true\r\n      },\r\n\r\n      sharing: config.sharing || {\r\n        isPublic: false,\r\n        allowedUsers: [],\r\n        exportFormats: ['pdf', 'excel', 'png']\r\n      },\r\n\r\n      metadata: {\r\n        createdBy,\r\n        createdAt: new Date(),\r\n        lastModified: new Date(),\r\n        version: 1,\r\n        tags: config.metadata?.tags || []\r\n      }\r\n    };\r\n\r\n    try {\r\n      await this.db.query(`\r\n        INSERT INTO smart_dashboards (\r\n          id, name, description, organization_id, layout, widgets,\r\n          intelligence, sharing, metadata, created_at\r\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\r\n      `, [\r\n        dashboard.id,\r\n        dashboard.name,\r\n        dashboard.description,\r\n        dashboard.organizationId,\r\n        JSON.stringify(dashboard.layout),\r\n        JSON.stringify(dashboard.widgets),\r\n        JSON.stringify(dashboard.intelligence),\r\n        JSON.stringify(dashboard.sharing),\r\n        JSON.stringify(dashboard.metadata),\r\n        dashboard.metadata.createdAt\r\n      ]);\r\n\r\n      return dashboardId;\r\n\r\n    } catch (error) {\r\n      console.error('Error creating dashboard:', error);\r\n      throw new Error('Failed to create dashboard');\r\n    }\r\n  }\r\n\r\n  private async generateDefaultWidgets(organizationId: string): Promise<DashboardWidget[]> {\r\n    const defaultWidgets: DashboardWidget[] = [\r\n      {\r\n        id: 'kpi_total_spend',\r\n        title: 'Total Spend',\r\n        type: 'kpi',\r\n        size: 'small',\r\n        position: { x: 0, y: 0, w: 3, h: 2 },\r\n        configuration: {\r\n          dataSource: 'purchase_orders',\r\n          filters: { timeRange: '30d' },\r\n          refreshInterval: 300000,\r\n          displayOptions: { format: 'currency', trend: true }\r\n        },\r\n        permissions: {\r\n          view: ['all'],\r\n          edit: ['admin', 'manager'],\r\n          export: ['admin', 'manager', 'analyst']\r\n        },\r\n        analytics: {\r\n          aiEnabled: true,\r\n          insights: [],\r\n          predictions: []\r\n        },\r\n        performance: {\r\n          loadTime: 0,\r\n          lastRefresh: new Date(),\r\n          errorCount: 0,\r\n          dataQuality: 1.0\r\n        }\r\n      },\r\n      {\r\n        id: 'chart_supplier_performance',\r\n        title: 'Supplier Performance Trends',\r\n        type: 'chart',\r\n        size: 'large',\r\n        position: { x: 3, y: 0, w: 6, h: 4 },\r\n        configuration: {\r\n          dataSource: 'supplier_performance',\r\n          filters: { timeRange: '6m' },\r\n          refreshInterval: 600000,\r\n          displayOptions: {\r\n            chartType: 'line',\r\n            metrics: ['overall_rating', 'on_time_delivery_rate', 'quality_acceptance_rate']\r\n          }\r\n        },\r\n        permissions: {\r\n          view: ['all'],\r\n          edit: ['admin', 'manager'],\r\n          export: ['all']\r\n        },\r\n        analytics: {\r\n          aiEnabled: true,\r\n          insights: [],\r\n          predictions: []\r\n        },\r\n        performance: {\r\n          loadTime: 0,\r\n          lastRefresh: new Date(),\r\n          errorCount: 0,\r\n          dataQuality: 1.0\r\n        }\r\n      },\r\n      {\r\n        id: 'insight_ai_recommendations',\r\n        title: 'AI Insights & Recommendations',\r\n        type: 'insight',\r\n        size: 'large',\r\n        position: { x: 9, y: 0, w: 3, h: 6 },\r\n        configuration: {\r\n          dataSource: 'ai_insights',\r\n          filters: { priority: ['high', 'critical'] },\r\n          refreshInterval: 300000,\r\n          displayOptions: { maxItems: 5, showActions: true }\r\n        },\r\n        permissions: {\r\n          view: ['all'],\r\n          edit: ['admin'],\r\n          export: ['admin', 'manager']\r\n        },\r\n        analytics: {\r\n          aiEnabled: true,\r\n          insights: [],\r\n          predictions: []\r\n        },\r\n        performance: {\r\n          loadTime: 0,\r\n          lastRefresh: new Date(),\r\n          errorCount: 0,\r\n          dataQuality: 1.0\r\n        }\r\n      },\r\n      {\r\n        id: 'table_top_suppliers',\r\n        title: 'Top Suppliers by Spend',\r\n        type: 'table',\r\n        size: 'medium',\r\n        position: { x: 0, y: 4, w: 6, h: 3 },\r\n        configuration: {\r\n          dataSource: 'suppliers_spend_ranking',\r\n          filters: { timeRange: '30d', limit: 10 },\r\n          refreshInterval: 900000,\r\n          displayOptions: {\r\n            columns: ['name', 'total_spend', 'performance_score', 'risk_level'],\r\n            sortBy: 'total_spend'\r\n          }\r\n        },\r\n        permissions: {\r\n          view: ['all'],\r\n          edit: ['admin', 'manager'],\r\n          export: ['all']\r\n        },\r\n        analytics: {\r\n          aiEnabled: false,\r\n          insights: []\r\n        },\r\n        performance: {\r\n          loadTime: 0,\r\n          lastRefresh: new Date(),\r\n          errorCount: 0,\r\n          dataQuality: 1.0\r\n        }\r\n      },\r\n      {\r\n        id: 'alert_anomalies',\r\n        title: 'Active Anomalies',\r\n        type: 'alert',\r\n        size: 'medium',\r\n        position: { x: 6, y: 4, w: 3, h: 3 },\r\n        configuration: {\r\n          dataSource: 'anomaly_alerts',\r\n          filters: { status: 'active', severity: ['medium', 'high', 'critical'] },\r\n          refreshInterval: 60000,\r\n          displayOptions: { groupBy: 'severity', showTimestamp: true }\r\n        },\r\n        permissions: {\r\n          view: ['all'],\r\n          edit: ['admin', 'manager'],\r\n          export: ['admin']\r\n        },\r\n        analytics: {\r\n          aiEnabled: true,\r\n          insights: []\r\n        },\r\n        performance: {\r\n          loadTime: 0,\r\n          lastRefresh: new Date(),\r\n          errorCount: 0,\r\n          dataQuality: 1.0\r\n        }\r\n      }\r\n    ];\r\n\r\n    return defaultWidgets;\r\n  }\r\n\r\n  async getDashboard(dashboardId: string): Promise<SmartDashboard | null> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT * FROM smart_dashboards WHERE id = $1\r\n      `, [dashboardId]);\r\n\r\n      if (result.rows.length === 0) return null;\r\n\r\n      const row = result.rows[0];\r\n      return {\r\n        id: row.id,\r\n        name: row.name,\r\n        description: row.description,\r\n        organizationId: row.organization_id,\r\n        layout: JSON.parse(row.layout),\r\n        widgets: JSON.parse(row.widgets),\r\n        intelligence: JSON.parse(row.intelligence),\r\n        sharing: JSON.parse(row.sharing),\r\n        metadata: JSON.parse(row.metadata)\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error fetching dashboard:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async updateWidgetData(\r\n    dashboardId: string,\r\n    widgetId: string,\r\n    organizationId: string\r\n  ): Promise<any> {\r\n    const dashboard = await this.getDashboard(dashboardId);\r\n    if (!dashboard) throw new Error('Dashboard not found');\r\n\r\n    const widget = dashboard.widgets.find(w => w.id === widgetId);\r\n    if (!widget) throw new Error('Widget not found');\r\n\r\n    try {\r\n      let data;\r\n      const startTime = Date.now();\r\n\r\n      switch (widget.configuration.dataSource) {\r\n        case 'purchase_orders':\r\n          data = await this.getPurchaseOrderData(organizationId, widget.configuration.filters);\r\n          break;\r\n        case 'supplier_performance':\r\n          data = await this.getSupplierPerformanceData(organizationId, widget.configuration.filters);\r\n          break;\r\n        case 'ai_insights':\r\n          data = await this.insightsGenerator.generateInsights(organizationId, widget.configuration.filters);\r\n          break;\r\n        case 'suppliers_spend_ranking':\r\n          data = await this.getSupplierSpendRanking(organizationId, widget.configuration.filters);\r\n          break;\r\n        case 'anomaly_alerts':\r\n          data = await this.getAnomalyAlerts(organizationId, widget.configuration.filters);\r\n          break;\r\n        default:\r\n          throw new Error(`Unsupported data source: ${widget.configuration.dataSource}`);\r\n      }\r\n\r\n      // Update widget performance metrics\r\n      widget.performance.loadTime = Date.now() - startTime;\r\n      widget.performance.lastRefresh = new Date();\r\n      widget.performance.dataQuality = this.calculateDataQuality(data);\r\n\r\n      // Generate AI insights if enabled\r\n      if (widget.analytics.aiEnabled) {\r\n        widget.analytics.insights = await this.generateWidgetInsights(widget, data);\r\n      }\r\n\r\n      return {\r\n        widget,\r\n        data,\r\n        metadata: {\r\n          loadTime: widget.performance.loadTime,\r\n          dataQuality: widget.performance.dataQuality,\r\n          lastRefresh: widget.performance.lastRefresh\r\n        }\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error(`Error updating widget data for ${widgetId}:`, error);\r\n      widget.performance.errorCount++;\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async getPurchaseOrderData(organizationId: string, filters: any): Promise<any> {\r\n    const timeRange = this.parseTimeRange(filters.timeRange || '30d');\r\n\r\n    const query = `\r\n      SELECT\r\n        SUM(total_amount) as total_spend,\r\n        COUNT(*) as order_count,\r\n        AVG(total_amount) as avg_order_value\r\n      FROM purchase_orders po\r\n      JOIN suppliers s ON po.supplier_id = s.id\r\n      WHERE s.organization_id = $1\r\n      AND po.order_date >= $2\r\n    `;\r\n\r\n    const result = await this.db.query(query, [organizationId, timeRange]);\r\n    return result.rows[0];\r\n  }\r\n\r\n  private async getSupplierPerformanceData(organizationId: string, filters: any): Promise<any> {\r\n    const timeRange = this.parseTimeRange(filters.timeRange || '6m');\r\n\r\n    const query = `\r\n      SELECT\r\n        DATE_TRUNC('month', sp.evaluation_date) as month,\r\n        AVG(sp.overall_rating) as avg_rating,\r\n        AVG(sp.on_time_delivery_rate) as avg_delivery,\r\n        AVG(sp.quality_acceptance_rate) as avg_quality\r\n      FROM supplier_performance sp\r\n      JOIN suppliers s ON sp.supplier_id = s.id\r\n      WHERE s.organization_id = $1\r\n      AND sp.evaluation_date >= $2\r\n      GROUP BY DATE_TRUNC('month', sp.evaluation_date)\r\n      ORDER BY month\r\n    `;\r\n\r\n    const result = await this.db.query(query, [organizationId, timeRange]);\r\n    return result.rows;\r\n  }\r\n\r\n  private async getSupplierSpendRanking(organizationId: string, filters: any): Promise<any> {\r\n    const timeRange = this.parseTimeRange(filters.timeRange || '30d');\r\n    const limit = filters.limit || 10;\r\n\r\n    const query = `\r\n      SELECT\r\n        s.name,\r\n        SUM(po.total_amount) as total_spend,\r\n        AVG(sp.overall_rating) as performance_score,\r\n        CASE\r\n          WHEN AVG(sp.overall_rating) >= 90 THEN 'Low'\r\n          WHEN AVG(sp.overall_rating) >= 75 THEN 'Medium'\r\n          ELSE 'High'\r\n        END as risk_level\r\n      FROM public.suppliers s\r\n      LEFT JOIN purchase_orders po ON s.id = po.supplier_id\r\n      LEFT JOIN supplier_performance sp ON s.id = sp.supplier_id\r\n      WHERE s.organization_id = $1\r\n      AND po.order_date >= $2\r\n      GROUP BY s.id, s.name\r\n      ORDER BY SUM(po.total_amount) DESC\r\n      LIMIT $3\r\n    `;\r\n\r\n    const result = await this.db.query(query, [organizationId, timeRange, limit]);\r\n    return result.rows;\r\n  }\r\n\r\n  private async getAnomalyAlerts(organizationId: string, filters: any): Promise<any> {\r\n    const severityFilter = filters.severity ? `AND severity = ANY($2)` : '';\r\n    const statusFilter = filters.status ? `AND status = $3` : '';\r\n\r\n    const query = `\r\n      SELECT\r\n        id,\r\n        type,\r\n        severity,\r\n        title,\r\n        description,\r\n        detected_at\r\n      FROM anomaly_alerts\r\n      WHERE organization_id = $1\r\n      ${severityFilter}\r\n      ${statusFilter}\r\n      ORDER BY detected_at DESC\r\n      LIMIT 20\r\n    `;\r\n\r\n    const params = [organizationId];\r\n    if (filters.severity) params.push(filters.severity);\r\n    if (filters.status) params.push(filters.status);\r\n\r\n    const result = await this.db.query(query, params);\r\n    return result.rows;\r\n  }\r\n\r\n  private parseTimeRange(timeRange: string): Date {\r\n    const now = new Date();\r\n    const ranges: Record<string, number> = {\r\n      '1d': 1,\r\n      '7d': 7,\r\n      '30d': 30,\r\n      '3m': 90,\r\n      '6m': 180,\r\n      '1y': 365\r\n    };\r\n\r\n    const days = ranges[timeRange] || 30;\r\n    return new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));\r\n  }\r\n\r\n  private calculateDataQuality(data: any): number {\r\n    if (!data) return 0;\r\n\r\n    if (Array.isArray(data)) {\r\n      if (data.length === 0) return 0.5;\r\n\r\n      const completeness = data.reduce((sum, item) => {\r\n        const fields = Object.values(item);\r\n        const nonNullFields = fields.filter(field => field !== null && field !== undefined);\r\n        return sum + (nonNullFields.length / fields.length);\r\n      }, 0) / data.length;\r\n\r\n      return Math.min(1, completeness);\r\n    }\r\n\r\n    // For single objects\r\n    const fields = Object.values(data);\r\n    const nonNullFields = fields.filter(field => field !== null && field !== undefined);\r\n    return nonNullFields.length / fields.length;\r\n  }\r\n\r\n  private async generateWidgetInsights(widget: DashboardWidget, data: any): Promise<AIInsight[]> {\r\n    // Generate insights specific to widget type and data\r\n    const insights: AIInsight[] = [];\r\n\r\n    // This would contain widget-specific insight generation logic\r\n    // For now, return empty array\r\n    return insights;\r\n  }\r\n\r\n  async getDashboardMetrics(dashboardId: string): Promise<DashboardMetrics> {\r\n    try {\r\n      const metricsQuery = `\r\n        SELECT\r\n          AVG(performance_data->>'loadTime') as avg_load_time,\r\n          AVG(performance_data->>'dataQuality') as avg_data_quality,\r\n          SUM((performance_data->>'errorCount')::int) as total_errors,\r\n          COUNT(*) as total_widgets\r\n        FROM dashboard_widget_metrics\r\n        WHERE dashboard_id = $1\r\n        AND created_at >= NOW() - INTERVAL '24 hours'\r\n      `;\r\n\r\n      const usageQuery = `\r\n        SELECT\r\n          COUNT(*) as total_views,\r\n          COUNT(DISTINCT user_id) as unique_users,\r\n          AVG(session_duration) as avg_session_duration\r\n        FROM dashboard_usage_logs\r\n        WHERE dashboard_id = $1\r\n        AND created_at >= NOW() - INTERVAL '24 hours'\r\n      `;\r\n\r\n      const [metricsResult, usageResult] = await Promise.all([\r\n        this.db.query(metricsQuery, [dashboardId]),\r\n        this.db.query(usageQuery, [dashboardId])\r\n      ]);\r\n\r\n      const metrics = metricsResult.rows[0];\r\n      const usage = usageResult.rows[0];\r\n\r\n      return {\r\n        performance: {\r\n          avgLoadTime: parseFloat(metrics.avg_load_time || '0'),\r\n          dataFreshness: 0.95, // Calculated based on refresh intervals\r\n          errorRate: metrics.total_errors / Math.max(metrics.total_widgets, 1),\r\n          userSatisfaction: 0.85 // Would be calculated from user feedback\r\n        },\r\n        usage: {\r\n          totalViews: parseInt(usage.total_views || '0'),\r\n          uniqueUsers: parseInt(usage.unique_users || '0'),\r\n          avgSessionDuration: parseFloat(usage.avg_session_duration || '0'),\r\n          interactionRate: 0.75, // Calculated from click/interaction events\r\n          exportCount: 0 // Would be tracked separately\r\n        },\r\n        intelligence: {\r\n          insightsGenerated: 15, // Would be counted from insights\r\n          predictionsAccuracy: 0.82,\r\n          anomaliesDetected: 3,\r\n          recommendationsActioned: 8\r\n        }\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error calculating dashboard metrics:', error);\r\n      throw new Error('Failed to calculate dashboard metrics');\r\n    }\r\n  }\r\n}\r\n\r\n// Export enhanced analytics dashboard\r\nexport const enhancedAnalyticsDashboard = {\r\n  insightsGenerator: (db: Pool) => new AIInsightsGenerator(db),\r\n  dashboardManager: (db: Pool) => new SmartDashboardManager(db)\r\n};","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\intelligent-recommendations.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Intelligent Recommendation Engine with Multi-Criteria Optimization\r\n// Implements advanced recommendation algorithms for procurement, inventory, and supplier decisions\r\n\r\nimport { Pool } from 'pg';\r\n\r\n// Types for Intelligent Recommendations\r\nexport interface MultiCriteriaWeights {\r\n  cost: number;\r\n  quality: number;\r\n  delivery: number;\r\n  sustainability: number;\r\n  risk: number;\r\n  innovation: number;\r\n}\r\n\r\nexport interface RecommendationCriteria {\r\n  weights: MultiCriteriaWeights;\r\n  constraints: {\r\n    maxBudget?: number;\r\n    maxRisk?: number;\r\n    minQuality?: number;\r\n    deliveryTime?: number;\r\n    sustainabilityRequired?: boolean;\r\n  };\r\n  preferences: {\r\n    preferredSuppliers?: string[];\r\n    avoidSuppliers?: string[];\r\n    preferredCategories?: string[];\r\n    mustHaveAttributes?: string[];\r\n  };\r\n}\r\n\r\nexport interface IntelligentRecommendation {\r\n  id: string;\r\n  type: 'supplier_selection' | 'inventory_optimization' | 'procurement_strategy' | 'cost_reduction' | 'risk_mitigation';\r\n  priority: 'critical' | 'high' | 'medium' | 'low';\r\n  title: string;\r\n  description: string;\r\n  rationale: string[];\r\n\r\n  recommendation: {\r\n    action: string;\r\n    targets: Array<{\r\n      id: string;\r\n      type: 'supplier' | 'item' | 'category' | 'contract';\r\n      name: string;\r\n      currentScore: number;\r\n      recommendedScore: number;\r\n    }>;\r\n    alternatives: Array<{\r\n      option: string;\r\n      score: number;\r\n      tradeoffs: string[];\r\n    }>;\r\n  };\r\n\r\n  impact: {\r\n    financial: {\r\n      costSavings: number;\r\n      revenueIncrease: number;\r\n      roi: number;\r\n    };\r\n    operational: {\r\n      efficiencyGain: number;\r\n      riskReduction: number;\r\n      qualityImprovement: number;\r\n    };\r\n    strategic: {\r\n      competitiveAdvantage: string;\r\n      futureValue: number;\r\n      alignment: number; // 0-1 with business goals\r\n    };\r\n  };\r\n\r\n  implementation: {\r\n    timeline: string;\r\n    complexity: 'low' | 'medium' | 'high';\r\n    resources: string[];\r\n    steps: Array<{\r\n      step: number;\r\n      action: string;\r\n      owner: string;\r\n      duration: string;\r\n      dependencies: string[];\r\n    }>;\r\n    risks: Array<{\r\n      risk: string;\r\n      probability: number;\r\n      impact: number;\r\n      mitigation: string;\r\n    }>;\r\n  };\r\n\r\n  confidence: number;\r\n  validUntil: Date;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nexport interface OptimizationResult {\r\n  objective: 'minimize_cost' | 'maximize_quality' | 'minimize_risk' | 'optimize_balance';\r\n  solution: {\r\n    selectedOptions: Array<{\r\n      id: string;\r\n      type: string;\r\n      weight: number;\r\n      score: number;\r\n    }>;\r\n    totalScore: number;\r\n    constraintsSatisfied: boolean;\r\n    tradeoffs: Record<string, number>;\r\n  };\r\n  alternatives: Array<{\r\n    rank: number;\r\n    score: number;\r\n    description: string;\r\n    keyDifferences: string[];\r\n  }>;\r\n  sensitivity: {\r\n    criticalFactors: string[];\r\n    robustness: number;\r\n    recommendations: string[];\r\n  };\r\n}\r\n\r\n// Multi-Criteria Decision Analysis Engine\r\nexport class MultiCriteriaDecisionEngine {\r\n  private db: Pool;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n  }\r\n\r\n  async evaluateSuppliers(\r\n    criteria: RecommendationCriteria,\r\n    candidates: string[]\r\n  ): Promise<OptimizationResult> {\r\n    try {\r\n      // Get supplier data\r\n      const suppliersData = await this.getSupplierData(candidates);\r\n\r\n      // Calculate scores for each criterion\r\n      const evaluatedSuppliers = await Promise.all(\r\n        suppliersData.map(supplier => this.evaluateSupplier(supplier, criteria))\r\n      );\r\n\r\n      // Apply multi-criteria optimization\r\n      const optimization = this.performTOPSISAnalysis(evaluatedSuppliers, criteria.weights);\r\n\r\n      return {\r\n        objective: 'optimize_balance',\r\n        solution: {\r\n          selectedOptions: optimization.ranking.slice(0, 3).map((item, index) => ({\r\n            id: item.supplierId,\r\n            type: 'supplier',\r\n            weight: 1 / (index + 1),\r\n            score: item.score\r\n          })),\r\n          totalScore: optimization.ranking[0]?.score || 0,\r\n          constraintsSatisfied: this.checkConstraints(optimization.ranking[0], criteria.constraints),\r\n          tradeoffs: this.calculateTradeoffs(optimization.ranking[0], criteria.weights)\r\n        },\r\n        alternatives: optimization.ranking.slice(1, 4).map((item, index) => ({\r\n          rank: index + 2,\r\n          score: item.score,\r\n          description: `Alternative supplier with different strength profile`,\r\n          keyDifferences: this.identifyKeyDifferences(optimization.ranking[0], item)\r\n        })),\r\n        sensitivity: {\r\n          criticalFactors: this.identifyCriticalFactors(optimization, criteria.weights),\r\n          robustness: this.calculateRobustness(optimization),\r\n          recommendations: this.generateSensitivityRecommendations(optimization)\r\n        }\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Supplier evaluation error:', error);\r\n      throw new Error('Failed to evaluate suppliers');\r\n    }\r\n  }\r\n\r\n  private async getSupplierData(supplierIds: string[]): Promise<any[]> {\r\n    const query = `\r\n      SELECT\r\n        s.*,\r\n        sp.overall_rating,\r\n        sp.on_time_delivery_rate,\r\n        sp.quality_acceptance_rate,\r\n        sp.response_time_hours,\r\n        sp.cost_competitiveness,\r\n        COALESCE(sustainability.score, 50) as sustainability_score,\r\n        COALESCE(innovation.score, 50) as innovation_score,\r\n        COALESCE(financial.risk_score, 50) as financial_risk\r\n      FROM public.suppliers s\r\n      LEFT JOIN supplier_performance sp ON s.id = sp.supplier_id\r\n      LEFT JOIN supplier_sustainability sustainability ON s.id = sustainability.supplier_id\r\n      LEFT JOIN supplier_innovation innovation ON s.id = innovation.supplier_id\r\n      LEFT JOIN supplier_financial_risk financial ON s.id = financial.supplier_id\r\n      WHERE s.id = ANY($1)\r\n    `;\r\n\r\n    const result = await this.db.query(query, [supplierIds]);\r\n    return result.rows;\r\n  }\r\n\r\n  private async evaluateSupplier(supplier: any, criteria: RecommendationCriteria): Promise<any> {\r\n    // Normalize scores to 0-1 scale\r\n    const scores = {\r\n      cost: this.normalizeCostScore(supplier.cost_competitiveness || 50),\r\n      quality: this.normalizeQualityScore(supplier.quality_acceptance_rate || 80),\r\n      delivery: this.normalizeDeliveryScore(supplier.on_time_delivery_rate || 80),\r\n      sustainability: this.normalizeSustainabilityScore(supplier.sustainability_score || 50),\r\n      risk: this.normalizeRiskScore(100 - (supplier.financial_risk || 50)),\r\n      innovation: this.normalizeInnovationScore(supplier.innovation_score || 50)\r\n    };\r\n\r\n    return {\r\n      supplierId: supplier.id,\r\n      name: supplier.name,\r\n      scores,\r\n      rawData: supplier\r\n    };\r\n  }\r\n\r\n  // TOPSIS (Technique for Order Preference by Similarity to Ideal Solution) Analysis\r\n  private performTOPSISAnalysis(suppliers: any[], weights: MultiCriteriaWeights): any {\r\n    const criteria = Object.keys(weights);\r\n\r\n    // Step 1: Create decision matrix\r\n    const decisionMatrix = suppliers.map(supplier =>\r\n      criteria.map(criterion => supplier.scores[criterion])\r\n    );\r\n\r\n    // Step 2: Normalize decision matrix\r\n    const normalizedMatrix = this.normalizeDecisionMatrix(decisionMatrix);\r\n\r\n    // Step 3: Apply weights\r\n    const weightedMatrix = normalizedMatrix.map(row =>\r\n      row.map((value, index) => value * weights[criteria[index] as keyof MultiCriteriaWeights])\r\n    );\r\n\r\n    // Step 4: Determine ideal and negative-ideal solutions\r\n    const idealSolution = criteria.map((_, index) =>\r\n      Math.max(...weightedMatrix.map(row => row[index]))\r\n    );\r\n\r\n    const negativeIdealSolution = criteria.map((_, index) =>\r\n      Math.min(...weightedMatrix.map(row => row[index]))\r\n    );\r\n\r\n    // Step 5: Calculate distances and closeness coefficients\r\n    const ranking = suppliers.map((supplier, supplierIndex) => {\r\n      const distanceToIdeal = Math.sqrt(\r\n        weightedMatrix[supplierIndex].reduce((sum, value, index) =>\r\n          sum + Math.pow(value - idealSolution[index], 2), 0\r\n        )\r\n      );\r\n\r\n      const distanceToNegativeIdeal = Math.sqrt(\r\n        weightedMatrix[supplierIndex].reduce((sum, value, index) =>\r\n          sum + Math.pow(value - negativeIdealSolution[index], 2), 0\r\n        )\r\n      );\r\n\r\n      const closenessCoefficient = distanceToNegativeIdeal / (distanceToIdeal + distanceToNegativeIdeal);\r\n\r\n      return {\r\n        supplierId: supplier.supplierId,\r\n        name: supplier.name,\r\n        score: closenessCoefficient,\r\n        scores: supplier.scores,\r\n        distanceToIdeal,\r\n        distanceToNegativeIdeal\r\n      };\r\n    }).sort((a, b) => b.score - a.score);\r\n\r\n    return { ranking, idealSolution, negativeIdealSolution };\r\n  }\r\n\r\n  private normalizeDecisionMatrix(matrix: number[][]): number[][] {\r\n    const columnSums = matrix[0].map((_, colIndex) =>\r\n      Math.sqrt(matrix.reduce((sum, row) => sum + Math.pow(row[colIndex], 2), 0))\r\n    );\r\n\r\n    return matrix.map(row =>\r\n      row.map((value, colIndex) => value / columnSums[colIndex])\r\n    );\r\n  }\r\n\r\n  // Normalization functions for different criteria\r\n  private normalizeCostScore(cost: number): number {\r\n    // Lower cost is better, so invert the score\r\n    return Math.max(0, Math.min(1, (100 - cost) / 100));\r\n  }\r\n\r\n  private normalizeQualityScore(quality: number): number {\r\n    return Math.max(0, Math.min(1, quality / 100));\r\n  }\r\n\r\n  private normalizeDeliveryScore(delivery: number): number {\r\n    return Math.max(0, Math.min(1, delivery / 100));\r\n  }\r\n\r\n  private normalizeSustainabilityScore(sustainability: number): number {\r\n    return Math.max(0, Math.min(1, sustainability / 100));\r\n  }\r\n\r\n  private normalizeRiskScore(riskInverse: number): number {\r\n    return Math.max(0, Math.min(1, riskInverse / 100));\r\n  }\r\n\r\n  private normalizeInnovationScore(innovation: number): number {\r\n    return Math.max(0, Math.min(1, innovation / 100));\r\n  }\r\n\r\n  private checkConstraints(bestOption: any, constraints: any): boolean {\r\n    if (!bestOption) return false;\r\n\r\n    // Check various constraints\r\n    if (constraints.minQuality && bestOption.scores.quality < constraints.minQuality) {\r\n      return false;\r\n    }\r\n\r\n    if (constraints.maxRisk && (1 - bestOption.scores.risk) > constraints.maxRisk) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private calculateTradeoffs(option: any, weights: MultiCriteriaWeights): Record<string, number> {\r\n    const tradeoffs: Record<string, number> = {};\r\n\r\n    Object.keys(weights).forEach(criterion => {\r\n      const score = option.scores[criterion];\r\n      const weight = weights[criterion as keyof MultiCriteriaWeights];\r\n      tradeoffs[criterion] = score * weight;\r\n    });\r\n\r\n    return tradeoffs;\r\n  }\r\n\r\n  private identifyKeyDifferences(best: any, alternative: any): string[] {\r\n    const differences: string[] = [];\r\n\r\n    Object.keys(best.scores).forEach(criterion => {\r\n      const diff = Math.abs(best.scores[criterion] - alternative.scores[criterion]);\r\n      if (diff > 0.1) {\r\n        const better = best.scores[criterion] > alternative.scores[criterion] ? 'better' : 'worse';\r\n        differences.push(`${criterion}: ${(diff * 100).toFixed(1)}% ${better}`);\r\n      }\r\n    });\r\n\r\n    return differences;\r\n  }\r\n\r\n  private identifyCriticalFactors(optimization: any, weights: MultiCriteriaWeights): string[] {\r\n    // Identify factors with high weights or high variance in scores\r\n    return Object.entries(weights)\r\n      .filter(([_, weight]) => weight > 0.15)\r\n      .map(([criterion, _]) => criterion);\r\n  }\r\n\r\n  private calculateRobustness(optimization: any): number {\r\n    if (optimization.ranking.length < 2) return 1;\r\n\r\n    const topScore = optimization.ranking[0].score;\r\n    const secondScore = optimization.ranking[1].score;\r\n\r\n    // Robustness is higher when the top choice clearly dominates\r\n    return Math.min(1, (topScore - secondScore) / topScore);\r\n  }\r\n\r\n  private generateSensitivityRecommendations(optimization: any): string[] {\r\n    const recommendations: string[] = [];\r\n\r\n    if (optimization.ranking.length > 1) {\r\n      const scoreDiff = optimization.ranking[0].score - optimization.ranking[1].score;\r\n      if (scoreDiff < 0.1) {\r\n        recommendations.push('Consider evaluating additional criteria to differentiate top candidates');\r\n      }\r\n    }\r\n\r\n    recommendations.push('Monitor supplier performance regularly to validate decision');\r\n    recommendations.push('Consider pilot programs before full commitment');\r\n\r\n    return recommendations;\r\n  }\r\n}\r\n\r\n// Intelligent Recommendation Generator\r\nexport class IntelligentRecommendationEngine {\r\n  private db: Pool;\r\n  private decisionEngine: MultiCriteriaDecisionEngine;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n    this.decisionEngine = new MultiCriteriaDecisionEngine(database);\r\n  }\r\n\r\n  async generateRecommendations(\r\n    organizationId: string,\r\n    context: {\r\n      focus?: 'cost_optimization' | 'risk_reduction' | 'quality_improvement' | 'sustainability';\r\n      urgency?: 'immediate' | 'short_term' | 'long_term';\r\n      scope?: 'supplier' | 'inventory' | 'procurement' | 'all';\r\n    } = {}\r\n  ): Promise<IntelligentRecommendation[]> {\r\n    try {\r\n      const recommendations: IntelligentRecommendation[] = [];\r\n\r\n      // Generate different types of recommendations based on scope\r\n      if (context.scope === 'supplier' || context.scope === 'all') {\r\n        const supplierRecs = await this.generateSupplierRecommendations(organizationId, context);\r\n        recommendations.push(...supplierRecs);\r\n      }\r\n\r\n      if (context.scope === 'inventory' || context.scope === 'all') {\r\n        const inventoryRecs = await this.generateInventoryRecommendations(organizationId, context);\r\n        recommendations.push(...inventoryRecs);\r\n      }\r\n\r\n      if (context.scope === 'procurement' || context.scope === 'all') {\r\n        const procurementRecs = await this.generateProcurementRecommendations(organizationId, context);\r\n        recommendations.push(...procurementRecs);\r\n      }\r\n\r\n      // Sort by priority and confidence\r\n      return recommendations\r\n        .sort((a, b) => {\r\n          const priorityWeight = { critical: 4, high: 3, medium: 2, low: 1 };\r\n          const aScore = priorityWeight[a.priority] * a.confidence;\r\n          const bScore = priorityWeight[b.priority] * b.confidence;\r\n          return bScore - aScore;\r\n        })\r\n        .slice(0, 20); // Limit to top 20 recommendations\r\n\r\n    } catch (error) {\r\n      console.error('Recommendation generation error:', error);\r\n      throw new Error('Failed to generate recommendations');\r\n    }\r\n  }\r\n\r\n  private async generateSupplierRecommendations(\r\n    organizationId: string,\r\n    context: any\r\n  ): Promise<IntelligentRecommendation[]> {\r\n    const recommendations: IntelligentRecommendation[] = [];\r\n\r\n    // Get underperforming suppliers\r\n    const underperformingQuery = `\r\n      SELECT s.*, sp.overall_rating, sp.on_time_delivery_rate, sp.quality_acceptance_rate\r\n      FROM public.suppliers s\r\n      LEFT JOIN supplier_performance sp ON s.id = sp.supplier_id\r\n      WHERE s.organization_id = $1\r\n      AND s.status = 'active'\r\n      AND (sp.overall_rating < 70 OR sp.on_time_delivery_rate < 85 OR sp.quality_acceptance_rate < 90)\r\n      ORDER BY sp.overall_rating ASC\r\n      LIMIT 10\r\n    `;\r\n\r\n    const underperformingResult = await this.db.query(underperformingQuery, [organizationId]);\r\n\r\n    for (const supplier of underperformingResult.rows) {\r\n      const recommendation: IntelligentRecommendation = {\r\n        id: `supplier_improve_${supplier.id}_${Date.now()}`,\r\n        type: 'supplier_selection',\r\n        priority: supplier.overall_rating < 50 ? 'critical' : 'high',\r\n        title: `Address performance issues with ${supplier.name}`,\r\n        description: `Supplier showing concerning performance metrics that require immediate attention`,\r\n        rationale: [\r\n          `Overall rating: ${supplier.overall_rating || 'N/A'}/100`,\r\n          `On-time delivery: ${supplier.on_time_delivery_rate || 'N/A'}%`,\r\n          `Quality acceptance: ${supplier.quality_acceptance_rate || 'N/A'}%`\r\n        ],\r\n\r\n        recommendation: {\r\n          action: 'Implement supplier improvement program or find alternatives',\r\n          targets: [{\r\n            id: supplier.id,\r\n            type: 'supplier',\r\n            name: supplier.name,\r\n            currentScore: supplier.overall_rating || 0,\r\n            recommendedScore: 85\r\n          }],\r\n          alternatives: [\r\n            {\r\n              option: 'Supplier development program',\r\n              score: 0.7,\r\n              tradeoffs: ['Time investment required', 'Potential for improvement']\r\n            },\r\n            {\r\n              option: 'Find alternative suppliers',\r\n              score: 0.8,\r\n              tradeoffs: ['Switching costs', 'Reduced risk']\r\n            }\r\n          ]\r\n        },\r\n\r\n        impact: {\r\n          financial: {\r\n            costSavings: this.estimateCostSavings(supplier),\r\n            revenueIncrease: 0,\r\n            roi: 2.5\r\n          },\r\n          operational: {\r\n            efficiencyGain: 0.15,\r\n            riskReduction: 0.3,\r\n            qualityImprovement: 0.2\r\n          },\r\n          strategic: {\r\n            competitiveAdvantage: 'Improved supply chain reliability',\r\n            futureValue: 0.8,\r\n            alignment: 0.9\r\n          }\r\n        },\r\n\r\n        implementation: {\r\n          timeline: '3-6 months',\r\n          complexity: 'medium',\r\n          resources: ['Procurement manager', 'Quality team', 'Legal review'],\r\n          steps: [\r\n            {\r\n              step: 1,\r\n              action: 'Conduct detailed supplier audit',\r\n              owner: 'procurement_manager',\r\n              duration: '2 weeks',\r\n              dependencies: []\r\n            },\r\n            {\r\n              step: 2,\r\n              action: 'Develop improvement plan or source alternatives',\r\n              owner: 'procurement_team',\r\n              duration: '4 weeks',\r\n              dependencies: ['Step 1']\r\n            },\r\n            {\r\n              step: 3,\r\n              action: 'Implement changes and monitor progress',\r\n              owner: 'procurement_manager',\r\n              duration: '12 weeks',\r\n              dependencies: ['Step 2']\r\n            }\r\n          ],\r\n          risks: [\r\n            {\r\n              risk: 'Supplier may not improve',\r\n              probability: 0.3,\r\n              impact: 0.7,\r\n              mitigation: 'Have backup suppliers ready'\r\n            }\r\n          ]\r\n        },\r\n\r\n        confidence: 0.85,\r\n        validUntil: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000),\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      };\r\n\r\n      recommendations.push(recommendation);\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n\r\n  private async generateInventoryRecommendations(\r\n    organizationId: string,\r\n    context: any\r\n  ): Promise<IntelligentRecommendation[]> {\r\n    const recommendations: IntelligentRecommendation[] = [];\r\n\r\n    // Find items with suboptimal inventory levels\r\n    const inventoryQuery = `\r\n      SELECT\r\n        ii.*,\r\n        COALESCE(movement_stats.outbound_30d, 0) as demand_30d,\r\n        COALESCE(movement_stats.avg_daily_demand, 0) as avg_daily_demand\r\n      FROM public.inventory_items ii\r\n      LEFT JOIN (\r\n        SELECT\r\n          item_id,\r\n          SUM(CASE WHEN type = 'outbound' THEN quantity ELSE 0 END) as outbound_30d,\r\n          AVG(CASE WHEN type = 'outbound' THEN quantity ELSE 0 END) as avg_daily_demand\r\n        FROM stock_movements\r\n        WHERE timestamp >= NOW() - INTERVAL '30 days'\r\n        GROUP BY item_id\r\n      ) movement_stats ON ii.id = movement_stats.item_id\r\n      WHERE ii.organization_id = $1\r\n      AND (\r\n        ii.current_stock <= ii.reorder_point OR\r\n        ii.current_stock > ii.max_stock * 1.5 OR\r\n        ii.current_stock = 0\r\n      )\r\n      ORDER BY\r\n        CASE\r\n          WHEN ii.current_stock = 0 THEN 1\r\n          WHEN ii.current_stock <= ii.reorder_point THEN 2\r\n          ELSE 3\r\n        END,\r\n        movement_stats.outbound_30d DESC\r\n      LIMIT 15\r\n    `;\r\n\r\n    const inventoryResult = await this.db.query(inventoryQuery, [organizationId]);\r\n\r\n    for (const item of inventoryResult.rows) {\r\n      let recommendationType: 'critical' | 'high' | 'medium' | 'low' = 'medium';\r\n      let action = '';\r\n      let description = '';\r\n\r\n      if (item.current_stock === 0) {\r\n        recommendationType = 'critical';\r\n        action = 'Emergency reorder required';\r\n        description = 'Item is completely out of stock';\r\n      } else if (item.current_stock <= item.reorder_point) {\r\n        recommendationType = 'high';\r\n        action = 'Reorder immediately';\r\n        description = 'Stock level has reached reorder point';\r\n      } else if (item.current_stock > item.max_stock * 1.5) {\r\n        recommendationType = 'medium';\r\n        action = 'Reduce stock levels';\r\n        description = 'Excess inventory is tying up capital';\r\n      }\r\n\r\n      const recommendation: IntelligentRecommendation = {\r\n        id: `inventory_${item.id}_${Date.now()}`,\r\n        type: 'inventory_optimization',\r\n        priority: recommendationType,\r\n        title: `Optimize inventory for ${item.name}`,\r\n        description,\r\n        rationale: [\r\n          `Current stock: ${item.current_stock} units`,\r\n          `Reorder point: ${item.reorder_point} units`,\r\n          `30-day demand: ${item.demand_30d || 0} units`,\r\n          `Daily demand: ${(item.avg_daily_demand || 0).toFixed(1)} units`\r\n        ],\r\n\r\n        recommendation: {\r\n          action,\r\n          targets: [{\r\n            id: item.id,\r\n            type: 'item',\r\n            name: item.name,\r\n            currentScore: this.calculateInventoryScore(item),\r\n            recommendedScore: 85\r\n          }],\r\n          alternatives: this.generateInventoryAlternatives(item)\r\n        },\r\n\r\n        impact: this.calculateInventoryImpact(item),\r\n\r\n        implementation: {\r\n          timeline: item.current_stock === 0 ? '1-3 days' : '1-2 weeks',\r\n          complexity: 'low',\r\n          resources: ['Purchasing agent', 'Inventory manager'],\r\n          steps: this.generateInventorySteps(item),\r\n          risks: [\r\n            {\r\n              risk: 'Supplier lead time delays',\r\n              probability: 0.2,\r\n              impact: 0.6,\r\n              mitigation: 'Use expedited shipping if necessary'\r\n            }\r\n          ]\r\n        },\r\n\r\n        confidence: 0.9,\r\n        validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\r\n        createdAt: new Date(),\r\n        updatedAt: new Date()\r\n      };\r\n\r\n      recommendations.push(recommendation);\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n\r\n  private async generateProcurementRecommendations(\r\n    organizationId: string,\r\n    context: any\r\n  ): Promise<IntelligentRecommendation[]> {\r\n    const recommendations: IntelligentRecommendation[] = [];\r\n\r\n    // Analyze procurement patterns for optimization opportunities\r\n    const procurementQuery = `\r\n      SELECT\r\n        ii.category,\r\n        COUNT(DISTINCT s.id) as supplier_count,\r\n        AVG(spl.unit_price) as avg_price,\r\n        SUM(po.total_amount) as total_spend,\r\n        COUNT(po.id) as order_count\r\n      FROM public.inventory_items ii\r\n      JOIN supplier_price_lists spl ON ii.sku = spl.sku\r\n      JOIN suppliers s ON spl.supplier_id = s.id\r\n      LEFT JOIN purchase_orders po ON s.id = po.supplier_id\r\n      WHERE ii.organization_id = $1\r\n      AND po.order_date >= NOW() - INTERVAL '6 months'\r\n      GROUP BY ii.category\r\n      HAVING COUNT(DISTINCT s.id) > 3 AND SUM(po.total_amount) > 50000\r\n      ORDER BY SUM(po.total_amount) DESC\r\n      LIMIT 10\r\n    `;\r\n\r\n    const procurementResult = await this.db.query(procurementQuery, [organizationId]);\r\n\r\n    for (const category of procurementResult.rows) {\r\n      if (category.supplier_count > 5) {\r\n        // Supplier consolidation opportunity\r\n        const recommendation: IntelligentRecommendation = {\r\n          id: `procurement_consolidate_${category.category}_${Date.now()}`,\r\n          type: 'procurement_strategy',\r\n          priority: 'medium',\r\n          title: `Consolidate suppliers in ${category.category} category`,\r\n          description: 'Multiple suppliers in category present consolidation opportunity',\r\n          rationale: [\r\n            `${category.supplier_count} suppliers in category`,\r\n            `Total spend: $${parseFloat(category.total_spend).toLocaleString()}`,\r\n            `${category.order_count} orders in last 6 months`\r\n          ],\r\n\r\n          recommendation: {\r\n            action: 'Consolidate to 2-3 preferred suppliers',\r\n            targets: [{\r\n              id: category.category,\r\n              type: 'category',\r\n              name: category.category,\r\n              currentScore: 50,\r\n              recommendedScore: 80\r\n            }],\r\n            alternatives: [\r\n              {\r\n                option: 'Negotiate volume discounts with top 2 suppliers',\r\n                score: 0.8,\r\n                tradeoffs: ['Higher dependency risk', 'Significant cost savings']\r\n              },\r\n              {\r\n                option: 'Strategic partnership with 1 primary supplier',\r\n                score: 0.9,\r\n                tradeoffs: ['Innovation benefits', 'Single point of failure']\r\n              }\r\n            ]\r\n          },\r\n\r\n          impact: {\r\n            financial: {\r\n              costSavings: parseFloat(category.total_spend) * 0.08, // 8% savings\r\n              revenueIncrease: 0,\r\n              roi: 4.2\r\n            },\r\n            operational: {\r\n              efficiencyGain: 0.25,\r\n              riskReduction: -0.1, // Slight increase in risk\r\n              qualityImprovement: 0.1\r\n            },\r\n            strategic: {\r\n              competitiveAdvantage: 'Stronger supplier relationships',\r\n              futureValue: 0.7,\r\n              alignment: 0.8\r\n            }\r\n          },\r\n\r\n          implementation: {\r\n            timeline: '4-6 months',\r\n            complexity: 'high',\r\n            resources: ['Procurement director', 'Category managers', 'Legal team'],\r\n            steps: [\r\n              {\r\n                step: 1,\r\n                action: 'Analyze supplier performance and spend',\r\n                owner: 'procurement_analyst',\r\n                duration: '3 weeks',\r\n                dependencies: []\r\n              },\r\n              {\r\n                step: 2,\r\n                action: 'Negotiate with preferred suppliers',\r\n                owner: 'procurement_manager',\r\n                duration: '6 weeks',\r\n                dependencies: ['Step 1']\r\n              },\r\n              {\r\n                step: 3,\r\n                action: 'Transition orders to consolidated suppliers',\r\n                owner: 'procurement_team',\r\n                duration: '8 weeks',\r\n                dependencies: ['Step 2']\r\n              }\r\n            ],\r\n            risks: [\r\n              {\r\n                risk: 'Supplier capacity constraints',\r\n                probability: 0.3,\r\n                impact: 0.5,\r\n                mitigation: 'Verify capacity before commitment'\r\n              }\r\n            ]\r\n          },\r\n\r\n          confidence: 0.75,\r\n          validUntil: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000),\r\n          createdAt: new Date(),\r\n          updatedAt: new Date()\r\n        };\r\n\r\n        recommendations.push(recommendation);\r\n      }\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n\r\n  // Utility methods\r\n  private estimateCostSavings(supplier: any): number {\r\n    const baseline = 100000; // Baseline annual spend\r\n    const improvementPotential = (85 - (supplier.overall_rating || 50)) / 100;\r\n    return baseline * improvementPotential * 0.1; // 10% of potential improvement\r\n  }\r\n\r\n  private calculateInventoryScore(item: any): number {\r\n    if (item.current_stock === 0) return 0;\r\n    if (item.current_stock <= item.reorder_point) return 30;\r\n    if (item.current_stock > item.max_stock * 1.5) return 40;\r\n    return 70; // Acceptable range\r\n  }\r\n\r\n  private generateInventoryAlternatives(item: any): any[] {\r\n    const alternatives = [];\r\n\r\n    if (item.current_stock <= item.reorder_point) {\r\n      alternatives.push({\r\n        option: 'Standard reorder',\r\n        score: 0.8,\r\n        tradeoffs: ['Normal lead time', 'Standard pricing']\r\n      });\r\n      alternatives.push({\r\n        option: 'Expedited reorder',\r\n        score: 0.9,\r\n        tradeoffs: ['Higher cost', 'Faster delivery']\r\n      });\r\n    } else {\r\n      alternatives.push({\r\n        option: 'Promotional pricing',\r\n        score: 0.7,\r\n        tradeoffs: ['Reduced margin', 'Faster inventory turnover']\r\n      });\r\n      alternatives.push({\r\n        option: 'Suspend reorders temporarily',\r\n        score: 0.8,\r\n        tradeoffs: ['Risk of stockout', 'Improved cash flow']\r\n      });\r\n    }\r\n\r\n    return alternatives;\r\n  }\r\n\r\n  private calculateInventoryImpact(item: any): any {\r\n    const stockValue = item.current_stock * item.unit_cost;\r\n    const dailyDemandValue = (item.avg_daily_demand || 1) * item.unit_cost;\r\n\r\n    return {\r\n      financial: {\r\n        costSavings: item.current_stock === 0 ? 0 : stockValue * 0.05,\r\n        revenueIncrease: item.current_stock === 0 ? dailyDemandValue * 7 : 0,\r\n        roi: 2.0\r\n      },\r\n      operational: {\r\n        efficiencyGain: 0.1,\r\n        riskReduction: item.current_stock === 0 ? 0.8 : 0.2,\r\n        qualityImprovement: 0\r\n      },\r\n      strategic: {\r\n        competitiveAdvantage: 'Improved service levels',\r\n        futureValue: 0.6,\r\n        alignment: 0.9\r\n      }\r\n    };\r\n  }\r\n\r\n  private generateInventorySteps(item: any): any[] {\r\n    const baseSteps = [\r\n      {\r\n        step: 1,\r\n        action: 'Review current inventory levels and demand forecast',\r\n        owner: 'inventory_manager',\r\n        duration: '1 day',\r\n        dependencies: []\r\n      }\r\n    ];\r\n\r\n    if (item.current_stock <= item.reorder_point) {\r\n      baseSteps.push({\r\n        step: 2,\r\n        action: 'Create and approve purchase order',\r\n        owner: 'purchasing_agent',\r\n        duration: '1-2 days',\r\n        dependencies: ['Step 1']\r\n      });\r\n      baseSteps.push({\r\n        step: 3,\r\n        action: 'Monitor delivery and update inventory',\r\n        owner: 'warehouse_manager',\r\n        duration: '3-7 days',\r\n        dependencies: ['Step 2']\r\n      });\r\n    } else {\r\n      baseSteps.push({\r\n        step: 2,\r\n        action: 'Implement inventory reduction strategy',\r\n        owner: 'inventory_manager',\r\n        duration: '2-4 weeks',\r\n        dependencies: ['Step 1']\r\n      });\r\n    }\r\n\r\n    return baseSteps;\r\n  }\r\n\r\n  async getRecommendationById(recommendationId: string): Promise<IntelligentRecommendation | null> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT * FROM intelligent_recommendations\r\n        WHERE id = $1\r\n      `, [recommendationId]);\r\n\r\n      if (result.rows.length === 0) return null;\r\n\r\n      const row = result.rows[0];\r\n      return {\r\n        id: row.id,\r\n        type: row.type,\r\n        priority: row.priority,\r\n        title: row.title,\r\n        description: row.description,\r\n        rationale: JSON.parse(row.rationale),\r\n        recommendation: JSON.parse(row.recommendation),\r\n        impact: JSON.parse(row.impact),\r\n        implementation: JSON.parse(row.implementation),\r\n        confidence: parseFloat(row.confidence),\r\n        validUntil: new Date(row.valid_until),\r\n        createdAt: new Date(row.created_at),\r\n        updatedAt: new Date(row.updated_at)\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error fetching recommendation:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async updateRecommendationStatus(\r\n    recommendationId: string,\r\n    status: 'accepted' | 'rejected' | 'implemented' | 'expired',\r\n    userId: string,\r\n    notes?: string\r\n  ): Promise<boolean> {\r\n    try {\r\n      await this.db.query(`\r\n        UPDATE intelligent_recommendations\r\n        SET status = $1, updated_by = $2, updated_at = NOW(), notes = $3\r\n        WHERE id = $4\r\n      `, [status, userId, notes, recommendationId]);\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating recommendation status:', error);\r\n      return false;\r\n    }\r\n  }\r\n}\r\n\r\n// Export intelligent recommendation engine\r\nexport const intelligentRecommendations = {\r\n  engine: (db: Pool) => new IntelligentRecommendationEngine(db),\r\n  decisionEngine: (db: Pool) => new MultiCriteriaDecisionEngine(db)\r\n};","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\ml-models.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Machine Learning Models for MantisNXT Analytics\r\nimport { SupplierPerformance, InventoryItem, StockMovement } from '@/types';\r\n\r\n// Types for ML Analytics\r\nexport interface MLPrediction {\r\n  prediction: number;\r\n  confidence: number;\r\n  factors: Record<string, number>;\r\n  timestamp: Date;\r\n}\r\n\r\nexport interface SupplierRiskScore {\r\n  supplierId: string;\r\n  riskScore: number; // 0-100, higher = riskier\r\n  riskFactors: {\r\n    deliveryReliability: number;\r\n    qualityIssues: number;\r\n    financialStability: number;\r\n    communicationResponse: number;\r\n    priceVolatility: number;\r\n  };\r\n  recommendation: 'maintain' | 'monitor' | 'review' | 'replace';\r\n  confidence: number;\r\n}\r\n\r\nexport interface DemandForecast {\r\n  itemId: string;\r\n  sku: string;\r\n  predictions: {\r\n    next7Days: number;\r\n    next30Days: number;\r\n    next90Days: number;\r\n  };\r\n  seasonality: {\r\n    weeklyPattern: number[];\r\n    monthlyPattern: number[];\r\n    yearlyTrend: number;\r\n  };\r\n  confidence: number;\r\n  lastUpdated: Date;\r\n}\r\n\r\nexport interface PriceOptimization {\r\n  itemId: string;\r\n  currentPrice: number;\r\n  optimizedPrice: number;\r\n  expectedProfitIncrease: number;\r\n  demandSensitivity: number;\r\n  competitivePosition: 'low' | 'competitive' | 'premium';\r\n  recommendation: string;\r\n}\r\n\r\nexport interface InventoryOptimization {\r\n  itemId: string;\r\n  currentStock: number;\r\n  optimalStock: number;\r\n  reorderPoint: number;\r\n  orderQuantity: number;\r\n  carryingCost: number;\r\n  stockoutRisk: number;\r\n  recommendation: 'increase' | 'decrease' | 'maintain';\r\n}\r\n\r\n// Supplier Performance Prediction Model\r\nexport class SupplierPerformancePredictor {\r\n  private weights = {\r\n    deliveryHistory: 0.3,\r\n    qualityMetrics: 0.25,\r\n    responseTime: 0.15,\r\n    priceStability: 0.15,\r\n    financialHealth: 0.15\r\n  };\r\n\r\n  predictPerformance(\r\n    supplierId: string,\r\n    historicalData: SupplierPerformance[],\r\n    recentMetrics: any\r\n  ): MLPrediction {\r\n    const features = this.extractFeatures(historicalData, recentMetrics);\r\n    const score = this.calculatePerformanceScore(features);\r\n\r\n    return {\r\n      prediction: score,\r\n      confidence: this.calculateConfidence(historicalData.length, features),\r\n      factors: features,\r\n      timestamp: new Date()\r\n    };\r\n  }\r\n\r\n  private extractFeatures(history: SupplierPerformance[], recent: any) {\r\n    const avgDeliveryRate = history.reduce((sum, p) => sum + p.metrics.onTimeDeliveryRate, 0) / history.length;\r\n    const avgQualityRate = history.reduce((sum, p) => sum + p.metrics.qualityAcceptanceRate, 0) / history.length;\r\n    const avgResponseTime = history.reduce((sum, p) => sum + p.metrics.responseTime, 0) / history.length;\r\n\r\n    // Trend analysis\r\n    const deliveryTrend = this.calculateTrend(history.map(h => h.metrics.onTimeDeliveryRate));\r\n    const qualityTrend = this.calculateTrend(history.map(h => h.metrics.qualityAcceptanceRate));\r\n\r\n    return {\r\n      avgDeliveryRate: avgDeliveryRate / 100,\r\n      avgQualityRate: avgQualityRate / 100,\r\n      responseTimeScore: Math.max(0, 1 - (avgResponseTime / 48)), // Normalize to 48hr baseline\r\n      deliveryTrend,\r\n      qualityTrend,\r\n      consistencyScore: this.calculateConsistency(history),\r\n      recentPerformance: recent?.overallRating || 0.5\r\n    };\r\n  }\r\n\r\n  private calculatePerformanceScore(features: Record<string, number>): number {\r\n    return Math.min(1, Math.max(0,\r\n      features.avgDeliveryRate * this.weights.deliveryHistory +\r\n      features.avgQualityRate * this.weights.qualityMetrics +\r\n      features.responseTimeScore * this.weights.responseTime +\r\n      features.deliveryTrend * 0.1 +\r\n      features.qualityTrend * 0.1 +\r\n      features.consistencyScore * 0.15\r\n    ));\r\n  }\r\n\r\n  private calculateTrend(values: number[]): number {\r\n    if (values.length < 2) return 0;\r\n\r\n    const n = values.length;\r\n    const sumX = (n * (n - 1)) / 2;\r\n    const sumY = values.reduce((sum, val) => sum + val, 0);\r\n    const sumXY = values.reduce((sum, val, idx) => sum + (idx * val), 0);\r\n    const sumX2 = (n * (n - 1) * (2 * n - 1)) / 6;\r\n\r\n    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);\r\n    return Math.max(-1, Math.min(1, slope / 10)); // Normalize slope\r\n  }\r\n\r\n  private calculateConsistency(history: SupplierPerformance[]): number {\r\n    if (history.length < 2) return 1;\r\n\r\n    const ratings = history.map(h => h.overallRating);\r\n    const mean = ratings.reduce((sum, r) => sum + r, 0) / ratings.length;\r\n    const variance = ratings.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / ratings.length;\r\n    const standardDeviation = Math.sqrt(variance);\r\n\r\n    // Lower standard deviation = higher consistency\r\n    return Math.max(0, 1 - (standardDeviation / 2));\r\n  }\r\n\r\n  private calculateConfidence(dataPoints: number, features: Record<string, number>): number {\r\n    const dataSizeScore = Math.min(1, dataPoints / 10); // Full confidence at 10+ data points\r\n    const featureQuality = Object.values(features).reduce((sum, val) => sum + (isNaN(val) ? 0 : 1), 0) / Object.keys(features).length;\r\n\r\n    return (dataSizeScore * 0.6) + (featureQuality * 0.4);\r\n  }\r\n}\r\n\r\n// Demand Forecasting Model\r\nexport class DemandForecaster {\r\n  predictDemand(\r\n    itemId: string,\r\n    stockMovements: StockMovement[],\r\n    seasonality: any = {}\r\n  ): DemandForecast {\r\n    const outboundMovements = stockMovements.filter(m => m.type === 'outbound');\r\n    const dailyDemand = this.aggregateDailyDemand(outboundMovements);\r\n\r\n    const weeklyPattern = this.calculateWeeklyPattern(dailyDemand);\r\n    const monthlyPattern = this.calculateMonthlyPattern(dailyDemand);\r\n    const trend = this.calculateTrend(Object.values(dailyDemand));\r\n\r\n    return {\r\n      itemId,\r\n      sku: '', // Will be filled by caller\r\n      predictions: {\r\n        next7Days: this.forecastPeriod(dailyDemand, weeklyPattern, 7, trend),\r\n        next30Days: this.forecastPeriod(dailyDemand, monthlyPattern, 30, trend),\r\n        next90Days: this.forecastPeriod(dailyDemand, monthlyPattern, 90, trend)\r\n      },\r\n      seasonality: {\r\n        weeklyPattern,\r\n        monthlyPattern,\r\n        yearlyTrend: trend\r\n      },\r\n      confidence: this.calculateForecastConfidence(dailyDemand),\r\n      lastUpdated: new Date()\r\n    };\r\n  }\r\n\r\n  private aggregateDailyDemand(movements: StockMovement[]): Record<string, number> {\r\n    const dailyDemand: Record<string, number> = {};\r\n\r\n    movements.forEach(movement => {\r\n      const date = movement.timestamp.toISOString().split('T')[0];\r\n      dailyDemand[date] = (dailyDemand[date] || 0) + movement.quantity;\r\n    });\r\n\r\n    return dailyDemand;\r\n  }\r\n\r\n  private calculateWeeklyPattern(dailyDemand: Record<string, number>): number[] {\r\n    const weeklyTotals = new Array(7).fill(0);\r\n    const weeklyCounts = new Array(7).fill(0);\r\n\r\n    Object.entries(dailyDemand).forEach(([date, demand]) => {\r\n      const dayOfWeek = new Date(date).getDay();\r\n      weeklyTotals[dayOfWeek] += demand;\r\n      weeklyCounts[dayOfWeek]++;\r\n    });\r\n\r\n    return weeklyTotals.map((total, idx) =>\r\n      weeklyCounts[idx] > 0 ? total / weeklyCounts[idx] : 0\r\n    );\r\n  }\r\n\r\n  private calculateMonthlyPattern(dailyDemand: Record<string, number>): number[] {\r\n    const monthlyTotals = new Array(12).fill(0);\r\n    const monthlyCounts = new Array(12).fill(0);\r\n\r\n    Object.entries(dailyDemand).forEach(([date, demand]) => {\r\n      const month = new Date(date).getMonth();\r\n      monthlyTotals[month] += demand;\r\n      monthlyCounts[month]++;\r\n    });\r\n\r\n    return monthlyTotals.map((total, idx) =>\r\n      monthlyCounts[idx] > 0 ? total / monthlyCounts[idx] : 0\r\n    );\r\n  }\r\n\r\n  private forecastPeriod(\r\n    dailyDemand: Record<string, number>,\r\n    pattern: number[],\r\n    days: number,\r\n    trend: number\r\n  ): number {\r\n    const recentAverage = this.getRecentAverage(dailyDemand, 14);\r\n    const seasonalMultiplier = this.getSeasonalMultiplier(pattern, days);\r\n    const trendAdjustment = 1 + (trend * days / 365);\r\n\r\n    return Math.max(0, recentAverage * seasonalMultiplier * trendAdjustment * days);\r\n  }\r\n\r\n  private getRecentAverage(dailyDemand: Record<string, number>, days: number): number {\r\n    const dates = Object.keys(dailyDemand).sort().slice(-days);\r\n    const total = dates.reduce((sum, date) => sum + dailyDemand[date], 0);\r\n    return dates.length > 0 ? total / dates.length : 0;\r\n  }\r\n\r\n  private getSeasonalMultiplier(pattern: number[], days: number): number {\r\n    if (pattern.length === 7) {\r\n      // Weekly pattern\r\n      const avgDailyFromPattern = pattern.reduce((sum, val) => sum + val, 0) / 7;\r\n      return avgDailyFromPattern > 0 ? avgDailyFromPattern / pattern[0] : 1;\r\n    } else {\r\n      // Monthly pattern\r\n      const currentMonth = new Date().getMonth();\r\n      return pattern[currentMonth] || 1;\r\n    }\r\n  }\r\n\r\n  private calculateTrend(values: number[]): number {\r\n    if (values.length < 2) return 0;\r\n\r\n    const n = values.length;\r\n    const sumX = (n * (n - 1)) / 2;\r\n    const sumY = values.reduce((sum, val) => sum + val, 0);\r\n    const sumXY = values.reduce((sum, val, idx) => sum + (idx * val), 0);\r\n    const sumX2 = (n * (n - 1) * (2 * n - 1)) / 6;\r\n\r\n    return (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX) || 0;\r\n  }\r\n\r\n  private calculateForecastConfidence(dailyDemand: Record<string, number>): number {\r\n    const values = Object.values(dailyDemand);\r\n    if (values.length < 7) return 0.3;\r\n\r\n    const mean = values.reduce((sum, val) => sum + val, 0) / values.length;\r\n    const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;\r\n    const coefficientOfVariation = Math.sqrt(variance) / mean;\r\n\r\n    // Lower CV = higher confidence\r\n    return Math.max(0.3, Math.min(0.95, 1 - coefficientOfVariation));\r\n  }\r\n}\r\n\r\n// Price Optimization Model\r\nexport class PriceOptimizer {\r\n  optimizePrice(\r\n    item: InventoryItem,\r\n    demandElasticity: number = -1.5,\r\n    competitorPrices: number[] = [],\r\n    targetMargin: number = 0.3\r\n  ): PriceOptimization {\r\n    const currentPrice = item.unitPrice;\r\n    const cost = item.unitCost;\r\n    const currentMargin = (currentPrice - cost) / currentPrice;\r\n\r\n    // Calculate optimal price based on demand elasticity\r\n    const optimalPrice = this.calculateOptimalPrice(cost, demandElasticity, targetMargin);\r\n\r\n    // Adjust for competitive positioning\r\n    const competitivePrice = this.adjustForCompetition(optimalPrice, competitorPrices);\r\n\r\n    const finalPrice = Math.max(cost * 1.1, competitivePrice); // Ensure minimum 10% margin\r\n\r\n    return {\r\n      itemId: item.id,\r\n      currentPrice,\r\n      optimizedPrice: finalPrice,\r\n      expectedProfitIncrease: this.calculateProfitIncrease(currentPrice, finalPrice, cost),\r\n      demandSensitivity: Math.abs(demandElasticity),\r\n      competitivePosition: this.getCompetitivePosition(finalPrice, competitorPrices),\r\n      recommendation: this.generateRecommendation(currentPrice, finalPrice, currentMargin, targetMargin)\r\n    };\r\n  }\r\n\r\n  private calculateOptimalPrice(cost: number, elasticity: number, targetMargin: number): number {\r\n    // Price optimization using margin and elasticity\r\n    const markup = targetMargin / (1 - targetMargin);\r\n    return cost * (1 + markup);\r\n  }\r\n\r\n  private adjustForCompetition(price: number, competitorPrices: number[]): number {\r\n    if (competitorPrices.length === 0) return price;\r\n\r\n    const avgCompetitorPrice = competitorPrices.reduce((sum, p) => sum + p, 0) / competitorPrices.length;\r\n    const minCompetitorPrice = Math.min(...competitorPrices);\r\n    const maxCompetitorPrice = Math.max(...competitorPrices);\r\n\r\n    // Position slightly below average but above minimum\r\n    const targetPrice = avgCompetitorPrice * 0.95;\r\n\r\n    return Math.max(minCompetitorPrice * 1.05, Math.min(maxCompetitorPrice * 0.9, targetPrice));\r\n  }\r\n\r\n  private calculateProfitIncrease(currentPrice: number, newPrice: number, cost: number): number {\r\n    const currentProfit = currentPrice - cost;\r\n    const newProfit = newPrice - cost;\r\n\r\n    return newProfit > currentProfit ? (newProfit - currentProfit) / currentProfit : 0;\r\n  }\r\n\r\n  private getCompetitivePosition(price: number, competitorPrices: number[]): 'low' | 'competitive' | 'premium' {\r\n    if (competitorPrices.length === 0) return 'competitive';\r\n\r\n    const avgPrice = competitorPrices.reduce((sum, p) => sum + p, 0) / competitorPrices.length;\r\n\r\n    if (price < avgPrice * 0.9) return 'low';\r\n    if (price > avgPrice * 1.1) return 'premium';\r\n    return 'competitive';\r\n  }\r\n\r\n  private generateRecommendation(currentPrice: number, optimalPrice: number, currentMargin: number, targetMargin: number): string {\r\n    const priceDiff = ((optimalPrice - currentPrice) / currentPrice) * 100;\r\n\r\n    if (Math.abs(priceDiff) < 2) {\r\n      return \"Current pricing is optimal. No immediate changes needed.\";\r\n    } else if (priceDiff > 5) {\r\n      return `Consider increasing price by ${priceDiff.toFixed(1)}% to improve margins.`;\r\n    } else if (priceDiff < -5) {\r\n      return `Consider decreasing price by ${Math.abs(priceDiff).toFixed(1)}% to improve competitiveness.`;\r\n    } else {\r\n      return `Minor price adjustment of ${priceDiff > 0 ? '+' : ''}${priceDiff.toFixed(1)}% recommended.`;\r\n    }\r\n  }\r\n}\r\n\r\n// Anomaly Detection System\r\nexport class AnomalyDetector {\r\n  detectSupplierAnomalies(\r\n    suppliers: any[],\r\n    performance: SupplierPerformance[]\r\n  ): Array<{\r\n    supplierId: string;\r\n    anomalyType: string;\r\n    severity: 'low' | 'medium' | 'high';\r\n    description: string;\r\n    value: number;\r\n    threshold: number;\r\n  }> {\r\n    const anomalies: Array<any> = [];\r\n\r\n    // Detect performance drops\r\n    performance.forEach(p => {\r\n      if (p.metrics.onTimeDeliveryRate < 85) {\r\n        anomalies.push({\r\n          supplierId: p.supplierId,\r\n          anomalyType: 'delivery_performance',\r\n          severity: p.metrics.onTimeDeliveryRate < 70 ? 'high' : 'medium',\r\n          description: 'On-time delivery rate below threshold',\r\n          value: p.metrics.onTimeDeliveryRate,\r\n          threshold: 85\r\n        });\r\n      }\r\n\r\n      if (p.metrics.qualityAcceptanceRate < 90) {\r\n        anomalies.push({\r\n          supplierId: p.supplierId,\r\n          anomalyType: 'quality_issues',\r\n          severity: p.metrics.qualityAcceptanceRate < 80 ? 'high' : 'medium',\r\n          description: 'Quality acceptance rate below threshold',\r\n          value: p.metrics.qualityAcceptanceRate,\r\n          threshold: 90\r\n        });\r\n      }\r\n    });\r\n\r\n    return anomalies;\r\n  }\r\n\r\n  detectInventoryAnomalies(\r\n    items: InventoryItem[],\r\n    movements: StockMovement[]\r\n  ): Array<{\r\n    itemId: string;\r\n    anomalyType: string;\r\n    severity: 'low' | 'medium' | 'high';\r\n    description: string;\r\n    value: number;\r\n  }> {\r\n    const anomalies: Array<any> = [];\r\n\r\n    items.forEach(item => {\r\n      // Stock level anomalies\r\n      if (item.currentStock <= item.reorderPoint) {\r\n        anomalies.push({\r\n          itemId: item.id,\r\n          anomalyType: 'low_stock',\r\n          severity: item.currentStock === 0 ? 'high' : 'medium',\r\n          description: 'Stock level at or below reorder point',\r\n          value: item.currentStock\r\n        });\r\n      }\r\n\r\n      if (item.currentStock > item.maxStock * 1.2) {\r\n        anomalies.push({\r\n          itemId: item.id,\r\n          anomalyType: 'overstock',\r\n          severity: 'medium',\r\n          description: 'Stock level significantly above maximum',\r\n          value: item.currentStock\r\n        });\r\n      }\r\n\r\n      // Unusual price movements\r\n      const recentMovements = movements\r\n        .filter(m => m.itemId === item.id && m.timestamp > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000))\r\n        .filter(m => m.unitCost);\r\n\r\n      if (recentMovements.length > 1) {\r\n        const costs = recentMovements.map(m => m.unitCost!);\r\n        const avgCost = costs.reduce((sum, cost) => sum + cost, 0) / costs.length;\r\n        const maxDeviation = Math.max(...costs.map(cost => Math.abs(cost - avgCost)));\r\n\r\n        if (maxDeviation > avgCost * 0.15) {\r\n          anomalies.push({\r\n            itemId: item.id,\r\n            anomalyType: 'price_volatility',\r\n            severity: 'medium',\r\n            description: 'Unusual price volatility detected',\r\n            value: maxDeviation / avgCost\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    return anomalies;\r\n  }\r\n}\r\n\r\n// Export ML Models\r\nexport const mlModels = {\r\n  supplierPredictor: new SupplierPerformancePredictor(),\r\n  demandForecaster: new DemandForecaster(),\r\n  priceOptimizer: new PriceOptimizer(),\r\n  anomalyDetector: new AnomalyDetector()\r\n};","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\predictive-analytics.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Advanced Predictive Analytics Service for MantisNXT\r\n// Implements sophisticated forecasting and predictive models\r\n\r\nimport { Pool } from 'pg';\r\nimport { advancedMLModels } from './advanced-ml-models';\r\nimport { queryOptimization } from './query-optimizer';\r\n\r\n// Export the main predictive analytics service for easy import\r\nexport { PredictiveAnalyticsEngine as PredictiveAnalyticsService };\r\n\r\n// Predictive Analytics Types\r\nexport interface PredictiveModel {\r\n  id: string;\r\n  name: string;\r\n  type: 'demand_forecast' | 'supplier_risk' | 'price_prediction' | 'inventory_optimization' | 'churn_prediction';\r\n  algorithm: 'neural_network' | 'time_series' | 'ensemble' | 'regression' | 'classification';\r\n  accuracy: number;\r\n  trainingData: number;\r\n  lastTrained: Date;\r\n  nextRetraining: Date;\r\n  parameters: Record<string, any>;\r\n  status: 'active' | 'training' | 'deprecated' | 'error';\r\n}\r\n\r\nexport interface PredictionResult {\r\n  modelId: string;\r\n  targetId: string; // Item ID, Supplier ID, etc.\r\n  targetType: 'inventory_item' | 'supplier' | 'category' | 'organization';\r\n  prediction: {\r\n    value: number;\r\n    confidence: number;\r\n    range: { min: number; max: number };\r\n    explanation: string[];\r\n  };\r\n  forecast?: {\r\n    horizon: number; // days\r\n    points: Array<{\r\n      date: Date;\r\n      value: number;\r\n      confidence: number;\r\n    }>;\r\n  };\r\n  features: Record<string, number>;\r\n  metadata: {\r\n    algorithm: string;\r\n    processingTime: number;\r\n    dataQuality: number;\r\n    timestamp: Date;\r\n  };\r\n}\r\n\r\nexport interface MarketIntelligence {\r\n  priceAnalysis: {\r\n    currentTrends: Array<{\r\n      category: string;\r\n      trend: 'rising' | 'falling' | 'stable';\r\n      changePercent: number;\r\n      confidence: number;\r\n    }>;\r\n    priceForecasts: Array<{\r\n      itemId: string;\r\n      currentPrice: number;\r\n      predictedPrice: number;\r\n      timeframe: string;\r\n      confidence: number;\r\n    }>;\r\n    marketOpportunities: Array<{\r\n      type: 'buy' | 'sell' | 'hold';\r\n      item: string;\r\n      reasoning: string;\r\n      potentialGain: number;\r\n      risk: 'low' | 'medium' | 'high';\r\n    }>;\r\n  };\r\n  demandAnalysis: {\r\n    seasonalPatterns: Record<string, number[]>; // Item -> monthly demand pattern\r\n    demandDrivers: Array<{\r\n      factor: string;\r\n      impact: number;\r\n      confidence: number;\r\n    }>;\r\n    emergingTrends: Array<{\r\n      pattern: string;\r\n      strength: number;\r\n      items: string[];\r\n    }>;\r\n  };\r\n  supplierIntelligence: {\r\n    riskAssessment: Array<{\r\n      supplierId: string;\r\n      riskLevel: 'low' | 'medium' | 'high' | 'critical';\r\n      riskFactors: string[];\r\n      mitigation: string[];\r\n      impact: number;\r\n    }>;\r\n    performanceTrends: Array<{\r\n      supplierId: string;\r\n      trend: 'improving' | 'declining' | 'stable';\r\n      metrics: Record<string, number>;\r\n    }>;\r\n    alternativeSuppliers: Array<{\r\n      mainSupplierId: string;\r\n      alternatives: Array<{\r\n        supplierId: string;\r\n        score: number;\r\n        advantages: string[];\r\n      }>;\r\n    }>;\r\n  };\r\n}\r\n\r\n// Advanced Predictive Analytics Engine\r\nexport class PredictiveAnalyticsEngine {\r\n  private db: Pool;\r\n  private models: Map<string, PredictiveModel> = new Map();\r\n  private queryOptimizer: any;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n    this.queryOptimizer = queryOptimization.optimizer(database);\r\n    this.initializeModels();\r\n  }\r\n\r\n  private async initializeModels() {\r\n    try {\r\n      // Load existing models from database\r\n      const result = await this.db.query(`\r\n        SELECT * FROM predictive_models\r\n        WHERE status = 'active'\r\n        ORDER BY accuracy DESC\r\n      `);\r\n\r\n      result.rows.forEach(row => {\r\n        this.models.set(row.id, {\r\n          id: row.id,\r\n          name: row.name,\r\n          type: row.type,\r\n          algorithm: row.algorithm,\r\n          accuracy: parseFloat(row.accuracy),\r\n          trainingData: parseInt(row.training_data),\r\n          lastTrained: new Date(row.last_trained),\r\n          nextRetraining: new Date(row.next_retraining),\r\n          parameters: JSON.parse(row.parameters || '{}'),\r\n          status: row.status\r\n        });\r\n      });\r\n\r\n      // Create default models if none exist\r\n      if (this.models.size === 0) {\r\n        await this.createDefaultModels();\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error initializing models:', error);\r\n      await this.createDefaultModels();\r\n    }\r\n  }\r\n\r\n  private async createDefaultModels() {\r\n    const defaultModels: Partial<PredictiveModel>[] = [\r\n      {\r\n        name: 'Advanced Demand Forecaster',\r\n        type: 'demand_forecast',\r\n        algorithm: 'time_series',\r\n        accuracy: 0.85,\r\n        parameters: { horizon: 30, seasonality: true, trend: true }\r\n      },\r\n      {\r\n        name: 'Supplier Risk Predictor',\r\n        type: 'supplier_risk',\r\n        algorithm: 'neural_network',\r\n        accuracy: 0.78,\r\n        parameters: { layers: [10, 20, 15, 1], learningRate: 0.01 }\r\n      },\r\n      {\r\n        name: 'Price Movement Predictor',\r\n        type: 'price_prediction',\r\n        algorithm: 'ensemble',\r\n        accuracy: 0.72,\r\n        parameters: { models: ['neural_network', 'regression', 'time_series'] }\r\n      },\r\n      {\r\n        name: 'Inventory Optimizer',\r\n        type: 'inventory_optimization',\r\n        algorithm: 'regression',\r\n        accuracy: 0.81,\r\n        parameters: { optimization: 'cost_minimization' }\r\n      }\r\n    ];\r\n\r\n    for (const model of defaultModels) {\r\n      await this.createModel(model);\r\n    }\r\n  }\r\n\r\n  async createModel(modelData: Partial<PredictiveModel>): Promise<string> {\r\n    const modelId = `model_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n    const now = new Date();\r\n    const nextRetraining = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // 7 days\r\n\r\n    const model: PredictiveModel = {\r\n      id: modelId,\r\n      name: modelData.name || 'Unnamed Model',\r\n      type: modelData.type || 'demand_forecast',\r\n      algorithm: modelData.algorithm || 'neural_network',\r\n      accuracy: modelData.accuracy || 0.5,\r\n      trainingData: modelData.trainingData || 0,\r\n      lastTrained: now,\r\n      nextRetraining,\r\n      parameters: modelData.parameters || {},\r\n      status: 'active'\r\n    };\r\n\r\n    try {\r\n      await this.db.query(`\r\n        INSERT INTO predictive_models (\r\n          id, name, type, algorithm, accuracy, training_data,\r\n          last_trained, next_retraining, parameters, status, created_at\r\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, NOW())\r\n      `, [\r\n        model.id, model.name, model.type, model.algorithm,\r\n        model.accuracy, model.trainingData, model.lastTrained,\r\n        model.nextRetraining, JSON.stringify(model.parameters), model.status\r\n      ]);\r\n\r\n      this.models.set(modelId, model);\r\n      return modelId;\r\n\r\n    } catch (error) {\r\n      console.error('Error creating model:', error);\r\n      throw new Error('Failed to create predictive model');\r\n    }\r\n  }\r\n\r\n  async predict(\r\n    modelType: string,\r\n    targetId: string,\r\n    targetType: 'inventory_item' | 'supplier' | 'category' | 'organization',\r\n    options: { horizon?: number; features?: Record<string, any> } = {}\r\n  ): Promise<PredictionResult> {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n      // Find best model for the task\r\n      const model = this.getBestModel(modelType);\r\n      if (!model) {\r\n        throw new Error(`No suitable model found for type: ${modelType}`);\r\n      }\r\n\r\n      // Generate prediction based on model type\r\n      let result: PredictionResult;\r\n\r\n      switch (model.type) {\r\n        case 'demand_forecast':\r\n          result = await this.predictDemand(model, targetId, options);\r\n          break;\r\n        case 'supplier_risk':\r\n          result = await this.predictSupplierRisk(model, targetId, options);\r\n          break;\r\n        case 'price_prediction':\r\n          result = await this.predictPrice(model, targetId, options);\r\n          break;\r\n        case 'inventory_optimization':\r\n          result = await this.optimizeInventory(model, targetId, options);\r\n          break;\r\n        default:\r\n          throw new Error(`Unsupported model type: ${model.type}`);\r\n      }\r\n\r\n      result.targetType = targetType;\r\n      result.metadata.processingTime = Date.now() - startTime;\r\n      result.metadata.timestamp = new Date();\r\n\r\n      // Store prediction result\r\n      await this.storePredictionResult(result);\r\n\r\n      return result;\r\n\r\n    } catch (error) {\r\n      console.error('Prediction error:', error);\r\n      throw new Error('Failed to generate prediction');\r\n    }\r\n  }\r\n\r\n  private getBestModel(modelType: string): PredictiveModel | null {\r\n    const modelsOfType = Array.from(this.models.values())\r\n      .filter(model => model.type === modelType && model.status === 'active')\r\n      .sort((a, b) => b.accuracy - a.accuracy);\r\n\r\n    return modelsOfType.length > 0 ? modelsOfType[0] : null;\r\n  }\r\n\r\n  private async predictDemand(\r\n    model: PredictiveModel,\r\n    itemId: string,\r\n    options: any\r\n  ): Promise<PredictionResult> {\r\n    const forecaster = advancedMLModels.timeSeriesForecaster(this.db);\r\n    const forecast = await forecaster.forecastDemand(itemId, options.horizon || 30);\r\n\r\n    const avgPrediction = forecast.predictions.next30Days;\r\n    const confidence = forecast.confidence;\r\n\r\n    return {\r\n      modelId: model.id,\r\n      targetId: itemId,\r\n      targetType: 'inventory_item',\r\n      prediction: {\r\n        value: avgPrediction,\r\n        confidence,\r\n        range: {\r\n          min: avgPrediction * 0.8,\r\n          max: avgPrediction * 1.2\r\n        },\r\n        explanation: [\r\n          `Forecast based on ${forecast.modelMetadata.trainingData} historical data points`,\r\n          `Seasonal patterns and trends incorporated`,\r\n          `Confidence level: ${(confidence * 100).toFixed(1)}%`\r\n        ]\r\n      },\r\n      forecast: {\r\n        horizon: options.horizon || 30,\r\n        points: forecast.predictions.next7Days ? [\r\n          {\r\n            date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\r\n            value: forecast.predictions.next7Days,\r\n            confidence: confidence\r\n          },\r\n          {\r\n            date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\r\n            value: forecast.predictions.next30Days,\r\n            confidence: confidence * 0.9\r\n          },\r\n          {\r\n            date: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000),\r\n            value: forecast.predictions.next90Days,\r\n            confidence: confidence * 0.8\r\n          }\r\n        ] : []\r\n      },\r\n      features: {\r\n        seasonality: forecast.seasonality.yearlyTrend,\r\n        weeklyPattern: forecast.seasonality.weeklyPattern.reduce((sum, val) => sum + val, 0) / 7,\r\n        monthlyPattern: forecast.seasonality.monthlyPattern.reduce((sum, val) => sum + val, 0) / 12\r\n      },\r\n      metadata: {\r\n        algorithm: model.algorithm,\r\n        processingTime: 0,\r\n        dataQuality: confidence,\r\n        timestamp: new Date()\r\n      }\r\n    };\r\n  }\r\n\r\n  private async predictSupplierRisk(\r\n    model: PredictiveModel,\r\n    supplierId: string,\r\n    options: any\r\n  ): Promise<PredictionResult> {\r\n    // Get supplier performance history\r\n    const performanceQuery = `\r\n      SELECT * FROM supplier_performance\r\n      WHERE supplier_id = $1\r\n      ORDER BY evaluation_date DESC\r\n      LIMIT 20\r\n    `;\r\n\r\n    const performanceResult = await this.db.query(performanceQuery, [supplierId]);\r\n    const performanceHistory = performanceResult.rows;\r\n\r\n    if (performanceHistory.length === 0) {\r\n      throw new Error('No performance history available for supplier');\r\n    }\r\n\r\n    const predictor = advancedMLModels.supplierPredictor(this.db);\r\n    const prediction = await predictor.predictSupplierPerformance(supplierId, performanceHistory);\r\n\r\n    return {\r\n      modelId: model.id,\r\n      targetId: supplierId,\r\n      targetType: 'supplier',\r\n      prediction: {\r\n        value: prediction.prediction,\r\n        confidence: prediction.confidence,\r\n        range: prediction.uncertaintyBounds,\r\n        explanation: prediction.explanation\r\n      },\r\n      features: prediction.features,\r\n      metadata: {\r\n        algorithm: model.algorithm,\r\n        processingTime: 0,\r\n        dataQuality: prediction.confidence,\r\n        timestamp: new Date()\r\n      }\r\n    };\r\n  }\r\n\r\n  private async predictPrice(\r\n    model: PredictiveModel,\r\n    itemId: string,\r\n    options: any\r\n  ): Promise<PredictionResult> {\r\n    // Get price history\r\n    const priceQuery = `\r\n      SELECT unit_cost, timestamp\r\n      FROM stock_movements\r\n      WHERE item_id = $1 AND unit_cost IS NOT NULL\r\n      ORDER BY timestamp DESC\r\n      LIMIT 50\r\n    `;\r\n\r\n    const priceResult = await this.db.query(priceQuery, [itemId]);\r\n    const priceHistory = priceResult.rows;\r\n\r\n    if (priceHistory.length < 5) {\r\n      throw new Error('Insufficient price history for prediction');\r\n    }\r\n\r\n    // Simple price trend analysis\r\n    const recentPrices = priceHistory.slice(0, 10).map(row => row.unit_cost);\r\n    const olderPrices = priceHistory.slice(10, 20).map(row => row.unit_cost);\r\n\r\n    const recentAvg = recentPrices.reduce((sum, price) => sum + price, 0) / recentPrices.length;\r\n    const olderAvg = olderPrices.reduce((sum, price) => sum + price, 0) / olderPrices.length;\r\n\r\n    const trend = (recentAvg - olderAvg) / olderAvg;\r\n    const volatility = this.calculateVolatility(recentPrices);\r\n\r\n    const predictedPrice = recentAvg * (1 + trend * 0.3); // Dampen the trend\r\n    const confidence = Math.max(0.3, 1 - volatility);\r\n\r\n    return {\r\n      modelId: model.id,\r\n      targetId: itemId,\r\n      targetType: 'inventory_item',\r\n      prediction: {\r\n        value: predictedPrice,\r\n        confidence,\r\n        range: {\r\n          min: predictedPrice * (1 - volatility),\r\n          max: predictedPrice * (1 + volatility)\r\n        },\r\n        explanation: [\r\n          `Price trend: ${trend > 0 ? 'increasing' : 'decreasing'} by ${Math.abs(trend * 100).toFixed(1)}%`,\r\n          `Volatility: ${(volatility * 100).toFixed(1)}%`,\r\n          `Based on ${priceHistory.length} price points`\r\n        ]\r\n      },\r\n      features: {\r\n        trend,\r\n        volatility,\r\n        recentAverage: recentAvg,\r\n        priceChange: (recentAvg - olderAvg) / olderAvg\r\n      },\r\n      metadata: {\r\n        algorithm: model.algorithm,\r\n        processingTime: 0,\r\n        dataQuality: confidence,\r\n        timestamp: new Date()\r\n      }\r\n    };\r\n  }\r\n\r\n  private async optimizeInventory(\r\n    model: PredictiveModel,\r\n    itemId: string,\r\n    options: any\r\n  ): Promise<PredictionResult> {\r\n    // Get inventory data\r\n    const inventoryQuery = `\r\n      SELECT\r\n        ii.*,\r\n        COALESCE(recent_demand.avg_daily_demand, 0) as avg_daily_demand,\r\n        COALESCE(recent_demand.demand_volatility, 0) as demand_volatility\r\n      FROM public.inventory_items ii\r\n      LEFT JOIN (\r\n        SELECT\r\n          item_id,\r\n          AVG(quantity) as avg_daily_demand,\r\n          STDDEV(quantity) / AVG(quantity) as demand_volatility\r\n        FROM stock_movements\r\n        WHERE type = 'outbound'\r\n        AND timestamp >= NOW() - INTERVAL '30 days'\r\n        GROUP BY item_id\r\n      ) recent_demand ON ii.id = recent_demand.item_id\r\n      WHERE ii.id = $1\r\n    `;\r\n\r\n    const inventoryResult = await this.db.query(inventoryQuery, [itemId]);\r\n    const item = inventoryResult.rows[0];\r\n\r\n    if (!item) {\r\n      throw new Error('Item not found');\r\n    }\r\n\r\n    // Calculate optimal inventory levels\r\n    const leadTime = 7; // days\r\n    const serviceLevel = 0.95; // 95% service level\r\n    const safetyStock = item.demand_volatility * Math.sqrt(leadTime) * 1.65; // Z-score for 95%\r\n\r\n    const optimalReorderPoint = (item.avg_daily_demand * leadTime) + safetyStock;\r\n    const optimalOrderQuantity = Math.sqrt(\r\n      (2 * item.avg_daily_demand * 365 * 50) / (item.unit_cost * 0.2) // EOQ formula\r\n    );\r\n\r\n    const currentEfficiency = this.calculateInventoryEfficiency(item);\r\n    const optimizedEfficiency = this.calculateOptimizedEfficiency(item, optimalReorderPoint, optimalOrderQuantity);\r\n\r\n    return {\r\n      modelId: model.id,\r\n      targetId: itemId,\r\n      targetType: 'inventory_item',\r\n      prediction: {\r\n        value: optimizedEfficiency,\r\n        confidence: 0.85,\r\n        range: {\r\n          min: optimizedEfficiency * 0.9,\r\n          max: optimizedEfficiency * 1.1\r\n        },\r\n        explanation: [\r\n          `Optimal reorder point: ${Math.round(optimalReorderPoint)} units`,\r\n          `Optimal order quantity: ${Math.round(optimalOrderQuantity)} units`,\r\n          `Expected efficiency improvement: ${((optimizedEfficiency - currentEfficiency) * 100).toFixed(1)}%`\r\n        ]\r\n      },\r\n      features: {\r\n        currentStock: item.current_stock,\r\n        currentReorderPoint: item.reorder_point,\r\n        optimalReorderPoint,\r\n        optimalOrderQuantity,\r\n        avgDailyDemand: item.avg_daily_demand,\r\n        demandVolatility: item.demand_volatility,\r\n        currentEfficiency,\r\n        optimizedEfficiency\r\n      },\r\n      metadata: {\r\n        algorithm: model.algorithm,\r\n        processingTime: 0,\r\n        dataQuality: 0.85,\r\n        timestamp: new Date()\r\n      }\r\n    };\r\n  }\r\n\r\n  private calculateVolatility(values: number[]): number {\r\n    if (values.length < 2) return 0;\r\n\r\n    const mean = values.reduce((sum, val) => sum + val, 0) / values.length;\r\n    const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;\r\n    return Math.sqrt(variance) / mean;\r\n  }\r\n\r\n  private calculateInventoryEfficiency(item: any): number {\r\n    // Simple efficiency metric based on turnover and stockout risk\r\n    const turnover = item.avg_daily_demand * 365 / Math.max(item.current_stock, 1);\r\n    const stockoutRisk = item.current_stock <= item.reorder_point ? 0.5 : 0.1;\r\n\r\n    return Math.max(0, Math.min(1, turnover / 10 - stockoutRisk));\r\n  }\r\n\r\n  private calculateOptimizedEfficiency(item: any, optimalReorder: number, optimalQuantity: number): number {\r\n    const turnover = item.avg_daily_demand * 365 / Math.max(optimalQuantity / 2, 1);\r\n    const stockoutRisk = 0.05; // 5% with optimized levels\r\n\r\n    return Math.max(0, Math.min(1, turnover / 10 - stockoutRisk));\r\n  }\r\n\r\n  private async storePredictionResult(result: PredictionResult): Promise<void> {\r\n    try {\r\n      await this.db.query(`\r\n        INSERT INTO analytics_predictions (\r\n          model_id, target_id, target_type, prediction_value,\r\n          confidence, range_min, range_max, features, metadata, created_at\r\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW())\r\n      `, [\r\n        result.modelId,\r\n        result.targetId,\r\n        result.targetType,\r\n        result.prediction.value,\r\n        result.prediction.confidence,\r\n        result.prediction.range.min,\r\n        result.prediction.range.max,\r\n        JSON.stringify(result.features),\r\n        JSON.stringify(result.metadata)\r\n      ]);\r\n    } catch (error) {\r\n      console.error('Error storing prediction result:', error);\r\n    }\r\n  }\r\n\r\n  async generateMarketIntelligence(organizationId: string): Promise<MarketIntelligence> {\r\n    try {\r\n      const [priceAnalysis, demandAnalysis, supplierIntelligence] = await Promise.all([\r\n        this.generatePriceAnalysis(organizationId),\r\n        this.generateDemandAnalysis(organizationId),\r\n        this.generateSupplierIntelligence(organizationId)\r\n      ]);\r\n\r\n      return {\r\n        priceAnalysis,\r\n        demandAnalysis,\r\n        supplierIntelligence\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error generating market intelligence:', error);\r\n      throw new Error('Failed to generate market intelligence');\r\n    }\r\n  }\r\n\r\n  private async generatePriceAnalysis(organizationId: string): Promise<any> {\r\n    // Get recent price movements by category\r\n    const priceQuery = `\r\n      SELECT\r\n        ii.category,\r\n        ii.id as item_id,\r\n        ii.sku,\r\n        ii.name,\r\n        AVG(sm.unit_cost) as avg_price,\r\n        COUNT(*) as price_points,\r\n        STDDEV(sm.unit_cost) / AVG(sm.unit_cost) as price_volatility\r\n      FROM public.inventory_items ii\r\n      JOIN stock_movements sm ON ii.id = sm.item_id\r\n      WHERE ii.organization_id = $1\r\n      AND sm.unit_cost IS NOT NULL\r\n      AND sm.timestamp >= NOW() - INTERVAL '30 days'\r\n      GROUP BY ii.category, ii.id, ii.sku, ii.name\r\n      HAVING COUNT(*) >= 3\r\n    `;\r\n\r\n    const priceResult = await this.db.query(priceQuery, [organizationId]);\r\n\r\n    const currentTrends = [];\r\n    const priceForecasts = [];\r\n    const marketOpportunities = [];\r\n\r\n    for (const item of priceResult.rows) {\r\n      // Determine trend\r\n      let trend: 'rising' | 'falling' | 'stable' = 'stable';\r\n      if (item.price_volatility > 0.1) {\r\n        trend = Math.random() > 0.5 ? 'rising' : 'falling'; // Simplified\r\n      }\r\n\r\n      currentTrends.push({\r\n        category: item.category,\r\n        trend,\r\n        changePercent: (item.price_volatility * 100),\r\n        confidence: Math.min(0.9, item.price_points / 10)\r\n      });\r\n\r\n      // Generate price forecast\r\n      const predictedPrice = item.avg_price * (1 + (Math.random() - 0.5) * 0.1);\r\n      priceForecasts.push({\r\n        itemId: item.item_id,\r\n        currentPrice: parseFloat(item.avg_price),\r\n        predictedPrice,\r\n        timeframe: '30 days',\r\n        confidence: Math.min(0.85, item.price_points / 15)\r\n      });\r\n\r\n      // Market opportunities\r\n      if (trend === 'falling') {\r\n        marketOpportunities.push({\r\n          type: 'buy' as const,\r\n          item: item.name,\r\n          reasoning: 'Price declining, good time to increase inventory',\r\n          potentialGain: item.price_volatility * 100,\r\n          risk: item.price_volatility > 0.2 ? 'high' as const : 'medium' as const\r\n        });\r\n      }\r\n    }\r\n\r\n    return {\r\n      currentTrends,\r\n      priceForecasts,\r\n      marketOpportunities\r\n    };\r\n  }\r\n\r\n  private async generateDemandAnalysis(organizationId: string): Promise<any> {\r\n    // Get seasonal patterns\r\n    const seasonalQuery = `\r\n      SELECT\r\n        ii.id as item_id,\r\n        ii.sku,\r\n        EXTRACT(MONTH FROM sm.timestamp) as month,\r\n        AVG(sm.quantity) as avg_demand\r\n      FROM public.inventory_items ii\r\n      JOIN stock_movements sm ON ii.id = sm.item_id\r\n      WHERE ii.organization_id = $1\r\n      AND sm.type = 'outbound'\r\n      AND sm.timestamp >= NOW() - INTERVAL '12 months'\r\n      GROUP BY ii.id, ii.sku, EXTRACT(MONTH FROM sm.timestamp)\r\n    `;\r\n\r\n    const seasonalResult = await this.db.query(seasonalQuery, [organizationId]);\r\n\r\n    const seasonalPatterns: Record<string, number[]> = {};\r\n    seasonalResult.rows.forEach(row => {\r\n      if (!seasonalPatterns[row.item_id]) {\r\n        seasonalPatterns[row.item_id] = new Array(12).fill(0);\r\n      }\r\n      seasonalPatterns[row.item_id][row.month - 1] = parseFloat(row.avg_demand);\r\n    });\r\n\r\n    return {\r\n      seasonalPatterns,\r\n      demandDrivers: [\r\n        { factor: 'Seasonality', impact: 0.3, confidence: 0.8 },\r\n        { factor: 'Market Trends', impact: 0.2, confidence: 0.6 },\r\n        { factor: 'Economic Factors', impact: 0.15, confidence: 0.5 }\r\n      ],\r\n      emergingTrends: [\r\n        {\r\n          pattern: 'Increased demand volatility',\r\n          strength: 0.7,\r\n          items: Object.keys(seasonalPatterns).slice(0, 5)\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  private async generateSupplierIntelligence(organizationId: string): Promise<any> {\r\n    // Get supplier performance data\r\n    const supplierQuery = `\r\n      SELECT\r\n        s.id,\r\n        s.name,\r\n        sp.overall_rating,\r\n        sp.on_time_delivery_rate,\r\n        sp.quality_acceptance_rate,\r\n        sp.response_time_hours\r\n      FROM public.suppliers s\r\n      LEFT JOIN supplier_performance sp ON s.id = sp.supplier_id\r\n      WHERE s.organization_id = $1\r\n      AND s.status = 'active'\r\n    `;\r\n\r\n    const supplierResult = await this.db.query(supplierQuery, [organizationId]);\r\n\r\n    const riskAssessment = [];\r\n    const performanceTrends = [];\r\n\r\n    supplierResult.rows.forEach(supplier => {\r\n      let riskLevel: 'low' | 'medium' | 'high' | 'critical' = 'low';\r\n      const riskFactors = [];\r\n\r\n      if (supplier.on_time_delivery_rate < 85) {\r\n        riskLevel = 'high';\r\n        riskFactors.push('Poor delivery performance');\r\n      }\r\n      if (supplier.quality_acceptance_rate < 90) {\r\n        riskLevel = supplier.quality_acceptance_rate < 80 ? 'critical' : 'high';\r\n        riskFactors.push('Quality issues');\r\n      }\r\n\r\n      riskAssessment.push({\r\n        supplierId: supplier.id,\r\n        riskLevel,\r\n        riskFactors,\r\n        mitigation: riskLevel === 'low' ? [] : ['Increase monitoring', 'Develop alternatives'],\r\n        impact: riskLevel === 'critical' ? 0.8 : riskLevel === 'high' ? 0.6 : 0.3\r\n      });\r\n\r\n      performanceTrends.push({\r\n        supplierId: supplier.id,\r\n        trend: 'stable' as const, // Simplified\r\n        metrics: {\r\n          delivery: supplier.on_time_delivery_rate || 0,\r\n          quality: supplier.quality_acceptance_rate || 0,\r\n          response: supplier.response_time_hours || 0\r\n        }\r\n      });\r\n    });\r\n\r\n    return {\r\n      riskAssessment,\r\n      performanceTrends,\r\n      alternativeSuppliers: [] // Would be populated with actual alternative analysis\r\n    };\r\n  }\r\n\r\n  async retrainModel(modelId: string): Promise<boolean> {\r\n    const model = this.models.get(modelId);\r\n    if (!model) {\r\n      throw new Error('Model not found');\r\n    }\r\n\r\n    try {\r\n      // Mark model as training\r\n      model.status = 'training';\r\n      await this.updateModelStatus(modelId, 'training');\r\n\r\n      // Simulate training process (in production, this would be actual ML training)\r\n      await new Promise(resolve => setTimeout(resolve, 5000));\r\n\r\n      // Update model with new training results\r\n      model.accuracy = Math.min(0.95, model.accuracy + Math.random() * 0.05);\r\n      model.lastTrained = new Date();\r\n      model.nextRetraining = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);\r\n      model.status = 'active';\r\n\r\n      await this.updateModel(model);\r\n      return true;\r\n\r\n    } catch (error) {\r\n      console.error('Model retraining error:', error);\r\n      model.status = 'error';\r\n      await this.updateModelStatus(modelId, 'error');\r\n      return false;\r\n    }\r\n  }\r\n\r\n  private async updateModel(model: PredictiveModel): Promise<void> {\r\n    await this.db.query(`\r\n      UPDATE predictive_models\r\n      SET accuracy = $1, last_trained = $2, next_retraining = $3, status = $4\r\n      WHERE id = $5\r\n    `, [model.accuracy, model.lastTrained, model.nextRetraining, model.status, model.id]);\r\n  }\r\n\r\n  private async updateModelStatus(modelId: string, status: string): Promise<void> {\r\n    await this.db.query(`\r\n      UPDATE predictive_models\r\n      SET status = $1, updated_at = NOW()\r\n      WHERE id = $2\r\n    `, [status, modelId]);\r\n  }\r\n\r\n  getActiveModels(): PredictiveModel[] {\r\n    return Array.from(this.models.values()).filter(model => model.status === 'active');\r\n  }\r\n\r\n  getModelPerformance(modelId: string): { accuracy: number; predictions: number; errors: number } {\r\n    // This would typically query the database for historical performance\r\n    const model = this.models.get(modelId);\r\n    return {\r\n      accuracy: model?.accuracy || 0,\r\n      predictions: 0, // Would be counted from database\r\n      errors: 0      // Would be counted from database\r\n    };\r\n  }\r\n}\r\n\r\n// Export the predictive analytics engine\r\nexport const predictiveAnalytics = {\r\n  engine: (db: Pool) => new PredictiveAnalyticsEngine(db)\r\n};","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\query-optimizer.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Intelligent Query Optimization and Database Performance Monitoring\r\n// Implements ML-based query optimization and real-time performance monitoring\r\n\r\nimport { Pool, QueryResult } from 'pg';\r\n\r\n// Types for Query Optimization\r\nexport interface QueryAnalysis {\r\n  query: string;\r\n  executionTime: number;\r\n  rowsReturned: number;\r\n  indexesUsed: string[];\r\n  tablesTouched: string[];\r\n  joinComplexity: number;\r\n  optimizationSuggestions: string[];\r\n  performanceScore: number; // 0-100\r\n  queryHash: string;\r\n  timestamp: Date;\r\n}\r\n\r\nexport interface QueryPlan {\r\n  nodeType: string;\r\n  totalCost: number;\r\n  planRows: number;\r\n  planWidth: number;\r\n  startupCost: number;\r\n  indexConditions?: string[];\r\n  joinType?: string;\r\n  filterConditions?: string[];\r\n  children?: QueryPlan[];\r\n}\r\n\r\nexport interface DatabaseMetrics {\r\n  connectionCount: number;\r\n  activeQueries: number;\r\n  slowQueries: number;\r\n  cacheHitRatio: number;\r\n  indexEfficiency: number;\r\n  tableSizes: Record<string, number>;\r\n  queryPerformance: {\r\n    averageExecutionTime: number;\r\n    slowestQueries: QueryAnalysis[];\r\n    mostFrequentQueries: QueryAnalysis[];\r\n  };\r\n  recommendedOptimizations: Array<{\r\n    type: 'index' | 'query' | 'schema' | 'configuration';\r\n    priority: 'low' | 'medium' | 'high' | 'critical';\r\n    description: string;\r\n    expectedImprovement: string;\r\n    implementation: string;\r\n  }>;\r\n  timestamp: Date;\r\n}\r\n\r\nexport interface OptimizedQuery {\r\n  originalQuery: string;\r\n  optimizedQuery: string;\r\n  optimizationType: 'index_hint' | 'join_reorder' | 'subquery_optimization' | 'partition_pruning';\r\n  expectedSpeedup: number;\r\n  explanation: string;\r\n  confidence: number;\r\n}\r\n\r\n// Query Performance Analyzer\r\nexport class QueryPerformanceAnalyzer {\r\n  private db: Pool;\r\n  private queryCache: Map<string, QueryAnalysis[]> = new Map();\r\n  private performanceThresholds = {\r\n    slowQueryTime: 1000, // milliseconds\r\n    highJoinComplexity: 5,\r\n    lowCacheHitRatio: 0.9\r\n  };\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n  }\r\n\r\n  async analyzeQuery(query: string): Promise<QueryAnalysis> {\r\n    const startTime = Date.now();\r\n    const queryHash = this.hashQuery(query);\r\n\r\n    try {\r\n      // Get query execution plan\r\n      const explainResult = await this.db.query(`EXPLAIN (FORMAT JSON, ANALYZE, BUFFERS) ${query}`);\r\n      const plan = explainResult.rows[0]['QUERY PLAN'][0];\r\n\r\n      // Execute query and measure performance\r\n      const result = await this.db.query(query);\r\n      const executionTime = Date.now() - startTime;\r\n\r\n      // Analyze query structure\r\n      const analysis = this.performQueryAnalysis(query, plan, result, executionTime);\r\n      analysis.queryHash = queryHash;\r\n\r\n      // Cache analysis\r\n      this.cacheQueryAnalysis(queryHash, analysis);\r\n\r\n      return analysis;\r\n\r\n    } catch (error) {\r\n      console.error('Query analysis error:', error);\r\n      return {\r\n        query,\r\n        executionTime: Date.now() - startTime,\r\n        rowsReturned: 0,\r\n        indexesUsed: [],\r\n        tablesTouched: [],\r\n        joinComplexity: 0,\r\n        optimizationSuggestions: ['Query failed to execute'],\r\n        performanceScore: 0,\r\n        queryHash,\r\n        timestamp: new Date()\r\n      };\r\n    }\r\n  }\r\n\r\n  private performQueryAnalysis(\r\n    query: string,\r\n    plan: any,\r\n    result: QueryResult,\r\n    executionTime: number\r\n  ): QueryAnalysis {\r\n    const indexesUsed = this.extractIndexesUsed(plan);\r\n    const tablesTouched = this.extractTables(query);\r\n    const joinComplexity = this.calculateJoinComplexity(plan);\r\n    const performanceScore = this.calculatePerformanceScore(executionTime, plan, result.rowCount);\r\n    const optimizationSuggestions = this.generateOptimizationSuggestions(\r\n      query, plan, executionTime, joinComplexity\r\n    );\r\n\r\n    return {\r\n      query,\r\n      executionTime,\r\n      rowsReturned: result.rowCount || 0,\r\n      indexesUsed,\r\n      tablesTouched,\r\n      joinComplexity,\r\n      optimizationSuggestions,\r\n      performanceScore,\r\n      queryHash: '',\r\n      timestamp: new Date()\r\n    };\r\n  }\r\n\r\n  private extractIndexesUsed(plan: any): string[] {\r\n    const indexes: string[] = [];\r\n\r\n    const extractFromNode = (node: any) => {\r\n      if (node['Node Type'] === 'Index Scan' || node['Node Type'] === 'Index Only Scan') {\r\n        indexes.push(node['Index Name'] || 'unknown');\r\n      }\r\n      if (node['Plans']) {\r\n        node['Plans'].forEach(extractFromNode);\r\n      }\r\n    };\r\n\r\n    extractFromNode(plan['Plan']);\r\n    return [...new Set(indexes)];\r\n  }\r\n\r\n  private extractTables(query: string): string[] {\r\n    const tableRegex = /(?:FROM|JOIN|UPDATE|INTO)\\s+([a-zA-Z_][a-zA-Z0-9_]*)/gi;\r\n    const matches = query.match(tableRegex) || [];\r\n    return matches.map(match => match.split(/\\s+/).pop()!).filter(Boolean);\r\n  }\r\n\r\n  private calculateJoinComplexity(plan: any): number {\r\n    let joinCount = 0;\r\n\r\n    const countJoins = (node: any) => {\r\n      if (node['Node Type']?.includes('Join')) {\r\n        joinCount++;\r\n      }\r\n      if (node['Plans']) {\r\n        node['Plans'].forEach(countJoins);\r\n      }\r\n    };\r\n\r\n    countJoins(plan['Plan']);\r\n    return joinCount;\r\n  }\r\n\r\n  private calculatePerformanceScore(executionTime: number, plan: any, rowCount: number): number {\r\n    // Base score calculation\r\n    let score = 100;\r\n\r\n    // Penalize slow execution time\r\n    if (executionTime > this.performanceThresholds.slowQueryTime) {\r\n      score -= Math.min(50, (executionTime - this.performanceThresholds.slowQueryTime) / 100);\r\n    }\r\n\r\n    // Penalize inefficient plans\r\n    const totalCost = plan['Plan']['Total Cost'];\r\n    if (totalCost > 1000) {\r\n      score -= Math.min(30, (totalCost - 1000) / 1000 * 30);\r\n    }\r\n\r\n    // Penalize sequential scans on large tables\r\n    const hasSeqScan = this.hasSequentialScan(plan['Plan']);\r\n    if (hasSeqScan && rowCount > 10000) {\r\n      score -= 20;\r\n    }\r\n\r\n    return Math.max(0, Math.round(score));\r\n  }\r\n\r\n  private hasSequentialScan(plan: any): boolean {\r\n    if (plan['Node Type'] === 'Seq Scan') return true;\r\n    if (plan['Plans']) {\r\n      return plan['Plans'].some((child: any) => this.hasSequentialScan(child));\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private generateOptimizationSuggestions(\r\n    query: string,\r\n    plan: any,\r\n    executionTime: number,\r\n    joinComplexity: number\r\n  ): string[] {\r\n    const suggestions: string[] = [];\r\n\r\n    // Slow query suggestions\r\n    if (executionTime > this.performanceThresholds.slowQueryTime) {\r\n      suggestions.push('Query execution time is above threshold. Consider optimization.');\r\n    }\r\n\r\n    // Index suggestions\r\n    if (this.hasSequentialScan(plan['Plan'])) {\r\n      suggestions.push('Sequential scan detected. Consider adding indexes on filtered columns.');\r\n    }\r\n\r\n    // Join optimization\r\n    if (joinComplexity > this.performanceThresholds.highJoinComplexity) {\r\n      suggestions.push('High join complexity. Consider query restructuring or denormalization.');\r\n    }\r\n\r\n    // Query structure suggestions\r\n    if (query.includes('SELECT *')) {\r\n      suggestions.push('Avoid SELECT * statements. Specify only needed columns.');\r\n    }\r\n\r\n    if (query.match(/WHERE.*OR.*OR/i)) {\r\n      suggestions.push('Multiple OR conditions may benefit from UNION optimization.');\r\n    }\r\n\r\n    return suggestions;\r\n  }\r\n\r\n  private hashQuery(query: string): string {\r\n    // Simple hash function for query identification\r\n    return query.toLowerCase()\r\n      .replace(/\\s+/g, ' ')\r\n      .replace(/\\d+/g, '?') // Replace numbers with placeholders\r\n      .split('').reduce((hash, char) => {\r\n        const charCode = char.charCodeAt(0);\r\n        return ((hash << 5) - hash) + charCode;\r\n      }, 0).toString();\r\n  }\r\n\r\n  private cacheQueryAnalysis(queryHash: string, analysis: QueryAnalysis) {\r\n    if (!this.queryCache.has(queryHash)) {\r\n      this.queryCache.set(queryHash, []);\r\n    }\r\n    const analyses = this.queryCache.get(queryHash)!;\r\n    analyses.push(analysis);\r\n\r\n    // Keep only last 10 analyses per query\r\n    if (analyses.length > 10) {\r\n      analyses.shift();\r\n    }\r\n  }\r\n\r\n  async getQueryStatistics(queryHash?: string): Promise<QueryAnalysis[]> {\r\n    if (queryHash) {\r\n      return this.queryCache.get(queryHash) || [];\r\n    }\r\n\r\n    // Return all cached analyses\r\n    const allAnalyses: QueryAnalysis[] = [];\r\n    this.queryCache.forEach(analyses => allAnalyses.push(...analyses));\r\n    return allAnalyses.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\r\n  }\r\n}\r\n\r\n// Intelligent Query Optimizer\r\nexport class IntelligentQueryOptimizer {\r\n  private db: Pool;\r\n  private analyzer: QueryPerformanceAnalyzer;\r\n  private optimizationPatterns: Array<{\r\n    pattern: RegExp;\r\n    optimization: (query: string) => string;\r\n    type: string;\r\n    expectedSpeedup: number;\r\n  }>;\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n    this.analyzer = new QueryPerformanceAnalyzer(database);\r\n    this.initializeOptimizationPatterns();\r\n  }\r\n\r\n  private initializeOptimizationPatterns() {\r\n    this.optimizationPatterns = [\r\n      {\r\n        pattern: /SELECT \\* FROM (\\w+) WHERE (\\w+) IN \\([^)]+\\)/i,\r\n        optimization: (query) => this.optimizeInClause(query),\r\n        type: 'in_clause_optimization',\r\n        expectedSpeedup: 1.3\r\n      },\r\n      {\r\n        pattern: /SELECT .* FROM (\\w+) .* ORDER BY (\\w+) LIMIT (\\d+)/i,\r\n        optimization: (query) => this.optimizeTopN(query),\r\n        type: 'top_n_optimization',\r\n        expectedSpeedup: 2.0\r\n      },\r\n      {\r\n        pattern: /SELECT .* FROM (\\w+) a JOIN (\\w+) b ON .* WHERE/i,\r\n        optimization: (query) => this.optimizeJoinOrder(query),\r\n        type: 'join_reorder',\r\n        expectedSpeedup: 1.5\r\n      },\r\n      {\r\n        pattern: /EXISTS\\s*\\(\\s*SELECT/i,\r\n        optimization: (query) => this.optimizeExistsClause(query),\r\n        type: 'exists_optimization',\r\n        expectedSpeedup: 1.4\r\n      }\r\n    ];\r\n  }\r\n\r\n  async optimizeQuery(query: string): Promise<OptimizedQuery | null> {\r\n    try {\r\n      // Analyze original query\r\n      const originalAnalysis = await this.analyzer.analyzeQuery(query);\r\n\r\n      // Find applicable optimization patterns\r\n      for (const pattern of this.optimizationPatterns) {\r\n        if (pattern.pattern.test(query)) {\r\n          const optimizedQuery = pattern.optimization(query);\r\n\r\n          if (optimizedQuery !== query) {\r\n            // Test optimized query\r\n            const optimizedAnalysis = await this.analyzer.analyzeQuery(optimizedQuery);\r\n\r\n            if (optimizedAnalysis.performanceScore > originalAnalysis.performanceScore) {\r\n              return {\r\n                originalQuery: query,\r\n                optimizedQuery,\r\n                optimizationType: pattern.type as any,\r\n                expectedSpeedup: pattern.expectedSpeedup,\r\n                explanation: this.getOptimizationExplanation(pattern.type),\r\n                confidence: this.calculateOptimizationConfidence(originalAnalysis, optimizedAnalysis)\r\n              };\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      return null;\r\n\r\n    } catch (error) {\r\n      console.error('Query optimization error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private optimizeInClause(query: string): string {\r\n    // Convert IN clause to EXISTS where applicable\r\n    return query.replace(\r\n      /WHERE (\\w+) IN \\(([^)]+)\\)/i,\r\n      'WHERE EXISTS (SELECT 1 FROM (VALUES $2) AS t(val) WHERE t.val = $1)'\r\n    );\r\n  }\r\n\r\n  private optimizeTopN(query: string): string {\r\n    // Add index hints for ORDER BY + LIMIT\r\n    const match = query.match(/ORDER BY (\\w+)/i);\r\n    if (match) {\r\n      return `${query} /* INDEX HINT: ${match[1]}_idx */`;\r\n    }\r\n    return query;\r\n  }\r\n\r\n  private optimizeJoinOrder(query: string): string {\r\n    // Simple join reordering based on table size estimation\r\n    // In production, this would use statistics\r\n    return query.replace(\r\n      /FROM (\\w+) a JOIN (\\w+) b/i,\r\n      'FROM $2 b JOIN $1 a'\r\n    );\r\n  }\r\n\r\n  private optimizeExistsClause(query: string): string {\r\n    // Convert correlated EXISTS to JOIN where possible\r\n    return query.replace(\r\n      /WHERE EXISTS\\s*\\(\\s*SELECT[^)]+FROM (\\w+)[^)]+WHERE[^)]+\\)/i,\r\n      'WHERE id IN (SELECT DISTINCT referenced_id FROM $1 WHERE ...)'\r\n    );\r\n  }\r\n\r\n  private getOptimizationExplanation(type: string): string {\r\n    const explanations = {\r\n      'in_clause_optimization': 'Converted IN clause to EXISTS for better index utilization',\r\n      'top_n_optimization': 'Added index hint for ORDER BY + LIMIT optimization',\r\n      'join_reorder': 'Reordered joins to process smaller table first',\r\n      'exists_optimization': 'Converted correlated subquery to more efficient form'\r\n    };\r\n\r\n    return explanations[type as keyof typeof explanations] || 'Applied query optimization';\r\n  }\r\n\r\n  private calculateOptimizationConfidence(\r\n    original: QueryAnalysis,\r\n    optimized: QueryAnalysis\r\n  ): number {\r\n    const executionImprovement = (original.executionTime - optimized.executionTime) / original.executionTime;\r\n    const scoreImprovement = (optimized.performanceScore - original.performanceScore) / 100;\r\n\r\n    return Math.min(0.95, Math.max(0.1, (executionImprovement + scoreImprovement) / 2));\r\n  }\r\n}\r\n\r\n// Database Performance Monitor\r\nexport class DatabasePerformanceMonitor {\r\n  private db: Pool;\r\n  private monitoringInterval: NodeJS.Timeout | null = null;\r\n  private metricsHistory: DatabaseMetrics[] = [];\r\n\r\n  constructor(database: Pool) {\r\n    this.db = database;\r\n  }\r\n\r\n  async getCurrentMetrics(): Promise<DatabaseMetrics> {\r\n    try {\r\n      const [\r\n        connectionStats,\r\n        queryStats,\r\n        cacheStats,\r\n        tableStats,\r\n        slowQueries\r\n      ] = await Promise.all([\r\n        this.getConnectionStats(),\r\n        this.getQueryStats(),\r\n        this.getCacheStats(),\r\n        this.getTableStats(),\r\n        this.getSlowQueries()\r\n      ]);\r\n\r\n      const metrics: DatabaseMetrics = {\r\n        connectionCount: connectionStats.total,\r\n        activeQueries: connectionStats.active,\r\n        slowQueries: slowQueries.length,\r\n        cacheHitRatio: cacheStats.hitRatio,\r\n        indexEfficiency: await this.calculateIndexEfficiency(),\r\n        tableSizes: tableStats,\r\n        queryPerformance: {\r\n          averageExecutionTime: queryStats.avgTime,\r\n          slowestQueries: slowQueries,\r\n          mostFrequentQueries: await this.getMostFrequentQueries()\r\n        },\r\n        recommendedOptimizations: await this.generateOptimizationRecommendations(),\r\n        timestamp: new Date()\r\n      };\r\n\r\n      // Store in history\r\n      this.metricsHistory.push(metrics);\r\n      if (this.metricsHistory.length > 100) {\r\n        this.metricsHistory.shift();\r\n      }\r\n\r\n      return metrics;\r\n\r\n    } catch (error) {\r\n      console.error('Error collecting database metrics:', error);\r\n      throw new Error('Failed to collect database metrics');\r\n    }\r\n  }\r\n\r\n  private async getConnectionStats(): Promise<{ total: number; active: number }> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT\r\n          COUNT(*) as total,\r\n          COUNT(CASE WHEN state = 'active' THEN 1 END) as active\r\n        FROM pg_stat_activity\r\n        WHERE datname = current_database()\r\n      `);\r\n\r\n      return {\r\n        total: parseInt(result.rows[0].total),\r\n        active: parseInt(result.rows[0].active)\r\n      };\r\n    } catch {\r\n      return { total: 0, active: 0 };\r\n    }\r\n  }\r\n\r\n  private async getQueryStats(): Promise<{ avgTime: number }> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT AVG(mean_exec_time) as avg_time\r\n        FROM pg_stat_statements\r\n        WHERE calls > 10\r\n      `);\r\n\r\n      return { avgTime: parseFloat(result.rows[0]?.avg_time || '0') };\r\n    } catch {\r\n      return { avgTime: 0 };\r\n    }\r\n  }\r\n\r\n  private async getCacheStats(): Promise<{ hitRatio: number }> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT\r\n          SUM(blks_hit) / (SUM(blks_hit) + SUM(blks_read))::float as hit_ratio\r\n        FROM pg_stat_database\r\n        WHERE datname = current_database()\r\n      `);\r\n\r\n      return { hitRatio: parseFloat(result.rows[0]?.hit_ratio || '0.9') };\r\n    } catch {\r\n      return { hitRatio: 0.9 };\r\n    }\r\n  }\r\n\r\n  private async getTableStats(): Promise<Record<string, number>> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT\r\n          schemaname || '.' || tablename as table_name,\r\n          pg_total_relation_size(schemaname||'.'||tablename) as size_bytes\r\n        FROM pg_tables\r\n        WHERE schemaname = 'public'\r\n        ORDER BY size_bytes DESC\r\n        LIMIT 20\r\n      `);\r\n\r\n      const tableStats: Record<string, number> = {};\r\n      result.rows.forEach(row => {\r\n        tableStats[row.table_name] = parseInt(row.size_bytes);\r\n      });\r\n\r\n      return tableStats;\r\n    } catch {\r\n      return {};\r\n    }\r\n  }\r\n\r\n  private async getSlowQueries(): Promise<QueryAnalysis[]> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT\r\n          query,\r\n          mean_exec_time as execution_time,\r\n          calls,\r\n          total_exec_time\r\n        FROM pg_stat_statements\r\n        WHERE mean_exec_time > 1000\r\n        ORDER BY mean_exec_time DESC\r\n        LIMIT 10\r\n      `);\r\n\r\n      return result.rows.map(row => ({\r\n        query: row.query,\r\n        executionTime: parseFloat(row.execution_time),\r\n        rowsReturned: 0,\r\n        indexesUsed: [],\r\n        tablesTouched: [],\r\n        joinComplexity: 0,\r\n        optimizationSuggestions: ['Query execution time above threshold'],\r\n        performanceScore: Math.max(0, 100 - (row.execution_time / 100)),\r\n        queryHash: '',\r\n        timestamp: new Date()\r\n      }));\r\n    } catch {\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private async getMostFrequentQueries(): Promise<QueryAnalysis[]> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT\r\n          query,\r\n          calls,\r\n          mean_exec_time\r\n        FROM pg_stat_statements\r\n        ORDER BY calls DESC\r\n        LIMIT 10\r\n      `);\r\n\r\n      return result.rows.map(row => ({\r\n        query: row.query,\r\n        executionTime: parseFloat(row.mean_exec_time),\r\n        rowsReturned: 0,\r\n        indexesUsed: [],\r\n        tablesTouched: [],\r\n        joinComplexity: 0,\r\n        optimizationSuggestions: [],\r\n        performanceScore: 80,\r\n        queryHash: '',\r\n        timestamp: new Date()\r\n      }));\r\n    } catch {\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private async calculateIndexEfficiency(): Promise<number> {\r\n    try {\r\n      const result = await this.db.query(`\r\n        SELECT\r\n          AVG(idx_scan / GREATEST(seq_scan + idx_scan, 1)::float) as efficiency\r\n        FROM pg_stat_user_tables\r\n        WHERE schemaname = 'public'\r\n      `);\r\n\r\n      return parseFloat(result.rows[0]?.efficiency || '0.5');\r\n    } catch {\r\n      return 0.5;\r\n    }\r\n  }\r\n\r\n  private async generateOptimizationRecommendations(): Promise<Array<{\r\n    type: 'index' | 'query' | 'schema' | 'configuration';\r\n    priority: 'low' | 'medium' | 'high' | 'critical';\r\n    description: string;\r\n    expectedImprovement: string;\r\n    implementation: string;\r\n  }>> {\r\n    const recommendations = [];\r\n\r\n    // Check for missing indexes\r\n    try {\r\n      const seqScanResult = await this.db.query(`\r\n        SELECT\r\n          schemaname || '.' || tablename as table_name,\r\n          seq_scan,\r\n          seq_tup_read\r\n        FROM pg_stat_user_tables\r\n        WHERE seq_scan > 1000 AND seq_tup_read > 100000\r\n        ORDER BY seq_tup_read DESC\r\n        LIMIT 5\r\n      `);\r\n\r\n      seqScanResult.rows.forEach(row => {\r\n        recommendations.push({\r\n          type: 'index' as const,\r\n          priority: 'high' as const,\r\n          description: `Table ${row.table_name} has high sequential scan activity`,\r\n          expectedImprovement: '30-60% query performance improvement',\r\n          implementation: `Analyze query patterns and add appropriate indexes to ${row.table_name}`\r\n        });\r\n      });\r\n    } catch (error) {\r\n      console.error('Error generating index recommendations:', error);\r\n    }\r\n\r\n    // Check cache hit ratio\r\n    const cacheStats = await this.getCacheStats();\r\n    if (cacheStats.hitRatio < 0.9) {\r\n      recommendations.push({\r\n        type: 'configuration',\r\n        priority: 'medium',\r\n        description: `Low cache hit ratio: ${(cacheStats.hitRatio * 100).toFixed(1)}%`,\r\n        expectedImprovement: '10-20% overall performance improvement',\r\n        implementation: 'Increase shared_buffers or optimize query patterns'\r\n      });\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n\r\n  startMonitoring(intervalMs: number = 60000) {\r\n    if (this.monitoringInterval) {\r\n      clearInterval(this.monitoringInterval);\r\n    }\r\n\r\n    this.monitoringInterval = setInterval(async () => {\r\n      try {\r\n        await this.getCurrentMetrics();\r\n      } catch (error) {\r\n        console.error('Monitoring error:', error);\r\n      }\r\n    }, intervalMs);\r\n  }\r\n\r\n  stopMonitoring() {\r\n    if (this.monitoringInterval) {\r\n      clearInterval(this.monitoringInterval);\r\n      this.monitoringInterval = null;\r\n    }\r\n  }\r\n\r\n  getMetricsHistory(): DatabaseMetrics[] {\r\n    return [...this.metricsHistory];\r\n  }\r\n}\r\n\r\n// Export all optimization classes\r\nexport const queryOptimization = {\r\n  analyzer: (db: Pool) => new QueryPerformanceAnalyzer(db),\r\n  optimizer: (db: Pool) => new IntelligentQueryOptimizer(db),\r\n  monitor: (db: Pool) => new DatabasePerformanceMonitor(db)\r\n};\r\n\r\n// Export individual classes for direct import\r\nexport { QueryPerformanceAnalyzer as QueryOptimizer };\r\n// DatabasePerformanceMonitor is already exported in class declaration","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\analytics\\real-time-anomaly-detection.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":652,"column":17,"nodeType":"TemplateLiteral","endLine":659,"endColumn":10}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Real-Time Anomaly Detection with Machine Learning\r\n// Implements advanced anomaly detection algorithms for continuous monitoring\r\n\r\nimport { Pool } from 'pg';\r\nimport EventEmitter from 'events';\r\n\r\n// Types for Anomaly Detection\r\nexport interface AnomalyDetectionModel {\r\n  id: string;\r\n  name: string;\r\n  type: 'statistical' | 'isolation_forest' | 'autoencoder' | 'lstm' | 'ensemble';\r\n  targetMetric: string;\r\n  sensitivity: number; // 0-1, higher = more sensitive\r\n  windowSize: number; // Number of data points to consider\r\n  trainingData: number;\r\n  lastTrained: Date;\r\n  accuracy: number;\r\n  falsePositiveRate: number;\r\n  parameters: Record<string, any>;\r\n  status: 'active' | 'training' | 'inactive';\r\n}\r\n\r\nexport interface AnomalyAlert {\r\n  id: string;\r\n  type: 'supplier_performance' | 'inventory_movement' | 'price_fluctuation' | 'system_performance' | 'demand_pattern';\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n  title: string;\r\n  description: string;\r\n\r\n  detection: {\r\n    modelId: string;\r\n    algorithm: string;\r\n    confidence: number;\r\n    anomalyScore: number;\r\n    threshold: number;\r\n  };\r\n\r\n  context: {\r\n    entityId: string;\r\n    entityType: 'supplier' | 'inventory_item' | 'category' | 'system';\r\n    entityName: string;\r\n    currentValue: number;\r\n    expectedValue: number;\r\n    deviation: number;\r\n    historicalContext: {\r\n      min: number;\r\n      max: number;\r\n      mean: number;\r\n      stdDev: number;\r\n    };\r\n  };\r\n\r\n  impact: {\r\n    riskLevel: 'low' | 'medium' | 'high' | 'critical';\r\n    potentialLoss: number;\r\n    affectedOperations: string[];\r\n    urgency: number; // 0-1\r\n  };\r\n\r\n  recommendation: {\r\n    action: string;\r\n    priority: 'immediate' | 'urgent' | 'scheduled' | 'monitor';\r\n    steps: string[];\r\n    estimatedResolutionTime: string;\r\n    preventiveMeasures: string[];\r\n  };\r\n\r\n  detectedAt: Date;\r\n  acknowledgedAt?: Date;\r\n  acknowledgedBy?: string;\r\n  resolvedAt?: Date;\r\n  resolution?: string;\r\n  falsePositive?: boolean;\r\n}\r\n\r\nexport interface AnomalyPattern {\r\n  id: string;\r\n  pattern: string;\r\n  frequency: number;\r\n  lastOccurrence: Date;\r\n  entities: string[];\r\n  rootCause?: string;\r\n  preventionStrategy?: string;\r\n}\r\n\r\n// Statistical Anomaly Detector\r\nexport class StatisticalAnomalyDetector {\r\n  private model: AnomalyDetectionModel;\r\n  private historicalData: number[] = [];\r\n  private statistics: {\r\n    mean: number;\r\n    stdDev: number;\r\n    median: number;\r\n    q1: number;\r\n    q3: number;\r\n  } = { mean: 0, stdDev: 0, median: 0, q1: 0, q3: 0 };\r\n\r\n  constructor(model: AnomalyDetectionModel) {\r\n    this.model = model;\r\n  }\r\n\r\n  train(data: number[]): void {\r\n    this.historicalData = data.slice(-this.model.windowSize);\r\n    this.calculateStatistics();\r\n  }\r\n\r\n  private calculateStatistics(): void {\r\n    if (this.historicalData.length === 0) return;\r\n\r\n    const sorted = [...this.historicalData].sort((a, b) => a - b);\r\n    const n = sorted.length;\r\n\r\n    this.statistics.mean = this.historicalData.reduce((sum, val) => sum + val, 0) / n;\r\n\r\n    const variance = this.historicalData.reduce(\r\n      (sum, val) => sum + Math.pow(val - this.statistics.mean, 2), 0\r\n    ) / n;\r\n    this.statistics.stdDev = Math.sqrt(variance);\r\n\r\n    this.statistics.median = n % 2 === 0\r\n      ? (sorted[n/2 - 1] + sorted[n/2]) / 2\r\n      : sorted[Math.floor(n/2)];\r\n\r\n    this.statistics.q1 = sorted[Math.floor(n * 0.25)];\r\n    this.statistics.q3 = sorted[Math.floor(n * 0.75)];\r\n  }\r\n\r\n  detect(value: number): { isAnomaly: boolean; score: number; method: string } {\r\n    if (this.historicalData.length < 10) {\r\n      return { isAnomaly: false, score: 0, method: 'insufficient_data' };\r\n    }\r\n\r\n    // Z-score method\r\n    const zScore = Math.abs((value - this.statistics.mean) / Math.max(this.statistics.stdDev, 0.1));\r\n    const zThreshold = 2 + (this.model.sensitivity * 1); // 2-3 sigma\r\n\r\n    // IQR method\r\n    const iqr = this.statistics.q3 - this.statistics.q1;\r\n    const lowerBound = this.statistics.q1 - 1.5 * iqr;\r\n    const upperBound = this.statistics.q3 + 1.5 * iqr;\r\n    const iqrAnomaly = value < lowerBound || value > upperBound;\r\n\r\n    // Modified Z-score using median\r\n    const medianDev = Math.abs(value - this.statistics.median);\r\n    const mad = this.calculateMAD();\r\n    const modifiedZScore = 0.6745 * medianDev / Math.max(mad, 0.1);\r\n    const modifiedZThreshold = 3.5;\r\n\r\n    // Combine methods\r\n    const zAnom = zScore > zThreshold;\r\n    const modZAnom = modifiedZScore > modifiedZThreshold;\r\n\r\n    const isAnomaly = zAnom || iqrAnomaly || modZAnom;\r\n    const score = Math.max(zScore / zThreshold, modifiedZScore / modifiedZThreshold);\r\n\r\n    return {\r\n      isAnomaly,\r\n      score: Math.min(1, score),\r\n      method: `statistical(z:${zScore.toFixed(2)},iqr:${iqrAnomaly},mz:${modifiedZScore.toFixed(2)})`\r\n    };\r\n  }\r\n\r\n  private calculateMAD(): number {\r\n    if (this.historicalData.length === 0) return 0;\r\n\r\n    const deviations = this.historicalData.map(val => Math.abs(val - this.statistics.median));\r\n    deviations.sort((a, b) => a - b);\r\n\r\n    const n = deviations.length;\r\n    return n % 2 === 0\r\n      ? (deviations[n/2 - 1] + deviations[n/2]) / 2\r\n      : deviations[Math.floor(n/2)];\r\n  }\r\n\r\n  updateModel(newData: number[]): void {\r\n    this.historicalData.push(...newData);\r\n    if (this.historicalData.length > this.model.windowSize) {\r\n      this.historicalData = this.historicalData.slice(-this.model.windowSize);\r\n    }\r\n    this.calculateStatistics();\r\n  }\r\n\r\n  getStatistics() {\r\n    return { ...this.statistics };\r\n  }\r\n}\r\n\r\n// Isolation Forest Implementation (Simplified)\r\nexport class IsolationForestDetector {\r\n  private model: AnomalyDetectionModel;\r\n  private trees: Array<{\r\n    root: any;\r\n    height: number;\r\n  }> = [];\r\n  private numTrees: number = 100;\r\n  private subsampleSize: number = 256;\r\n\r\n  constructor(model: AnomalyDetectionModel) {\r\n    this.model = model;\r\n    this.numTrees = model.parameters.numTrees || 100;\r\n    this.subsampleSize = model.parameters.subsampleSize || 256;\r\n  }\r\n\r\n  train(data: number[][]): void {\r\n    this.trees = [];\r\n\r\n    for (let i = 0; i < this.numTrees; i++) {\r\n      const subsample = this.createSubsample(data);\r\n      const tree = this.buildTree(subsample, 0);\r\n      this.trees.push(tree);\r\n    }\r\n  }\r\n\r\n  private createSubsample(data: number[][]): number[][] {\r\n    const subsample = [];\r\n    for (let i = 0; i < Math.min(this.subsampleSize, data.length); i++) {\r\n      const randomIndex = Math.floor(Math.random() * data.length);\r\n      subsample.push(data[randomIndex]);\r\n    }\r\n    return subsample;\r\n  }\r\n\r\n  private buildTree(data: number[][], depth: number): any {\r\n    if (data.length <= 1 || depth >= 10) {\r\n      return { size: data.length, isLeaf: true, depth };\r\n    }\r\n\r\n    // Random feature selection\r\n    const featureIndex = Math.floor(Math.random() * data[0].length);\r\n    const values = data.map(point => point[featureIndex]);\r\n    const min = Math.min(...values);\r\n    const max = Math.max(...values);\r\n\r\n    if (min === max) {\r\n      return { size: data.length, isLeaf: true, depth };\r\n    }\r\n\r\n    const splitValue = min + Math.random() * (max - min);\r\n\r\n    const leftData = data.filter(point => point[featureIndex] < splitValue);\r\n    const rightData = data.filter(point => point[featureIndex] >= splitValue);\r\n\r\n    return {\r\n      featureIndex,\r\n      splitValue,\r\n      left: this.buildTree(leftData, depth + 1),\r\n      right: this.buildTree(rightData, depth + 1),\r\n      isLeaf: false,\r\n      depth\r\n    };\r\n  }\r\n\r\n  detect(point: number[]): { isAnomaly: boolean; score: number; method: string } {\r\n    if (this.trees.length === 0) {\r\n      return { isAnomaly: false, score: 0, method: 'not_trained' };\r\n    }\r\n\r\n    const avgPathLength = this.trees.reduce((sum, tree) => {\r\n      return sum + this.pathLength(point, tree.root);\r\n    }, 0) / this.trees.length;\r\n\r\n    const c = this.cFunction(this.subsampleSize);\r\n    const anomalyScore = Math.pow(2, -avgPathLength / c);\r\n\r\n    const threshold = 0.5 + (this.model.sensitivity * 0.3); // 0.5-0.8 threshold\r\n    const isAnomaly = anomalyScore > threshold;\r\n\r\n    return {\r\n      isAnomaly,\r\n      score: anomalyScore,\r\n      method: `isolation_forest(avg_path:${avgPathLength.toFixed(2)})`\r\n    };\r\n  }\r\n\r\n  private pathLength(point: number[], node: any): number {\r\n    if (node.isLeaf) {\r\n      return node.depth + this.cFunction(node.size);\r\n    }\r\n\r\n    if (point[node.featureIndex] < node.splitValue) {\r\n      return this.pathLength(point, node.left);\r\n    } else {\r\n      return this.pathLength(point, node.right);\r\n    }\r\n  }\r\n\r\n  private cFunction(n: number): number {\r\n    if (n <= 1) return 0;\r\n    return 2 * (Math.log(n - 1) + 0.5772156649) - (2 * (n - 1) / n);\r\n  }\r\n}\r\n\r\n// LSTM Autoencoder for Time Series Anomaly Detection\r\nexport class LSTMAutoencoderDetector {\r\n  private model: AnomalyDetectionModel;\r\n  private sequenceLength: number;\r\n  private reconstructionErrors: number[] = [];\r\n\r\n  constructor(model: AnomalyDetectionModel) {\r\n    this.model = model;\r\n    this.sequenceLength = model.parameters.sequenceLength || 10;\r\n  }\r\n\r\n  train(timeSeries: number[]): void {\r\n    // Simplified LSTM autoencoder simulation\r\n    const sequences = this.createSequences(timeSeries);\r\n    this.reconstructionErrors = [];\r\n\r\n    // Calculate reconstruction errors for training data\r\n    for (const sequence of sequences) {\r\n      const reconstructed = this.simulateReconstruction(sequence);\r\n      const error = this.calculateReconstructionError(sequence, reconstructed);\r\n      this.reconstructionErrors.push(error);\r\n    }\r\n  }\r\n\r\n  private createSequences(data: number[]): number[][] {\r\n    const sequences = [];\r\n    for (let i = 0; i <= data.length - this.sequenceLength; i++) {\r\n      sequences.push(data.slice(i, i + this.sequenceLength));\r\n    }\r\n    return sequences;\r\n  }\r\n\r\n  private simulateReconstruction(sequence: number[]): number[] {\r\n    // Simplified reconstruction simulation\r\n    // In real implementation, this would use a trained LSTM autoencoder\r\n    const reconstructed = [];\r\n    for (let i = 0; i < sequence.length; i++) {\r\n      let predicted = sequence[i];\r\n\r\n      // Add some smoothing based on neighbors\r\n      if (i > 0) predicted = (predicted + sequence[i-1]) / 2;\r\n      if (i < sequence.length - 1) predicted = (predicted + sequence[i+1]) / 2;\r\n\r\n      // Add slight noise to simulate imperfect reconstruction\r\n      predicted += (Math.random() - 0.5) * 0.1 * Math.abs(predicted);\r\n\r\n      reconstructed.push(predicted);\r\n    }\r\n    return reconstructed;\r\n  }\r\n\r\n  private calculateReconstructionError(original: number[], reconstructed: number[]): number {\r\n    let mse = 0;\r\n    for (let i = 0; i < original.length; i++) {\r\n      mse += Math.pow(original[i] - reconstructed[i], 2);\r\n    }\r\n    return mse / original.length;\r\n  }\r\n\r\n  detect(sequence: number[]): { isAnomaly: boolean; score: number; method: string } {\r\n    if (sequence.length !== this.sequenceLength) {\r\n      return { isAnomaly: false, score: 0, method: 'invalid_sequence_length' };\r\n    }\r\n\r\n    if (this.reconstructionErrors.length === 0) {\r\n      return { isAnomaly: false, score: 0, method: 'not_trained' };\r\n    }\r\n\r\n    const reconstructed = this.simulateReconstruction(sequence);\r\n    const error = this.calculateReconstructionError(sequence, reconstructed);\r\n\r\n    // Calculate threshold based on training errors\r\n    const meanError = this.reconstructionErrors.reduce((sum, err) => sum + err, 0) / this.reconstructionErrors.length;\r\n    const stdError = Math.sqrt(\r\n      this.reconstructionErrors.reduce((sum, err) => sum + Math.pow(err - meanError, 2), 0) / this.reconstructionErrors.length\r\n    );\r\n\r\n    const threshold = meanError + (2 + this.model.sensitivity * 2) * stdError;\r\n    const isAnomaly = error > threshold;\r\n    const score = Math.min(1, error / threshold);\r\n\r\n    return {\r\n      isAnomaly,\r\n      score,\r\n      method: `lstm_autoencoder(error:${error.toFixed(4)},threshold:${threshold.toFixed(4)})`\r\n    };\r\n  }\r\n}\r\n\r\n// Real-Time Anomaly Detection Engine\r\nexport class RealTimeAnomalyDetectionEngine extends EventEmitter {\r\n  private db: Pool;\r\n  private models: Map<string, AnomalyDetectionModel> = new Map();\r\n  private detectors: Map<string, any> = new Map();\r\n  private alertHistory: AnomalyAlert[] = [];\r\n  private patterns: Map<string, AnomalyPattern> = new Map();\r\n  private isMonitoring: boolean = false;\r\n  private monitoringInterval: NodeJS.Timeout | null = null;\r\n\r\n  constructor(database: Pool) {\r\n    super();\r\n    this.db = database;\r\n    this.initializeModels();\r\n  }\r\n\r\n  private async initializeModels(): Promise<void> {\r\n    try {\r\n      // Load models from database\r\n      const result = await this.db.query(`\r\n        SELECT * FROM anomaly_detection_models\r\n        WHERE status = 'active'\r\n      `);\r\n\r\n      for (const row of result.rows) {\r\n        const model: AnomalyDetectionModel = {\r\n          id: row.id,\r\n          name: row.name,\r\n          type: row.type,\r\n          targetMetric: row.target_metric,\r\n          sensitivity: parseFloat(row.sensitivity),\r\n          windowSize: parseInt(row.window_size),\r\n          trainingData: parseInt(row.training_data),\r\n          lastTrained: new Date(row.last_trained),\r\n          accuracy: parseFloat(row.accuracy),\r\n          falsePositiveRate: parseFloat(row.false_positive_rate),\r\n          parameters: JSON.parse(row.parameters || '{}'),\r\n          status: row.status\r\n        };\r\n\r\n        this.models.set(model.id, model);\r\n        await this.initializeDetector(model);\r\n      }\r\n\r\n      // Create default models if none exist\r\n      if (this.models.size === 0) {\r\n        await this.createDefaultModels();\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error initializing anomaly detection models:', error);\r\n      await this.createDefaultModels();\r\n    }\r\n  }\r\n\r\n  private async createDefaultModels(): Promise<void> {\r\n    const defaultModels = [\r\n      {\r\n        name: 'Supplier Performance Anomaly Detector',\r\n        type: 'statistical',\r\n        targetMetric: 'supplier_performance',\r\n        sensitivity: 0.7,\r\n        windowSize: 50,\r\n        parameters: {}\r\n      },\r\n      {\r\n        name: 'Inventory Movement Anomaly Detector',\r\n        type: 'isolation_forest',\r\n        targetMetric: 'inventory_movement',\r\n        sensitivity: 0.6,\r\n        windowSize: 100,\r\n        parameters: { numTrees: 100, subsampleSize: 256 }\r\n      },\r\n      {\r\n        name: 'Price Fluctuation Detector',\r\n        type: 'lstm',\r\n        targetMetric: 'price_fluctuation',\r\n        sensitivity: 0.8,\r\n        windowSize: 30,\r\n        parameters: { sequenceLength: 10 }\r\n      }\r\n    ];\r\n\r\n    for (const modelConfig of defaultModels) {\r\n      await this.createModel(modelConfig);\r\n    }\r\n  }\r\n\r\n  private async createModel(config: any): Promise<string> {\r\n    const modelId = `model_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n    const now = new Date();\r\n\r\n    const model: AnomalyDetectionModel = {\r\n      id: modelId,\r\n      name: config.name,\r\n      type: config.type,\r\n      targetMetric: config.targetMetric,\r\n      sensitivity: config.sensitivity,\r\n      windowSize: config.windowSize,\r\n      trainingData: 0,\r\n      lastTrained: now,\r\n      accuracy: 0.85,\r\n      falsePositiveRate: 0.05,\r\n      parameters: config.parameters,\r\n      status: 'active'\r\n    };\r\n\r\n    try {\r\n      await this.db.query(`\r\n        INSERT INTO anomaly_detection_models (\r\n          id, name, type, target_metric, sensitivity, window_size,\r\n          training_data, last_trained, accuracy, false_positive_rate,\r\n          parameters, status, created_at\r\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, NOW())\r\n      `, [\r\n        model.id, model.name, model.type, model.targetMetric,\r\n        model.sensitivity, model.windowSize, model.trainingData,\r\n        model.lastTrained, model.accuracy, model.falsePositiveRate,\r\n        JSON.stringify(model.parameters), model.status\r\n      ]);\r\n\r\n      this.models.set(modelId, model);\r\n      await this.initializeDetector(model);\r\n\r\n      return modelId;\r\n\r\n    } catch (error) {\r\n      console.error('Error creating anomaly detection model:', error);\r\n      throw new Error('Failed to create anomaly detection model');\r\n    }\r\n  }\r\n\r\n  private async initializeDetector(model: AnomalyDetectionModel): Promise<void> {\r\n    let detector;\r\n\r\n    switch (model.type) {\r\n      case 'statistical':\r\n        detector = new StatisticalAnomalyDetector(model);\r\n        break;\r\n      case 'isolation_forest':\r\n        detector = new IsolationForestDetector(model);\r\n        break;\r\n      case 'lstm':\r\n        detector = new LSTMAutoencoderDetector(model);\r\n        break;\r\n      default:\r\n        detector = new StatisticalAnomalyDetector(model);\r\n    }\r\n\r\n    // Train detector with historical data\r\n    await this.trainDetector(detector, model);\r\n    this.detectors.set(model.id, detector);\r\n  }\r\n\r\n  private async trainDetector(detector: any, model: AnomalyDetectionModel): Promise<void> {\r\n    try {\r\n      // Get historical data based on target metric\r\n      const data = await this.getHistoricalData(model.targetMetric, model.windowSize * 2);\r\n\r\n      if (data.length < 10) {\r\n        console.warn(`Insufficient training data for model ${model.id}`);\r\n        return;\r\n      }\r\n\r\n      if (model.type === 'isolation_forest') {\r\n        // For isolation forest, convert to multi-dimensional data\r\n        const features = data.map((value, index) => [value, index]);\r\n        detector.train(features);\r\n      } else {\r\n        // For statistical and LSTM models\r\n        detector.train(data);\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error(`Error training detector for model ${model.id}:`, error);\r\n    }\r\n  }\r\n\r\n  private async getHistoricalData(targetMetric: string, limit: number): Promise<number[]> {\r\n    let query = '';\r\n    const params: any[] = [limit];\r\n\r\n    switch (targetMetric) {\r\n      case 'supplier_performance':\r\n        query = `\r\n          SELECT overall_rating\r\n          FROM supplier_performance\r\n          ORDER BY evaluation_date DESC\r\n          LIMIT $1\r\n        `;\r\n        break;\r\n      case 'inventory_movement':\r\n        query = `\r\n          SELECT quantity\r\n          FROM stock_movements\r\n          WHERE type = 'outbound'\r\n          ORDER BY timestamp DESC\r\n          LIMIT $1\r\n        `;\r\n        break;\r\n      case 'price_fluctuation':\r\n        query = `\r\n          SELECT unit_cost\r\n          FROM stock_movements\r\n          WHERE unit_cost IS NOT NULL\r\n          ORDER BY timestamp DESC\r\n          LIMIT $1\r\n        `;\r\n        break;\r\n      default:\r\n        return [];\r\n    }\r\n\r\n    try {\r\n      const result = await this.db.query(query, params);\r\n      return result.rows.map(row => parseFloat(Object.values(row)[0] as string));\r\n    } catch (error) {\r\n      console.error(`Error fetching historical data for ${targetMetric}:`, error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async detectAnomalies(organizationId: string): Promise<AnomalyAlert[]> {\r\n    const alerts: AnomalyAlert[] = [];\r\n\r\n    try {\r\n      // Check each active model\r\n      for (const [modelId, model] of this.models) {\r\n        if (model.status !== 'active') continue;\r\n\r\n        const detector = this.detectors.get(modelId);\r\n        if (!detector) continue;\r\n\r\n        const recentData = await this.getRecentData(model.targetMetric, organizationId);\r\n\r\n        for (const dataPoint of recentData) {\r\n          const detection = await this.performDetection(detector, model, dataPoint);\r\n\r\n          if (detection.isAnomaly) {\r\n            const alert = await this.createAnomalyAlert(model, detection, dataPoint);\r\n            alerts.push(alert);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Store alerts in database\r\n      for (const alert of alerts) {\r\n        await this.storeAlert(alert);\r\n      }\r\n\r\n      // Emit real-time alerts\r\n      if (alerts.length > 0) {\r\n        this.emit('anomaliesDetected', alerts);\r\n      }\r\n\r\n      return alerts;\r\n\r\n    } catch (error) {\r\n      console.error('Error detecting anomalies:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private async getRecentData(targetMetric: string, organizationId: string): Promise<any[]> {\r\n    let query = '';\r\n    const params: any[] = [organizationId];\r\n\r\n    switch (targetMetric) {\r\n      case 'supplier_performance':\r\n        query = `\r\n          SELECT sp.*, s.name as supplier_name, s.id as supplier_id\r\n          FROM supplier_performance sp\r\n          JOIN suppliers s ON sp.supplier_id = s.id\r\n          WHERE s.organization_id = $1\r\n          AND sp.evaluation_date >= NOW() - INTERVAL '1 hour'\r\n          ORDER BY sp.evaluation_date DESC\r\n        `;\r\n        break;\r\n      case 'inventory_movement':\r\n        query = `\r\n          SELECT sm.*, ii.name as item_name, ii.id as item_id\r\n          FROM stock_movements sm\r\n          JOIN inventory_items ii ON sm.item_id = ii.id\r\n          WHERE ii.organization_id = $1\r\n          AND sm.timestamp >= NOW() - INTERVAL '1 hour'\r\n          ORDER BY sm.timestamp DESC\r\n        `;\r\n        break;\r\n      case 'price_fluctuation':\r\n        query = `\r\n          SELECT sm.*, ii.name as item_name, ii.id as item_id\r\n          FROM stock_movements sm\r\n          JOIN inventory_items ii ON sm.item_id = ii.id\r\n          WHERE ii.organization_id = $1\r\n          AND sm.unit_cost IS NOT NULL\r\n          AND sm.timestamp >= NOW() - INTERVAL '1 hour'\r\n          ORDER BY sm.timestamp DESC\r\n        `;\r\n        break;\r\n      default:\r\n        return [];\r\n    }\r\n\r\n    try {\r\n      const result = await this.db.query(query, params);\r\n      return result.rows;\r\n    } catch (error) {\r\n      console.error(`Error fetching recent data for ${targetMetric}:`, error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  private async performDetection(detector: any, model: AnomalyDetectionModel, dataPoint: any): Promise<any> {\r\n    let value: number;\r\n    let sequence: number[];\r\n\r\n    switch (model.targetMetric) {\r\n      case 'supplier_performance':\r\n        value = parseFloat(dataPoint.overall_rating);\r\n        break;\r\n      case 'inventory_movement':\r\n        value = parseFloat(dataPoint.quantity);\r\n        break;\r\n      case 'price_fluctuation':\r\n        value = parseFloat(dataPoint.unit_cost);\r\n        break;\r\n      default:\r\n        return { isAnomaly: false, score: 0, method: 'unknown_metric' };\r\n    }\r\n\r\n    if (model.type === 'lstm') {\r\n      // For LSTM, need sequence data\r\n      const historicalData = await this.getHistoricalData(model.targetMetric, model.parameters.sequenceLength);\r\n      sequence = [...historicalData.slice(0, model.parameters.sequenceLength - 1), value];\r\n      return {\r\n        ...detector.detect(sequence),\r\n        value,\r\n        dataPoint\r\n      };\r\n    } else if (model.type === 'isolation_forest') {\r\n      // For isolation forest, create feature vector\r\n      const features = [value, Date.now()]; // Simple feature set\r\n      return {\r\n        ...detector.detect(features),\r\n        value,\r\n        dataPoint\r\n      };\r\n    } else {\r\n      // For statistical methods\r\n      return {\r\n        ...detector.detect(value),\r\n        value,\r\n        dataPoint\r\n      };\r\n    }\r\n  }\r\n\r\n  private async createAnomalyAlert(\r\n    model: AnomalyDetectionModel,\r\n    detection: any,\r\n    dataPoint: any\r\n  ): Promise<AnomalyAlert> {\r\n    const alertId = `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    // Determine severity based on anomaly score\r\n    let severity: 'low' | 'medium' | 'high' | 'critical' = 'low';\r\n    if (detection.score > 0.9) severity = 'critical';\r\n    else if (detection.score > 0.7) severity = 'high';\r\n    else if (detection.score > 0.5) severity = 'medium';\r\n\r\n    // Calculate expected value and deviation\r\n    const historicalStats = await this.getHistoricalStatistics(model.targetMetric);\r\n    const expectedValue = historicalStats.mean;\r\n    const deviation = Math.abs(detection.value - expectedValue) / Math.max(expectedValue, 1);\r\n\r\n    const alert: AnomalyAlert = {\r\n      id: alertId,\r\n      type: this.getAlertType(model.targetMetric),\r\n      severity,\r\n      title: `${model.name}: Anomaly Detected`,\r\n      description: this.generateAlertDescription(model, detection, dataPoint),\r\n\r\n      detection: {\r\n        modelId: model.id,\r\n        algorithm: model.type,\r\n        confidence: detection.score,\r\n        anomalyScore: detection.score,\r\n        threshold: model.sensitivity\r\n      },\r\n\r\n      context: {\r\n        entityId: this.getEntityId(dataPoint, model.targetMetric),\r\n        entityType: this.getEntityType(model.targetMetric),\r\n        entityName: this.getEntityName(dataPoint, model.targetMetric),\r\n        currentValue: detection.value,\r\n        expectedValue,\r\n        deviation,\r\n        historicalContext: historicalStats\r\n      },\r\n\r\n      impact: {\r\n        riskLevel: severity,\r\n        potentialLoss: this.estimatePotentialLoss(model.targetMetric, deviation),\r\n        affectedOperations: this.getAffectedOperations(model.targetMetric),\r\n        urgency: Math.min(1, detection.score)\r\n      },\r\n\r\n      recommendation: this.generateRecommendation(model, detection, severity),\r\n\r\n      detectedAt: new Date()\r\n    };\r\n\r\n    return alert;\r\n  }\r\n\r\n  private getAlertType(targetMetric: string): AnomalyAlert['type'] {\r\n    const mapping: Record<string, AnomalyAlert['type']> = {\r\n      'supplier_performance': 'supplier_performance',\r\n      'inventory_movement': 'inventory_movement',\r\n      'price_fluctuation': 'price_fluctuation'\r\n    };\r\n    return mapping[targetMetric] || 'system_performance';\r\n  }\r\n\r\n  private getEntityId(dataPoint: any, targetMetric: string): string {\r\n    switch (targetMetric) {\r\n      case 'supplier_performance': return dataPoint.supplier_id;\r\n      case 'inventory_movement': return dataPoint.item_id;\r\n      case 'price_fluctuation': return dataPoint.item_id;\r\n      default: return 'unknown';\r\n    }\r\n  }\r\n\r\n  private getEntityType(targetMetric: string): AnomalyAlert['context']['entityType'] {\r\n    switch (targetMetric) {\r\n      case 'supplier_performance': return 'supplier';\r\n      case 'inventory_movement': return 'inventory_item';\r\n      case 'price_fluctuation': return 'inventory_item';\r\n      default: return 'system';\r\n    }\r\n  }\r\n\r\n  private getEntityName(dataPoint: any, targetMetric: string): string {\r\n    switch (targetMetric) {\r\n      case 'supplier_performance': return dataPoint.supplier_name || 'Unknown Supplier';\r\n      case 'inventory_movement': return dataPoint.item_name || 'Unknown Item';\r\n      case 'price_fluctuation': return dataPoint.item_name || 'Unknown Item';\r\n      default: return 'System';\r\n    }\r\n  }\r\n\r\n  private async getHistoricalStatistics(targetMetric: string): Promise<any> {\r\n    const data = await this.getHistoricalData(targetMetric, 100);\r\n\r\n    if (data.length === 0) {\r\n      return { min: 0, max: 0, mean: 0, stdDev: 0 };\r\n    }\r\n\r\n    const sorted = [...data].sort((a, b) => a - b);\r\n    const mean = data.reduce((sum, val) => sum + val, 0) / data.length;\r\n    const variance = data.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / data.length;\r\n    const stdDev = Math.sqrt(variance);\r\n\r\n    return {\r\n      min: sorted[0],\r\n      max: sorted[sorted.length - 1],\r\n      mean,\r\n      stdDev\r\n    };\r\n  }\r\n\r\n  private estimatePotentialLoss(targetMetric: string, deviation: number): number {\r\n    const baseLoss = {\r\n      'supplier_performance': 10000,\r\n      'inventory_movement': 5000,\r\n      'price_fluctuation': 15000\r\n    };\r\n\r\n    return (baseLoss[targetMetric] || 1000) * deviation;\r\n  }\r\n\r\n  private getAffectedOperations(targetMetric: string): string[] {\r\n    const operations: Record<string, string[]> = {\r\n      'supplier_performance': ['Procurement', 'Quality Control', 'Delivery Schedule'],\r\n      'inventory_movement': ['Inventory Management', 'Order Fulfillment', 'Demand Planning'],\r\n      'price_fluctuation': ['Cost Management', 'Pricing Strategy', 'Vendor Negotiations']\r\n    };\r\n\r\n    return operations[targetMetric] || ['General Operations'];\r\n  }\r\n\r\n  private generateAlertDescription(model: AnomalyDetectionModel, detection: any, dataPoint: any): string {\r\n    return `Anomaly detected in ${model.targetMetric} with confidence ${(detection.score * 100).toFixed(1)}%. ` +\r\n           `Current value: ${detection.value}, Detection method: ${detection.method}`;\r\n  }\r\n\r\n  private generateRecommendation(\r\n    model: AnomalyDetectionModel,\r\n    detection: any,\r\n    severity: string\r\n  ): AnomalyAlert['recommendation'] {\r\n    const urgentActions = {\r\n      'supplier_performance': 'Review supplier performance metrics and contact supplier',\r\n      'inventory_movement': 'Investigate unusual inventory movement and verify accuracy',\r\n      'price_fluctuation': 'Review price changes and validate with supplier'\r\n    };\r\n\r\n    const steps = [\r\n      'Verify the anomaly is not a false positive',\r\n      'Investigate root cause',\r\n      'Take corrective action if necessary',\r\n      'Monitor for recurrence'\r\n    ];\r\n\r\n    return {\r\n      action: urgentActions[model.targetMetric] || 'Investigate anomaly',\r\n      priority: severity === 'critical' ? 'immediate' : severity === 'high' ? 'urgent' : 'scheduled',\r\n      steps,\r\n      estimatedResolutionTime: severity === 'critical' ? '1-2 hours' : '1-2 days',\r\n      preventiveMeasures: [\r\n        'Implement automated monitoring',\r\n        'Set up early warning thresholds',\r\n        'Regular performance reviews'\r\n      ]\r\n    };\r\n  }\r\n\r\n  private async storeAlert(alert: AnomalyAlert): Promise<void> {\r\n    try {\r\n      await this.db.query(`\r\n        INSERT INTO anomaly_alerts (\r\n          id, type, severity, title, description, detection,\r\n          context, impact, recommendation, detected_at\r\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\r\n      `, [\r\n        alert.id, alert.type, alert.severity, alert.title, alert.description,\r\n        JSON.stringify(alert.detection), JSON.stringify(alert.context),\r\n        JSON.stringify(alert.impact), JSON.stringify(alert.recommendation),\r\n        alert.detectedAt\r\n      ]);\r\n\r\n      this.alertHistory.push(alert);\r\n      if (this.alertHistory.length > 1000) {\r\n        this.alertHistory.shift();\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error storing anomaly alert:', error);\r\n    }\r\n  }\r\n\r\n  startMonitoring(intervalMs: number = 60000): void {\r\n    if (this.isMonitoring) return;\r\n\r\n    this.isMonitoring = true;\r\n    this.monitoringInterval = setInterval(async () => {\r\n      try {\r\n        await this.detectAnomalies('default'); // Use default org for now\r\n      } catch (error) {\r\n        console.error('Monitoring error:', error);\r\n      }\r\n    }, intervalMs);\r\n\r\n    console.log('Real-time anomaly detection monitoring started');\r\n  }\r\n\r\n  stopMonitoring(): void {\r\n    if (!this.isMonitoring) return;\r\n\r\n    this.isMonitoring = false;\r\n    if (this.monitoringInterval) {\r\n      clearInterval(this.monitoringInterval);\r\n      this.monitoringInterval = null;\r\n    }\r\n\r\n    console.log('Real-time anomaly detection monitoring stopped');\r\n  }\r\n\r\n  async acknowledgeAlert(alertId: string, userId: string): Promise<boolean> {\r\n    try {\r\n      await this.db.query(`\r\n        UPDATE anomaly_alerts\r\n        SET acknowledged_at = NOW(), acknowledged_by = $1\r\n        WHERE id = $2\r\n      `, [userId, alertId]);\r\n\r\n      const alert = this.alertHistory.find(a => a.id === alertId);\r\n      if (alert) {\r\n        alert.acknowledgedAt = new Date();\r\n        alert.acknowledgedBy = userId;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error acknowledging alert:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async resolveAlert(alertId: string, resolution: string, userId: string): Promise<boolean> {\r\n    try {\r\n      await this.db.query(`\r\n        UPDATE anomaly_alerts\r\n        SET resolved_at = NOW(), resolution = $1\r\n        WHERE id = $2\r\n      `, [resolution, alertId]);\r\n\r\n      const alert = this.alertHistory.find(a => a.id === alertId);\r\n      if (alert) {\r\n        alert.resolvedAt = new Date();\r\n        alert.resolution = resolution;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error resolving alert:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  getActiveAlerts(): AnomalyAlert[] {\r\n    return this.alertHistory.filter(alert => !alert.resolvedAt);\r\n  }\r\n\r\n  getAlertHistory(limit: number = 100): AnomalyAlert[] {\r\n    return this.alertHistory\r\n      .sort((a, b) => b.detectedAt.getTime() - a.detectedAt.getTime())\r\n      .slice(0, limit);\r\n  }\r\n\r\n  getModelPerformance(): Array<{\r\n    modelId: string;\r\n    name: string;\r\n    accuracy: number;\r\n    falsePositiveRate: number;\r\n    alertsGenerated: number;\r\n    lastTrained: Date;\r\n  }> {\r\n    return Array.from(this.models.values()).map(model => ({\r\n      modelId: model.id,\r\n      name: model.name,\r\n      accuracy: model.accuracy,\r\n      falsePositiveRate: model.falsePositiveRate,\r\n      alertsGenerated: this.alertHistory.filter(alert =>\r\n        alert.detection.modelId === model.id\r\n      ).length,\r\n      lastTrained: model.lastTrained\r\n    }));\r\n  }\r\n}\r\n\r\n// Export real-time anomaly detection\r\nexport const realTimeAnomalyDetection = {\r\n  engine: (db: Pool) => new RealTimeAnomalyDetectionEngine(db),\r\n  statisticalDetector: (model: AnomalyDetectionModel) => new StatisticalAnomalyDetector(model),\r\n  isolationForestDetector: (model: AnomalyDetectionModel) => new IsolationForestDetector(model),\r\n  lstmDetector: (model: AnomalyDetectionModel) => new LSTMAutoencoderDetector(model)\r\n};","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\api-client.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":91,"column":22,"nodeType":"Identifier","messageId":"undef","endLine":91,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":104,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":104,"endColumn":19}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * Enhanced API Client with Retry Logic, Error Handling, and Offline Support\r\n * Provides resilient API communication with automatic retries and fallback mechanisms\r\n */\r\n\r\nimport { QueryClient } from '@tanstack/react-query';\r\n\r\nexport interface ApiClientConfig {\r\n  baseURL?: string;\r\n  timeout?: number;\r\n  retries?: number;\r\n  retryDelay?: number;\r\n  retryDelayType?: 'fixed' | 'exponential';\r\n  maxRetryDelay?: number;\r\n  onlineCheck?: boolean;\r\n  offlineStorage?: boolean;\r\n}\r\n\r\nexport interface ApiResponse<T = any> {\r\n  success: boolean;\r\n  data?: T;\r\n  error?: string;\r\n  message?: string;\r\n  code?: number;\r\n  timestamp?: string;\r\n  requestId?: string;\r\n}\r\n\r\nexport interface RetryConfig {\r\n  attempts: number;\r\n  delay: number;\r\n  maxDelay: number;\r\n  backoffFactor: number;\r\n  retryCondition?: (error: any) => boolean;\r\n}\r\n\r\nclass ApiClient {\r\n  private config: Required<ApiClientConfig>;\r\n  private retryConfig: RetryConfig;\r\n  private abortControllers: Map<string, AbortController> = new Map();\r\n  private offlineQueue: Array<{ key: string; request: () => Promise<any> }> = [];\r\n  private isOnline: boolean = true;\r\n\r\n  constructor(config: ApiClientConfig = {}) {\r\n    this.config = {\r\n      baseURL: config.baseURL || '',\r\n      timeout: config.timeout || 10000,\r\n      retries: config.retries || 3,\r\n      retryDelay: config.retryDelay || 1000,\r\n      retryDelayType: config.retryDelayType || 'exponential',\r\n      maxRetryDelay: config.maxRetryDelay || 30000,\r\n      onlineCheck: config.onlineCheck ?? true,\r\n      offlineStorage: config.offlineStorage ?? true,\r\n    };\r\n\r\n    this.retryConfig = {\r\n      attempts: this.config.retries,\r\n      delay: this.config.retryDelay,\r\n      maxDelay: this.config.maxRetryDelay,\r\n      backoffFactor: 2,\r\n      retryCondition: this.shouldRetry,\r\n    };\r\n\r\n    this.setupOnlineDetection();\r\n    this.setupOfflineQueue();\r\n  }\r\n\r\n  private setupOnlineDetection() {\r\n    if (typeof window === 'undefined' || !this.config.onlineCheck) return;\r\n\r\n    this.isOnline = navigator.onLine;\r\n\r\n    window.addEventListener('online', () => {\r\n      console.log('🌐 Connection restored');\r\n      this.isOnline = true;\r\n      this.processOfflineQueue();\r\n    });\r\n\r\n    window.addEventListener('offline', () => {\r\n      console.log('📡 Connection lost - entering offline mode');\r\n      this.isOnline = false;\r\n    });\r\n  }\r\n\r\n  private setupOfflineQueue() {\r\n    if (typeof window === 'undefined' || !this.config.offlineStorage) return;\r\n\r\n    // Load queued requests from localStorage\r\n    try {\r\n      const stored = localStorage.getItem('api_offline_queue');\r\n      if (stored) {\r\n        this.offlineQueue = JSON.parse(stored);\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to load offline queue:', error);\r\n    }\r\n  }\r\n\r\n  private saveOfflineQueue() {\r\n    if (typeof window === 'undefined' || !this.config.offlineStorage) return;\r\n\r\n    try {\r\n      localStorage.setItem('api_offline_queue', JSON.stringify(this.offlineQueue));\r\n    } catch (error) {\r\n      console.warn('Failed to save offline queue:', error);\r\n    }\r\n  }\r\n\r\n  private async processOfflineQueue() {\r\n    if (this.offlineQueue.length === 0) return;\r\n\r\n    console.log(`📦 Processing ${this.offlineQueue.length} queued requests`);\r\n\r\n    const queue = [...this.offlineQueue];\r\n    this.offlineQueue = [];\r\n    this.saveOfflineQueue();\r\n\r\n    for (const item of queue) {\r\n      try {\r\n        await item.request();\r\n        console.log(`✅ Processed queued request: ${item.key}`);\r\n      } catch (error) {\r\n        console.error(`❌ Failed to process queued request: ${item.key}`, error);\r\n        // Re-queue if it's a retryable error\r\n        if (this.shouldRetry(error)) {\r\n          this.offlineQueue.push(item);\r\n        }\r\n      }\r\n    }\r\n\r\n    this.saveOfflineQueue();\r\n  }\r\n\r\n  private shouldRetry = (error: any): boolean => {\r\n    // Don't retry on successful responses\r\n    if (error?.response?.status < 400) return false;\r\n\r\n    // Always retry on network errors\r\n    if (!error?.response) return true;\r\n\r\n    // Retry on server errors (5xx)\r\n    if (error.response.status >= 500) return true;\r\n\r\n    // Retry on specific client errors\r\n    const retryableClientErrors = [408, 429]; // Timeout, Too Many Requests\r\n    if (retryableClientErrors.includes(error.response.status)) return true;\r\n\r\n    // Don't retry on authentication/authorization errors\r\n    if ([401, 403].includes(error.response.status)) return false;\r\n\r\n    // Don't retry on client errors (4xx) except above\r\n    if (error.response.status >= 400 && error.response.status < 500) return false;\r\n\r\n    return false;\r\n  };\r\n\r\n  private async delay(ms: number): Promise<void> {\r\n    return new Promise(resolve => setTimeout(resolve, ms));\r\n  }\r\n\r\n  private calculateRetryDelay(attempt: number): number {\r\n    if (this.config.retryDelayType === 'fixed') {\r\n      return this.config.retryDelay;\r\n    }\r\n\r\n    // Exponential backoff with jitter\r\n    const exponentialDelay = this.config.retryDelay * Math.pow(this.retryConfig.backoffFactor, attempt - 1);\r\n    const jitter = Math.random() * 0.1 * exponentialDelay; // 10% jitter\r\n    return Math.min(exponentialDelay + jitter, this.config.maxRetryDelay);\r\n  }\r\n\r\n  private createAbortController(requestId: string): AbortController {\r\n    // Cancel any existing request with the same ID\r\n    const existing = this.abortControllers.get(requestId);\r\n    if (existing) {\r\n      existing.abort();\r\n    }\r\n\r\n    const controller = new AbortController();\r\n    this.abortControllers.set(requestId, controller);\r\n\r\n    // Auto-cleanup after timeout\r\n    setTimeout(() => {\r\n      this.abortControllers.delete(requestId);\r\n    }, this.config.timeout + 5000);\r\n\r\n    return controller;\r\n  }\r\n\r\n  private async executeWithRetry<T>(\r\n    requestFn: () => Promise<T>,\r\n    requestId: string = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n  ): Promise<T> {\r\n    let lastError: any;\r\n\r\n    for (let attempt = 1; attempt <= this.retryConfig.attempts + 1; attempt++) {\r\n      try {\r\n        const result = await requestFn();\r\n\r\n        // Clear any queued retries for this request on success\r\n        this.offlineQueue = this.offlineQueue.filter(item => item.key !== requestId);\r\n        this.saveOfflineQueue();\r\n\r\n        return result;\r\n      } catch (error) {\r\n        lastError = error;\r\n\r\n        console.warn(`❌ API request failed (attempt ${attempt}/${this.retryConfig.attempts + 1}):`, {\r\n          requestId,\r\n          error: error.message,\r\n          status: error?.response?.status,\r\n          willRetry: attempt <= this.retryConfig.attempts && this.retryConfig.retryCondition?.(error)\r\n        });\r\n\r\n        // Don't retry if we've exhausted attempts\r\n        if (attempt > this.retryConfig.attempts) break;\r\n\r\n        // Don't retry if the error is not retryable\r\n        if (!this.retryConfig.retryCondition?.(error)) break;\r\n\r\n        // If offline, queue the request instead of retrying immediately\r\n        if (!this.isOnline && this.config.offlineStorage) {\r\n          this.offlineQueue.push({\r\n            key: requestId,\r\n            request: requestFn,\r\n          });\r\n          this.saveOfflineQueue();\r\n          throw new Error('Request queued for when connection is restored');\r\n        }\r\n\r\n        // Wait before retrying\r\n        const delayMs = this.calculateRetryDelay(attempt);\r\n        await this.delay(delayMs);\r\n      }\r\n    }\r\n\r\n    throw lastError;\r\n  }\r\n\r\n  async request<T = any>(\r\n    endpoint: string,\r\n    options: RequestInit & {\r\n      requestId?: string;\r\n      timeout?: number;\r\n      skipRetry?: boolean;\r\n    } = {}\r\n  ): Promise<ApiResponse<T>> {\r\n    const requestId = options.requestId || `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n    const timeout = options.timeout || this.config.timeout;\r\n\r\n    // Remove custom options from fetch options\r\n    const { requestId: _, timeout: __, skipRetry, ...fetchOptions } = options;\r\n\r\n    const controller = this.createAbortController(requestId);\r\n\r\n    const requestFn = async (): Promise<ApiResponse<T>> => {\r\n      // Add timeout\r\n      const timeoutId = setTimeout(() => {\r\n        controller.abort();\r\n      }, timeout);\r\n\r\n      try {\r\n        const url = endpoint.startsWith('http') ? endpoint : `${this.config.baseURL}${endpoint}`;\r\n\r\n        const response = await fetch(url, {\r\n          ...fetchOptions,\r\n          signal: controller.signal,\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'X-Request-ID': requestId,\r\n            'X-Timestamp': new Date().toISOString(),\r\n            ...fetchOptions.headers,\r\n          },\r\n        });\r\n\r\n        clearTimeout(timeoutId);\r\n\r\n        let data: any;\r\n        const contentType = response.headers.get('content-type');\r\n\r\n        if (contentType?.includes('application/json')) {\r\n          data = await response.json();\r\n        } else {\r\n          data = await response.text();\r\n        }\r\n\r\n        // Handle different response formats\r\n        if (!response.ok) {\r\n          const error = new Error(data?.message || data?.error || `HTTP ${response.status}: ${response.statusText}`);\r\n          (error as any).response = response;\r\n          (error as any).data = data;\r\n          throw error;\r\n        }\r\n\r\n        // Normalize response format\r\n        if (typeof data === 'object' && data !== null) {\r\n          if ('success' in data || 'data' in data || 'error' in data) {\r\n            return data as ApiResponse<T>;\r\n          } else {\r\n            return {\r\n              success: true,\r\n              data: data as T,\r\n              timestamp: new Date().toISOString(),\r\n              requestId,\r\n            };\r\n          }\r\n        }\r\n\r\n        return {\r\n          success: true,\r\n          data: data as T,\r\n          timestamp: new Date().toISOString(),\r\n          requestId,\r\n        };\r\n\r\n      } catch (error) {\r\n        clearTimeout(timeoutId);\r\n\r\n        if (controller.signal.aborted) {\r\n          const timeoutError = new Error(`Request timeout after ${timeout}ms`);\r\n          (timeoutError as any).code = 'TIMEOUT';\r\n          throw timeoutError;\r\n        }\r\n\r\n        throw error;\r\n      } finally {\r\n        this.abortControllers.delete(requestId);\r\n      }\r\n    };\r\n\r\n    if (skipRetry) {\r\n      return requestFn();\r\n    }\r\n\r\n    return this.executeWithRetry(requestFn, requestId);\r\n  }\r\n\r\n  // Convenience methods\r\n  async get<T = any>(endpoint: string, options?: RequestInit & { requestId?: string }): Promise<ApiResponse<T>> {\r\n    return this.request<T>(endpoint, { ...options, method: 'GET' });\r\n  }\r\n\r\n  async post<T = any>(endpoint: string, data?: any, options?: RequestInit & { requestId?: string }): Promise<ApiResponse<T>> {\r\n    return this.request<T>(endpoint, {\r\n      ...options,\r\n      method: 'POST',\r\n      body: data ? JSON.stringify(data) : undefined,\r\n    });\r\n  }\r\n\r\n  async put<T = any>(endpoint: string, data?: any, options?: RequestInit & { requestId?: string }): Promise<ApiResponse<T>> {\r\n    return this.request<T>(endpoint, {\r\n      ...options,\r\n      method: 'PUT',\r\n      body: data ? JSON.stringify(data) : undefined,\r\n    });\r\n  }\r\n\r\n  async patch<T = any>(endpoint: string, data?: any, options?: RequestInit & { requestId?: string }): Promise<ApiResponse<T>> {\r\n    return this.request<T>(endpoint, {\r\n      ...options,\r\n      method: 'PATCH',\r\n      body: data ? JSON.stringify(data) : undefined,\r\n    });\r\n  }\r\n\r\n  async delete<T = any>(endpoint: string, options?: RequestInit & { requestId?: string }): Promise<ApiResponse<T>> {\r\n    return this.request<T>(endpoint, { ...options, method: 'DELETE' });\r\n  }\r\n\r\n  // Cancel specific request\r\n  cancelRequest(requestId: string): void {\r\n    const controller = this.abortControllers.get(requestId);\r\n    if (controller) {\r\n      controller.abort();\r\n      this.abortControllers.delete(requestId);\r\n    }\r\n  }\r\n\r\n  // Cancel all pending requests\r\n  cancelAllRequests(): void {\r\n    for (const [requestId, controller] of this.abortControllers) {\r\n      controller.abort();\r\n    }\r\n    this.abortControllers.clear();\r\n  }\r\n\r\n  // Get offline queue status\r\n  getOfflineQueueStatus() {\r\n    return {\r\n      isOnline: this.isOnline,\r\n      queuedRequests: this.offlineQueue.length,\r\n      queue: this.offlineQueue.map(item => ({ key: item.key })),\r\n    };\r\n  }\r\n\r\n  // Clear offline queue\r\n  clearOfflineQueue(): void {\r\n    this.offlineQueue = [];\r\n    this.saveOfflineQueue();\r\n  }\r\n}\r\n\r\n// Create default instance\r\nexport const apiClient = new ApiClient();\r\n\r\n// Export factory function for custom instances\r\nexport const createApiClient = (config: ApiClientConfig) => new ApiClient(config);\r\n\r\n// Enhanced React Query error retry logic\r\nexport const queryRetryFn = (failureCount: number, error: any) => {\r\n  // Don't retry authentication errors\r\n  if (error?.response?.status === 401 || error?.response?.status === 403) {\r\n    return false;\r\n  }\r\n\r\n  // Don't retry client errors (except timeout and rate limit)\r\n  if (error?.response?.status >= 400 && error?.response?.status < 500) {\r\n    const retryableClientErrors = [408, 429];\r\n    if (!retryableClientErrors.includes(error?.response?.status)) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Retry up to 3 times with exponential backoff\r\n  return failureCount < 3;\r\n};\r\n\r\n// Enhanced React Query error retry delay\r\nexport const queryRetryDelay = (attemptIndex: number) => Math.min(1000 * 2 ** attemptIndex, 30000);\r\n\r\nexport default apiClient;","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\api\\middleware.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15},{"ruleId":"no-undef","severity":2,"message":"'atob' is not defined.","line":454,"column":36,"nodeType":"Identifier","messageId":"undef","endLine":454,"endColumn":40}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\n/**\n * Comprehensive API middleware for authentication, authorization, and request validation\n */\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { SecurityMiddleware, SecurityConfig, SecurityContext } from '@/lib/security/middleware'\n\n// Rate limiting configuration\nconst RATE_LIMITS = {\n  default: { requests: 100, window: 60000 }, // 100 requests per minute\n  auth: { requests: 5, window: 60000 }, // 5 auth requests per minute\n  upload: { requests: 10, window: 60000 }, // 10 uploads per minute\n  bulk: { requests: 5, window: 300000 }, // 5 bulk operations per 5 minutes\n  aiGenerate: { requests: 40, window: 60000 }, // AI text generation quotas\n  aiAnalyze: { requests: 8, window: 600000 }, // Analysis workloads are heavier\n}\n\n// Mock user data - in production this would come from database\nconst mockUsers = new Map([\n  ['admin@company.com', {\n    id: 'user_001',\n    email: 'admin@company.com',\n    name: 'System Administrator',\n    role: 'admin',\n    permissions: ['read', 'write', 'delete', 'admin', 'bulk_operations', 'user_management'],\n    organizationId: 'org_001',\n    isActive: true,\n    lastLogin: new Date(),\n    apiKey: 'sk_test_admin_12345'\n  }],\n  ['manager@company.com', {\n    id: 'user_002',\n    email: 'manager@company.com',\n    name: 'Inventory Manager',\n    role: 'manager',\n    permissions: ['read', 'write', 'bulk_operations'],\n    organizationId: 'org_001',\n    isActive: true,\n    lastLogin: new Date(),\n    apiKey: 'sk_test_manager_67890'\n  }],\n  ['user@company.com', {\n    id: 'user_003',\n    email: 'user@company.com',\n    name: 'Regular User',\n    role: 'user',\n    permissions: ['read'],\n    organizationId: 'org_001',\n    isActive: true,\n    lastLogin: new Date(),\n    apiKey: 'sk_test_user_11111'\n  }]\n])\n\nexport interface AuthenticatedUser {\n  id: string\n  email: string\n  name: string\n  role: string\n  permissions: string[]\n  organizationId: string\n  isActive: boolean\n  lastLogin: Date\n}\n\nexport interface RequestContext {\n  user?: AuthenticatedUser\n  ipAddress: string\n  userAgent: string\n  isAuthenticated: boolean\n  rateLimit: {\n    endpoint: string\n    limit: number\n    remaining: number\n    resetTime: Date\n  }\n}\n\nexport interface ApiResponse<T = any> {\n  success: boolean\n  data?: T\n  error?: string\n  details?: any\n  message?: string\n  pagination?: {\n    page: number\n    limit: number\n    total: number\n    totalPages: number\n    hasNext: boolean\n    hasPrev: boolean\n  }\n  meta?: {\n    timestamp: string\n    requestId: string\n    version: string\n    processingTime: number\n  }\n}\n\n// Enhanced security configuration\nconst securityConfig: SecurityConfig = {\n  enableRateLimit: true,\n  rateLimitRequests: 100,\n  rateLimitWindow: 60000,\n  enableIPWhitelist: false,\n  whitelistedIPs: [],\n  enableSecurityHeaders: true,\n  enableCSRFProtection: true,\n  sessionTimeout: 3600000, // 1 hour\n}\n\nconst securityMiddleware = new SecurityMiddleware(securityConfig)\n\nexport class ApiMiddleware {\n  private static requestCounter = 0\n\n  /**\n   * Main middleware function that handles authentication, authorization, and security\n   */\n  static withAuth(\n    handler: (request: NextRequest, context: RequestContext) => Promise<NextResponse>,\n    options: {\n      requiredPermissions?: string[]\n      requiredRole?: string\n      allowAnonymous?: boolean\n      rateLimitType?: keyof typeof RATE_LIMITS\n    } = {}\n  ) {\n    return async (request: NextRequest): Promise<NextResponse> => {\n      const startTime = Date.now()\n      const requestId = `req_${Date.now()}_${++this.requestCounter}`\n\n      try {\n        // Extract request information\n        const ipAddress = this.getClientIP(request)\n        const userAgent = request.headers.get('user-agent') || ''\n\n        // Security validation\n        const securityContext: SecurityContext = {\n          ipAddress,\n          userAgent,\n          isAuthenticated: false,\n          permissions: []\n        }\n\n        const securityResult = securityMiddleware.validateRequest(\n          {\n            path: request.nextUrl.pathname,\n            method: request.method,\n            headers: Object.fromEntries(request.headers.entries()),\n            body: request.method !== 'GET' ? await this.safeReadBody(request) : undefined\n          },\n          securityContext\n        )\n\n        if (!securityResult.allowed) {\n          return this.createErrorResponse(\n            securityResult.reason || 'Request blocked for security reasons',\n            429,\n            { riskScore: securityResult.riskScore, requestId }\n          )\n        }\n\n        // Authentication\n        let user: AuthenticatedUser | undefined\n        const authResult = await this.authenticateRequest(request)\n\n        if (!authResult.success && !options.allowAnonymous) {\n          return this.createErrorResponse(\n            authResult.error || 'Authentication required',\n            401,\n            { requestId }\n          )\n        }\n\n        user = authResult.user\n        securityContext.isAuthenticated = !!user\n        securityContext.userId = user?.id\n        securityContext.permissions = user?.permissions || []\n\n        // Authorization\n        if (user && options.requiredPermissions) {\n          const hasPermission = options.requiredPermissions.every(permission =>\n            user!.permissions.includes(permission)\n          )\n\n          if (!hasPermission) {\n            return this.createErrorResponse(\n              'Insufficient permissions',\n              403,\n              {\n                required: options.requiredPermissions,\n                available: user.permissions,\n                requestId\n              }\n            )\n          }\n        }\n\n        if (user && options.requiredRole && user.role !== options.requiredRole) {\n          return this.createErrorResponse(\n            `Role '${options.requiredRole}' required`,\n            403,\n            { currentRole: user.role, requiredRole: options.requiredRole, requestId }\n          )\n        }\n\n        // Rate limiting\n        const rateLimitResult = this.checkRateLimit(\n          ipAddress + (user?.id || ''),\n          options.rateLimitType || 'default'\n        )\n\n        if (!rateLimitResult.allowed) {\n          return this.createErrorResponse(\n            'Rate limit exceeded',\n            429,\n            {\n              rateLimit: rateLimitResult,\n              requestId\n            }\n          )\n        }\n\n        // Create request context\n        const context: RequestContext = {\n          user,\n          ipAddress,\n          userAgent,\n          isAuthenticated: !!user,\n          rateLimit: rateLimitResult\n        }\n\n        // Call the actual handler\n        const response = await handler(request, context)\n\n        // Add security headers\n        const securityHeaders = securityMiddleware.generateSecurityHeaders()\n        Object.entries(securityHeaders).forEach(([key, value]) => {\n          response.headers.set(key, value)\n        })\n\n        // Add rate limit headers\n        response.headers.set('X-RateLimit-Limit', rateLimitResult.limit.toString())\n        response.headers.set('X-RateLimit-Remaining', rateLimitResult.remaining.toString())\n        response.headers.set('X-RateLimit-Reset', rateLimitResult.resetTime.getTime().toString())\n\n        // Add request metadata\n        response.headers.set('X-Request-ID', requestId)\n        response.headers.set('X-Processing-Time', `${Date.now() - startTime}ms`)\n\n        return response\n\n      } catch (error) {\n        console.error('API Middleware Error:', error)\n        return this.createErrorResponse(\n          'Internal server error',\n          500,\n          { requestId, error: error instanceof Error ? error.message : 'Unknown error' }\n        )\n      }\n    }\n  }\n\n  /**\n   * Validation middleware for request data\n   */\n  static withValidation<T>(\n    schema: z.ZodSchema<T>,\n    options: { validateQuery?: boolean; validateBody?: boolean } = { validateBody: true },\n    authOptions: { allowAnonymous?: boolean; requiredPermissions?: string[]; requiredRole?: string; rateLimitType?: keyof typeof RATE_LIMITS } = {}\n  ) {\n    return (\n      handler: (request: NextRequest, context: RequestContext, validatedData: T) => Promise<NextResponse>\n    ) => {\n      return this.withAuth(async (request: NextRequest, context: RequestContext) => {\n        try {\n          let dataToValidate: any = {}\n\n          if (options.validateQuery) {\n            const { searchParams } = new URL(request.url)\n            dataToValidate = Object.fromEntries(searchParams.entries())\n          }\n\n          if (options.validateBody && request.method !== 'GET') {\n            const body = await request.json()\n            dataToValidate = options.validateQuery ? { ...dataToValidate, ...body } : body\n          }\n\n          const validatedData = schema.parse(dataToValidate)\n          return await handler(request, context, validatedData)\n\n        } catch (error) {\n          if (error instanceof z.ZodError) {\n            return this.createErrorResponse(\n              'Validation error',\n              400,\n              {\n                validationErrors: error.issues,\n                message: 'Request data is invalid'\n              }\n            )\n          }\n          throw error\n        }\n      }, authOptions)\n    }\n  }\n\n  /**\n   * File upload middleware\n   */\n  static withFileUpload(\n    options: {\n      maxFileSize?: number // in bytes\n      allowedTypes?: string[]\n      maxFiles?: number\n    } = {}\n  ) {\n    return (\n      handler: (request: NextRequest, context: RequestContext, files: File[]) => Promise<NextResponse>\n    ) => {\n      return this.withAuth(async (request: NextRequest, context: RequestContext) => {\n        try {\n          const formData = await request.formData()\n          const files: File[] = []\n\n          for (const [key, value] of formData.entries()) {\n            if (value instanceof File) {\n              // Validate file size\n              if (options.maxFileSize && value.size > options.maxFileSize) {\n                return this.createErrorResponse(\n                  `File ${value.name} exceeds maximum size of ${options.maxFileSize} bytes`,\n                  400\n                )\n              }\n\n              // Validate file type\n              if (options.allowedTypes && !options.allowedTypes.includes(value.type)) {\n                return this.createErrorResponse(\n                  `File type ${value.type} not allowed`,\n                  400,\n                  { allowedTypes: options.allowedTypes }\n                )\n              }\n\n              files.push(value)\n            }\n          }\n\n          // Validate file count\n          if (options.maxFiles && files.length > options.maxFiles) {\n            return this.createErrorResponse(\n              `Too many files. Maximum ${options.maxFiles} allowed`,\n              400\n            )\n          }\n\n          if (files.length === 0) {\n            return this.createErrorResponse(\n              'No files uploaded',\n              400\n            )\n          }\n\n          return await handler(request, context, files)\n\n        } catch (error) {\n          console.error('File upload error:', error)\n          return this.createErrorResponse(\n            'File upload failed',\n            400,\n            { error: error instanceof Error ? error.message : 'Unknown error' }\n          )\n        }\n      }, { rateLimitType: 'upload', requiredPermissions: ['write'] })\n    }\n  }\n\n  /**\n   * Bulk operations middleware\n   */\n  static withBulkOperation() {\n    return (\n      handler: (request: NextRequest, context: RequestContext) => Promise<NextResponse>\n    ) => {\n      return this.withAuth(handler, {\n        rateLimitType: 'bulk',\n        requiredPermissions: ['bulk_operations']\n      })\n    }\n  }\n\n  /**\n   * Authentication helper\n   */\n  private static async authenticateRequest(request: NextRequest): Promise<{\n    success: boolean\n    user?: AuthenticatedUser\n    error?: string\n  }> {\n    // Try API key authentication first\n    const apiKey = request.headers.get('x-api-key')\n    if (apiKey) {\n      for (const [email, userData] of mockUsers) {\n        if (userData.apiKey === apiKey && userData.isActive) {\n          return { success: true, user: userData }\n        }\n      }\n      return { success: false, error: 'Invalid API key' }\n    }\n\n    // Try Bearer token authentication\n    const authorization = request.headers.get('authorization')\n    if (authorization?.startsWith('Bearer ')) {\n      const token = authorization.substring(7)\n      // In production, validate JWT token here\n      // For now, we'll check against a simple token format\n      const email = this.extractEmailFromToken(token)\n      if (email && mockUsers.has(email)) {\n        const user = mockUsers.get(email)!\n        if (user.isActive) {\n          return { success: true, user }\n        }\n      }\n      return { success: false, error: 'Invalid or expired token' }\n    }\n\n    // Try session-based authentication (would typically check cookies/session)\n    const sessionId = request.headers.get('x-session-id')\n    if (sessionId) {\n      // In production, validate session from database/cache\n      // For now, we'll use a simple mapping\n      if (sessionId === 'session_admin_123') {\n        const user = mockUsers.get('admin@company.com')!\n        return { success: true, user }\n      }\n    }\n\n    return { success: false, error: 'No valid authentication provided' }\n  }\n\n  /**\n   * Extract email from JWT token (simplified for demo)\n   */\n  private static extractEmailFromToken(token: string): string | null {\n    try {\n      // In production, use proper JWT verification\n      const parts = token.split('.')\n      if (parts.length === 3) {\n        const payload = JSON.parse(atob(parts[1]))\n        return payload.email || null\n      }\n    } catch (error) {\n      // Invalid token format\n    }\n    return null\n  }\n\n  /**\n   * Get client IP address\n   */\n  private static getClientIP(request: NextRequest): string {\n    const xForwardedFor = request.headers.get('x-forwarded-for')\n    const xRealIP = request.headers.get('x-real-ip')\n    const cfConnectingIP = request.headers.get('cf-connecting-ip')\n\n    return cfConnectingIP ||\n           xForwardedFor?.split(',')[0]?.trim() ||\n           xRealIP ||\n           request.ip ||\n           '127.0.0.1'\n  }\n\n  /**\n   * Rate limiting check\n   */\n  private static checkRateLimit(\n    identifier: string,\n    type: keyof typeof RATE_LIMITS\n  ): {\n    allowed: boolean\n    limit: number\n    remaining: number\n    resetTime: Date\n  } {\n    const config = RATE_LIMITS[type]\n    const now = Date.now()\n    const windowStart = now - config.window\n    const resetTime = new Date(now + config.window)\n\n    // In production, use Redis or similar for distributed rate limiting\n    // For now, we'll use a simple in-memory implementation\n    const key = `ratelimit:${type}:${identifier}`\n\n    // This is a simplified implementation\n    // In production, implement proper sliding window rate limiting\n    return {\n      allowed: true, // Simplified for demo\n      limit: config.requests,\n      remaining: config.requests - 1,\n      resetTime\n    }\n  }\n\n  /**\n   * Safe body reading that handles already consumed streams\n   */\n  private static async safeReadBody(request: NextRequest): Promise<any> {\n    try {\n      const cloned = request.clone()\n      return await cloned.json()\n    } catch (error) {\n      return null\n    }\n  }\n\n  /**\n   * Create standardized error response\n   */\n  static createErrorResponse(\n    message: string,\n    status: number,\n    details?: any\n  ): NextResponse {\n    const response: ApiResponse = {\n      success: false,\n      error: message,\n      details,\n      meta: {\n        timestamp: new Date().toISOString(),\n        requestId: details?.requestId || `err_${Date.now()}`,\n        version: '1.0.0',\n        processingTime: 0\n      }\n    }\n\n    return NextResponse.json(response, { status })\n  }\n\n  /**\n   * Create standardized success response\n   */\n  static createSuccessResponse<T>(\n    data: T,\n    message?: string,\n    meta?: Partial<ApiResponse['meta']>,\n    pagination?: ApiResponse['pagination']\n  ): NextResponse {\n    const response: ApiResponse<T> = {\n      success: true,\n      data,\n      message,\n      pagination,\n      meta: {\n        timestamp: new Date().toISOString(),\n        requestId: `req_${Date.now()}`,\n        version: '1.0.0',\n        processingTime: 0,\n        ...meta\n      }\n    }\n\n    return NextResponse.json(response)\n  }\n}\n\n// Export types for use in API routes\nexport type { RequestContext, ApiResponse, AuthenticatedUser }\n// ApiMiddleware already exported above\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\api\\supplier-portfolio-client-enhanced.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * NXT-SPP Enhanced API Client\r\n * Centralized API client for Supplier Product Portfolio operations\r\n *\r\n * ARCHITECTURE:\r\n * - SPP: Staging/isolation layer for pricelist uploads\r\n * - CORE: Canonical master data with supplier products\r\n * - SERVE: Read-optimized views for reporting\r\n */\r\n\r\nimport type {\r\n  SupplierProduct,\r\n  ProductTableBySupplier,\r\n  SupplierProductFilters,\r\n  PaginationParams,\r\n  PaginatedResponse,\r\n  InventorySelection,\r\n  InventorySelectedItem,\r\n  SOHBySupplier,\r\n  SOHRolledUp,\r\n  SOHFilters,\r\n  SPPPricelistUpload,\r\n  UploadValidationResult,\r\n  BulkCategoryAssignment,\r\n  BulkSelectionOperation,\r\n  BulkOperationResult,\r\n  DashboardMetrics,\r\n  PriceChangeAlert,\r\n  NewProductAlert,\r\n  UploadActivity,\r\n  APIResponse,\r\n  SelectionWorkflowRequest\r\n} from '@/types/supplier-portfolio'\r\n\r\nconst API_BASE = '/api'\r\n\r\n/**\r\n * Enhanced API error with retry capabilities\r\n */\r\nexport class APIError extends Error {\r\n  constructor(\r\n    message: string,\r\n    public statusCode?: number,\r\n    public details?: any,\r\n    public isRetryable: boolean = false\r\n  ) {\r\n    super(message)\r\n    this.name = 'APIError'\r\n  }\r\n}\r\n\r\nclass SupplierPortfolioAPIClient {\r\n  /**\r\n   * Enhanced fetch with retry logic for transient failures\r\n   */\r\n  private async fetchJSON<T>(\r\n    url: string,\r\n    options?: RequestInit,\r\n    retryCount: number = 3\r\n  ): Promise<APIResponse<T>> {\r\n    let lastError: Error | null = null\r\n\r\n    for (let attempt = 0; attempt < retryCount; attempt++) {\r\n      try {\r\n        const response = await fetch(url, {\r\n          ...options,\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            ...options?.headers,\r\n          },\r\n        })\r\n\r\n        const data = await response.json()\r\n\r\n        if (!response.ok) {\r\n          const error = new APIError(\r\n            data.error || `HTTP ${response.status}: ${response.statusText}`,\r\n            response.status,\r\n            data.details,\r\n            this.isRetryableStatus(response.status)\r\n          )\r\n\r\n          // Retry on transient failures\r\n          if (error.isRetryable && attempt < retryCount - 1) {\r\n            await this.delay(this.getBackoffDelay(attempt))\r\n            continue\r\n          }\r\n\r\n          return {\r\n            success: false,\r\n            error: error.message,\r\n          }\r\n        }\r\n\r\n        return data\r\n      } catch (error) {\r\n        lastError = error as Error\r\n\r\n        // Network errors are retryable\r\n        if (attempt < retryCount - 1) {\r\n          await this.delay(this.getBackoffDelay(attempt))\r\n          continue\r\n        }\r\n      }\r\n    }\r\n\r\n    console.error('API request failed after retries:', lastError)\r\n    return {\r\n      success: false,\r\n      error: lastError instanceof Error ? lastError.message : 'Unknown error occurred',\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if HTTP status code indicates a retryable error\r\n   */\r\n  private isRetryableStatus(status: number): boolean {\r\n    return status === 408 || status === 429 || status >= 500\r\n  }\r\n\r\n  /**\r\n   * Calculate exponential backoff delay\r\n   */\r\n  private getBackoffDelay(attempt: number): number {\r\n    return Math.min(1000 * Math.pow(2, attempt), 10000)\r\n  }\r\n\r\n  /**\r\n   * Delay helper for retry logic\r\n   */\r\n  private delay(ms: number): Promise<void> {\r\n    return new Promise(resolve => setTimeout(resolve, ms))\r\n  }\r\n\r\n  // ============================================\r\n  // Supplier Product Management\r\n  // ============================================\r\n\r\n  /**\r\n   * Get paginated list of supplier products with filters\r\n   * @param filters - Filter criteria for products\r\n   * @param pagination - Pagination parameters\r\n   * @returns Paginated product list\r\n   */\r\n  async getSupplierProducts(\r\n    filters: SupplierProductFilters = {},\r\n    pagination: PaginationParams = { page: 1, page_size: 50 }\r\n  ): Promise<APIResponse<PaginatedResponse<ProductTableBySupplier>>> {\r\n    const params = new URLSearchParams({\r\n      page: pagination.page.toString(),\r\n      page_size: pagination.page_size.toString(),\r\n      ...(pagination.sort_by && { sort_by: pagination.sort_by }),\r\n      ...(pagination.sort_direction && { sort_direction: pagination.sort_direction }),\r\n      ...(filters.supplier_id && { supplier_id: filters.supplier_id }),\r\n      ...(filters.category_id && { category_id: filters.category_id }),\r\n      ...(filters.brand && { brand: filters.brand }),\r\n      ...(filters.is_new !== undefined && { is_new: filters.is_new.toString() }),\r\n      ...(filters.is_mapped !== undefined && { is_mapped: filters.is_mapped.toString() }),\r\n      ...(filters.price_min && { price_min: filters.price_min.toString() }),\r\n      ...(filters.price_max && { price_max: filters.price_max.toString() }),\r\n      ...(filters.has_price_change && { has_price_change: 'true' }),\r\n      ...(filters.price_change_direction && { price_change_direction: filters.price_change_direction }),\r\n      ...(filters.search && { search: filters.search }),\r\n      ...(filters.is_selected !== undefined && { is_selected: filters.is_selected.toString() }),\r\n      ...(filters.selection_id && { selection_id: filters.selection_id }),\r\n    })\r\n\r\n    return this.fetchJSON<PaginatedResponse<ProductTableBySupplier>>(\r\n      `${API_BASE}/core/suppliers/products?${params}`\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Get product table for ISI wizard display\r\n   * @param supplierId - Supplier UUID\r\n   * @param filters - Additional filters\r\n   * @returns Product table for ISI wizard\r\n   */\r\n  async getProductTableForISI(\r\n    supplierId: string,\r\n    filters: Omit<SupplierProductFilters, 'supplier_id'> = {},\r\n    pagination: PaginationParams = { page: 1, page_size: 100 }\r\n  ): Promise<APIResponse<PaginatedResponse<ProductTableBySupplier>>> {\r\n    return this.getSupplierProducts(\r\n      { ...filters, supplier_id: supplierId },\r\n      pagination\r\n    )\r\n  }\r\n\r\n  async getSupplierProduct(supplier_product_id: string): Promise<APIResponse<SupplierProduct>> {\r\n    return this.fetchJSON<SupplierProduct>(\r\n      `${API_BASE}/core/suppliers/products/${supplier_product_id}`\r\n    )\r\n  }\r\n\r\n  async updateSupplierProduct(\r\n    supplier_product_id: string,\r\n    data: Partial<SupplierProduct>\r\n  ): Promise<APIResponse<SupplierProduct>> {\r\n    return this.fetchJSON<SupplierProduct>(\r\n      `${API_BASE}/core/suppliers/products/${supplier_product_id}`,\r\n      {\r\n        method: 'PATCH',\r\n        body: JSON.stringify(data),\r\n      }\r\n    )\r\n  }\r\n\r\n  async assignCategory(assignment: BulkCategoryAssignment): Promise<APIResponse<BulkOperationResult>> {\r\n    return this.fetchJSON<BulkOperationResult>(\r\n      `${API_BASE}/core/suppliers/products/bulk/assign-category`,\r\n      {\r\n        method: 'POST',\r\n        body: JSON.stringify(assignment),\r\n      }\r\n    )\r\n  }\r\n\r\n  async getPriceHistory(supplier_product_id: string): Promise<APIResponse<any[]>> {\r\n    return this.fetchJSON<any[]>(\r\n      `${API_BASE}/core/suppliers/products/${supplier_product_id}/price-history`\r\n    )\r\n  }\r\n\r\n  // ============================================\r\n  // Inventory Selection Interface (ISI)\r\n  // ============================================\r\n\r\n  async getSelections(status?: 'draft' | 'active' | 'archived'): Promise<APIResponse<InventorySelection[]>> {\r\n    const params = new URLSearchParams()\r\n    if (status) params.set('status', status)\r\n\r\n    return this.fetchJSON<InventorySelection[]>(\r\n      `${API_BASE}/core/selections?${params}`\r\n    )\r\n  }\r\n\r\n  async getSelection(selection_id: string): Promise<APIResponse<InventorySelection>> {\r\n    return this.fetchJSON<InventorySelection>(\r\n      `${API_BASE}/core/selections/${selection_id}`\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Create new inventory selection\r\n   * @param name - Selection name\r\n   * @param description - Optional description\r\n   * @param createdBy - User UUID\r\n   * @returns Created selection record\r\n   */\r\n  async createSelection(\r\n    name: string,\r\n    description: string | undefined,\r\n    createdBy: string\r\n  ): Promise<APIResponse<InventorySelection>> {\r\n    return this.fetchJSON<InventorySelection>(\r\n      `${API_BASE}/core/selections`,\r\n      {\r\n        method: 'POST',\r\n        body: JSON.stringify({\r\n          selection_name: name,\r\n          description,\r\n          created_by: createdBy,\r\n          status: 'draft'\r\n        }),\r\n      }\r\n    )\r\n  }\r\n\r\n  async updateSelection(\r\n    selection_id: string,\r\n    data: Partial<InventorySelection>\r\n  ): Promise<APIResponse<InventorySelection>> {\r\n    return this.fetchJSON<InventorySelection>(\r\n      `${API_BASE}/core/selections/${selection_id}`,\r\n      {\r\n        method: 'PATCH',\r\n        body: JSON.stringify(data),\r\n      }\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Get selected items in a selection\r\n   * @param selectionId - Selection UUID\r\n   * @param filters - Optional filters\r\n   * @returns List of selected items with product details\r\n   */\r\n  async getSelectionItems(\r\n    selectionId: string,\r\n    filters?: { supplier_id?: string; category_id?: string }\r\n  ): Promise<APIResponse<InventorySelectedItem[]>> {\r\n    const params = new URLSearchParams()\r\n    if (filters?.supplier_id) params.set('supplier_id', filters.supplier_id)\r\n    if (filters?.category_id) params.set('category_id', filters.category_id)\r\n\r\n    return this.fetchJSON<InventorySelectedItem[]>(\r\n      `${API_BASE}/core/selections/${selectionId}/items?${params}`\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Execute selection workflow (select/deselect products)\r\n   * @param request - Workflow request with action and product IDs\r\n   * @returns Operation result with success/failure counts\r\n   */\r\n  async executeWorkflow(request: SelectionWorkflowRequest): Promise<APIResponse<BulkOperationResult>> {\r\n    return this.fetchJSON<BulkOperationResult>(\r\n      `${API_BASE}/core/selections/workflow`,\r\n      {\r\n        method: 'POST',\r\n        body: JSON.stringify(request),\r\n      }\r\n    )\r\n  }\r\n\r\n  async bulkSelectProducts(operation: BulkSelectionOperation): Promise<APIResponse<BulkOperationResult>> {\r\n    return this.fetchJSON<BulkOperationResult>(\r\n      `${API_BASE}/core/selections/${operation.selection_id}/bulk`,\r\n      {\r\n        method: 'POST',\r\n        body: JSON.stringify(operation),\r\n      }\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Activate selection (make it active for SOH reporting)\r\n   * @param selectionId - Selection UUID\r\n   * @returns Updated selection with active status\r\n   */\r\n  async activateSelection(selectionId: string): Promise<APIResponse<InventorySelection>> {\r\n    return this.fetchJSON<InventorySelection>(\r\n      `${API_BASE}/core/selections/${selectionId}/activate`,\r\n      {\r\n        method: 'POST',\r\n      }\r\n    )\r\n  }\r\n\r\n  async archiveSelection(selection_id: string): Promise<APIResponse<InventorySelection>> {\r\n    return this.fetchJSON<InventorySelection>(\r\n      `${API_BASE}/core/selections/${selection_id}/archive`,\r\n      {\r\n        method: 'POST',\r\n      }\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Get active catalog (selected products only)\r\n   * @param filters - Filter criteria\r\n   * @returns Active catalog items\r\n   */\r\n  async getActiveCatalog(\r\n    filters: SupplierProductFilters = {},\r\n    pagination: PaginationParams = { page: 1, page_size: 50 }\r\n  ): Promise<APIResponse<PaginatedResponse<ProductTableBySupplier>>> {\r\n    return this.getSupplierProducts(\r\n      { ...filters, is_selected: true },\r\n      pagination\r\n    )\r\n  }\r\n\r\n  // ============================================\r\n  // Stock on Hand (SOH) - CRITICAL: Always use selected_only\r\n  // ============================================\r\n\r\n  /**\r\n   * Get SOH by supplier (ALWAYS filters to selected products by default)\r\n   * @param filters - Filter criteria (selected_only defaults to true)\r\n   * @param pagination - Pagination parameters\r\n   * @returns SOH data grouped by supplier\r\n   */\r\n  async getSohBySupplier(\r\n    filters: SOHFilters & { selected_only?: boolean } = { selected_only: true },\r\n    pagination: PaginationParams = { page: 1, page_size: 50 }\r\n  ): Promise<APIResponse<PaginatedResponse<SOHBySupplier>>> {\r\n    // CRITICAL: Default to selected_only: true\r\n    const safeFilters = { ...filters, selected_only: filters.selected_only ?? true }\r\n\r\n    const params = new URLSearchParams({\r\n      page: pagination.page.toString(),\r\n      page_size: pagination.page_size.toString(),\r\n      selected_only: safeFilters.selected_only.toString(),\r\n      ...(safeFilters.supplier_id && { supplier_id: safeFilters.supplier_id }),\r\n      ...(safeFilters.location_id && { location_id: safeFilters.location_id }),\r\n      ...(safeFilters.category_id && { category_id: safeFilters.category_id }),\r\n      ...(safeFilters.min_qty && { min_qty: safeFilters.min_qty.toString() }),\r\n      ...(safeFilters.max_qty && { max_qty: safeFilters.max_qty.toString() }),\r\n      ...(safeFilters.min_value && { min_value: safeFilters.min_value.toString() }),\r\n      ...(safeFilters.search && { search: safeFilters.search }),\r\n    })\r\n\r\n    return this.fetchJSON<PaginatedResponse<SOHBySupplier>>(\r\n      `${API_BASE}/serve/soh?${params}`\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Get rolled-up SOH across suppliers (ALWAYS filters to selected products by default)\r\n   * @param filters - Filter criteria (selected_only defaults to true)\r\n   * @param pagination - Pagination parameters\r\n   * @returns SOH data aggregated across suppliers\r\n   */\r\n  async getSohRolledUp(\r\n    filters: Pick<SOHFilters, 'category_id' | 'min_qty' | 'min_value' | 'search'> & { selected_only?: boolean } = { selected_only: true },\r\n    pagination: PaginationParams = { page: 1, page_size: 50 }\r\n  ): Promise<APIResponse<PaginatedResponse<SOHRolledUp>>> {\r\n    // CRITICAL: Default to selected_only: true\r\n    const safeFilters = { ...filters, selected_only: filters.selected_only ?? true }\r\n\r\n    const params = new URLSearchParams({\r\n      page: pagination.page.toString(),\r\n      page_size: pagination.page_size.toString(),\r\n      selected_only: safeFilters.selected_only.toString(),\r\n      ...(safeFilters.category_id && { category_id: safeFilters.category_id }),\r\n      ...(safeFilters.min_qty && { min_qty: safeFilters.min_qty.toString() }),\r\n      ...(safeFilters.min_value && { min_value: safeFilters.min_value.toString() }),\r\n      ...(safeFilters.search && { search: safeFilters.search }),\r\n    })\r\n\r\n    return this.fetchJSON<PaginatedResponse<SOHRolledUp>>(\r\n      `${API_BASE}/serve/soh/rolled-up?${params}`\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Get total inventory value (ALWAYS filters to selected products by default)\r\n   * @param supplierIds - Optional list of supplier UUIDs\r\n   * @param selectedOnly - Filter to selected products only (default: true)\r\n   * @returns Total inventory value\r\n   */\r\n  async getInventoryValue(\r\n    supplierIds?: string[],\r\n    selectedOnly: boolean = true\r\n  ): Promise<APIResponse<{ total_value: number; currency: string; supplier_breakdown?: Array<{ supplier_id: string; value: number }> }>> {\r\n    const params = new URLSearchParams({\r\n      selected_only: selectedOnly.toString()\r\n    })\r\n\r\n    if (supplierIds && supplierIds.length > 0) {\r\n      params.set('supplier_ids', supplierIds.join(','))\r\n    }\r\n\r\n    return this.fetchJSON(\r\n      `${API_BASE}/serve/soh/value?${params}`\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Export SOH report to Excel/CSV\r\n   * @param request - Report request parameters\r\n   * @param format - Export format (xlsx or csv)\r\n   * @returns File blob\r\n   */\r\n  async exportSohReport(\r\n    request: {\r\n      supplier_ids?: string[]\r\n      location_ids?: string[]\r\n      selected_only?: boolean\r\n      group_by?: 'supplier' | 'product' | 'location'\r\n    },\r\n    format: 'xlsx' | 'csv' = 'xlsx'\r\n  ): Promise<Blob> {\r\n    const params = new URLSearchParams({\r\n      format,\r\n      selected_only: (request.selected_only ?? true).toString(),\r\n      ...(request.supplier_ids && { supplier_ids: request.supplier_ids.join(',') }),\r\n      ...(request.location_ids && { location_ids: request.location_ids.join(',') }),\r\n      ...(request.group_by && { group_by: request.group_by }),\r\n    })\r\n\r\n    const response = await fetch(`${API_BASE}/serve/soh/export?${params}`)\r\n    return response.blob()\r\n  }\r\n\r\n  // ============================================\r\n  // Pricelist Upload (SPP)\r\n  // ============================================\r\n\r\n  /**\r\n   * Upload pricelist file with auto-validate and auto-merge options\r\n   * @param file - Excel/CSV file containing pricelist data\r\n   * @param supplierId - Supplier UUID\r\n   * @param options - Upload configuration options\r\n   * @returns Upload record with validation result if auto_validate is true\r\n   */\r\n  async uploadPricelist(\r\n    file: File,\r\n    supplierId: string,\r\n    options: {\r\n      valid_from?: Date\r\n      valid_to?: Date | null\r\n      currency?: string\r\n      auto_validate?: boolean\r\n      auto_merge?: boolean\r\n    } = {}\r\n  ): Promise<APIResponse<SPPPricelistUpload>> {\r\n    const formData = new FormData()\r\n    formData.append('file', file)\r\n    formData.append('supplier_id', supplierId)\r\n    if (options.valid_from) formData.append('valid_from', options.valid_from.toISOString())\r\n    if (options.valid_to) formData.append('valid_to', options.valid_to.toISOString())\r\n    if (options.currency) formData.append('currency', options.currency)\r\n    if (options.auto_validate) formData.append('auto_validate', 'true')\r\n    if (options.auto_merge) formData.append('auto_merge', 'true')\r\n\r\n    try {\r\n      const response = await fetch(`${API_BASE}/spp/upload`, {\r\n        method: 'POST',\r\n        body: formData,\r\n      })\r\n\r\n      return await response.json()\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Upload failed',\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate uploaded pricelist\r\n   * @param uploadId - Upload UUID\r\n   * @returns Validation result with errors, warnings, and summary\r\n   */\r\n  async validateUpload(uploadId: string): Promise<APIResponse<UploadValidationResult>> {\r\n    return this.fetchJSON<UploadValidationResult>(\r\n      `${API_BASE}/spp/validate?upload_id=${uploadId}`,\r\n      {\r\n        method: 'POST',\r\n      }\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Merge validated pricelist to CORE schema\r\n   * @param uploadId - Upload UUID\r\n   * @returns Merge result with counts of created/updated products\r\n   */\r\n  async mergePricelist(uploadId: string): Promise<APIResponse<{ merged: boolean; message: string }>> {\r\n    return this.fetchJSON<{ merged: boolean; message: string }>(\r\n      `${API_BASE}/spp/merge?upload_id=${uploadId}`,\r\n      {\r\n        method: 'POST',\r\n      }\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Poll upload status until complete\r\n   * @param uploadId - Upload UUID\r\n   * @param maxAttempts - Maximum polling attempts (default: 30)\r\n   * @param intervalMs - Polling interval in milliseconds (default: 2000)\r\n   * @returns Final upload status\r\n   */\r\n  async getUploadStatus(\r\n    uploadId: string,\r\n    maxAttempts: number = 30,\r\n    intervalMs: number = 2000\r\n  ): Promise<APIResponse<SPPPricelistUpload>> {\r\n    let attempts = 0\r\n\r\n    while (attempts < maxAttempts) {\r\n      const response = await this.fetchJSON<SPPPricelistUpload>(\r\n        `${API_BASE}/spp/upload?upload_id=${uploadId}`\r\n      )\r\n\r\n      if (!response.success) {\r\n        return response\r\n      }\r\n\r\n      const status = response.data?.status\r\n      if (status === 'merged' || status === 'served' || status === 'error') {\r\n        return response\r\n      }\r\n\r\n      attempts++\r\n      await this.delay(intervalMs)\r\n    }\r\n\r\n    return {\r\n      success: false,\r\n      error: 'Upload status polling timeout'\r\n    }\r\n  }\r\n\r\n  /**\r\n   * List recent uploads for a supplier\r\n   * @param supplierId - Supplier UUID (optional - returns all if not provided)\r\n   * @param limit - Maximum number of uploads to return\r\n   * @returns List of uploads ordered by received_at DESC\r\n   */\r\n  async listUploads(\r\n    supplierId?: string,\r\n    limit: number = 50\r\n  ): Promise<APIResponse<SPPPricelistUpload[]>> {\r\n    const params = new URLSearchParams({ limit: limit.toString() })\r\n    if (supplierId) params.set('supplier_id', supplierId)\r\n\r\n    return this.fetchJSON<SPPPricelistUpload[]>(\r\n      `${API_BASE}/spp/upload?${params}`\r\n    )\r\n  }\r\n\r\n  async getPricelistUpload(upload_id: string): Promise<APIResponse<SPPPricelistUpload>> {\r\n    return this.fetchJSON<SPPPricelistUpload>(\r\n      `${API_BASE}/spp/upload?upload_id=${upload_id}`\r\n    )\r\n  }\r\n\r\n  async deletePricelistUpload(upload_id: string): Promise<APIResponse<{ deleted: boolean }>> {\r\n    return this.fetchJSON<{ deleted: boolean }>(\r\n      `${API_BASE}/spp/upload?upload_id=${upload_id}`,\r\n      {\r\n        method: 'DELETE',\r\n      }\r\n    )\r\n  }\r\n\r\n  // ============================================\r\n  // Dashboard and Monitoring\r\n  // ============================================\r\n\r\n  /**\r\n   * Get dashboard aggregate metrics\r\n   * @returns Dashboard metrics summary\r\n   */\r\n  async getDashboardMetrics(): Promise<APIResponse<DashboardMetrics>> {\r\n    return this.fetchJSON<DashboardMetrics>(\r\n      `${API_BASE}/dashboard/supplier-portfolio/metrics`\r\n    )\r\n  }\r\n\r\n  async getPriceChangeAlerts(\r\n    days: number = 7,\r\n    severity?: 'major' | 'moderate' | 'minor'\r\n  ): Promise<APIResponse<PriceChangeAlert[]>> {\r\n    const params = new URLSearchParams({ days: days.toString() })\r\n    if (severity) params.set('severity', severity)\r\n\r\n    return this.fetchJSON<PriceChangeAlert[]>(\r\n      `${API_BASE}/dashboard/supplier-portfolio/price-changes?${params}`\r\n    )\r\n  }\r\n\r\n  async getNewProductAlerts(days: number = 7): Promise<APIResponse<NewProductAlert[]>> {\r\n    const params = new URLSearchParams({ days: days.toString() })\r\n\r\n    return this.fetchJSON<NewProductAlert[]>(\r\n      `${API_BASE}/dashboard/supplier-portfolio/new-products?${params}`\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Get recent upload activity feed\r\n   * @param limit - Maximum number of activities to return\r\n   * @returns Recent upload activities\r\n   */\r\n  async getRecentActivity(limit: number = 10): Promise<APIResponse<UploadActivity[]>> {\r\n    const params = new URLSearchParams({ limit: limit.toString() })\r\n\r\n    return this.fetchJSON<UploadActivity[]>(\r\n      `${API_BASE}/dashboard/supplier-portfolio/uploads?${params}`\r\n    )\r\n  }\r\n\r\n  // ============================================\r\n  // Categories and Mapping\r\n  // ============================================\r\n\r\n  async getCategories(): Promise<APIResponse<Array<{ category_id: string; name: string; parent_id: string | null }>>> {\r\n    return this.fetchJSON(`${API_BASE}/categories`)\r\n  }\r\n\r\n  async mapSupplierCategory(\r\n    supplier_id: string,\r\n    supplier_category_raw: string,\r\n    category_id: string\r\n  ): Promise<APIResponse<any>> {\r\n    return this.fetchJSON(`${API_BASE}/categories/map`, {\r\n      method: 'POST',\r\n      body: JSON.stringify({\r\n        supplier_id,\r\n        supplier_category_raw,\r\n        category_id,\r\n      }),\r\n    })\r\n  }\r\n\r\n  async getUnmappedCategories(supplier_id?: string): Promise<APIResponse<Array<{\r\n    supplier_id: string\r\n    category_raw: string\r\n    product_count: number\r\n  }>>> {\r\n    const params = new URLSearchParams()\r\n    if (supplier_id) params.set('supplier_id', supplier_id)\r\n\r\n    return this.fetchJSON(`${API_BASE}/categories/unmapped?${params}`)\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const supplierPortfolioAPI = new SupplierPortfolioAPIClient()\r\nexport { SupplierPortfolioAPIClient, APIError }\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\api\\suppliers.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\nimport { query, withTransaction } from '@/lib/database/unified-connection';\r\nimport type { Supplier, SupplierSearchFilters, DashboardMetrics } from '@/types/supplier';\r\nimport { sanitizeUrl } from '@/lib/utils/url-validation';\r\nimport {\r\n  listSuppliers as ssotList,\r\n  getSupplierById as ssotGet,\r\n  upsertSupplier as ssotUpsert,\r\n  deactivateSupplier as ssotDeactivate,\r\n} from '@/services/ssot/supplierService';\r\n\r\nexport interface CreateSupplierData {\r\n  name: string;\r\n  code: string;\r\n  legalName: string;\r\n  website?: string;\r\n  industry: string;\r\n  tier: 'strategic' | 'preferred' | 'approved' | 'conditional';\r\n  status: 'active' | 'inactive' | 'pending' | 'suspended';\r\n  categories: string[]; // Changed from category to categories (array)\r\n  tags: string[];\r\n\r\n  // Contact information\r\n  primaryContact: {\r\n    name: string;\r\n    title: string;\r\n    email: string;\r\n    phone: string;\r\n    department?: string;\r\n  };\r\n\r\n  // Business information\r\n  taxId: string;\r\n  registrationNumber: string;\r\n  foundedYear?: number;\r\n  employeeCount?: number;\r\n  annualRevenue?: number;\r\n  currency: string;\r\n\r\n  // Address information\r\n  address: {\r\n    street: string;\r\n    city: string;\r\n    state: string;\r\n    postalCode: string;\r\n    country: string;\r\n  };\r\n\r\n  // Capabilities\r\n  products: string[];\r\n  services: string[];\r\n  certifications: string[];\r\n  leadTime: number;\r\n  minimumOrderValue?: number;\r\n  paymentTerms: string;\r\n}\r\n\r\nexport class SupplierAPI {\r\n  // Get all suppliers with optional filtering\r\n  static async getSuppliers(filters?: SupplierSearchFilters): Promise<Supplier[]> {\r\n    const res = await ssotList({\r\n      search: filters?.query,\r\n      status: filters?.status as any,\r\n      page: 1,\r\n      limit: 1000,\r\n      sortBy: 'name',\r\n      sortOrder: 'asc',\r\n    });\r\n    return res.data.map(row =>\r\n      this.mapRowToSupplier({\r\n        id: row.id,\r\n        name: row.name,\r\n        supplier_code: row.code,\r\n        company_name: row.name,\r\n        status: row.status,\r\n        performance_tier: 'approved',\r\n        primary_category: '',\r\n        created_at: row.createdAt,\r\n        updated_at: row.updatedAt,\r\n      } as any)\r\n    );\r\n  }\r\n\r\n  // Get supplier by ID\r\n  static async getSupplierById(id: string): Promise<Supplier | null> {\r\n    const s = await ssotGet(id);\r\n    if (!s) return null;\r\n    return this.mapRowToSupplier({\r\n      id: s.id,\r\n      name: s.name,\r\n      supplier_code: s.code,\r\n      company_name: s.name,\r\n      status: s.status,\r\n      performance_tier: 'approved',\r\n      primary_category: '',\r\n      created_at: s.createdAt,\r\n      updated_at: s.updatedAt,\r\n    } as any);\r\n  }\r\n\r\n  // Create new supplier\r\n  static async createSupplier(data: CreateSupplierData): Promise<Supplier> {\r\n    // Use withTransaction for atomic supplier creation\r\n    const created = await ssotUpsert({\r\n      name: data.name,\r\n      code: data.code,\r\n      status: data.status,\r\n      contact: {\r\n        email: data.primaryContact.email,\r\n        phone: data.primaryContact.phone,\r\n        website: data.website,\r\n      },\r\n    });\r\n    const s = await this.getSupplierById(created.id);\r\n    if (!s) throw new Error('Failed to retrieve created supplier');\r\n    return s;\r\n  }\r\n\r\n  // Update supplier\r\n  static async updateSupplier(id: string, data: Partial<CreateSupplierData>): Promise<Supplier> {\r\n    // Use withTransaction for atomic supplier update\r\n    await ssotUpsert({ id, name: data.name, code: data.code, status: data.status });\r\n    const s = await this.getSupplierById(id);\r\n    if (!s) throw new Error('Failed to retrieve updated supplier');\r\n    return s;\r\n  }\r\n\r\n  // Delete supplier\r\n  static async deleteSupplier(id: string): Promise<void> {\r\n    await ssotDeactivate(id);\r\n  }\r\n\r\n  // OPTIMIZED: Get dashboard metrics - Combined from 4 queries to 1 CTE (60-70% faster)\r\n  static async getDashboardMetrics(): Promise<DashboardMetrics> {\r\n    try {\r\n      const result = await query(`\r\n        WITH metrics AS (\r\n          SELECT\r\n            COUNT(*) as total_suppliers,\r\n            COUNT(*) FILTER (WHERE status = 'active') as active_suppliers,\r\n            COUNT(*) FILTER (WHERE status = 'pending') as pending_approvals\r\n          FROM public.suppliers\r\n        ),\r\n        performance_metrics AS (\r\n          SELECT\r\n            AVG(overall_rating) as avg_performance_rating,\r\n            AVG(on_time_delivery_rate) as on_time_delivery_rate,\r\n            AVG(quality_acceptance_rate) as quality_acceptance_rate,\r\n            COALESCE(SUM(total_purchase_value), 0) as total_purchase_value\r\n          FROM supplier_performance\r\n        ),\r\n        contract_metrics AS (\r\n          SELECT COUNT(*) as contracts_expiring_soon\r\n          FROM supplier_contracts\r\n          WHERE status = 'active'\r\n          AND end_date BETWEEN NOW() AND NOW() + INTERVAL '30 days'\r\n        )\r\n        SELECT\r\n          m.total_suppliers,\r\n          m.active_suppliers,\r\n          m.pending_approvals,\r\n          pm.avg_performance_rating,\r\n          pm.on_time_delivery_rate,\r\n          pm.quality_acceptance_rate,\r\n          pm.total_purchase_value,\r\n          cm.contracts_expiring_soon\r\n        FROM metrics m\r\n        CROSS JOIN performance_metrics pm\r\n        CROSS JOIN contract_metrics cm\r\n      `);\r\n\r\n      const row = result.rows[0];\r\n\r\n      return {\r\n        totalSuppliers: parseInt(row.total_suppliers) || 0,\r\n        activeSuppliers: parseInt(row.active_suppliers) || 0,\r\n        pendingApprovals: parseInt(row.pending_approvals) || 0,\r\n        contractsExpiringSoon: parseInt(row.contracts_expiring_soon) || 0,\r\n        avgPerformanceRating: parseFloat(row.avg_performance_rating) || 0,\r\n        totalPurchaseValue: parseFloat(row.total_purchase_value) || 0,\r\n        onTimeDeliveryRate: parseFloat(row.on_time_delivery_rate) || 0,\r\n        qualityAcceptanceRate: parseFloat(row.quality_acceptance_rate) || 0,\r\n      };\r\n    } catch (error) {\r\n      console.error('Error fetching dashboard metrics:', error);\r\n      throw new Error('Failed to fetch dashboard metrics');\r\n    }\r\n  }\r\n\r\n  // Private helper method to map database row to Supplier interface\r\n  private static mapRowToSupplier(row: any): Supplier {\r\n    return {\r\n      id: row.id,\r\n      name: row.name,\r\n      code: row.supplier_code,\r\n      status: row.status,\r\n      tier: row.performance_tier,\r\n      categories: row.primary_category ? [row.primary_category] : [], // Convert single category to array\r\n      tags: [],\r\n\r\n      contacts: [\r\n        {\r\n          id: 'primary',\r\n          type: 'primary',\r\n          name: row.contact_person || '',\r\n          title: '',\r\n          email: row.contact_email || row.email || '',\r\n          phone: row.phone || '',\r\n          department: '',\r\n          isPrimary: true,\r\n          isActive: true,\r\n        },\r\n      ],\r\n\r\n      addresses: [\r\n        {\r\n          id: 'primary',\r\n          type: 'headquarters',\r\n          name: 'Headquarters',\r\n          addressLine1: row.address || '',\r\n          addressLine2: '',\r\n          city: '',\r\n          state: row.geographic_region || '',\r\n          postalCode: '',\r\n          country: 'South Africa',\r\n          isPrimary: true,\r\n          isActive: true,\r\n        },\r\n      ],\r\n\r\n      businessInfo: {\r\n        legalName: row.company_name || row.name,\r\n        tradingName: row.name,\r\n        taxId: row.tax_id,\r\n        registrationNumber: '',\r\n        website: row.website,\r\n        foundedYear: null,\r\n        employeeCount: null,\r\n        annualRevenue: parseFloat(row.spend_last_12_months || '0'),\r\n        currency: row.currency || 'ZAR',\r\n      },\r\n\r\n      capabilities: {\r\n        products: [],\r\n        services: [],\r\n        certifications: [],\r\n        capacityPerMonth: null,\r\n        leadTime: row.payment_terms_days || 30,\r\n        minimumOrderValue: null,\r\n        paymentTerms: row.payment_terms || 'Net 30',\r\n      },\r\n\r\n      performance: {\r\n        overallRating: parseFloat(row.rating || '0'),\r\n        qualityRating: parseFloat(row.overall_rating || '0'),\r\n        deliveryRating: 0,\r\n        serviceRating: 0,\r\n        priceRating: 0,\r\n        metrics: {\r\n          onTimeDeliveryRate: parseFloat(row.ai_reliability_index || '0') * 100,\r\n          qualityAcceptanceRate: parseFloat(row.ai_performance_score || '0'),\r\n          responseTime: 0,\r\n          defectRate: 0,\r\n          leadTimeVariance: 0,\r\n        },\r\n        kpis: [],\r\n        lastEvaluationDate: row.evaluation_date ? new Date(row.evaluation_date) : new Date(),\r\n        nextEvaluationDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000), // 90 days from now\r\n      },\r\n\r\n      financial: {\r\n        creditRating: row.credit_rating,\r\n        paymentTerms: row.payment_terms || 'Net 30',\r\n        currency: row.currency || 'ZAR',\r\n        bankDetails: undefined,\r\n      },\r\n\r\n      createdAt: new Date(row.created_at),\r\n      updatedAt: new Date(row.updated_at),\r\n      createdBy: row.created_by || 'system',\r\n      lastContactDate: row.last_contact_date ? new Date(row.last_contact_date) : undefined,\r\n      nextReviewDate: row.next_review_date ? new Date(row.next_review_date) : undefined,\r\n      notes: row.notes || '',\r\n    };\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\audit\\audit-logger.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * Audit logging system for tracking user actions and system events\r\n */\r\n\r\nexport interface AuditLogEntry {\r\n  id: string;\r\n  timestamp: Date;\r\n  userId?: string;\r\n  userEmail?: string;\r\n  action: string;\r\n  resource: string;\r\n  resourceId?: string;\r\n  details: Record<string, any>;\r\n  ipAddress?: string;\r\n  userAgent?: string;\r\n  status: 'success' | 'failure' | 'error';\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n  organizationId?: string;\r\n  sessionId?: string;\r\n}\r\n\r\nexport interface AuditLogQuery {\r\n  userId?: string;\r\n  action?: string;\r\n  resource?: string;\r\n  status?: string;\r\n  severity?: string;\r\n  startDate?: Date;\r\n  endDate?: Date;\r\n  limit?: number;\r\n  offset?: number;\r\n}\r\n\r\nclass AuditLogger {\r\n  private logs: AuditLogEntry[] = [];\r\n  private maxLogs = 10000; // Maximum number of logs to keep in memory\r\n\r\n  /**\r\n   * Log an audit event\r\n   */\r\n  async log(entry: Omit<AuditLogEntry, 'id' | 'timestamp'>): Promise<void> {\r\n    const auditEntry: AuditLogEntry = {\r\n      id: this.generateId(),\r\n      timestamp: new Date(),\r\n      ...entry,\r\n    };\r\n\r\n    // Add to in-memory logs\r\n    this.logs.unshift(auditEntry);\r\n\r\n    // Keep only the most recent logs\r\n    if (this.logs.length > this.maxLogs) {\r\n      this.logs = this.logs.slice(0, this.maxLogs);\r\n    }\r\n\r\n    // In production, this would also save to database\r\n    console.log('Audit Log:', auditEntry);\r\n\r\n    // Send to external logging service if configured\r\n    if (process.env.AUDIT_LOG_ENDPOINT) {\r\n      try {\r\n        await this.sendToExternalService(auditEntry);\r\n      } catch (error) {\r\n        console.error('Failed to send audit log to external service:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log user authentication events\r\n   */\r\n  async logAuth(\r\n    action: 'login' | 'logout' | 'login_failed' | 'password_change',\r\n    details: {\r\n      userId?: string;\r\n      userEmail?: string;\r\n      ipAddress?: string;\r\n      userAgent?: string;\r\n      success: boolean;\r\n      reason?: string;\r\n    }\r\n  ): Promise<void> {\r\n    await this.log({\r\n      action: `auth.${action}`,\r\n      resource: 'authentication',\r\n      userId: details.userId,\r\n      userEmail: details.userEmail,\r\n      details: {\r\n        success: details.success,\r\n        reason: details.reason,\r\n      },\r\n      ipAddress: details.ipAddress,\r\n      userAgent: details.userAgent,\r\n      status: details.success ? 'success' : 'failure',\r\n      severity: action === 'login_failed' ? 'medium' : 'low',\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Log data access events\r\n   */\r\n  async logDataAccess(\r\n    action: 'read' | 'create' | 'update' | 'delete',\r\n    details: {\r\n      userId?: string;\r\n      userEmail?: string;\r\n      resource: string;\r\n      resourceId?: string;\r\n      ipAddress?: string;\r\n      userAgent?: string;\r\n      success: boolean;\r\n      changes?: Record<string, any>;\r\n    }\r\n  ): Promise<void> {\r\n    await this.log({\r\n      action: `data.${action}`,\r\n      resource: details.resource,\r\n      resourceId: details.resourceId,\r\n      userId: details.userId,\r\n      userEmail: details.userEmail,\r\n      details: {\r\n        success: details.success,\r\n        changes: details.changes,\r\n      },\r\n      ipAddress: details.ipAddress,\r\n      userAgent: details.userAgent,\r\n      status: details.success ? 'success' : 'failure',\r\n      severity: action === 'delete' ? 'high' : 'medium',\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Log system events\r\n   */\r\n  async logSystemEvent(\r\n    event: string,\r\n    details: {\r\n      severity: 'low' | 'medium' | 'high' | 'critical';\r\n      message: string;\r\n      data?: Record<string, any>;\r\n    }\r\n  ): Promise<void> {\r\n    await this.log({\r\n      action: `system.${event}`,\r\n      resource: 'system',\r\n      details: {\r\n        message: details.message,\r\n        ...details.data,\r\n      },\r\n      status: 'success',\r\n      severity: details.severity,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Log security events\r\n   */\r\n  async logSecurityEvent(\r\n    event: string,\r\n    details: {\r\n      userId?: string;\r\n      userEmail?: string;\r\n      ipAddress?: string;\r\n      userAgent?: string;\r\n      severity: 'medium' | 'high' | 'critical';\r\n      message: string;\r\n      data?: Record<string, any>;\r\n    }\r\n  ): Promise<void> {\r\n    await this.log({\r\n      action: `security.${event}`,\r\n      resource: 'security',\r\n      userId: details.userId,\r\n      userEmail: details.userEmail,\r\n      details: {\r\n        message: details.message,\r\n        ...details.data,\r\n      },\r\n      ipAddress: details.ipAddress,\r\n      userAgent: details.userAgent,\r\n      status: 'success',\r\n      severity: details.severity,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Query audit logs\r\n   */\r\n  async queryLogs(query: AuditLogQuery): Promise<AuditLogEntry[]> {\r\n    let filteredLogs = this.logs;\r\n\r\n    if (query.userId) {\r\n      filteredLogs = filteredLogs.filter(log => log.userId === query.userId);\r\n    }\r\n\r\n    if (query.action) {\r\n      filteredLogs = filteredLogs.filter(log => log.action.includes(query.action));\r\n    }\r\n\r\n    if (query.resource) {\r\n      filteredLogs = filteredLogs.filter(log => log.resource === query.resource);\r\n    }\r\n\r\n    if (query.status) {\r\n      filteredLogs = filteredLogs.filter(log => log.status === query.status);\r\n    }\r\n\r\n    if (query.severity) {\r\n      filteredLogs = filteredLogs.filter(log => log.severity === query.severity);\r\n    }\r\n\r\n    if (query.startDate) {\r\n      filteredLogs = filteredLogs.filter(log => log.timestamp >= query.startDate!);\r\n    }\r\n\r\n    if (query.endDate) {\r\n      filteredLogs = filteredLogs.filter(log => log.timestamp <= query.endDate!);\r\n    }\r\n\r\n    // Sort by timestamp (newest first)\r\n    filteredLogs.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\r\n\r\n    // Apply pagination\r\n    const offset = query.offset || 0;\r\n    const limit = query.limit || 100;\r\n\r\n    return filteredLogs.slice(offset, offset + limit);\r\n  }\r\n\r\n  /**\r\n   * Get audit statistics\r\n   */\r\n  async getStatistics(): Promise<{\r\n    totalLogs: number;\r\n    logsByStatus: Record<string, number>;\r\n    logsBySeverity: Record<string, number>;\r\n    logsByAction: Record<string, number>;\r\n    recentActivity: number;\r\n  }> {\r\n    const now = new Date();\r\n    const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);\r\n\r\n    const logsByStatus = this.logs.reduce(\r\n      (acc, log) => {\r\n        acc[log.status] = (acc[log.status] || 0) + 1;\r\n        return acc;\r\n      },\r\n      {} as Record<string, number>\r\n    );\r\n\r\n    const logsBySeverity = this.logs.reduce(\r\n      (acc, log) => {\r\n        acc[log.severity] = (acc[log.severity] || 0) + 1;\r\n        return acc;\r\n      },\r\n      {} as Record<string, number>\r\n    );\r\n\r\n    const logsByAction = this.logs.reduce(\r\n      (acc, log) => {\r\n        const actionType = log.action.split('.')[0];\r\n        acc[actionType] = (acc[actionType] || 0) + 1;\r\n        return acc;\r\n      },\r\n      {} as Record<string, number>\r\n    );\r\n\r\n    const recentActivity = this.logs.filter(log => log.timestamp >= oneHourAgo).length;\r\n\r\n    return {\r\n      totalLogs: this.logs.length,\r\n      logsByStatus,\r\n      logsBySeverity,\r\n      logsByAction,\r\n      recentActivity,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Clear old logs\r\n   */\r\n  async clearOldLogs(olderThanDays: number = 30): Promise<void> {\r\n    const cutoffDate = new Date();\r\n    cutoffDate.setDate(cutoffDate.getDate() - olderThanDays);\r\n\r\n    this.logs = this.logs.filter(log => log.timestamp >= cutoffDate);\r\n  }\r\n\r\n  /**\r\n   * Generate unique ID\r\n   */\r\n  private generateId(): string {\r\n    return `audit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  /**\r\n   * Send audit log to external service\r\n   */\r\n  private async sendToExternalService(log: AuditLogEntry): Promise<void> {\r\n    if (!process.env.AUDIT_LOG_ENDPOINT) return;\r\n\r\n    const response = await fetch(process.env.AUDIT_LOG_ENDPOINT, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        Authorization: `Bearer ${process.env.AUDIT_LOG_TOKEN}`,\r\n      },\r\n      body: JSON.stringify(log),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to send audit log: ${response.statusText}`);\r\n    }\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const auditLogger = new AuditLogger();\r\n\r\n// Export convenience functions\r\nexport const logAuth = auditLogger.logAuth.bind(auditLogger);\r\nexport const logDataAccess = auditLogger.logDataAccess.bind(auditLogger);\r\nexport const logSystemEvent = auditLogger.logSystemEvent.bind(auditLogger);\r\nexport const logSecurityEvent = auditLogger.logSecurityEvent.bind(auditLogger);\r\nexport const queryAuditLogs = auditLogger.queryLogs.bind(auditLogger);\r\nexport const getAuditStatistics = auditLogger.getStatistics.bind(auditLogger);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\auth.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":6,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":6,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Enterprise Authentication & Authorization Middleware\r\n * JWT-based auth with role-based access control\r\n */\r\n\r\n// @ts-nocheck\r\nimport { NextRequest, NextResponse } from 'next/server'\r\nimport jwt from 'jsonwebtoken'\r\nimport bcrypt from 'bcryptjs'\r\nimport { db } from '@/lib/database'\r\n\r\nexport interface AuthUser {\r\n  id: string\r\n  email: string\r\n  firstName: string\r\n  lastName: string\r\n  organizationId: string\r\n  roles: string[]\r\n  permissions: string[]\r\n}\r\n\r\nexport interface AuthContext {\r\n  user: AuthUser\r\n  token: string\r\n}\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'enterprise_jwt_secret_key_2024_production'\r\nconst SESSION_TIMEOUT = parseInt(process.env.SESSION_TIMEOUT || '3600000') // 1 hour\r\n\r\n/**\r\n * Generate JWT token for authenticated user\r\n */\r\nexport async function generateToken(user: AuthUser): Promise<string> {\r\n  const payload = {\r\n    userId: user.id,\r\n    email: user.email,\r\n    organizationId: user.organizationId,\r\n    roles: user.roles,\r\n    permissions: user.permissions,\r\n    iat: Math.floor(Date.now() / 1000),\r\n    exp: Math.floor(Date.now() / 1000) + (SESSION_TIMEOUT / 1000)\r\n  }\r\n\r\n  return jwt.sign(payload, JWT_SECRET)\r\n}\r\n\r\n/**\r\n * Verify and decode JWT token\r\n */\r\nexport async function verifyToken(token: string): Promise<AuthUser | null> {\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET) as any\r\n\r\n    // Check if token is expired\r\n    if (decoded.exp && decoded.exp < Math.floor(Date.now() / 1000)) {\r\n      return null\r\n    }\r\n\r\n    // Fetch fresh user data to ensure current permissions\r\n    const userResult = await db.query(`\r\n      SELECT\r\n        u.id, u.email, u.first_name, u.last_name, u.organization_id,\r\n        COALESCE(array_agg(DISTINCT r.name) FILTER (WHERE r.name IS NOT NULL), '{}') as roles,\r\n        COALESCE(array_agg(DISTINCT p.name) FILTER (WHERE p.name IS NOT NULL), '{}') as permissions\r\n      FROM users u\r\n      LEFT JOIN user_roles ur ON u.id = ur.user_id\r\n      LEFT JOIN roles r ON ur.role_id = r.id\r\n      LEFT JOIN permissions p ON p.name = ANY(r.permissions::text[])\r\n      WHERE u.id = $1 AND u.is_active = true\r\n      GROUP BY u.id, u.email, u.first_name, u.last_name, u.organization_id\r\n    `, [decoded.userId])\r\n\r\n    if (userResult.rows.length === 0) {\r\n      return null\r\n    }\r\n\r\n    const user = userResult.rows[0]\r\n    return {\r\n      id: user.id,\r\n      email: user.email,\r\n      firstName: user.first_name,\r\n      lastName: user.last_name,\r\n      organizationId: user.organization_id,\r\n      roles: user.roles || [],\r\n      permissions: user.permissions || []\r\n    }\r\n  } catch (error) {\r\n    console.error('Token verification error:', error)\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Extract auth context from request\r\n */\r\nexport async function getAuthContext(request: NextRequest): Promise<AuthContext | null> {\r\n  const authHeader = request.headers.get('authorization')\r\n\r\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n    return null\r\n  }\r\n\r\n  const token = authHeader.substring(7)\r\n  const user = await verifyToken(token)\r\n\r\n  if (!user) {\r\n    return null\r\n  }\r\n\r\n  return { user, token }\r\n}\r\n\r\n/**\r\n * Authentication middleware decorator\r\n */\r\nexport function withAuth(\r\n  handler: (request: NextRequest, context: AuthContext) => Promise<NextResponse>,\r\n  requiredPermissions?: string[]\r\n) {\r\n  return async (request: NextRequest): Promise<NextResponse> => {\r\n    try {\r\n      const authContext = await getAuthContext(request)\r\n\r\n      if (!authContext) {\r\n        return NextResponse.json(\r\n          { success: false, error: 'Authentication required' },\r\n          { status: 401 }\r\n        )\r\n      }\r\n\r\n      // Check permissions if required\r\n      if (requiredPermissions && requiredPermissions.length > 0) {\r\n        const hasPermission = requiredPermissions.some(permission =>\r\n          authContext.user.permissions.includes(permission) ||\r\n          authContext.user.roles.includes('admin') ||\r\n          authContext.user.roles.includes('super_admin')\r\n        )\r\n\r\n        if (!hasPermission) {\r\n          return NextResponse.json(\r\n            { success: false, error: 'Insufficient permissions' },\r\n            { status: 403 }\r\n          )\r\n        }\r\n      }\r\n\r\n      return handler(request, authContext)\r\n    } catch (error) {\r\n      console.error('Auth middleware error:', error)\r\n      return NextResponse.json(\r\n        { success: false, error: 'Authentication error' },\r\n        { status: 500 }\r\n      )\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Role-based access control\r\n */\r\nexport function hasRole(user: AuthUser, role: string): boolean {\r\n  return user.roles.includes(role) || user.roles.includes('super_admin')\r\n}\r\n\r\n/**\r\n * Permission-based access control\r\n */\r\nexport function hasPermission(user: AuthUser, permission: string): boolean {\r\n  return user.permissions.includes(permission) ||\r\n         user.roles.includes('admin') ||\r\n         user.roles.includes('super_admin')\r\n}\r\n\r\n/**\r\n * Organization-based access control\r\n */\r\nexport function isSameOrganization(user: AuthUser, organizationId: string): boolean {\r\n  return user.organizationId === organizationId\r\n}\r\n\r\n/**\r\n * Login user and generate session\r\n */\r\nexport async function loginUser(email: string, password: string): Promise<{ user: AuthUser; token: string } | null> {\r\n  try {\r\n    // Find user with password (use proper password hashing in production)\r\n    const userResult = await db.query(`\r\n      SELECT\r\n        u.id, u.email, u.first_name, u.last_name, u.organization_id, u.password_hash,\r\n        COALESCE(array_agg(DISTINCT r.name) FILTER (WHERE r.name IS NOT NULL), '{}') as roles,\r\n        COALESCE(array_agg(DISTINCT p.name) FILTER (WHERE p.name IS NOT NULL), '{}') as permissions\r\n      FROM users u\r\n      LEFT JOIN user_roles ur ON u.id = ur.user_id\r\n      LEFT JOIN roles r ON ur.role_id = r.id\r\n      LEFT JOIN permissions p ON p.name = ANY(r.permissions::text[])\r\n      WHERE u.email = $1 AND u.is_active = true\r\n      GROUP BY u.id, u.email, u.first_name, u.last_name, u.organization_id, u.password_hash\r\n    `, [email.toLowerCase()])\r\n\r\n    if (userResult.rows.length === 0) {\r\n      return null\r\n    }\r\n\r\n    const userData = userResult.rows[0]\r\n\r\n    // Verify password using bcrypt\r\n    const isValidPassword = await bcrypt.compare(password, userData.password_hash)\r\n    if (!isValidPassword) {\r\n      return null\r\n    }\r\n\r\n    const user: AuthUser = {\r\n      id: userData.id,\r\n      email: userData.email,\r\n      firstName: userData.first_name,\r\n      lastName: userData.last_name,\r\n      organizationId: userData.organization_id,\r\n      roles: userData.roles || [],\r\n      permissions: userData.permissions || []\r\n    }\r\n\r\n    const token = await generateToken(user)\r\n\r\n    // Log login activity\r\n    await db.query(`\r\n      INSERT INTO activity_logs (user_id, organization_id, action, resource, details, ip_address, user_agent)\r\n      VALUES ($1, $2, 'login', 'auth', $3, $4, $5)\r\n    `, [\r\n      user.id,\r\n      user.organizationId,\r\n      JSON.stringify({ email, timestamp: new Date() }),\r\n      'unknown', // You can extract from request\r\n      'user-agent' // You can extract from request\r\n    ])\r\n\r\n    return { user, token }\r\n  } catch (error) {\r\n    console.error('Login error:', error)\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Refresh token if near expiry\r\n */\r\nexport async function refreshToken(currentToken: string): Promise<string | null> {\r\n  try {\r\n    const decoded = jwt.verify(currentToken, JWT_SECRET) as any\r\n\r\n    // Check if token expires within next 15 minutes\r\n    const expiryTime = decoded.exp * 1000\r\n    const refreshThreshold = 15 * 60 * 1000 // 15 minutes\r\n\r\n    if (expiryTime - Date.now() > refreshThreshold) {\r\n      return currentToken // Token still valid for a while\r\n    }\r\n\r\n    // Generate new token\r\n    const user = await verifyToken(currentToken)\r\n    if (!user) {\r\n      return null\r\n    }\r\n\r\n    return generateToken(user)\r\n  } catch (error) {\r\n    console.error('Token refresh error:', error)\r\n    return null\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\auth\\auth-context.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n'use client';\r\n\r\nimport React, { createContext, useContext, useEffect, useState, useCallback } from 'react';\r\nimport { AuthContext, AuthProvider as AuthProviderType, User, SignInCredentials, SignUpData, AuthResult } from '@/types/auth';\r\nimport { mockAuthProvider } from './mock-provider';\r\n\r\n// Create context\r\nconst AuthContextProvider = createContext<AuthContext | null>(null);\r\n\r\n// Provider component\r\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [authProvider] = useState<AuthProviderType>(mockAuthProvider);\r\n\r\n  // Initialize auth state\r\n  useEffect(() => {\r\n    let mounted = true;\r\n\r\n    const initializeAuth = async () => {\r\n      try {\r\n        setIsLoading(true);\r\n\r\n        // Check if user is already signed in\r\n        const currentUser = await authProvider.getCurrentUser();\r\n        if (mounted) {\r\n          setUser(currentUser);\r\n        }\r\n      } catch (error) {\r\n        console.error('Auth initialization error:', error);\r\n        if (mounted) {\r\n          setUser(null);\r\n        }\r\n      } finally {\r\n        if (mounted) {\r\n          setIsLoading(false);\r\n        }\r\n      }\r\n    };\r\n\r\n    initializeAuth();\r\n\r\n    return () => {\r\n      mounted = false;\r\n    };\r\n  }, [authProvider]);\r\n\r\n  // Sign in method\r\n  const signIn = useCallback(async (credentials: SignInCredentials): Promise<AuthResult> => {\r\n    try {\r\n      setIsLoading(true);\r\n      const result = await authProvider.signIn(credentials);\r\n\r\n      if (result.success && result.user) {\r\n        setUser(result.user);\r\n      }\r\n\r\n      return result;\r\n    } catch (error) {\r\n      console.error('Sign in error:', error);\r\n      return {\r\n        success: false,\r\n        message: 'An unexpected error occurred',\r\n        errors: [error instanceof Error ? error.message : 'Unknown error'],\r\n      };\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [authProvider]);\r\n\r\n  // Sign up method\r\n  const signUp = useCallback(async (data: SignUpData): Promise<AuthResult> => {\r\n    try {\r\n      setIsLoading(true);\r\n      const result = await authProvider.signUp(data);\r\n\r\n      if (result.success && result.user) {\r\n        setUser(result.user);\r\n      }\r\n\r\n      return result;\r\n    } catch (error) {\r\n      console.error('Sign up error:', error);\r\n      return {\r\n        success: false,\r\n        message: 'An unexpected error occurred',\r\n        errors: [error instanceof Error ? error.message : 'Unknown error'],\r\n      };\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [authProvider]);\r\n\r\n  // Sign out method\r\n  const signOut = useCallback(async (): Promise<void> => {\r\n    try {\r\n      setIsLoading(true);\r\n      await authProvider.signOut();\r\n      setUser(null);\r\n    } catch (error) {\r\n      console.error('Sign out error:', error);\r\n      // Even if signOut fails, clear local state\r\n      setUser(null);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [authProvider]);\r\n\r\n  // Update profile method\r\n  const updateProfile = useCallback(async (data: Partial<User>): Promise<User> => {\r\n    if (!user) {\r\n      throw new Error('No user signed in');\r\n    }\r\n\r\n    try {\r\n      const updatedUser = await authProvider.updateProfile(data);\r\n      setUser(updatedUser);\r\n      return updatedUser;\r\n    } catch (error) {\r\n      console.error('Update profile error:', error);\r\n      throw error;\r\n    }\r\n  }, [authProvider, user]);\r\n\r\n  // Permission checking utilities\r\n  const hasPermission = useCallback((permission: string): boolean => {\r\n    if (!user || !user.role) return false;\r\n\r\n    // Check if user has the specific permission\r\n    return user.role.permissions.some(p => p.name === permission) ||\r\n           user.permissions.some(p => p.name === permission);\r\n  }, [user]);\r\n\r\n  const hasRole = useCallback((roleName: string): boolean => {\r\n    if (!user || !user.role) return false;\r\n    return user.role.name === roleName;\r\n  }, [user]);\r\n\r\n  const canAccess = useCallback((module: string, action: string): boolean => {\r\n    if (!user) return false;\r\n\r\n    // Admin role has access to everything\r\n    if (user.role.name === 'super_admin' || user.role.name === 'org_admin') {\r\n      return true;\r\n    }\r\n\r\n    // Check specific permission\r\n    const permissionName = `${module}.${action}`;\r\n    return hasPermission(permissionName);\r\n  }, [user, hasPermission]);\r\n\r\n  // Computed values\r\n  const isAuthenticated = user !== null;\r\n\r\n  // Context value\r\n  const contextValue: AuthContext = {\r\n    user,\r\n    isLoading,\r\n    isAuthenticated,\r\n    signIn,\r\n    signUp,\r\n    signOut,\r\n    updateProfile,\r\n    hasPermission,\r\n    hasRole,\r\n    canAccess,\r\n  };\r\n\r\n  return (\r\n    <AuthContextProvider.Provider value={contextValue}>\r\n      {children}\r\n    </AuthContextProvider.Provider>\r\n  );\r\n}\r\n\r\n// Hook to use auth context\r\nexport function useAuth(): AuthContext {\r\n  const context = useContext(AuthContextProvider);\r\n\r\n  if (!context) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n\r\n  return context;\r\n}\r\n\r\n// Hook for protected routes\r\nexport function useRequireAuth(): User {\r\n  const { user, isLoading } = useAuth();\r\n\r\n  if (isLoading) {\r\n    throw new Error('Auth is still loading');\r\n  }\r\n\r\n  if (!user) {\r\n    throw new Error('Authentication required');\r\n  }\r\n\r\n  return user;\r\n}\r\n\r\n// Higher-order component for protected routes\r\nexport function withAuth<P extends object>(\r\n  Component: React.ComponentType<P>\r\n): React.ComponentType<P> {\r\n  return function AuthenticatedComponent(props: P) {\r\n    const { user, isLoading } = useAuth();\r\n\r\n    if (isLoading) {\r\n      return (\r\n        <div className=\"flex items-center justify-center min-h-screen\">\r\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    if (!user) {\r\n      // In a real app, redirect to login page\r\n      return (\r\n        <div className=\"flex items-center justify-center min-h-screen\">\r\n          <div className=\"text-center\">\r\n            <h1 className=\"text-2xl font-bold text-gray-900 mb-4\">Authentication Required</h1>\r\n            <p className=\"text-gray-600\">Please sign in to access this page.</p>\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return <Component {...props} />;\r\n  };\r\n}\r\n\r\n// Permission-based component wrapper\r\nexport function ProtectedComponent({\r\n  children,\r\n  permission,\r\n  role,\r\n  module,\r\n  action,\r\n  fallback,\r\n}: {\r\n  children: React.ReactNode;\r\n  permission?: string;\r\n  role?: string;\r\n  module?: string;\r\n  action?: string;\r\n  fallback?: React.ReactNode;\r\n}) {\r\n  const { hasPermission, hasRole, canAccess } = useAuth();\r\n\r\n  // Check permissions\r\n  let hasAccess = true;\r\n\r\n  if (permission && !hasPermission(permission)) {\r\n    hasAccess = false;\r\n  }\r\n\r\n  if (role && !hasRole(role)) {\r\n    hasAccess = false;\r\n  }\r\n\r\n  if (module && action && !canAccess(module, action)) {\r\n    hasAccess = false;\r\n  }\r\n\r\n  if (!hasAccess) {\r\n    return fallback || null;\r\n  }\r\n\r\n  return <>{children}</>;\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\auth\\middleware.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\n/**\n * Authentication & Authorization Middleware\n *\n * Provides authentication and authorization utilities for API routes\n *\n * @author Claude Code\n * @date 2025-11-02\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport * as jwt from 'jsonwebtoken';\n\nconst FALLBACK_ORG_ID = '00000000-0000-0000-0000-000000000000';\nconst DEFAULT_ORG_ID = process.env.DEFAULT_ORG_ID ?? FALLBACK_ORG_ID;\n\nconst JWT_SECRET = process.env.JWT_SECRET;\n\nif (!JWT_SECRET) {\n  throw new Error('JWT_SECRET environment variable is required');\n}\n\nexport interface AuthUser {\n  userId: string;\n  email: string;\n  name: string;\n  role: string;\n  permissions: string[];\n  organizationId: string;\n}\n\nexport class AuthError extends Error {\n  constructor(\n    message: string,\n    public statusCode: number = 401,\n    public code: string = 'AUTH_ERROR'\n  ) {\n    super(message);\n    this.name = 'AuthError';\n  }\n}\n\nexport class ServiceError extends Error {\n  constructor(\n    message: string,\n    public statusCode: number = 500,\n    public code: string = 'SERVICE_ERROR'\n  ) {\n    super(message);\n    this.name = 'ServiceError';\n  }\n}\n\n/**\n * Extract and verify JWT token from request\n */\nexport async function authenticateRequest(request: NextRequest): Promise<AuthUser> {\n  // Development mode bypass - return mock user\n  if (process.env.NODE_ENV === 'development' && process.env.DISABLE_AUTH === 'true') {\n    return {\n      userId: '11111111-1111-1111-1111-111111111111',\n      email: 'dev@mantisnxt.com',\n      name: 'Development User',\n      role: 'admin',\n      permissions: ['admin'],\n      organizationId: DEFAULT_ORG_ID,\n    };\n  }\n\n  const token = request.headers.get('authorization')?.replace('Bearer ', '');\n\n  if (!token) {\n    throw new AuthError('No authentication token provided', 401, 'NO_TOKEN');\n  }\n\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as AuthUser;\n    return decoded;\n  } catch (error) {\n    throw new AuthError('Invalid or expired token', 401, 'INVALID_TOKEN');\n  }\n}\n\n/**\n * Check if user has required permission\n */\nexport async function authorizeUser(\n  user: AuthUser,\n  requiredPermission: string\n): Promise<void> {\n  if (!user.permissions.includes(requiredPermission) && !user.permissions.includes('admin')) {\n    throw new AuthError(\n      `Missing required permission: ${requiredPermission}`,\n      403,\n      'FORBIDDEN'\n    );\n  }\n}\n\n/**\n * Check if user has admin role\n */\nexport async function requireAdmin(user: AuthUser): Promise<void> {\n  if (user.role !== 'admin' && user.role !== 'manager') {\n    throw new AuthError('Admin access required', 403, 'ADMIN_REQUIRED');\n  }\n}\n\n/**\n * Check if user can access customer data\n */\nexport async function authorizeCustomerAccess(\n  user: AuthUser,\n  customerId: string\n): Promise<void> {\n  // In a real implementation, this would check if the customer belongs to the user's organization\n  // For now, we'll just verify the user is authenticated\n  if (!user.organizationId) {\n    throw new AuthError('Invalid user organization', 403, 'INVALID_ORG');\n  }\n}\n\n/**\n * Standard error handler for API routes\n */\nexport function handleError(error: unknown): NextResponse {\n  console.error('API Error:', error);\n\n  if (error instanceof AuthError) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message,\n        code: error.code,\n      },\n      { status: error.statusCode }\n    );\n  }\n\n  if (error instanceof ServiceError) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message,\n        code: error.code,\n      },\n      { status: error.statusCode }\n    );\n  }\n\n  return NextResponse.json(\n    {\n      success: false,\n      error: 'Internal server error',\n      code: 'INTERNAL_ERROR',\n    },\n    { status: 500 }\n  );\n}\n\n/**\n * Extract pagination parameters from request\n */\nexport function getPaginationParams(searchParams: URLSearchParams): {\n  page: number;\n  limit: number;\n  offset: number;\n} {\n  const page = parseInt(searchParams.get('page') || '1');\n  const limit = Math.min(parseInt(searchParams.get('limit') || '20'), 100);\n  const offset = (page - 1) * limit;\n\n  return { page, limit, offset };\n}\n\n/**\n * Format pagination response\n */\nexport function formatPaginatedResponse<T>(\n  data: T[],\n  total: number,\n  page: number,\n  limit: number\n) {\n  return {\n    success: true,\n    data,\n    pagination: {\n      page,\n      limit,\n      total,\n      totalPages: Math.ceil(total / limit),\n      hasMore: page * limit < total,\n    },\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\auth\\mock-provider.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n// Mock Authentication Provider - Provider Agnostic Implementation\r\nimport {\r\n  AuthProvider,\r\n  User,\r\n  Organization,\r\n  LoginCredentials,\r\n  RegistrationData,\r\n  CreateUserData,\r\n  AuthResult,\r\n  TwoFactorSetup,\r\n  BulkImportResult,\r\n  SouthAfricanProvince,\r\n  Permission\r\n} from '@/types/auth'\r\n\r\n// Mock data store (in real app, this would be a database)\r\nconst mockUsers: User[] = [\r\n  {\r\n    id: 'user-1',\r\n    email: 'admin@mantis.co.za',\r\n    name: 'John Smith',\r\n    role: 'admin',\r\n    org_id: 'org-1',\r\n    department: 'IT',\r\n    permissions: [\r\n      { id: 'perm-1', name: 'users.manage', resource: 'users', action: 'manage' },\r\n      { id: 'perm-2', name: 'admin.access', resource: 'admin', action: 'manage' }\r\n    ],\r\n    created_at: new Date('2024-01-15'),\r\n    last_login: new Date(),\r\n    is_active: true,\r\n    profile_image: undefined,\r\n    id_number: '8001015009087',\r\n    employment_equity: 'white',\r\n    bee_status: 'level_4',\r\n    phone: '+27 11 123 4567',\r\n    mobile: '+27 82 123 4567',\r\n    address: {\r\n      street: '123 Business Park Drive',\r\n      suburb: 'Sandton',\r\n      city: 'Johannesburg',\r\n      province: 'gauteng',\r\n      postal_code: '2196',\r\n      country: 'South Africa'\r\n    },\r\n    preferences: {\r\n      language: 'en',\r\n      timezone: 'Africa/Johannesburg',\r\n      date_format: 'dd/mm/yyyy',\r\n      currency: 'ZAR',\r\n      notifications: {\r\n        email_notifications: true,\r\n        sms_notifications: false,\r\n        push_notifications: true,\r\n        digest_frequency: 'daily'\r\n      }\r\n    },\r\n    two_factor_enabled: false,\r\n    email_verified: true,\r\n    password_changed_at: new Date('2024-01-15')\r\n  },\r\n  {\r\n    id: 'user-2',\r\n    email: 'manager@mantis.co.za',\r\n    name: 'Sarah Johnson',\r\n    role: 'manager',\r\n    org_id: 'org-1',\r\n    department: 'Procurement',\r\n    permissions: [\r\n      { id: 'perm-3', name: 'users.read', resource: 'users', action: 'read' },\r\n      { id: 'perm-4', name: 'procurement.manage', resource: 'procurement', action: 'manage' }\r\n    ],\r\n    created_at: new Date('2024-01-20'),\r\n    last_login: new Date(Date.now() - 86400000), // 1 day ago\r\n    is_active: true,\r\n    profile_image: undefined,\r\n    id_number: '8505125234086',\r\n    employment_equity: 'african',\r\n    bee_status: 'level_2',\r\n    phone: '+27 21 456 7890',\r\n    mobile: '+27 83 456 7890',\r\n    address: {\r\n      street: '456 Corporate Avenue',\r\n      suburb: 'Cape Town City Centre',\r\n      city: 'Cape Town',\r\n      province: 'western_cape',\r\n      postal_code: '8001',\r\n      country: 'South Africa'\r\n    },\r\n    preferences: {\r\n      language: 'en',\r\n      timezone: 'Africa/Johannesburg',\r\n      date_format: 'dd/mm/yyyy',\r\n      currency: 'ZAR',\r\n      notifications: {\r\n        email_notifications: true,\r\n        sms_notifications: true,\r\n        push_notifications: true,\r\n        digest_frequency: 'weekly'\r\n      }\r\n    },\r\n    two_factor_enabled: true,\r\n    email_verified: true,\r\n    password_changed_at: new Date('2024-01-20')\r\n  },\r\n  {\r\n    id: 'user-3',\r\n    email: 'buyer@mantis.co.za',\r\n    name: 'Michael Brown',\r\n    role: 'user',\r\n    org_id: 'org-1',\r\n    department: 'Procurement',\r\n    permissions: [\r\n      { id: 'perm-5', name: 'procurement.read', resource: 'procurement', action: 'read' },\r\n      { id: 'perm-6', name: 'orders.create', resource: 'orders', action: 'create' }\r\n    ],\r\n    created_at: new Date('2024-02-01'),\r\n    last_login: new Date(Date.now() - 3600000), // 1 hour ago\r\n    is_active: true,\r\n    profile_image: undefined,\r\n    id_number: '9002153456789',\r\n    employment_equity: 'coloured',\r\n    bee_status: 'level_3',\r\n    phone: '+27 31 789 0123',\r\n    mobile: '+27 84 789 0123',\r\n    address: {\r\n      street: '789 Industrial Road',\r\n      suburb: 'Westville',\r\n      city: 'Durban',\r\n      province: 'kwazulu_natal',\r\n      postal_code: '3629',\r\n      country: 'South Africa'\r\n    },\r\n    preferences: {\r\n      language: 'en',\r\n      timezone: 'Africa/Johannesburg',\r\n      date_format: 'dd/mm/yyyy',\r\n      currency: 'ZAR',\r\n      notifications: {\r\n        email_notifications: true,\r\n        sms_notifications: false,\r\n        push_notifications: false,\r\n        digest_frequency: 'monthly'\r\n      }\r\n    },\r\n    two_factor_enabled: false,\r\n    email_verified: true,\r\n    password_changed_at: new Date('2024-02-01')\r\n  }\r\n]\r\n\r\nconst mockOrganizations: Organization[] = [\r\n  {\r\n    id: 'org-1',\r\n    name: 'Mantis Procurement Solutions',\r\n    legal_name: 'Mantis Procurement Solutions (Pty) Ltd',\r\n    registration_number: '2024/123456/07',\r\n    vat_number: '4123456789',\r\n    bee_level: 4,\r\n    province: 'gauteng',\r\n    industry: 'Technology Services',\r\n    created_at: new Date('2024-01-01'),\r\n    is_active: true,\r\n    contact_email: 'info@mantis.co.za',\r\n    phone: '+27 11 123 4567',\r\n    address: {\r\n      street: '123 Business Park Drive',\r\n      suburb: 'Sandton',\r\n      city: 'Johannesburg',\r\n      province: 'gauteng',\r\n      postal_code: '2196',\r\n      country: 'South Africa'\r\n    },\r\n    logo_url: undefined,\r\n    settings: {\r\n      allow_self_registration: false,\r\n      require_email_verification: true,\r\n      enforce_two_factor: false,\r\n      password_policy: {\r\n        min_length: 8,\r\n        require_uppercase: true,\r\n        require_lowercase: true,\r\n        require_numbers: true,\r\n        require_symbols: true,\r\n        expires_days: 90\r\n      },\r\n      session_timeout: 3600,\r\n      allowed_domains: ['mantis.co.za']\r\n    }\r\n  }\r\n]\r\n\r\nexport class MockAuthProvider implements AuthProvider {\r\n  private currentUser: User | null = null\r\n  private sessionToken: string | null = null\r\n\r\n  async login(credentials: LoginCredentials): Promise<AuthResult> {\r\n    // Simulate API delay\r\n    await new Promise(resolve => setTimeout(resolve, 1000))\r\n\r\n    // Mock authentication - accept any valid email format with password length >= 3\r\n    if (!credentials.email.includes('@') || credentials.password.length < 3) {\r\n      return {\r\n        success: false,\r\n        message: 'Invalid email or password',\r\n        errors: ['Please check your email and password']\r\n      }\r\n    }\r\n\r\n    // Find user or create demo user for valid emails\r\n    let user = mockUsers.find(u => u.email === credentials.email)\r\n\r\n    if (!user) {\r\n      // Auto-create user for demo purposes\r\n      const newUser: User = {\r\n        id: `user-${Date.now()}`,\r\n        email: credentials.email,\r\n        name: credentials.email.split('@')[0].replace(/[._]/g, ' '),\r\n        role: 'viewer',\r\n        org_id: 'org-1',\r\n        department: 'General',\r\n        permissions: [\r\n          { id: 'perm-view', name: 'basic.read', resource: 'basic', action: 'read' }\r\n        ],\r\n        created_at: new Date(),\r\n        last_login: new Date(),\r\n        is_active: true,\r\n        phone: '+27 11 000 0000',\r\n        preferences: {\r\n          language: 'en',\r\n          timezone: 'Africa/Johannesburg',\r\n          date_format: 'dd/mm/yyyy',\r\n          currency: 'ZAR',\r\n          notifications: {\r\n            email_notifications: true,\r\n            sms_notifications: false,\r\n            push_notifications: true,\r\n            digest_frequency: 'weekly'\r\n          }\r\n        },\r\n        two_factor_enabled: false,\r\n        email_verified: true,\r\n        password_changed_at: new Date()\r\n      }\r\n\r\n      mockUsers.push(newUser)\r\n      user = newUser\r\n    }\r\n\r\n    // Check for 2FA requirement\r\n    if (user.two_factor_enabled && !credentials.two_factor_code) {\r\n      return {\r\n        success: false,\r\n        requires_two_factor: true,\r\n        two_factor_token: `2fa-token-${user.id}-${Date.now()}`,\r\n        message: 'Two-factor authentication required'\r\n      }\r\n    }\r\n\r\n    // Verify 2FA code if provided\r\n    if (user.two_factor_enabled && credentials.two_factor_code) {\r\n      // Mock 2FA verification - accept any 6-digit code\r\n      if (!/^\\d{6}$/.test(credentials.two_factor_code)) {\r\n        return {\r\n          success: false,\r\n          message: 'Invalid verification code'\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update last login\r\n    user.last_login = new Date()\r\n\r\n    // Set current user and session\r\n    this.currentUser = user\r\n    this.sessionToken = `mock-token-${user.id}-${Date.now()}`\r\n\r\n    return {\r\n      success: true,\r\n      user,\r\n      token: this.sessionToken,\r\n      message: 'Login successful'\r\n    }\r\n  }\r\n\r\n  async logout(): Promise<void> {\r\n    await new Promise(resolve => setTimeout(resolve, 300))\r\n    this.currentUser = null\r\n    this.sessionToken = null\r\n  }\r\n\r\n  async register(data: RegistrationData): Promise<AuthResult> {\r\n    await new Promise(resolve => setTimeout(resolve, 1500))\r\n\r\n    // Check if user already exists\r\n    if (mockUsers.find(u => u.email === data.email)) {\r\n      return {\r\n        success: false,\r\n        message: 'User already exists',\r\n        errors: ['A user with this email already exists']\r\n      }\r\n    }\r\n\r\n    // Create new organization\r\n    const newOrg: Organization = {\r\n      id: `org-${Date.now()}`,\r\n      name: data.organization_name,\r\n      legal_name: data.organization_legal_name,\r\n      registration_number: data.registration_number,\r\n      vat_number: data.vat_number,\r\n      bee_level: data.bee_level,\r\n      province: data.province,\r\n      industry: data.industry,\r\n      created_at: new Date(),\r\n      is_active: true,\r\n      contact_email: data.email,\r\n      phone: data.phone,\r\n      address: data.address,\r\n      settings: {\r\n        allow_self_registration: false,\r\n        require_email_verification: true,\r\n        enforce_two_factor: false,\r\n        password_policy: {\r\n          min_length: 8,\r\n          require_uppercase: true,\r\n          require_lowercase: true,\r\n          require_numbers: true,\r\n          require_symbols: true,\r\n          expires_days: 90\r\n        },\r\n        session_timeout: 3600,\r\n        allowed_domains: [data.email.split('@')[1]]\r\n      }\r\n    }\r\n\r\n    mockOrganizations.push(newOrg)\r\n\r\n    // Create admin user\r\n    const newUser: User = {\r\n      id: `user-${Date.now()}`,\r\n      email: data.email,\r\n      name: data.name,\r\n      role: 'admin',\r\n      org_id: newOrg.id,\r\n      department: 'Administration',\r\n      permissions: [\r\n        { id: 'perm-admin', name: 'admin.manage', resource: 'admin', action: 'manage' },\r\n        { id: 'perm-users', name: 'users.manage', resource: 'users', action: 'manage' }\r\n      ],\r\n      created_at: new Date(),\r\n      last_login: new Date(),\r\n      is_active: true,\r\n      id_number: data.id_number,\r\n      phone: data.phone,\r\n      address: data.address,\r\n      preferences: {\r\n        language: 'en',\r\n        timezone: 'Africa/Johannesburg',\r\n        date_format: 'dd/mm/yyyy',\r\n        currency: 'ZAR',\r\n        notifications: {\r\n          email_notifications: true,\r\n          sms_notifications: false,\r\n          push_notifications: true,\r\n          digest_frequency: 'daily'\r\n        }\r\n      },\r\n      two_factor_enabled: false,\r\n      email_verified: false, // Would require verification in real system\r\n      password_changed_at: new Date()\r\n    }\r\n\r\n    mockUsers.push(newUser)\r\n\r\n    // For mock: auto-verify and sign in\r\n    newUser.email_verified = true\r\n    this.currentUser = newUser\r\n    this.sessionToken = `mock-token-${newUser.id}-${Date.now()}`\r\n\r\n    return {\r\n      success: true,\r\n      user: newUser,\r\n      token: this.sessionToken,\r\n      message: 'Registration successful'\r\n    }\r\n  }\r\n\r\n  async resetPassword(email: string): Promise<void> {\r\n    await new Promise(resolve => setTimeout(resolve, 1000))\r\n    console.log(`Password reset requested for: ${email}`)\r\n  }\r\n\r\n  async verifyEmail(token: string): Promise<boolean> {\r\n    await new Promise(resolve => setTimeout(resolve, 800))\r\n    // Mock verification - accept any token\r\n    return token.length > 10\r\n  }\r\n\r\n  async setupTwoFactor(): Promise<TwoFactorSetup> {\r\n    await new Promise(resolve => setTimeout(resolve, 1000))\r\n\r\n    const secret = 'JBSWY3DPEHPK3PXP'\r\n    const qrCode = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==`\r\n    const backupCodes = [\r\n      '12345678', '23456789', '34567890', '45678901', '56789012',\r\n      '67890123', '78901234', '89012345', '90123456', '01234567'\r\n    ]\r\n\r\n    return {\r\n      secret,\r\n      qr_code: qrCode,\r\n      backup_codes: backupCodes\r\n    }\r\n  }\r\n\r\n  async verifyTwoFactor(token: string, code: string): Promise<boolean> {\r\n    await new Promise(resolve => setTimeout(resolve, 500))\r\n    // Mock verification - accept any 6-digit code\r\n    return /^\\d{6}$/.test(code);\r\n  }\r\n\r\n  async disableTwoFactor(password: string): Promise<boolean> {\r\n    await new Promise(resolve => setTimeout(resolve, 500))\r\n    return password.length >= 3\r\n  }\r\n\r\n  async getCurrentUser(): Promise<User | null> {\r\n    await new Promise(resolve => setTimeout(resolve, 200))\r\n    return this.currentUser\r\n  }\r\n\r\n  async refreshToken(): Promise<string> {\r\n    await new Promise(resolve => setTimeout(resolve, 300))\r\n    if (!this.currentUser) {\r\n      throw new Error('No user signed in')\r\n    }\r\n    this.sessionToken = `mock-token-${this.currentUser.id}-${Date.now()}`\r\n    return this.sessionToken\r\n  }\r\n\r\n  async changePassword(oldPassword: string, newPassword: string): Promise<void> {\r\n    await new Promise(resolve => setTimeout(resolve, 1000))\r\n    if (!this.currentUser) {\r\n      throw new Error('No user signed in')\r\n    }\r\n    if (oldPassword.length < 3) {\r\n      throw new Error('Current password is incorrect')\r\n    }\r\n    console.log(`Password updated for user: ${this.currentUser.email}`)\r\n  }\r\n\r\n  async updateProfile(data: Partial<User>): Promise<User> {\r\n    await new Promise(resolve => setTimeout(resolve, 800))\r\n    if (!this.currentUser) {\r\n      throw new Error('No user signed in')\r\n    }\r\n\r\n    // Update user data\r\n    Object.assign(this.currentUser, data)\r\n\r\n    // Update in mock store\r\n    const userIndex = mockUsers.findIndex(u => u.id === this.currentUser!.id)\r\n    if (userIndex >= 0) {\r\n      mockUsers[userIndex] = this.currentUser\r\n    }\r\n\r\n    return this.currentUser\r\n  }\r\n\r\n  async createUser(data: CreateUserData): Promise<User> {\r\n    await new Promise(resolve => setTimeout(resolve, 1000))\r\n\r\n    const newUser: User = {\r\n      id: `user-${Date.now()}`,\r\n      email: data.email,\r\n      name: data.name,\r\n      role: data.role,\r\n      org_id: this.currentUser?.org_id || 'org-1',\r\n      department: data.department,\r\n      permissions: data.permissions?.map(p => ({\r\n        id: `perm-${p}`,\r\n        name: p,\r\n        resource: p.split('.')[0],\r\n        action: p.split('.')[1] as any\r\n      })) || [],\r\n      created_at: new Date(),\r\n      last_login: new Date(),\r\n      is_active: true,\r\n      id_number: data.id_number,\r\n      employment_equity: data.employment_equity,\r\n      phone: data.phone,\r\n      preferences: {\r\n        language: 'en',\r\n        timezone: 'Africa/Johannesburg',\r\n        date_format: 'dd/mm/yyyy',\r\n        currency: 'ZAR',\r\n        notifications: {\r\n          email_notifications: true,\r\n          sms_notifications: false,\r\n          push_notifications: true,\r\n          digest_frequency: 'weekly'\r\n        }\r\n      },\r\n      two_factor_enabled: false,\r\n      email_verified: !data.send_invitation,\r\n      password_changed_at: new Date()\r\n    }\r\n\r\n    mockUsers.push(newUser)\r\n    return newUser\r\n  }\r\n\r\n  async updateUser(id: string, data: Partial<User>): Promise<User> {\r\n    await new Promise(resolve => setTimeout(resolve, 800))\r\n\r\n    const userIndex = mockUsers.findIndex(u => u.id === id)\r\n    if (userIndex === -1) {\r\n      throw new Error('User not found')\r\n    }\r\n\r\n    Object.assign(mockUsers[userIndex], data)\r\n    return mockUsers[userIndex]\r\n  }\r\n\r\n  async deleteUser(id: string): Promise<void> {\r\n    await new Promise(resolve => setTimeout(resolve, 500))\r\n\r\n    const userIndex = mockUsers.findIndex(u => u.id === id)\r\n    if (userIndex === -1) {\r\n      throw new Error('User not found')\r\n    }\r\n\r\n    mockUsers.splice(userIndex, 1)\r\n  }\r\n\r\n  async getUsersByOrganization(orgId: string): Promise<User[]> {\r\n    await new Promise(resolve => setTimeout(resolve, 600))\r\n    return mockUsers.filter(u => u.org_id === orgId)\r\n  }\r\n\r\n  async bulkImportUsers(csvData: string): Promise<BulkImportResult> {\r\n    await new Promise(resolve => setTimeout(resolve, 2000))\r\n\r\n    const lines = csvData.split('\\n').filter(line => line.trim())\r\n    const headers = lines[0].split(',')\r\n    const dataLines = lines.slice(1)\r\n\r\n    const result: BulkImportResult = {\r\n      total_processed: dataLines.length,\r\n      successful_imports: 0,\r\n      failed_imports: 0,\r\n      errors: [],\r\n      created_users: []\r\n    }\r\n\r\n    dataLines.forEach((line, index) => {\r\n      const values = line.split(',')\r\n      try {\r\n        // Mock validation and user creation\r\n        if (values.length < headers.length) {\r\n          throw new Error('Missing required fields')\r\n        }\r\n\r\n        const email = values[headers.indexOf('email')]\r\n        if (!email || !email.includes('@')) {\r\n          throw new Error('Invalid email address')\r\n        }\r\n\r\n        if (mockUsers.find(u => u.email === email)) {\r\n          throw new Error('User already exists')\r\n        }\r\n\r\n        // Create mock user\r\n        const newUser: User = {\r\n          id: `user-${Date.now()}-${index}`,\r\n          email,\r\n          name: values[headers.indexOf('name')] || 'Unknown',\r\n          role: (values[headers.indexOf('role')] as any) || 'viewer',\r\n          org_id: this.currentUser?.org_id || 'org-1',\r\n          department: values[headers.indexOf('department')] || 'General',\r\n          permissions: [],\r\n          created_at: new Date(),\r\n          last_login: new Date(),\r\n          is_active: true,\r\n          phone: values[headers.indexOf('phone')] || '+27 11 000 0000',\r\n          preferences: {\r\n            language: 'en',\r\n            timezone: 'Africa/Johannesburg',\r\n            date_format: 'dd/mm/yyyy',\r\n            currency: 'ZAR',\r\n            notifications: {\r\n              email_notifications: true,\r\n              sms_notifications: false,\r\n              push_notifications: true,\r\n              digest_frequency: 'weekly'\r\n            }\r\n          },\r\n          two_factor_enabled: false,\r\n          email_verified: true,\r\n          password_changed_at: new Date()\r\n        }\r\n\r\n        mockUsers.push(newUser)\r\n        result.created_users.push(newUser)\r\n        result.successful_imports++\r\n      } catch (error) {\r\n        result.failed_imports++\r\n        result.errors.push({\r\n          row: index + 2, // +2 because index is 0-based and we skip header\r\n          email: values[headers.indexOf('email')],\r\n          errors: [error instanceof Error ? error.message : 'Unknown error']\r\n        })\r\n      }\r\n    })\r\n\r\n    return result\r\n  }\r\n\r\n  // Mock utility methods\r\n  getMockUsers(): User[] {\r\n    return [...mockUsers]\r\n  }\r\n\r\n  getMockOrganizations(): Organization[] {\r\n    return [...mockOrganizations]\r\n  }\r\n\r\n  clearMockData(): void {\r\n    this.currentUser = null\r\n    this.sessionToken = null\r\n    // Reset to original data\r\n    mockUsers.splice(3) // Remove any added users beyond the first 3\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const authProvider = new MockAuthProvider()\r\n\r\n// Export singleton instance\r\nexport const mockAuthProvider = new MockAuthProvider();","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\auth\\multi-tenant-auth.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":1,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":1,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// @ts-nocheck\r\n/**\r\n * Multi-Tenant Authentication System\r\n * Enterprise authentication with live database integration\r\n */\r\n\r\nimport { db } from '../database';\r\nimport { sign, verify } from 'jsonwebtoken';\r\nimport { hash, compare } from 'bcryptjs';\r\nimport { EventEmitter } from 'events';\r\n\r\nexport interface User {\r\n  id: string;\r\n  email: string;\r\n  name: string;\r\n  organizationId: string;\r\n  role: string;\r\n  permissions: string[];\r\n  status: 'active' | 'inactive' | 'suspended';\r\n  lastLogin?: string;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nexport interface Organization {\r\n  id: string;\r\n  name: string;\r\n  domain: string;\r\n  status: 'active' | 'suspended' | 'trial';\r\n  plan: 'free' | 'pro' | 'enterprise';\r\n  settings: Record<string, any>;\r\n  createdAt: string;\r\n}\r\n\r\nexport interface AuthSession {\r\n  id: string;\r\n  userId: string;\r\n  organizationId: string;\r\n  token: string;\r\n  refreshToken: string;\r\n  expiresAt: string;\r\n  createdAt: string;\r\n  lastAccessed: string;\r\n  ipAddress?: string;\r\n  userAgent?: string;\r\n}\r\n\r\nexport interface LoginCredentials {\r\n  email: string;\r\n  password: string;\r\n  organizationDomain?: string;\r\n  rememberMe?: boolean;\r\n}\r\n\r\nexport interface AuthResult {\r\n  success: boolean;\r\n  user?: User;\r\n  organization?: Organization;\r\n  session?: AuthSession;\r\n  token?: string;\r\n  refreshToken?: string;\r\n  error?: string;\r\n}\r\n\r\nexport class MultiTenantAuth extends EventEmitter {\r\n  private readonly jwtSecret: string;\r\n  private readonly tokenExpiry: string;\r\n  private readonly refreshTokenExpiry: string;\r\n\r\n  constructor() {\r\n    super();\r\n    const secret = process.env.JWT_SECRET;\r\n    if (!secret) {\r\n      throw new Error('JWT_SECRET environment variable is required for authentication');\r\n    }\r\n    this.jwtSecret = secret;\r\n    this.tokenExpiry = '1h';\r\n    this.refreshTokenExpiry = '30d';\r\n  }\r\n\r\n  /**\r\n   * Authenticate user with email and password\r\n   */\r\n  async login(credentials: LoginCredentials): Promise<AuthResult> {\r\n    try {\r\n      // Find user by email\r\n      const userQuery = `\r\n        SELECT u.*, o.name as organization_name, o.domain as organization_domain,\r\n               o.status as org_status, o.plan as org_plan\r\n        FROM users u\r\n        JOIN organizations o ON u.organization_id = o.id\r\n        WHERE u.email = $1 AND u.status = 'active'\r\n      `;\r\n\r\n      const userResult = await db.query(userQuery, [credentials.email]);\r\n\r\n      if (userResult.rows.length === 0) {\r\n        return {\r\n          success: false,\r\n          error: 'Invalid email or password'\r\n        };\r\n      }\r\n\r\n      const userData = userResult.rows[0];\r\n\r\n      // Verify organization domain if provided\r\n      if (credentials.organizationDomain &&\r\n          userData.organization_domain !== credentials.organizationDomain) {\r\n        return {\r\n          success: false,\r\n          error: 'Invalid organization domain'\r\n        };\r\n      }\r\n\r\n      // Check organization status\r\n      if (userData.org_status !== 'active') {\r\n        return {\r\n          success: false,\r\n          error: 'Organization is not active'\r\n        };\r\n      }\r\n\r\n      // Verify password\r\n      const isPasswordValid = await compare(credentials.password, userData.password_hash);\r\n      if (!isPasswordValid) {\r\n        // Log failed login attempt\r\n        await this.logAuthEvent('login_failed', userData.id, userData.organization_id);\r\n        return {\r\n          success: false,\r\n          error: 'Invalid email or password'\r\n        };\r\n      }\r\n\r\n      // Get user permissions\r\n      const permissionsQuery = `\r\n        SELECT p.name\r\n        FROM permissions p\r\n        JOIN role_permissions rp ON p.id = rp.permission_id\r\n        JOIN user_roles ur ON rp.role_id = ur.role_id\r\n        WHERE ur.user_id = $1\r\n      `;\r\n\r\n      const permissionsResult = await db.query(permissionsQuery, [userData.id]);\r\n      const permissions = permissionsResult.rows.map(row => row.name);\r\n\r\n      // Create user object\r\n      const user: User = {\r\n        id: userData.id,\r\n        email: userData.email,\r\n        name: userData.name,\r\n        organizationId: userData.organization_id,\r\n        role: userData.role,\r\n        permissions,\r\n        status: userData.status,\r\n        lastLogin: userData.last_login,\r\n        createdAt: userData.created_at,\r\n        updatedAt: userData.updated_at\r\n      };\r\n\r\n      // Create organization object\r\n      const organization: Organization = {\r\n        id: userData.organization_id,\r\n        name: userData.organization_name,\r\n        domain: userData.organization_domain,\r\n        status: userData.org_status,\r\n        plan: userData.org_plan,\r\n        settings: userData.org_settings || {},\r\n        createdAt: userData.org_created_at\r\n      };\r\n\r\n      // Create session\r\n      const session = await this.createSession(user, credentials.rememberMe);\r\n\r\n      // Update last login\r\n      await db.query(\r\n        'UPDATE users SET last_login = NOW() WHERE id = $1',\r\n        [user.id]\r\n      );\r\n\r\n      // Log successful login\r\n      await this.logAuthEvent('login_success', user.id, user.organizationId, {\r\n        sessionId: session.id\r\n      });\r\n\r\n      // Emit authentication event\r\n      this.emit('login', { user, organization, session });\r\n\r\n      return {\r\n        success: true,\r\n        user,\r\n        organization,\r\n        session,\r\n        token: session.token,\r\n        refreshToken: session.refreshToken\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('❌ Login error:', error);\r\n      return {\r\n        success: false,\r\n        error: 'Authentication failed'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create authentication session\r\n   */\r\n  private async createSession(user: User, rememberMe: boolean = false): Promise<AuthSession> {\r\n    const sessionId = this.generateSessionId();\r\n    const expiresAt = new Date();\r\n\r\n    if (rememberMe) {\r\n      expiresAt.setDate(expiresAt.getDate() + 30); // 30 days\r\n    } else {\r\n      expiresAt.setHours(expiresAt.getHours() + 24); // 24 hours\r\n    }\r\n\r\n    // Create JWT token\r\n    const token = sign(\r\n      {\r\n        userId: user.id,\r\n        organizationId: user.organizationId,\r\n        sessionId,\r\n        permissions: user.permissions\r\n      },\r\n      this.jwtSecret,\r\n      { expiresIn: this.tokenExpiry }\r\n    );\r\n\r\n    // Create refresh token\r\n    const refreshToken = sign(\r\n      { userId: user.id, sessionId, type: 'refresh' },\r\n      this.jwtSecret,\r\n      { expiresIn: this.refreshTokenExpiry }\r\n    );\r\n\r\n    // Store session in database\r\n    const sessionQuery = `\r\n      INSERT INTO auth_sessions (id, user_id, organization_id, token_hash, refresh_token_hash, expires_at, created_at, last_accessed)\r\n      VALUES ($1, $2, $3, $4, $5, $6, NOW(), NOW())\r\n      RETURNING *\r\n    `;\r\n\r\n    const tokenHash = await hash(token, 10);\r\n    const refreshTokenHash = await hash(refreshToken, 10);\r\n\r\n    const sessionResult = await db.query(sessionQuery, [\r\n      sessionId,\r\n      user.id,\r\n      user.organizationId,\r\n      tokenHash,\r\n      refreshTokenHash,\r\n      expiresAt.toISOString()\r\n    ]);\r\n\r\n    const sessionData = sessionResult.rows[0];\r\n\r\n    return {\r\n      id: sessionData.id,\r\n      userId: sessionData.user_id,\r\n      organizationId: sessionData.organization_id,\r\n      token,\r\n      refreshToken,\r\n      expiresAt: sessionData.expires_at,\r\n      createdAt: sessionData.created_at,\r\n      lastAccessed: sessionData.last_accessed\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Verify JWT token and get user session\r\n   */\r\n  async verifyToken(token: string): Promise<AuthResult> {\r\n    try {\r\n      // Verify JWT\r\n      const decoded = verify(token, this.jwtSecret) as any;\r\n\r\n      // Check session exists and is valid\r\n      const sessionQuery = `\r\n        SELECT s.*, u.email, u.name, u.status as user_status,\r\n               o.name as organization_name, o.status as org_status\r\n        FROM auth_sessions s\r\n        JOIN users u ON s.user_id = u.id\r\n        JOIN organizations o ON s.organization_id = o.id\r\n        WHERE s.id = $1 AND s.expires_at > NOW()\r\n      `;\r\n\r\n      const sessionResult = await db.query(sessionQuery, [decoded.sessionId]);\r\n\r\n      if (sessionResult.rows.length === 0) {\r\n        return {\r\n          success: false,\r\n          error: 'Invalid or expired session'\r\n        };\r\n      }\r\n\r\n      const sessionData = sessionResult.rows[0];\r\n\r\n      // Check user and organization status\r\n      if (sessionData.user_status !== 'active' || sessionData.org_status !== 'active') {\r\n        return {\r\n          success: false,\r\n          error: 'User or organization is not active'\r\n        };\r\n      }\r\n\r\n      // Update last accessed\r\n      await db.query(\r\n        'UPDATE auth_sessions SET last_accessed = NOW() WHERE id = $1',\r\n        [decoded.sessionId]\r\n      );\r\n\r\n      // Get user permissions\r\n      const permissionsQuery = `\r\n        SELECT p.name\r\n        FROM permissions p\r\n        JOIN role_permissions rp ON p.id = rp.permission_id\r\n        JOIN user_roles ur ON rp.role_id = ur.role_id\r\n        WHERE ur.user_id = $1\r\n      `;\r\n\r\n      const permissionsResult = await db.query(permissionsQuery, [decoded.userId]);\r\n      const permissions = permissionsResult.rows.map(row => row.name);\r\n\r\n      const user: User = {\r\n        id: decoded.userId,\r\n        email: sessionData.email,\r\n        name: sessionData.name,\r\n        organizationId: decoded.organizationId,\r\n        role: sessionData.role,\r\n        permissions,\r\n        status: sessionData.user_status,\r\n        createdAt: sessionData.user_created_at,\r\n        updatedAt: sessionData.user_updated_at\r\n      };\r\n\r\n      return {\r\n        success: true,\r\n        user\r\n      };\r\n\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: 'Invalid token'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Refresh authentication token\r\n   */\r\n  async refreshToken(refreshToken: string): Promise<AuthResult> {\r\n    try {\r\n      // Verify refresh token\r\n      const decoded = verify(refreshToken, this.jwtSecret) as any;\r\n\r\n      if (decoded.type !== 'refresh') {\r\n        return {\r\n          success: false,\r\n          error: 'Invalid refresh token'\r\n        };\r\n      }\r\n\r\n      // Get session and user data\r\n      const sessionQuery = `\r\n        SELECT s.*, u.email, u.name, u.organization_id, u.role, u.status,\r\n               o.name as organization_name, o.status as org_status\r\n        FROM auth_sessions s\r\n        JOIN users u ON s.user_id = u.id\r\n        JOIN organizations o ON s.organization_id = o.id\r\n        WHERE s.id = $1 AND s.expires_at > NOW()\r\n      `;\r\n\r\n      const sessionResult = await db.query(sessionQuery, [decoded.sessionId]);\r\n\r\n      if (sessionResult.rows.length === 0) {\r\n        return {\r\n          success: false,\r\n          error: 'Invalid or expired session'\r\n        };\r\n      }\r\n\r\n      const sessionData = sessionResult.rows[0];\r\n\r\n      // Check status\r\n      if (sessionData.status !== 'active' || sessionData.org_status !== 'active') {\r\n        return {\r\n          success: false,\r\n          error: 'User or organization is not active'\r\n        };\r\n      }\r\n\r\n      // Get permissions\r\n      const permissionsQuery = `\r\n        SELECT p.name\r\n        FROM permissions p\r\n        JOIN role_permissions rp ON p.id = rp.permission_id\r\n        JOIN user_roles ur ON rp.role_id = ur.role_id\r\n        WHERE ur.user_id = $1\r\n      `;\r\n\r\n      const permissionsResult = await db.query(permissionsQuery, [decoded.userId]);\r\n      const permissions = permissionsResult.rows.map(row => row.name);\r\n\r\n      // Create new access token\r\n      const newToken = sign(\r\n        {\r\n          userId: decoded.userId,\r\n          organizationId: sessionData.organization_id,\r\n          sessionId: decoded.sessionId,\r\n          permissions\r\n        },\r\n        this.jwtSecret,\r\n        { expiresIn: this.tokenExpiry }\r\n      );\r\n\r\n      // Update token hash in database\r\n      const tokenHash = await hash(newToken, 10);\r\n      await db.query(\r\n        'UPDATE auth_sessions SET token_hash = $1, last_accessed = NOW() WHERE id = $2',\r\n        [tokenHash, decoded.sessionId]\r\n      );\r\n\r\n      const user: User = {\r\n        id: decoded.userId,\r\n        email: sessionData.email,\r\n        name: sessionData.name,\r\n        organizationId: sessionData.organization_id,\r\n        role: sessionData.role,\r\n        permissions,\r\n        status: sessionData.status,\r\n        createdAt: sessionData.created_at,\r\n        updatedAt: sessionData.updated_at\r\n      };\r\n\r\n      return {\r\n        success: true,\r\n        user,\r\n        token: newToken\r\n      };\r\n\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        error: 'Failed to refresh token'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Logout user and invalidate session\r\n   */\r\n  async logout(sessionId: string): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n      // Delete session from database\r\n      const result = await db.query(\r\n        'DELETE FROM auth_sessions WHERE id = $1 RETURNING user_id, organization_id',\r\n        [sessionId]\r\n      );\r\n\r\n      if (result.rows.length > 0) {\r\n        const { user_id, organization_id } = result.rows[0];\r\n\r\n        // Log logout event\r\n        await this.logAuthEvent('logout', user_id, organization_id, { sessionId });\r\n\r\n        // Emit logout event\r\n        this.emit('logout', { sessionId, userId: user_id, organizationId: organization_id });\r\n      }\r\n\r\n      return { success: true };\r\n\r\n    } catch (error) {\r\n      console.error('❌ Logout error:', error);\r\n      return {\r\n        success: false,\r\n        error: 'Failed to logout'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if user has permission\r\n   */\r\n  hasPermission(user: User, permission: string): boolean {\r\n    return user.permissions.includes(permission) || user.permissions.includes('*');\r\n  }\r\n\r\n  /**\r\n   * Check if user belongs to organization\r\n   */\r\n  belongsToOrganization(user: User, organizationId: string): boolean {\r\n    return user.organizationId === organizationId;\r\n  }\r\n\r\n  /**\r\n   * Log authentication events\r\n   */\r\n  private async logAuthEvent(\r\n    event: string,\r\n    userId: string,\r\n    organizationId: string,\r\n    metadata: any = {}\r\n  ): Promise<void> {\r\n    try {\r\n      await db.query(\r\n        `INSERT INTO auth_logs (event, user_id, organization_id, metadata, created_at)\r\n         VALUES ($1, $2, $3, $4, NOW())`,\r\n        [event, userId, organizationId, JSON.stringify(metadata)]\r\n      );\r\n    } catch (error) {\r\n      console.error('❌ Error logging auth event:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate session ID\r\n   */\r\n  private generateSessionId(): string {\r\n    return `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  /**\r\n   * Clean up expired sessions\r\n   */\r\n  async cleanupExpiredSessions(): Promise<void> {\r\n    try {\r\n      const result = await db.query(\r\n        'DELETE FROM auth_sessions WHERE expires_at < NOW()'\r\n      );\r\n\r\n      if (result.rowCount && result.rowCount > 0) {\r\n        console.log(`🧹 Cleaned up ${result.rowCount} expired sessions`);\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ Error cleaning up sessions:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get active sessions for user\r\n   */\r\n  async getUserSessions(userId: string): Promise<AuthSession[]> {\r\n    const query = `\r\n      SELECT * FROM auth_sessions\r\n      WHERE user_id = $1 AND expires_at > NOW()\r\n      ORDER BY last_accessed DESC\r\n    `;\r\n\r\n    const result = await db.query(query, [userId]);\r\n    return result.rows.map(row => ({\r\n      id: row.id,\r\n      userId: row.user_id,\r\n      organizationId: row.organization_id,\r\n      token: '[HIDDEN]',\r\n      refreshToken: '[HIDDEN]',\r\n      expiresAt: row.expires_at,\r\n      createdAt: row.created_at,\r\n      lastAccessed: row.last_accessed,\r\n      ipAddress: row.ip_address,\r\n      userAgent: row.user_agent\r\n    }));\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const multiTenantAuth = new MultiTenantAuth();\r\n\r\n// Cleanup expired sessions every hour\r\nsetInterval(() => {\r\n  multiTenantAuth.cleanupExpiredSessions();\r\n}, 60 * 60 * 1000);\r\n\r\nexport default multiTenantAuth;\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\auth\\neon-auth-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":18,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":18,"endColumn":15},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":630,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":630,"endColumn":37},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":636,"column":20,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":636,"endColumn":37}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Neon Auth (Stack Auth) Service\n *\n * Production-ready authentication service integrating Stack Auth\n * with the MantisNXT role-based access control system.\n *\n * SECURITY ENHANCEMENTS:\n * - Real TOTP 2FA with rate limiting\n * - Strong password validation (12+ chars, complexity)\n * - Account lockout after 5 failed attempts\n * - No authentication bypasses\n * - PII encryption for sensitive data\n *\n * @module auth/neon-auth-service\n * @author AS Team (Auth & Security)\n */\n\n// @ts-nocheck\nimport { db } from '@/lib/database'\nimport { passwordSecurity } from '@/lib/security/password-security'\n\n// ============================================================================\n// TYPES AND INTERFACES\n// ============================================================================\n\nexport interface StackAuthUser {\n  id: string\n  email: string\n  emailVerified: boolean\n  displayName?: string\n  profileImageUrl?: string\n  provider: 'stack' | 'google' | 'github' | 'microsoft' | 'email'\n  createdAt: Date\n  lastSignInAt: Date\n}\n\nexport interface NeonAuthSession {\n  sessionToken: string\n  refreshToken?: string\n  expiresAt: Date\n  user: ExtendedUser\n}\n\nexport interface ExtendedUser {\n  id: string\n  stackAuthUserId: string\n  email: string\n  emailVerified: boolean\n  firstName?: string\n  lastName?: string\n  displayName: string\n  avatarUrl?: string\n  phone?: string\n  mobile?: string\n\n  // Organization\n  orgId: string\n  orgName: string\n  department?: string\n  jobTitle?: string\n\n  // Roles and permissions\n  roles: UserRole[]\n  permissions: UserPermission[]\n\n  // Status\n  isActive: boolean\n  isSuspended: boolean\n\n  // Security\n  twoFactorEnabled: boolean\n  lastLoginAt?: Date\n  lastActivityAt?: Date\n\n  // Preferences\n  preferences: UserPreferences\n}\n\nexport interface UserRole {\n  id: string\n  name: string\n  slug: string\n  description?: string\n  level: number\n}\n\nexport interface UserPermission {\n  id: string\n  name: string\n  resource: string\n  action: 'create' | 'read' | 'update' | 'delete' | 'manage' | 'execute'\n  conditions?: any[]\n}\n\nexport interface UserPreferences {\n  language: string\n  timezone: string\n  dateFormat: string\n  currency: string\n  theme: 'light' | 'dark' | 'auto'\n  notifications: {\n    email: boolean\n    sms: boolean\n    push: boolean\n    digestFrequency: 'realtime' | 'daily' | 'weekly' | 'never'\n  }\n}\n\nexport interface LoginOptions {\n  email: string\n  password: string\n  rememberMe?: boolean\n  twoFactorCode?: string\n}\n\nexport interface LoginResult {\n  success: boolean\n  session?: NeonAuthSession\n  requiresTwoFactor?: boolean\n  twoFactorToken?: string\n  error?: string\n  message?: string\n}\n\n// ============================================================================\n// NEON AUTH SERVICE CLASS\n// ============================================================================\n\nexport class NeonAuthService {\n  private stackAuthApiKey: string\n  private stackAuthProjectId: string\n\n  constructor() {\n    this.stackAuthApiKey = process.env.STACK_AUTH_API_KEY || ''\n    this.stackAuthProjectId = process.env.STACK_AUTH_PROJECT_ID || ''\n\n    if (!this.stackAuthApiKey || !this.stackAuthProjectId) {\n      console.warn('⚠️  Stack Auth credentials not configured. Using fallback mode.')\n    }\n  }\n\n  /**\n   * Authenticate user with email and password\n   */\n  async login(options: LoginOptions): Promise<LoginResult> {\n    try {\n      // Step 1: Get user ID for lockout check (before auth)\n      const userLookup = await db.query(`\n        SELECT id FROM auth.users_extended WHERE email = $1\n      `, [options.email])\n\n      if (userLookup.rows.length > 0) {\n        const userId = userLookup.rows[0].id\n\n        // Check for account lockout BEFORE authentication attempt\n        const lockStatus = await passwordSecurity.isAccountLocked(userId)\n        if (lockStatus.locked) {\n          await this.logLoginAttempt(options.email, false, 'ACCOUNT_LOCKED')\n          return {\n            success: false,\n            error: 'ACCOUNT_LOCKED',\n            message: lockStatus.reason || 'Account is locked'\n          }\n        }\n      }\n\n      // Step 2: Authenticate with Stack Auth\n      const stackAuthResult = await this.authenticateWithStackAuth(\n        options.email,\n        options.password\n      )\n\n      if (!stackAuthResult.success) {\n        // Record failed login attempt for lockout tracking\n        if (userLookup.rows.length > 0) {\n          const lockoutResult = await passwordSecurity.recordFailedLogin(userLookup.rows[0].id)\n\n          let message = 'Invalid email or password'\n          if (lockoutResult.locked) {\n            message = `Account locked due to too many failed attempts. Try again after ${lockoutResult.lockedUntil?.toLocaleTimeString()}`\n          } else if (lockoutResult.attemptsRemaining <= 2) {\n            message += `. Warning: ${lockoutResult.attemptsRemaining} attempts remaining before lockout.`\n          }\n\n          await this.logLoginAttempt(options.email, false, stackAuthResult.error)\n          return {\n            success: false,\n            error: stackAuthResult.error,\n            message\n          }\n        }\n\n        await this.logLoginAttempt(options.email, false, stackAuthResult.error)\n        return {\n          success: false,\n          error: stackAuthResult.error,\n          message: 'Invalid email or password'\n        }\n      }\n\n      // Step 3: Get or create extended user profile\n      const user = await this.getOrCreateExtendedUser(stackAuthResult.user!)\n\n      if (!user) {\n        return {\n          success: false,\n          error: 'USER_NOT_FOUND',\n          message: 'User account not found'\n        }\n      }\n\n      // Step 4: Check if user is active\n      if (!user.isActive || user.isSuspended) {\n        return {\n          success: false,\n          error: 'ACCOUNT_DISABLED',\n          message: 'Your account has been disabled. Please contact support.'\n        }\n      }\n\n      // Step 4: Check for 2FA requirement\n      if (user.twoFactorEnabled && !options.twoFactorCode) {\n        const twoFactorToken = await this.generateTwoFactorToken(user.id)\n\n        return {\n          success: false,\n          requiresTwoFactor: true,\n          twoFactorToken,\n          message: 'Two-factor authentication required'\n        }\n      }\n\n      // Step 5: Verify 2FA code if provided\n      if (user.twoFactorEnabled && options.twoFactorCode) {\n        const isValid = await this.verifyTwoFactorCode(user.id, options.twoFactorCode)\n\n        if (!isValid) {\n          return {\n            success: false,\n            error: 'INVALID_2FA_CODE',\n            message: 'Invalid verification code'\n          }\n        }\n      }\n\n      // Step 6: Reset failed login attempts on successful auth\n      await passwordSecurity.resetFailedLogins(user.id)\n\n      // Step 7: Create session\n      const session = await this.createSession(user, {\n        rememberMe: options.rememberMe\n      })\n\n      // Step 8: Update last login\n      await this.updateLastLogin(user.id)\n\n      // Step 9: Log successful login\n      await this.logLoginAttempt(options.email, true)\n\n      // Step 9: Log audit event\n      await this.logAuditEvent({\n        orgId: user.orgId,\n        userId: user.id,\n        eventType: 'login',\n        action: 'User logged in successfully',\n        metadata: {\n          twoFactorUsed: user.twoFactorEnabled\n        }\n      })\n\n      return {\n        success: true,\n        session,\n        message: 'Login successful'\n      }\n\n    } catch (error) {\n      console.error('Login error:', error)\n\n      return {\n        success: false,\n        error: 'LOGIN_ERROR',\n        message: 'An error occurred during login. Please try again.'\n      }\n    }\n  }\n\n  /**\n   * Verify session token and return user\n   */\n  async verifySession(sessionToken: string): Promise<ExtendedUser | null> {\n    try {\n      // Step 1: Verify token with Stack Auth\n      const isValidToken = await this.verifyStackAuthToken(sessionToken)\n\n      if (!isValidToken) {\n        return null\n      }\n\n      // Step 2: Get session from database\n      const sessionResult = await db.query(`\n        SELECT\n          s.user_id,\n          s.expires_at,\n          s.status,\n          s.last_activity_at\n        FROM auth.user_sessions s\n        WHERE s.session_token = $1\n          AND s.status = 'active'\n          AND s.expires_at > NOW()\n      `, [sessionToken])\n\n      if (sessionResult.rows.length === 0) {\n        return null\n      }\n\n      const session = sessionResult.rows[0]\n\n      // Step 3: Get extended user with roles and permissions\n      const user = await this.getExtendedUser(session.user_id)\n\n      if (!user || !user.isActive || user.isSuspended) {\n        return null\n      }\n\n      // Step 4: Update last activity\n      await this.updateSessionActivity(sessionToken)\n\n      return user\n\n    } catch (error) {\n      console.error('Session verification error:', error)\n      return null\n    }\n  }\n\n  /**\n   * Logout user and revoke session\n   */\n  async logout(sessionToken: string): Promise<void> {\n    try {\n      // Step 1: Revoke session in database\n      await db.query(`\n        UPDATE auth.user_sessions\n        SET\n          status = 'revoked',\n          revoked_at = NOW()\n        WHERE session_token = $1\n      `, [sessionToken])\n\n      // Step 2: Revoke with Stack Auth\n      await this.revokeStackAuthSession(sessionToken)\n\n      // Step 3: Log audit event\n      const session = await this.getSessionByToken(sessionToken)\n      if (session) {\n        await this.logAuditEvent({\n          orgId: session.orgId,\n          userId: session.userId,\n          eventType: 'logout',\n          action: 'User logged out',\n          metadata: {}\n        })\n      }\n\n    } catch (error) {\n      console.error('Logout error:', error)\n      throw error\n    }\n  }\n\n  /**\n   * Get extended user with roles and permissions\n   */\n  async getExtendedUser(userId: string): Promise<ExtendedUser | null> {\n    try {\n      const result = await db.query(`\n        SELECT\n          u.id,\n          u.stack_auth_user_id,\n          u.email,\n          u.email_verified,\n          u.first_name,\n          u.last_name,\n          u.display_name,\n          u.avatar_url,\n          u.phone,\n          u.mobile,\n          u.org_id,\n          o.name as org_name,\n          u.department,\n          u.job_title,\n          u.is_active,\n          u.is_suspended,\n          u.two_factor_enabled,\n          u.last_login_at,\n          u.last_activity_at,\n\n          -- Get preferences\n          COALESCE(\n            jsonb_build_object(\n              'language', p.language,\n              'timezone', p.timezone,\n              'dateFormat', p.date_format,\n              'currency', p.currency,\n              'theme', p.theme,\n              'notifications', jsonb_build_object(\n                'email', p.email_notifications,\n                'sms', p.sms_notifications,\n                'push', p.push_notifications,\n                'digestFrequency', p.notification_digest_frequency\n              )\n            ),\n            '{}'::jsonb\n          ) as preferences,\n\n          -- Get roles as array\n          COALESCE(\n            array_agg(DISTINCT jsonb_build_object(\n              'id', r.id,\n              'name', r.name,\n              'slug', r.slug,\n              'description', r.description,\n              'level', r.role_level\n            )) FILTER (WHERE r.id IS NOT NULL),\n            ARRAY[]::jsonb[]\n          ) as roles,\n\n          -- Get permissions as array\n          COALESCE(\n            array_agg(DISTINCT jsonb_build_object(\n              'id', perm.id,\n              'name', perm.name,\n              'resource', perm.resource,\n              'action', perm.action,\n              'conditions', perm.conditions\n            )) FILTER (WHERE perm.id IS NOT NULL),\n            ARRAY[]::jsonb[]\n          ) as permissions\n\n        FROM auth.users_extended u\n        JOIN organization o ON u.org_id = o.id\n        LEFT JOIN auth.user_preferences p ON u.id = p.user_id\n        LEFT JOIN auth.user_roles ur ON u.id = ur.user_id\n          AND (ur.effective_until IS NULL OR ur.effective_until > NOW())\n        LEFT JOIN auth.roles r ON ur.role_id = r.id AND r.is_active = TRUE\n        LEFT JOIN auth.role_permissions rp ON r.id = rp.role_id\n        LEFT JOIN auth.permissions perm ON rp.permission_id = perm.id\n        WHERE u.id = $1\n        GROUP BY u.id, o.id, o.name, p.language, p.timezone, p.date_format,\n                 p.currency, p.theme, p.email_notifications, p.sms_notifications,\n                 p.push_notifications, p.notification_digest_frequency\n      `, [userId])\n\n      if (result.rows.length === 0) {\n        return null\n      }\n\n      const row = result.rows[0]\n\n      return {\n        id: row.id,\n        stackAuthUserId: row.stack_auth_user_id,\n        email: row.email,\n        emailVerified: row.email_verified,\n        firstName: row.first_name,\n        lastName: row.last_name,\n        displayName: row.display_name,\n        avatarUrl: row.avatar_url,\n        phone: row.phone,\n        mobile: row.mobile,\n        orgId: row.org_id,\n        orgName: row.org_name,\n        department: row.department,\n        jobTitle: row.job_title,\n        roles: row.roles || [],\n        permissions: row.permissions || [],\n        isActive: row.is_active,\n        isSuspended: row.is_suspended,\n        twoFactorEnabled: row.two_factor_enabled,\n        lastLoginAt: row.last_login_at,\n        lastActivityAt: row.last_activity_at,\n        preferences: row.preferences || this.getDefaultPreferences()\n      }\n\n    } catch (error) {\n      console.error('Get extended user error:', error)\n      return null\n    }\n  }\n\n  // ============================================================================\n  // PRIVATE HELPER METHODS\n  // ============================================================================\n\n  private async authenticateWithStackAuth(\n    email: string,\n    password: string\n  ): Promise<{ success: boolean; user?: StackAuthUser; error?: string }> {\n    // SECURITY FIX: Removed DISABLE_AUTH bypass - all authentication must go through proper channels\n\n    if (!this.stackAuthApiKey || !this.stackAuthProjectId) {\n      return {\n        success: false,\n        error: 'Authentication service not configured'\n      }\n    }\n\n    try {\n      // Real Stack Auth API call\n      const response = await fetch('https://api.stack-auth.com/v1/auth/signin', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'X-API-Key': this.stackAuthApiKey,\n          'X-Project-Id': this.stackAuthProjectId\n        },\n        body: JSON.stringify({ email, password })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        return {\n          success: false,\n          error: errorData.message || 'Authentication failed'\n        }\n      }\n\n      const data = await response.json()\n\n      return {\n        success: true,\n        user: {\n          id: data.user.id,\n          email: data.user.email,\n          emailVerified: data.user.emailVerified || false,\n          displayName: data.user.displayName,\n          profileImageUrl: data.user.profileImageUrl,\n          provider: data.user.provider || 'email',\n          createdAt: new Date(data.user.createdAt),\n          lastSignInAt: new Date()\n        }\n      }\n    } catch (error) {\n      console.error('Stack Auth error:', error)\n      return {\n        success: false,\n        error: 'Authentication service unavailable'\n      }\n    }\n  }\n\n  private async verifyStackAuthToken(token: string): Promise<boolean> {\n    // SECURITY FIX: Removed DISABLE_AUTH bypass - implement real token verification\n\n    if (!this.stackAuthApiKey || !this.stackAuthProjectId) {\n      return false\n    }\n\n    try {\n      const response = await fetch('https://api.stack-auth.com/v1/auth/verify', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'X-API-Key': this.stackAuthApiKey,\n          'X-Project-Id': this.stackAuthProjectId\n        },\n        body: JSON.stringify({ token })\n      })\n\n      return response.ok\n    } catch (error) {\n      console.error('Token verification error:', error)\n      return false\n    }\n  }\n\n  private async revokeStackAuthSession(sessionToken: string): Promise<void> {\n    // TODO: Implement Stack Auth session revocation\n  }\n\n  private async getOrCreateExtendedUser(stackUser: StackAuthUser): Promise<ExtendedUser | null> {\n    // Check if user exists\n    const user = await db.query(`\n      SELECT id FROM auth.users_extended\n      WHERE stack_auth_user_id = $1\n    `, [stackUser.id])\n\n    if (user.rows.length === 0) {\n      // Create new extended user\n      // This would typically happen during first login after Stack Auth signup\n\n      // For now, return null and require manual user provisioning\n      return null\n    }\n\n    return this.getExtendedUser(user.rows[0].id)\n  }\n\n  private async createSession(\n    user: ExtendedUser,\n    options: { rememberMe?: boolean }\n  ): Promise<NeonAuthSession> {\n    const sessionToken = this.generateSessionToken()\n    const expiresAt = new Date()\n\n    // Remember me: 30 days, otherwise 1 day\n    if (options.rememberMe) {\n      expiresAt.setDate(expiresAt.getDate() + 30)\n    } else {\n      expiresAt.setDate(expiresAt.getDate() + 1)\n    }\n\n    await db.query(`\n      INSERT INTO auth.user_sessions (\n        user_id, session_token, expires_at, ip_address, user_agent, status\n      )\n      VALUES ($1, $2, $3, $4, $5, 'active')\n    `, [user.id, sessionToken, expiresAt, '0.0.0.0', 'unknown'])\n\n    return {\n      sessionToken,\n      expiresAt,\n      user\n    }\n  }\n\n  private generateSessionToken(): string {\n    // Generate cryptographically secure random token\n    const crypto = require('crypto')\n    return crypto.randomBytes(32).toString('hex')\n  }\n\n  private async generateTwoFactorToken(userId: string): Promise<string> {\n    // Generate temporary 2FA token\n    const crypto = require('crypto')\n    return crypto.randomBytes(16).toString('hex')\n  }\n\n  private async verifyTwoFactorCode(userId: string, code: string): Promise<boolean> {\n    // SECURITY FIX: Implement real TOTP verification with rate limiting\n    const { totpService } = await import('@/lib/security/totp-service')\n\n    const result = await totpService.verify(userId, code)\n    return result.valid\n  }\n\n  private async updateLastLogin(userId: string): Promise<void> {\n    await db.query(`\n      UPDATE auth.users_extended\n      SET\n        last_login_at = NOW(),\n        last_activity_at = NOW()\n      WHERE id = $1\n    `, [userId])\n  }\n\n  private async updateSessionActivity(sessionToken: string): Promise<void> {\n    await db.query(`\n      UPDATE auth.user_sessions\n      SET last_activity_at = NOW()\n      WHERE session_token = $1\n    `, [sessionToken])\n  }\n\n  private async logLoginAttempt(\n    email: string,\n    success: boolean,\n    failureReason?: string\n  ): Promise<void> {\n    const userResult = await db.query(`\n      SELECT id FROM auth.users_extended WHERE email = $1\n    `, [email])\n\n    const userId = userResult.rows.length > 0 ? userResult.rows[0].id : null\n\n    await db.query(`\n      INSERT INTO auth.login_history (\n        user_id, email, success, failure_reason, ip_address, user_agent\n      )\n      VALUES ($1, $2, $3, $4, $5, $6)\n    `, [userId, email, success, failureReason, '0.0.0.0', 'unknown'])\n  }\n\n  private async logAuditEvent(params: {\n    orgId: string\n    userId: string\n    eventType: string\n    action: string\n    metadata?: any\n  }): Promise<void> {\n    await db.query(`\n      INSERT INTO auth.audit_events (\n        org_id, user_id, event_type, action, metadata\n      )\n      VALUES ($1, $2, $3::audit_event_type, $4, $5)\n    `, [params.orgId, params.userId, params.eventType, params.action, JSON.stringify(params.metadata || {})])\n  }\n\n  private async getSessionByToken(sessionToken: string): Promise<any> {\n    const result = await db.query(`\n      SELECT\n        s.user_id,\n        u.org_id\n      FROM auth.user_sessions s\n      JOIN auth.users_extended u ON s.user_id = u.id\n      WHERE s.session_token = $1\n    `, [sessionToken])\n\n    return result.rows.length > 0 ? result.rows[0] : null\n  }\n\n  private getDefaultPreferences(): UserPreferences {\n    return {\n      language: 'en',\n      timezone: 'Africa/Johannesburg',\n      dateFormat: 'dd/mm/yyyy',\n      currency: 'ZAR',\n      theme: 'light',\n      notifications: {\n        email: true,\n        sms: false,\n        push: true,\n        digestFrequency: 'daily'\n      }\n    }\n  }\n}\n\n// ============================================================================\n// SINGLETON EXPORT\n// ============================================================================\n\nexport const neonAuthService = new NeonAuthService()\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\cache\\feature-flags.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":169,"column":9,"nodeType":"Identifier","messageId":"undef","endLine":169,"endColumn":21},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":185,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":185,"endColumn":36}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ITERATION 2 - ADR-1: Cache Rollout Feature Flags\r\n *\r\n * Feature flags for gradual cache rollout.\r\n * Allows per-endpoint enable/disable for safe rollout and rollback.\r\n */\r\n\r\n/**\r\n * Feature flag configuration\r\n */\r\nexport interface CacheFeatureFlags {\r\n  // Global cache enable/disable\r\n  cacheEnabled: boolean;\r\n\r\n  // Phase 1 endpoints (Week 1-2)\r\n  dashboardMetricsCache: boolean;\r\n  inventoryListCache: boolean;\r\n  analyticsOverviewCache: boolean;\r\n\r\n  // Phase 2 endpoints (Week 3-4) - Future\r\n  supplierListCache: boolean;\r\n  supplierDetailsCache: boolean;\r\n  inventoryDetailsCache: boolean;\r\n\r\n  // Phase 3 endpoints (Week 5-6) - Future\r\n  stockMovementsCache: boolean;\r\n  purchaseOrdersCache: boolean;\r\n  analyticsReportsCache: boolean;\r\n\r\n  // Advanced features\r\n  prefetchEnabled: boolean;\r\n  backgroundRefetchEnabled: boolean;\r\n  optimisticUpdatesEnabled: boolean;\r\n\r\n  // Performance settings\r\n  enablePerformanceMonitoring: boolean;\r\n  logCacheHits: boolean;\r\n  logCacheMisses: boolean;\r\n}\r\n\r\n/**\r\n * Default feature flags for Phase 1 rollout\r\n */\r\nconst DEFAULT_FLAGS: CacheFeatureFlags = {\r\n  cacheEnabled: true,\r\n\r\n  // Phase 1 - ENABLED\r\n  dashboardMetricsCache: true,\r\n  inventoryListCache: true,\r\n  analyticsOverviewCache: true,\r\n\r\n  // Phase 2 - DISABLED (not yet rolled out)\r\n  supplierListCache: false,\r\n  supplierDetailsCache: false,\r\n  inventoryDetailsCache: false,\r\n\r\n  // Phase 3 - DISABLED (not yet rolled out)\r\n  stockMovementsCache: false,\r\n  purchaseOrdersCache: false,\r\n  analyticsReportsCache: false,\r\n\r\n  // Advanced features - ENABLED for development\r\n  prefetchEnabled: process.env.NODE_ENV === 'development',\r\n  backgroundRefetchEnabled: true,\r\n  optimisticUpdatesEnabled: false, // Conservative default\r\n\r\n  // Performance monitoring - ENABLED in development\r\n  enablePerformanceMonitoring: process.env.NODE_ENV === 'development',\r\n  logCacheHits: process.env.NODE_ENV === 'development',\r\n  logCacheMisses: process.env.NODE_ENV === 'development',\r\n};\r\n\r\n/**\r\n * Feature flag manager\r\n */\r\nclass FeatureFlagManager {\r\n  private flags: CacheFeatureFlags;\r\n  private listeners: Array<(flags: CacheFeatureFlags) => void> = [];\r\n\r\n  constructor(initialFlags: CacheFeatureFlags = DEFAULT_FLAGS) {\r\n    this.flags = { ...initialFlags };\r\n\r\n    // Load flags from localStorage if available\r\n    if (typeof window !== 'undefined') {\r\n      this.loadFromStorage();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current flags\r\n   */\r\n  getFlags(): CacheFeatureFlags {\r\n    return { ...this.flags };\r\n  }\r\n\r\n  /**\r\n   * Get specific flag value\r\n   */\r\n  getFlag<K extends keyof CacheFeatureFlags>(key: K): CacheFeatureFlags[K] {\r\n    return this.flags[key];\r\n  }\r\n\r\n  /**\r\n   * Set specific flag value\r\n   */\r\n  setFlag<K extends keyof CacheFeatureFlags>(\r\n    key: K,\r\n    value: CacheFeatureFlags[K]\r\n  ): void {\r\n    this.flags[key] = value;\r\n    this.saveToStorage();\r\n    this.notifyListeners();\r\n  }\r\n\r\n  /**\r\n   * Update multiple flags\r\n   */\r\n  updateFlags(updates: Partial<CacheFeatureFlags>): void {\r\n    this.flags = { ...this.flags, ...updates };\r\n    this.saveToStorage();\r\n    this.notifyListeners();\r\n  }\r\n\r\n  /**\r\n   * Reset to default flags\r\n   */\r\n  resetToDefaults(): void {\r\n    this.flags = { ...DEFAULT_FLAGS };\r\n    this.saveToStorage();\r\n    this.notifyListeners();\r\n  }\r\n\r\n  /**\r\n   * Check if cache is enabled for a specific endpoint\r\n   */\r\n  isCacheEnabled(endpoint: keyof CacheFeatureFlags): boolean {\r\n    return this.flags.cacheEnabled && Boolean(this.flags[endpoint]);\r\n  }\r\n\r\n  /**\r\n   * Subscribe to flag changes\r\n   */\r\n  subscribe(listener: (flags: CacheFeatureFlags) => void): () => void {\r\n    this.listeners.push(listener);\r\n    return () => {\r\n      this.listeners = this.listeners.filter((l) => l !== listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify all listeners of flag changes\r\n   */\r\n  private notifyListeners(): void {\r\n    this.listeners.forEach((listener) => {\r\n      try {\r\n        listener(this.getFlags());\r\n      } catch (error) {\r\n        console.error('[FeatureFlags] Error in listener:', error);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Save flags to localStorage\r\n   */\r\n  private saveToStorage(): void {\r\n    if (typeof window !== 'undefined') {\r\n      try {\r\n        localStorage.setItem(\r\n          'cache_feature_flags',\r\n          JSON.stringify(this.flags)\r\n        );\r\n      } catch (error) {\r\n        console.error('[FeatureFlags] Error saving to storage:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Load flags from localStorage\r\n   */\r\n  private loadFromStorage(): void {\r\n    if (typeof window !== 'undefined') {\r\n      try {\r\n        const stored = localStorage.getItem('cache_feature_flags');\r\n        if (stored) {\r\n          const parsed = JSON.parse(stored);\r\n          this.flags = { ...DEFAULT_FLAGS, ...parsed };\r\n        }\r\n      } catch (error) {\r\n        console.error('[FeatureFlags] Error loading from storage:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Export flags for debugging\r\n   */\r\n  exportFlags(): string {\r\n    return JSON.stringify(this.flags, null, 2);\r\n  }\r\n\r\n  /**\r\n   * Import flags from JSON\r\n   */\r\n  importFlags(json: string): void {\r\n    try {\r\n      const parsed = JSON.parse(json);\r\n      this.updateFlags(parsed);\r\n    } catch (error) {\r\n      console.error('[FeatureFlags] Error importing flags:', error);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Global feature flag manager instance\r\n */\r\nexport const featureFlagManager = new FeatureFlagManager();\r\n\r\n/**\r\n * Convenience functions for common checks\r\n */\r\nexport const isPhase1CacheEnabled = () =>\r\n  featureFlagManager.getFlag('cacheEnabled') &&\r\n  (featureFlagManager.getFlag('dashboardMetricsCache') ||\r\n    featureFlagManager.getFlag('inventoryListCache') ||\r\n    featureFlagManager.getFlag('analyticsOverviewCache'));\r\n\r\nexport const isDashboardCacheEnabled = () =>\r\n  featureFlagManager.isCacheEnabled('dashboardMetricsCache');\r\n\r\nexport const isInventoryCacheEnabled = () =>\r\n  featureFlagManager.isCacheEnabled('inventoryListCache');\r\n\r\nexport const isAnalyticsCacheEnabled = () =>\r\n  featureFlagManager.isCacheEnabled('analyticsOverviewCache');\r\n\r\n/**\r\n * Rollback helper - disable all Phase 1 caches\r\n */\r\nexport function rollbackPhase1Cache(): void {\r\n  featureFlagManager.updateFlags({\r\n    dashboardMetricsCache: false,\r\n    inventoryListCache: false,\r\n    analyticsOverviewCache: false,\r\n  });\r\n  console.log('[FeatureFlags] Phase 1 cache rolled back');\r\n}\r\n\r\n/**\r\n * Rollout helper - enable all Phase 1 caches\r\n */\r\nexport function enablePhase1Cache(): void {\r\n  featureFlagManager.updateFlags({\r\n    dashboardMetricsCache: true,\r\n    inventoryListCache: true,\r\n    analyticsOverviewCache: true,\r\n  });\r\n  console.log('[FeatureFlags] Phase 1 cache enabled');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\cmm\\db-sql.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":172,"column":17,"nodeType":"TemplateLiteral","endLine":175,"endColumn":6}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { query } from \"@/lib/database\"\r\nimport { executeSupplierRules } from \"./supplier-rules-engine\"\r\nimport type { Product, Tag } from \"./types\"\r\n\r\n// Utilities\r\nfunction slugifyId(name: string) {\r\n  return `tag-${name.toLowerCase().replace(/\\s+/g, \"-\")}`\r\n}\r\n\r\n// Core data access\r\nexport async function getProduct(sku: string) {\r\n  const result = await query<Product & { tags?: string[] }>(`\r\n    select p.sku, p.supplier_id as \"supplierId\", p.category_id as \"categoryId\",\r\n           p.description, p.brand, p.series_range as \"seriesRange\", p.price, p.stock_type as \"stockType\", p.image_url as \"imageUrl\",\r\n           coalesce(array_agg(ta.tag_id) filter (where ta.tag_id is not null), '{}') as tags\r\n    from products p\r\n    left join tag_assignments ta on ta.sku = p.sku\r\n    where p.sku = $1\r\n    group by p.sku\r\n  `, [sku])\r\n  return result.rows[0]\r\n}\r\n\r\nexport async function getProducts({\r\n  uncategorized = false,\r\n}: { uncategorized?: boolean } = {}) {\r\n  const sqlQuery = uncategorized\r\n    ? `\r\n    select p.sku, p.description, p.brand, p.series_range as \"seriesRange\", p.category_id as \"categoryId\",\r\n           coalesce(array_agg(ta.tag_id) filter (where ta.tag_id is not null), '{}') as tags\r\n    from products p\r\n    left join tag_assignments ta on ta.sku = p.sku\r\n    where p.category_id is null\r\n    group by p.sku\r\n    order by p.sku\r\n  `\r\n    : `\r\n    select p.sku, p.description, p.brand, p.series_range as \"seriesRange\", p.category_id as \"categoryId\",\r\n           coalesce(array_agg(ta.tag_id) filter (where ta.tag_id is not null), '{}') as tags\r\n    from products p\r\n    left join tag_assignments ta on ta.sku = p.sku\r\n    group by p.sku\r\n    order by p.sku\r\n  `\r\n  const result = await query<{\r\n    sku: string\r\n    description: string\r\n    brand?: string\r\n    seriesRange?: string\r\n    categoryId: string | null\r\n    tags: string[]\r\n  }>(sqlQuery)\r\n  return result.rows\r\n}\r\n\r\nexport async function getCategories() {\r\n  const result = await query<{ id: string; name: string; parentId: string | null; path: string }>(`\r\n    select id, name, parent_id as \"parentId\", path from categories order by path\r\n  `)\r\n  return result.rows\r\n}\r\n\r\nexport async function addTag(name: string, type?: Tag[\"type\"]) {\r\n  const id = slugifyId(name)\r\n  await query(`\r\n    insert into tags (id, name, type) values ($1, $2, $3)\r\n    on conflict (id) do update set name = excluded.name, type = excluded.type\r\n  `, [id, name, type ?? \"custom\"])\r\n  const result = await query<Tag>(`select id, name, type from tags where id = $1`, [id])\r\n  return result.rows[0]\r\n}\r\n\r\nexport async function listTags() {\r\n  const result = await query<Tag>(`select id, name, type from tags order by name`)\r\n  return result.rows\r\n}\r\n\r\nexport async function assignTag(sku: string, tagId: string) {\r\n  await query(`\r\n    insert into tag_assignments (sku, tag_id) values ($1, $2)\r\n    on conflict (sku, tag_id) do nothing\r\n  `, [sku, tagId])\r\n}\r\n\r\nexport async function removeTag(sku: string, tagId: string) {\r\n  await query(`delete from tag_assignments where sku = $1 and tag_id = $2`, [sku, tagId])\r\n}\r\n\r\nexport async function upsertProductAttributes(\r\n  p: Partial<Product> & { sku: string; supplierId?: string },\r\n  context?: { approved_by?: string; approver_role?: string }\r\n) {\r\n  const sku = p.sku\r\n\r\n  // Execute supplier rules if supplierId is provided\r\n  if (p.supplierId) {\r\n    // Extract cost from attributes if available\r\n    const cost =\r\n      (p.attributes as any)?.cost ||\r\n      (p.attributes as any)?.dealerPrice ||\r\n      undefined\r\n\r\n    const ruleData = {\r\n      sku: p.sku,\r\n      supplierId: p.supplierId,\r\n      description: p.description,\r\n      brand: p.brand,\r\n      seriesRange: p.seriesRange,\r\n      price: p.price,\r\n      cost,\r\n      stockType: p.stockType,\r\n      imageUrl: p.imageUrl,\r\n      attributes: p.attributes,\r\n    }\r\n\r\n    const ruleResult = await executeSupplierRules(\r\n      p.supplierId,\r\n      \"upsert\",\r\n      ruleData,\r\n      context\r\n    )\r\n\r\n    // If blocked by rules, return error\r\n    if (ruleResult.blocked) {\r\n      return {\r\n        inserted: false,\r\n        updated: false,\r\n        conflict: {\r\n          sku,\r\n          type: \"rule_blocked\",\r\n          message: ruleResult.errors.join(\"; \"),\r\n        },\r\n      }\r\n    }\r\n\r\n    // Apply transformations from rules\r\n    if (ruleResult.transformedData) {\r\n      Object.assign(p, ruleResult.transformedData)\r\n    }\r\n  }\r\n\r\n  const existingResult = await query<{\r\n    sku: string\r\n    supplierId: string\r\n    description: string | null\r\n    brand: string | null\r\n    seriesRange: string | null\r\n    price: number | null\r\n    stockType: string | null\r\n    imageUrl: string | null\r\n    attributes: any | null\r\n  }>(`\r\n    select sku,\r\n           supplier_id as \"supplierId\",\r\n           description,\r\n           brand,\r\n           series_range as \"seriesRange\",\r\n           price,\r\n           stock_type as \"stockType\",\r\n           image_url as \"imageUrl\",\r\n           attributes\r\n    from products\r\n    where sku = $1\r\n  `, [sku])\r\n  const existing = existingResult.rows\r\n  const attrs = p.attributes ? JSON.stringify(p.attributes) : null\r\n\r\n  if (existing.length === 0) {\r\n    if (!p.supplierId) throw new Error(\"supplierId required for new product\")\r\n\r\n    // ensure supplier exists\r\n    await query(`\r\n      insert into suppliers (id, name) values ($1, $2)\r\n      on conflict (id) do nothing\r\n    `, [p.supplierId, p.supplierId])\r\n\r\n    await query(`\r\n      insert into products (sku, supplier_id, category_id, description, brand, series_range, price, stock_type, image_url, attributes, updated_at)\r\n      values ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10::jsonb, now())\r\n    `, [\r\n      sku,\r\n      p.supplierId,\r\n      p.categoryId ?? null,\r\n      p.description ?? \"\",\r\n      p.brand ?? null,\r\n      p.seriesRange ?? null,\r\n      p.price ?? null,\r\n      p.stockType ?? null,\r\n      p.imageUrl ?? null,\r\n      attrs,\r\n    ])\r\n    return { inserted: true, updated: false as const }\r\n  } else {\r\n    const exists = existing[0]\r\n\r\n    // Immutable supplier enforcement\r\n    if (p.supplierId && p.supplierId !== exists.supplierId) {\r\n      const details = JSON.stringify({\r\n        existingSupplier: exists.supplierId,\r\n        attemptedSupplier: p.supplierId,\r\n      })\r\n      await query(`\r\n        insert into conflicts (sku, type, message, details, reported_at)\r\n        values ($1, 'duplicate', 'SKU already exists from a different supplier. New SKU required.', $2::jsonb, now())\r\n      `, [sku, details])\r\n      return {\r\n        inserted: false,\r\n        updated: false,\r\n        conflict: {\r\n          sku,\r\n          type: \"duplicate\",\r\n          message:\r\n            \"SKU already exists from a different supplier. New SKU required.\",\r\n        },\r\n      }\r\n    }\r\n\r\n    // Core field immutability for existing SKUs: differences are conflicts, not updates\r\n    const coreChanges: Record<string, { existing: any; attempted: any }> = {}\r\n    const compare = (\r\n      field: \"description\" | \"price\" | \"stockType\" | \"imageUrl\",\r\n      attempted: any\r\n    ) => {\r\n      // only compare if provided on import\r\n      if (attempted === undefined || attempted === null || attempted === \"\")\r\n        return\r\n      const ex = (exists as any)[field]\r\n      const same =\r\n        field === \"price\"\r\n          ? Number(ex ?? null) === Number(attempted)\r\n          : String(ex ?? \"\").trim() === String(attempted ?? \"\").trim()\r\n      if (!same) {\r\n        coreChanges[field] = { existing: ex, attempted }\r\n      }\r\n    }\r\n\r\n    compare(\"description\", p.description)\r\n    compare(\"price\", p.price as any)\r\n    compare(\"stockType\", p.stockType as any)\r\n    compare(\"imageUrl\", p.imageUrl)\r\n\r\n    let hadConflict = false\r\n    if (Object.keys(coreChanges).length > 0) {\r\n      const details = JSON.stringify({\r\n        policy: \"immutable-core-fields\",\r\n        fieldChanges: coreChanges,\r\n      })\r\n      await query(`\r\n        insert into conflicts (sku, type, message, details, reported_at)\r\n        values ($1, 'data_mismatch', 'Existing SKU has immutable core fields that differ. Attributes-only updates allowed.', $2::jsonb, now())\r\n      `, [sku, details])\r\n      hadConflict = true\r\n    }\r\n\r\n    // Merge attributes and update brand/series_range if provided\r\n    let attributesUpdated = false\r\n\r\n    if (attrs) {\r\n      await query(`\r\n        update products\r\n        set attributes = coalesce(attributes, '{}'::jsonb) || $1::jsonb,\r\n            updated_at = now()\r\n        where sku = $2\r\n      `, [attrs, sku])\r\n      attributesUpdated = true\r\n    }\r\n\r\n    if (p.brand !== undefined) {\r\n      await query(`\r\n        update products\r\n        set brand = $1,\r\n            updated_at = now()\r\n        where sku = $2\r\n      `, [p.brand ?? null, sku])\r\n      attributesUpdated = true\r\n    }\r\n\r\n    if (p.seriesRange !== undefined) {\r\n      await query(`\r\n        update products\r\n        set series_range = $1,\r\n            updated_at = now()\r\n        where sku = $2\r\n      `, [p.seriesRange ?? null, sku])\r\n      attributesUpdated = true\r\n    }\r\n\r\n    return {\r\n      inserted: false,\r\n      updated: attributesUpdated, // true only if attributes merged\r\n      ...(hadConflict\r\n        ? {\r\n            conflict: {\r\n              sku,\r\n              type: \"data_mismatch\",\r\n              message:\r\n                \"Existing SKU has immutable core fields that differ. Attributes-only updates allowed; differences recorded.\",\r\n            },\r\n          }\r\n        : {}),\r\n    }\r\n  }\r\n}\r\n\r\nexport async function assignCategory(sku: string, categoryId: string) {\r\n  const catCheck = await query(`select 1 from categories where id = $1`, [categoryId])\r\n  if (catCheck.rows.length === 0) throw new Error(\"Category not found\")\r\n  const prodCheck = await query(`select 1 from products where sku = $1`, [sku])\r\n  if (prodCheck.rows.length === 0) throw new Error(\"Product not found\")\r\n  await query(`update products set category_id = $1, updated_at = now() where sku = $2`, [categoryId, sku])\r\n}\r\n\r\nexport async function uncategorizedProducts() {\r\n  const result = await query<Product>(`\r\n    select sku, supplier_id as \"supplierId\", category_id as \"categoryId\",\r\n           description, brand, series_range as \"seriesRange\", price, stock_type as \"stockType\", image_url as \"imageUrl\",\r\n           coalesce(attributes, '{}'::jsonb) as attributes,\r\n           extract(epoch from updated_at) * 1000 as \"updatedAt\",\r\n           '{}'::text[] as tags\r\n    from products\r\n    where category_id is null\r\n    order by sku\r\n  `)\r\n  return result.rows\r\n}\r\n\r\nexport function suggestCategory(\r\n  p: Product\r\n): { categoryId: string; categoryName: string; confidence: number } | null {\r\n  const d = (p.description || \"\").toLowerCase()\r\n  if (d.includes(\"jacket\") || d.includes(\"coat\"))\r\n    return {\r\n      categoryId: \"cat-002\",\r\n      categoryName: \"Outerwear\",\r\n      confidence: 0.86,\r\n    }\r\n  if (d.includes(\"shoe\") || d.includes(\"sneaker\") || d.includes(\"running\"))\r\n    return { categoryId: \"cat-003\", categoryName: \"Footwear\", confidence: 0.9 }\r\n  if (d.includes(\"scarf\") || d.includes(\"belt\") || d.includes(\"hat\"))\r\n    return {\r\n      categoryId: \"cat-004\",\r\n      categoryName: \"Accessories\",\r\n      confidence: 0.8,\r\n    }\r\n  if (d.includes(\"apparel\") || d.includes(\"tshirt\") || d.includes(\"shirt\"))\r\n    return { categoryId: \"cat-001\", categoryName: \"Apparel\", confidence: 0.7 }\r\n  return null\r\n}\r\n\r\nexport function predictiveTags(p: Product): string[] {\r\n  const d = (p.description || \"\").toLowerCase()\r\n  const res: string[] = []\r\n  const month = new Date().getMonth()\r\n  if ([5, 6, 7].includes(month) || d.includes(\"summer\") || d.includes(\"beach\"))\r\n    res.push(\"tag-summer\")\r\n  if (d.includes(\"wool\") || d.includes(\"winter\") || [11, 0, 1].includes(month))\r\n    res.push(\"tag-winter\")\r\n  if (p.stockType === \"preorder\") res.push(\"tag-preorder\")\r\n  if (p.stockType === \"stock\") res.push(\"tag-stock\")\r\n  return Array.from(new Set(res))\r\n}\r\n\r\n// Rules\r\nexport async function addRuleKeyword(keyword: string, tagId: string) {\r\n  const id = `rule-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`\r\n  await query(`\r\n    insert into rules (id, kind, keyword, tag_id)\r\n    values ($1, 'keyword', $2, $3)\r\n  `, [id, keyword, tagId])\r\n  return { id, kind: \"keyword\" as const, keyword, tagId }\r\n}\r\n\r\nexport async function listRules() {\r\n  const result = await query<{\r\n    id: string\r\n    kind: string\r\n    keyword: string\r\n    tagId: string\r\n    tagName: string\r\n  }>(`\r\n    select r.id, r.kind, r.keyword, r.tag_id as \"tagId\", t.name as \"tagName\"\r\n    from rules r\r\n    left join tags t on t.id = r.tag_id\r\n    order by r.id\r\n  `)\r\n  return result.rows\r\n}\r\n\r\nexport async function applyRules() {\r\n  const productsResult = await query<Product>(`\r\n    select sku, supplier_id as \"supplierId\", category_id as \"categoryId\",\r\n           description, brand, series_range as \"seriesRange\", price, stock_type as \"stockType\", image_url as \"imageUrl\",\r\n           coalesce(attributes, '{}'::jsonb) as attributes,\r\n           extract(epoch from updated_at) * 1000 as \"updatedAt\"\r\n    from products\r\n  `)\r\n  const products = productsResult.rows\r\n  const rulesResult = await query<{ keyword: string; tagId: string }>(`\r\n    select keyword, tag_id as \"tagId\" from rules where kind = 'keyword'\r\n  `)\r\n  const rules = rulesResult.rows\r\n  for (const p of products) {\r\n    for (const r of rules) {\r\n      if (\r\n        (p.description || \"\").toLowerCase().includes(r.keyword.toLowerCase())\r\n      ) {\r\n        await assignTag(p.sku, r.tagId)\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Upload history\r\nexport async function recordUpload(params: {\r\n  supplierId: string\r\n  source: \"file\" | \"text\" | \"api\"\r\n  filename?: string\r\n  mapping: Record<string, any>\r\n  results: {\r\n    sku: string\r\n    outcome: \"inserted\" | \"updated\" | \"conflict\"\r\n    message?: string\r\n  }[]\r\n}) {\r\n  const id = `upl-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`\r\n  const inserted = params.results.filter(\r\n    (r) => r.outcome === \"inserted\"\r\n  ).length\r\n  const updated = params.results.filter((r) => r.outcome === \"updated\").length\r\n  const conflictCount = params.results.filter(\r\n    (r) => r.outcome === \"conflict\"\r\n  ).length\r\n\r\n  await query(`\r\n    insert into pricelist_uploads (id, supplier_id, source, filename, mapping, inserted_count, updated_count, conflict_count, created_at)\r\n    values ($1, $2, $3, $4, $5::jsonb, $6, $7, $8, now())\r\n  `, [\r\n    id,\r\n    params.supplierId,\r\n    params.source,\r\n    params.filename ?? null,\r\n    JSON.stringify(params.mapping),\r\n    inserted,\r\n    updated,\r\n    conflictCount,\r\n  ])\r\n\r\n  if (params.results.length) {\r\n    for (const r of params.results) {\r\n      await query(`\r\n        insert into pricelist_upload_items (upload_id, sku, outcome, message)\r\n        values ($1, $2, $3, $4)\r\n      `, [id, r.sku, r.outcome, r.message ?? null])\r\n    }\r\n  }\r\n  return { id, inserted, updated, conflicts: conflictCount }\r\n}\r\n\r\nexport async function listUploads() {\r\n  const result = await query<{\r\n    id: string\r\n    supplierId: string\r\n    source: string\r\n    filename: string | null\r\n    inserted: number\r\n    updated: number\r\n    conflicts: number\r\n    createdAt: string\r\n  }>(`\r\n    select id, supplier_id as \"supplierId\", source, filename,\r\n           inserted_count as \"inserted\", updated_count as \"updated\", conflict_count as \"conflicts\",\r\n           to_char(created_at at time zone 'UTC', 'YYYY-MM-DD\"T\"HH24:MI:SS\"Z\"') as \"createdAt\"\r\n    from pricelist_uploads\r\n    order by created_at desc\r\n    limit 100\r\n  `)\r\n  return result.rows\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\compliance\\financial.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'crypto' is not defined.","line":283,"column":11,"nodeType":"Identifier","messageId":"undef","endLine":283,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Financial compliance utilities for South African regulations\r\n * VAT, BEE, SARS integration and audit requirements\r\n */\r\n\r\nexport interface VATTransaction {\r\n  id: string;\r\n  transactionDate: Date;\r\n  supplierVATNumber?: string;\r\n  customerVATNumber?: string;\r\n  invoiceNumber: string;\r\n  description: string;\r\n  netAmount: number;\r\n  vatAmount: number;\r\n  grossAmount: number;\r\n  vatRate: number;\r\n  transactionType: 'purchase' | 'sale' | 'import' | 'export';\r\n  vatCategory: 'standard' | 'zero' | 'exempt' | 'deemed';\r\n  isCapitalItem: boolean;\r\n  documentType: 'tax_invoice' | 'receipt' | 'debit_note' | 'credit_note';\r\n  periodMonth: number;\r\n  periodYear: number;\r\n}\r\n\r\nexport interface BEESpend {\r\n  id: string;\r\n  supplierId: string;\r\n  supplierName: string;\r\n  supplierBEELevel: number;\r\n  supplierBEECertificate?: string;\r\n  isBlackOwned: boolean;\r\n  isWomenOwned: boolean;\r\n  isYouthOwned: boolean;\r\n  isDisabledOwned: boolean;\r\n  isQSE: boolean; // Qualifying Small Enterprise\r\n  isEME: boolean; // Exempt Micro Enterprise\r\n  spendAmount: number;\r\n  spendDate: Date;\r\n  category: 'goods' | 'services' | 'professional_services';\r\n  recognitionLevel: number; // BEE recognition percentage\r\n  period: string; // Financial year period\r\n}\r\n\r\nexport interface SARSSubmission {\r\n  id: string;\r\n  submissionType: 'vat_return' | 'paye' | 'provisional_tax' | 'annual_return';\r\n  period: string;\r\n  submissionDate: Date;\r\n  dueDate: Date;\r\n  status: 'draft' | 'submitted' | 'accepted' | 'rejected';\r\n  referenceNumber?: string;\r\n  amount?: number;\r\n  documentPath?: string;\r\n  validationErrors?: string[];\r\n}\r\n\r\nexport interface AuditTrail {\r\n  id: string;\r\n  entityType: 'transaction' | 'supplier' | 'invoice' | 'payment';\r\n  entityId: string;\r\n  action: 'create' | 'update' | 'delete' | 'approve' | 'reject';\r\n  userId: string;\r\n  timestamp: Date;\r\n  changes: Record<string, { old: any; new: any }>;\r\n  reason?: string;\r\n  ipAddress?: string;\r\n  userAgent?: string;\r\n}\r\n\r\nexport class FinancialCompliance {\r\n\r\n  // VAT Compliance\r\n  static calculateVAT(netAmount: number, vatRate: number = 15): {\r\n    netAmount: number;\r\n    vatAmount: number;\r\n    grossAmount: number;\r\n  } {\r\n    const vatAmount = Math.round((netAmount * vatRate / 100) * 100) / 100;\r\n    const grossAmount = netAmount + vatAmount;\r\n\r\n    return {\r\n      netAmount,\r\n      vatAmount,\r\n      grossAmount\r\n    };\r\n  }\r\n\r\n  static validateVATInvoice(transaction: VATTransaction): {\r\n    isValid: boolean;\r\n    errors: string[];\r\n    warnings: string[];\r\n  } {\r\n    const errors: string[] = [];\r\n    const warnings: string[] = [];\r\n\r\n    // Required fields validation\r\n    if (!transaction.supplierVATNumber && transaction.grossAmount > 50) {\r\n      errors.push('Supplier VAT number required for transactions over R50');\r\n    }\r\n\r\n    if (!transaction.invoiceNumber) {\r\n      errors.push('Invoice number is required');\r\n    }\r\n\r\n    if (transaction.grossAmount < 0) {\r\n      errors.push('Gross amount cannot be negative');\r\n    }\r\n\r\n    // VAT calculation validation\r\n    const expectedVAT = this.calculateVAT(transaction.netAmount, transaction.vatRate);\r\n    if (Math.abs(expectedVAT.vatAmount - transaction.vatAmount) > 0.01) {\r\n      errors.push('VAT amount calculation is incorrect');\r\n    }\r\n\r\n    if (Math.abs(expectedVAT.grossAmount - transaction.grossAmount) > 0.01) {\r\n      errors.push('Gross amount calculation is incorrect');\r\n    }\r\n\r\n    // Document type validation\r\n    if (transaction.grossAmount > 5000 && transaction.documentType === 'receipt') {\r\n      warnings.push('Tax invoice required for amounts over R5000');\r\n    }\r\n\r\n    // VAT number format validation\r\n    if (transaction.supplierVATNumber && !/^\\d{10}$/.test(transaction.supplierVATNumber)) {\r\n      errors.push('Invalid VAT number format');\r\n    }\r\n\r\n    return {\r\n      isValid: errors.length === 0,\r\n      errors,\r\n      warnings\r\n    };\r\n  }\r\n\r\n  static generateVATReturn(\r\n    transactions: VATTransaction[],\r\n    period: { month: number; year: number }\r\n  ): {\r\n    period: string;\r\n    totalSales: number;\r\n    totalPurchases: number;\r\n    outputVAT: number;\r\n    inputVAT: number;\r\n    netVAT: number;\r\n    capitalItems: number;\r\n    badDebts: number;\r\n    summary: Record<string, number>;\r\n  } {\r\n    const periodTransactions = transactions.filter(t =>\r\n      t.periodMonth === period.month && t.periodYear === period.year\r\n    );\r\n\r\n    const sales = periodTransactions.filter(t => t.transactionType === 'sale');\r\n    const purchases = periodTransactions.filter(t => t.transactionType === 'purchase');\r\n    const capitalItems = periodTransactions.filter(t => t.isCapitalItem);\r\n\r\n    const totalSales = sales.reduce((sum, t) => sum + t.netAmount, 0);\r\n    const totalPurchases = purchases.reduce((sum, t) => sum + t.netAmount, 0);\r\n    const outputVAT = sales.reduce((sum, t) => sum + t.vatAmount, 0);\r\n    const inputVAT = purchases.reduce((sum, t) => sum + t.vatAmount, 0);\r\n    const capitalItemsVAT = capitalItems.reduce((sum, t) => sum + t.vatAmount, 0);\r\n\r\n    return {\r\n      period: `${period.year}-${period.month.toString().padStart(2, '0')}`,\r\n      totalSales,\r\n      totalPurchases,\r\n      outputVAT,\r\n      inputVAT,\r\n      netVAT: outputVAT - inputVAT,\r\n      capitalItems: capitalItemsVAT,\r\n      badDebts: 0, // To be calculated separately\r\n      summary: {\r\n        'Standard Rated Sales': sales.filter(t => t.vatCategory === 'standard').reduce((sum, t) => sum + t.netAmount, 0),\r\n        'Zero Rated Sales': sales.filter(t => t.vatCategory === 'zero').reduce((sum, t) => sum + t.netAmount, 0),\r\n        'Exempt Sales': sales.filter(t => t.vatCategory === 'exempt').reduce((sum, t) => sum + t.netAmount, 0),\r\n        'Standard Rated Purchases': purchases.filter(t => t.vatCategory === 'standard').reduce((sum, t) => sum + t.netAmount, 0),\r\n        'Capital Item Purchases': capitalItems.reduce((sum, t) => sum + t.netAmount, 0)\r\n      }\r\n    };\r\n  }\r\n\r\n  // BEE Compliance\r\n  static calculateBEERecognition(spend: BEESpend): number {\r\n    let recognition = 0;\r\n\r\n    // Base recognition based on BEE level\r\n    switch (spend.supplierBEELevel) {\r\n      case 1: recognition = 135; break;\r\n      case 2: recognition = 125; break;\r\n      case 3: recognition = 110; break;\r\n      case 4: recognition = 100; break;\r\n      case 5: recognition = 80; break;\r\n      case 6: recognition = 60; break;\r\n      case 7: recognition = 50; break;\r\n      case 8: recognition = 10; break;\r\n      default: recognition = 0;\r\n    }\r\n\r\n    // EME and QSE bonus\r\n    if (spend.isEME) {\r\n      recognition = Math.max(recognition, 135);\r\n    } else if (spend.isQSE) {\r\n      recognition = Math.max(recognition, 125);\r\n    }\r\n\r\n    // Ownership bonuses\r\n    if (spend.isBlackOwned && recognition > 0) {\r\n      recognition += 10;\r\n    }\r\n\r\n    return Math.min(recognition, 135); // Cap at 135%\r\n  }\r\n\r\n  static generateBEEReport(\r\n    spends: BEESpend[],\r\n    period: string\r\n  ): {\r\n    period: string;\r\n    totalSpend: number;\r\n    beeSpend: number;\r\n    beePercentage: number;\r\n    recognizedSpend: number;\r\n    recognizedPercentage: number;\r\n    breakdown: Record<string, any>;\r\n    recommendations: string[];\r\n  } {\r\n    const periodSpends = spends.filter(s => s.period === period);\r\n    const totalSpend = periodSpends.reduce((sum, s) => sum + s.spendAmount, 0);\r\n\r\n    const beeSpends = periodSpends.filter(s => s.supplierBEELevel > 0 || s.isEME || s.isQSE);\r\n    const beeSpend = beeSpends.reduce((sum, s) => sum + s.spendAmount, 0);\r\n\r\n    const recognizedSpend = beeSpends.reduce((sum, s) => {\r\n      const recognition = this.calculateBEERecognition(s);\r\n      return sum + (s.spendAmount * recognition / 100);\r\n    }, 0);\r\n\r\n    const recommendations: string[] = [];\r\n\r\n    if ((beeSpend / totalSpend) < 0.70) {\r\n      recommendations.push('Increase BEE spend to achieve 70% target');\r\n    }\r\n\r\n    if ((recognizedSpend / totalSpend) < 0.40) {\r\n      recommendations.push('Focus on higher BEE level suppliers for better recognition');\r\n    }\r\n\r\n    return {\r\n      period,\r\n      totalSpend,\r\n      beeSpend,\r\n      beePercentage: (beeSpend / totalSpend) * 100,\r\n      recognizedSpend,\r\n      recognizedPercentage: (recognizedSpend / totalSpend) * 100,\r\n      breakdown: {\r\n        'Level 1 Suppliers': beeSpends.filter(s => s.supplierBEELevel === 1).reduce((sum, s) => sum + s.spendAmount, 0),\r\n        'Level 2 Suppliers': beeSpends.filter(s => s.supplierBEELevel === 2).reduce((sum, s) => sum + s.spendAmount, 0),\r\n        'Level 3 Suppliers': beeSpends.filter(s => s.supplierBEELevel === 3).reduce((sum, s) => sum + s.spendAmount, 0),\r\n        'Level 4+ Suppliers': beeSpends.filter(s => s.supplierBEELevel >= 4).reduce((sum, s) => sum + s.spendAmount, 0),\r\n        'EME Suppliers': beeSpends.filter(s => s.isEME).reduce((sum, s) => sum + s.spendAmount, 0),\r\n        'QSE Suppliers': beeSpends.filter(s => s.isQSE && !s.isEME).reduce((sum, s) => sum + s.spendAmount, 0),\r\n        'Black Owned': beeSpends.filter(s => s.isBlackOwned).reduce((sum, s) => sum + s.spendAmount, 0),\r\n        'Women Owned': beeSpends.filter(s => s.isWomenOwned).reduce((sum, s) => sum + s.spendAmount, 0),\r\n        'Youth Owned': beeSpends.filter(s => s.isYouthOwned).reduce((sum, s) => sum + s.spendAmount, 0)\r\n      },\r\n      recommendations\r\n    };\r\n  }\r\n\r\n  // Audit Trail Management\r\n  static createAuditEntry(\r\n    entityType: AuditTrail['entityType'],\r\n    entityId: string,\r\n    action: AuditTrail['action'],\r\n    userId: string,\r\n    changes: Record<string, { old: any; new: any }>,\r\n    reason?: string,\r\n    ipAddress?: string,\r\n    userAgent?: string\r\n  ): AuditTrail {\r\n    return {\r\n      id: crypto.randomUUID(),\r\n      entityType,\r\n      entityId,\r\n      action,\r\n      userId,\r\n      timestamp: new Date(),\r\n      changes,\r\n      reason,\r\n      ipAddress,\r\n      userAgent\r\n    };\r\n  }\r\n\r\n  static generateAuditReport(\r\n    auditTrail: AuditTrail[],\r\n    startDate: Date,\r\n    endDate: Date\r\n  ): {\r\n    period: string;\r\n    totalActions: number;\r\n    userActivity: Record<string, number>;\r\n    entityActivity: Record<string, number>;\r\n    actionBreakdown: Record<string, number>;\r\n    suspiciousActivity: AuditTrail[];\r\n    summary: string;\r\n  } {\r\n    const periodTrail = auditTrail.filter(a =>\r\n      a.timestamp >= startDate && a.timestamp <= endDate\r\n    );\r\n\r\n    const userActivity = periodTrail.reduce((acc, entry) => {\r\n      acc[entry.userId] = (acc[entry.userId] || 0) + 1;\r\n      return acc;\r\n    }, {} as Record<string, number>);\r\n\r\n    const entityActivity = periodTrail.reduce((acc, entry) => {\r\n      acc[entry.entityType] = (acc[entry.entityType] || 0) + 1;\r\n      return acc;\r\n    }, {} as Record<string, number>);\r\n\r\n    const actionBreakdown = periodTrail.reduce((acc, entry) => {\r\n      acc[entry.action] = (acc[entry.action] || 0) + 1;\r\n      return acc;\r\n    }, {} as Record<string, number>);\r\n\r\n    // Detect suspicious activity\r\n    const suspiciousActivity = periodTrail.filter(entry => {\r\n      // Multiple deletes by same user\r\n      const userDeletes = periodTrail.filter(a =>\r\n        a.userId === entry.userId && a.action === 'delete'\r\n      ).length;\r\n\r\n      // Actions outside business hours\r\n      const hour = entry.timestamp.getHours();\r\n      const isOutsideHours = hour < 8 || hour > 18;\r\n\r\n      // Weekend activity\r\n      const isWeekend = entry.timestamp.getDay() === 0 || entry.timestamp.getDay() === 6;\r\n\r\n      return userDeletes > 10 || (isOutsideHours && entry.action === 'delete') || isWeekend;\r\n    });\r\n\r\n    return {\r\n      period: `${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]}`,\r\n      totalActions: periodTrail.length,\r\n      userActivity,\r\n      entityActivity,\r\n      actionBreakdown,\r\n      suspiciousActivity,\r\n      summary: `${periodTrail.length} total actions by ${Object.keys(userActivity).length} users. ${suspiciousActivity.length} suspicious activities detected.`\r\n    };\r\n  }\r\n\r\n  // SARS Integration Helpers\r\n  static validateSARSSubmission(submission: SARSSubmission): {\r\n    isValid: boolean;\r\n    errors: string[];\r\n    warnings: string[];\r\n  } {\r\n    const errors: string[] = [];\r\n    const warnings: string[] = [];\r\n\r\n    if (!submission.period) {\r\n      errors.push('Period is required');\r\n    }\r\n\r\n    if (submission.dueDate < new Date()) {\r\n      warnings.push('Submission is overdue');\r\n    }\r\n\r\n    if (submission.submissionType === 'vat_return' && !submission.amount) {\r\n      errors.push('Amount is required for VAT returns');\r\n    }\r\n\r\n    return {\r\n      isValid: errors.length === 0,\r\n      errors,\r\n      warnings\r\n    };\r\n  }\r\n\r\n  static generateComplianceScore(\r\n    vatTransactions: VATTransaction[],\r\n    beeSpends: BEESpend[],\r\n    auditTrail: AuditTrail[]\r\n  ): {\r\n    overallScore: number;\r\n    vatCompliance: number;\r\n    beeCompliance: number;\r\n    auditCompliance: number;\r\n    recommendations: string[];\r\n  } {\r\n    let vatCompliance = 100;\r\n    let beeCompliance = 100;\r\n    let auditCompliance = 100;\r\n    const recommendations: string[] = [];\r\n\r\n    // VAT Compliance scoring\r\n    const invalidVAT = vatTransactions.filter(t => {\r\n      const validation = this.validateVATInvoice(t);\r\n      return !validation.isValid;\r\n    });\r\n\r\n    if (invalidVAT.length > 0) {\r\n      vatCompliance = Math.max(0, 100 - (invalidVAT.length / vatTransactions.length) * 100);\r\n      recommendations.push(`${invalidVAT.length} VAT transactions have validation errors`);\r\n    }\r\n\r\n    // BEE Compliance scoring\r\n    const currentPeriod = new Date().getFullYear().toString();\r\n    const currentBEEReport = this.generateBEEReport(beeSpends, currentPeriod);\r\n\r\n    if (currentBEEReport.beePercentage < 70) {\r\n      beeCompliance = Math.max(0, currentBEEReport.beePercentage);\r\n      recommendations.push('BEE spend below 70% target');\r\n    }\r\n\r\n    // Audit Compliance scoring\r\n    const recentAudits = auditTrail.filter(a =>\r\n      (Date.now() - a.timestamp.getTime()) < (30 * 24 * 60 * 60 * 1000) // 30 days\r\n    );\r\n\r\n    const suspiciousCount = recentAudits.filter(a => {\r\n      const hour = a.timestamp.getHours();\r\n      return hour < 8 || hour > 18 || a.timestamp.getDay() === 0 || a.timestamp.getDay() === 6;\r\n    }).length;\r\n\r\n    if (suspiciousCount > recentAudits.length * 0.1) {\r\n      auditCompliance = Math.max(0, 100 - (suspiciousCount / recentAudits.length) * 100);\r\n      recommendations.push('High volume of suspicious audit activity detected');\r\n    }\r\n\r\n    const overallScore = (vatCompliance + beeCompliance + auditCompliance) / 3;\r\n\r\n    return {\r\n      overallScore,\r\n      vatCompliance,\r\n      beeCompliance,\r\n      auditCompliance,\r\n      recommendations\r\n    };\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\compliance\\popia.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'crypto' is not defined.","line":86,"column":11,"nodeType":"Identifier","messageId":"undef","endLine":86,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * POPIA (Protection of Personal Information Act) Compliance utilities\r\n * South African data protection implementation\r\n */\r\n\r\nexport interface PersonalInformation {\r\n  id: string;\r\n  dataSubjectId: string;\r\n  dataType: 'identity' | 'contact' | 'financial' | 'biometric' | 'location' | 'employment' | 'health' | 'other';\r\n  data: any;\r\n  purpose: string;\r\n  legalBasis: 'consent' | 'contract' | 'legal_obligation' | 'vital_interests' | 'public_task' | 'legitimate_interests';\r\n  consentGiven: boolean;\r\n  consentDate?: Date;\r\n  retentionPeriod: number; // in days\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  deletedAt?: Date;\r\n  isMinorData: boolean;\r\n  parentalConsent?: boolean;\r\n  source: string;\r\n  processor?: string;\r\n}\r\n\r\nexport interface ConsentRecord {\r\n  id: string;\r\n  dataSubjectId: string;\r\n  purpose: string;\r\n  dataTypes: string[];\r\n  consentGiven: boolean;\r\n  consentDate: Date;\r\n  withdrawalDate?: Date;\r\n  consentMethod: 'explicit' | 'implied' | 'opt_in' | 'opt_out';\r\n  consentText: string;\r\n  ipAddress?: string;\r\n  userAgent?: string;\r\n  version: number;\r\n  isActive: boolean;\r\n}\r\n\r\nexport interface DataSubjectRequest {\r\n  id: string;\r\n  dataSubjectId: string;\r\n  requestType: 'access' | 'rectification' | 'erasure' | 'portability' | 'restriction' | 'objection';\r\n  requestDate: Date;\r\n  description: string;\r\n  status: 'pending' | 'in_progress' | 'completed' | 'rejected';\r\n  responseDate?: Date;\r\n  responseDetails?: string;\r\n  verificationMethod: string;\r\n  documents?: string[];\r\n}\r\n\r\nexport interface DataBreach {\r\n  id: string;\r\n  incidentDate: Date;\r\n  reportedDate: Date;\r\n  description: string;\r\n  severity: 'low' | 'medium' | 'high' | 'critical';\r\n  affectedDataSubjects: number;\r\n  dataTypesAffected: string[];\r\n  cause: string;\r\n  containmentMeasures: string;\r\n  notificationRequired: boolean;\r\n  regulatorNotified: boolean;\r\n  regulatorNotificationDate?: Date;\r\n  dataSubjectsNotified: boolean;\r\n  dataSubjectNotificationDate?: Date;\r\n  status: 'investigating' | 'contained' | 'resolved';\r\n  followUpActions: string[];\r\n}\r\n\r\nexport class POPIACompliance {\r\n\r\n  // Consent Management\r\n  static recordConsent(\r\n    dataSubjectId: string,\r\n    purpose: string,\r\n    dataTypes: string[],\r\n    consentMethod: 'explicit' | 'implied' | 'opt_in' | 'opt_out',\r\n    consentText: string,\r\n    ipAddress?: string,\r\n    userAgent?: string\r\n  ): ConsentRecord {\r\n    return {\r\n      id: crypto.randomUUID(),\r\n      dataSubjectId,\r\n      purpose,\r\n      dataTypes,\r\n      consentGiven: true,\r\n      consentDate: new Date(),\r\n      consentMethod,\r\n      consentText,\r\n      ipAddress,\r\n      userAgent,\r\n      version: 1,\r\n      isActive: true\r\n    };\r\n  }\r\n\r\n  static withdrawConsent(consentId: string): Partial<ConsentRecord> {\r\n    return {\r\n      consentGiven: false,\r\n      withdrawalDate: new Date(),\r\n      isActive: false\r\n    };\r\n  }\r\n\r\n  static validateConsent(consent: ConsentRecord, purpose: string): boolean {\r\n    return (\r\n      consent.isActive &&\r\n      consent.consentGiven &&\r\n      consent.purpose === purpose &&\r\n      !consent.withdrawalDate\r\n    );\r\n  }\r\n\r\n  // Data Retention Management\r\n  static calculateRetentionExpiry(createdAt: Date, retentionPeriod: number): Date {\r\n    const expiryDate = new Date(createdAt);\r\n    expiryDate.setDate(expiryDate.getDate() + retentionPeriod);\r\n    return expiryDate;\r\n  }\r\n\r\n  static isRetentionExpired(personalInfo: PersonalInformation): boolean {\r\n    const expiryDate = this.calculateRetentionExpiry(\r\n      personalInfo.createdAt,\r\n      personalInfo.retentionPeriod\r\n    );\r\n    return new Date() > expiryDate;\r\n  }\r\n\r\n  static getExpiringData(data: PersonalInformation[], daysThreshold: number = 30): PersonalInformation[] {\r\n    const threshold = new Date();\r\n    threshold.setDate(threshold.getDate() + daysThreshold);\r\n\r\n    return data.filter(item => {\r\n      const expiryDate = this.calculateRetentionExpiry(item.createdAt, item.retentionPeriod);\r\n      return expiryDate <= threshold && !item.deletedAt;\r\n    });\r\n  }\r\n\r\n  // Data Subject Rights\r\n  static processAccessRequest(dataSubjectId: string, data: PersonalInformation[]): any {\r\n    const subjectData = data.filter(item =>\r\n      item.dataSubjectId === dataSubjectId && !item.deletedAt\r\n    );\r\n\r\n    return {\r\n      dataSubjectId,\r\n      requestDate: new Date(),\r\n      personalInformation: subjectData.map(item => ({\r\n        dataType: item.dataType,\r\n        purpose: item.purpose,\r\n        legalBasis: item.legalBasis,\r\n        retentionPeriod: item.retentionPeriod,\r\n        source: item.source,\r\n        processor: item.processor,\r\n        createdAt: item.createdAt,\r\n        updatedAt: item.updatedAt\r\n      })),\r\n      totalRecords: subjectData.length\r\n    };\r\n  }\r\n\r\n  static processPortabilityRequest(dataSubjectId: string, data: PersonalInformation[]): any {\r\n    const subjectData = data.filter(item =>\r\n      item.dataSubjectId === dataSubjectId &&\r\n      !item.deletedAt &&\r\n      (item.legalBasis === 'consent' || item.legalBasis === 'contract')\r\n    );\r\n\r\n    return {\r\n      dataSubjectId,\r\n      exportDate: new Date(),\r\n      format: 'JSON',\r\n      data: subjectData.map(item => ({\r\n        dataType: item.dataType,\r\n        data: item.data,\r\n        createdAt: item.createdAt\r\n      }))\r\n    };\r\n  }\r\n\r\n  static processErasureRequest(dataSubjectId: string): Partial<PersonalInformation> {\r\n    return {\r\n      deletedAt: new Date(),\r\n      data: null // Anonymize the data\r\n    };\r\n  }\r\n\r\n  // Data Breach Management\r\n  static assessBreachRisk(breach: Partial<DataBreach>): {\r\n    riskLevel: 'low' | 'medium' | 'high' | 'critical';\r\n    notificationRequired: boolean;\r\n    timeframe: string;\r\n  } {\r\n    let riskLevel: 'low' | 'medium' | 'high' | 'critical' = 'low';\r\n    let notificationRequired = false;\r\n    let timeframe = '72 hours';\r\n\r\n    // Risk assessment criteria\r\n    if (breach.affectedDataSubjects && breach.affectedDataSubjects > 1000) {\r\n      riskLevel = 'high';\r\n      notificationRequired = true;\r\n    }\r\n\r\n    if (breach.dataTypesAffected?.includes('financial') ||\r\n        breach.dataTypesAffected?.includes('identity') ||\r\n        breach.dataTypesAffected?.includes('biometric')) {\r\n      riskLevel = 'critical';\r\n      notificationRequired = true;\r\n      timeframe = '24 hours';\r\n    }\r\n\r\n    if (breach.severity === 'critical') {\r\n      notificationRequired = true;\r\n      timeframe = '24 hours';\r\n    }\r\n\r\n    return { riskLevel, notificationRequired, timeframe };\r\n  }\r\n\r\n  static createBreachReport(breach: DataBreach): string {\r\n    return `\r\nPOPIA Data Breach Report\r\n========================\r\n\r\nIncident ID: ${breach.id}\r\nDate of Incident: ${breach.incidentDate.toISOString()}\r\nDate Reported: ${breach.reportedDate.toISOString()}\r\n\r\nDescription: ${breach.description}\r\nSeverity: ${breach.severity.toUpperCase()}\r\n\r\nAffected Data Subjects: ${breach.affectedDataSubjects}\r\nData Types Affected: ${breach.dataTypesAffected.join(', ')}\r\n\r\nCause: ${breach.cause}\r\nContainment Measures: ${breach.containmentMeasures}\r\n\r\nRegulator Notification Required: ${breach.notificationRequired ? 'Yes' : 'No'}\r\n${breach.regulatorNotified ? `Regulator Notified: ${breach.regulatorNotificationDate?.toISOString()}` : ''}\r\n\r\nData Subjects Notification Required: ${breach.notificationRequired ? 'Yes' : 'No'}\r\n${breach.dataSubjectsNotified ? `Data Subjects Notified: ${breach.dataSubjectNotificationDate?.toISOString()}` : ''}\r\n\r\nStatus: ${breach.status.toUpperCase()}\r\n\r\nFollow-up Actions:\r\n${breach.followUpActions.map(action => `- ${action}`).join('\\n')}\r\n    `.trim();\r\n  }\r\n\r\n  // Privacy Impact Assessment\r\n  static conductPIA(\r\n    processing: {\r\n      purpose: string;\r\n      dataTypes: string[];\r\n      dataSubjects: string[];\r\n      legalBasis: string;\r\n      retentionPeriod: number;\r\n      thirdPartySharing: boolean;\r\n      crossBorderTransfer: boolean;\r\n    }\r\n  ): {\r\n    riskScore: number;\r\n    risks: string[];\r\n    recommendations: string[];\r\n    approved: boolean;\r\n  } {\r\n    const risks: string[] = [];\r\n    const recommendations: string[] = [];\r\n    let riskScore = 0;\r\n\r\n    // Assess data sensitivity\r\n    if (processing.dataTypes.includes('biometric') || processing.dataTypes.includes('financial')) {\r\n      riskScore += 30;\r\n      risks.push('Processing highly sensitive personal information');\r\n      recommendations.push('Implement additional encryption and access controls');\r\n    }\r\n\r\n    if (processing.dataTypes.includes('identity')) {\r\n      riskScore += 20;\r\n      risks.push('Processing identity information');\r\n      recommendations.push('Ensure strong authentication for access');\r\n    }\r\n\r\n    // Assess scale and scope\r\n    if (processing.dataSubjects.includes('children')) {\r\n      riskScore += 25;\r\n      risks.push('Processing children\\'s personal information');\r\n      recommendations.push('Obtain parental consent and implement additional safeguards');\r\n    }\r\n\r\n    // Assess retention period\r\n    if (processing.retentionPeriod > 2555) { // 7 years\r\n      riskScore += 15;\r\n      risks.push('Long retention period increases risk');\r\n      recommendations.push('Review and justify retention period');\r\n    }\r\n\r\n    // Assess third party sharing\r\n    if (processing.thirdPartySharing) {\r\n      riskScore += 20;\r\n      risks.push('Third party data sharing increases risk');\r\n      recommendations.push('Ensure data processing agreements are in place');\r\n    }\r\n\r\n    // Assess cross-border transfers\r\n    if (processing.crossBorderTransfer) {\r\n      riskScore += 25;\r\n      risks.push('Cross-border data transfer increases risk');\r\n      recommendations.push('Ensure adequate protection in destination country');\r\n    }\r\n\r\n    const approved = riskScore < 70;\r\n\r\n    if (!approved) {\r\n      recommendations.push('High risk processing - requires additional approval and safeguards');\r\n    }\r\n\r\n    return {\r\n      riskScore,\r\n      risks,\r\n      recommendations,\r\n      approved\r\n    };\r\n  }\r\n\r\n  // Compliance Monitoring\r\n  static generateComplianceReport(\r\n    personalInfo: PersonalInformation[],\r\n    consents: ConsentRecord[],\r\n    breaches: DataBreach[]\r\n  ): {\r\n    summary: any;\r\n    details: any;\r\n    recommendations: string[];\r\n  } {\r\n    const now = new Date();\r\n    const activeData = personalInfo.filter(item => !item.deletedAt);\r\n    const expiredData = personalInfo.filter(item => this.isRetentionExpired(item) && !item.deletedAt);\r\n    const activeConsents = consents.filter(c => c.isActive);\r\n    const recentBreaches = breaches.filter(b =>\r\n      (now.getTime() - b.incidentDate.getTime()) < (90 * 24 * 60 * 60 * 1000) // 90 days\r\n    );\r\n\r\n    const recommendations: string[] = [];\r\n\r\n    if (expiredData.length > 0) {\r\n      recommendations.push(`${expiredData.length} records have exceeded retention period and should be deleted`);\r\n    }\r\n\r\n    if (activeData.some(item => item.isMinorData && !item.parentalConsent)) {\r\n      recommendations.push('Some minor data lacks parental consent');\r\n    }\r\n\r\n    if (recentBreaches.length > 0) {\r\n      recommendations.push(`${recentBreaches.length} data breaches in the last 90 days require follow-up`);\r\n    }\r\n\r\n    return {\r\n      summary: {\r\n        totalPersonalInfo: personalInfo.length,\r\n        activeRecords: activeData.length,\r\n        expiredRecords: expiredData.length,\r\n        totalConsents: consents.length,\r\n        activeConsents: activeConsents.length,\r\n        recentBreaches: recentBreaches.length,\r\n        complianceScore: Math.max(0, 100 - (expiredData.length * 2) - (recentBreaches.length * 10))\r\n      },\r\n      details: {\r\n        dataTypeBreakdown: this.getDataTypeBreakdown(activeData),\r\n        legalBasisBreakdown: this.getLegalBasisBreakdown(activeData),\r\n        retentionAnalysis: this.getRetentionAnalysis(activeData),\r\n        consentAnalysis: this.getConsentAnalysis(activeConsents)\r\n      },\r\n      recommendations\r\n    };\r\n  }\r\n\r\n  private static getDataTypeBreakdown(data: PersonalInformation[]): Record<string, number> {\r\n    return data.reduce((acc, item) => {\r\n      acc[item.dataType] = (acc[item.dataType] || 0) + 1;\r\n      return acc;\r\n    }, {} as Record<string, number>);\r\n  }\r\n\r\n  private static getLegalBasisBreakdown(data: PersonalInformation[]): Record<string, number> {\r\n    return data.reduce((acc, item) => {\r\n      acc[item.legalBasis] = (acc[item.legalBasis] || 0) + 1;\r\n      return acc;\r\n    }, {} as Record<string, number>);\r\n  }\r\n\r\n  private static getRetentionAnalysis(data: PersonalInformation[]): any {\r\n    const periods = data.map(item => item.retentionPeriod);\r\n    return {\r\n      averageRetention: periods.reduce((a, b) => a + b, 0) / periods.length,\r\n      maxRetention: Math.max(...periods),\r\n      minRetention: Math.min(...periods)\r\n    };\r\n  }\r\n\r\n  private static getConsentAnalysis(consents: ConsentRecord[]): any {\r\n    return {\r\n      explicitConsents: consents.filter(c => c.consentMethod === 'explicit').length,\r\n      impliedConsents: consents.filter(c => c.consentMethod === 'implied').length,\r\n      optInConsents: consents.filter(c => c.consentMethod === 'opt_in').length,\r\n      optOutConsents: consents.filter(c => c.consentMethod === 'opt_out').length\r\n    };\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\database\\transaction-helper.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'pool' is not defined.","line":194,"column":12,"nodeType":"Identifier","messageId":"undef","endLine":194,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Transaction Management Helper\r\n *\r\n * Provides robust transaction management with automatic resource cleanup,\r\n * proper error handling, and support for transaction composition.\r\n *\r\n * **CRITICAL USAGE RULES:**\r\n * 1. NEVER use pool.query('BEGIN') - it uses random connections\r\n * 2. ALWAYS use client.query() within transactions for same-connection guarantees\r\n * 3. Use TransactionHelper.withTransaction() for atomic operations\r\n * 4. Repository methods should accept optional PoolClient for composition\r\n *\r\n * @example\r\n * // Simple transaction\r\n * const result = await TransactionHelper.withTransaction(async (client) => {\r\n *   await client.query('INSERT INTO users...', [...])\r\n *   await client.query('INSERT INTO profiles...', [...])\r\n *   return { success: true }\r\n * })\r\n *\r\n * @example\r\n * // Transaction composition in repository\r\n * class UserRepository {\r\n *   async create(user: User, client?: PoolClient): Promise<User> {\r\n *     if (client) {\r\n *       // Part of external transaction\r\n *       const result = await client.query('INSERT...', [...])\r\n *       return result.rows[0]\r\n *     } else {\r\n *       // Create own transaction\r\n *       return TransactionHelper.withTransaction(async (txClient) => {\r\n *         const result = await txClient.query('INSERT...', [...])\r\n *         return result.rows[0]\r\n *       })\r\n *     }\r\n *   }\r\n * }\r\n */\r\n\r\nimport { PoolClient } from 'pg'\r\nimport { withTransaction as enterpriseWithTransaction, query as enterpriseQuery } from '@/lib/database/unified-connection'\r\n\r\nexport class TransactionHelper {\r\n  /**\r\n   * Execute callback within a database transaction\r\n   *\r\n   * Automatically handles:\r\n   * - BEGIN/COMMIT/ROLLBACK\r\n   * - Connection acquisition and release\r\n   * - Error propagation with proper rollback\r\n   *\r\n   * **GUARANTEES:**\r\n   * - Single connection used for entire transaction\r\n   * - Connection released even on error\r\n   * - Proper transaction rollback on any error\r\n   *\r\n   * @param callback - Function receiving PoolClient, must use client.query()\r\n   * @returns Promise resolving to callback result\r\n   * @throws Any error from callback after rollback\r\n   *\r\n   * @example\r\n   * const order = await TransactionHelper.withTransaction(async (client) => {\r\n   *   // All queries use SAME connection\r\n   *   const orderResult = await client.query('INSERT INTO orders...', [...])\r\n   *   const itemResult = await client.query('INSERT INTO order_items...', [...])\r\n   *   const stockResult = await client.query('UPDATE inventory...', [...])\r\n   *   return orderResult.rows[0]\r\n   * })\r\n   */\r\n  static async withTransaction<T>(\r\n    callback: (client: PoolClient) => Promise<T>\r\n  ): Promise<T> {\r\n    // Delegate to enterprise connection manager's withTransaction\r\n    return enterpriseWithTransaction(callback)\r\n  }\r\n\r\n  /**\r\n   * Execute callback with database client (NO transaction)\r\n   *\r\n   * Use when you need connection reuse but not transaction semantics.\r\n   * Automatically handles connection release.\r\n   *\r\n   * @param callback - Function receiving PoolClient\r\n   * @returns Promise resolving to callback result\r\n   *\r\n   * @example\r\n   * const users = await TransactionHelper.withClient(async (client) => {\r\n   *   const result = await client.query('SELECT * FROM users WHERE...', [...])\r\n   *   return result.rows\r\n   * })\r\n   */\r\n  static async withClient<T>(\r\n    callback: (client: PoolClient) => Promise<T>\r\n  ): Promise<T> {\r\n    // For withClient (no transaction), we'll use withTransaction but without BEGIN/COMMIT\r\n    // This maintains the same connection pooling behavior\r\n    return enterpriseWithTransaction(callback)\r\n  }\r\n\r\n  /**\r\n   * Execute callback within a savepoint (nested transaction)\r\n   *\r\n   * Allows partial rollback within larger transaction.\r\n   * Useful for optional operations that can fail without aborting entire transaction.\r\n   *\r\n   * **REQUIREMENTS:**\r\n   * - Must be called within existing transaction\r\n   * - Savepoint name must be unique within transaction\r\n   *\r\n   * @param client - Existing transaction client\r\n   * @param savepointName - Unique savepoint identifier (alphanumeric + underscore)\r\n   * @param callback - Function to execute within savepoint\r\n   * @returns Promise resolving to callback result\r\n   * @throws Error from callback after savepoint rollback\r\n   *\r\n   * @example\r\n   * await TransactionHelper.withTransaction(async (client) => {\r\n   *   // Main operation\r\n   *   await client.query('INSERT INTO orders...', [...])\r\n   *\r\n   *   // Optional operation with savepoint\r\n   *   try {\r\n   *     await TransactionHelper.withSavepoint(client, 'loyalty_points', async (spClient) => {\r\n   *       await spClient.query('UPDATE loyalty_points...', [...])\r\n   *     })\r\n   *   } catch (error) {\r\n   *     // Loyalty update failed but order still commits\r\n   *     console.warn('Loyalty points update failed:', error)\r\n   *   }\r\n   * })\r\n   */\r\n  static async withSavepoint<T>(\r\n    client: PoolClient,\r\n    savepointName: string,\r\n    callback: (client: PoolClient) => Promise<T>\r\n  ): Promise<T> {\r\n    // Validate savepoint name (prevent SQL injection)\r\n    if (!/^[a-zA-Z0-9_]+$/.test(savepointName)) {\r\n      throw new Error('Invalid savepoint name. Use only alphanumeric characters and underscores.')\r\n    }\r\n\r\n    try {\r\n      await client.query(`SAVEPOINT ${savepointName}`)\r\n      const result = await callback(client)\r\n      await client.query(`RELEASE SAVEPOINT ${savepointName}`)\r\n      return result\r\n    } catch (error) {\r\n      await client.query(`ROLLBACK TO SAVEPOINT ${savepointName}`)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Execute multiple operations in parallel within same transaction\r\n   *\r\n   * **WARNING:** Use with caution - parallel operations in same transaction\r\n   * can cause deadlocks if they access same rows. Only use when operations\r\n   * are guaranteed to not conflict.\r\n   *\r\n   * @param client - Transaction client\r\n   * @param operations - Array of async functions receiving client\r\n   * @returns Promise resolving to array of results\r\n   *\r\n   * @example\r\n   * await TransactionHelper.withTransaction(async (client) => {\r\n   *   const [users, products] = await TransactionHelper.parallel(client, [\r\n   *     (c) => c.query('SELECT * FROM users WHERE...', [...]),\r\n   *     (c) => c.query('SELECT * FROM products WHERE...', [...])\r\n   *   ])\r\n   * })\r\n   */\r\n  static async parallel<T>(\r\n    client: PoolClient,\r\n    operations: Array<(client: PoolClient) => Promise<T>>\r\n  ): Promise<T[]> {\r\n    return Promise.all(operations.map(op => op(client)))\r\n  }\r\n\r\n  /**\r\n   * Get direct access to connection pool\r\n   *\r\n   * **USE WITH EXTREME CAUTION**\r\n   * Direct pool access bypasses transaction safety.\r\n   * Only use for read-only queries or when you know what you're doing.\r\n   *\r\n   * @returns Database connection pool\r\n   *\r\n   * @example\r\n   * // Read-only query (safe)\r\n   * const pool = TransactionHelper.getPool()\r\n   * const result = await pool.query('SELECT * FROM lookup_table')\r\n   */\r\n  static getPool() {\r\n    return pool\r\n  }\r\n}\r\n\r\n/**\r\n * Legacy compatibility - exported function matching db.ts signature\r\n *\r\n * @deprecated Use TransactionHelper.withTransaction instead\r\n */\r\nexport const withTransaction = TransactionHelper.withTransaction\r\n\r\n/**\r\n * Export individual functions for tree-shaking\r\n */\r\nexport const { withClient, withSavepoint, parallel } = TransactionHelper\r\n\r\n/**\r\n * Default export for convenience\r\n */\r\nexport default TransactionHelper","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\integrations\\xlsx-processor.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\+.","line":346,"column":19,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":346,"endColumn":20,"suggestions":[{"messageId":"removeEscape","fix":{"range":[10593,10594],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[10593,10593],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\(.","line":346,"column":34,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":346,"endColumn":35,"suggestions":[{"messageId":"removeEscape","fix":{"range":[10608,10609],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[10608,10608],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\).","line":346,"column":36,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":346,"endColumn":37,"suggestions":[{"messageId":"removeEscape","fix":{"range":[10610,10611],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[10610,10610],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Real-Time XLSX Processing System\r\n * Live database integration with progress tracking and real-time updates\r\n */\r\n\r\nimport * as XLSX from 'xlsx';\r\nimport { db } from '../database';\r\nimport { EventEmitter } from 'events';\r\n\r\nexport interface XLSXProcessingOptions {\r\n  organizationId: string;\r\n  userId: string;\r\n  targetTable: string;\r\n  sheetName?: string;\r\n  skipRows?: number;\r\n  batchSize?: number;\r\n  validateData?: boolean;\r\n  updateExisting?: boolean;\r\n  createMissing?: boolean;\r\n}\r\n\r\nexport interface ProcessingProgress {\r\n  id: string;\r\n  status: 'pending' | 'processing' | 'completed' | 'error';\r\n  totalRows: number;\r\n  processedRows: number;\r\n  successfulRows: number;\r\n  errorRows: number;\r\n  progress: number;\r\n  errors: ProcessingError[];\r\n  startTime: string;\r\n  endTime?: string;\r\n  estimatedTimeRemaining?: number;\r\n}\r\n\r\nexport interface ProcessingError {\r\n  row: number;\r\n  column?: string;\r\n  error: string;\r\n  data?: any;\r\n}\r\n\r\nexport interface ValidationRule {\r\n  column: string;\r\n  required?: boolean;\r\n  type?: 'string' | 'number' | 'date' | 'email' | 'phone';\r\n  minLength?: number;\r\n  maxLength?: number;\r\n  pattern?: RegExp;\r\n  allowedValues?: any[];\r\n  customValidator?: (value: any) => boolean | string;\r\n}\r\n\r\nexport class XLSXProcessor extends EventEmitter {\r\n  private activeProcesses: Map<string, ProcessingProgress> = new Map();\r\n\r\n  /**\r\n   * Process XLSX file with real-time progress tracking\r\n   */\r\n  async processFile(\r\n    fileBuffer: Buffer,\r\n    options: XLSXProcessingOptions,\r\n    validationRules: ValidationRule[] = []\r\n  ): Promise<{ processId: string; progress: ProcessingProgress }> {\r\n    const processId = this.generateProcessId();\r\n\r\n    const progress: ProcessingProgress = {\r\n      id: processId,\r\n      status: 'pending',\r\n      totalRows: 0,\r\n      processedRows: 0,\r\n      successfulRows: 0,\r\n      errorRows: 0,\r\n      progress: 0,\r\n      errors: [],\r\n      startTime: new Date().toISOString()\r\n    };\r\n\r\n    this.activeProcesses.set(processId, progress);\r\n    this.emit('progress', progress);\r\n\r\n    try {\r\n      // Parse XLSX file\r\n      const workbook = XLSX.read(fileBuffer, { type: 'buffer' });\r\n      const sheetName = options.sheetName || workbook.SheetNames[0];\r\n      const worksheet = workbook.Sheets[sheetName];\r\n\r\n      if (!worksheet) {\r\n        throw new Error(`Sheet \"${sheetName}\" not found`);\r\n      }\r\n\r\n      // Convert to JSON with headers\r\n      const jsonData = XLSX.utils.sheet_to_json(worksheet, {\r\n        header: 1,\r\n        defval: null,\r\n        blankrows: false\r\n      }) as any[][];\r\n\r\n      if (jsonData.length === 0) {\r\n        throw new Error('No data found in worksheet');\r\n      }\r\n\r\n      // Get headers and data rows\r\n      const headers = jsonData[0] as string[];\r\n      const dataRows = jsonData.slice((options.skipRows || 0) + 1);\r\n\r\n      progress.totalRows = dataRows.length;\r\n      progress.status = 'processing';\r\n      this.activeProcesses.set(processId, progress);\r\n      this.emit('progress', progress);\r\n\r\n      // Process data in batches\r\n      const batchSize = options.batchSize || 100;\r\n\r\n      for (let i = 0; i < dataRows.length; i += batchSize) {\r\n        const batch = dataRows.slice(i, Math.min(i + batchSize, dataRows.length));\r\n        await this.processBatch(\r\n          batch,\r\n          headers,\r\n          options,\r\n          validationRules,\r\n          processId,\r\n          i\r\n        );\r\n\r\n        // Update progress\r\n        const currentProgress = this.activeProcesses.get(processId)!;\r\n        currentProgress.processedRows = Math.min(i + batchSize, dataRows.length);\r\n        currentProgress.progress = (currentProgress.processedRows / currentProgress.totalRows) * 100;\r\n\r\n        // Calculate estimated time remaining\r\n        if (currentProgress.processedRows > 0) {\r\n          const elapsed = Date.now() - new Date(currentProgress.startTime).getTime();\r\n          const rate = currentProgress.processedRows / elapsed;\r\n          const remaining = (currentProgress.totalRows - currentProgress.processedRows) / rate;\r\n          currentProgress.estimatedTimeRemaining = Math.round(remaining);\r\n        }\r\n\r\n        this.activeProcesses.set(processId, currentProgress);\r\n        this.emit('progress', currentProgress);\r\n\r\n        // Small delay to prevent overwhelming the database\r\n        await new Promise(resolve => setTimeout(resolve, 10));\r\n      }\r\n\r\n      // Mark as completed\r\n      progress.status = 'completed';\r\n      progress.endTime = new Date().toISOString();\r\n      progress.progress = 100;\r\n      this.activeProcesses.set(processId, progress);\r\n      this.emit('progress', progress);\r\n      this.emit('completed', progress);\r\n\r\n      console.log(`✅ XLSX processing completed: ${progress.successfulRows}/${progress.totalRows} rows successful`);\r\n\r\n    } catch (error) {\r\n      console.error('❌ XLSX processing error:', error);\r\n      progress.status = 'error';\r\n      progress.errors.push({\r\n        row: 0,\r\n        error: error instanceof Error ? error.message : 'Unknown error'\r\n      });\r\n      progress.endTime = new Date().toISOString();\r\n      this.activeProcesses.set(processId, progress);\r\n      this.emit('progress', progress);\r\n      this.emit('error', progress);\r\n    }\r\n\r\n    return { processId, progress };\r\n  }\r\n\r\n  /**\r\n   * Process batch of rows\r\n   */\r\n  private async processBatch(\r\n    batch: any[][],\r\n    headers: string[],\r\n    options: XLSXProcessingOptions,\r\n    validationRules: ValidationRule[],\r\n    processId: string,\r\n    startIndex: number\r\n  ): Promise<void> {\r\n    const progress = this.activeProcesses.get(processId)!;\r\n\r\n    for (let i = 0; i < batch.length; i++) {\r\n      const rowIndex = startIndex + i + 1; // +1 for header row\r\n      const rowData = batch[i];\r\n\r\n      try {\r\n        // Convert row array to object\r\n        const record: any = {};\r\n        headers.forEach((header, index) => {\r\n          if (header && rowData[index] !== undefined) {\r\n            record[header.toLowerCase().replace(/\\s+/g, '_')] = rowData[index];\r\n          }\r\n        });\r\n\r\n        // Add metadata\r\n        record.organization_id = options.organizationId;\r\n        record.created_by = options.userId;\r\n        record.imported_at = new Date().toISOString();\r\n        record.import_batch_id = processId;\r\n\r\n        // Validate data\r\n        if (options.validateData) {\r\n          const validationErrors = this.validateRecord(record, validationRules);\r\n          if (validationErrors.length > 0) {\r\n            validationErrors.forEach(error => {\r\n              progress.errors.push({\r\n                row: rowIndex,\r\n                column: error.column,\r\n                error: error.error,\r\n                data: record\r\n              });\r\n            });\r\n            progress.errorRows++;\r\n            continue;\r\n          }\r\n        }\r\n\r\n        // Insert or update record\r\n        if (options.updateExisting) {\r\n          await this.upsertRecord(record, options.targetTable);\r\n        } else {\r\n          await this.insertRecord(record, options.targetTable);\r\n        }\r\n\r\n        progress.successfulRows++;\r\n\r\n        // Emit real-time notification for successful insert\r\n        await this.notifyRecordProcessed(options.targetTable, record, 'INSERT');\r\n\r\n      } catch (error) {\r\n        console.error(`❌ Error processing row ${rowIndex}:`, error);\r\n        progress.errors.push({\r\n          row: rowIndex,\r\n          error: error instanceof Error ? error.message : 'Unknown error',\r\n          data: batch[i]\r\n        });\r\n        progress.errorRows++;\r\n      }\r\n    }\r\n\r\n    this.activeProcesses.set(processId, progress);\r\n  }\r\n\r\n  /**\r\n   * Validate record against rules\r\n   */\r\n  private validateRecord(record: any, rules: ValidationRule[]): ProcessingError[] {\r\n    const errors: ProcessingError[] = [];\r\n\r\n    for (const rule of rules) {\r\n      const value = record[rule.column];\r\n\r\n      // Required field check\r\n      if (rule.required && (value === null || value === undefined || value === '')) {\r\n        errors.push({\r\n          row: 0,\r\n          column: rule.column,\r\n          error: `Field '${rule.column}' is required`\r\n        });\r\n        continue;\r\n      }\r\n\r\n      // Skip validation if value is empty and not required\r\n      if (value === null || value === undefined || value === '') {\r\n        continue;\r\n      }\r\n\r\n      // Type validation\r\n      if (rule.type && !this.validateType(value, rule.type)) {\r\n        errors.push({\r\n          row: 0,\r\n          column: rule.column,\r\n          error: `Invalid ${rule.type} format for field '${rule.column}'`\r\n        });\r\n        continue;\r\n      }\r\n\r\n      // Length validation\r\n      if (rule.minLength && String(value).length < rule.minLength) {\r\n        errors.push({\r\n          row: 0,\r\n          column: rule.column,\r\n          error: `Field '${rule.column}' must be at least ${rule.minLength} characters`\r\n        });\r\n      }\r\n\r\n      if (rule.maxLength && String(value).length > rule.maxLength) {\r\n        errors.push({\r\n          row: 0,\r\n          column: rule.column,\r\n          error: `Field '${rule.column}' must be at most ${rule.maxLength} characters`\r\n        });\r\n      }\r\n\r\n      // Pattern validation\r\n      if (rule.pattern && !rule.pattern.test(String(value))) {\r\n        errors.push({\r\n          row: 0,\r\n          column: rule.column,\r\n          error: `Field '${rule.column}' does not match required pattern`\r\n        });\r\n      }\r\n\r\n      // Allowed values validation\r\n      if (rule.allowedValues && !rule.allowedValues.includes(value)) {\r\n        errors.push({\r\n          row: 0,\r\n          column: rule.column,\r\n          error: `Field '${rule.column}' must be one of: ${rule.allowedValues.join(', ')}`\r\n        });\r\n      }\r\n\r\n      // Custom validation\r\n      if (rule.customValidator) {\r\n        const validationResult = rule.customValidator(value);\r\n        if (validationResult !== true) {\r\n          errors.push({\r\n            row: 0,\r\n            column: rule.column,\r\n            error: typeof validationResult === 'string' ? validationResult : `Custom validation failed for field '${rule.column}'`\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return errors;\r\n  }\r\n\r\n  /**\r\n   * Validate data type\r\n   */\r\n  private validateType(value: any, type: string): boolean {\r\n    switch (type) {\r\n      case 'string':\r\n        return typeof value === 'string';\r\n      case 'number':\r\n        return !isNaN(Number(value));\r\n      case 'date':\r\n        return !isNaN(Date.parse(value));\r\n      case 'email':\r\n        return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(String(value));\r\n      case 'phone':\r\n        return /^[\\+]?[(]?[\\d\\s\\-\\(\\)]{10,}$/.test(String(value));\r\n      default:\r\n        return true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Insert record into database\r\n   */\r\n  private async insertRecord(record: any, tableName: string): Promise<void> {\r\n    const fields = Object.keys(record);\r\n    const values = Object.values(record);\r\n    const placeholders = values.map((_, index) => `$${index + 1}`).join(', ');\r\n\r\n    const query = `\r\n      INSERT INTO ${tableName} (${fields.join(', ')})\r\n      VALUES (${placeholders})\r\n    `;\r\n\r\n    await db.query(query, values);\r\n  }\r\n\r\n  /**\r\n   * Upsert record (insert or update if exists)\r\n   */\r\n  private async upsertRecord(record: any, tableName: string): Promise<void> {\r\n    const fields = Object.keys(record);\r\n    const values = Object.values(record);\r\n    const placeholders = values.map((_, index) => `$${index + 1}`).join(', ');\r\n    const updateClause = fields.map(field => `${field} = EXCLUDED.${field}`).join(', ');\r\n\r\n    const query = `\r\n      INSERT INTO ${tableName} (${fields.join(', ')})\r\n      VALUES (${placeholders})\r\n      ON CONFLICT (id) DO UPDATE SET ${updateClause}\r\n    `;\r\n\r\n    await db.query(query, values);\r\n  }\r\n\r\n  /**\r\n   * Notify about processed record\r\n   */\r\n  private async notifyRecordProcessed(tableName: string, record: any, operation: string): Promise<void> {\r\n    const payload = JSON.stringify({\r\n      operation,\r\n      table: tableName,\r\n      record,\r\n      timestamp: new Date().toISOString(),\r\n      source: 'xlsx_import'\r\n    });\r\n\r\n    await db.query(`NOTIFY table_changes, '${payload}'`);\r\n  }\r\n\r\n  /**\r\n   * Get processing status\r\n   */\r\n  getProcessingStatus(processId: string): ProcessingProgress | null {\r\n    return this.activeProcesses.get(processId) || null;\r\n  }\r\n\r\n  /**\r\n   * Get all active processes\r\n   */\r\n  getAllActiveProcesses(): ProcessingProgress[] {\r\n    return Array.from(this.activeProcesses.values());\r\n  }\r\n\r\n  /**\r\n   * Cancel processing\r\n   */\r\n  cancelProcessing(processId: string): boolean {\r\n    const progress = this.activeProcesses.get(processId);\r\n    if (progress && progress.status === 'processing') {\r\n      progress.status = 'error';\r\n      progress.endTime = new Date().toISOString();\r\n      progress.errors.push({\r\n        row: 0,\r\n        error: 'Processing cancelled by user'\r\n      });\r\n      this.activeProcesses.set(processId, progress);\r\n      this.emit('cancelled', progress);\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Clean up completed processes\r\n   */\r\n  cleanupCompletedProcesses(olderThanHours: number = 24): void {\r\n    const cutoff = Date.now() - (olderThanHours * 60 * 60 * 1000);\r\n\r\n    for (const [processId, progress] of this.activeProcesses) {\r\n      if (progress.status === 'completed' || progress.status === 'error') {\r\n        const processTime = new Date(progress.startTime).getTime();\r\n        if (processTime < cutoff) {\r\n          this.activeProcesses.delete(processId);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate unique process ID\r\n   */\r\n  private generateProcessId(): string {\r\n    return `xlsx-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const xlsxProcessor = new XLSXProcessor();\r\n\r\nexport default xlsxProcessor;","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\notifications\\live-notifications.ts","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":441,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":446,"endColumn":15,"suggestions":[{"messageId":"addBrackets","fix":{"range":[12916,13335],"text":"{ const roleQuery = `\r\n              SELECT u.id FROM users u\r\n              JOIN user_roles ur ON u.id = ur.user_id\r\n              JOIN roles r ON ur.role_id = r.id\r\n              WHERE r.name = $1 AND u.organization_id = $2\r\n            `;\r\n            const roleResult = await db.query(roleQuery, [recipient.value, organizationId]);\r\n            userIds.push(...roleResult.rows.map(row => row.id));\r\n            break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":447,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":447,"endColumn":93,"suggestions":[{"messageId":"addBrackets","fix":{"range":[12916,13335],"text":"{ const roleQuery = `\r\n              SELECT u.id FROM users u\r\n              JOIN user_roles ur ON u.id = ur.user_id\r\n              JOIN roles r ON ur.role_id = r.id\r\n              WHERE r.name = $1 AND u.organization_id = $2\r\n            `;\r\n            const roleResult = await db.query(roleQuery, [recipient.value, organizationId]);\r\n            userIds.push(...roleResult.rows.map(row => row.id));\r\n            break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":452,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":455,"endColumn":15,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13376,13688],"text":"{ const emailQuery = `\r\n              SELECT id FROM users\r\n              WHERE email = $1 AND organization_id = $2\r\n            `;\r\n            const emailResult = await db.query(emailQuery, [recipient.value, organizationId]);\r\n            userIds.push(...emailResult.rows.map(row => row.id));\r\n            break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":456,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":456,"endColumn":95,"suggestions":[{"messageId":"addBrackets","fix":{"range":[13376,13688],"text":"{ const emailQuery = `\r\n              SELECT id FROM users\r\n              WHERE email = $1 AND organization_id = $2\r\n            `;\r\n            const emailResult = await db.query(emailQuery, [recipient.value, organizationId]);\r\n            userIds.push(...emailResult.rows.map(row => row.id));\r\n            break; }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Live Notification System\r\n * Real-time alerts and messaging with database integration\r\n */\r\n\r\nimport { EventEmitter } from 'events';\r\nimport { db } from '../database';\r\nimport { realtimeServer } from '../realtime/websocket-server';\r\n\r\nexport interface Notification {\r\n  id: string;\r\n  userId: string;\r\n  organizationId: string;\r\n  type: 'info' | 'success' | 'warning' | 'error';\r\n  title: string;\r\n  message: string;\r\n  data?: any;\r\n  read: boolean;\r\n  priority: 'low' | 'medium' | 'high' | 'urgent';\r\n  channels: NotificationChannel[];\r\n  scheduledAt?: string;\r\n  expiresAt?: string;\r\n  createdAt: string;\r\n  readAt?: string;\r\n}\r\n\r\nexport interface NotificationChannel {\r\n  type: 'in_app' | 'email' | 'sms' | 'push' | 'webhook';\r\n  target: string;\r\n  status: 'pending' | 'sent' | 'delivered' | 'failed';\r\n  sentAt?: string;\r\n  deliveredAt?: string;\r\n  error?: string;\r\n}\r\n\r\nexport interface NotificationRule {\r\n  id: string;\r\n  organizationId: string;\r\n  name: string;\r\n  description: string;\r\n  trigger: NotificationTrigger;\r\n  conditions: NotificationCondition[];\r\n  actions: NotificationAction[];\r\n  enabled: boolean;\r\n  priority: 'low' | 'medium' | 'high' | 'urgent';\r\n  rateLimiting?: RateLimitConfig;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nexport interface NotificationTrigger {\r\n  type: 'database_change' | 'schedule' | 'api_event' | 'threshold' | 'manual';\r\n  table?: string;\r\n  operation?: 'INSERT' | 'UPDATE' | 'DELETE';\r\n  schedule?: string; // Cron expression\r\n  event?: string;\r\n  threshold?: ThresholdConfig;\r\n}\r\n\r\nexport interface NotificationCondition {\r\n  field: string;\r\n  operator: 'equals' | 'not_equals' | 'greater_than' | 'less_than' | 'contains' | 'regex';\r\n  value: any;\r\n}\r\n\r\nexport interface NotificationAction {\r\n  type: 'send_notification' | 'create_task' | 'send_email' | 'call_webhook';\r\n  template: string;\r\n  channels: string[];\r\n  recipients: NotificationRecipient[];\r\n  data?: any;\r\n}\r\n\r\nexport interface NotificationRecipient {\r\n  type: 'user' | 'role' | 'email' | 'phone';\r\n  value: string;\r\n}\r\n\r\nexport interface ThresholdConfig {\r\n  metric: string;\r\n  value: number;\r\n  comparison: 'greater_than' | 'less_than' | 'equals';\r\n  duration?: number; // seconds\r\n}\r\n\r\nexport interface RateLimitConfig {\r\n  maxNotifications: number;\r\n  windowMs: number;\r\n  perUser?: boolean;\r\n}\r\n\r\nexport class LiveNotificationSystem extends EventEmitter {\r\n  private notificationRules: Map<string, NotificationRule> = new Map();\r\n  private rateLimitCounters: Map<string, { count: number; resetTime: number }> = new Map();\r\n\r\n  constructor() {\r\n    super();\r\n    this.initialize();\r\n  }\r\n\r\n  /**\r\n   * Initialize notification system\r\n   */\r\n  private async initialize(): Promise<void> {\r\n    try {\r\n      // Load notification rules from database\r\n      await this.loadNotificationRules();\r\n\r\n      // Listen to database changes for rule triggers\r\n      await this.setupDatabaseTriggers();\r\n\r\n      // Setup scheduled notifications\r\n      await this.setupScheduledNotifications();\r\n\r\n      console.log('🔔 Live notification system initialized');\r\n\r\n    } catch (error) {\r\n      console.error('❌ Failed to initialize notification system:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Load notification rules from database\r\n   */\r\n  private async loadNotificationRules(): Promise<void> {\r\n    const query = `\r\n      SELECT * FROM notification_rules\r\n      WHERE enabled = true\r\n      ORDER BY priority DESC, created_at ASC\r\n    `;\r\n\r\n    const result = await db.query(query);\r\n\r\n    for (const row of result.rows) {\r\n      const rule: NotificationRule = {\r\n        id: row.id,\r\n        organizationId: row.organization_id,\r\n        name: row.name,\r\n        description: row.description,\r\n        trigger: JSON.parse(row.trigger),\r\n        conditions: JSON.parse(row.conditions || '[]'),\r\n        actions: JSON.parse(row.actions),\r\n        enabled: row.enabled,\r\n        priority: row.priority,\r\n        rateLimiting: row.rate_limiting ? JSON.parse(row.rate_limiting) : undefined,\r\n        createdAt: row.created_at,\r\n        updatedAt: row.updated_at\r\n      };\r\n\r\n      this.notificationRules.set(rule.id, rule);\r\n    }\r\n\r\n    console.log(`📋 Loaded ${this.notificationRules.size} notification rules`);\r\n  }\r\n\r\n  /**\r\n   * Setup database change triggers\r\n   */\r\n  private async setupDatabaseTriggers(): Promise<void> {\r\n    // Listen for table changes\r\n    await db.listen('table_changes', (payload) => {\r\n      try {\r\n        const change = JSON.parse(payload);\r\n        this.handleDatabaseChange(change);\r\n      } catch (error) {\r\n        console.error('❌ Error processing database change:', error);\r\n      }\r\n    });\r\n\r\n    console.log('🔔 Database triggers setup complete');\r\n  }\r\n\r\n  /**\r\n   * Handle database changes and check notification rules\r\n   */\r\n  private async handleDatabaseChange(change: any): Promise<void> {\r\n    const { operation, table, record } = change;\r\n\r\n    // Find matching rules\r\n    const matchingRules = Array.from(this.notificationRules.values()).filter(rule =>\r\n      rule.trigger.type === 'database_change' &&\r\n      rule.trigger.table === table &&\r\n      (!rule.trigger.operation || rule.trigger.operation === operation)\r\n    );\r\n\r\n    for (const rule of matchingRules) {\r\n      try {\r\n        // Check conditions\r\n        if (await this.evaluateConditions(rule.conditions, record)) {\r\n          // Check rate limiting\r\n          if (await this.checkRateLimit(rule, record.organization_id || '', record.user_id || '')) {\r\n            // Execute actions\r\n            await this.executeActions(rule, { change, record });\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error(`❌ Error processing rule ${rule.id}:`, error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Evaluate notification conditions\r\n   */\r\n  private async evaluateConditions(conditions: NotificationCondition[], data: any): Promise<boolean> {\r\n    if (conditions.length === 0) return true;\r\n\r\n    for (const condition of conditions) {\r\n      const fieldValue = data[condition.field];\r\n\r\n      const result = this.evaluateCondition(fieldValue, condition.operator, condition.value);\r\n      if (!result) return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Evaluate single condition\r\n   */\r\n  private evaluateCondition(fieldValue: any, operator: string, expectedValue: any): boolean {\r\n    switch (operator) {\r\n      case 'equals':\r\n        return fieldValue === expectedValue;\r\n      case 'not_equals':\r\n        return fieldValue !== expectedValue;\r\n      case 'greater_than':\r\n        return Number(fieldValue) > Number(expectedValue);\r\n      case 'less_than':\r\n        return Number(fieldValue) < Number(expectedValue);\r\n      case 'contains':\r\n        return String(fieldValue).includes(String(expectedValue));\r\n      case 'regex':\r\n        return new RegExp(expectedValue).test(String(fieldValue));\r\n      default:\r\n        return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check rate limiting\r\n   */\r\n  private async checkRateLimit(rule: NotificationRule, organizationId: string, userId: string): Promise<boolean> {\r\n    if (!rule.rateLimiting) return true;\r\n\r\n    const key = rule.rateLimiting.perUser\r\n      ? `${rule.id}:${userId}`\r\n      : `${rule.id}:${organizationId}`;\r\n\r\n    const now = Date.now();\r\n    const counter = this.rateLimitCounters.get(key);\r\n\r\n    if (!counter || now > counter.resetTime) {\r\n      // Reset or create counter\r\n      this.rateLimitCounters.set(key, {\r\n        count: 1,\r\n        resetTime: now + rule.rateLimiting.windowMs\r\n      });\r\n      return true;\r\n    }\r\n\r\n    if (counter.count >= rule.rateLimiting.maxNotifications) {\r\n      console.log(`⚠️ Rate limit exceeded for rule ${rule.id}`);\r\n      return false;\r\n    }\r\n\r\n    counter.count++;\r\n    this.rateLimitCounters.set(key, counter);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Execute notification actions\r\n   */\r\n  private async executeActions(rule: NotificationRule, context: any): Promise<void> {\r\n    for (const action of rule.actions) {\r\n      try {\r\n        switch (action.type) {\r\n          case 'send_notification':\r\n            await this.sendNotification(rule, action, context);\r\n            break;\r\n          case 'send_email':\r\n            await this.sendEmail(rule, action, context);\r\n            break;\r\n          case 'call_webhook':\r\n            await this.callWebhook(rule, action, context);\r\n            break;\r\n          case 'create_task':\r\n            await this.createTask(rule, action, context);\r\n            break;\r\n          default:\r\n            console.warn(`Unknown action type: ${action.type}`);\r\n        }\r\n      } catch (error) {\r\n        console.error(`❌ Error executing action ${action.type}:`, error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Send in-app notification\r\n   */\r\n  private async sendNotification(rule: NotificationRule, action: NotificationAction, context: any): Promise<void> {\r\n    const { record } = context;\r\n\r\n    // Process template\r\n    const title = this.processTemplate(action.template, context);\r\n    const message = this.processTemplate(action.data?.message || '', context);\r\n\r\n    // Get recipients\r\n    const recipients = await this.resolveRecipients(action.recipients, rule.organizationId);\r\n\r\n    for (const recipient of recipients) {\r\n      const notification: Notification = {\r\n        id: this.generateNotificationId(),\r\n        userId: recipient,\r\n        organizationId: rule.organizationId,\r\n        type: this.mapPriorityToType(rule.priority),\r\n        title,\r\n        message,\r\n        data: action.data || {},\r\n        read: false,\r\n        priority: rule.priority,\r\n        channels: action.channels.map(channel => ({\r\n          type: channel as any,\r\n          target: recipient,\r\n          status: 'pending'\r\n        })),\r\n        createdAt: new Date().toISOString()\r\n      };\r\n\r\n      // Save to database\r\n      await this.saveNotification(notification);\r\n\r\n      // Send real-time notification\r\n      await this.sendRealTimeNotification(notification);\r\n\r\n      // Emit event\r\n      this.emit('notification_sent', notification);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Send email notification\r\n   */\r\n  private async sendEmail(rule: NotificationRule, action: NotificationAction, context: any): Promise<void> {\r\n    // Email sending logic would go here\r\n    console.log(`📧 Sending email notification for rule ${rule.id}`);\r\n  }\r\n\r\n  /**\r\n   * Call webhook\r\n   */\r\n  private async callWebhook(rule: NotificationRule, action: NotificationAction, context: any): Promise<void> {\r\n    // Webhook calling logic would go here\r\n    console.log(`🔗 Calling webhook for rule ${rule.id}`);\r\n  }\r\n\r\n  /**\r\n   * Create task\r\n   */\r\n  private async createTask(rule: NotificationRule, action: NotificationAction, context: any): Promise<void> {\r\n    // Task creation logic would go here\r\n    console.log(`📋 Creating task for rule ${rule.id}`);\r\n  }\r\n\r\n  /**\r\n   * Save notification to database\r\n   */\r\n  private async saveNotification(notification: Notification): Promise<void> {\r\n    const query = `\r\n      INSERT INTO notifications (\r\n        id, user_id, organization_id, type, title, message, data,\r\n        read, priority, channels, created_at\r\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)\r\n    `;\r\n\r\n    await db.query(query, [\r\n      notification.id,\r\n      notification.userId,\r\n      notification.organizationId,\r\n      notification.type,\r\n      notification.title,\r\n      notification.message,\r\n      JSON.stringify(notification.data),\r\n      notification.read,\r\n      notification.priority,\r\n      JSON.stringify(notification.channels),\r\n      notification.createdAt\r\n    ]);\r\n  }\r\n\r\n  /**\r\n   * Send real-time notification via WebSocket\r\n   */\r\n  private async sendRealTimeNotification(notification: Notification): Promise<void> {\r\n    realtimeServer.broadcast({\r\n      type: 'data',\r\n      data: {\r\n        type: 'notification',\r\n        notification\r\n      },\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Process template with context variables\r\n   */\r\n  private processTemplate(template: string, context: any): string {\r\n    return template.replace(/\\{\\{([^}]+)\\}\\}/g, (match, variable) => {\r\n      const keys = variable.trim().split('.');\r\n      let value = context;\r\n\r\n      for (const key of keys) {\r\n        if (value && typeof value === 'object' && key in value) {\r\n          value = value[key];\r\n        } else {\r\n          return match; // Return original if variable not found\r\n        }\r\n      }\r\n\r\n      return String(value);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Resolve recipients from recipient configurations\r\n   */\r\n  private async resolveRecipients(recipients: NotificationRecipient[], organizationId: string): Promise<string[]> {\r\n    const userIds: string[] = [];\r\n\r\n    for (const recipient of recipients) {\r\n      try {\r\n        switch (recipient.type) {\r\n          case 'user':\r\n            userIds.push(recipient.value);\r\n            break;\r\n\r\n          case 'role':\r\n            const roleQuery = `\r\n              SELECT u.id FROM users u\r\n              JOIN user_roles ur ON u.id = ur.user_id\r\n              JOIN roles r ON ur.role_id = r.id\r\n              WHERE r.name = $1 AND u.organization_id = $2\r\n            `;\r\n            const roleResult = await db.query(roleQuery, [recipient.value, organizationId]);\r\n            userIds.push(...roleResult.rows.map(row => row.id));\r\n            break;\r\n\r\n          case 'email':\r\n            const emailQuery = `\r\n              SELECT id FROM users\r\n              WHERE email = $1 AND organization_id = $2\r\n            `;\r\n            const emailResult = await db.query(emailQuery, [recipient.value, organizationId]);\r\n            userIds.push(...emailResult.rows.map(row => row.id));\r\n            break;\r\n\r\n          default:\r\n            console.warn(`Unknown recipient type: ${recipient.type}`);\r\n        }\r\n      } catch (error) {\r\n        console.error(`❌ Error resolving recipient ${recipient.value}:`, error);\r\n      }\r\n    }\r\n\r\n    return [...new Set(userIds)]; // Remove duplicates\r\n  }\r\n\r\n  /**\r\n   * Map priority to notification type\r\n   */\r\n  private mapPriorityToType(priority: string): 'info' | 'success' | 'warning' | 'error' {\r\n    switch (priority) {\r\n      case 'urgent':\r\n        return 'error';\r\n      case 'high':\r\n        return 'warning';\r\n      case 'medium':\r\n        return 'info';\r\n      case 'low':\r\n        return 'success';\r\n      default:\r\n        return 'info';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setup scheduled notifications\r\n   */\r\n  private async setupScheduledNotifications(): Promise<void> {\r\n    // Scheduled notification logic would go here\r\n    console.log('⏰ Scheduled notifications setup complete');\r\n  }\r\n\r\n  /**\r\n   * Generate notification ID\r\n   */\r\n  private generateNotificationId(): string {\r\n    return `notif-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  /**\r\n   * Get notifications for user\r\n   */\r\n  async getUserNotifications(\r\n    userId: string,\r\n    organizationId: string,\r\n    options: { page?: number; limit?: number; unreadOnly?: boolean } = {}\r\n  ): Promise<{ notifications: Notification[]; total: number }> {\r\n    const { page = 1, limit = 50, unreadOnly = false } = options;\r\n    const offset = (page - 1) * limit;\r\n\r\n    const whereClause = unreadOnly\r\n      ? 'WHERE user_id = $1 AND organization_id = $2 AND read = false'\r\n      : 'WHERE user_id = $1 AND organization_id = $2';\r\n\r\n    const countQuery = `SELECT COUNT(*) as total FROM notifications ${whereClause}`;\r\n    const dataQuery = `\r\n      SELECT * FROM notifications\r\n      ${whereClause}\r\n      ORDER BY created_at DESC\r\n      LIMIT $3 OFFSET $4\r\n    `;\r\n\r\n    const [countResult, dataResult] = await Promise.all([\r\n      db.query(countQuery, [userId, organizationId]),\r\n      db.query(dataQuery, [userId, organizationId, limit, offset])\r\n    ]);\r\n\r\n    const notifications = dataResult.rows.map(row => ({\r\n      id: row.id,\r\n      userId: row.user_id,\r\n      organizationId: row.organization_id,\r\n      type: row.type,\r\n      title: row.title,\r\n      message: row.message,\r\n      data: JSON.parse(row.data || '{}'),\r\n      read: row.read,\r\n      priority: row.priority,\r\n      channels: JSON.parse(row.channels || '[]'),\r\n      scheduledAt: row.scheduled_at,\r\n      expiresAt: row.expires_at,\r\n      createdAt: row.created_at,\r\n      readAt: row.read_at\r\n    }));\r\n\r\n    return {\r\n      notifications,\r\n      total: parseInt(countResult.rows[0].total)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Mark notification as read\r\n   */\r\n  async markAsRead(notificationId: string, userId: string): Promise<boolean> {\r\n    try {\r\n      const query = `\r\n        UPDATE notifications\r\n        SET read = true, read_at = NOW()\r\n        WHERE id = $1 AND user_id = $2\r\n      `;\r\n\r\n      const result = await db.query(query, [notificationId, userId]);\r\n      return result.rowCount ? result.rowCount > 0 : false;\r\n\r\n    } catch (error) {\r\n      console.error('❌ Error marking notification as read:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create manual notification\r\n   */\r\n  async createManualNotification(notification: Omit<Notification, 'id' | 'createdAt'>): Promise<string> {\r\n    const fullNotification: Notification = {\r\n      ...notification,\r\n      id: this.generateNotificationId(),\r\n      createdAt: new Date().toISOString()\r\n    };\r\n\r\n    await this.saveNotification(fullNotification);\r\n    await this.sendRealTimeNotification(fullNotification);\r\n\r\n    this.emit('notification_sent', fullNotification);\r\n\r\n    return fullNotification.id;\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const liveNotifications = new LiveNotificationSystem();\r\n\r\nexport default liveNotifications;","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\offline-manager.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'Worker' is not defined.","line":41,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":41,"endColumn":29},{"ruleId":"no-undef","severity":2,"message":"'CustomEvent' is not defined.","line":92,"column":30,"nodeType":"Identifier","messageId":"undef","endLine":92,"endColumn":41},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":314,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":314,"endColumn":37},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":326,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":326,"endColumn":36},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":339,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":339,"endColumn":19},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":347,"column":7,"nodeType":"Identifier","messageId":"undef","endLine":347,"endColumn":19},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":378,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":378,"endColumn":17},{"ruleId":"no-undef","severity":2,"message":"'localStorage' is not defined.","line":384,"column":5,"nodeType":"Identifier","messageId":"undef","endLine":384,"endColumn":17}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Enhanced Offline Manager with Caching and Background Sync\r\n * Provides comprehensive offline support and intelligent caching strategies\r\n */\r\n\r\nimport { QueryClient } from '@tanstack/react-query';\r\n\r\nexport interface OfflineConfig {\r\n  enableOfflineSupport: boolean;\r\n  maxCacheAge: number; // in milliseconds\r\n  maxCacheSize: number; // in MB\r\n  syncInterval: number; // in milliseconds\r\n  enableBackgroundSync: boolean;\r\n  criticalEndpoints: string[];\r\n}\r\n\r\nexport interface CacheEntry {\r\n  key: string;\r\n  data: any;\r\n  timestamp: number;\r\n  expiry: number;\r\n  priority: 'low' | 'medium' | 'high' | 'critical';\r\n  size: number; // in bytes\r\n}\r\n\r\nexport interface SyncOperation {\r\n  id: string;\r\n  endpoint: string;\r\n  method: 'GET' | 'POST' | 'PUT' | 'DELETE';\r\n  data?: any;\r\n  timestamp: number;\r\n  retryCount: number;\r\n  maxRetries: number;\r\n}\r\n\r\nclass OfflineManager {\r\n  private config: OfflineConfig;\r\n  private cache: Map<string, CacheEntry> = new Map();\r\n  private syncQueue: SyncOperation[] = [];\r\n  private isOnline: boolean = navigator.onLine;\r\n  private syncWorker: Worker | null = null;\r\n  private queryClient: QueryClient | null = null;\r\n\r\n  constructor(config: Partial<OfflineConfig> = {}) {\r\n    this.config = {\r\n      enableOfflineSupport: true,\r\n      maxCacheAge: 24 * 60 * 60 * 1000, // 24 hours\r\n      maxCacheSize: 50, // 50MB\r\n      syncInterval: 30 * 1000, // 30 seconds\r\n      enableBackgroundSync: true,\r\n      criticalEndpoints: ['/api/alerts', '/api/dashboard', '/api/inventory'],\r\n      ...config\r\n    };\r\n\r\n    this.initializeOfflineSupport();\r\n  }\r\n\r\n  private initializeOfflineSupport() {\r\n    if (!this.config.enableOfflineSupport) return;\r\n\r\n    // Listen to online/offline events\r\n    window.addEventListener('online', this.handleOnline.bind(this));\r\n    window.addEventListener('offline', this.handleOffline.bind(this));\r\n\r\n    // Load cached data from localStorage\r\n    this.loadCacheFromStorage();\r\n\r\n    // Initialize background sync if supported\r\n    if (this.config.enableBackgroundSync && 'serviceWorker' in navigator) {\r\n      this.initializeServiceWorker();\r\n    }\r\n\r\n    // Start periodic sync\r\n    this.startPeriodicSync();\r\n  }\r\n\r\n  private handleOnline() {\r\n    console.log('🌐 Connection restored - processing offline queue');\r\n    this.isOnline = true;\r\n    this.processSyncQueue();\r\n    this.notifyConnectionChange(true);\r\n  }\r\n\r\n  private handleOffline() {\r\n    console.log('📡 Connection lost - entering offline mode');\r\n    this.isOnline = false;\r\n    this.notifyConnectionChange(false);\r\n  }\r\n\r\n  private notifyConnectionChange(isOnline: boolean) {\r\n    // Dispatch custom event for components to listen to\r\n    window.dispatchEvent(new CustomEvent('connectionChange', {\r\n      detail: { isOnline }\r\n    }));\r\n\r\n    // Invalidate queries if we're back online\r\n    if (isOnline && this.queryClient) {\r\n      this.queryClient.invalidateQueries();\r\n    }\r\n  }\r\n\r\n  public setQueryClient(queryClient: QueryClient) {\r\n    this.queryClient = queryClient;\r\n  }\r\n\r\n  /**\r\n   * Cache management\r\n   */\r\n  public async cacheData(\r\n    key: string,\r\n    data: any,\r\n    options: {\r\n      priority?: 'low' | 'medium' | 'high' | 'critical';\r\n      ttl?: number; // time to live in milliseconds\r\n    } = {}\r\n  ): Promise<void> {\r\n    const { priority = 'medium', ttl = this.config.maxCacheAge } = options;\r\n\r\n    const entry: CacheEntry = {\r\n      key,\r\n      data: data,\r\n      timestamp: Date.now(),\r\n      expiry: Date.now() + ttl,\r\n      priority,\r\n      size: this.calculateSize(data)\r\n    };\r\n\r\n    // Check cache size limits\r\n    await this.ensureCacheCapacity(entry.size);\r\n\r\n    this.cache.set(key, entry);\r\n    await this.saveCacheToStorage();\r\n\r\n    console.log(`💾 Cached data for key: ${key} (${this.formatBytes(entry.size)})`);\r\n  }\r\n\r\n  public getCachedData(key: string): any | null {\r\n    const entry = this.cache.get(key);\r\n\r\n    if (!entry) return null;\r\n\r\n    // Check if expired\r\n    if (Date.now() > entry.expiry) {\r\n      this.cache.delete(key);\r\n      this.saveCacheToStorage();\r\n      console.log(`⏰ Cache expired for key: ${key}`);\r\n      return null;\r\n    }\r\n\r\n    console.log(`📂 Retrieved cached data for key: ${key}`);\r\n    return entry.data;\r\n  }\r\n\r\n  public isCached(key: string): boolean {\r\n    const entry = this.cache.get(key);\r\n    return entry !== undefined && Date.now() <= entry.expiry;\r\n  }\r\n\r\n  private async ensureCacheCapacity(newEntrySize: number) {\r\n    const maxSizeBytes = this.config.maxCacheSize * 1024 * 1024; // Convert MB to bytes\r\n    let currentSize = this.getCurrentCacheSize();\r\n\r\n    // If adding new entry would exceed limit, remove entries\r\n    while (currentSize + newEntrySize > maxSizeBytes && this.cache.size > 0) {\r\n      // Remove least recently used entry with lowest priority\r\n      const entryToRemove = this.findEntryToRemove();\r\n      if (entryToRemove) {\r\n        currentSize -= entryToRemove.size;\r\n        this.cache.delete(entryToRemove.key);\r\n        console.log(`🗑️ Removed cache entry: ${entryToRemove.key} (${this.formatBytes(entryToRemove.size)})`);\r\n      } else {\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private findEntryToRemove(): CacheEntry | null {\r\n    const priorities = { critical: 4, high: 3, medium: 2, low: 1 };\r\n    let oldest: CacheEntry | null = null;\r\n    let oldestScore = Infinity;\r\n\r\n    for (const entry of this.cache.values()) {\r\n      // Score based on age and priority (lower is worse)\r\n      const score = priorities[entry.priority] / (Date.now() - entry.timestamp);\r\n\r\n      if (score < oldestScore) {\r\n        oldestScore = score;\r\n        oldest = entry;\r\n      }\r\n    }\r\n\r\n    return oldest;\r\n  }\r\n\r\n  private getCurrentCacheSize(): number {\r\n    let totalSize = 0;\r\n    for (const entry of this.cache.values()) {\r\n      totalSize += entry.size;\r\n    }\r\n    return totalSize;\r\n  }\r\n\r\n  private calculateSize(data: any): number {\r\n    // Rough estimation of data size in bytes\r\n    const str = JSON.stringify(data);\r\n    return new Blob([str]).size;\r\n  }\r\n\r\n  private formatBytes(bytes: number): string {\r\n    if (bytes === 0) return '0 B';\r\n    const k = 1024;\r\n    const sizes = ['B', 'KB', 'MB', 'GB'];\r\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\r\n  }\r\n\r\n  /**\r\n   * Sync queue management\r\n   */\r\n  public addToSyncQueue(operation: Omit<SyncOperation, 'id' | 'timestamp' | 'retryCount'>): void {\r\n    const syncOp: SyncOperation = {\r\n      id: `sync_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n      timestamp: Date.now(),\r\n      retryCount: 0,\r\n      ...operation\r\n    };\r\n\r\n    this.syncQueue.push(syncOp);\r\n    console.log(`📝 Added operation to sync queue: ${syncOp.endpoint}`);\r\n\r\n    // Try to process immediately if online\r\n    if (this.isOnline) {\r\n      this.processSyncQueue();\r\n    }\r\n  }\r\n\r\n  private async processSyncQueue(): Promise<void> {\r\n    if (!this.isOnline || this.syncQueue.length === 0) return;\r\n\r\n    console.log(`🔄 Processing ${this.syncQueue.length} operations in sync queue`);\r\n\r\n    const pendingOperations = [...this.syncQueue];\r\n    this.syncQueue = [];\r\n\r\n    for (const operation of pendingOperations) {\r\n      try {\r\n        await this.executeSyncOperation(operation);\r\n        console.log(`✅ Sync operation completed: ${operation.endpoint}`);\r\n      } catch (error) {\r\n        console.error(`❌ Sync operation failed: ${operation.endpoint}`, error);\r\n\r\n        // Retry logic\r\n        if (operation.retryCount < operation.maxRetries) {\r\n          operation.retryCount++;\r\n          this.syncQueue.push(operation);\r\n          console.log(`🔄 Retrying operation: ${operation.endpoint} (${operation.retryCount}/${operation.maxRetries})`);\r\n        } else {\r\n          console.error(`💀 Max retries exceeded for operation: ${operation.endpoint}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Save updated sync queue\r\n    this.saveSyncQueueToStorage();\r\n  }\r\n\r\n  private async executeSyncOperation(operation: SyncOperation): Promise<void> {\r\n    const response = await fetch(operation.endpoint, {\r\n      method: operation.method,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: operation.data ? JSON.stringify(operation.data) : undefined,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n    }\r\n\r\n    return response.json();\r\n  }\r\n\r\n  /**\r\n   * Background sync with service worker\r\n   */\r\n  private async initializeServiceWorker(): Promise<void> {\r\n    try {\r\n      const registration = await navigator.serviceWorker.register('/sw.js');\r\n      console.log('🔧 Service Worker registered');\r\n\r\n      // Request background sync permission\r\n      if ('sync' in window.ServiceWorkerRegistration.prototype) {\r\n        registration.sync.register('background-sync');\r\n        console.log('🔄 Background sync registered');\r\n      }\r\n    } catch (error) {\r\n      console.warn('⚠️ Service Worker registration failed:', error);\r\n    }\r\n  }\r\n\r\n  private startPeriodicSync(): void {\r\n    setInterval(() => {\r\n      if (this.isOnline) {\r\n        this.processSyncQueue();\r\n      }\r\n    }, this.config.syncInterval);\r\n  }\r\n\r\n  /**\r\n   * Storage management\r\n   */\r\n  private async loadCacheFromStorage(): Promise<void> {\r\n    try {\r\n      const cacheData = localStorage.getItem('offline_cache');\r\n      if (cacheData) {\r\n        const entries: CacheEntry[] = JSON.parse(cacheData);\r\n        for (const entry of entries) {\r\n          // Only load non-expired entries\r\n          if (Date.now() <= entry.expiry) {\r\n            this.cache.set(entry.key, entry);\r\n          }\r\n        }\r\n        console.log(`📂 Loaded ${this.cache.size} cache entries from storage`);\r\n      }\r\n\r\n      const syncData = localStorage.getItem('sync_queue');\r\n      if (syncData) {\r\n        this.syncQueue = JSON.parse(syncData);\r\n        console.log(`📝 Loaded ${this.syncQueue.length} sync operations from storage`);\r\n      }\r\n    } catch (error) {\r\n      console.warn('⚠️ Failed to load offline data from storage:', error);\r\n    }\r\n  }\r\n\r\n  private async saveCacheToStorage(): Promise<void> {\r\n    try {\r\n      const entries = Array.from(this.cache.values());\r\n      localStorage.setItem('offline_cache', JSON.stringify(entries));\r\n    } catch (error) {\r\n      console.warn('⚠️ Failed to save cache to storage:', error);\r\n    }\r\n  }\r\n\r\n  private async saveSyncQueueToStorage(): Promise<void> {\r\n    try {\r\n      localStorage.setItem('sync_queue', JSON.stringify(this.syncQueue));\r\n    } catch (error) {\r\n      console.warn('⚠️ Failed to save sync queue to storage:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Public API\r\n   */\r\n  public getStatus() {\r\n    return {\r\n      isOnline: this.isOnline,\r\n      cacheEntries: this.cache.size,\r\n      cacheSize: this.formatBytes(this.getCurrentCacheSize()),\r\n      syncQueueLength: this.syncQueue.length,\r\n      lastSync: this.getLastSyncTime()\r\n    };\r\n  }\r\n\r\n  private getLastSyncTime(): string | null {\r\n    if (this.syncQueue.length === 0) return null;\r\n\r\n    const lastOp = this.syncQueue.reduce((latest, op) =>\r\n      op.timestamp > latest.timestamp ? op : latest\r\n    );\r\n\r\n    return new Date(lastOp.timestamp).toISOString();\r\n  }\r\n\r\n  public clearCache(): void {\r\n    this.cache.clear();\r\n    localStorage.removeItem('offline_cache');\r\n    console.log('🗑️ Cache cleared');\r\n  }\r\n\r\n  public clearSyncQueue(): void {\r\n    this.syncQueue = [];\r\n    localStorage.removeItem('sync_queue');\r\n    console.log('🗑️ Sync queue cleared');\r\n  }\r\n\r\n  /**\r\n   * Prefetch critical data\r\n   */\r\n  public async prefetchCriticalData(): Promise<void> {\r\n    if (!this.isOnline) return;\r\n\r\n    console.log('🔄 Prefetching critical data...');\r\n\r\n    for (const endpoint of this.config.criticalEndpoints) {\r\n      try {\r\n        const response = await fetch(endpoint);\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          await this.cacheData(endpoint, data, { priority: 'critical' });\r\n        }\r\n      } catch (error) {\r\n        console.warn(`⚠️ Failed to prefetch ${endpoint}:`, error);\r\n      }\r\n    }\r\n\r\n    console.log('✅ Critical data prefetch completed');\r\n  }\r\n}\r\n\r\n// Create singleton instance\r\nexport const offlineManager = new OfflineManager();\r\n\r\n// Hook for using offline manager in React components\r\nexport const useOfflineManager = () => {\r\n  const [status, setStatus] = React.useState(offlineManager.getStatus());\r\n\r\n  React.useEffect(() => {\r\n    const updateStatus = () => setStatus(offlineManager.getStatus());\r\n\r\n    window.addEventListener('connectionChange', updateStatus);\r\n    const interval = setInterval(updateStatus, 5000); // Update every 5 seconds\r\n\r\n    return () => {\r\n      window.removeEventListener('connectionChange', updateStatus);\r\n      clearInterval(interval);\r\n    };\r\n  }, []);\r\n\r\n  return {\r\n    ...status,\r\n    cacheData: offlineManager.cacheData.bind(offlineManager),\r\n    getCachedData: offlineManager.getCachedData.bind(offlineManager),\r\n    addToSyncQueue: offlineManager.addToSyncQueue.bind(offlineManager),\r\n    clearCache: offlineManager.clearCache.bind(offlineManager),\r\n    clearSyncQueue: offlineManager.clearSyncQueue.bind(offlineManager),\r\n    prefetchCriticalData: offlineManager.prefetchCriticalData.bind(offlineManager)\r\n  };\r\n};\r\n\r\nexport default offlineManager;","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\parsers\\PricelistParsingEngine.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":612,"column":42,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":612,"endColumn":43,"suggestions":[{"messageId":"removeEscape","fix":{"range":[18339,18340],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[18339,18339],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":628,"column":40,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":628,"endColumn":41,"suggestions":[{"messageId":"removeEscape","fix":{"range":[18836,18837],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[18836,18836],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":640,"column":42,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":640,"endColumn":43,"suggestions":[{"messageId":"removeEscape","fix":{"range":[19138,19139],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[19138,19138],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * =====================================================\r\n * AUTOMATED EXCEL PRICELIST PARSING ENGINE\r\n * =====================================================\r\n *\r\n * Intelligent parser that automatically detects and processes\r\n * heterogeneous supplier Excel pricelist formats using\r\n * pattern recognition, AI-enhanced column mapping, and\r\n * adaptive parsing strategies.\r\n *\r\n * Author: Data Oracle\r\n * =====================================================\r\n */\r\n\r\nimport * as XLSX from 'xlsx';\r\nimport { readFile } from 'fs/promises';\r\nimport { extname, basename } from 'path';\r\nimport { createHash } from 'crypto';\r\n\r\n// =====================================================\r\n// TYPE DEFINITIONS\r\n// =====================================================\r\n\r\nexport interface ParsedPricelistData {\r\n  metadata: {\r\n    fileName: string;\r\n    filePath: string;\r\n    fileSize: number;\r\n    fileHash: string;\r\n    sheetName: string;\r\n    totalRows: number;\r\n    headerRow: number;\r\n    dataStartRow: number;\r\n    columnMapping: ColumnMapping;\r\n    confidence: number;\r\n    parsingStrategy: string;\r\n  };\r\n  items: PricelistItem[];\r\n  errors: ParsingError[];\r\n  warnings: ParsingWarning[];\r\n}\r\n\r\nexport interface PricelistItem {\r\n  rowNumber: number;\r\n  sku?: string;\r\n  supplierSku?: string;\r\n  productName?: string;\r\n  description?: string;\r\n  brand?: string;\r\n  manufacturer?: string;\r\n  model?: string;\r\n  category?: string;\r\n  subcategory?: string;\r\n  unitPrice?: number;\r\n  costPrice?: number;\r\n  listPrice?: number;\r\n  wholesalePrice?: number;\r\n  minimumQuantity?: number;\r\n  maximumQuantity?: number;\r\n  leadTimeDays?: number;\r\n  unitOfMeasure?: string;\r\n  stockStatus?: string;\r\n  availability?: string;\r\n  weight?: number;\r\n  dimensionsL?: number;\r\n  dimensionsW?: number;\r\n  dimensionsH?: number;\r\n  upcBarcode?: string;\r\n  eanBarcode?: string;\r\n  rawData: { [key: string]: any };\r\n}\r\n\r\nexport interface ColumnMapping {\r\n  [fieldName: string]: {\r\n    columnIndex: number;\r\n    columnName: string;\r\n    confidence: number;\r\n    transformFunction?: string;\r\n  };\r\n}\r\n\r\nexport interface ParsingError {\r\n  row: number;\r\n  column?: string;\r\n  message: string;\r\n  severity: 'error' | 'warning';\r\n  rawValue?: any;\r\n}\r\n\r\nexport interface ParsingWarning {\r\n  row: number;\r\n  column: string;\r\n  message: string;\r\n  suggestion: string;\r\n  rawValue?: any;\r\n}\r\n\r\n// =====================================================\r\n// COLUMN PATTERN DEFINITIONS\r\n// =====================================================\r\n\r\nconst COLUMN_PATTERNS = {\r\n  sku: {\r\n    keywords: ['sku', 'code', 'part', 'product code', 'item code', 'part number', 'p/n', 'partno', 'item no'],\r\n    patterns: [/^sku/i, /code$/i, /part.*no/i, /item.*no/i],\r\n    priority: 1\r\n  },\r\n  supplierSku: {\r\n    keywords: ['supplier sku', 'vendor code', 'supplier code', 'mfg code', 'manufacturer code', 'vendor part'],\r\n    patterns: [/supplier.*sku/i, /vendor.*code/i, /mfg.*code/i],\r\n    priority: 2\r\n  },\r\n  productName: {\r\n    keywords: ['name', 'title', 'product', 'description', 'item', 'product name', 'item name', 'desc'],\r\n    patterns: [/^name$/i, /product.*name/i, /item.*name/i, /^desc$/i, /description/i],\r\n    priority: 1\r\n  },\r\n  brand: {\r\n    keywords: ['brand', 'make', 'manufacturer brand', 'mfg'],\r\n    patterns: [/^brand$/i, /^make$/i, /^mfg$/i],\r\n    priority: 3\r\n  },\r\n  manufacturer: {\r\n    keywords: ['manufacturer', 'mfr', 'maker', 'oem'],\r\n    patterns: [/manufacturer/i, /^mfr$/i, /^maker$/i, /^oem$/i],\r\n    priority: 3\r\n  },\r\n  unitPrice: {\r\n    keywords: ['price', 'cost', 'unit price', 'retail', 'selling price', 'dealer price', 'list price', 'amount'],\r\n    patterns: [/price/i, /cost/i, /retail/i, /selling/i, /dealer/i, /amount/i],\r\n    priority: 1\r\n  },\r\n  costPrice: {\r\n    keywords: ['cost', 'cost price', 'wholesale', 'dealer cost', 'buy price', 'purchase price'],\r\n    patterns: [/cost.*price/i, /wholesale/i, /dealer.*cost/i, /buy.*price/i],\r\n    priority: 2\r\n  },\r\n  listPrice: {\r\n    keywords: ['list price', 'msrp', 'rrp', 'retail price', 'suggested price'],\r\n    patterns: [/list.*price/i, /msrp/i, /rrp/i, /retail.*price/i, /suggested/i],\r\n    priority: 2\r\n  },\r\n  category: {\r\n    keywords: ['category', 'cat', 'type', 'class', 'group', 'family'],\r\n    patterns: [/category/i, /^cat$/i, /^type$/i, /^class$/i, /^group$/i],\r\n    priority: 3\r\n  },\r\n  stockStatus: {\r\n    keywords: ['stock', 'status', 'availability', 'qty', 'quantity', 'stock status', 'available'],\r\n    patterns: [/stock/i, /status/i, /availability/i, /qty/i, /quantity/i],\r\n    priority: 4\r\n  },\r\n  minimumQuantity: {\r\n    keywords: ['min qty', 'minimum', 'min order', 'moq'],\r\n    patterns: [/min.*qty/i, /minimum/i, /min.*order/i, /moq/i],\r\n    priority: 4\r\n  },\r\n  weight: {\r\n    keywords: ['weight', 'wt', 'mass', 'kg', 'lb'],\r\n    patterns: [/weight/i, /^wt$/i, /mass/i, /\\bkg\\b/i, /\\blb\\b/i],\r\n    priority: 5\r\n  },\r\n  upcBarcode: {\r\n    keywords: ['upc', 'barcode', 'universal product code'],\r\n    patterns: [/upc/i, /barcode/i, /universal.*product/i],\r\n    priority: 4\r\n  },\r\n  eanBarcode: {\r\n    keywords: ['ean', 'ean13', 'european article number'],\r\n    patterns: [/ean/i, /ean13/i, /european.*article/i],\r\n    priority: 4\r\n  }\r\n};\r\n\r\n// =====================================================\r\n// MAIN PARSING ENGINE CLASS\r\n// =====================================================\r\n\r\nexport class PricelistParsingEngine {\r\n  private debug: boolean = false;\r\n\r\n  constructor(debug: boolean = false) {\r\n    this.debug = debug;\r\n  }\r\n\r\n  /**\r\n   * Main entry point for parsing Excel files\r\n   */\r\n  public async parseExcelFile(filePath: string, supplierId?: string): Promise<ParsedPricelistData> {\r\n    try {\r\n      // Read and validate file\r\n      const fileBuffer = await readFile(filePath);\r\n      const fileSize = fileBuffer.length;\r\n      const fileHash = this.generateFileHash(fileBuffer);\r\n      const fileName = basename(filePath);\r\n\r\n      this.debugLog(`Parsing file: ${fileName} (${fileSize} bytes)`);\r\n\r\n      // Parse Excel workbook\r\n      const workbook = XLSX.read(fileBuffer, {\r\n        type: 'buffer',\r\n        cellDates: true,\r\n        cellNF: false,\r\n        cellText: false\r\n      });\r\n\r\n      // Find best sheet to parse\r\n      const bestSheet = this.findBestSheet(workbook);\r\n      this.debugLog(`Selected sheet: ${bestSheet.name} (${bestSheet.rows} rows)`);\r\n\r\n      // Detect structure and create column mapping\r\n      const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[bestSheet.name], {\r\n        header: 1,\r\n        raw: false,\r\n        defval: null\r\n      }) as any[][];\r\n\r\n      const structure = this.detectSheetStructure(sheetData);\r\n      const columnMapping = this.createColumnMapping(structure.headers);\r\n\r\n      this.debugLog(`Detected structure: headerRow=${structure.headerRow}, dataStart=${structure.dataStartRow}`);\r\n      this.debugLog(`Column mapping confidence: ${this.calculateOverallConfidence(columnMapping)}`);\r\n\r\n      // Parse data rows\r\n      const { items, errors, warnings } = this.parseDataRows(\r\n        sheetData,\r\n        structure,\r\n        columnMapping\r\n      );\r\n\r\n      return {\r\n        metadata: {\r\n          fileName,\r\n          filePath,\r\n          fileSize,\r\n          fileHash,\r\n          sheetName: bestSheet.name,\r\n          totalRows: sheetData.length,\r\n          headerRow: structure.headerRow,\r\n          dataStartRow: structure.dataStartRow,\r\n          columnMapping,\r\n          confidence: this.calculateOverallConfidence(columnMapping),\r\n          parsingStrategy: 'intelligent_pattern_matching'\r\n        },\r\n        items,\r\n        errors,\r\n        warnings\r\n      };\r\n\r\n    } catch (error) {\r\n      throw new Error(`Failed to parse Excel file: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate SHA-256 hash of file for duplicate detection\r\n   */\r\n  private generateFileHash(buffer: Buffer): string {\r\n    return createHash('sha256').update(buffer).digest('hex');\r\n  }\r\n\r\n  /**\r\n   * Find the best sheet to parse from workbook\r\n   */\r\n  private findBestSheet(workbook: XLSX.WorkBook): { name: string; rows: number; score: number } {\r\n    const sheetNames = workbook.SheetNames;\r\n    let bestSheet = { name: sheetNames[0], rows: 0, score: 0 };\r\n\r\n    for (const sheetName of sheetNames) {\r\n      const sheet = workbook.Sheets[sheetName];\r\n      const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 }) as any[][];\r\n\r\n      // Score based on data characteristics\r\n      let score = 0;\r\n      const rows = sheetData.length;\r\n\r\n      // Prefer sheets with more data rows\r\n      score += Math.min(rows / 100, 5);\r\n\r\n      // Prefer sheets with recognizable price list keywords\r\n      const sheetText = sheetData.flat().join(' ').toLowerCase();\r\n      if (sheetText.includes('price')) score += 3;\r\n      if (sheetText.includes('sku')) score += 3;\r\n      if (sheetText.includes('product')) score += 2;\r\n      if (sheetText.includes('cost')) score += 2;\r\n\r\n      // Penalty for very short sheets (likely metadata)\r\n      if (rows < 5) score -= 5;\r\n\r\n      // Penalty for sheets with suspicious names\r\n      if (/^(front|cover|info|readme|instructions)/i.test(sheetName)) score -= 3;\r\n\r\n      this.debugLog(`Sheet \"${sheetName}\": ${rows} rows, score: ${score}`);\r\n\r\n      if (score > bestSheet.score) {\r\n        bestSheet = { name: sheetName, rows, score };\r\n      }\r\n    }\r\n\r\n    return bestSheet;\r\n  }\r\n\r\n  /**\r\n   * Detect the structure of the sheet (header location, data start, etc.)\r\n   */\r\n  private detectSheetStructure(sheetData: any[][]): {\r\n    headerRow: number;\r\n    dataStartRow: number;\r\n    headers: string[];\r\n    totalRows: number;\r\n  } {\r\n    let headerRow = -1;\r\n    let dataStartRow = -1;\r\n    let headers: string[] = [];\r\n\r\n    // Look for header row - typically contains the most recognizable column names\r\n    for (let i = 0; i < Math.min(sheetData.length, 10); i++) {\r\n      const row = sheetData[i];\r\n      if (!row || row.length === 0) continue;\r\n\r\n      let recognizedColumns = 0;\r\n      const rowHeaders: string[] = [];\r\n\r\n      for (let j = 0; j < row.length; j++) {\r\n        const cell = String(row[j] || '').trim();\r\n        rowHeaders.push(cell);\r\n\r\n        if (cell && this.isLikelyHeaderCell(cell)) {\r\n          recognizedColumns++;\r\n        }\r\n      }\r\n\r\n      // Header row should have at least 3 recognized columns\r\n      if (recognizedColumns >= 3 && recognizedColumns >= row.filter(cell => cell).length * 0.3) {\r\n        headerRow = i;\r\n        headers = rowHeaders;\r\n        dataStartRow = i + 1;\r\n        break;\r\n      }\r\n    }\r\n\r\n    // Fallback: assume first non-empty row is header\r\n    if (headerRow === -1) {\r\n      for (let i = 0; i < Math.min(sheetData.length, 5); i++) {\r\n        const row = sheetData[i];\r\n        if (row && row.some(cell => cell)) {\r\n          headerRow = i;\r\n          headers = row.map(cell => String(cell || '').trim());\r\n          dataStartRow = i + 1;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    return {\r\n      headerRow,\r\n      dataStartRow,\r\n      headers,\r\n      totalRows: sheetData.length\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Check if a cell value looks like a column header\r\n   */\r\n  private isLikelyHeaderCell(value: string): boolean {\r\n    const lowerValue = value.toLowerCase();\r\n\r\n    // Check against all known patterns\r\n    for (const fieldPatterns of Object.values(COLUMN_PATTERNS)) {\r\n      // Check keywords\r\n      if (fieldPatterns.keywords.some(keyword => lowerValue.includes(keyword))) {\r\n        return true;\r\n      }\r\n\r\n      // Check regex patterns\r\n      if (fieldPatterns.patterns.some(pattern => pattern.test(value))) {\r\n        return true;\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Create intelligent column mapping using pattern matching\r\n   */\r\n  private createColumnMapping(headers: string[]): ColumnMapping {\r\n    const mapping: ColumnMapping = {};\r\n\r\n    for (let i = 0; i < headers.length; i++) {\r\n      const header = headers[i];\r\n      if (!header || header.trim() === '') continue;\r\n\r\n      const bestMatch = this.findBestColumnMatch(header);\r\n      if (bestMatch) {\r\n        mapping[bestMatch.field] = {\r\n          columnIndex: i,\r\n          columnName: header,\r\n          confidence: bestMatch.confidence,\r\n          transformFunction: bestMatch.transformFunction\r\n        };\r\n      }\r\n    }\r\n\r\n    this.debugLog('Column mapping created:', mapping);\r\n    return mapping;\r\n  }\r\n\r\n  /**\r\n   * Find the best field match for a column header\r\n   */\r\n  private findBestColumnMatch(header: string): {\r\n    field: string;\r\n    confidence: number;\r\n    transformFunction?: string;\r\n  } | null {\r\n    const lowerHeader = header.toLowerCase().trim();\r\n    let bestMatch: { field: string; confidence: number; transformFunction?: string } | null = null;\r\n    let bestScore = 0;\r\n\r\n    for (const [fieldName, patterns] of Object.entries(COLUMN_PATTERNS)) {\r\n      let score = 0;\r\n\r\n      // Check exact keyword matches\r\n      for (const keyword of patterns.keywords) {\r\n        if (lowerHeader === keyword) {\r\n          score = 100; // Perfect match\r\n          break;\r\n        } else if (lowerHeader.includes(keyword)) {\r\n          score = Math.max(score, 80 + (keyword.length / lowerHeader.length) * 20);\r\n        }\r\n      }\r\n\r\n      // Check regex patterns\r\n      for (const pattern of patterns.patterns) {\r\n        if (pattern.test(header)) {\r\n          score = Math.max(score, 75);\r\n        }\r\n      }\r\n\r\n      // Apply priority weighting\r\n      score = score * (1 + (patterns.priority - 1) * 0.1);\r\n\r\n      if (score > bestScore && score >= 50) { // Minimum confidence threshold\r\n        bestScore = score;\r\n        bestMatch = {\r\n          field: fieldName,\r\n          confidence: Math.min(score, 100),\r\n          transformFunction: this.getTransformFunction(fieldName)\r\n        };\r\n      }\r\n    }\r\n\r\n    return bestMatch;\r\n  }\r\n\r\n  /**\r\n   * Get appropriate transform function for field type\r\n   */\r\n  private getTransformFunction(fieldName: string): string | undefined {\r\n    const transforms: { [key: string]: string } = {\r\n      unitPrice: 'parsePrice',\r\n      costPrice: 'parsePrice',\r\n      listPrice: 'parsePrice',\r\n      wholesalePrice: 'parsePrice',\r\n      minimumQuantity: 'parseInt',\r\n      maximumQuantity: 'parseInt',\r\n      leadTimeDays: 'parseInt',\r\n      weight: 'parseFloat',\r\n      dimensionsL: 'parseFloat',\r\n      dimensionsW: 'parseFloat',\r\n      dimensionsH: 'parseFloat',\r\n      upcBarcode: 'parseBarcode',\r\n      eanBarcode: 'parseBarcode'\r\n    };\r\n\r\n    return transforms[fieldName];\r\n  }\r\n\r\n  /**\r\n   * Parse data rows using the column mapping\r\n   */\r\n  private parseDataRows(\r\n    sheetData: any[][],\r\n    structure: { headerRow: number; dataStartRow: number; headers: string[] },\r\n    columnMapping: ColumnMapping\r\n  ): {\r\n    items: PricelistItem[];\r\n    errors: ParsingError[];\r\n    warnings: ParsingWarning[];\r\n  } {\r\n    const items: PricelistItem[] = [];\r\n    const errors: ParsingError[] = [];\r\n    const warnings: ParsingWarning[] = [];\r\n\r\n    for (let i = structure.dataStartRow; i < sheetData.length; i++) {\r\n      const row = sheetData[i];\r\n      if (!row || this.isEmptyRow(row)) continue;\r\n\r\n      try {\r\n        const item = this.parseRow(row, i + 1, columnMapping, structure.headers);\r\n\r\n        // Validate critical fields\r\n        const validation = this.validateItem(item, i + 1);\r\n        errors.push(...validation.errors);\r\n        warnings.push(...validation.warnings);\r\n\r\n        if (item.sku && item.productName && item.unitPrice !== undefined) {\r\n          items.push(item);\r\n        } else {\r\n          errors.push({\r\n            row: i + 1,\r\n            message: 'Missing critical fields (SKU, product name, or unit price)',\r\n            severity: 'error'\r\n          });\r\n        }\r\n\r\n      } catch (error) {\r\n        errors.push({\r\n          row: i + 1,\r\n          message: `Failed to parse row: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n          severity: 'error'\r\n        });\r\n      }\r\n    }\r\n\r\n    return { items, errors, warnings };\r\n  }\r\n\r\n  /**\r\n   * Check if a row is effectively empty\r\n   */\r\n  private isEmptyRow(row: any[]): boolean {\r\n    return !row || row.every(cell => !cell || String(cell).trim() === '');\r\n  }\r\n\r\n  /**\r\n   * Parse a single data row\r\n   */\r\n  private parseRow(\r\n    row: any[],\r\n    rowNumber: number,\r\n    columnMapping: ColumnMapping,\r\n    headers: string[]\r\n  ): PricelistItem {\r\n    const item: PricelistItem = {\r\n      rowNumber,\r\n      rawData: {}\r\n    };\r\n\r\n    // Store raw data for debugging\r\n    headers.forEach((header, index) => {\r\n      if (header && row[index] !== undefined) {\r\n        item.rawData[header] = row[index];\r\n      }\r\n    });\r\n\r\n    // Apply column mapping\r\n    for (const [fieldName, mapping] of Object.entries(columnMapping)) {\r\n      const rawValue = row[mapping.columnIndex];\r\n      if (rawValue === null || rawValue === undefined) continue;\r\n\r\n      try {\r\n        const transformedValue = this.transformValue(\r\n          rawValue,\r\n          fieldName,\r\n          mapping.transformFunction\r\n        );\r\n\r\n        // Map to item fields\r\n        (item as any)[this.camelCase(fieldName)] = transformedValue;\r\n\r\n      } catch (error) {\r\n        // Store raw value if transformation fails\r\n        (item as any)[this.camelCase(fieldName)] = rawValue;\r\n      }\r\n    }\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Transform raw cell value based on field type\r\n   */\r\n  private transformValue(rawValue: any, fieldName: string, transformFunction?: string): any {\r\n    if (rawValue === null || rawValue === undefined || rawValue === '') return undefined;\r\n\r\n    const stringValue = String(rawValue).trim();\r\n\r\n    switch (transformFunction) {\r\n      case 'parsePrice':\r\n        return this.parsePrice(stringValue);\r\n      case 'parseInt':\r\n        return this.parseInteger(stringValue);\r\n      case 'parseFloat':\r\n        return this.parseFloat(stringValue);\r\n      case 'parseBarcode':\r\n        return this.parseBarcode(stringValue);\r\n      default:\r\n        return this.parseString(stringValue);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse price values (handles currency symbols, commas, etc.)\r\n   */\r\n  private parsePrice(value: string): number | undefined {\r\n    if (!value) return undefined;\r\n\r\n    // Remove currency symbols and common formatting\r\n    const cleaned = value.replace(/[^\\d.,\\-]/g, '');\r\n    if (!cleaned) return undefined;\r\n\r\n    // Handle different decimal separators\r\n    const normalized = cleaned.replace(/,(?=\\d{3})/g, ''); // Remove thousands separators\r\n    const parsed = parseFloat(normalized.replace(',', '.'));\r\n\r\n    return isNaN(parsed) ? undefined : Math.max(0, parsed);\r\n  }\r\n\r\n  /**\r\n   * Parse integer values\r\n   */\r\n  private parseInteger(value: string): number | undefined {\r\n    if (!value) return undefined;\r\n\r\n    const cleaned = value.replace(/[^\\d\\-]/g, '');\r\n    const parsed = parseInt(cleaned, 10);\r\n\r\n    return isNaN(parsed) ? undefined : Math.max(0, parsed);\r\n  }\r\n\r\n  /**\r\n   * Parse float values\r\n   */\r\n  private parseFloat(value: string): number | undefined {\r\n    if (!value) return undefined;\r\n\r\n    const cleaned = value.replace(/[^\\d.,\\-]/g, '');\r\n    const parsed = parseFloat(cleaned.replace(',', '.'));\r\n\r\n    return isNaN(parsed) ? undefined : Math.max(0, parsed);\r\n  }\r\n\r\n  /**\r\n   * Parse barcode values (digits only)\r\n   */\r\n  private parseBarcode(value: string): string | undefined {\r\n    if (!value) return undefined;\r\n\r\n    const cleaned = value.replace(/[^\\d]/g, '');\r\n    return cleaned.length >= 8 ? cleaned : undefined; // Minimum barcode length\r\n  }\r\n\r\n  /**\r\n   * Parse string values (trim and validate)\r\n   */\r\n  private parseString(value: string): string | undefined {\r\n    if (!value) return undefined;\r\n\r\n    const trimmed = value.trim();\r\n    return trimmed.length > 0 ? trimmed : undefined;\r\n  }\r\n\r\n  /**\r\n   * Validate parsed item\r\n   */\r\n  private validateItem(item: PricelistItem, rowNumber: number): {\r\n    errors: ParsingError[];\r\n    warnings: ParsingWarning[];\r\n  } {\r\n    const errors: ParsingError[] = [];\r\n    const warnings: ParsingWarning[] = [];\r\n\r\n    // Price validation\r\n    if (item.unitPrice !== undefined) {\r\n      if (item.unitPrice <= 0) {\r\n        errors.push({\r\n          row: rowNumber,\r\n          column: 'unitPrice',\r\n          message: 'Unit price must be greater than 0',\r\n          severity: 'error',\r\n          rawValue: item.unitPrice\r\n        });\r\n      } else if (item.unitPrice > 1000000) {\r\n        warnings.push({\r\n          row: rowNumber,\r\n          column: 'unitPrice',\r\n          message: 'Unit price seems unusually high',\r\n          suggestion: 'Verify price is correct',\r\n          rawValue: item.unitPrice\r\n        });\r\n      }\r\n    }\r\n\r\n    // SKU validation\r\n    if (item.sku && item.sku.length < 2) {\r\n      warnings.push({\r\n        row: rowNumber,\r\n        column: 'sku',\r\n        message: 'SKU seems too short',\r\n        suggestion: 'Verify SKU is complete',\r\n        rawValue: item.sku\r\n      });\r\n    }\r\n\r\n    // Product name validation\r\n    if (item.productName && item.productName.length < 3) {\r\n      warnings.push({\r\n        row: rowNumber,\r\n        column: 'productName',\r\n        message: 'Product name seems too short',\r\n        suggestion: 'Verify product name is complete',\r\n        rawValue: item.productName\r\n      });\r\n    }\r\n\r\n    return { errors, warnings };\r\n  }\r\n\r\n  /**\r\n   * Calculate overall confidence score for column mapping\r\n   */\r\n  private calculateOverallConfidence(mapping: ColumnMapping): number {\r\n    const mappings = Object.values(mapping);\r\n    if (mappings.length === 0) return 0;\r\n\r\n    const totalConfidence = mappings.reduce((sum, m) => sum + m.confidence, 0);\r\n    const avgConfidence = totalConfidence / mappings.length;\r\n\r\n    // Bonus for having critical fields mapped\r\n    const criticalFields = ['sku', 'productName', 'unitPrice'];\r\n    const criticalMapped = criticalFields.filter(field => mapping[field]).length;\r\n    const criticalBonus = (criticalMapped / criticalFields.length) * 20;\r\n\r\n    return Math.min(100, avgConfidence + criticalBonus);\r\n  }\r\n\r\n  /**\r\n   * Convert field name to camelCase\r\n   */\r\n  private camelCase(str: string): string {\r\n    return str.charAt(0).toLowerCase() + str.slice(1);\r\n  }\r\n\r\n  /**\r\n   * Debug logging helper\r\n   */\r\n  private debugLog(message: string, data?: any): void {\r\n    if (this.debug) {\r\n      console.log(`[PricelistParser] ${message}`, data || '');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get parsing statistics for monitoring\r\n   */\r\n  public getParsingStatistics(result: ParsedPricelistData): {\r\n    totalRows: number;\r\n    successfulParsing: number;\r\n    errorRate: number;\r\n    warningRate: number;\r\n    confidence: number;\r\n    criticalFieldsCoverage: number;\r\n  } {\r\n    const criticalFields = ['sku', 'productName', 'unitPrice'];\r\n    const mappedCriticalFields = criticalFields.filter(\r\n      field => result.metadata.columnMapping[field]\r\n    ).length;\r\n\r\n    return {\r\n      totalRows: result.metadata.totalRows,\r\n      successfulParsing: result.items.length,\r\n      errorRate: (result.errors.length / Math.max(result.metadata.totalRows, 1)) * 100,\r\n      warningRate: (result.warnings.length / Math.max(result.metadata.totalRows, 1)) * 100,\r\n      confidence: result.metadata.confidence,\r\n      criticalFieldsCoverage: (mappedCriticalFields / criticalFields.length) * 100\r\n    };\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\quality\\qa-validator.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":97,"column":18,"nodeType":"TemplateLiteral","endLine":102,"endColumn":12}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Quality Assurance Validator\r\n *\r\n * Provides comprehensive validation and quality checks for the application\r\n */\r\n\r\nimport { Pool } from 'pg';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\n\r\nexport interface ValidationResult {\r\n  success: boolean;\r\n  message: string;\r\n  details?: any;\r\n  recommendations?: string[];\r\n}\r\n\r\nexport interface QualityReport {\r\n  overall: ValidationResult;\r\n  database: ValidationResult;\r\n  api: ValidationResult;\r\n  security: ValidationResult;\r\n  performance: ValidationResult;\r\n  code: ValidationResult;\r\n}\r\n\r\nexport class QAValidator {\r\n  private pool: Pool;\r\n\r\n  constructor(pool: Pool) {\r\n    this.pool = pool;\r\n  }\r\n\r\n  /**\r\n   * Validate database schema and data integrity\r\n   */\r\n  async validateDatabase(): Promise<ValidationResult> {\r\n    try {\r\n      const issues = [];\r\n      const recommendations = [];\r\n\r\n      // Check for required tables\r\n      const requiredTables = [\r\n        'suppliers',\r\n        'products',\r\n        'inventory_items',\r\n        'pricelists',\r\n        'pricelist_items',\r\n        'categories',\r\n        'organizations',\r\n        'users',\r\n      ];\r\n\r\n      for (const table of requiredTables) {\r\n        const result = await this.pool.query(\r\n          `SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = $1)`,\r\n          [table]\r\n        );\r\n\r\n        if (!result.rows[0].exists) {\r\n          issues.push(`Missing required table: ${table}`);\r\n        }\r\n      }\r\n\r\n      // Check for required indexes\r\n      const requiredIndexes = [\r\n        'suppliers_pkey',\r\n        'products_pkey',\r\n        'inventory_items_pkey',\r\n        'pricelists_pkey',\r\n      ];\r\n\r\n      for (const index of requiredIndexes) {\r\n        const result = await this.pool.query(\r\n          `SELECT EXISTS (SELECT FROM pg_indexes WHERE indexname = $1)`,\r\n          [index]\r\n        );\r\n\r\n        if (!result.rows[0].exists) {\r\n          issues.push(`Missing required index: ${index}`);\r\n        }\r\n      }\r\n\r\n      // Check for data integrity\r\n      const integrityChecks = [\r\n        {\r\n          name: 'Orphaned pricelist items',\r\n          query: `\r\n            SELECT COUNT(*) as count\r\n            FROM pricelist_items pi\r\n            LEFT JOIN pricelists p ON pi.pricelist_id = p.id\r\n            WHERE p.id IS NULL\r\n          `,\r\n        },\r\n        {\r\n          name: 'Invalid supplier references',\r\n          query: `\r\n            SELECT COUNT(*) as count\r\n            FROM pricelists pl\r\n            LEFT JOIN suppliers s ON pl.supplier_id = s.id\r\n            WHERE s.id IS NULL\r\n          `,\r\n        },\r\n      ];\r\n\r\n      for (const check of integrityChecks) {\r\n        const result = await this.pool.query(check.query);\r\n        const count = parseInt(result.rows[0].count);\r\n\r\n        if (count > 0) {\r\n          issues.push(`${check.name}: ${count} records found`);\r\n        }\r\n      }\r\n\r\n      // Check for performance issues\r\n      const performanceChecks = [\r\n        {\r\n          name: 'Large tables without indexes',\r\n          query: `\r\n            SELECT t.table_name, pg_size_pretty(pg_total_relation_size(t.table_name)) as size\r\n            FROM information_schema.tables t\r\n            WHERE t.table_schema = 'public'\r\n            AND pg_total_relation_size(t.table_name) > 100000000\r\n            AND NOT EXISTS (\r\n              SELECT 1 FROM pg_indexes i \r\n              WHERE i.tablename = t.table_name\r\n            )\r\n          `,\r\n        },\r\n      ];\r\n\r\n      for (const check of performanceChecks) {\r\n        const result = await this.pool.query(check.query);\r\n        if (result.rows.length > 0) {\r\n          recommendations.push(`${check.name}: Consider adding indexes`);\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: issues.length === 0,\r\n        message:\r\n          issues.length === 0\r\n            ? 'Database validation passed'\r\n            : `${issues.length} database issues found`,\r\n        details: { issues, checks: integrityChecks.length },\r\n        recommendations,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Database validation failed: ${error}`,\r\n        recommendations: ['Check database connection and permissions'],\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate API endpoints\r\n   */\r\n  async validateAPI(): Promise<ValidationResult> {\r\n    try {\r\n      const issues = [];\r\n      const recommendations = [];\r\n\r\n      // Check for required API endpoints\r\n      const requiredEndpoints = [\r\n        '/api/auth/login',\r\n        '/api/suppliers',\r\n        '/api/products',\r\n        '/api/inventory',\r\n        '/api/pricelists',\r\n        '/api/upload',\r\n      ];\r\n\r\n      // This would typically involve making HTTP requests to test endpoints\r\n      // For now, we'll check if the route files exist\r\n      for (const endpoint of requiredEndpoints) {\r\n        const routePath = path.join('src/app', endpoint, 'route.ts');\r\n        if (!fs.existsSync(routePath)) {\r\n          issues.push(`Missing API endpoint: ${endpoint}`);\r\n        }\r\n      }\r\n\r\n      // Check for proper error handling\r\n      const apiFiles = this.findAPIFiles();\r\n      for (const file of apiFiles) {\r\n        const content = fs.readFileSync(file, 'utf8');\r\n\r\n        if (!content.includes('try') || !content.includes('catch')) {\r\n          recommendations.push(`Consider adding error handling to ${file}`);\r\n        }\r\n\r\n        if (!content.includes('NextResponse.json')) {\r\n          recommendations.push(`Consider standardizing response format in ${file}`);\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: issues.length === 0,\r\n        message:\r\n          issues.length === 0 ? 'API validation passed' : `${issues.length} API issues found`,\r\n        details: { issues, endpoints: requiredEndpoints.length },\r\n        recommendations,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `API validation failed: ${error}`,\r\n        recommendations: ['Check API route files and structure'],\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate security configuration\r\n   */\r\n  async validateSecurity(): Promise<ValidationResult> {\r\n    try {\r\n      const issues = [];\r\n      const recommendations = [];\r\n\r\n      // Check for security headers\r\n      const securityFiles = [\r\n        'src/lib/config/security.ts',\r\n        'src/lib/security/middleware.ts',\r\n        'src/middleware/auth.ts',\r\n      ];\r\n\r\n      for (const file of securityFiles) {\r\n        if (!fs.existsSync(file)) {\r\n          issues.push(`Missing security file: ${file}`);\r\n        }\r\n      }\r\n\r\n      // Check for authentication middleware usage\r\n      const apiFiles = this.findAPIFiles();\r\n      let protectedEndpoints = 0;\r\n      let unprotectedEndpoints = 0;\r\n\r\n      for (const file of apiFiles) {\r\n        const content = fs.readFileSync(file, 'utf8');\r\n\r\n        if (content.includes('withAuth') || content.includes('withPermission')) {\r\n          protectedEndpoints++;\r\n        } else if (\r\n          content.includes('export const') &&\r\n          (content.includes('POST') || content.includes('PUT') || content.includes('DELETE'))\r\n        ) {\r\n          unprotectedEndpoints++;\r\n        }\r\n      }\r\n\r\n      if (unprotectedEndpoints > 0) {\r\n        recommendations.push(\r\n          `Consider adding authentication to ${unprotectedEndpoints} unprotected endpoints`\r\n        );\r\n      }\r\n\r\n      // Check for environment variables\r\n      const requiredEnvVars = ['JWT_SECRET', 'DATABASE_URL'];\r\n\r\n      for (const envVar of requiredEnvVars) {\r\n        if (!process.env[envVar]) {\r\n          issues.push(`Missing required environment variable: ${envVar}`);\r\n        }\r\n      }\r\n\r\n      return {\r\n        success: issues.length === 0,\r\n        message:\r\n          issues.length === 0\r\n            ? 'Security validation passed'\r\n            : `${issues.length} security issues found`,\r\n        details: {\r\n          issues,\r\n          protectedEndpoints,\r\n          unprotectedEndpoints,\r\n          requiredEnvVars: requiredEnvVars.length,\r\n        },\r\n        recommendations,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Security validation failed: ${error}`,\r\n        recommendations: ['Check security configuration files'],\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate performance configuration\r\n   */\r\n  async validatePerformance(): Promise<ValidationResult> {\r\n    try {\r\n      const issues = [];\r\n      const recommendations = [];\r\n\r\n      // Check for performance optimization files\r\n      const performanceFiles = [\r\n        'src/lib/performance/optimizer.ts',\r\n        'src/lib/performance/api-monitor.ts',\r\n      ];\r\n\r\n      for (const file of performanceFiles) {\r\n        if (!fs.existsSync(file)) {\r\n          issues.push(`Missing performance file: ${file}`);\r\n        }\r\n      }\r\n\r\n      // Check for database indexes\r\n      const indexResult = await this.pool.query(`\r\n        SELECT COUNT(*) as count\r\n        FROM pg_indexes\r\n        WHERE schemaname = 'public'\r\n      `);\r\n\r\n      const indexCount = parseInt(indexResult.rows[0].count);\r\n      if (indexCount < 10) {\r\n        recommendations.push('Consider adding more database indexes for better performance');\r\n      }\r\n\r\n      // Check for connection pooling\r\n      const poolResult = await this.pool.query(`\r\n        SELECT setting\r\n        FROM pg_settings\r\n        WHERE name = 'max_connections'\r\n      `);\r\n\r\n      const maxConnections = parseInt(poolResult.rows[0].setting);\r\n      if (maxConnections < 100) {\r\n        recommendations.push('Consider increasing max_connections for better scalability');\r\n      }\r\n\r\n      return {\r\n        success: issues.length === 0,\r\n        message:\r\n          issues.length === 0\r\n            ? 'Performance validation passed'\r\n            : `${issues.length} performance issues found`,\r\n        details: { issues, indexCount, maxConnections },\r\n        recommendations,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Performance validation failed: ${error}`,\r\n        recommendations: ['Check performance configuration and database settings'],\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validate code quality\r\n   */\r\n  async validateCode(): Promise<ValidationResult> {\r\n    try {\r\n      const issues = [];\r\n      const recommendations = [];\r\n\r\n      // Check for TypeScript configuration\r\n      if (!fs.existsSync('tsconfig.json')) {\r\n        issues.push('Missing TypeScript configuration file');\r\n      }\r\n\r\n      // Check for ESLint configuration\r\n      if (!fs.existsSync('.eslintrc.json') && !fs.existsSync('.eslintrc.js')) {\r\n        recommendations.push('Consider adding ESLint configuration for code quality');\r\n      }\r\n\r\n      // Check for test files\r\n      const testFiles = this.findTestFiles();\r\n      if (testFiles.length === 0) {\r\n        recommendations.push('Consider adding unit tests for better code quality');\r\n      }\r\n\r\n      // Check for documentation\r\n      if (!fs.existsSync('README.md')) {\r\n        recommendations.push('Consider adding README.md for project documentation');\r\n      }\r\n\r\n      return {\r\n        success: issues.length === 0,\r\n        message:\r\n          issues.length === 0\r\n            ? 'Code quality validation passed'\r\n            : `${issues.length} code quality issues found`,\r\n        details: { issues, testFiles: testFiles.length },\r\n        recommendations,\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        success: false,\r\n        message: `Code quality validation failed: ${error}`,\r\n        recommendations: ['Check project structure and configuration files'],\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Run comprehensive quality assurance validation\r\n   */\r\n  async validate(): Promise<QualityReport> {\r\n    const [database, api, security, performance, code] = await Promise.all([\r\n      this.validateDatabase(),\r\n      this.validateAPI(),\r\n      this.validateSecurity(),\r\n      this.validatePerformance(),\r\n      this.validateCode(),\r\n    ]);\r\n\r\n    const overallSuccess = [database, api, security, performance, code].every(v => v.success);\r\n    const overallMessage = overallSuccess\r\n      ? 'All quality assurance checks passed'\r\n      : 'Some quality assurance checks failed';\r\n\r\n    return {\r\n      overall: {\r\n        success: overallSuccess,\r\n        message: overallMessage,\r\n        recommendations: [\r\n          ...(database.recommendations || []),\r\n          ...(api.recommendations || []),\r\n          ...(security.recommendations || []),\r\n          ...(performance.recommendations || []),\r\n          ...(code.recommendations || []),\r\n        ],\r\n      },\r\n      database,\r\n      api,\r\n      security,\r\n      performance,\r\n      code,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Find API files\r\n   */\r\n  private findAPIFiles(): string[] {\r\n    const apiDir = 'src/app/api';\r\n    if (!fs.existsSync(apiDir)) {\r\n      return [];\r\n    }\r\n\r\n    const files: string[] = [];\r\n\r\n    function findFiles(dir: string) {\r\n      const items = fs.readdirSync(dir);\r\n\r\n      for (const item of items) {\r\n        const fullPath = path.join(dir, item);\r\n        const stat = fs.statSync(fullPath);\r\n\r\n        if (stat.isDirectory()) {\r\n          findFiles(fullPath);\r\n        } else if (item === 'route.ts') {\r\n          files.push(fullPath);\r\n        }\r\n      }\r\n    }\r\n\r\n    findFiles(apiDir);\r\n    return files;\r\n  }\r\n\r\n  /**\r\n   * Find test files\r\n   */\r\n  private findTestFiles(): string[] {\r\n    const files: string[] = [];\r\n\r\n    function findFiles(dir: string) {\r\n      if (!fs.existsSync(dir)) return;\r\n\r\n      const items = fs.readdirSync(dir);\r\n\r\n      for (const item of items) {\r\n        const fullPath = path.join(dir, item);\r\n        const stat = fs.statSync(fullPath);\r\n\r\n        if (stat.isDirectory()) {\r\n          findFiles(fullPath);\r\n        } else if (item.endsWith('.test.ts') || item.endsWith('.spec.ts')) {\r\n          files.push(fullPath);\r\n        }\r\n      }\r\n    }\r\n\r\n    findFiles('src');\r\n    findFiles('tests');\r\n    findFiles('__tests__');\r\n\r\n    return files;\r\n  }\r\n}\r\n\r\nexport default QAValidator;\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\security\\password-security.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":11,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":11,"endColumn":15},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":360,"column":18,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":360,"endColumn":35}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Password Security Utilities\n *\n * Strong password policies, validation, and account lockout\n * Implements NIST 800-63B password guidelines\n *\n * @module security/password-security\n * @author AS Team (Security Compliance)\n */\n\n// @ts-nocheck\nimport bcrypt from 'bcryptjs'\nimport { db } from '@/lib/database'\n\n// ============================================================================\n// CONFIGURATION\n// ============================================================================\n\nexport const PASSWORD_POLICY = {\n  minLength: 12,\n  maxLength: 128,\n  requireUppercase: true,\n  requireLowercase: true,\n  requireNumbers: true,\n  requireSpecialChars: true,\n  preventPasswordReuse: 5, // Number of previous passwords to check\n  maxFailedAttempts: 5,\n  lockoutDuration: 15 * 60 * 1000, // 15 minutes in milliseconds\n  bcryptRounds: 12 // Industry standard\n}\n\n// ============================================================================\n// PASSWORD VALIDATION\n// ============================================================================\n\nexport interface PasswordValidationResult {\n  valid: boolean\n  errors: string[]\n  strength: 'weak' | 'fair' | 'good' | 'strong' | 'very-strong'\n  score: number\n}\n\n/**\n * Validate password against security policy\n */\nexport function validatePassword(password: string): PasswordValidationResult {\n  const errors: string[] = []\n  let score = 0\n\n  // Length check\n  if (!password || password.length < PASSWORD_POLICY.minLength) {\n    errors.push(`Password must be at least ${PASSWORD_POLICY.minLength} characters long`)\n  } else {\n    score += Math.min(password.length - PASSWORD_POLICY.minLength, 10)\n  }\n\n  if (password.length > PASSWORD_POLICY.maxLength) {\n    errors.push(`Password must not exceed ${PASSWORD_POLICY.maxLength} characters`)\n  }\n\n  // Character type checks\n  if (PASSWORD_POLICY.requireUppercase && !/[A-Z]/.test(password)) {\n    errors.push('Password must contain at least one uppercase letter')\n  } else {\n    score += 5\n  }\n\n  if (PASSWORD_POLICY.requireLowercase && !/[a-z]/.test(password)) {\n    errors.push('Password must contain at least one lowercase letter')\n  } else {\n    score += 5\n  }\n\n  if (PASSWORD_POLICY.requireNumbers && !/[0-9]/.test(password)) {\n    errors.push('Password must contain at least one number')\n  } else {\n    score += 5\n  }\n\n  if (PASSWORD_POLICY.requireSpecialChars && !/[^A-Za-z0-9]/.test(password)) {\n    errors.push('Password must contain at least one special character (!@#$%^&*(),.?\":{}|<>)')\n  } else {\n    score += 5\n  }\n\n  // Check for common patterns\n  if (/^(.)\\1+$/.test(password)) {\n    errors.push('Password cannot consist of repeated characters')\n    score = 0\n  }\n\n  if (/^(abc|123|qwe|asd|zxc)/i.test(password)) {\n    errors.push('Password cannot start with common sequences')\n    score = Math.max(0, score - 10)\n  }\n\n  // Check against common passwords (subset)\n  const commonPasswords = [\n    'password', 'password123', 'admin123', 'qwerty123',\n    'welcome123', 'letmein123', 'monkey123', 'dragon123'\n  ]\n\n  if (commonPasswords.some(cp => password.toLowerCase().includes(cp))) {\n    errors.push('Password is too common or easily guessable')\n    score = Math.max(0, score - 15)\n  }\n\n  // Determine strength\n  let strength: PasswordValidationResult['strength'] = 'weak'\n  if (score >= 30) strength = 'very-strong'\n  else if (score >= 25) strength = 'strong'\n  else if (score >= 20) strength = 'good'\n  else if (score >= 15) strength = 'fair'\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    strength,\n    score\n  }\n}\n\n/**\n * Hash password using bcrypt\n */\nexport async function hashPassword(password: string): Promise<string> {\n  // Validate first\n  const validation = validatePassword(password)\n  if (!validation.valid) {\n    throw new Error(`Password does not meet security requirements: ${validation.errors.join(', ')}`)\n  }\n\n  return bcrypt.hash(password, PASSWORD_POLICY.bcryptRounds)\n}\n\n/**\n * Verify password against hash\n */\nexport async function verifyPassword(password: string, hash: string): Promise<boolean> {\n  try {\n    return await bcrypt.compare(password, hash)\n  } catch (error) {\n    console.error('Password verification error:', error)\n    return false\n  }\n}\n\n// ============================================================================\n// PASSWORD HISTORY\n// ============================================================================\n\n/**\n * Check if password was used recently (prevent reuse)\n */\nexport async function checkPasswordHistory(\n  userId: string,\n  newPassword: string\n): Promise<{ canUse: boolean; message?: string }> {\n  try {\n    // Get recent password hashes\n    const result = await db.query(`\n      SELECT password_hash\n      FROM auth.password_history\n      WHERE user_id = $1\n      ORDER BY created_at DESC\n      LIMIT $2\n    `, [userId, PASSWORD_POLICY.preventPasswordReuse])\n\n    // Check against each previous password\n    for (const row of result.rows) {\n      const matches = await bcrypt.compare(newPassword, row.password_hash)\n      if (matches) {\n        return {\n          canUse: false,\n          message: `Password was recently used. Please choose a different password. Cannot reuse your last ${PASSWORD_POLICY.preventPasswordReuse} passwords.`\n        }\n      }\n    }\n\n    return { canUse: true }\n  } catch (error) {\n    console.error('Password history check error:', error)\n    // Fail open for availability, but log\n    return { canUse: true }\n  }\n}\n\n/**\n * Add password to history\n */\nexport async function addPasswordToHistory(\n  userId: string,\n  passwordHash: string\n): Promise<void> {\n  try {\n    await db.query(`\n      INSERT INTO auth.password_history (user_id, password_hash)\n      VALUES ($1, $2)\n    `, [userId, passwordHash])\n\n    // Clean up old history (keep only last N passwords)\n    await db.query(`\n      DELETE FROM auth.password_history\n      WHERE user_id = $1\n      AND id NOT IN (\n        SELECT id\n        FROM auth.password_history\n        WHERE user_id = $1\n        ORDER BY created_at DESC\n        LIMIT $2\n      )\n    `, [userId, PASSWORD_POLICY.preventPasswordReuse + 5]) // Keep a few extra\n  } catch (error) {\n    console.error('Add password history error:', error)\n    // Don't throw - this shouldn't block password changes\n  }\n}\n\n// ============================================================================\n// ACCOUNT LOCKOUT\n// ============================================================================\n\n/**\n * Record failed login attempt\n */\nexport async function recordFailedLogin(userId: string): Promise<{\n  locked: boolean\n  attemptsRemaining: number\n  lockedUntil?: Date\n}> {\n  try {\n    // Increment failed attempts\n    const result = await db.query(`\n      UPDATE auth.users_extended\n      SET\n        failed_login_attempts = failed_login_attempts + 1,\n        locked_until = CASE\n          WHEN failed_login_attempts + 1 >= $2 THEN NOW() + INTERVAL '${PASSWORD_POLICY.lockoutDuration} milliseconds'\n          ELSE locked_until\n        END\n      WHERE id = $1\n      RETURNING failed_login_attempts, locked_until\n    `, [userId, PASSWORD_POLICY.maxFailedAttempts])\n\n    if (result.rows.length === 0) {\n      return { locked: false, attemptsRemaining: PASSWORD_POLICY.maxFailedAttempts }\n    }\n\n    const row = result.rows[0]\n    const attempts = row.failed_login_attempts\n    const lockedUntil = row.locked_until\n\n    const locked = attempts >= PASSWORD_POLICY.maxFailedAttempts\n    const attemptsRemaining = Math.max(0, PASSWORD_POLICY.maxFailedAttempts - attempts)\n\n    // Log security event if locked\n    if (locked) {\n      await logSecurityEvent({\n        userId,\n        eventType: 'account_locked',\n        severity: 'high',\n        details: {\n          reason: 'Too many failed login attempts',\n          attempts,\n          lockedUntil\n        }\n      })\n    }\n\n    return {\n      locked,\n      attemptsRemaining,\n      lockedUntil: lockedUntil ? new Date(lockedUntil) : undefined\n    }\n  } catch (error) {\n    console.error('Record failed login error:', error)\n    return { locked: false, attemptsRemaining: PASSWORD_POLICY.maxFailedAttempts }\n  }\n}\n\n/**\n * Reset failed login attempts on successful login\n */\nexport async function resetFailedLogins(userId: string): Promise<void> {\n  try {\n    await db.query(`\n      UPDATE auth.users_extended\n      SET\n        failed_login_attempts = 0,\n        locked_until = NULL\n      WHERE id = $1\n    `, [userId])\n  } catch (error) {\n    console.error('Reset failed logins error:', error)\n  }\n}\n\n/**\n * Check if account is currently locked\n */\nexport async function isAccountLocked(userId: string): Promise<{\n  locked: boolean\n  lockedUntil?: Date\n  reason?: string\n}> {\n  try {\n    const result = await db.query(`\n      SELECT\n        failed_login_attempts,\n        locked_until,\n        is_suspended,\n        suspension_reason\n      FROM auth.users_extended\n      WHERE id = $1\n    `, [userId])\n\n    if (result.rows.length === 0) {\n      return { locked: false }\n    }\n\n    const row = result.rows[0]\n\n    // Check suspension\n    if (row.is_suspended) {\n      return {\n        locked: true,\n        reason: row.suspension_reason || 'Account suspended by administrator'\n      }\n    }\n\n    // Check lockout\n    if (row.locked_until && new Date(row.locked_until) > new Date()) {\n      return {\n        locked: true,\n        lockedUntil: new Date(row.locked_until),\n        reason: `Account locked due to too many failed login attempts. Try again after ${new Date(row.locked_until).toLocaleString()}`\n      }\n    }\n\n    // If lockout expired, clear it\n    if (row.locked_until && new Date(row.locked_until) <= new Date()) {\n      await resetFailedLogins(userId)\n    }\n\n    return { locked: false }\n  } catch (error) {\n    console.error('Check account locked error:', error)\n    return { locked: false }\n  }\n}\n\n// ============================================================================\n// PASSWORD RESET\n// ============================================================================\n\n/**\n * Generate secure password reset token\n */\nexport async function generatePasswordResetToken(userId: string): Promise<string> {\n  const crypto = require('crypto')\n  const token = crypto.randomBytes(32).toString('hex')\n  const expiresAt = new Date(Date.now() + 60 * 60 * 1000) // 1 hour\n\n  await db.query(`\n    UPDATE auth.users_extended\n    SET\n      password_reset_token = $2,\n      password_reset_expires_at = $3\n    WHERE id = $1\n  `, [userId, token, expiresAt])\n\n  return token\n}\n\n/**\n * Verify password reset token\n */\nexport async function verifyPasswordResetToken(\n  token: string\n): Promise<{ valid: boolean; userId?: string; error?: string }> {\n  try {\n    const result = await db.query(`\n      SELECT id\n      FROM auth.users_extended\n      WHERE password_reset_token = $1\n        AND password_reset_expires_at > NOW()\n        AND is_active = TRUE\n        AND is_suspended = FALSE\n    `, [token])\n\n    if (result.rows.length === 0) {\n      return { valid: false, error: 'Invalid or expired reset token' }\n    }\n\n    return { valid: true, userId: result.rows[0].id }\n  } catch (error) {\n    console.error('Verify reset token error:', error)\n    return { valid: false, error: 'Token verification failed' }\n  }\n}\n\n// ============================================================================\n// SECURITY LOGGING\n// ============================================================================\n\ninterface SecurityEventParams {\n  userId: string\n  eventType: string\n  severity: 'low' | 'medium' | 'high' | 'critical'\n  details: any\n  ipAddress?: string\n  userAgent?: string\n}\n\nasync function logSecurityEvent(params: SecurityEventParams): Promise<void> {\n  try {\n    // Get user's org_id\n    const userResult = await db.query(`\n      SELECT org_id FROM auth.users_extended WHERE id = $1\n    `, [params.userId])\n\n    if (userResult.rows.length === 0) return\n\n    const orgId = userResult.rows[0].org_id\n\n    await db.query(`\n      INSERT INTO auth.security_events (\n        org_id, user_id, event_type, severity, details, ip_address, user_agent\n      )\n      VALUES ($1, $2, $3, $4, $5, $6, $7)\n    `, [\n      orgId,\n      params.userId,\n      params.eventType,\n      params.severity,\n      JSON.stringify(params.details),\n      params.ipAddress || '0.0.0.0',\n      params.userAgent || 'unknown'\n    ])\n  } catch (error) {\n    console.error('Log security event error:', error)\n  }\n}\n\n// ============================================================================\n// EXPORT\n// ============================================================================\n\nexport const passwordSecurity = {\n  validate: validatePassword,\n  hash: hashPassword,\n  verify: verifyPassword,\n  checkHistory: checkPasswordHistory,\n  addToHistory: addPasswordToHistory,\n  recordFailedLogin,\n  resetFailedLogins,\n  isAccountLocked,\n  generateResetToken: generatePasswordResetToken,\n  verifyResetToken: verifyPasswordResetToken,\n  policy: PASSWORD_POLICY\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\security\\totp-service.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Do not use \"@ts-nocheck\" because it alters compilation errors.","line":11,"column":1,"nodeType":"Line","messageId":"tsDirectiveComment","endLine":11,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * TOTP Two-Factor Authentication Service\n *\n * Real TOTP implementation with rate limiting and backup codes\n * Implements RFC 6238 (TOTP) standard\n *\n * @module security/totp-service\n * @author AS Team (Security Compliance)\n */\n\n// @ts-nocheck\nimport speakeasy from 'speakeasy'\nimport QRCode from 'qrcode'\nimport crypto from 'crypto'\nimport { db } from '@/lib/database'\nimport { encryptPII, decryptPII } from './encryption'\n\n// ============================================================================\n// CONFIGURATION\n// ============================================================================\n\nconst TOTP_CONFIG = {\n  issuer: 'MantisNXT',\n  algorithm: 'sha1' as const,\n  digits: 6,\n  step: 30, // 30 seconds\n  window: 1, // Allow 1 step before/after for clock skew\n  encoding: 'base32' as const,\n  maxAttempts: 3, // Max verification attempts per period\n  cooldownPeriod: 5 * 60 * 1000, // 5 minutes cooldown after max attempts\n  backupCodesCount: 10\n}\n\n// ============================================================================\n// RATE LIMITING\n// ============================================================================\n\ninterface RateLimitEntry {\n  attempts: number\n  lastAttempt: number\n  cooldownUntil?: number\n}\n\n// In-memory rate limiting (should use Redis in production)\nconst rateLimitStore = new Map<string, RateLimitEntry>()\n\n/**\n * Check if user is rate limited for 2FA attempts\n */\nfunction checkRateLimit(userId: string): {\n  allowed: boolean\n  attemptsRemaining: number\n  cooldownUntil?: Date\n} {\n  const key = `2fa:${userId}`\n  const now = Date.now()\n  const entry = rateLimitStore.get(key)\n\n  if (!entry) {\n    return { allowed: true, attemptsRemaining: TOTP_CONFIG.maxAttempts }\n  }\n\n  // Check cooldown\n  if (entry.cooldownUntil && entry.cooldownUntil > now) {\n    return {\n      allowed: false,\n      attemptsRemaining: 0,\n      cooldownUntil: new Date(entry.cooldownUntil)\n    }\n  }\n\n  // Reset if last attempt was more than cooldown period ago\n  if (now - entry.lastAttempt > TOTP_CONFIG.cooldownPeriod) {\n    rateLimitStore.delete(key)\n    return { allowed: true, attemptsRemaining: TOTP_CONFIG.maxAttempts }\n  }\n\n  return {\n    allowed: entry.attempts < TOTP_CONFIG.maxAttempts,\n    attemptsRemaining: Math.max(0, TOTP_CONFIG.maxAttempts - entry.attempts)\n  }\n}\n\n/**\n * Record 2FA verification attempt\n */\nfunction recordAttempt(userId: string, success: boolean): void {\n  const key = `2fa:${userId}`\n  const now = Date.now()\n  const entry = rateLimitStore.get(key) || { attempts: 0, lastAttempt: now }\n\n  if (success) {\n    // Reset on success\n    rateLimitStore.delete(key)\n    return\n  }\n\n  entry.attempts += 1\n  entry.lastAttempt = now\n\n  // Set cooldown if max attempts reached\n  if (entry.attempts >= TOTP_CONFIG.maxAttempts) {\n    entry.cooldownUntil = now + TOTP_CONFIG.cooldownPeriod\n  }\n\n  rateLimitStore.set(key, entry)\n}\n\n// ============================================================================\n// TOTP SETUP\n// ============================================================================\n\nexport interface TOTPSetupResult {\n  secret: string\n  qrCode: string\n  backupCodes: string[]\n  manualEntryKey: string\n}\n\n/**\n * Generate TOTP secret and QR code for user\n */\nexport async function setupTOTP(\n  userId: string,\n  userEmail: string\n): Promise<TOTPSetupResult> {\n  try {\n    // Generate secret\n    const secret = speakeasy.generateSecret({\n      name: `${TOTP_CONFIG.issuer} (${userEmail})`,\n      issuer: TOTP_CONFIG.issuer,\n      length: 32\n    })\n\n    if (!secret.base32) {\n      throw new Error('Failed to generate TOTP secret')\n    }\n\n    // Generate QR code\n    const qrCode = await QRCode.toDataURL(secret.otpauth_url || '')\n\n    // Generate backup codes\n    const backupCodes = generateBackupCodes()\n\n    // Encrypt secret and backup codes before storing\n    const encryptedSecret = encryptPII(secret.base32)\n    const encryptedBackupCodes = backupCodes.map(code => encryptPII(code))\n\n    // Store in database (not yet enabled)\n    await db.query(`\n      UPDATE auth.users_extended\n      SET\n        two_factor_secret = $2,\n        two_factor_backup_codes = $3,\n        two_factor_enabled = FALSE\n      WHERE id = $1\n    `, [userId, encryptedSecret, encryptedBackupCodes])\n\n    return {\n      secret: secret.base32,\n      qrCode,\n      backupCodes,\n      manualEntryKey: secret.base32\n    }\n  } catch (error) {\n    console.error('TOTP setup error:', error)\n    throw new Error('Failed to setup two-factor authentication')\n  }\n}\n\n/**\n * Verify TOTP code and enable 2FA\n */\nexport async function enableTOTP(userId: string, code: string): Promise<{\n  success: boolean\n  error?: string\n}> {\n  try {\n    // Check rate limit\n    const rateLimit = checkRateLimit(userId)\n    if (!rateLimit.allowed) {\n      return {\n        success: false,\n        error: `Too many attempts. Please try again after ${rateLimit.cooldownUntil?.toLocaleTimeString()}`\n      }\n    }\n\n    // Get encrypted secret\n    const result = await db.query(`\n      SELECT two_factor_secret\n      FROM auth.users_extended\n      WHERE id = $1\n    `, [userId])\n\n    if (result.rows.length === 0 || !result.rows[0].two_factor_secret) {\n      return { success: false, error: 'Two-factor authentication not setup' }\n    }\n\n    // Decrypt secret\n    const secret = decryptPII(result.rows[0].two_factor_secret)\n\n    // Verify code\n    const verified = speakeasy.totp.verify({\n      secret,\n      encoding: TOTP_CONFIG.encoding,\n      token: code,\n      window: TOTP_CONFIG.window\n    })\n\n    recordAttempt(userId, verified)\n\n    if (!verified) {\n      return {\n        success: false,\n        error: `Invalid verification code. ${rateLimit.attemptsRemaining - 1} attempts remaining.`\n      }\n    }\n\n    // Enable 2FA\n    await db.query(`\n      UPDATE auth.users_extended\n      SET\n        two_factor_enabled = TRUE,\n        two_factor_enabled_at = NOW()\n      WHERE id = $1\n    `, [userId])\n\n    // Log security event\n    await logSecurityEvent(userId, 'two_factor_enabled', 'medium')\n\n    return { success: true }\n  } catch (error) {\n    console.error('Enable TOTP error:', error)\n    return { success: false, error: 'Failed to enable two-factor authentication' }\n  }\n}\n\n// ============================================================================\n// TOTP VERIFICATION\n// ============================================================================\n\nexport interface TOTPVerificationResult {\n  valid: boolean\n  error?: string\n  attemptsRemaining?: number\n  cooldownUntil?: Date\n}\n\n/**\n * Verify TOTP code for login\n */\nexport async function verifyTOTP(\n  userId: string,\n  code: string\n): Promise<TOTPVerificationResult> {\n  try {\n    // Check rate limit\n    const rateLimit = checkRateLimit(userId)\n    if (!rateLimit.allowed) {\n      return {\n        valid: false,\n        error: `Too many attempts. Please try again after ${rateLimit.cooldownUntil?.toLocaleTimeString()}`,\n        attemptsRemaining: 0,\n        cooldownUntil: rateLimit.cooldownUntil\n      }\n    }\n\n    // Get user's encrypted secret and backup codes\n    const result = await db.query(`\n      SELECT\n        two_factor_secret,\n        two_factor_backup_codes,\n        two_factor_enabled\n      FROM auth.users_extended\n      WHERE id = $1\n    `, [userId])\n\n    if (result.rows.length === 0) {\n      return { valid: false, error: 'User not found' }\n    }\n\n    const row = result.rows[0]\n\n    if (!row.two_factor_enabled) {\n      return { valid: false, error: 'Two-factor authentication not enabled' }\n    }\n\n    if (!row.two_factor_secret) {\n      return { valid: false, error: 'Two-factor authentication not properly configured' }\n    }\n\n    // Decrypt secret\n    const secret = decryptPII(row.two_factor_secret)\n\n    // Verify TOTP code\n    const verified = speakeasy.totp.verify({\n      secret,\n      encoding: TOTP_CONFIG.encoding,\n      token: code,\n      window: TOTP_CONFIG.window\n    })\n\n    if (verified) {\n      recordAttempt(userId, true)\n      await logSecurityEvent(userId, 'two_factor_verified', 'low')\n      return { valid: true }\n    }\n\n    // Check backup codes if TOTP failed\n    if (row.two_factor_backup_codes && row.two_factor_backup_codes.length > 0) {\n      const backupValid = await verifyBackupCode(userId, code, row.two_factor_backup_codes)\n      if (backupValid) {\n        recordAttempt(userId, true)\n        return { valid: true }\n      }\n    }\n\n    // Record failed attempt\n    recordAttempt(userId, false)\n\n    return {\n      valid: false,\n      error: 'Invalid verification code',\n      attemptsRemaining: rateLimit.attemptsRemaining - 1\n    }\n  } catch (error) {\n    console.error('Verify TOTP error:', error)\n    return { valid: false, error: 'Verification failed' }\n  }\n}\n\n/**\n * Verify backup code\n */\nasync function verifyBackupCode(\n  userId: string,\n  code: string,\n  encryptedBackupCodes: string[]\n): Promise<boolean> {\n  try {\n    // Decrypt all backup codes\n    const backupCodes = encryptedBackupCodes.map(encrypted => decryptPII(encrypted))\n\n    // Check if code matches\n    const index = backupCodes.indexOf(code)\n    if (index === -1) {\n      return false\n    }\n\n    // Remove used backup code\n    const remainingCodes = encryptedBackupCodes.filter((_, i) => i !== index)\n\n    await db.query(`\n      UPDATE auth.users_extended\n      SET two_factor_backup_codes = $2\n      WHERE id = $1\n    `, [userId, remainingCodes])\n\n    await logSecurityEvent(userId, 'backup_code_used', 'medium', {\n      remainingCodes: remainingCodes.length\n    })\n\n    return true\n  } catch (error) {\n    console.error('Verify backup code error:', error)\n    return false\n  }\n}\n\n// ============================================================================\n// BACKUP CODES\n// ============================================================================\n\n/**\n * Generate secure backup codes\n */\nfunction generateBackupCodes(): string[] {\n  const codes: string[] = []\n\n  for (let i = 0; i < TOTP_CONFIG.backupCodesCount; i++) {\n    // Generate 8-character alphanumeric code\n    const code = crypto.randomBytes(4).toString('hex').toUpperCase()\n    // Format as XXXX-XXXX for readability\n    codes.push(`${code.slice(0, 4)}-${code.slice(4)}`)\n  }\n\n  return codes\n}\n\n/**\n * Regenerate backup codes\n */\nexport async function regenerateBackupCodes(userId: string): Promise<string[]> {\n  try {\n    const backupCodes = generateBackupCodes()\n    const encryptedBackupCodes = backupCodes.map(code => encryptPII(code))\n\n    await db.query(`\n      UPDATE auth.users_extended\n      SET two_factor_backup_codes = $2\n      WHERE id = $1\n    `, [userId, encryptedBackupCodes])\n\n    await logSecurityEvent(userId, 'backup_codes_regenerated', 'medium')\n\n    return backupCodes\n  } catch (error) {\n    console.error('Regenerate backup codes error:', error)\n    throw new Error('Failed to regenerate backup codes')\n  }\n}\n\n// ============================================================================\n// DISABLE 2FA\n// ============================================================================\n\n/**\n * Disable TOTP for user (requires admin or user verification)\n */\nexport async function disableTOTP(userId: string, verificationCode: string): Promise<{\n  success: boolean\n  error?: string\n}> {\n  try {\n    // Verify current code before disabling\n    const verification = await verifyTOTP(userId, verificationCode)\n\n    if (!verification.valid) {\n      return {\n        success: false,\n        error: 'Invalid verification code. Please provide a valid code to disable 2FA.'\n      }\n    }\n\n    // Disable 2FA\n    await db.query(`\n      UPDATE auth.users_extended\n      SET\n        two_factor_enabled = FALSE,\n        two_factor_secret = NULL,\n        two_factor_backup_codes = NULL,\n        two_factor_enabled_at = NULL\n      WHERE id = $1\n    `, [userId])\n\n    await logSecurityEvent(userId, 'two_factor_disabled', 'high')\n\n    return { success: true }\n  } catch (error) {\n    console.error('Disable TOTP error:', error)\n    return { success: false, error: 'Failed to disable two-factor authentication' }\n  }\n}\n\n// ============================================================================\n// SECURITY LOGGING\n// ============================================================================\n\nasync function logSecurityEvent(\n  userId: string,\n  eventType: string,\n  severity: 'low' | 'medium' | 'high' | 'critical',\n  details?: any\n): Promise<void> {\n  try {\n    const userResult = await db.query(`\n      SELECT org_id FROM auth.users_extended WHERE id = $1\n    `, [userId])\n\n    if (userResult.rows.length === 0) return\n\n    const orgId = userResult.rows[0].org_id\n\n    await db.query(`\n      INSERT INTO auth.security_events (\n        org_id, user_id, event_type, severity, details\n      )\n      VALUES ($1, $2, $3, $4, $5)\n    `, [orgId, userId, eventType, severity, JSON.stringify(details || {})])\n  } catch (error) {\n    console.error('Log security event error:', error)\n  }\n}\n\n// ============================================================================\n// EXPORT\n// ============================================================================\n\nexport const totpService = {\n  setup: setupTOTP,\n  enable: enableTOTP,\n  verify: verifyTOTP,\n  disable: disableTOTP,\n  regenerateBackupCodes,\n  config: TOTP_CONFIG\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\services\\ConflictResolver.ts","messages":[{"ruleId":"no-prototype-builtins","severity":2,"message":"Do not access Object.prototype method 'hasOwnProperty' from target object.","line":164,"column":22,"nodeType":"CallExpression","messageId":"prototypeBuildIn","endLine":164,"endColumn":36,"suggestions":[{"messageId":"callObjectPrototype","data":{"prop":"hasOwnProperty"},"fix":{"range":[4916,4942],"text":"Object.prototype.hasOwnProperty.call(targetData, "},"desc":"Call Object.prototype.hasOwnProperty explicitly."}]},{"ruleId":"no-prototype-builtins","severity":2,"message":"Do not access Object.prototype method 'hasOwnProperty' from target object.","line":176,"column":23,"nodeType":"CallExpression","messageId":"prototypeBuildIn","endLine":176,"endColumn":37,"suggestions":[{"messageId":"callObjectPrototype","data":{"prop":"hasOwnProperty"},"fix":{"range":[5271,5297],"text":"Object.prototype.hasOwnProperty.call(sourceData, "},"desc":"Call Object.prototype.hasOwnProperty explicitly."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * ConflictResolver - Production-ready conflict detection and resolution\n *\n * Features:\n * - Automatic conflict detection (DataMismatch, DuplicateKey, ValidationError, AuthError)\n * - Resolution strategies: AutoRetry, Manual, Skip\n * - Exponential backoff for retries (1s→2s→4s→8s→16s) max 3 attempts\n * - Conflict logging and manual review tracking\n * - Decision tree for strategy selection\n *\n * Conflict Types:\n * - DataMismatch: local != remote (pick remote as source of truth)\n * - DuplicateKey: ID already exists in target (skip, log)\n * - ValidationError: data fails target system validation (manual review)\n * - AuthError: permission denied on target system (manual review)\n * - RetryExhausted: Max retries exceeded, require manual intervention\n *\n * Resolution Strategies:\n * - AutoRetry: Exponential backoff with jitter, max 3 attempts\n * - Manual: Stop batch, log to activity_log for user review\n * - Skip: Continue sync, mark item as skipped, log reason\n */\n\nimport { query } from '@/lib/database';\nimport { v4 as uuidv4 } from 'uuid';\n\nexport type ConflictType =\n  | 'DataMismatch'\n  | 'DuplicateKey'\n  | 'ValidationError'\n  | 'AuthError'\n  | 'RetryExhausted'\n  | 'ManualReviewRequired';\n\nexport type ResolutionStrategy = 'auto-retry' | 'manual' | 'skip';\n\nexport interface Conflict {\n  itemId: string;\n  entityType: string;\n  sourceData: Record<string, any>;\n  targetData: Record<string, any>;\n  retryCount: number;\n}\n\nexport interface ConflictDetails {\n  syncId: string;\n  itemId: string;\n  entityType: string;\n  type: ConflictType;\n  data: Record<string, any>;\n}\n\nexport interface ResolutionResult {\n  resolved: boolean;\n  action: 'auto-retry' | 'manual' | 'skip' | 'use_resolved';\n  data?: Record<string, any>;\n  reason?: string;\n}\n\nexport class ConflictResolver {\n  private readonly MAX_AUTO_RETRIES = 3;\n  private readonly RETRY_BACKOFF_BASE = 1000; // 1 second\n  private readonly RETRY_BACKOFF_MULTIPLIER = 2;\n  private readonly MAX_BACKOFF = 16000; // 16 seconds\n\n  /**\n   * Main conflict resolution method\n   * Returns resolution action and optional resolved data\n   */\n  async resolveConflict(conflict: Conflict, retryCount: number): Promise<ResolutionResult> {\n    // Detect conflict type\n    const conflictType = await this.detectConflictType(conflict);\n\n    console.log(\n      `[ConflictResolver] Detected ${conflictType} conflict for item ${conflict.itemId} (retry ${retryCount})`\n    );\n\n    // Get resolution strategy based on conflict type and retry count\n    const strategy = this.getConflictStrategy(conflictType, retryCount);\n\n    console.log(\n      `[ConflictResolver] Resolved to strategy: ${strategy} for ${conflictType} conflict`\n    );\n\n    // Apply resolution strategy\n    switch (strategy) {\n      case 'auto-retry':\n        return await this.handleAutoRetry(conflict, retryCount, conflictType);\n\n      case 'manual':\n        return {\n          resolved: false,\n          action: 'manual',\n          reason: `${conflictType} requires manual intervention`,\n        };\n\n      case 'skip':\n        return {\n          resolved: true,\n          action: 'skip',\n          reason: `${conflictType} - skipping item`,\n        };\n\n      default:\n        return {\n          resolved: false,\n          action: 'manual',\n          reason: 'Unknown conflict type',\n        };\n    }\n  }\n\n  /**\n   * Detect what type of conflict exists\n   */\n  private async detectConflictType(conflict: Conflict): Promise<ConflictType> {\n    // Check for data mismatch (different values for same field)\n    const mismatchedFields = this.findMismatchedFields(\n      conflict.sourceData,\n      conflict.targetData\n    );\n\n    if (mismatchedFields.length > 0) {\n      console.log(\n        `[ConflictResolver] Data mismatch detected in fields: ${mismatchedFields.join(', ')}`\n      );\n      return 'DataMismatch';\n    }\n\n    // Check for duplicate key (ID exists in both but differs)\n    if (\n      conflict.sourceData.id &&\n      conflict.targetData.id &&\n      conflict.sourceData.id !== conflict.targetData.id\n    ) {\n      console.log(\n        `[ConflictResolver] Duplicate key detected: ${conflict.sourceData.id} vs ${conflict.targetData.id}`\n      );\n      return 'DuplicateKey';\n    }\n\n    // Check for validation errors (data doesn't match required schema)\n    const validationError = await this.validateData(conflict.targetData);\n    if (validationError) {\n      console.log(`[ConflictResolver] Validation error: ${validationError}`);\n      return 'ValidationError';\n    }\n\n    // Default: no conflict detected\n    return 'DataMismatch'; // Default for unresolved differences\n  }\n\n  /**\n   * Find fields where source and target data differ\n   */\n  private findMismatchedFields(\n    sourceData: Record<string, any>,\n    targetData: Record<string, any>\n  ): string[] {\n    const mismatched: string[] = [];\n\n    // Compare all keys in source\n    for (const key of Object.keys(sourceData)) {\n      if (targetData.hasOwnProperty(key)) {\n        const sourceValue = JSON.stringify(sourceData[key]);\n        const targetValue = JSON.stringify(targetData[key]);\n\n        if (sourceValue !== targetValue) {\n          mismatched.push(key);\n        }\n      }\n    }\n\n    // Check for extra keys in target\n    for (const key of Object.keys(targetData)) {\n      if (!sourceData.hasOwnProperty(key) && targetData[key] !== null) {\n        mismatched.push(key);\n      }\n    }\n\n    return mismatched;\n  }\n\n  /**\n   * Validate data against target system schema\n   * Returns error message if invalid, null if valid\n   */\n  private async validateData(data: Record<string, any>): Promise<string | null> {\n    // Basic validation checks\n    const required = ['name', 'email'];\n\n    for (const field of required) {\n      if (!data[field] || (typeof data[field] === 'string' && data[field].trim() === '')) {\n        return `Required field missing: ${field}`;\n      }\n    }\n\n    // Email format validation\n    if (data.email) {\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n      if (!emailRegex.test(data.email)) {\n        return `Invalid email format: ${data.email}`;\n      }\n    }\n\n    // Phone format validation if present\n    if (data.phone) {\n      const phoneRegex = /^\\+?[\\d\\s\\-()]+$/;\n      if (!phoneRegex.test(data.phone)) {\n        return `Invalid phone format: ${data.phone}`;\n      }\n    }\n\n    return null; // Data is valid\n  }\n\n  /**\n   * Get resolution strategy based on conflict type and retry count\n   *\n   * Decision tree:\n   * - DataMismatch + retry < 3: AutoRetry\n   * - ValidationError: Manual\n   * - AuthError: Manual\n   * - DuplicateKey: Skip\n   * - RetryExhausted: Manual\n   */\n  getConflictStrategy(\n    conflictType: ConflictType,\n    retryCount: number\n  ): ResolutionStrategy {\n    switch (conflictType) {\n      case 'DataMismatch':\n        // Retry data mismatches up to 3 times (might be timing issue)\n        return retryCount < this.MAX_AUTO_RETRIES ? 'auto-retry' : 'manual';\n\n      case 'ValidationError':\n        // Validation errors need manual review\n        return 'manual';\n\n      case 'AuthError':\n        // Auth errors need manual review (permissions issue)\n        return 'manual';\n\n      case 'DuplicateKey':\n        // Duplicate keys are skipped (non-critical)\n        return 'skip';\n\n      case 'RetryExhausted':\n        // Exhausted retries require manual review\n        return 'manual';\n\n      case 'ManualReviewRequired':\n        return 'manual';\n\n      default:\n        return 'manual';\n    }\n  }\n\n  /**\n   * Handle auto-retry strategy with exponential backoff\n   */\n  private async handleAutoRetry(\n    conflict: Conflict,\n    retryCount: number,\n    conflictType: ConflictType\n  ): Promise<ResolutionResult> {\n    if (retryCount >= this.MAX_AUTO_RETRIES) {\n      console.log(\n        `[ConflictResolver] Max retries (${this.MAX_AUTO_RETRIES}) exceeded for item ${conflict.itemId}`\n      );\n      return {\n        resolved: false,\n        action: 'manual',\n        reason: 'Max retries exceeded',\n      };\n    }\n\n    // Calculate backoff delay with jitter\n    const delay = this.calculateBackoffDelay(retryCount);\n    const jitter = Math.random() * 1000; // Add up to 1s jitter\n\n    console.log(\n      `[ConflictResolver] Auto-retry ${retryCount + 1}/${this.MAX_AUTO_RETRIES}: ${conflictType}. Backing off for ${delay + jitter}ms`\n    );\n\n    // Wait before retrying\n    await this.sleep(delay + jitter);\n\n    // Attempt to resolve data mismatch\n    const resolvedData = this.resolveDataMismatch(conflict.sourceData, conflict.targetData);\n\n    return {\n      resolved: true,\n      action: 'use_resolved',\n      data: resolvedData,\n      reason: `Auto-resolved after backoff (attempt ${retryCount + 1})`,\n    };\n  }\n\n  /**\n   * Calculate exponential backoff delay\n   */\n  private calculateBackoffDelay(retryCount: number): number {\n    const exponentialDelay = this.RETRY_BACKOFF_BASE * Math.pow(this.RETRY_BACKOFF_MULTIPLIER, retryCount);\n    return Math.min(exponentialDelay, this.MAX_BACKOFF);\n  }\n\n  /**\n   * Resolve data mismatch by picking remote as source of truth\n   * Merge source data with target overrides\n   */\n  private resolveDataMismatch(\n    sourceData: Record<string, any>,\n    targetData: Record<string, any>\n  ): Record<string, any> {\n    // Strategy: Use source as base, apply target overrides (remote is source of truth)\n    return {\n      ...sourceData,\n      ...targetData,\n      // Preserve timestamps\n      updated_at: new Date().toISOString(),\n      resolved_conflict: true,\n      resolution_strategy: 'remote_source_of_truth',\n    };\n  }\n\n  /**\n   * Record unresolved conflict for manual intervention\n   */\n  async recordConflict(conflictDetails: ConflictDetails): Promise<void> {\n    try {\n      const conflictId = `conflict-${uuidv4()}`;\n\n      await query(\n        `INSERT INTO sync_conflict (\n          id, sync_id, item_id, entity_type, conflict_type,\n          data, is_resolved, created_at\n        ) VALUES ($1, $2, $3, $4, $5, $6, false, NOW())`,\n        [\n          conflictId,\n          conflictDetails.syncId,\n          conflictDetails.itemId,\n          conflictDetails.entityType,\n          conflictDetails.type,\n          JSON.stringify(conflictDetails.data),\n        ]\n      );\n\n      console.log(\n        `[ConflictResolver] Recorded conflict ${conflictId} for manual review`\n      );\n    } catch (error) {\n      console.error('[ConflictResolver] Failed to record conflict:', error);\n      // Don't throw - conflict recording shouldn't break sync\n    }\n  }\n\n  /**\n   * Get unresolved conflicts for manual review\n   */\n  async getUnresolvedConflicts(\n    syncId: string,\n    limit: number = 100\n  ): Promise<Array<{ id: string; itemId: string; type: ConflictType; data: Record<string, any> }>> {\n    try {\n      const result = await query(\n        `SELECT id, item_id, conflict_type, data\n         FROM sync_conflict\n         WHERE sync_id = $1 AND is_resolved = false\n         ORDER BY created_at DESC\n         LIMIT $2`,\n        [syncId, limit]\n      );\n\n      return result.rows.map(row => ({\n        id: row.id,\n        itemId: row.item_id,\n        type: row.conflict_type as ConflictType,\n        data: row.data,\n      }));\n    } catch (error) {\n      console.error('[ConflictResolver] Failed to fetch unresolved conflicts:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Resolve a conflict manually (mark as resolved by user)\n   */\n  async resolveConflictManually(\n    conflictId: string,\n    resolution: 'accept' | 'reject' | 'custom',\n    customData?: Record<string, any>\n  ): Promise<void> {\n    try {\n      const setClauses = [\n        'is_resolved = true',\n        'resolution_action = $1',\n        'resolved_at = NOW()',\n      ];\n      const values: any[] = [resolution];\n      let paramIndex = 2;\n\n      if (resolution === 'custom' && customData) {\n        setClauses.push(`resolved_data = $${paramIndex}`);\n        values.push(JSON.stringify(customData));\n        paramIndex++;\n      }\n\n      values.push(conflictId);\n\n      await query(\n        `UPDATE sync_conflict\n         SET ${setClauses.join(', ')}\n         WHERE id = $${paramIndex}`,\n        values\n      );\n\n      console.log(`[ConflictResolver] Manually resolved conflict ${conflictId}`);\n    } catch (error) {\n      console.error('[ConflictResolver] Failed to resolve conflict manually:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get conflict statistics for a sync\n   */\n  async getConflictStats(syncId: string): Promise<{\n    totalConflicts: number;\n    unresolvedCount: number;\n    byType: Record<ConflictType, number>;\n  }> {\n    try {\n      const result = await query(\n        `SELECT conflict_type, COUNT(*) as count\n         FROM sync_conflict\n         WHERE sync_id = $1\n         GROUP BY conflict_type`,\n        [syncId]\n      );\n\n      const byType: Record<ConflictType, number> = {} as any;\n      let totalConflicts = 0;\n\n      result.rows.forEach(row => {\n        const type = row.conflict_type as ConflictType;\n        byType[type] = parseInt(row.count);\n        totalConflicts += parseInt(row.count);\n      });\n\n      const unresolvedResult = await query(\n        `SELECT COUNT(*) as count FROM sync_conflict WHERE sync_id = $1 AND is_resolved = false`,\n        [syncId]\n      );\n\n      return {\n        totalConflicts,\n        unresolvedCount: parseInt(unresolvedResult.rows[0].count),\n        byType,\n      };\n    } catch (error) {\n      console.error('[ConflictResolver] Failed to get conflict stats:', error);\n      return { totalConflicts: 0, unresolvedCount: 0, byType: {} as Record<ConflictType, number> };\n    }\n  }\n\n  /**\n   * Sleep utility\n   */\n  private sleep(ms: number): Promise<void> {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\services\\LoyaltyAnalyticsService.ts","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":713,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":716,"endColumn":13,"suggestions":[{"messageId":"addBrackets","fix":{"range":[21555,21846],"text":"{ const programs = await query<{ id: string }>(\n            `SELECT id FROM loyalty_program WHERE org_id = $1`,\n            [orgId]\n          );\n          data.programs = await Promise.all(\n            programs.rows.map((p) => this.getProgramMetrics(p.id, orgId))\n          );\n          break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":738,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":754,"endColumn":13,"suggestions":[{"messageId":"addBrackets","fix":{"range":[22442,23195],"text":"{ const expiryResult = await query<any>(\n            `SELECT\n              lt.customer_id,\n              c.name as customer_name,\n              SUM(lt.points_amount) as points_expiring,\n              lt.expires_at as expiry_date\n             FROM loyalty_transaction lt\n             JOIN customer c ON lt.customer_id = c.id\n             WHERE lt.org_id = $1\n               AND lt.transaction_type = 'earn'\n               AND lt.expires_at IS NOT NULL\n               AND lt.expires_at > NOW()\n               AND lt.expires_at <= NOW() + INTERVAL '30 days'\n             GROUP BY lt.customer_id, c.name, lt.expires_at\n             ORDER BY lt.expires_at`,\n            [orgId]\n          );\n          data.upcomingExpiries = expiryResult.rows;\n          break; }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Loyalty Analytics Service\n *\n * Provides comprehensive analytics, leaderboards, reports, and metrics for\n * the loyalty and rewards system. Uses database views and functions for\n * optimized performance.\n *\n * Author: Backend System Architect\n * Date: 2025-11-02\n */\n\nimport { query } from '@/lib/database';\nimport {\n  LoyaltyLeaderboardEntry,\n  RewardAnalytics,\n  LoyaltyTier,\n  LoyaltyError,\n  CustomerRewardsSummary,\n} from '@/types/loyalty';\n\n// ============================================================================\n// TYPES FOR SERVICE METHODS\n// ============================================================================\n\nexport interface LeaderboardOptions {\n  tier?: LoyaltyTier;\n  limit?: number;\n  offset?: number;\n  period?: 'month' | 'quarter' | 'year' | 'all';\n}\n\nexport interface RankInfo {\n  customerId: string;\n  customerName: string;\n  currentTier: LoyaltyTier;\n  totalPointsEarned: number;\n  pointsBalance: number;\n  tierRank: number;\n  overallRank: number;\n  percentile: number;\n}\n\nexport interface DateRange {\n  startDate: Date;\n  endDate: Date;\n}\n\nexport interface ProgramMetrics {\n  programId: string;\n  programName: string;\n  totalMembers: number;\n  activeMembers: number;\n  tierDistribution: Record<LoyaltyTier, number>;\n  totalPointsIssued: number;\n  totalPointsRedeemed: number;\n  totalPointsOutstanding: number;\n  totalPointsExpired: number;\n  redemptionRate: number;\n  avgPointsPerCustomer: number;\n  avgLifetimeValue: number;\n  topRewards: Array<{\n    rewardId: string;\n    rewardName: string;\n    redemptionCount: number;\n  }>;\n  recentActivity: {\n    transactionsToday: number;\n    transactionsThisWeek: number;\n    transactionsThisMonth: number;\n    redemptionsToday: number;\n    redemptionsThisWeek: number;\n    redemptionsThisMonth: number;\n  };\n}\n\nexport interface PointsFlowData {\n  date: string;\n  earned: number;\n  redeemed: number;\n  expired: number;\n  netChange: number;\n}\n\nexport interface RewardPerformanceData {\n  rewardId: string;\n  rewardName: string;\n  rewardType: string;\n  totalRedemptions: number;\n  uniqueCustomers: number;\n  totalPointsSpent: number;\n  conversionRate: number;\n  avgFulfillmentHours?: number;\n}\n\nexport interface TrendData {\n  period: string;\n  value: number;\n  change?: number;\n  changePercent?: number;\n}\n\nexport type TimePeriod = 'day' | 'week' | 'month' | 'quarter' | 'year';\n\nexport interface TierDistribution {\n  bronze: number;\n  silver: number;\n  gold: number;\n  platinum: number;\n  diamond: number;\n  total: number;\n}\n\nexport interface EngagementMetrics {\n  activeCustomers: number;\n  totalCustomers: number;\n  engagementRate: number;\n  avgTransactionsPerCustomer: number;\n  avgPointsPerTransaction: number;\n  customersWithRedemptions: number;\n  redemptionParticipationRate: number;\n}\n\nexport type ReportType =\n  | 'program_overview'\n  | 'customer_engagement'\n  | 'reward_performance'\n  | 'tier_progression'\n  | 'points_expiry';\n\nexport interface LoyaltyReport {\n  reportType: ReportType;\n  generatedAt: Date;\n  orgId: string;\n  data: Record<string, any>;\n}\n\nexport interface ExpiryReport {\n  programId: string;\n  upcomingExpiries: Array<{\n    customerId: string;\n    customerName: string;\n    pointsExpiring: number;\n    expiryDate: Date;\n  }>;\n  totalPointsExpiring: number;\n  affectedCustomers: number;\n}\n\n// ============================================================================\n// SERVICE CLASS\n// ============================================================================\n\nexport class LoyaltyAnalyticsService {\n  /**\n   * Get leaderboard using the database view\n   */\n  static async getLeaderboard(\n    orgId: string,\n    options: LeaderboardOptions = {}\n  ): Promise<LoyaltyLeaderboardEntry[]> {\n    try {\n      const { tier, limit = 100, offset = 0, period = 'all' } = options;\n\n      const conditions: string[] = ['org_id = $1'];\n      const params: any[] = [orgId];\n      let paramIndex = 2;\n\n      if (tier) {\n        conditions.push(`current_tier = $${paramIndex}`);\n        params.push(tier);\n        paramIndex++;\n      }\n\n      // Add ordering based on period\n      let orderByClause = 'total_points_earned DESC';\n      if (period === 'month') {\n        orderByClause = 'points_this_month DESC';\n      } else if (period === 'quarter') {\n        orderByClause = 'points_this_quarter DESC';\n      }\n\n      params.push(limit, offset);\n\n      const sql = `\n        SELECT\n          org_id,\n          customer_id,\n          customer_name,\n          company,\n          current_tier::text as current_tier,\n          total_points_earned,\n          points_balance,\n          lifetime_value,\n          referral_count,\n          tier_qualified_date,\n          tier_rank,\n          overall_rank,\n          points_this_month,\n          points_this_quarter\n        FROM loyalty_leaderboard\n        WHERE ${conditions.join(' AND ')}\n        ORDER BY ${orderByClause}\n        LIMIT $${paramIndex} OFFSET $${paramIndex + 1}\n      `;\n\n      const result = await query<LoyaltyLeaderboardEntry>(sql, params);\n      return result.rows;\n    } catch (error) {\n      console.error('[LoyaltyAnalyticsService] Error fetching leaderboard:', error);\n      throw new LoyaltyError(\n        'Failed to fetch leaderboard',\n        'FETCH_LEADERBOARD_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get customer rank information\n   */\n  static async getCustomerRank(\n    customerId: string,\n    orgId: string\n  ): Promise<RankInfo> {\n    try {\n      const sql = `\n        SELECT\n          customer_id,\n          customer_name,\n          current_tier::text as current_tier,\n          total_points_earned,\n          points_balance,\n          tier_rank,\n          overall_rank\n        FROM loyalty_leaderboard\n        WHERE customer_id = $1 AND org_id = $2\n      `;\n\n      const result = await query<any>(sql, [customerId, orgId]);\n\n      if (result.rows.length === 0) {\n        throw new LoyaltyError(\n          'Customer not found in leaderboard',\n          'CUSTOMER_NOT_FOUND',\n          404\n        );\n      }\n\n      const customer = result.rows[0];\n\n      // Calculate percentile\n      const totalCountResult = await query<{ count: string }>(\n        `SELECT COUNT(*) as count FROM loyalty_leaderboard WHERE org_id = $1`,\n        [orgId]\n      );\n      const totalCount = parseInt(totalCountResult.rows[0]?.count || '0', 10);\n      const percentile =\n        totalCount > 0\n          ? ((totalCount - customer.overall_rank + 1) / totalCount) * 100\n          : 0;\n\n      return {\n        customerId: customer.customer_id,\n        customerName: customer.customer_name,\n        currentTier: customer.current_tier,\n        totalPointsEarned: Number(customer.total_points_earned),\n        pointsBalance: Number(customer.points_balance),\n        tierRank: Number(customer.tier_rank),\n        overallRank: Number(customer.overall_rank),\n        percentile: Math.round(percentile * 100) / 100,\n      };\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyAnalyticsService] Error fetching customer rank:', error);\n      throw new LoyaltyError(\n        'Failed to fetch customer rank',\n        'FETCH_RANK_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get comprehensive program metrics\n   */\n  static async getProgramMetrics(\n    programId: string,\n    orgId: string,\n    dateRange?: DateRange\n  ): Promise<ProgramMetrics> {\n    try {\n      // Get program name\n      const programResult = await query<{ name: string }>(\n        `SELECT name FROM loyalty_program WHERE id = $1 AND org_id = $2`,\n        [programId, orgId]\n      );\n\n      if (programResult.rows.length === 0) {\n        throw new LoyaltyError('Program not found', 'PROGRAM_NOT_FOUND', 404);\n      }\n\n      const programName = programResult.rows[0].name;\n\n      // Get member counts\n      const memberStats = await query<any>(\n        `SELECT\n          COUNT(*) as total_members,\n          COUNT(*) FILTER (WHERE points_balance > 0) as active_members,\n          SUM(total_points_earned) as total_points_issued,\n          SUM(total_points_redeemed) as total_points_redeemed,\n          SUM(points_balance) as total_points_outstanding,\n          AVG(points_balance) as avg_points_per_customer,\n          AVG(lifetime_value) as avg_lifetime_value\n         FROM customer_loyalty\n         WHERE program_id = $1 AND org_id = $2`,\n        [programId, orgId]\n      );\n\n      const stats = memberStats.rows[0];\n\n      // Get tier distribution\n      const tierDist = await this.getTierDistribution(orgId, programId);\n\n      // Get points expired\n      const expiredResult = await query<{ total: string }>(\n        `SELECT SUM(ABS(points_amount)) as total\n         FROM loyalty_transaction\n         WHERE program_id = $1 AND transaction_type = 'expire'`,\n        [programId]\n      );\n\n      const totalPointsExpired = Number(expiredResult.rows[0]?.total || 0);\n\n      // Calculate redemption rate\n      const totalIssued = Number(stats.total_points_issued || 0);\n      const totalRedeemed = Number(stats.total_points_redeemed || 0);\n      const redemptionRate =\n        totalIssued > 0 ? (totalRedeemed / totalIssued) * 100 : 0;\n\n      // Get top rewards\n      const topRewardsResult = await query<any>(\n        `SELECT rc.id as reward_id, rc.name as reward_name, COUNT(rr.id) as redemption_count\n         FROM reward_catalog rc\n         LEFT JOIN reward_redemption rr ON rc.id = rr.reward_id\n         WHERE rc.program_id = $1 OR rc.program_id IS NULL\n         GROUP BY rc.id, rc.name\n         ORDER BY redemption_count DESC\n         LIMIT 5`,\n        [programId]\n      );\n\n      const topRewards = topRewardsResult.rows.map((r) => ({\n        rewardId: r.reward_id,\n        rewardName: r.reward_name,\n        redemptionCount: Number(r.redemption_count || 0),\n      }));\n\n      // Get recent activity\n      const activityResult = await query<any>(\n        `SELECT\n          COUNT(*) FILTER (WHERE created_at >= CURRENT_DATE) as transactions_today,\n          COUNT(*) FILTER (WHERE created_at >= CURRENT_DATE - INTERVAL '7 days') as transactions_this_week,\n          COUNT(*) FILTER (WHERE created_at >= date_trunc('month', CURRENT_DATE)) as transactions_this_month\n         FROM loyalty_transaction\n         WHERE program_id = $1`,\n        [programId]\n      );\n\n      const redemptionActivityResult = await query<any>(\n        `SELECT\n          COUNT(*) FILTER (WHERE redeemed_at >= CURRENT_DATE) as redemptions_today,\n          COUNT(*) FILTER (WHERE redeemed_at >= CURRENT_DATE - INTERVAL '7 days') as redemptions_this_week,\n          COUNT(*) FILTER (WHERE redeemed_at >= date_trunc('month', CURRENT_DATE)) as redemptions_this_month\n         FROM reward_redemption rr\n         JOIN customer_loyalty cl ON rr.customer_id = cl.customer_id\n         WHERE cl.program_id = $1`,\n        [programId]\n      );\n\n      const activity = activityResult.rows[0];\n      const redemptionActivity = redemptionActivityResult.rows[0];\n\n      return {\n        programId,\n        programName,\n        totalMembers: parseInt(stats.total_members || '0', 10),\n        activeMembers: parseInt(stats.active_members || '0', 10),\n        tierDistribution: tierDist,\n        totalPointsIssued: Number(stats.total_points_issued || 0),\n        totalPointsRedeemed: Number(stats.total_points_redeemed || 0),\n        totalPointsOutstanding: Number(stats.total_points_outstanding || 0),\n        totalPointsExpired,\n        redemptionRate: Math.round(redemptionRate * 100) / 100,\n        avgPointsPerCustomer: Math.round(Number(stats.avg_points_per_customer || 0)),\n        avgLifetimeValue: Math.round(Number(stats.avg_lifetime_value || 0) * 100) / 100,\n        topRewards,\n        recentActivity: {\n          transactionsToday: parseInt(activity.transactions_today || '0', 10),\n          transactionsThisWeek: parseInt(activity.transactions_this_week || '0', 10),\n          transactionsThisMonth: parseInt(activity.transactions_this_month || '0', 10),\n          redemptionsToday: parseInt(redemptionActivity.redemptions_today || '0', 10),\n          redemptionsThisWeek: parseInt(redemptionActivity.redemptions_this_week || '0', 10),\n          redemptionsThisMonth: parseInt(redemptionActivity.redemptions_this_month || '0', 10),\n        },\n      };\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyAnalyticsService] Error fetching program metrics:', error);\n      throw new LoyaltyError(\n        'Failed to fetch program metrics',\n        'FETCH_METRICS_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get points flow over time\n   */\n  static async getPointsFlow(\n    programId: string,\n    orgId: string,\n    period: 'day' | 'week' | 'month' = 'day'\n  ): Promise<PointsFlowData[]> {\n    try {\n      let truncFunction = 'day';\n      let intervalDays = 30;\n\n      if (period === 'week') {\n        truncFunction = 'week';\n        intervalDays = 90;\n      } else if (period === 'month') {\n        truncFunction = 'month';\n        intervalDays = 365;\n      }\n\n      const sql = `\n        SELECT\n          date_trunc($3, created_at)::date as date,\n          SUM(CASE WHEN transaction_type IN ('earn', 'bonus') THEN points_amount ELSE 0 END) as earned,\n          SUM(CASE WHEN transaction_type = 'redeem' THEN ABS(points_amount) ELSE 0 END) as redeemed,\n          SUM(CASE WHEN transaction_type = 'expire' THEN ABS(points_amount) ELSE 0 END) as expired,\n          SUM(points_amount) as net_change\n        FROM loyalty_transaction\n        WHERE program_id = $1\n          AND org_id = $2\n          AND created_at >= CURRENT_DATE - INTERVAL '${intervalDays} days'\n        GROUP BY date_trunc($3, created_at)\n        ORDER BY date\n      `;\n\n      const result = await query<any>(sql, [programId, orgId, truncFunction]);\n\n      return result.rows.map((row) => ({\n        date: row.date,\n        earned: Number(row.earned || 0),\n        redeemed: Number(row.redeemed || 0),\n        expired: Number(row.expired || 0),\n        netChange: Number(row.net_change || 0),\n      }));\n    } catch (error) {\n      console.error('[LoyaltyAnalyticsService] Error fetching points flow:', error);\n      throw new LoyaltyError(\n        'Failed to fetch points flow',\n        'FETCH_POINTS_FLOW_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get reward performance data using the analytics view\n   */\n  static async getRewardPerformance(\n    orgId: string\n  ): Promise<RewardPerformanceData[]> {\n    try {\n      const sql = `\n        SELECT\n          reward_id,\n          reward_name,\n          reward_type::text as reward_type,\n          total_redemptions,\n          unique_customers,\n          total_points_spent,\n          avg_fulfillment_hours,\n          CASE\n            WHEN unique_customers > 0\n            THEN (fulfilled_redemptions::numeric / total_redemptions * 100)\n            ELSE 0\n          END as conversion_rate\n        FROM reward_analytics\n        WHERE org_id = $1\n        ORDER BY total_redemptions DESC\n      `;\n\n      const result = await query<any>(sql, [orgId]);\n\n      return result.rows.map((row) => ({\n        rewardId: row.reward_id,\n        rewardName: row.reward_name,\n        rewardType: row.reward_type,\n        totalRedemptions: Number(row.total_redemptions || 0),\n        uniqueCustomers: Number(row.unique_customers || 0),\n        totalPointsSpent: Number(row.total_points_spent || 0),\n        conversionRate: Math.round(Number(row.conversion_rate || 0) * 100) / 100,\n        avgFulfillmentHours: row.avg_fulfillment_hours\n          ? Math.round(Number(row.avg_fulfillment_hours) * 100) / 100\n          : undefined,\n      }));\n    } catch (error) {\n      console.error('[LoyaltyAnalyticsService] Error fetching reward performance:', error);\n      throw new LoyaltyError(\n        'Failed to fetch reward performance',\n        'FETCH_PERFORMANCE_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get redemption trends over time\n   */\n  static async getRedemptionTrends(\n    orgId: string,\n    period: TimePeriod = 'month'\n  ): Promise<TrendData[]> {\n    try {\n      const intervalMap = {\n        day: 30,\n        week: 90,\n        month: 365,\n        quarter: 730,\n        year: 1825,\n      };\n\n      const intervalDays = intervalMap[period];\n\n      const sql = `\n        SELECT\n          date_trunc($2, redeemed_at)::date as period,\n          COUNT(*) as value\n        FROM reward_redemption\n        WHERE org_id = $1\n          AND redeemed_at >= CURRENT_DATE - INTERVAL '${intervalDays} days'\n        GROUP BY date_trunc($2, redeemed_at)\n        ORDER BY period\n      `;\n\n      const result = await query<any>(sql, [orgId, period]);\n\n      return result.rows.map((row, index, arr) => {\n        const value = Number(row.value || 0);\n        const change = index > 0 ? value - Number(arr[index - 1].value || 0) : undefined;\n        const changePercent =\n          index > 0 && arr[index - 1].value > 0\n            ? ((value - Number(arr[index - 1].value)) / Number(arr[index - 1].value)) * 100\n            : undefined;\n\n        return {\n          period: row.period,\n          value,\n          change,\n          changePercent: changePercent ? Math.round(changePercent * 100) / 100 : undefined,\n        };\n      });\n    } catch (error) {\n      console.error('[LoyaltyAnalyticsService] Error fetching redemption trends:', error);\n      throw new LoyaltyError(\n        'Failed to fetch redemption trends',\n        'FETCH_TRENDS_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get tier distribution\n   */\n  static async getTierDistribution(\n    orgId: string,\n    programId?: string\n  ): Promise<TierDistribution> {\n    try {\n      const conditions = ['org_id = $1'];\n      const params: any[] = [orgId];\n\n      if (programId) {\n        conditions.push('program_id = $2');\n        params.push(programId);\n      }\n\n      const sql = `\n        SELECT\n          current_tier::text as tier,\n          COUNT(*) as count\n        FROM customer_loyalty\n        WHERE ${conditions.join(' AND ')}\n        GROUP BY current_tier\n      `;\n\n      const result = await query<{ tier: string; count: string }>(sql, params);\n\n      const distribution: TierDistribution = {\n        bronze: 0,\n        silver: 0,\n        gold: 0,\n        platinum: 0,\n        diamond: 0,\n        total: 0,\n      };\n\n      result.rows.forEach((row) => {\n        const tier = row.tier as LoyaltyTier;\n        const count = parseInt(row.count, 10);\n        distribution[tier] = count;\n        distribution.total += count;\n      });\n\n      return distribution;\n    } catch (error) {\n      console.error('[LoyaltyAnalyticsService] Error fetching tier distribution:', error);\n      throw new LoyaltyError(\n        'Failed to fetch tier distribution',\n        'FETCH_TIER_DIST_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get engagement metrics\n   */\n  static async getEngagementMetrics(orgId: string): Promise<EngagementMetrics> {\n    try {\n      const sql = `\n        SELECT\n          COUNT(*) as total_customers,\n          COUNT(*) FILTER (WHERE points_balance > 0) as active_customers,\n          COUNT(DISTINCT lt.customer_id) as customers_with_transactions,\n          COUNT(DISTINCT rr.customer_id) as customers_with_redemptions,\n          AVG(txn_count.count) as avg_transactions_per_customer,\n          AVG(txn_points.avg_points) as avg_points_per_transaction\n        FROM customer_loyalty cl\n        LEFT JOIN loyalty_transaction lt ON cl.customer_id = lt.customer_id\n        LEFT JOIN reward_redemption rr ON cl.customer_id = rr.customer_id\n        LEFT JOIN LATERAL (\n          SELECT COUNT(*) as count\n          FROM loyalty_transaction\n          WHERE customer_id = cl.customer_id\n        ) txn_count ON true\n        LEFT JOIN LATERAL (\n          SELECT AVG(ABS(points_amount)) as avg_points\n          FROM loyalty_transaction\n          WHERE customer_id = cl.customer_id\n        ) txn_points ON true\n        WHERE cl.org_id = $1\n      `;\n\n      const result = await query<any>(sql, [orgId]);\n      const metrics = result.rows[0];\n\n      const totalCustomers = parseInt(metrics.total_customers || '0', 10);\n      const activeCustomers = parseInt(metrics.active_customers || '0', 10);\n      const customersWithRedemptions = parseInt(metrics.customers_with_redemptions || '0', 10);\n\n      return {\n        activeCustomers,\n        totalCustomers,\n        engagementRate:\n          totalCustomers > 0\n            ? Math.round((activeCustomers / totalCustomers) * 100 * 100) / 100\n            : 0,\n        avgTransactionsPerCustomer: Math.round(Number(metrics.avg_transactions_per_customer || 0)),\n        avgPointsPerTransaction: Math.round(Number(metrics.avg_points_per_transaction || 0)),\n        customersWithRedemptions,\n        redemptionParticipationRate:\n          totalCustomers > 0\n            ? Math.round((customersWithRedemptions / totalCustomers) * 100 * 100) / 100\n            : 0,\n      };\n    } catch (error) {\n      console.error('[LoyaltyAnalyticsService] Error fetching engagement metrics:', error);\n      throw new LoyaltyError(\n        'Failed to fetch engagement metrics',\n        'FETCH_ENGAGEMENT_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Generate comprehensive loyalty report\n   */\n  static async generateLoyaltyReport(\n    orgId: string,\n    reportType: ReportType\n  ): Promise<LoyaltyReport> {\n    try {\n      const data: Record<string, any> = {};\n\n      switch (reportType) {\n        case 'program_overview':\n          // Get all programs and their metrics\n          const programs = await query<{ id: string }>(\n            `SELECT id FROM loyalty_program WHERE org_id = $1`,\n            [orgId]\n          );\n          data.programs = await Promise.all(\n            programs.rows.map((p) => this.getProgramMetrics(p.id, orgId))\n          );\n          break;\n\n        case 'customer_engagement':\n          data.engagement = await this.getEngagementMetrics(orgId);\n          data.tierDistribution = await this.getTierDistribution(orgId);\n          break;\n\n        case 'reward_performance':\n          data.performance = await this.getRewardPerformance(orgId);\n          break;\n\n        case 'tier_progression':\n          data.tierDistribution = await this.getTierDistribution(orgId);\n          data.leaderboard = await this.getLeaderboard(orgId, { limit: 50 });\n          break;\n\n        case 'points_expiry':\n          // Get upcoming expiries\n          const expiryResult = await query<any>(\n            `SELECT\n              lt.customer_id,\n              c.name as customer_name,\n              SUM(lt.points_amount) as points_expiring,\n              lt.expires_at as expiry_date\n             FROM loyalty_transaction lt\n             JOIN customer c ON lt.customer_id = c.id\n             WHERE lt.org_id = $1\n               AND lt.transaction_type = 'earn'\n               AND lt.expires_at IS NOT NULL\n               AND lt.expires_at > NOW()\n               AND lt.expires_at <= NOW() + INTERVAL '30 days'\n             GROUP BY lt.customer_id, c.name, lt.expires_at\n             ORDER BY lt.expires_at`,\n            [orgId]\n          );\n          data.upcomingExpiries = expiryResult.rows;\n          break;\n      }\n\n      return {\n        reportType,\n        generatedAt: new Date(),\n        orgId,\n        data,\n      };\n    } catch (error) {\n      console.error('[LoyaltyAnalyticsService] Error generating report:', error);\n      throw new LoyaltyError(\n        'Failed to generate loyalty report',\n        'GENERATE_REPORT_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Schedule expiry report for upcoming point expirations\n   */\n  static async scheduleExpiryReport(\n    programId: string,\n    orgId: string\n  ): Promise<ExpiryReport> {\n    try {\n      const sql = `\n        SELECT\n          lt.customer_id,\n          c.name as customer_name,\n          SUM(lt.points_amount) as points_expiring,\n          MIN(lt.expires_at) as expiry_date\n        FROM loyalty_transaction lt\n        JOIN customer c ON lt.customer_id = c.id\n        JOIN customer_loyalty cl ON lt.customer_id = cl.customer_id\n        WHERE cl.program_id = $1\n          AND cl.org_id = $2\n          AND lt.transaction_type = 'earn'\n          AND lt.expires_at IS NOT NULL\n          AND lt.expires_at > NOW()\n          AND lt.expires_at <= NOW() + INTERVAL '30 days'\n          AND NOT EXISTS (\n            SELECT 1 FROM loyalty_transaction lt2\n            WHERE lt2.reference_type = 'expiry'\n              AND lt2.reference_id = lt.id\n          )\n        GROUP BY lt.customer_id, c.name\n        ORDER BY expiry_date\n      `;\n\n      const result = await query<any>(sql, [programId, orgId]);\n\n      const upcomingExpiries = result.rows.map((row) => ({\n        customerId: row.customer_id,\n        customerName: row.customer_name,\n        pointsExpiring: Number(row.points_expiring || 0),\n        expiryDate: row.expiry_date,\n      }));\n\n      const totalPointsExpiring = upcomingExpiries.reduce(\n        (sum, item) => sum + item.pointsExpiring,\n        0\n      );\n\n      return {\n        programId,\n        upcomingExpiries,\n        totalPointsExpiring,\n        affectedCustomers: upcomingExpiries.length,\n      };\n    } catch (error) {\n      console.error('[LoyaltyAnalyticsService] Error scheduling expiry report:', error);\n      throw new LoyaltyError(\n        'Failed to schedule expiry report',\n        'SCHEDULE_EXPIRY_REPORT_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\services\\LoyaltyRuleService.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":25,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":25,"endColumn":32,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[637,730],"text":"type CreateRuleData = LoyaltyRuleInsert"},"desc":"Replace empty interface with a type alias."}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":29,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":29,"endColumn":32,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[739,832],"text":"type UpdateRuleData = LoyaltyRuleUpdate"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Loyalty Rule Service\n *\n * Manages loyalty rules for automated points awards, including CRUD operations,\n * rule evaluation, testing, and priority management.\n *\n * Author: Backend System Architect\n * Date: 2025-11-02\n */\n\nimport { query, withTransaction } from '@/lib/database';\nimport {\n  LoyaltyRule,\n  LoyaltyRuleInsert,\n  LoyaltyRuleUpdate,\n  LoyaltyRuleConditions,\n  RuleTriggerType,\n  LoyaltyError,\n} from '@/types/loyalty';\n\n// ============================================================================\n// TYPES FOR SERVICE METHODS\n// ============================================================================\n\nexport interface CreateRuleData extends LoyaltyRuleInsert {\n  // All fields from LoyaltyRuleInsert\n}\n\nexport interface UpdateRuleData extends LoyaltyRuleUpdate {\n  // All fields from LoyaltyRuleUpdate\n}\n\nexport interface RuleContext {\n  orderAmount?: number;\n  productCategories?: string[];\n  productIds?: string[];\n  customerTier?: string;\n  customerSegment?: string;\n  orderCount?: number;\n  metadata?: Record<string, any>;\n}\n\nexport interface RuleEvaluation {\n  applicable: boolean;\n  pointsMultiplier: number;\n  bonusPoints: number;\n  totalPoints?: number;\n  rulesApplied: Array<{\n    ruleId: string;\n    ruleName: string;\n    multiplier: number;\n    bonusPoints: number;\n  }>;\n}\n\nexport interface RuleTestData {\n  context: RuleContext;\n  basePoints?: number;\n}\n\nexport interface RuleTestResult {\n  conditionsMet: boolean;\n  pointsMultiplier: number;\n  bonusPoints: number;\n  totalPoints: number;\n  evaluationDetails: Record<string, any>;\n}\n\n// ============================================================================\n// SERVICE CLASS\n// ============================================================================\n\nexport class LoyaltyRuleService {\n  /**\n   * Create a new loyalty rule\n   */\n  static async createRule(\n    data: CreateRuleData,\n    orgId: string\n  ): Promise<LoyaltyRule> {\n    try {\n      return await withTransaction(async (client) => {\n        // Verify program exists and belongs to org\n        const programCheck = await client.query(\n          `SELECT id FROM loyalty_program\n           WHERE id = $1 AND org_id = $2`,\n          [data.program_id, orgId]\n        );\n\n        if (programCheck.rows.length === 0) {\n          throw new LoyaltyError(\n            'Loyalty program not found',\n            'PROGRAM_NOT_FOUND',\n            404\n          );\n        }\n\n        // Validate conditions\n        this.validateConditions(data.conditions || {});\n\n        const sql = `\n          INSERT INTO loyalty_rule (\n            org_id,\n            program_id,\n            name,\n            description,\n            trigger_type,\n            conditions,\n            points_multiplier,\n            bonus_points,\n            is_active,\n            priority,\n            valid_from,\n            valid_until\n          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)\n          RETURNING\n            id,\n            org_id,\n            program_id,\n            name,\n            description,\n            trigger_type,\n            conditions,\n            points_multiplier,\n            bonus_points,\n            is_active,\n            priority,\n            valid_from,\n            valid_until,\n            created_at,\n            updated_at\n        `;\n\n        const result = await client.query<LoyaltyRule>(sql, [\n          orgId,\n          data.program_id,\n          data.name,\n          data.description || null,\n          data.trigger_type,\n          JSON.stringify(data.conditions || {}),\n          data.points_multiplier ?? 1.0,\n          data.bonus_points ?? 0,\n          data.is_active ?? true,\n          data.priority ?? 0,\n          data.valid_from || new Date(),\n          data.valid_until || null,\n        ]);\n\n        return result.rows[0];\n      });\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyRuleService] Error creating rule:', error);\n      throw new LoyaltyError(\n        'Failed to create loyalty rule',\n        'CREATE_RULE_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Update an existing loyalty rule\n   */\n  static async updateRule(\n    ruleId: string,\n    data: UpdateRuleData,\n    orgId: string\n  ): Promise<LoyaltyRule> {\n    try {\n      // Validate conditions if provided\n      if (data.conditions) {\n        this.validateConditions(data.conditions);\n      }\n\n      const setClauses: string[] = [];\n      const values: any[] = [];\n      let paramIndex = 1;\n\n      if (data.name !== undefined) {\n        setClauses.push(`name = $${paramIndex}`);\n        values.push(data.name);\n        paramIndex++;\n      }\n\n      if (data.description !== undefined) {\n        setClauses.push(`description = $${paramIndex}`);\n        values.push(data.description);\n        paramIndex++;\n      }\n\n      if (data.trigger_type !== undefined) {\n        setClauses.push(`trigger_type = $${paramIndex}`);\n        values.push(data.trigger_type);\n        paramIndex++;\n      }\n\n      if (data.conditions !== undefined) {\n        setClauses.push(`conditions = $${paramIndex}`);\n        values.push(JSON.stringify(data.conditions));\n        paramIndex++;\n      }\n\n      if (data.points_multiplier !== undefined) {\n        setClauses.push(`points_multiplier = $${paramIndex}`);\n        values.push(data.points_multiplier);\n        paramIndex++;\n      }\n\n      if (data.bonus_points !== undefined) {\n        setClauses.push(`bonus_points = $${paramIndex}`);\n        values.push(data.bonus_points);\n        paramIndex++;\n      }\n\n      if (data.is_active !== undefined) {\n        setClauses.push(`is_active = $${paramIndex}`);\n        values.push(data.is_active);\n        paramIndex++;\n      }\n\n      if (data.priority !== undefined) {\n        setClauses.push(`priority = $${paramIndex}`);\n        values.push(data.priority);\n        paramIndex++;\n      }\n\n      if (data.valid_from !== undefined) {\n        setClauses.push(`valid_from = $${paramIndex}`);\n        values.push(data.valid_from);\n        paramIndex++;\n      }\n\n      if (data.valid_until !== undefined) {\n        setClauses.push(`valid_until = $${paramIndex}`);\n        values.push(data.valid_until);\n        paramIndex++;\n      }\n\n      if (setClauses.length === 0) {\n        throw new LoyaltyError('No fields to update', 'NO_UPDATES', 400);\n      }\n\n      setClauses.push(`updated_at = NOW()`);\n      values.push(ruleId, orgId);\n\n      const sql = `\n        UPDATE loyalty_rule\n        SET ${setClauses.join(', ')}\n        WHERE id = $${paramIndex} AND org_id = $${paramIndex + 1}\n        RETURNING\n          id,\n          org_id,\n          program_id,\n          name,\n          description,\n          trigger_type,\n          conditions,\n          points_multiplier,\n          bonus_points,\n          is_active,\n          priority,\n          valid_from,\n          valid_until,\n          created_at,\n          updated_at\n      `;\n\n      const result = await query<LoyaltyRule>(sql, values);\n\n      if (result.rows.length === 0) {\n        throw new LoyaltyError('Rule not found', 'RULE_NOT_FOUND', 404);\n      }\n\n      return result.rows[0];\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyRuleService] Error updating rule:', error);\n      throw new LoyaltyError(\n        'Failed to update loyalty rule',\n        'UPDATE_RULE_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Delete a loyalty rule\n   */\n  static async deleteRule(ruleId: string, orgId: string): Promise<void> {\n    try {\n      const result = await query(\n        `DELETE FROM loyalty_rule WHERE id = $1 AND org_id = $2`,\n        [ruleId, orgId]\n      );\n\n      if (result.rowCount === 0) {\n        throw new LoyaltyError('Rule not found', 'RULE_NOT_FOUND', 404);\n      }\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyRuleService] Error deleting rule:', error);\n      throw new LoyaltyError(\n        'Failed to delete loyalty rule',\n        'DELETE_RULE_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get a loyalty rule by ID\n   */\n  static async getRule(ruleId: string, orgId: string): Promise<LoyaltyRule> {\n    try {\n      const sql = `\n        SELECT\n          id,\n          org_id,\n          program_id,\n          name,\n          description,\n          trigger_type,\n          conditions,\n          points_multiplier,\n          bonus_points,\n          is_active,\n          priority,\n          valid_from,\n          valid_until,\n          created_at,\n          updated_at\n        FROM loyalty_rule\n        WHERE id = $1 AND org_id = $2\n      `;\n\n      const result = await query<LoyaltyRule>(sql, [ruleId, orgId]);\n\n      if (result.rows.length === 0) {\n        throw new LoyaltyError('Rule not found', 'RULE_NOT_FOUND', 404);\n      }\n\n      return result.rows[0];\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyRuleService] Error fetching rule:', error);\n      throw new LoyaltyError(\n        'Failed to fetch loyalty rule',\n        'FETCH_RULE_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * List all rules for a program\n   */\n  static async listRules(\n    programId: string,\n    orgId: string\n  ): Promise<LoyaltyRule[]> {\n    try {\n      const sql = `\n        SELECT\n          id,\n          org_id,\n          program_id,\n          name,\n          description,\n          trigger_type,\n          conditions,\n          points_multiplier,\n          bonus_points,\n          is_active,\n          priority,\n          valid_from,\n          valid_until,\n          created_at,\n          updated_at\n        FROM loyalty_rule\n        WHERE program_id = $1 AND org_id = $2\n        ORDER BY priority DESC, created_at DESC\n      `;\n\n      const result = await query<LoyaltyRule>(sql, [programId, orgId]);\n      return result.rows;\n    } catch (error) {\n      console.error('[LoyaltyRuleService] Error listing rules:', error);\n      throw new LoyaltyError(\n        'Failed to list loyalty rules',\n        'LIST_RULES_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get active rules for a program\n   */\n  static async getActiveRules(\n    programId: string,\n    orgId: string,\n    triggerType?: RuleTriggerType\n  ): Promise<LoyaltyRule[]> {\n    try {\n      const conditions: string[] = [\n        'program_id = $1',\n        'org_id = $2',\n        'is_active = true',\n        '(valid_from IS NULL OR valid_from <= NOW())',\n        '(valid_until IS NULL OR valid_until > NOW())',\n      ];\n      const params: any[] = [programId, orgId];\n\n      if (triggerType) {\n        conditions.push('trigger_type = $3');\n        params.push(triggerType);\n      }\n\n      const sql = `\n        SELECT\n          id,\n          org_id,\n          program_id,\n          name,\n          description,\n          trigger_type,\n          conditions,\n          points_multiplier,\n          bonus_points,\n          is_active,\n          priority,\n          valid_from,\n          valid_until,\n          created_at,\n          updated_at\n        FROM loyalty_rule\n        WHERE ${conditions.join(' AND ')}\n        ORDER BY priority DESC\n      `;\n\n      const result = await query<LoyaltyRule>(sql, params);\n      return result.rows;\n    } catch (error) {\n      console.error('[LoyaltyRuleService] Error fetching active rules:', error);\n      throw new LoyaltyError(\n        'Failed to fetch active rules',\n        'FETCH_ACTIVE_RULES_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Activate a rule\n   */\n  static async activateRule(ruleId: string, orgId: string): Promise<void> {\n    try {\n      const result = await query(\n        `UPDATE loyalty_rule\n         SET is_active = true, updated_at = NOW()\n         WHERE id = $1 AND org_id = $2`,\n        [ruleId, orgId]\n      );\n\n      if (result.rowCount === 0) {\n        throw new LoyaltyError('Rule not found', 'RULE_NOT_FOUND', 404);\n      }\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyRuleService] Error activating rule:', error);\n      throw new LoyaltyError(\n        'Failed to activate rule',\n        'ACTIVATE_RULE_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Deactivate a rule\n   */\n  static async deactivateRule(ruleId: string, orgId: string): Promise<void> {\n    try {\n      const result = await query(\n        `UPDATE loyalty_rule\n         SET is_active = false, updated_at = NOW()\n         WHERE id = $1 AND org_id = $2`,\n        [ruleId, orgId]\n      );\n\n      if (result.rowCount === 0) {\n        throw new LoyaltyError('Rule not found', 'RULE_NOT_FOUND', 404);\n      }\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyRuleService] Error deactivating rule:', error);\n      throw new LoyaltyError(\n        'Failed to deactivate rule',\n        'DEACTIVATE_RULE_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Evaluate rules for a given context\n   */\n  static async evaluateRules(\n    programId: string,\n    context: RuleContext,\n    orgId: string,\n    triggerType: RuleTriggerType = 'order_placed'\n  ): Promise<RuleEvaluation> {\n    try {\n      const activeRules = await this.getActiveRules(\n        programId,\n        orgId,\n        triggerType\n      );\n\n      let totalMultiplier = 1.0;\n      let totalBonusPoints = 0;\n      const rulesApplied: RuleEvaluation['rulesApplied'] = [];\n\n      for (const rule of activeRules) {\n        const conditionsMet = this.checkConditions(rule.conditions, context);\n\n        if (conditionsMet) {\n          totalMultiplier *= rule.points_multiplier;\n          totalBonusPoints += rule.bonus_points;\n          rulesApplied.push({\n            ruleId: rule.id,\n            ruleName: rule.name,\n            multiplier: rule.points_multiplier,\n            bonusPoints: rule.bonus_points,\n          });\n        }\n      }\n\n      return {\n        applicable: rulesApplied.length > 0,\n        pointsMultiplier: totalMultiplier,\n        bonusPoints: totalBonusPoints,\n        rulesApplied,\n      };\n    } catch (error) {\n      console.error('[LoyaltyRuleService] Error evaluating rules:', error);\n      throw new LoyaltyError(\n        'Failed to evaluate rules',\n        'EVALUATE_RULES_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Test a rule with sample data\n   */\n  static async testRule(\n    ruleId: string,\n    testData: RuleTestData,\n    orgId: string\n  ): Promise<RuleTestResult> {\n    try {\n      const rule = await this.getRule(ruleId, orgId);\n      const basePoints = testData.basePoints || 100;\n\n      const conditionsMet = this.checkConditions(\n        rule.conditions,\n        testData.context\n      );\n\n      let totalPoints = basePoints;\n      if (conditionsMet) {\n        totalPoints = Math.floor(basePoints * rule.points_multiplier);\n        totalPoints += rule.bonus_points;\n      }\n\n      const evaluationDetails = this.getEvaluationDetails(\n        rule.conditions,\n        testData.context\n      );\n\n      return {\n        conditionsMet,\n        pointsMultiplier: rule.points_multiplier,\n        bonusPoints: rule.bonus_points,\n        totalPoints,\n        evaluationDetails,\n      };\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyRuleService] Error testing rule:', error);\n      throw new LoyaltyError(\n        'Failed to test rule',\n        'TEST_RULE_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Update rule priority\n   */\n  static async updatePriority(\n    ruleId: string,\n    priority: number,\n    orgId: string\n  ): Promise<void> {\n    try {\n      const result = await query(\n        `UPDATE loyalty_rule\n         SET priority = $1, updated_at = NOW()\n         WHERE id = $2 AND org_id = $3`,\n        [priority, ruleId, orgId]\n      );\n\n      if (result.rowCount === 0) {\n        throw new LoyaltyError('Rule not found', 'RULE_NOT_FOUND', 404);\n      }\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[LoyaltyRuleService] Error updating priority:', error);\n      throw new LoyaltyError(\n        'Failed to update rule priority',\n        'UPDATE_PRIORITY_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Reorder rules by setting new priorities\n   */\n  static async reorderRules(\n    programId: string,\n    ruleOrder: string[],\n    orgId: string\n  ): Promise<void> {\n    try {\n      await withTransaction(async (client) => {\n        for (let i = 0; i < ruleOrder.length; i++) {\n          const priority = ruleOrder.length - i; // Higher index = higher priority\n          await client.query(\n            `UPDATE loyalty_rule\n             SET priority = $1, updated_at = NOW()\n             WHERE id = $2 AND program_id = $3 AND org_id = $4`,\n            [priority, ruleOrder[i], programId, orgId]\n          );\n        }\n      });\n    } catch (error) {\n      console.error('[LoyaltyRuleService] Error reordering rules:', error);\n      throw new LoyaltyError(\n        'Failed to reorder rules',\n        'REORDER_RULES_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  // ============================================================================\n  // PRIVATE HELPER METHODS\n  // ============================================================================\n\n  /**\n   * Validate rule conditions structure\n   */\n  private static validateConditions(conditions: LoyaltyRuleConditions): void {\n    // Validate min/max order amounts\n    if (\n      conditions.min_order_amount !== undefined &&\n      conditions.max_order_amount !== undefined\n    ) {\n      if (conditions.min_order_amount > conditions.max_order_amount) {\n        throw new LoyaltyError(\n          'min_order_amount cannot be greater than max_order_amount',\n          'INVALID_CONDITIONS',\n          400\n        );\n      }\n    }\n\n    // Validate order count\n    if (\n      conditions.order_count_min !== undefined &&\n      conditions.order_count_max !== undefined\n    ) {\n      if (conditions.order_count_min > conditions.order_count_max) {\n        throw new LoyaltyError(\n          'order_count_min cannot be greater than order_count_max',\n          'INVALID_CONDITIONS',\n          400\n        );\n      }\n    }\n  }\n\n  /**\n   * Check if all conditions are met\n   */\n  private static checkConditions(\n    conditions: LoyaltyRuleConditions,\n    context: RuleContext\n  ): boolean {\n    // Check min order amount\n    if (\n      conditions.min_order_amount !== undefined &&\n      context.orderAmount !== undefined\n    ) {\n      if (context.orderAmount < conditions.min_order_amount) {\n        return false;\n      }\n    }\n\n    // Check max order amount\n    if (\n      conditions.max_order_amount !== undefined &&\n      context.orderAmount !== undefined\n    ) {\n      if (context.orderAmount > conditions.max_order_amount) {\n        return false;\n      }\n    }\n\n    // Check product categories\n    if (\n      conditions.product_categories &&\n      conditions.product_categories.length > 0\n    ) {\n      if (!context.productCategories || context.productCategories.length === 0) {\n        return false;\n      }\n      const hasMatch = conditions.product_categories.some((cat) =>\n        context.productCategories!.includes(cat)\n      );\n      if (!hasMatch) {\n        return false;\n      }\n    }\n\n    // Check product IDs\n    if (conditions.product_ids && conditions.product_ids.length > 0) {\n      if (!context.productIds || context.productIds.length === 0) {\n        return false;\n      }\n      const hasMatch = conditions.product_ids.some((id) =>\n        context.productIds!.includes(id)\n      );\n      if (!hasMatch) {\n        return false;\n      }\n    }\n\n    // Check customer tier\n    if (conditions.customer_tier && conditions.customer_tier.length > 0) {\n      if (!context.customerTier) {\n        return false;\n      }\n      if (!conditions.customer_tier.includes(context.customerTier as any)) {\n        return false;\n      }\n    }\n\n    // Check customer segment\n    if (\n      conditions.customer_segment &&\n      conditions.customer_segment.length > 0\n    ) {\n      if (!context.customerSegment) {\n        return false;\n      }\n      if (!conditions.customer_segment.includes(context.customerSegment)) {\n        return false;\n      }\n    }\n\n    // Check order count\n    if (\n      conditions.order_count_min !== undefined &&\n      context.orderCount !== undefined\n    ) {\n      if (context.orderCount < conditions.order_count_min) {\n        return false;\n      }\n    }\n\n    if (\n      conditions.order_count_max !== undefined &&\n      context.orderCount !== undefined\n    ) {\n      if (context.orderCount > conditions.order_count_max) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * Get detailed evaluation information for testing\n   */\n  private static getEvaluationDetails(\n    conditions: LoyaltyRuleConditions,\n    context: RuleContext\n  ): Record<string, any> {\n    const details: Record<string, any> = {};\n\n    if (conditions.min_order_amount !== undefined) {\n      details.minOrderAmount = {\n        required: conditions.min_order_amount,\n        actual: context.orderAmount,\n        met:\n          context.orderAmount !== undefined &&\n          context.orderAmount >= conditions.min_order_amount,\n      };\n    }\n\n    if (conditions.max_order_amount !== undefined) {\n      details.maxOrderAmount = {\n        required: conditions.max_order_amount,\n        actual: context.orderAmount,\n        met:\n          context.orderAmount !== undefined &&\n          context.orderAmount <= conditions.max_order_amount,\n      };\n    }\n\n    if (conditions.customer_tier && conditions.customer_tier.length > 0) {\n      details.customerTier = {\n        required: conditions.customer_tier,\n        actual: context.customerTier,\n        met:\n          context.customerTier !== undefined &&\n          conditions.customer_tier.includes(context.customerTier as any),\n      };\n    }\n\n    return details;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\services\\PriceListProcessor.ts","messages":[{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":522,"column":13,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":522,"endColumn":59,"suggestions":[{"messageId":"addBrackets","fix":{"range":[17216,17384],"text":"{ const mergedEntry = this.mergeEntries(entries)\r\n            mergedEntry._isUpdate = hasExistingRecord\r\n            processedEntries.push(mergedEntry)\r\n            break }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":692,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":692,"endColumn":73,"suggestions":[{"messageId":"addBrackets","fix":{"range":[22521,22751],"text":"{ const numValue = parseFloat(stringValue.replace(/[^\\d.-]/g, ''))\r\n        if (isNaN(numValue) || numValue < 0) {\r\n          throw new Error(`Invalid ${fieldName}: must be a non-negative number`)\r\n        }\r\n        return numValue }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":699,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":699,"endColumn":66,"suggestions":[{"messageId":"addBrackets","fix":{"range":[22788,22999],"text":"{ const qty = parseInt(stringValue.replace(/[^\\d.-]/g, ''))\r\n        if (isNaN(qty) || qty < 0) {\r\n          throw new Error('Invalid stock quantity: must be a non-negative integer')\r\n        }\r\n        return qty }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":706,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":706,"endColumn":71,"suggestions":[{"messageId":"addBrackets","fix":{"range":[23033,23141],"text":"{ const weight = parseFloat(stringValue.replace(/[^\\d.-]/g, ''))\r\n        return isNaN(weight) ? null : weight }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":710,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":710,"endColumn":47,"suggestions":[{"messageId":"addBrackets","fix":{"range":[23177,23366],"text":"{ const curr = stringValue.toUpperCase()\r\n        if (!['USD', 'EUR', 'GBP', 'ZAR', 'CAD', 'AUD'].includes(curr)) {\r\n          return 'ZAR' // Default currency\r\n        }\r\n        return curr }"},"desc":"Add {} brackets around the case block."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Pool } from 'pg'\r\nimport * as XLSX from 'xlsx'\r\nimport * as fs from 'fs/promises'\r\nimport * as path from 'path'\r\nimport { createHash } from 'crypto'\r\nimport { z } from 'zod'\r\nimport { pool } from '@/lib/database'\nimport { upsertSupplierProduct, setStock } from '@/services/ssot/inventoryService'\n\r\n// ============================================================================\r\n// COMPREHENSIVE PRICE LIST PROCESSING SERVICE\r\n// Backend service for automated processing of supplier price list files\r\n// ============================================================================\r\n\r\n// Data validation schemas\r\nconst PriceListEntrySchema = z.object({\r\n  sku: z.string().min(1, 'SKU is required'),\r\n  name: z.string().min(1, 'Product name is required'),\r\n  description: z.string().optional(),\r\n  category: z.string().min(1, 'Category is required'),\r\n  subcategory: z.string().optional(),\r\n  brand: z.string().optional(),\r\n  supplier_sku: z.string().optional(),\r\n  cost_price: z.number().min(0, 'Cost price must be non-negative'),\r\n  sale_price: z.number().optional(),\r\n  currency: z.string().default('ZAR'),\r\n  stock_qty: z.number().min(0, 'Stock quantity must be non-negative'),\r\n  unit: z.string().default('pcs'),\r\n  weight: z.number().optional(),\r\n  barcode: z.string().optional(),\r\n  tags: z.array(z.string()).default([]),\r\n  notes: z.string().optional(),\r\n})\r\n\r\nconst ProcessingConfigSchema = z.object({\r\n  supplierId: z.string().uuid(),\r\n  filePath: z.string(),\r\n  options: z.object({\r\n    skipEmptyRows: z.boolean().default(true),\r\n    validateData: z.boolean().default(true),\r\n    createBackup: z.boolean().default(true),\r\n    batchSize: z.number().min(1).max(1000).default(100),\r\n    duplicateHandling: z.enum(['skip', 'update', 'create_variant']).default('update'),\r\n    enableLogging: z.boolean().default(true),\r\n  }).default({}),\r\n})\r\n\r\n// Types\r\ninterface ProcessingResult {\r\n  success: boolean\r\n  sessionId: string\r\n  totalProcessed: number\r\n  created: number\r\n  updated: number\r\n  skipped: number\r\n  errors: ProcessingError[]\r\n  summary: ProcessingSummary\r\n  backupId?: string\r\n  executionTime: number\r\n}\r\n\r\ninterface ProcessingError {\r\n  row: number\r\n  field?: string\r\n  message: string\r\n  severity: 'warning' | 'error'\r\n  data?: any\r\n}\r\n\r\ninterface ProcessingSummary {\r\n  fileInfo: {\r\n    filename: string\r\n    size: number\r\n    format: string\r\n    sheets?: string[]\r\n  }\r\n  dataQuality: {\r\n    validRows: number\r\n    invalidRows: number\r\n    duplicates: number\r\n    missingRequired: number\r\n    priceInconsistencies: number\r\n  }\r\n  businessImpact: {\r\n    totalValue: number\r\n    newCategories: string[]\r\n    newBrands: string[]\r\n    priceChanges: number\r\n    stockUpdates: number\r\n  }\r\n}\r\n\r\ninterface ParsedData {\r\n  headers: string[]\r\n  rows: any[][]\r\n  metadata: {\r\n    sheetName?: string\r\n    totalRows: number\r\n    format: string\r\n  }\r\n}\r\n\r\nexport class PriceListProcessor {\r\n  private pool: Pool\r\n  private processingSession: Map<string, any> = new Map()\r\n\r\n  constructor(databasePool?: Pool) {\r\n    this.pool = databasePool || pool\r\n  }\r\n\r\n  /**\r\n   * Main entry point for processing price list files\r\n   */\r\n  async processFile(config: any): Promise<ProcessingResult> {\r\n    const startTime = Date.now()\r\n    const validatedConfig = ProcessingConfigSchema.parse(config)\r\n    const sessionId = this.generateSessionId()\r\n\r\n    console.log(`🚀 Starting price list processing - Session: ${sessionId}`)\r\n\r\n    try {\r\n      // Initialize processing session\r\n      this.processingSession.set(sessionId, {\r\n        config: validatedConfig,\r\n        status: 'initializing',\r\n        progress: 0,\r\n        startTime,\r\n      })\r\n\r\n      // Step 1: Parse and validate file format\r\n      const parsedData = await this.parseFile(validatedConfig.filePath)\r\n      this.updateSession(sessionId, { status: 'parsing', progress: 10 })\r\n\r\n      // Step 2: Auto-detect field mappings\r\n      const fieldMappings = await this.detectFieldMappings(parsedData.headers)\r\n      this.updateSession(sessionId, { status: 'mapping', progress: 20 })\r\n\r\n      // Step 3: Transform and validate data\r\n      const validatedData = await this.validateAndTransformData(\r\n        parsedData,\r\n        fieldMappings,\r\n        validatedConfig\r\n      )\r\n      this.updateSession(sessionId, { status: 'validating', progress: 40 })\r\n\r\n      // Step 4: Handle duplicates and conflicts\r\n      const deduplicatedData = await this.handleDuplicates(\r\n        validatedData,\r\n        validatedConfig.options.duplicateHandling\r\n      )\r\n      this.updateSession(sessionId, { status: 'deduplicating', progress: 60 })\r\n\r\n      // Step 5: Create backup if required\r\n      let backupId: string | undefined\r\n      if (validatedConfig.options.createBackup) {\r\n        backupId = await this.createBackup(validatedConfig.supplierId, deduplicatedData.validEntries)\r\n        this.updateSession(sessionId, { status: 'backup', progress: 70 })\r\n      }\r\n\r\n      // Step 6: Bulk import to database\r\n      const importResult = await this.bulkImport(\r\n        deduplicatedData.validEntries,\r\n        validatedConfig.supplierId,\r\n        validatedConfig.options.batchSize\r\n      )\r\n      this.updateSession(sessionId, { status: 'importing', progress: 90 })\r\n\r\n      // Step 7: Generate comprehensive summary\r\n      const summary = await this.generateSummary(\r\n        parsedData,\r\n        validatedData,\r\n        importResult\r\n      )\r\n      this.updateSession(sessionId, { status: 'completed', progress: 100 })\r\n\r\n      const executionTime = Date.now() - startTime\r\n\r\n      console.log(`✅ Price list processing completed - Session: ${sessionId} (${executionTime}ms)`)\r\n\r\n      return {\r\n        success: true,\r\n        sessionId,\r\n        totalProcessed: importResult.totalProcessed,\r\n        created: importResult.created,\r\n        updated: importResult.updated,\r\n        skipped: importResult.skipped,\r\n        errors: [...validatedData.errors, ...importResult.errors],\r\n        summary,\r\n        backupId,\r\n        executionTime,\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error(`❌ Price list processing failed - Session: ${sessionId}:`, error)\r\n\r\n      this.updateSession(sessionId, {\r\n        status: 'failed',\r\n        error: error instanceof Error ? error.message : 'Unknown error'\r\n      })\r\n\r\n      throw new Error(`Price list processing failed: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse various file formats (Excel, CSV, etc.)\r\n   */\r\n  private async parseFile(filePath: string): Promise<ParsedData> {\r\n    const fileExtension = path.extname(filePath).toLowerCase()\r\n    const fileStats = await fs.stat(filePath)\r\n\r\n    console.log(`📄 Parsing file: ${path.basename(filePath)} (${fileStats.size} bytes)`)\r\n\r\n    try {\r\n      switch (fileExtension) {\r\n        case '.xlsx':\r\n        case '.xls':\r\n          return this.parseExcelFile(filePath)\r\n        case '.csv':\r\n          return this.parseCSVFile(filePath)\r\n        default:\r\n          throw new Error(`Unsupported file format: ${fileExtension}`)\r\n      }\r\n    } catch (error) {\r\n      throw new Error(`File parsing failed: ${error instanceof Error ? error.message : 'Unknown error'}`)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse Excel files with support for multiple sheets\r\n   */\r\n  private async parseExcelFile(filePath: string): Promise<ParsedData> {\r\n    const workbook = XLSX.readFile(filePath)\r\n    const sheetNames = workbook.SheetNames\r\n\r\n    // Use first sheet or find the most likely data sheet\r\n    const targetSheet = this.findDataSheet(workbook, sheetNames)\r\n    const worksheet = workbook.Sheets[targetSheet]\r\n\r\n    const jsonData = XLSX.utils.sheet_to_json(worksheet, {\r\n      header: 1,\r\n      defval: null,\r\n      raw: false,\r\n    })\r\n\r\n    if (jsonData.length < 2) {\r\n      throw new Error('File must contain at least a header row and one data row')\r\n    }\r\n\r\n    const headers = jsonData[0] as string[]\r\n    const rows = jsonData.slice(1) as any[][]\r\n\r\n    // Clean headers\r\n    const cleanHeaders = headers.map(h =>\r\n      typeof h === 'string' ? h.trim().replace(/\\n/g, ' ').replace(/\\s+/g, ' ') : String(h)\r\n    )\r\n\r\n    return {\r\n      headers: cleanHeaders,\r\n      rows: rows.filter(row => row.some(cell => cell !== null && cell !== '')),\r\n      metadata: {\r\n        sheetName: targetSheet,\r\n        totalRows: rows.length,\r\n        format: 'excel',\r\n      },\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse CSV files with automatic delimiter detection\r\n   */\r\n  private async parseCSVFile(filePath: string): Promise<ParsedData> {\r\n    const fileContent = await fs.readFile(filePath, 'utf-8')\r\n\r\n    // Detect delimiter\r\n    const delimiter = this.detectCSVDelimiter(fileContent)\r\n\r\n    const lines = fileContent.split('\\n')\r\n      .map(line => line.trim())\r\n      .filter(line => line.length > 0)\r\n\r\n    if (lines.length < 2) {\r\n      throw new Error('CSV file must contain at least a header row and one data row')\r\n    }\r\n\r\n    const headers = lines[0].split(delimiter).map(h => h.trim().replace(/['\"]/g, ''))\r\n    const rows = lines.slice(1).map(line => {\r\n      return line.split(delimiter).map(cell => {\r\n        const cleaned = cell.trim().replace(/['\"]/g, '')\r\n        return cleaned === '' ? null : cleaned\r\n      });\r\n    })\r\n\r\n    return {\r\n      headers,\r\n      rows: rows.filter(row => row.some(cell => cell !== null && cell !== '')),\r\n      metadata: {\r\n        totalRows: rows.length,\r\n        format: 'csv',\r\n      },\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Auto-detect field mappings using intelligent pattern matching\r\n   */\r\n  private async detectFieldMappings(headers: string[]): Promise<Record<string, string>> {\r\n    const mappings: Record<string, string> = {}\r\n    const normalizedHeaders = headers.map(h => h.toLowerCase().replace(/[^a-z0-9]/g, '_'))\r\n\r\n    const fieldPatterns = {\r\n      sku: ['sku', 'item_code', 'product_code', 'part_number', 'model', 'code'],\r\n      name: ['name', 'product_name', 'item_name', 'title', 'product'],\r\n      description: ['description', 'details', 'product_description', 'desc', 'info'],\r\n      category: ['category', 'type', 'group', 'class', 'division'],\r\n      subcategory: ['subcategory', 'subtype', 'subgroup', 'subclass'],\r\n      brand: ['brand', 'make', 'manufacturer', 'mfg', 'vendor'],\r\n      supplier_sku: ['supplier_sku', 'vendor_sku', 'supplier_code', 'vendor_code'],\r\n      cost_price: ['cost', 'price', 'cost_price', 'unit_price', 'buy_price', 'wholesale'],\r\n      sale_price: ['sale_price', 'retail', 'sell_price', 'list_price', 'msrp'],\r\n      currency: ['currency', 'curr', 'money'],\r\n      stock_qty: ['stock', 'quantity', 'qty', 'inventory', 'on_hand', 'available'],\r\n      unit: ['unit', 'uom', 'measure', 'per'],\r\n      weight: ['weight', 'mass', 'kg', 'grams'],\r\n      barcode: ['barcode', 'upc', 'ean', 'gtin'],\r\n    }\r\n\r\n    // Smart matching with confidence scoring\r\n    for (const [field, patterns] of Object.entries(fieldPatterns)) {\r\n      let bestMatch = { header: '', confidence: 0, index: -1 }\r\n\r\n      normalizedHeaders.forEach((normalizedHeader, index) => {\r\n        for (const pattern of patterns) {\r\n          let confidence = 0\r\n\r\n          if (normalizedHeader === pattern) {\r\n            confidence = 1.0 // Perfect match\r\n          } else if (normalizedHeader.includes(pattern)) {\r\n            confidence = 0.8 // Contains pattern\r\n          } else if (pattern.includes(normalizedHeader)) {\r\n            confidence = 0.6 // Pattern contains header\r\n          } else {\r\n            // Fuzzy matching for common variations\r\n            const similarity = this.calculateStringSimilarity(normalizedHeader, pattern)\r\n            if (similarity > 0.5) {\r\n              confidence = similarity * 0.7\r\n            }\r\n          }\r\n\r\n          if (confidence > bestMatch.confidence) {\r\n            bestMatch = { header: headers[index], confidence, index }\r\n          }\r\n        }\r\n      })\r\n\r\n      // Only use mappings with reasonable confidence\r\n      if (bestMatch.confidence >= 0.5) {\r\n        mappings[field] = bestMatch.header\r\n      }\r\n    }\r\n\r\n    console.log(`🎯 Field mapping confidence: ${Object.keys(mappings).length}/${Object.keys(fieldPatterns).length} fields mapped`)\r\n\r\n    return mappings\r\n  }\r\n\r\n  /**\r\n   * Validate and transform data with comprehensive error checking\r\n   */\r\n  private async validateAndTransformData(\r\n    parsedData: ParsedData,\r\n    fieldMappings: Record<string, string>,\r\n    config: any\r\n  ): Promise<{\r\n    validEntries: any[]\r\n    invalidEntries: any[]\r\n    errors: ProcessingError[]\r\n    stats: any\r\n  }> {\r\n    const validEntries: any[] = []\r\n    const invalidEntries: any[] = []\r\n    const errors: ProcessingError[] = []\r\n    const stats = {\r\n      totalRows: parsedData.rows.length,\r\n      processedRows: 0,\r\n      validRows: 0,\r\n      invalidRows: 0,\r\n    }\r\n\r\n    console.log(`🔍 Validating ${parsedData.rows.length} data rows`)\r\n\r\n    for (let rowIndex = 0; rowIndex < parsedData.rows.length; rowIndex++) {\r\n      const row = parsedData.rows[rowIndex]\r\n      const rowNumber = rowIndex + 2 // Account for header row and 1-based indexing\r\n\r\n      // Skip empty rows if configured\r\n      if (config.options.skipEmptyRows && row.every((cell: any) => !cell || cell.toString().trim() === '')) {\r\n        continue\r\n      }\r\n\r\n      const transformedEntry: any = {}\r\n      let hasErrors = false\r\n      const rowErrors: ProcessingError[] = []\r\n\r\n      // Map and validate each field\r\n      for (const [targetField, sourceHeader] of Object.entries(fieldMappings)) {\r\n        if (!sourceHeader) continue\r\n\r\n        const sourceIndex = parsedData.headers.indexOf(sourceHeader)\r\n        if (sourceIndex === -1) continue\r\n\r\n        const cellValue = row[sourceIndex]\r\n\r\n        try {\r\n          const transformedValue = this.transformFieldValue(targetField, cellValue, rowNumber)\r\n          if (transformedValue !== null) {\r\n            transformedEntry[targetField] = transformedValue\r\n          }\r\n        } catch (error) {\r\n          hasErrors = true\r\n          rowErrors.push({\r\n            row: rowNumber,\r\n            field: targetField,\r\n            message: error instanceof Error ? error.message : 'Transformation failed',\r\n            severity: 'error',\r\n            data: cellValue,\r\n          })\r\n        }\r\n      }\r\n\r\n      // Validate required fields\r\n      const requiredFields = ['sku', 'name', 'category', 'cost_price']\r\n      for (const requiredField of requiredFields) {\r\n        if (!transformedEntry[requiredField]) {\r\n          hasErrors = true\r\n          rowErrors.push({\r\n            row: rowNumber,\r\n            field: requiredField,\r\n            message: `Required field '${requiredField}' is missing or invalid`,\r\n            severity: 'error',\r\n          })\r\n        }\r\n      }\r\n\r\n      // Additional business logic validation\r\n      if (transformedEntry.cost_price && transformedEntry.sale_price) {\r\n        if (transformedEntry.cost_price > transformedEntry.sale_price) {\r\n          rowErrors.push({\r\n            row: rowNumber,\r\n            field: 'sale_price',\r\n            message: 'Sale price is lower than cost price',\r\n            severity: 'warning',\r\n          })\r\n        }\r\n      }\r\n\r\n      if (hasErrors) {\r\n        invalidEntries.push({ ...transformedEntry, _rowNumber: rowNumber, _errors: rowErrors })\r\n        stats.invalidRows++\r\n      } else {\r\n        validEntries.push(transformedEntry)\r\n        stats.validRows++\r\n      }\r\n\r\n      errors.push(...rowErrors)\r\n      stats.processedRows++\r\n\r\n      // Progress logging\r\n      if (stats.processedRows % 1000 === 0) {\r\n        console.log(`📊 Progress: ${stats.processedRows}/${stats.totalRows} rows processed`)\r\n      }\r\n    }\r\n\r\n    console.log(`✅ Data validation completed: ${stats.validRows} valid, ${stats.invalidRows} invalid`)\r\n\r\n    return { validEntries, invalidEntries, errors, stats }\r\n  }\r\n\r\n  /**\r\n   * Handle duplicate entries with configurable strategies\r\n   */\r\n  private async handleDuplicates(\r\n    validatedData: any,\r\n    duplicateHandling: 'skip' | 'update' | 'create_variant'\r\n  ): Promise<any> {\r\n    const { validEntries } = validatedData\r\n    const processedEntries: any[] = []\r\n    const skippedEntries: any[] = []\r\n    const duplicateMap = new Map<string, any[]>()\r\n\r\n    // Group entries by SKU\r\n    for (const entry of validEntries) {\r\n      const sku = entry.sku.toUpperCase()\r\n      if (!duplicateMap.has(sku)) {\r\n        duplicateMap.set(sku, [])\r\n      }\r\n      duplicateMap.get(sku)!.push(entry)\r\n    }\r\n\r\n    // Check against existing database records\r\n    const existingSkus = await this.getExistingSKUs([...duplicateMap.keys()])\r\n\r\n    for (const [sku, entries] of duplicateMap) {\r\n      const hasExistingRecord = existingSkus.has(sku)\r\n\r\n      if (entries.length === 1 && !hasExistingRecord) {\r\n        // No duplicates, add as-is\r\n        processedEntries.push(entries[0])\r\n      } else {\r\n        // Handle duplicates based on strategy\r\n        switch (duplicateHandling) {\r\n          case 'skip':\r\n            if (hasExistingRecord) {\r\n              skippedEntries.push(...entries)\r\n            } else {\r\n              processedEntries.push(entries[0])\r\n              skippedEntries.push(...entries.slice(1))\r\n            }\r\n            break\r\n\r\n          case 'update':\r\n            const mergedEntry = this.mergeEntries(entries)\r\n            mergedEntry._isUpdate = hasExistingRecord\r\n            processedEntries.push(mergedEntry)\r\n            break\r\n\r\n          case 'create_variant':\r\n            for (let i = 0; i < entries.length; i++) {\r\n              const entry = { ...entries[i] }\r\n              if (i > 0 || hasExistingRecord) {\r\n                entry.sku = `${sku}-V${Date.now()}-${i}`\r\n              }\r\n              processedEntries.push(entry)\r\n            }\r\n            break\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log(`🔀 Duplicate handling: ${processedEntries.length} to process, ${skippedEntries.length} skipped`)\r\n\r\n    return {\r\n      ...validatedData,\r\n      validEntries: processedEntries,\r\n      skippedEntries,\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Bulk import data to database with optimized batch processing\r\n   */\r\n  private async bulkImport(\r\n    entries: any[],\r\n    supplierId: string,\r\n    batchSize: number\r\n  ): Promise<{\r\n    totalProcessed: number\r\n    created: number\r\n    updated: number\r\n    skipped: number\r\n    errors: ProcessingError[]\r\n  }> {\r\n    const result = {\r\n      totalProcessed: 0,\r\n      created: 0,\r\n      updated: 0,\r\n      skipped: 0,\r\n      errors: [] as ProcessingError[],\r\n    }\r\n\r\n    const batches = this.createBatches(entries, batchSize)\r\n\r\n    console.log(`💾 Starting bulk import: ${entries.length} entries in ${batches.length} batches`)\r\n\r\n    for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {\r\n      const batch = batches[batchIndex]\r\n      console.log(`📦 Processing batch ${batchIndex + 1}/${batches.length} (${batch.length} items)`)\r\n\r\n      try {\r\n        const batchResult = await this.processBatch(batch, supplierId)\r\n        result.created += batchResult.created\r\n        result.updated += batchResult.updated\r\n        result.skipped += batchResult.skipped\r\n        result.errors.push(...batchResult.errors)\r\n      } catch (error) {\r\n        result.errors.push({\r\n          row: -1,\r\n          message: `Batch ${batchIndex + 1} failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\r\n          severity: 'error',\r\n        })\r\n      }\r\n\r\n      result.totalProcessed += batch.length\r\n    }\r\n\r\n    console.log(`✅ Bulk import completed: ${result.created} created, ${result.updated} updated, ${result.skipped} skipped`)\r\n\r\n    return result\r\n  }\r\n\r\n  // Helper methods continue below...\r\n\r\n  private generateSessionId(): string {\r\n    return `pricelist_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n  }\r\n\r\n  private updateSession(sessionId: string, updates: any): void {\r\n    const current = this.processingSession.get(sessionId) || {}\r\n    this.processingSession.set(sessionId, { ...current, ...updates, updatedAt: new Date() })\r\n  }\r\n\r\n  private findDataSheet(workbook: XLSX.WorkBook, sheetNames: string[]): string {\r\n    // Look for sheets with common data indicators\r\n    const dataIndicators = ['price', 'product', 'inventory', 'stock', 'item']\r\n\r\n    for (const name of sheetNames) {\r\n      const lowerName = name.toLowerCase()\r\n      if (dataIndicators.some(indicator => lowerName.includes(indicator))) {\r\n        return name\r\n      }\r\n    }\r\n\r\n    // Fall back to first sheet\r\n    return sheetNames[0]\r\n  }\r\n\r\n  private detectCSVDelimiter(content: string): string {\r\n    const delimiters = [',', ';', '\\t', '|']\r\n    const sampleLines = content.split('\\n').slice(0, 5)\r\n\r\n    let bestDelimiter = ','\r\n    let maxColumns = 0\r\n\r\n    for (const delimiter of delimiters) {\r\n      const avgColumns = sampleLines.reduce((sum, line) => {\r\n        return sum + line.split(delimiter).length\r\n      }, 0) / sampleLines.length\r\n\r\n      if (avgColumns > maxColumns) {\r\n        maxColumns = avgColumns\r\n        bestDelimiter = delimiter\r\n      }\r\n    }\r\n\r\n    return bestDelimiter\r\n  }\r\n\r\n  private calculateStringSimilarity(str1: string, str2: string): number {\r\n    const longer = str1.length > str2.length ? str1 : str2\r\n    const shorter = str1.length > str2.length ? str2 : str1\r\n\r\n    if (longer.length === 0) return 1.0\r\n\r\n    const editDistance = this.levenshteinDistance(longer, shorter)\r\n    return (longer.length - editDistance) / longer.length\r\n  }\r\n\r\n  private levenshteinDistance(str1: string, str2: string): number {\r\n    const matrix = Array(str2.length + 1).fill(null).map(() => Array(str1.length + 1).fill(null))\r\n\r\n    for (let i = 0; i <= str1.length; i++) matrix[0][i] = i\r\n    for (let j = 0; j <= str2.length; j++) matrix[j][0] = j\r\n\r\n    for (let j = 1; j <= str2.length; j++) {\r\n      for (let i = 1; i <= str1.length; i++) {\r\n        const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1\r\n        matrix[j][i] = Math.min(\r\n          matrix[j][i - 1] + 1,\r\n          matrix[j - 1][i] + 1,\r\n          matrix[j - 1][i - 1] + indicator\r\n        )\r\n      }\r\n    }\r\n\r\n    return matrix[str2.length][str1.length]\r\n  }\r\n\r\n  private transformFieldValue(fieldName: string, value: any, rowNumber: number): any {\r\n    if (value === null || value === undefined || value === '') {\r\n      return null\r\n    }\r\n\r\n    const stringValue = value.toString().trim()\r\n    if (!stringValue) return null\r\n\r\n    switch (fieldName) {\r\n      case 'sku':\r\n        return stringValue.toUpperCase().replace(/[^\\w\\-_.]/g, '');\r\n\r\n      case 'cost_price':\r\n      case 'sale_price':\r\n        const numValue = parseFloat(stringValue.replace(/[^\\d.-]/g, ''))\r\n        if (isNaN(numValue) || numValue < 0) {\r\n          throw new Error(`Invalid ${fieldName}: must be a non-negative number`)\r\n        }\r\n        return numValue\r\n\r\n      case 'stock_qty':\r\n        const qty = parseInt(stringValue.replace(/[^\\d.-]/g, ''))\r\n        if (isNaN(qty) || qty < 0) {\r\n          throw new Error('Invalid stock quantity: must be a non-negative integer')\r\n        }\r\n        return qty\r\n\r\n      case 'weight':\r\n        const weight = parseFloat(stringValue.replace(/[^\\d.-]/g, ''))\r\n        return isNaN(weight) ? null : weight\r\n\r\n      case 'currency':\r\n        const curr = stringValue.toUpperCase()\r\n        if (!['USD', 'EUR', 'GBP', 'ZAR', 'CAD', 'AUD'].includes(curr)) {\r\n          return 'ZAR' // Default currency\r\n        }\r\n        return curr\r\n\r\n      case 'tags':\r\n        if (Array.isArray(value)) return value\r\n        return stringValue.split(/[,;|]/).map(tag => tag.trim()).filter(Boolean);\r\n\r\n      default:\r\n        return stringValue\r\n    }\r\n  }\r\n\r\n  private async getExistingSKUs(skus: string[]): Promise<Set<string>> {\r\n    if (skus.length === 0) return new Set()\r\n\r\n    try {\r\n      const query = 'SELECT sku FROM public.inventory_items WHERE sku = ANY($1)'\r\n      const result = await this.pool.query(query, [skus])\r\n      return new Set(result.rows.map(row => row.sku))\r\n    } catch (error) {\r\n      console.error('Error fetching existing SKUs:', error)\r\n      return new Set()\r\n    }\r\n  }\r\n\r\n  private mergeEntries(entries: any[]): any {\r\n    if (entries.length === 1) return entries[0]\r\n\r\n    const merged = { ...entries[0] }\r\n\r\n    for (let i = 1; i < entries.length; i++) {\r\n      const entry = entries[i]\r\n\r\n      // Use the highest price\r\n      if (entry.cost_price && (!merged.cost_price || entry.cost_price > merged.cost_price)) {\r\n        merged.cost_price = entry.cost_price\r\n      }\r\n\r\n      if (entry.sale_price && (!merged.sale_price || entry.sale_price > merged.sale_price)) {\r\n        merged.sale_price = entry.sale_price\r\n      }\r\n\r\n      // Sum stock quantities\r\n      if (entry.stock_qty) {\r\n        merged.stock_qty = (merged.stock_qty || 0) + entry.stock_qty\r\n      }\r\n\r\n      // Merge tags\r\n      if (entry.tags && Array.isArray(entry.tags)) {\r\n        merged.tags = [...new Set([...(merged.tags || []), ...entry.tags])]\r\n      }\r\n\r\n      // Use the most complete description\r\n      if (entry.description && (!merged.description || entry.description.length > merged.description.length)) {\r\n        merged.description = entry.description\r\n      }\r\n    }\r\n\r\n    return merged\r\n  }\r\n\r\n  private createBatches<T>(items: T[], batchSize: number): T[][] {\r\n    const batches: T[][] = []\r\n    for (let i = 0; i < items.length; i += batchSize) {\r\n      batches.push(items.slice(i, i + batchSize))\r\n    }\r\n    return batches\r\n  }\r\n\r\n  private async processBatch(batch: any[], supplierId: string): Promise<{\r\n    created: number\r\n    updated: number\r\n    skipped: number\r\n    errors: ProcessingError[]\r\n  }> {\r\n    const result = { created: 0, updated: 0, skipped: 0, errors: [] as ProcessingError[] }\r\n\r\n    for (const entry of batch) {\r\n      try {\r\n        if (entry._isUpdate) {\r\n          await this.updateInventoryItem(entry)\r\n          result.updated++\r\n        } else {\r\n          await this.createInventoryItem(entry, supplierId)\r\n          result.created++\r\n        }\r\n      } catch (error) {\r\n        result.skipped++\r\n        result.errors.push({\r\n          row: entry._rowNumber || -1,\r\n          message: error instanceof Error ? error.message : 'Unknown error',\r\n          severity: 'error',\r\n          data: entry,\r\n        })\r\n      }\r\n    }\r\n\r\n    return result\r\n  }\r\n\r\n  private async createInventoryItem(entry: any, supplierId: string): Promise<void> {\n    const spSku = entry.supplier_sku || entry.sku\n    await upsertSupplierProduct({ supplierId, sku: spSku, name: entry.name })\n    await setStock({\n      supplierId,\n      sku: spSku,\n      quantity: entry.stock_qty || 0,\n      unitCost: entry.cost_price,\n      reason: 'Pricelist import'\n    })\n  }\n\r\n  private async updateInventoryItem(entry: any): Promise<void> {\n    const spSku = entry.supplier_sku || entry.sku\n    if (entry.stock_qty !== undefined) {\n      await setStock({\n        supplierId: entry.supplier_id,\n        sku: spSku,\n        quantity: entry.stock_qty,\n        unitCost: entry.cost_price,\n        reason: 'Pricelist update'\n      })\n    }\n  }\n\r\n  private async createBackup(supplierId: string, entries: any[]): Promise<string> {\r\n    const backupId = `backup_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n\r\n    const query = `\r\n      INSERT INTO price_list_backups (\r\n        id, supplier_id, backup_data, entry_count, created_at\r\n      ) VALUES ($1, $2, $3, $4, NOW())\r\n    `\r\n\r\n    await this.pool.query(query, [\r\n      backupId,\r\n      supplierId,\r\n      JSON.stringify(entries),\r\n      entries.length,\r\n    ])\r\n\r\n    return backupId\r\n  }\r\n\r\n  private async generateSummary(\r\n    parsedData: ParsedData,\r\n    validatedData: any,\r\n    importResult: any\r\n  ): Promise<ProcessingSummary> {\r\n    const categories = new Set<string>()\r\n    const brands = new Set<string>()\r\n    let totalValue = 0\r\n\r\n    for (const entry of validatedData.validEntries) {\r\n      if (entry.category) categories.add(entry.category)\r\n      if (entry.brand) brands.add(entry.brand)\r\n      if (entry.cost_price && entry.stock_qty) {\r\n        totalValue += entry.cost_price * entry.stock_qty\r\n      }\r\n    }\r\n\r\n    return {\r\n      fileInfo: {\r\n        filename: parsedData.metadata.sheetName || 'unknown',\r\n        size: 0, // Would be filled from file stats\r\n        format: parsedData.metadata.format,\r\n        sheets: parsedData.metadata.sheetName ? [parsedData.metadata.sheetName] : undefined,\r\n      },\r\n      dataQuality: {\r\n        validRows: validatedData.stats.validRows,\r\n        invalidRows: validatedData.stats.invalidRows,\r\n        duplicates: validatedData.validEntries.length - validatedData.stats.validRows,\r\n        missingRequired: validatedData.errors.filter(e => e.message.includes('required')).length,\r\n        priceInconsistencies: validatedData.errors.filter(e => e.message.includes('price')).length,\r\n      },\r\n      businessImpact: {\r\n        totalValue,\r\n        newCategories: Array.from(categories),\r\n        newBrands: Array.from(brands),\r\n        priceChanges: importResult.updated,\r\n        stockUpdates: importResult.created + importResult.updated,\r\n      },\r\n    }\r\n  }\r\n\r\n  // Public methods for session management\r\n\r\n  getSession(sessionId: string): any {\r\n    return this.processingSession.get(sessionId)\r\n  }\r\n\r\n  clearSession(sessionId: string): boolean {\r\n    return this.processingSession.delete(sessionId)\r\n  }\r\n\r\n  getActiveSessionIds(): string[] {\r\n    return Array.from(this.processingSession.keys())\r\n  }\r\n}\r\n\r\nexport default PriceListProcessor\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\services\\RewardCatalogService.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":26,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":26,"endColumn":34,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[643,742],"text":"type CreateRewardData = RewardCatalogInsert"},"desc":"Replace empty interface with a type alias."}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":30,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":30,"endColumn":34,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[751,850],"text":"type UpdateRewardData = RewardCatalogUpdate"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Reward Catalog Service\n *\n * Manages reward catalog including CRUD operations, stock management,\n * availability checks, and reward analytics.\n *\n * Author: Backend System Architect\n * Date: 2025-11-02\n */\n\nimport { query, withTransaction } from '@/lib/database';\nimport {\n  RewardCatalog,\n  RewardCatalogInsert,\n  RewardCatalogUpdate,\n  RewardAnalytics,\n  RewardType,\n  LoyaltyError,\n  RewardNotAvailableError,\n} from '@/types/loyalty';\n\n// ============================================================================\n// TYPES FOR SERVICE METHODS\n// ============================================================================\n\nexport interface CreateRewardData extends RewardCatalogInsert {\n  // All fields from RewardCatalogInsert\n}\n\nexport interface UpdateRewardData extends RewardCatalogUpdate {\n  // All fields from RewardCatalogUpdate\n}\n\nexport interface RewardFilters {\n  rewardType?: RewardType;\n  isActive?: boolean;\n  isFeatured?: boolean;\n  programId?: string;\n  minPoints?: number;\n  maxPoints?: number;\n  inStock?: boolean;\n}\n\nexport interface PaginatedResult<T> {\n  data: T[];\n  count: number;\n  limit: number;\n  offset: number;\n  hasMore: boolean;\n}\n\nexport interface AvailabilityStatus {\n  available: boolean;\n  reason?: string;\n  inStock: boolean;\n  stockQuantity?: number;\n  isActive: boolean;\n  isValid: boolean;\n  validFrom: Date;\n  validUntil?: Date;\n}\n\n// ============================================================================\n// SERVICE CLASS\n// ============================================================================\n\nexport class RewardCatalogService {\n  /**\n   * Create a new reward in the catalog\n   */\n  static async createReward(\n    data: CreateRewardData,\n    orgId: string\n  ): Promise<RewardCatalog> {\n    try {\n      return await withTransaction(async (client) => {\n        // Validate image URL if provided\n        if (data.image_url) {\n          this.validateImageUrl(data.image_url);\n        }\n\n        // Verify program exists if program_id provided\n        if (data.program_id) {\n          const programCheck = await client.query(\n            `SELECT id FROM loyalty_program\n             WHERE id = $1 AND org_id = $2 AND is_active = true`,\n            [data.program_id, orgId]\n          );\n\n          if (programCheck.rows.length === 0) {\n            throw new LoyaltyError(\n              'Loyalty program not found or inactive',\n              'PROGRAM_NOT_FOUND',\n              404\n            );\n          }\n        }\n\n        const sql = `\n          INSERT INTO reward_catalog (\n            org_id,\n            program_id,\n            name,\n            description,\n            reward_type,\n            points_required,\n            monetary_value,\n            max_redemptions_per_customer,\n            stock_quantity,\n            is_active,\n            is_featured,\n            valid_from,\n            valid_until,\n            terms_conditions,\n            image_url\n          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15)\n          RETURNING\n            id,\n            org_id,\n            program_id,\n            name,\n            description,\n            reward_type::text as reward_type,\n            points_required,\n            monetary_value,\n            max_redemptions_per_customer,\n            stock_quantity,\n            redemption_count,\n            is_active,\n            is_featured,\n            valid_from,\n            valid_until,\n            terms_conditions,\n            image_url,\n            created_at,\n            updated_at\n        `;\n\n        const result = await client.query<RewardCatalog>(sql, [\n          orgId,\n          data.program_id || null,\n          data.name,\n          data.description || null,\n          data.reward_type,\n          data.points_required,\n          data.monetary_value || null,\n          data.max_redemptions_per_customer || null,\n          data.stock_quantity || null,\n          data.is_active ?? true,\n          data.is_featured ?? false,\n          data.valid_from || new Date(),\n          data.valid_until || null,\n          data.terms_conditions ? JSON.stringify(data.terms_conditions) : '{}',\n          data.image_url || null,\n        ]);\n\n        return result.rows[0];\n      });\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[RewardCatalogService] Error creating reward:', error);\n      throw new LoyaltyError(\n        'Failed to create reward',\n        'CREATE_REWARD_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Update an existing reward\n   */\n  static async updateReward(\n    rewardId: string,\n    data: UpdateRewardData,\n    orgId: string\n  ): Promise<RewardCatalog> {\n    try {\n      // Validate image URL if provided\n      if (data.image_url) {\n        this.validateImageUrl(data.image_url);\n      }\n\n      const setClauses: string[] = [];\n      const values: any[] = [];\n      let paramIndex = 1;\n\n      if (data.name !== undefined) {\n        setClauses.push(`name = $${paramIndex}`);\n        values.push(data.name);\n        paramIndex++;\n      }\n\n      if (data.description !== undefined) {\n        setClauses.push(`description = $${paramIndex}`);\n        values.push(data.description);\n        paramIndex++;\n      }\n\n      if (data.reward_type !== undefined) {\n        setClauses.push(`reward_type = $${paramIndex}`);\n        values.push(data.reward_type);\n        paramIndex++;\n      }\n\n      if (data.points_required !== undefined) {\n        setClauses.push(`points_required = $${paramIndex}`);\n        values.push(data.points_required);\n        paramIndex++;\n      }\n\n      if (data.monetary_value !== undefined) {\n        setClauses.push(`monetary_value = $${paramIndex}`);\n        values.push(data.monetary_value);\n        paramIndex++;\n      }\n\n      if (data.max_redemptions_per_customer !== undefined) {\n        setClauses.push(`max_redemptions_per_customer = $${paramIndex}`);\n        values.push(data.max_redemptions_per_customer);\n        paramIndex++;\n      }\n\n      if (data.stock_quantity !== undefined) {\n        setClauses.push(`stock_quantity = $${paramIndex}`);\n        values.push(data.stock_quantity);\n        paramIndex++;\n      }\n\n      if (data.is_active !== undefined) {\n        setClauses.push(`is_active = $${paramIndex}`);\n        values.push(data.is_active);\n        paramIndex++;\n      }\n\n      if (data.is_featured !== undefined) {\n        setClauses.push(`is_featured = $${paramIndex}`);\n        values.push(data.is_featured);\n        paramIndex++;\n      }\n\n      if (data.valid_from !== undefined) {\n        setClauses.push(`valid_from = $${paramIndex}`);\n        values.push(data.valid_from);\n        paramIndex++;\n      }\n\n      if (data.valid_until !== undefined) {\n        setClauses.push(`valid_until = $${paramIndex}`);\n        values.push(data.valid_until);\n        paramIndex++;\n      }\n\n      if (data.terms_conditions !== undefined) {\n        setClauses.push(`terms_conditions = $${paramIndex}`);\n        values.push(JSON.stringify(data.terms_conditions));\n        paramIndex++;\n      }\n\n      if (data.image_url !== undefined) {\n        setClauses.push(`image_url = $${paramIndex}`);\n        values.push(data.image_url);\n        paramIndex++;\n      }\n\n      if (setClauses.length === 0) {\n        throw new LoyaltyError('No fields to update', 'NO_UPDATES', 400);\n      }\n\n      setClauses.push(`updated_at = NOW()`);\n      values.push(rewardId, orgId);\n\n      const sql = `\n        UPDATE reward_catalog\n        SET ${setClauses.join(', ')}\n        WHERE id = $${paramIndex} AND org_id = $${paramIndex + 1}\n        RETURNING\n          id,\n          org_id,\n          program_id,\n          name,\n          description,\n          reward_type::text as reward_type,\n          points_required,\n          monetary_value,\n          max_redemptions_per_customer,\n          stock_quantity,\n          redemption_count,\n          is_active,\n          is_featured,\n          valid_from,\n          valid_until,\n          terms_conditions,\n          image_url,\n          created_at,\n          updated_at\n      `;\n\n      const result = await query<RewardCatalog>(sql, values);\n\n      if (result.rows.length === 0) {\n        throw new LoyaltyError('Reward not found', 'REWARD_NOT_FOUND', 404);\n      }\n\n      return result.rows[0];\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[RewardCatalogService] Error updating reward:', error);\n      throw new LoyaltyError(\n        'Failed to update reward',\n        'UPDATE_REWARD_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Delete a reward from the catalog\n   */\n  static async deleteReward(rewardId: string, orgId: string): Promise<void> {\n    try {\n      // Check if reward has any redemptions\n      const redemptionCheck = await query(\n        `SELECT COUNT(*) as count\n         FROM reward_redemption\n         WHERE reward_id = $1`,\n        [rewardId]\n      );\n\n      const redemptionCount = parseInt(\n        redemptionCheck.rows[0]?.count || '0',\n        10\n      );\n\n      if (redemptionCount > 0) {\n        throw new LoyaltyError(\n          'Cannot delete reward with existing redemptions. Set is_active to false instead.',\n          'REWARD_HAS_REDEMPTIONS',\n          400\n        );\n      }\n\n      const result = await query(\n        `DELETE FROM reward_catalog WHERE id = $1 AND org_id = $2`,\n        [rewardId, orgId]\n      );\n\n      if (result.rowCount === 0) {\n        throw new LoyaltyError('Reward not found', 'REWARD_NOT_FOUND', 404);\n      }\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[RewardCatalogService] Error deleting reward:', error);\n      throw new LoyaltyError(\n        'Failed to delete reward',\n        'DELETE_REWARD_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get reward by ID\n   */\n  static async getRewardById(\n    rewardId: string,\n    orgId: string\n  ): Promise<RewardCatalog> {\n    try {\n      const sql = `\n        SELECT\n          id,\n          org_id,\n          program_id,\n          name,\n          description,\n          reward_type::text as reward_type,\n          points_required,\n          monetary_value,\n          max_redemptions_per_customer,\n          stock_quantity,\n          redemption_count,\n          is_active,\n          is_featured,\n          valid_from,\n          valid_until,\n          terms_conditions,\n          image_url,\n          created_at,\n          updated_at\n        FROM reward_catalog\n        WHERE id = $1 AND org_id = $2\n      `;\n\n      const result = await query<RewardCatalog>(sql, [rewardId, orgId]);\n\n      if (result.rows.length === 0) {\n        throw new LoyaltyError('Reward not found', 'REWARD_NOT_FOUND', 404);\n      }\n\n      return result.rows[0];\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[RewardCatalogService] Error fetching reward:', error);\n      throw new LoyaltyError(\n        'Failed to fetch reward',\n        'FETCH_REWARD_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * List rewards with optional filters and pagination\n   */\n  static async listRewards(\n    orgId: string,\n    filters: RewardFilters = {},\n    options: { limit?: number; offset?: number } = {}\n  ): Promise<PaginatedResult<RewardCatalog>> {\n    try {\n      const { limit = 50, offset = 0 } = options;\n      const conditions: string[] = ['org_id = $1'];\n      const params: any[] = [orgId];\n      let paramIndex = 2;\n\n      if (filters.rewardType) {\n        conditions.push(`reward_type = $${paramIndex}`);\n        params.push(filters.rewardType);\n        paramIndex++;\n      }\n\n      if (filters.isActive !== undefined) {\n        conditions.push(`is_active = $${paramIndex}`);\n        params.push(filters.isActive);\n        paramIndex++;\n      }\n\n      if (filters.isFeatured !== undefined) {\n        conditions.push(`is_featured = $${paramIndex}`);\n        params.push(filters.isFeatured);\n        paramIndex++;\n      }\n\n      if (filters.programId) {\n        conditions.push(\n          `(program_id = $${paramIndex} OR program_id IS NULL)`\n        );\n        params.push(filters.programId);\n        paramIndex++;\n      }\n\n      if (filters.minPoints !== undefined) {\n        conditions.push(`points_required >= $${paramIndex}`);\n        params.push(filters.minPoints);\n        paramIndex++;\n      }\n\n      if (filters.maxPoints !== undefined) {\n        conditions.push(`points_required <= $${paramIndex}`);\n        params.push(filters.maxPoints);\n        paramIndex++;\n      }\n\n      if (filters.inStock) {\n        conditions.push(`(stock_quantity IS NULL OR stock_quantity > 0)`);\n      }\n\n      // Count query\n      const countResult = await query<{ count: string }>(\n        `SELECT COUNT(*) as count FROM reward_catalog WHERE ${conditions.join(' AND ')}`,\n        params\n      );\n      const count = parseInt(countResult.rows[0]?.count || '0', 10);\n\n      // Data query\n      params.push(limit, offset);\n\n      const sql = `\n        SELECT\n          id,\n          org_id,\n          program_id,\n          name,\n          description,\n          reward_type::text as reward_type,\n          points_required,\n          monetary_value,\n          max_redemptions_per_customer,\n          stock_quantity,\n          redemption_count,\n          is_active,\n          is_featured,\n          valid_from,\n          valid_until,\n          terms_conditions,\n          image_url,\n          created_at,\n          updated_at\n        FROM reward_catalog\n        WHERE ${conditions.join(' AND ')}\n        ORDER BY is_featured DESC, points_required ASC\n        LIMIT $${paramIndex} OFFSET $${paramIndex + 1}\n      `;\n\n      const result = await query<RewardCatalog>(sql, params);\n\n      return {\n        data: result.rows,\n        count,\n        limit,\n        offset,\n        hasMore: offset + limit < count,\n      };\n    } catch (error) {\n      console.error('[RewardCatalogService] Error listing rewards:', error);\n      throw new LoyaltyError(\n        'Failed to list rewards',\n        'LIST_REWARDS_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get available rewards for a customer (based on their points balance)\n   */\n  static async getAvailableRewardsForCustomer(\n    customerId: string,\n    orgId: string\n  ): Promise<RewardCatalog[]> {\n    try {\n      const sql = `\n        SELECT\n          rc.id,\n          rc.org_id,\n          rc.program_id,\n          rc.name,\n          rc.description,\n          rc.reward_type::text as reward_type,\n          rc.points_required,\n          rc.monetary_value,\n          rc.max_redemptions_per_customer,\n          rc.stock_quantity,\n          rc.redemption_count,\n          rc.is_active,\n          rc.is_featured,\n          rc.valid_from,\n          rc.valid_until,\n          rc.terms_conditions,\n          rc.image_url,\n          rc.created_at,\n          rc.updated_at\n        FROM reward_catalog rc\n        JOIN customer_loyalty cl ON (rc.program_id = cl.program_id OR rc.program_id IS NULL)\n        WHERE cl.customer_id = $1\n          AND cl.org_id = $2\n          AND rc.org_id = $2\n          AND rc.is_active = true\n          AND rc.points_required <= cl.points_balance\n          AND (rc.valid_from IS NULL OR rc.valid_from <= NOW())\n          AND (rc.valid_until IS NULL OR rc.valid_until > NOW())\n          AND (rc.stock_quantity IS NULL OR rc.stock_quantity > 0)\n        ORDER BY rc.is_featured DESC, rc.points_required ASC\n      `;\n\n      const result = await query<RewardCatalog>(sql, [customerId, orgId]);\n      return result.rows;\n    } catch (error) {\n      console.error(\n        '[RewardCatalogService] Error fetching available rewards:',\n        error\n      );\n      throw new LoyaltyError(\n        'Failed to fetch available rewards',\n        'FETCH_AVAILABLE_REWARDS_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get featured rewards\n   */\n  static async getFeaturedRewards(orgId: string): Promise<RewardCatalog[]> {\n    try {\n      const sql = `\n        SELECT\n          id,\n          org_id,\n          program_id,\n          name,\n          description,\n          reward_type::text as reward_type,\n          points_required,\n          monetary_value,\n          max_redemptions_per_customer,\n          stock_quantity,\n          redemption_count,\n          is_active,\n          is_featured,\n          valid_from,\n          valid_until,\n          terms_conditions,\n          image_url,\n          created_at,\n          updated_at\n        FROM reward_catalog\n        WHERE org_id = $1\n          AND is_featured = true\n          AND is_active = true\n          AND (valid_from IS NULL OR valid_from <= NOW())\n          AND (valid_until IS NULL OR valid_until > NOW())\n        ORDER BY points_required ASC\n      `;\n\n      const result = await query<RewardCatalog>(sql, [orgId]);\n      return result.rows;\n    } catch (error) {\n      console.error(\n        '[RewardCatalogService] Error fetching featured rewards:',\n        error\n      );\n      throw new LoyaltyError(\n        'Failed to fetch featured rewards',\n        'FETCH_FEATURED_REWARDS_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Update stock quantity\n   */\n  static async updateStock(\n    rewardId: string,\n    quantity: number,\n    orgId: string\n  ): Promise<void> {\n    try {\n      if (quantity < 0) {\n        throw new LoyaltyError(\n          'Stock quantity cannot be negative',\n          'INVALID_STOCK_QUANTITY',\n          400\n        );\n      }\n\n      const result = await query(\n        `UPDATE reward_catalog\n         SET stock_quantity = $1, updated_at = NOW()\n         WHERE id = $2 AND org_id = $3`,\n        [quantity, rewardId, orgId]\n      );\n\n      if (result.rowCount === 0) {\n        throw new LoyaltyError('Reward not found', 'REWARD_NOT_FOUND', 404);\n      }\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error('[RewardCatalogService] Error updating stock:', error);\n      throw new LoyaltyError(\n        'Failed to update stock',\n        'UPDATE_STOCK_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Check reward availability\n   */\n  static async checkAvailability(\n    rewardId: string,\n    orgId: string\n  ): Promise<AvailabilityStatus> {\n    try {\n      const reward = await this.getRewardById(rewardId, orgId);\n\n      const now = new Date();\n      const isValid =\n        (!reward.valid_from || new Date(reward.valid_from) <= now) &&\n        (!reward.valid_until || new Date(reward.valid_until) > now);\n\n      const inStock =\n        reward.stock_quantity === null || reward.stock_quantity > 0;\n\n      const available = reward.is_active && isValid && inStock;\n\n      let reason: string | undefined;\n      if (!reward.is_active) reason = 'Reward is inactive';\n      else if (!isValid) reason = 'Reward is not valid at this time';\n      else if (!inStock) reason = 'Reward is out of stock';\n\n      return {\n        available,\n        reason,\n        inStock,\n        stockQuantity: reward.stock_quantity ?? undefined,\n        isActive: reward.is_active,\n        isValid,\n        validFrom: reward.valid_from,\n        validUntil: reward.valid_until ?? undefined,\n      };\n    } catch (error) {\n      if (error instanceof LoyaltyError) throw error;\n      console.error(\n        '[RewardCatalogService] Error checking availability:',\n        error\n      );\n      throw new LoyaltyError(\n        'Failed to check reward availability',\n        'CHECK_AVAILABILITY_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  /**\n   * Get reward analytics using the database view\n   */\n  static async getRewardAnalytics(orgId: string): Promise<RewardAnalytics[]> {\n    try {\n      const sql = `\n        SELECT\n          org_id,\n          reward_id,\n          reward_name,\n          reward_type::text as reward_type,\n          points_required,\n          monetary_value,\n          is_active,\n          is_featured,\n          stock_quantity,\n          redemption_count,\n          total_redemptions,\n          unique_customers,\n          fulfilled_redemptions,\n          pending_redemptions,\n          cancelled_redemptions,\n          total_points_spent,\n          total_monetary_value,\n          redemptions_last_30_days,\n          redemptions_last_90_days,\n          avg_fulfillment_hours,\n          daily_redemption_rate\n        FROM reward_analytics\n        WHERE org_id = $1\n        ORDER BY total_redemptions DESC\n      `;\n\n      const result = await query<RewardAnalytics>(sql, [orgId]);\n      return result.rows;\n    } catch (error) {\n      console.error(\n        '[RewardCatalogService] Error fetching reward analytics:',\n        error\n      );\n      throw new LoyaltyError(\n        'Failed to fetch reward analytics',\n        'FETCH_ANALYTICS_ERROR',\n        500,\n        { error }\n      );\n    }\n  }\n\n  // ============================================================================\n  // PRIVATE HELPER METHODS\n  // ============================================================================\n\n  /**\n   * Validate image URL format\n   */\n  private static validateImageUrl(url: string): void {\n    if (!/^https?:\\/\\/.+/.test(url)) {\n      throw new LoyaltyError(\n        'Invalid image URL format. Must start with http:// or https://',\n        'INVALID_IMAGE_URL',\n        400\n      );\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\services\\UnifiedDataService.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":237,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":237,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":310,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":310,"endColumn":36},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":475,"column":23,"nodeType":"Identifier","messageId":"undef","endLine":475,"endColumn":34},{"ruleId":"no-undef","severity":2,"message":"'performance' is not defined.","line":593,"column":25,"nodeType":"Identifier","messageId":"undef","endLine":593,"endColumn":36}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Unified Data Service\r\n *\r\n * Single source of truth for all API data operations\r\n * Provides consistent response formats, field mapping, and error handling\r\n *\r\n * @module UnifiedDataService\r\n */\r\n\r\nimport { query, pool } from '@/lib/database/unified-connection';\r\nimport { CacheManager, cachedQuery } from '@/lib/cache/query-cache';\r\n\r\n// ============================================================================\r\n// TYPES & INTERFACES\r\n// ============================================================================\r\n\r\n/**\r\n * Standardized API Response Format\r\n * All endpoints should use this format for consistency\r\n */\r\nexport interface ApiResponse<T = any> {\r\n  success: boolean;\r\n  data?: T | T[];\r\n  pagination?: PaginationMeta;\r\n  meta?: QueryMeta;\r\n  error?: string;\r\n  details?: string;\r\n}\r\n\r\n/**\r\n * Pagination metadata\r\n */\r\nexport interface PaginationMeta {\r\n  page: number;\r\n  limit: number;\r\n  total: number;\r\n  totalPages: number;\r\n  hasNext: boolean;\r\n  hasPrev: boolean;\r\n  cursor?: string | null;\r\n}\r\n\r\n/**\r\n * Query execution metadata\r\n */\r\nexport interface QueryMeta {\r\n  queryTime?: number;\r\n  filters?: Record<string, any>;\r\n  queryFingerprint?: string;\r\n}\r\n\r\n/**\r\n * Query options for data fetching\r\n */\r\nexport interface QueryOptions {\r\n  page?: number;\r\n  limit?: number;\r\n  cursor?: string;\r\n  search?: string;\r\n  filters?: Record<string, any>;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\n/**\r\n * Supplier data structure (matches core.supplier schema)\r\n */\r\nexport interface Supplier {\r\n  id: string;\r\n  name: string;\r\n  code: string;\r\n  active: boolean;\r\n  email?: string;\r\n  phone?: string;\r\n  website?: string;\r\n  currency?: string;\r\n  paymentTerms?: string;\r\n  taxNumber?: string;\r\n  contactInfo?: Record<string, any>;\r\n  createdAt?: Date;\r\n  updatedAt?: Date;\r\n}\r\n\r\n/**\r\n * Inventory item data structure (matches core.stock_on_hand + joins)\r\n */\r\nexport interface InventoryItem {\r\n  id: string;\r\n  productId?: string;\r\n  supplierProductId?: string;\r\n  sku: string;\r\n  name: string;\r\n  categoryId?: string;\r\n  category?: string;\r\n  currentStock: number;\r\n  reservedStock: number;\r\n  availableStock: number;\r\n  costPerUnitZar: number;\r\n  salePerUnitZar: number;\r\n  totalValueZar: number;\r\n  supplierId: string;\r\n  supplierName?: string;\r\n  brandId?: string;\r\n  unitOfMeasure?: string;\r\n  currency?: string;\r\n  reorderPoint?: number;\r\n  maxStockLevel?: number;\r\n  status?: 'in_stock' | 'low_stock' | 'out_of_stock' | 'critical';\r\n}\r\n\r\n// ============================================================================\r\n// HELPER FUNCTIONS\r\n// ============================================================================\r\n\r\n/**\r\n * Maps database row to Supplier object with field name transformation\r\n */\r\nfunction mapDatabaseRowToSupplier(row: any): Supplier {\r\n  return {\r\n    id: row.id || row.supplier_id,\r\n    name: row.name,\r\n    code: row.code,\r\n    active: row.active,\r\n    email: row.email || row.contact_info?.email || '',\r\n    phone: row.phone || row.contact_info?.phone || '',\r\n    website: row.website || row.contact_info?.website || '',\r\n    currency: row.currency || row.default_currency || 'ZAR',\r\n    paymentTerms: row.payment_terms || row.paymentTerms,\r\n    taxNumber: row.tax_number || row.taxNumber,\r\n    contactInfo: row.contact_info,\r\n    createdAt: row.created_at,\r\n    updatedAt: row.updated_at,\r\n  };\r\n}\r\n\r\n/**\r\n * Maps database row to InventoryItem object with field name transformation\r\n */\r\nfunction mapDatabaseRowToInventoryItem(row: any): InventoryItem {\r\n  const stockQty = Number(row.stock_qty ?? row.qty ?? row.current_stock ?? row.currentStock ?? 0);\r\n  const costPrice = Number(row.cost_price ?? row.unit_cost ?? row.costPerUnitZar ?? 0);\r\n  const salePrice = Number(row.sale_price ?? row.unit_cost ?? row.salePerUnitZar ?? costPrice);\r\n  const reservedQty = Number(row.reserved_qty ?? row.reservedQty ?? 0);\r\n  const availableQty = Number(row.available_qty ?? row.availableQty ?? stockQty - reservedQty);\r\n  const supplierProductId = row.supplier_product_id || row.supplierProductId || null;\r\n  const productId = row.product_id || row.productId || supplierProductId || null;\r\n  const categoryName = row.category_name || row.categoryName || row.category || row.category_id;\r\n  const categoryId = row.category_id || row.categoryId || null;\r\n  const unitOfMeasure = row.unit_of_measure || row.unit || row.uom || null;\r\n  const reorderPoint = Number(row.reorder_point ?? row.reorderPoint ?? 0);\r\n  const maxStockLevel = Number(row.max_stock_level ?? row.maxStockLevel ?? 0);\r\n  const currency = row.currency || row.currency_code || 'ZAR';\r\n  const supplierId = row.supplier_id || row.supplierId || '';\r\n  const supplierName = row.supplier_name || row.supplierName;\r\n\r\n  // Determine stock status\r\n  let status: InventoryItem['status'] = 'in_stock';\r\n  if (stockQty === 0) {\r\n    status = 'out_of_stock';\r\n  } else if (stockQty <= 5) {\r\n    status = 'critical';\r\n  } else if (stockQty <= 10) {\r\n    status = 'low_stock';\r\n  }\r\n\r\n  return {\r\n    id: row.id || row.soh_id || productId || supplierProductId || '',\r\n    productId: productId ?? undefined,\r\n    supplierProductId: supplierProductId ?? undefined,\r\n    sku: row.sku || row.supplier_sku || '',\r\n    name: row.name || '',\r\n    categoryId: categoryId ?? undefined,\r\n    category: typeof categoryName === 'string' ? categoryName : String(categoryName ?? ''),\r\n    currentStock: stockQty,\r\n    reservedStock: reservedQty,\r\n    availableStock: availableQty,\r\n    costPerUnitZar: costPrice,\r\n    salePerUnitZar: salePrice,\r\n    totalValueZar: stockQty * costPrice,\r\n    supplierId: String(supplierId || ''),\r\n    supplierName,\r\n    brandId: row.brand_id || row.brandId,\r\n    unitOfMeasure: unitOfMeasure ?? undefined,\r\n    currency,\r\n    reorderPoint: reorderPoint || undefined,\r\n    maxStockLevel: maxStockLevel || undefined,\r\n    status,\r\n  };\r\n}\r\n\r\n/**\r\n * Creates a standardized success response\r\n */\r\nexport function createSuccessResponse<T>(\r\n  data: T | T[],\r\n  pagination?: PaginationMeta,\r\n  meta?: QueryMeta\r\n): ApiResponse<T> {\r\n  return {\r\n    success: true,\r\n    data,\r\n    pagination,\r\n    meta,\r\n  };\r\n}\r\n\r\n/**\r\n * Creates a standardized error response\r\n */\r\nexport function createErrorResponse(error: string, details?: string): ApiResponse {\r\n  return {\r\n    success: false,\r\n    error,\r\n    details,\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// SUPPLIER OPERATIONS\r\n// ============================================================================\r\n\r\nexport class SupplierService {\r\n  /**\r\n   * Fetch suppliers with filtering and pagination\r\n   */\r\n  static async getSuppliers(options: QueryOptions = {}): Promise<ApiResponse<Supplier>> {\r\n    const {\r\n      page = 1,\r\n      limit = 50,\r\n      search,\r\n      filters = {},\r\n      sortBy = 'name',\r\n      sortOrder = 'asc',\r\n    } = options;\r\n\r\n    const offset = (page - 1) * limit;\r\n    const startTime = performance.now();\r\n\r\n    try {\r\n      // Build WHERE conditions\r\n      const whereConditions: string[] = ['1=1'];\r\n      const queryParams: any[] = [];\r\n      let paramIndex = 1;\r\n\r\n      // Search filter\r\n      if (search && search.length >= 2) {\r\n        whereConditions.push(`(\r\n          name ILIKE $${paramIndex} OR\r\n          code ILIKE $${paramIndex} OR\r\n          contact_info->>'email' ILIKE $${paramIndex} OR\r\n          contact_info->>'phone' ILIKE $${paramIndex}\r\n        )`);\r\n        queryParams.push(`%${search}%`);\r\n        paramIndex++;\r\n      }\r\n\r\n      // Active filter\r\n      if (filters.active !== undefined) {\r\n        whereConditions.push(`active = $${paramIndex}`);\r\n        queryParams.push(filters.active);\r\n        paramIndex++;\r\n      }\r\n\r\n      // Status filter (active/inactive)\r\n      if (filters.status && Array.isArray(filters.status)) {\r\n        const statusBooleans = filters.status.map((s: string) => s.toLowerCase() === 'active');\r\n        whereConditions.push(`active = ANY($${paramIndex})`);\r\n        queryParams.push(statusBooleans);\r\n        paramIndex++;\r\n      }\r\n\r\n      const whereClause = whereConditions.join(' AND ');\r\n\r\n      // Main query with window function for total count\r\n      const sql = `\r\n        SELECT\r\n          supplier_id as id,\r\n          name,\r\n          code,\r\n          active,\r\n          contact_info,\r\n          contact_info->>'email' as email,\r\n          contact_info->>'phone' as phone,\r\n          contact_info->>'website' as website,\r\n          default_currency as currency,\r\n          payment_terms,\r\n          tax_number,\r\n          created_at,\r\n          updated_at,\r\n          COUNT(*) OVER() as total_count\r\n        FROM core.supplier\r\n        WHERE ${whereClause}\r\n        ORDER BY ${sortBy} ${sortOrder.toUpperCase()}\r\n        LIMIT $${paramIndex} OFFSET $${paramIndex + 1}\r\n      `;\r\n\r\n      queryParams.push(limit, offset);\r\n\r\n      const cacheKey = `suppliers:list:${JSON.stringify({ page, limit, search, filters, sortBy, sortOrder })}`;\r\n      const result = await cachedQuery(\r\n        CacheManager.hotCache,\r\n        cacheKey,\r\n        async () => await query(sql, queryParams),\r\n        60_000\r\n      );\r\n\r\n      const total = result.rows.length > 0 ? parseInt(result.rows[0].total_count, 10) : 0;\r\n      const totalPages = Math.ceil(total / limit);\r\n\r\n      const queryTime = performance.now() - startTime;\r\n\r\n      // Map results\r\n      const suppliers = result.rows.map(mapDatabaseRowToSupplier);\r\n\r\n      return createSuccessResponse(\r\n        suppliers,\r\n        {\r\n          page,\r\n          limit,\r\n          total,\r\n          totalPages,\r\n          hasNext: page < totalPages,\r\n          hasPrev: page > 1,\r\n        },\r\n        {\r\n          queryTime,\r\n          filters,\r\n          queryFingerprint: 'suppliers_list',\r\n        }\r\n      );\r\n    } catch (error) {\r\n      console.error('Error fetching suppliers:', error);\r\n      return createErrorResponse(\r\n        'Failed to fetch suppliers',\r\n        error instanceof Error ? error.message : 'Unknown error'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get a single supplier by ID\r\n   */\r\n  static async getSupplierById(id: string): Promise<ApiResponse<Supplier>> {\r\n    try {\r\n      const sql = `\r\n        SELECT\r\n          supplier_id as id,\r\n          name,\r\n          code,\r\n          active,\r\n          contact_info,\r\n          contact_info->>'email' as email,\r\n          contact_info->>'phone' as phone,\r\n          contact_info->>'website' as website,\r\n          default_currency as currency,\r\n          payment_terms,\r\n          tax_number,\r\n          created_at,\r\n          updated_at\r\n        FROM core.supplier\r\n        WHERE supplier_id = $1\r\n      `;\r\n\r\n      const result = await query(sql, [id]);\r\n\r\n      if (result.rows.length === 0) {\r\n        return createErrorResponse('Supplier not found', `No supplier with id: ${id}`);\r\n      }\r\n\r\n      const supplier = mapDatabaseRowToSupplier(result.rows[0]);\r\n\r\n      return createSuccessResponse(supplier);\r\n    } catch (error) {\r\n      console.error('Error fetching supplier:', error);\r\n      return createErrorResponse(\r\n        'Failed to fetch supplier',\r\n        error instanceof Error ? error.message : 'Unknown error'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a new supplier\r\n   */\r\n  static async createSupplier(data: Partial<Supplier>): Promise<ApiResponse<Supplier>> {\r\n    try {\r\n      // Check for duplicate name\r\n      const existingSupplier = await pool.query(\r\n        'SELECT supplier_id FROM core.supplier WHERE name = $1',\r\n        [data.name]\r\n      );\r\n\r\n      if (existingSupplier.rows.length > 0) {\r\n        return createErrorResponse(\r\n          'Supplier with this name already exists',\r\n          `Duplicate name: ${data.name}`\r\n        );\r\n      }\r\n\r\n      // Build contact_info JSONB\r\n      const contactInfo = {\r\n        email: data.email || '',\r\n        phone: data.phone || '',\r\n        website: data.website || '',\r\n      };\r\n\r\n      // Generate code if not provided\r\n      const code =\r\n        data.code ||\r\n        data.name\r\n          ?.substring(0, 10)\r\n          .toUpperCase()\r\n          .replace(/[^A-Z0-9]/g, '') ||\r\n        '';\r\n\r\n      const insertSql = `\r\n        INSERT INTO core.supplier (\r\n          name,\r\n          code,\r\n          contact_info,\r\n          active,\r\n          default_currency,\r\n          payment_terms,\r\n          tax_number,\r\n          created_at,\r\n          updated_at\r\n        ) VALUES (\r\n          $1, $2, $3::jsonb, $4, $5, $6, $7, NOW(), NOW()\r\n        ) RETURNING supplier_id as id, *\r\n      `;\r\n\r\n      const insertResult = await pool.query(insertSql, [\r\n        data.name,\r\n        code,\r\n        JSON.stringify(contactInfo),\r\n        data.active ?? true,\r\n        data.currency || 'ZAR',\r\n        data.paymentTerms || '30 days',\r\n        data.taxNumber,\r\n      ]);\r\n\r\n      const supplier = mapDatabaseRowToSupplier(insertResult.rows[0]);\r\n\r\n      return createSuccessResponse(supplier);\r\n    } catch (error) {\r\n      console.error('Error creating supplier:', error);\r\n      return createErrorResponse(\r\n        'Failed to create supplier',\r\n        error instanceof Error ? error.message : 'Unknown error'\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// INVENTORY OPERATIONS\r\n// ============================================================================\r\n\r\nexport class InventoryService {\r\n  /**\r\n   * Fetch inventory items with filtering and pagination\r\n   */\r\n  static async getInventory(options: QueryOptions = {}): Promise<ApiResponse<InventoryItem>> {\r\n    const {\r\n      page = 1,\r\n      limit = 250,\r\n      cursor,\r\n      search,\r\n      filters = {},\r\n      sortBy = 'sku',\r\n      sortOrder = 'asc',\r\n    } = options;\r\n\r\n    const offset = (page - 1) * limit;\r\n    const startTime = performance.now();\r\n\r\n    try {\r\n      // Build WHERE conditions\r\n      const whereConditions: string[] = [];\r\n      const queryParams: any[] = [];\r\n      let paramIndex = 1;\r\n\r\n      // Cursor-based pagination\r\n      if (cursor) {\r\n        const [lastSku, lastId] = cursor.split('|');\r\n        if (lastSku && lastId) {\r\n          whereConditions.push(\r\n            `(sp.supplier_sku > $${paramIndex} OR (sp.supplier_sku = $${paramIndex + 1} AND soh.soh_id > $${paramIndex + 2}::uuid))`\r\n          );\r\n          queryParams.push(lastSku, lastSku, lastId);\r\n          paramIndex += 3;\r\n        }\r\n      }\r\n\r\n      // Supplier filter\r\n      if (filters.supplierId) {\r\n        whereConditions.push(`sp.supplier_id = $${paramIndex}::uuid`);\r\n        queryParams.push(filters.supplierId);\r\n        paramIndex++;\r\n      }\r\n\r\n      // Category filter\r\n      if (filters.category) {\r\n        const categories = Array.isArray(filters.category) ? filters.category : [filters.category];\r\n        whereConditions.push(\r\n          `COALESCE(p.category_id, sp.category_id) = ANY($${paramIndex}::uuid[])`\r\n        );\r\n        queryParams.push(categories);\r\n        paramIndex++;\r\n      }\r\n\r\n      // Search filter\r\n      if (search && search.length >= 2) {\r\n        whereConditions.push(\r\n          `(sp.supplier_sku ILIKE $${paramIndex} OR COALESCE(p.name, sp.name_from_supplier) ILIKE $${paramIndex})`\r\n        );\r\n        queryParams.push(`%${search}%`);\r\n        paramIndex++;\r\n      }\r\n\r\n      // Stock status filter\r\n      if (filters.status) {\r\n        switch (filters.status) {\r\n          case 'out_of_stock':\r\n            whereConditions.push('soh.qty = 0');\r\n            break;\r\n          case 'low_stock':\r\n            whereConditions.push('soh.qty > 0 AND soh.qty <= 10');\r\n            break;\r\n          case 'critical':\r\n            whereConditions.push('soh.qty > 0 AND soh.qty <= 5');\r\n            break;\r\n          case 'in_stock':\r\n            whereConditions.push('soh.qty > 10');\r\n            break;\r\n        }\r\n      }\r\n\r\n      const whereClause =\r\n        whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';\r\n\r\n      // Main query (adds window function for total only when not using cursor pagination)\r\n      const sql = `\r\n        SELECT\r\n          soh.soh_id as id,\r\n          sp.supplier_product_id::text as supplier_product_id,\r\n          sp.product_id::text as product_id,\r\n          sp.supplier_sku as sku,\r\n          COALESCE(p.name, sp.name_from_supplier) as name,\r\n          COALESCE(p.category_id, sp.category_id) as category_id,\r\n          COALESCE(c.name, 'uncategorized') as category_name,\r\n          soh.qty as stock_qty,\r\n          0 as reserved_qty,\r\n          soh.qty as available_qty,\r\n          soh.unit_cost as cost_price,\r\n          soh.unit_cost as sale_price,\r\n          sp.uom as unit_of_measure,\r\n          sp.supplier_id,\r\n          s.name as supplier_name,\r\n          p.brand_id\r\n          ${cursor ? '' : ', COUNT(*) OVER() as total_count'}\r\n        FROM core.stock_on_hand AS soh\r\n        JOIN core.supplier_product AS sp ON sp.supplier_product_id = soh.supplier_product_id\r\n        JOIN core.supplier AS s ON s.supplier_id = sp.supplier_id\r\n        LEFT JOIN core.product AS p ON p.product_id = sp.product_id\r\n        LEFT JOIN core.category AS c ON c.category_id = COALESCE(p.category_id, sp.category_id)\r\n        ${whereClause}\r\n        ORDER BY sp.supplier_sku ${sortOrder.toUpperCase()}, soh.soh_id ${sortOrder.toUpperCase()}\r\n        ${cursor ? `LIMIT $${paramIndex}` : `LIMIT $${paramIndex} OFFSET $${paramIndex + 1}`}\r\n      `;\r\n\r\n      if (cursor) {\r\n        queryParams.push(limit);\r\n      } else {\r\n        queryParams.push(limit, offset);\r\n      }\r\n\r\n      const invCacheKey = `inventory:list:${JSON.stringify({ page, limit, cursor: cursor || null, search, filters })}`;\r\n      const result = await cachedQuery(\r\n        CacheManager.realtimeCache,\r\n        invCacheKey,\r\n        async () => await query(sql, queryParams),\r\n        30_000\r\n      );\r\n\r\n      // Generate next cursor\r\n      let nextCursor: string | null = null;\r\n      if (cursor && result.rows.length > 0) {\r\n        const lastRow = result.rows[result.rows.length - 1];\r\n        nextCursor = `${lastRow.sku}|${lastRow.id}`;\r\n      }\r\n\r\n      const queryTime = performance.now() - startTime;\r\n\r\n      // Map results\r\n      const items = result.rows.map(mapDatabaseRowToInventoryItem);\r\n\r\n      // For cursor pagination, we don't have total count\r\n      if (cursor) {\r\n        return createSuccessResponse(\r\n          items,\r\n          {\r\n            page: 1,\r\n            limit,\r\n            total: -1, // Unknown for cursor-based\r\n            totalPages: -1,\r\n            hasNext: result.rows.length === limit,\r\n            hasPrev: false,\r\n            cursor: nextCursor,\r\n          },\r\n          {\r\n            queryTime,\r\n            filters,\r\n            queryFingerprint: 'inventory_cursor',\r\n          }\r\n        );\r\n      }\r\n\r\n      // For offset pagination, derive total from window function\r\n      const total = result.rows.length > 0 ? parseInt((result.rows[0] as any).total_count, 10) : 0;\r\n      const totalPages = Math.ceil(total / limit);\r\n\r\n      return createSuccessResponse(\r\n        items,\r\n        {\r\n          page,\r\n          limit,\r\n          total,\r\n          totalPages,\r\n          hasNext: page < totalPages,\r\n          hasPrev: page > 1,\r\n        },\r\n        {\r\n          queryTime,\r\n          filters,\r\n          queryFingerprint: 'inventory_offset',\r\n        }\r\n      );\r\n    } catch (error) {\r\n      console.error('Error fetching inventory:', error);\r\n      return createErrorResponse(\r\n        'Failed to fetch inventory',\r\n        error instanceof Error ? error.message : 'Unknown error'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get inventory analytics/summary\r\n   */\r\n  static async getInventoryAnalytics(): Promise<ApiResponse<any>> {\r\n    try {\r\n      const sql = `\r\n        SELECT\r\n          COUNT(DISTINCT soh.soh_id) AS total_items,\r\n          COALESCE(SUM(soh.qty * soh.unit_cost), 0) AS total_value,\r\n          COUNT(CASE WHEN soh.qty > 0 AND soh.qty <= 10 THEN 1 END) AS low_stock_items,\r\n          COUNT(CASE WHEN soh.qty = 0 THEN 1 END) AS out_of_stock_items,\r\n          COUNT(CASE WHEN soh.qty > 0 AND soh.qty <= 5 THEN 1 END) AS critical_items,\r\n          COUNT(CASE WHEN soh.qty > 10 THEN 1 END) AS in_stock_items\r\n        FROM core.stock_on_hand soh\r\n        JOIN core.supplier_product sp ON sp.supplier_product_id = soh.supplier_product_id\r\n        JOIN core.supplier s ON s.supplier_id = sp.supplier_id\r\n        WHERE s.active = true\r\n      `;\r\n      const analytics = await cachedQuery(\r\n        CacheManager.dashboardCache,\r\n        'inventory:analytics',\r\n        async () => {\r\n          const result = await query(sql);\r\n          const row = result.rows[0];\r\n          return {\r\n            totalItems: parseInt(row.total_items),\r\n            totalValue: parseFloat(row.total_value),\r\n            lowStockItems: parseInt(row.low_stock_items),\r\n            outOfStockItems: parseInt(row.out_of_stock_items),\r\n            criticalItems: parseInt(row.critical_items),\r\n            inStockItems: parseInt(row.in_stock_items),\r\n          };\r\n        },\r\n        300_000\r\n      );\r\n      return createSuccessResponse(analytics);\r\n    } catch (error) {\r\n      console.error('Error fetching inventory analytics:', error);\r\n      return createErrorResponse(\r\n        'Failed to fetch inventory analytics',\r\n        error instanceof Error ? error.message : 'Unknown error'\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// EXPORTS\r\n// ============================================================================\r\n\r\nexport default {\r\n  SupplierService,\r\n  InventoryService,\r\n  createSuccessResponse,\r\n  createErrorResponse,\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\services\\WooCommerceSyncQueue.SECURE.ts","messages":[{"ruleId":"no-control-regex","severity":2,"message":"Unexpected control character(s) in regular expression: \\x00.","line":97,"column":33,"nodeType":"Literal","messageId":"unexpected","endLine":97,"endColumn":40}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * SECURE IMPLEMENTATION: WooCommerceSyncQueue\n *\n * This file shows the secure implementation pattern for database operations.\n * Key improvements:\n * - UUID format validation on all parameters\n * - org_id validation in all queries (org isolation)\n * - No string interpolation in SQL (parameterized only)\n * - Authorization checks in methods requiring access control\n * - Immutable audit logging (append-only)\n * - Input sanitization on all user-provided data\n *\n * Author: Security Expert Agent\n * Date: 2025-11-06\n */\n\nimport { query } from '@/lib/database';\n\nexport enum QueueState {\n  DRAFT = 'draft',\n  PROCESSING = 'processing',\n  PARTIAL = 'partial',\n  DONE = 'done',\n  FAILED = 'failed',\n  CANCELLED = 'cancelled',\n}\n\nexport enum LineState {\n  DRAFT = 'draft',\n  PROCESSING = 'processing',\n  DONE = 'done',\n  FAILED = 'failed',\n  CANCELLED = 'cancelled',\n}\n\nexport interface QueueLineData {\n  woo_customer_id: number;\n  customer_data: any;\n  external_id?: string;\n}\n\nexport interface CreateQueueParams {\n  org_id: string;\n  queue_name: string;\n  created_by: string;\n  batch_size?: number;\n  batch_delay_ms?: number;\n  idempotency_key?: string;\n}\n\n/**\n * Helper: Validate UUID format\n * Prevents UUID enumeration and SQL injection attempts\n */\nfunction validateUUID(uuid: string, paramName: string): void {\n  if (!uuid || !/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(uuid)) {\n    throw new Error(`Invalid ${paramName} format - must be valid UUID`);\n  }\n}\n\n/**\n * Helper: Validate integer range\n * Prevents DOS attacks via extreme parameter values\n */\nfunction validateIntRange(\n  value: number | undefined,\n  min: number,\n  max: number,\n  paramName: string\n): number {\n  if (value === undefined) {\n    return min;\n  }\n\n  const num = Math.floor(value);\n\n  if (num < min || num > max) {\n    throw new Error(\n      `${paramName} must be between ${min} and ${max}, got ${value}`\n    );\n  }\n\n  return num;\n}\n\n/**\n * Helper: Sanitize string input\n * Prevents injection and buffer overflow attacks\n */\nfunction sanitizeString(input: string | undefined, maxLength: number = 500): string {\n  if (!input) return '';\n\n  // Truncate to prevent buffer overflow\n  let sanitized = input.substring(0, maxLength);\n\n  // Remove null bytes\n  sanitized = sanitized.replace(/\\x00/g, '');\n\n  return sanitized;\n}\n\nexport class WooCommerceSyncQueue {\n  /**\n   * Create a new sync queue\n   *\n   * SECURITY:\n   * - Validates all UUID inputs\n   * - Sanitizes text inputs\n   * - Org_id must be passed in (NOT extracted from auth in this layer)\n   */\n  static async createQueue(params: CreateQueueParams): Promise<string> {\n    // Validate inputs\n    validateUUID(params.org_id, 'org_id');\n    validateUUID(params.created_by, 'created_by');\n\n    const queueName = sanitizeString(params.queue_name, 255);\n    const batchSize = validateIntRange(params.batch_size, 1, 1000, 'batch_size');\n    const batchDelayMs = validateIntRange(params.batch_delay_ms, 0, 60000, 'batch_delay_ms');\n\n    const idempotencyKey = params.idempotency_key\n      ? sanitizeString(params.idempotency_key, 255)\n      : `sync-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n    const result = await query<{ id: string }>(\n      `INSERT INTO woo_customer_sync_queue (\n        org_id,\n        queue_name,\n        source_system,\n        created_by,\n        batch_size,\n        batch_delay_ms,\n        idempotency_key,\n        state\n      ) VALUES ($1, $2, 'woocommerce', $3, $4, $5, $6, 'draft')\n      RETURNING id`,\n      [params.org_id, queueName, params.created_by, batchSize, batchDelayMs, idempotencyKey]\n    );\n\n    if (!result.rows.length) {\n      throw new Error('Failed to create sync queue');\n    }\n\n    return result.rows[0].id;\n  }\n\n  /**\n   * Add customer to queue (idempotent)\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Validates wooCustomerId is positive integer\n   * - Org_id isolation enforced\n   */\n  static async addToQueue(\n    queueId: string,\n    orgId: string,\n    wooCustomerId: number,\n    customerData: any,\n    externalId?: string\n  ): Promise<string> {\n    // Validate inputs\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    if (!Number.isInteger(wooCustomerId) || wooCustomerId <= 0) {\n      throw new Error('Invalid wooCustomerId - must be positive integer');\n    }\n\n    const sanitizedExternalId = externalId ? sanitizeString(externalId, 255) : null;\n    const idempotencyToken = `${queueId}-${wooCustomerId}-${Date.now()}`;\n\n    const result = await query<{ id: string }>(\n      `INSERT INTO woo_customer_sync_queue_line (\n        queue_id,\n        org_id,\n        woo_customer_id,\n        customer_data,\n        external_id,\n        idempotency_token,\n        state\n      ) VALUES ($1, $2, $3, $4::jsonb, $5, $6, 'draft')\n      ON CONFLICT (queue_id, woo_customer_id)\n      DO UPDATE SET updated_at = NOW()\n      RETURNING id`,\n      [queueId, orgId, wooCustomerId, JSON.stringify(customerData), sanitizedExternalId, idempotencyToken]\n    );\n\n    if (!result.rows.length) {\n      throw new Error('Failed to add line to queue');\n    }\n\n    // Update total_count in queue\n    await this.updateQueueCounts(queueId, orgId);\n\n    return result.rows[0].id;\n  }\n\n  /**\n   * Update total_count based on current lines\n   *\n   * SECURITY:\n   * - Org_id isolation enforced\n   * - No injection possible (parameterized)\n   */\n  static async updateQueueCounts(queueId: string, orgId: string): Promise<void> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    await query(\n      `UPDATE woo_customer_sync_queue\n       SET total_count = (\n         SELECT COUNT(*) FROM woo_customer_sync_queue_line\n         WHERE queue_id = $1 AND org_id = $2\n       )\n       WHERE id = $1 AND org_id = $2`,\n      [queueId, orgId]\n    );\n  }\n\n  /**\n   * Get next batch of draft lines for processing\n   *\n   * SECURITY:\n   * - Org_id isolation enforced\n   * - Batch size clamped to prevent DOS\n   */\n  static async getNextBatch(\n    queueId: string,\n    orgId: string,\n    batchSize: number = 50\n  ): Promise<any[]> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    const size = validateIntRange(batchSize, 1, 1000, 'batchSize');\n\n    const result = await query(\n      `SELECT id, woo_customer_id, customer_data, queue_id\n       FROM woo_customer_sync_queue_line\n       WHERE queue_id = $1 AND org_id = $2 AND state = 'draft'\n       ORDER BY created_at ASC\n       LIMIT $3`,\n      [queueId, orgId, size]\n    );\n\n    return result.rows;\n  }\n\n  /**\n   * Mark lines as processing (atomic operation)\n   *\n   * SECURITY:\n   * - Validates all UUIDs\n   * - Org_id isolation (could be enforced with RLS)\n   */\n  static async markLinesProcessing(\n    lineIds: string[],\n    orgId: string\n  ): Promise<void> {\n    if (!lineIds.length) return;\n\n    validateUUID(orgId, 'orgId');\n\n    // Validate all line IDs\n    lineIds.forEach((id, idx) => {\n      try {\n        validateUUID(id, `lineIds[${idx}]`);\n      } catch (error) {\n        throw new Error(`Invalid line ID at index ${idx}`);\n      }\n    });\n\n    const placeholders = lineIds.map((_, i) => `$${i + 1}`).join(',');\n\n    await query(\n      `UPDATE woo_customer_sync_queue_line\n       SET state = 'processing', process_count = process_count + 1\n       WHERE id IN (${placeholders}) AND org_id = $${lineIds.length + 1}`,\n      [...lineIds, orgId]\n    );\n  }\n\n  /**\n   * Mark line as done with result\n   *\n   * SECURITY:\n   * - Validates all UUIDs\n   * - Org_id isolation enforced\n   * - Customer ID validation (could be UUID or null)\n   */\n  static async markLineDone(\n    lineId: string,\n    customerId: string | null,\n    wasUpdate: boolean,\n    queueId: string,\n    orgId: string\n  ): Promise<void> {\n    validateUUID(lineId, 'lineId');\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    if (customerId) {\n      validateUUID(customerId, 'customerId');\n    }\n\n    await query(\n      `UPDATE woo_customer_sync_queue_line\n       SET state = 'done',\n           result_customer_id = $1,\n           was_update = $2,\n           last_process_date = NOW(),\n           updated_at = NOW()\n       WHERE id = $3 AND org_id = $4`,\n      [customerId, wasUpdate, lineId, orgId]\n    );\n\n    // Log activity\n    await this.logActivity(\n      queueId,\n      lineId,\n      'customer_sync',\n      'success',\n      'Customer synced successfully',\n      orgId,\n      null, // userId from calling context\n      { customerId, wasUpdate }\n    );\n  }\n\n  /**\n   * Mark line as failed with error details\n   *\n   * SECURITY:\n   * - Validates all UUIDs\n   * - Sanitizes error message (truncate to prevent bloat)\n   * - Org_id isolation enforced\n   */\n  static async markLineFailed(\n    lineId: string,\n    error: string,\n    queueId: string,\n    orgId: string\n  ): Promise<void> {\n    validateUUID(lineId, 'lineId');\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    const sanitizedError = sanitizeString(error, 500);\n\n    const result = await query<{ process_count: number }>(\n      `UPDATE woo_customer_sync_queue_line\n       SET state = 'failed',\n           error_message = $1,\n           error_count = error_count + 1,\n           last_error_timestamp = NOW(),\n           last_process_date = NOW(),\n           updated_at = NOW()\n       WHERE id = $2 AND org_id = $3\n       RETURNING process_count`,\n      [sanitizedError, lineId, orgId]\n    );\n\n    const processCount = result.rows[0]?.process_count || 0;\n\n    // Log activity\n    await this.logActivity(\n      queueId,\n      lineId,\n      'customer_sync',\n      'failed',\n      sanitizedError,\n      orgId,\n      null,\n      { processCount, willRetry: processCount < 3 }\n    );\n  }\n\n  /**\n   * Get queue status (counts, state, progress)\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   * - Returns null if queue not found (doesn't leak existence)\n   */\n  static async getQueueStatus(queueId: string, orgId: string): Promise<any | null> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    const result = await query(\n      `SELECT\n        id,\n        queue_name,\n        state,\n        total_count,\n        draft_count,\n        done_count,\n        failed_count,\n        cancelled_count,\n        process_count,\n        is_action_required,\n        action_required_reason,\n        last_process_date,\n        created_at,\n        metadata\n       FROM woo_customer_sync_queue\n       WHERE id = $1 AND org_id = $2`,\n      [queueId, orgId]\n    );\n\n    if (!result.rows.length) {\n      return null; // Queue not found or not authorized\n    }\n\n    const queue = result.rows[0];\n\n    // Calculate progress\n    const completed = queue.done_count + queue.cancelled_count;\n    const progress = queue.total_count > 0 ? Math.round((completed / queue.total_count) * 100) : 0;\n\n    return {\n      ...queue,\n      progress,\n      processingCount: queue.total_count\n        - queue.draft_count\n        - queue.done_count\n        - queue.failed_count\n        - queue.cancelled_count,\n    };\n  }\n\n  /**\n   * Check if queue requires action (retries exceeded)\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   */\n  static async checkQueueActionRequired(queueId: string, orgId: string): Promise<void> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    const result = await query<{ process_count: number; id: string }>(\n      `SELECT id, process_count FROM woo_customer_sync_queue\n       WHERE id = $1 AND org_id = $2`,\n      [queueId, orgId]\n    );\n\n    if (!result.rows.length) return;\n\n    const { process_count, id } = result.rows[0];\n\n    // Mark as action required if process_count > 3 (Odoo pattern)\n    if (process_count > 3) {\n      await query(\n        `UPDATE woo_customer_sync_queue\n         SET is_action_required = true,\n             action_required_reason = 'Exceeded maximum retry attempts (3). Manual intervention required.',\n             updated_at = NOW()\n         WHERE id = $1 AND org_id = $2`,\n        [id, orgId]\n      );\n    }\n  }\n\n  /**\n   * Force done (cancel remaining draft/failed lines)\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   * - User context required for audit\n   */\n  static async forceDone(\n    queueId: string,\n    orgId: string,\n    userId: string\n  ): Promise<number> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n    validateUUID(userId, 'userId');\n\n    const result = await query<{ count: number }>(\n      `UPDATE woo_customer_sync_queue_line\n       SET state = 'cancelled'\n       WHERE queue_id = $1 AND org_id = $2 AND state IN ('draft', 'failed')\n       RETURNING COUNT(*) as count`,\n      [queueId, orgId]\n    );\n\n    const count = result.rows[0]?.count || 0;\n\n    // Log the action\n    await this.logActivity(\n      queueId,\n      null,\n      'force_done',\n      'completed',\n      `Forced done: ${count} lines cancelled`,\n      orgId,\n      userId,\n      { cancelledCount: count }\n    );\n\n    // Mark queue as done\n    await query(\n      `UPDATE woo_customer_sync_queue\n       SET state = 'done',\n           updated_at = NOW()\n       WHERE id = $1 AND org_id = $2`,\n      [queueId, orgId]\n    );\n\n    return count;\n  }\n\n  /**\n   * Log activity (APPEND-ONLY audit trail)\n   *\n   * SECURITY:\n   * - Validates all UUIDs\n   * - Org_id isolation enforced\n   * - Message sanitized (no injection)\n   * - Only INSERT allowed (immutable audit log)\n   *\n   * NOTE: This replaces the old pattern which queried org_id from queue.\n   * Now org_id is explicitly validated before logging.\n   */\n  static async logActivity(\n    queueId: string,\n    queueLineId: string | null,\n    activityType: string,\n    status: string,\n    message: string,\n    orgId: string,\n    userId: string | null,\n    details?: Record<string, any>\n  ): Promise<void> {\n    // Validate inputs\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    if (queueLineId) {\n      validateUUID(queueLineId, 'queueLineId');\n    }\n\n    if (userId) {\n      validateUUID(userId, 'userId');\n    }\n\n    const sanitizedMessage = sanitizeString(message, 500);\n    const sanitizedActivityType = sanitizeString(activityType, 100);\n    const sanitizedStatus = sanitizeString(status, 100);\n\n    // Verify queue belongs to org (authorization check)\n    const queueCheck = await query<{ id: string }>(\n      `SELECT id FROM woo_customer_sync_queue\n       WHERE id = $1 AND org_id = $2`,\n      [queueId, orgId]\n    );\n\n    if (!queueCheck.rows.length) {\n      throw new Error('Queue not found or unauthorized');\n    }\n\n    // Insert activity log (append-only)\n    await query(\n      `INSERT INTO woo_sync_activity\n       (queue_id, queue_line_id, org_id, activity_type, status, message, details, created_by, created_at)\n       VALUES ($1, $2, $3, $4, $5, $6, $7::jsonb, $8, NOW())`,\n      [\n        queueId,\n        queueLineId,\n        orgId,\n        sanitizedActivityType,\n        sanitizedStatus,\n        sanitizedMessage,\n        JSON.stringify(details || {}),\n        userId,\n      ]\n    );\n  }\n\n  /**\n   * Get activity log for queue\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   * - Limit enforced to prevent DOS\n   */\n  static async getActivityLog(\n    queueId: string,\n    orgId: string,\n    limit: number = 100\n  ): Promise<any[]> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    const safeLimit = validateIntRange(limit, 1, 1000, 'limit');\n\n    const result = await query(\n      `SELECT id, queue_line_id, activity_type, status, message, details, created_at, created_by\n       FROM woo_sync_activity\n       WHERE queue_id = $1 AND org_id = $2\n       ORDER BY created_at DESC\n       LIMIT $3`,\n      [queueId, orgId, safeLimit]\n    );\n\n    return result.rows;\n  }\n\n  /**\n   * Get failed lines with retry potential\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   * - Max retries clamped to prevent DOS\n   */\n  static async getRetryableFailed(\n    queueId: string,\n    orgId: string,\n    maxRetries: number = 3\n  ): Promise<any[]> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    const safeMaxRetries = validateIntRange(maxRetries, 1, 10, 'maxRetries');\n\n    const result = await query(\n      `SELECT id, woo_customer_id, customer_data, error_message, process_count\n       FROM woo_customer_sync_queue_line\n       WHERE queue_id = $1\n         AND org_id = $2\n         AND state = 'failed'\n         AND process_count < $3\n       ORDER BY last_error_timestamp ASC`,\n      [queueId, orgId, safeMaxRetries]\n    );\n\n    return result.rows;\n  }\n\n  /**\n   * Increment queue process count\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   */\n  static async incrementQueueProcessCount(queueId: string, orgId: string): Promise<void> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    await query(\n      `UPDATE woo_customer_sync_queue\n       SET process_count = process_count + 1,\n           last_process_date = NOW(),\n           updated_at = NOW()\n       WHERE id = $1 AND org_id = $2`,\n      [queueId, orgId]\n    );\n  }\n\n  /**\n   * Set queue as processing\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   */\n  static async setQueueProcessing(\n    queueId: string,\n    orgId: string,\n    isProcessing: boolean\n  ): Promise<void> {\n    validateUUID(queueId, 'queueId');\n    validateUUID(orgId, 'orgId');\n\n    await query(\n      `UPDATE woo_customer_sync_queue\n       SET is_processing = $1,\n           updated_at = NOW()\n       WHERE id = $2 AND org_id = $3`,\n      [isProcessing, queueId, orgId]\n    );\n  }\n\n  /**\n   * Get queue by idempotency key\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   * - Returns null if not found (doesn't leak existence)\n   */\n  static async getQueueByIdempotencyKey(\n    orgId: string,\n    idempotencyKey: string\n  ): Promise<any | null> {\n    validateUUID(orgId, 'orgId');\n\n    const sanitizedKey = sanitizeString(idempotencyKey, 255);\n\n    const result = await query(\n      `SELECT id, state, process_count FROM woo_customer_sync_queue\n       WHERE org_id = $1 AND idempotency_key = $2`,\n      [orgId, sanitizedKey]\n    );\n\n    return result.rows[0] || null;\n  }\n\n  /**\n   * Clean up old completed queues (retention: 30 days)\n   *\n   * SECURITY:\n   * - Validates UUIDs\n   * - Org_id isolation enforced\n   * - Retention days clamped to reasonable range (1-365)\n   * - CRITICAL: Uses parameterized query, NOT string interpolation\n   */\n  static async cleanupOldQueues(\n    orgId: string,\n    retentionDays: number = 30\n  ): Promise<number> {\n    validateUUID(orgId, 'orgId');\n\n    // Validate and clamp retention days (prevents any manipulation)\n    const days = validateIntRange(retentionDays, 1, 365, 'retentionDays');\n\n    // CRITICAL: Use INTERVAL '1 day' * $2 instead of string interpolation\n    const result = await query<{ count: number }>(\n      `DELETE FROM woo_customer_sync_queue\n       WHERE org_id = $1\n         AND state IN ('done', 'failed', 'cancelled')\n         AND updated_at < NOW() - INTERVAL '1 day' * $2\n       RETURNING COUNT(*) as count`,\n      [orgId, days]\n    );\n\n    return result.rows[0]?.count || 0;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\stores\\notification-store.ts","messages":[{"ruleId":"no-undef","severity":2,"message":"'crypto' is not defined.","line":13,"column":15,"nodeType":"Identifier","messageId":"undef","endLine":13,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { create } from 'zustand'\r\nimport { devtools } from 'zustand/middleware'\r\nimport type { Notification, NotificationStore } from '@/lib/types/inventory'\r\n\r\nexport const useNotificationStore = create<NotificationStore>()(\r\n  devtools(\r\n    (set, get) => ({\r\n      notifications: [],\r\n      unreadCount: 0,\r\n\r\n      addNotification: (notification: Omit<Notification, 'id' | 'timestamp' | 'read'>) => {\r\n        const newNotification: Notification = {\r\n          id: crypto.randomUUID(),\r\n          timestamp: new Date().toISOString(),\r\n          read: false,\r\n          ...notification\r\n        }\r\n\r\n        set((state) => ({\r\n          notifications: [newNotification, ...state.notifications],\r\n          unreadCount: state.unreadCount + 1\r\n        }))\r\n\r\n        // Auto-remove info notifications after 5 seconds\r\n        if (notification.type === 'info') {\r\n          setTimeout(() => {\r\n            get().removeNotification(newNotification.id)\r\n          }, 5000)\r\n        }\r\n      },\r\n\r\n      markAsRead: (id: string) => {\r\n        set((state) => {\r\n          const notification = state.notifications.find((n: Notification) => n.id === id)\r\n          if (!notification || notification.read) return state\r\n\r\n          return {\r\n            notifications: state.notifications.map((n: Notification) =>\r\n              n.id === id ? { ...n, read: true } : n\r\n            ),\r\n            unreadCount: Math.max(0, state.unreadCount - 1)\r\n          }\r\n        })\r\n      },\r\n\r\n      markAllAsRead: () => {\r\n        set((state) => ({\r\n          notifications: state.notifications.map((n: Notification) => ({ ...n, read: true })),\r\n          unreadCount: 0\r\n        }))\r\n      },\r\n\r\n      removeNotification: (id: string) => {\r\n        set((state) => {\r\n          const notification = state.notifications.find((n: Notification) => n.id === id)\r\n          const wasUnread = notification && !notification.read\r\n\r\n          return {\r\n            notifications: state.notifications.filter((n: Notification) => n.id !== id),\r\n            unreadCount: wasUnread ? Math.max(0, state.unreadCount - 1) : state.unreadCount\r\n          }\r\n        })\r\n      },\r\n\r\n      clearAll: () => {\r\n        set({\r\n          notifications: [],\r\n          unreadCount: 0\r\n        })\r\n      }\r\n    }),\r\n    {\r\n      name: 'notification-store'\r\n    }\r\n  )\r\n)\r\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\supplier-discovery\\ai-analytics.ts","messages":[{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":168,"column":16,"nodeType":"TemplateLiteral","endLine":183,"endColumn":10},{"ruleId":"ssot/no-legacy-supplier-inventory","severity":2,"message":"SSOT violation: use canonical SSOT services or schema-qualified public views (public.suppliers/public.inventory_items).","line":485,"column":7,"nodeType":"Literal","endLine":485,"endColumn":46},{"ruleId":"no-restricted-syntax","severity":2,"message":"Use public.suppliers view or SSOT services","line":485,"column":7,"nodeType":"Literal","messageId":"restrictedSyntax","endLine":485,"endColumn":46}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * AI Analytics Integration for Supplier Discovery\n *\n * Provides intelligent supplier scoring, risk assessment, performance predictions,\n * and comparative analysis using AI-powered analytics.\n *\n * Features:\n * - AI-powered supplier scoring\n * - Risk assessment via anomaly detection\n * - Performance predictions\n * - Comparative supplier analysis\n * - Automatic caching and database storage\n */\n\nimport { aiDatabase } from '@/lib/ai/database-integration';\nimport { query } from '@/lib/database/connection';\nimport { z } from 'zod';\n\n// ============================================================================\n// TYPES AND SCHEMAS\n// ============================================================================\n\nexport interface SupplierScore {\n  supplierId: number;\n  supplierName: string;\n  overallScore: number; // 0-100\n  scores: {\n    reliability: number;\n    quality: number;\n    communication: number;\n    pricing: number;\n    delivery: number;\n    compliance: number;\n  };\n  grade: 'A+' | 'A' | 'B' | 'C' | 'D' | 'F';\n  confidence: number; // 0-1\n  insights: Array<{\n    category: string;\n    finding: string;\n    impact: 'positive' | 'negative' | 'neutral';\n    severity: 'low' | 'medium' | 'high';\n  }>;\n  lastUpdated: Date;\n  dataPoints: number;\n}\n\nexport interface SupplierRiskAssessment {\n  supplierId: number;\n  supplierName: string;\n  overallRiskScore: number; // 0-100, higher = more risk\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n  risks: Array<{\n    type: 'financial' | 'operational' | 'compliance' | 'quality' | 'delivery' | 'reputation';\n    severity: 'low' | 'medium' | 'high' | 'critical';\n    title: string;\n    description: string;\n    likelihood: number; // 0-1\n    impact: number; // 0-1\n    mitigation: string;\n    detectMethod: string;\n  }>;\n  anomalies: Array<{\n    type: string;\n    severity: string;\n    description: string;\n    affectedMetrics: string[];\n    suggestedAction: string;\n  }>;\n  recommendations: string[];\n  assessmentDate: Date;\n  confidence: number;\n}\n\nexport interface SupplierPerformancePrediction {\n  supplierId: number;\n  supplierName: string;\n  predictionType: 'on_time_delivery' | 'quality_score' | 'cost_trend' | 'order_volume';\n  forecastDays: number;\n  predictions: Array<{\n    date: string;\n    value: number;\n    confidence: number;\n    lowerBound: number;\n    upperBound: number;\n  }>;\n  trend: 'improving' | 'stable' | 'declining';\n  trendStrength: number; // 0-1\n  keyFactors: Array<{\n    factor: string;\n    impact: number; // -1 to 1\n    description: string;\n  }>;\n  recommendations: string[];\n  confidence: number;\n  generatedAt: Date;\n}\n\nexport interface SupplierComparison {\n  supplierIds: number[];\n  suppliers: Array<{\n    id: number;\n    name: string;\n    rank: number;\n    overallScore: number;\n    strengths: string[];\n    weaknesses: string[];\n  }>;\n  comparisonMetrics: {\n    reliability: Record<number, number>;\n    quality: Record<number, number>;\n    pricing: Record<number, number>;\n    delivery: Record<number, number>;\n    compliance: Record<number, number>;\n  };\n  bestPerformer: {\n    supplierId: number;\n    supplierName: string;\n    category: string;\n  };\n  recommendations: Array<{\n    supplierId: number;\n    supplierName: string;\n    recommendation: string;\n    reason: string;\n    priority: 'high' | 'medium' | 'low';\n  }>;\n  analysisDate: Date;\n}\n\n// ============================================================================\n// SUPPLIER AI ANALYTICS SERVICE\n// ============================================================================\n\nexport class SupplierAIAnalytics {\n  private cachePrefix = 'supplier_ai_analytics';\n  private cacheTTL = 3600; // 1 hour in seconds\n\n  /**\n   * Score a supplier using AI-powered comprehensive analysis\n   *\n   * Analyzes historical data including:\n   * - Purchase orders and fulfillment\n   * - Product quality metrics\n   * - Delivery performance\n   * - Communication patterns\n   * - Pricing consistency\n   * - Compliance records\n   */\n  async scoreSupplier(supplierId: number): Promise<SupplierScore> {\n    try {\n      console.log(`AI Analytics: Scoring supplier ${supplierId}`);\n\n      // Check cache first\n      const cached = await this.getCachedScore(supplierId);\n      if (cached) {\n        console.log(`AI Analytics: Cache hit for supplier ${supplierId} score`);\n        return cached;\n      }\n\n      // Fetch supplier data\n      const supplierData = await this.fetchSupplierData(supplierId);\n      if (!supplierData) {\n        throw new Error(`Supplier ${supplierId} not found`);\n      }\n\n      // Analyze supplier data using AI\n      const analysis = await aiDatabase.analyzeData({\n        query: `\n          SELECT\n            s.id, s.name, s.email, s.status,\n            COUNT(DISTINCT po.id) as total_orders,\n            AVG(CASE WHEN po.status = 'completed' THEN 1 ELSE 0 END) as completion_rate,\n            AVG(EXTRACT(EPOCH FROM (po.delivery_date - po.order_date))/86400) as avg_delivery_days,\n            COUNT(DISTINCT p.id) as products_supplied,\n            AVG(poi.unit_price) as avg_unit_price,\n            SUM(poi.total) as total_revenue\n          FROM suppliers s\n          LEFT JOIN purchase_orders po ON s.id = po.supplier_id\n          LEFT JOIN purchase_order_items poi ON po.id = poi.purchase_order_id\n          LEFT JOIN products p ON p.supplier_id = s.id\n          WHERE s.id = ${supplierId}\n          GROUP BY s.id, s.name, s.email, s.status\n        `,\n        focus: 'all',\n      });\n\n      // Calculate detailed scores\n      const scores = this.calculateScores(supplierData, analysis);\n\n      // Determine grade\n      const grade = this.calculateGrade(scores.overall);\n\n      // Build supplier score object\n      const supplierScore: SupplierScore = {\n        supplierId,\n        supplierName: supplierData.name,\n        overallScore: scores.overall,\n        scores: {\n          reliability: scores.reliability,\n          quality: scores.quality,\n          communication: scores.communication,\n          pricing: scores.pricing,\n          delivery: scores.delivery,\n          compliance: scores.compliance,\n        },\n        grade,\n        confidence: analysis.metrics.data_quality_score,\n        insights: analysis.insights.map(insight => ({\n          category: insight.category,\n          finding: insight.description,\n          impact: insight.impact === 'high' || insight.impact === 'critical'\n            ? 'negative'\n            : insight.category === 'opportunity' ? 'positive' : 'neutral',\n          severity: insight.impact,\n        })),\n        lastUpdated: new Date(),\n        dataPoints: analysis.metrics.total_records,\n      };\n\n      // Store in database\n      await this.storeSupplierScore(supplierScore);\n\n      // Cache the result\n      await this.cacheScore(supplierId, supplierScore);\n\n      console.log(`AI Analytics: Supplier ${supplierId} scored: ${scores.overall}/100 (${grade})`);\n\n      return supplierScore;\n    } catch (error) {\n      console.error('AI Analytics: Score supplier failed:', error);\n      throw new Error(`Failed to score supplier: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Assess supplier risks using anomaly detection and pattern analysis\n   */\n  async assessSupplierRisk(supplierId: number): Promise<SupplierRiskAssessment> {\n    try {\n      console.log(`AI Analytics: Assessing risk for supplier ${supplierId}`);\n\n      // Check cache\n      const cached = await this.getCachedRiskAssessment(supplierId);\n      if (cached) {\n        console.log(`AI Analytics: Cache hit for supplier ${supplierId} risk assessment`);\n        return cached;\n      }\n\n      // Fetch supplier data\n      const supplierData = await this.fetchSupplierData(supplierId);\n      if (!supplierData) {\n        throw new Error(`Supplier ${supplierId} not found`);\n      }\n\n      // Run anomaly detection on supplier's performance data\n      const anomalies = await aiDatabase.detectAnomalies({\n        query: `\n          SELECT\n            po.id, po.order_date, po.delivery_date, po.status, po.total_amount,\n            EXTRACT(EPOCH FROM (po.delivery_date - po.order_date))/86400 as delivery_days,\n            COUNT(poi.id) as item_count,\n            SUM(poi.quantity) as total_quantity\n          FROM purchase_orders po\n          LEFT JOIN purchase_order_items poi ON po.id = poi.purchase_order_id\n          WHERE po.supplier_id = ${supplierId}\n            AND po.created_at > NOW() - INTERVAL '6 months'\n          GROUP BY po.id, po.order_date, po.delivery_date, po.status, po.total_amount\n          ORDER BY po.order_date DESC\n        `,\n        checks: ['data_quality', 'statistical', 'business_rule'],\n      });\n\n      // Calculate risk score based on anomalies\n      const overallRiskScore = this.calculateRiskScore(anomalies);\n      const riskLevel = this.determineRiskLevel(overallRiskScore);\n\n      // Map anomalies to risks\n      const risks = anomalies.anomalies.map(anomaly => ({\n        type: this.mapAnomalyToRiskType(anomaly.type),\n        severity: anomaly.severity,\n        title: anomaly.title,\n        description: anomaly.description,\n        likelihood: anomaly.severity === 'critical' ? 0.9 : anomaly.severity === 'high' ? 0.7 : 0.4,\n        impact: anomaly.affected_records / 100, // Normalize\n        mitigation: anomaly.suggested_fix || 'Review and validate supplier data',\n        detectMethod: anomaly.detection_method,\n      }));\n\n      const riskAssessment: SupplierRiskAssessment = {\n        supplierId,\n        supplierName: supplierData.name,\n        overallRiskScore,\n        riskLevel,\n        risks,\n        anomalies: anomalies.anomalies.map(a => ({\n          type: a.type,\n          severity: a.severity,\n          description: a.description,\n          affectedMetrics: ['delivery_performance', 'order_quality'],\n          suggestedAction: a.suggested_fix || 'Monitor closely',\n        })),\n        recommendations: anomalies.recommendations,\n        assessmentDate: new Date(),\n        confidence: anomalies.overall_health_score,\n      };\n\n      // Store in database\n      await this.storeRiskAssessment(riskAssessment);\n\n      // Cache result\n      await this.cacheRiskAssessment(supplierId, riskAssessment);\n\n      console.log(`AI Analytics: Risk assessment for supplier ${supplierId}: ${riskLevel} (${overallRiskScore}/100)`);\n\n      return riskAssessment;\n    } catch (error) {\n      console.error('AI Analytics: Risk assessment failed:', error);\n      throw new Error(`Failed to assess supplier risk: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Predict supplier performance using AI-powered forecasting\n   */\n  async predictSupplierPerformance(\n    supplierId: number,\n    predictionType: 'on_time_delivery' | 'quality_score' | 'cost_trend' | 'order_volume' = 'on_time_delivery',\n    forecastDays: number = 30\n  ): Promise<SupplierPerformancePrediction> {\n    try {\n      console.log(`AI Analytics: Predicting ${predictionType} for supplier ${supplierId}`);\n\n      // Check cache\n      const cached = await this.getCachedPrediction(supplierId, predictionType);\n      if (cached) {\n        console.log(`AI Analytics: Cache hit for supplier ${supplierId} prediction`);\n        return cached;\n      }\n\n      // Fetch supplier data\n      const supplierData = await this.fetchSupplierData(supplierId);\n      if (!supplierData) {\n        throw new Error(`Supplier ${supplierId} not found`);\n      }\n\n      // Generate predictions using AI\n      const aiPredictionType = this.mapPredictionType(predictionType);\n      const predictions = await aiDatabase.generatePredictions({\n        type: aiPredictionType,\n        target_id: supplierId,\n        forecast_days: forecastDays,\n      });\n\n      // Analyze trend\n      const trend = this.analyzeTrend(predictions.predictions);\n      const trendStrength = this.calculateTrendStrength(predictions.predictions);\n\n      const performancePrediction: SupplierPerformancePrediction = {\n        supplierId,\n        supplierName: supplierData.name,\n        predictionType,\n        forecastDays,\n        predictions: predictions.predictions.map(p => ({\n          date: p.date,\n          value: p.value,\n          confidence: p.confidence,\n          lowerBound: p.lower_bound || p.value * 0.9,\n          upperBound: p.upper_bound || p.value * 1.1,\n        })),\n        trend,\n        trendStrength,\n        keyFactors: predictions.factors.map(f => ({\n          factor: f.name,\n          impact: f.impact,\n          description: f.description,\n        })),\n        recommendations: predictions.recommendations,\n        confidence: predictions.confidence,\n        generatedAt: new Date(),\n      };\n\n      // Store in database\n      await this.storePrediction(performancePrediction);\n\n      // Cache result\n      await this.cachePrediction(supplierId, predictionType, performancePrediction);\n\n      console.log(`AI Analytics: Prediction for supplier ${supplierId}: ${trend} trend (confidence: ${predictions.confidence})`);\n\n      return performancePrediction;\n    } catch (error) {\n      console.error('AI Analytics: Performance prediction failed:', error);\n      throw new Error(`Failed to predict supplier performance: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Compare multiple suppliers with AI-powered analysis\n   */\n  async compareSuppliers(supplierIds: number[]): Promise<SupplierComparison> {\n    try {\n      console.log(`AI Analytics: Comparing ${supplierIds.length} suppliers`);\n\n      if (supplierIds.length < 2) {\n        throw new Error('At least 2 suppliers required for comparison');\n      }\n\n      // Score all suppliers\n      const scores = await Promise.all(\n        supplierIds.map(id => this.scoreSupplier(id))\n      );\n\n      // Rank suppliers\n      const rankedSuppliers = scores\n        .sort((a, b) => b.overallScore - a.overallScore)\n        .map((score, index) => ({\n          id: score.supplierId,\n          name: score.supplierName,\n          rank: index + 1,\n          overallScore: score.overallScore,\n          strengths: this.identifyStrengths(score),\n          weaknesses: this.identifyWeaknesses(score),\n        }));\n\n      // Build comparison metrics\n      const comparisonMetrics = {\n        reliability: {} as Record<number, number>,\n        quality: {} as Record<number, number>,\n        pricing: {} as Record<number, number>,\n        delivery: {} as Record<number, number>,\n        compliance: {} as Record<number, number>,\n      };\n\n      scores.forEach(score => {\n        comparisonMetrics.reliability[score.supplierId] = score.scores.reliability;\n        comparisonMetrics.quality[score.supplierId] = score.scores.quality;\n        comparisonMetrics.pricing[score.supplierId] = score.scores.pricing;\n        comparisonMetrics.delivery[score.supplierId] = score.scores.delivery;\n        comparisonMetrics.compliance[score.supplierId] = score.scores.compliance;\n      });\n\n      // Find best performer\n      const bestPerformer = rankedSuppliers[0];\n\n      // Generate recommendations\n      const recommendations = rankedSuppliers.map(supplier => {\n        const score = scores.find(s => s.supplierId === supplier.id)!;\n        return {\n          supplierId: supplier.id,\n          supplierName: supplier.name,\n          recommendation: this.generateRecommendation(supplier, score),\n          reason: this.generateRecommendationReason(supplier, score),\n          priority: supplier.rank <= 2 ? 'high' as const : supplier.rank <= 4 ? 'medium' as const : 'low' as const,\n        };\n      });\n\n      const comparison: SupplierComparison = {\n        supplierIds,\n        suppliers: rankedSuppliers,\n        comparisonMetrics,\n        bestPerformer: {\n          supplierId: bestPerformer.id,\n          supplierName: bestPerformer.name,\n          category: 'overall_performance',\n        },\n        recommendations,\n        analysisDate: new Date(),\n      };\n\n      console.log(`AI Analytics: Comparison complete. Best performer: ${bestPerformer.name} (${bestPerformer.overallScore}/100)`);\n\n      return comparison;\n    } catch (error) {\n      console.error('AI Analytics: Supplier comparison failed:', error);\n      throw new Error(`Failed to compare suppliers: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  // ============================================================================\n  // PRIVATE HELPER METHODS\n  // ============================================================================\n\n  private async fetchSupplierData(supplierId: number): Promise<any> {\n    const result = await query(\n      'SELECT * FROM suppliers WHERE id = $1',\n      [supplierId]\n    );\n    return result.rows[0];\n  }\n\n  private calculateScores(supplierData: any, analysis: any): {\n    overall: number;\n    reliability: number;\n    quality: number;\n    communication: number;\n    pricing: number;\n    delivery: number;\n    compliance: number;\n  } {\n    // Base scores from data quality\n    const baseScore = analysis.metrics.data_quality_score * 100;\n\n    // Calculate individual scores based on insights\n    const scores = {\n      reliability: baseScore * 0.9 + Math.random() * 10, // Placeholder logic\n      quality: baseScore * 0.95 + Math.random() * 5,\n      communication: baseScore * 0.85 + Math.random() * 15,\n      pricing: baseScore * 0.8 + Math.random() * 20,\n      delivery: baseScore * 0.9 + Math.random() * 10,\n      compliance: baseScore * 1.0,\n    };\n\n    // Calculate weighted overall score\n    const overall = (\n      scores.reliability * 0.25 +\n      scores.quality * 0.25 +\n      scores.communication * 0.1 +\n      scores.pricing * 0.15 +\n      scores.delivery * 0.15 +\n      scores.compliance * 0.1\n    );\n\n    return {\n      overall: Math.round(overall),\n      reliability: Math.round(scores.reliability),\n      quality: Math.round(scores.quality),\n      communication: Math.round(scores.communication),\n      pricing: Math.round(scores.pricing),\n      delivery: Math.round(scores.delivery),\n      compliance: Math.round(scores.compliance),\n    };\n  }\n\n  private calculateGrade(score: number): 'A+' | 'A' | 'B' | 'C' | 'D' | 'F' {\n    if (score >= 95) return 'A+';\n    if (score >= 85) return 'A';\n    if (score >= 75) return 'B';\n    if (score >= 65) return 'C';\n    if (score >= 55) return 'D';\n    return 'F';\n  }\n\n  private calculateRiskScore(anomalies: any): number {\n    const criticalWeight = 25;\n    const highWeight = 15;\n    const mediumWeight = 8;\n    const lowWeight = 3;\n\n    const score = anomalies.anomalies.reduce((total: number, anomaly: any) => {\n      switch (anomaly.severity) {\n        case 'critical': return total + criticalWeight;\n        case 'high': return total + highWeight;\n        case 'medium': return total + mediumWeight;\n        case 'low': return total + lowWeight;\n        default: return total;\n      }\n    }, 0);\n\n    return Math.min(100, score);\n  }\n\n  private determineRiskLevel(riskScore: number): 'low' | 'medium' | 'high' | 'critical' {\n    if (riskScore >= 75) return 'critical';\n    if (riskScore >= 50) return 'high';\n    if (riskScore >= 25) return 'medium';\n    return 'low';\n  }\n\n  private mapAnomalyToRiskType(anomalyType: string): 'financial' | 'operational' | 'compliance' | 'quality' | 'delivery' | 'reputation' {\n    const mapping: Record<string, any> = {\n      'data_quality': 'operational',\n      'statistical': 'quality',\n      'business_rule': 'compliance',\n      'security': 'compliance',\n    };\n    return mapping[anomalyType] || 'operational';\n  }\n\n  private mapPredictionType(predictionType: string): 'inventory_demand' | 'supplier_performance' | 'price_trends' | 'stock_levels' {\n    const mapping: Record<string, any> = {\n      'on_time_delivery': 'supplier_performance',\n      'quality_score': 'supplier_performance',\n      'cost_trend': 'price_trends',\n      'order_volume': 'inventory_demand',\n    };\n    return mapping[predictionType] || 'supplier_performance';\n  }\n\n  private analyzeTrend(predictions: any[]): 'improving' | 'stable' | 'declining' {\n    if (predictions.length < 2) return 'stable';\n\n    const firstValue = predictions[0].value;\n    const lastValue = predictions[predictions.length - 1].value;\n    const change = ((lastValue - firstValue) / firstValue) * 100;\n\n    if (change > 5) return 'improving';\n    if (change < -5) return 'declining';\n    return 'stable';\n  }\n\n  private calculateTrendStrength(predictions: any[]): number {\n    if (predictions.length < 2) return 0;\n\n    const values = predictions.map(p => p.value);\n    const avg = values.reduce((a, b) => a + b, 0) / values.length;\n    const variance = values.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / values.length;\n\n    return Math.min(1, variance / avg); // Normalized strength\n  }\n\n  private identifyStrengths(score: SupplierScore): string[] {\n    const strengths: string[] = [];\n    const { scores } = score;\n\n    if (scores.reliability >= 85) strengths.push('High reliability');\n    if (scores.quality >= 85) strengths.push('Excellent quality');\n    if (scores.delivery >= 85) strengths.push('Fast delivery');\n    if (scores.pricing >= 85) strengths.push('Competitive pricing');\n    if (scores.compliance >= 85) strengths.push('Strong compliance');\n    if (scores.communication >= 85) strengths.push('Responsive communication');\n\n    return strengths.length > 0 ? strengths : ['Meets basic requirements'];\n  }\n\n  private identifyWeaknesses(score: SupplierScore): string[] {\n    const weaknesses: string[] = [];\n    const { scores } = score;\n\n    if (scores.reliability < 70) weaknesses.push('Reliability concerns');\n    if (scores.quality < 70) weaknesses.push('Quality issues');\n    if (scores.delivery < 70) weaknesses.push('Delivery delays');\n    if (scores.pricing < 70) weaknesses.push('Pricing concerns');\n    if (scores.compliance < 70) weaknesses.push('Compliance gaps');\n    if (scores.communication < 70) weaknesses.push('Communication issues');\n\n    return weaknesses;\n  }\n\n  private generateRecommendation(supplier: any, score: SupplierScore): string {\n    if (supplier.rank === 1) {\n      return 'Primary supplier - maintain relationship';\n    } else if (supplier.rank <= 3) {\n      return 'Strong candidate - consider for key orders';\n    } else if (score.overallScore >= 70) {\n      return 'Secondary supplier - suitable for backup orders';\n    } else {\n      return 'Monitor performance - consider alternative suppliers';\n    }\n  }\n\n  private generateRecommendationReason(supplier: any, score: SupplierScore): string {\n    if (supplier.rank === 1) {\n      return `Top performer with ${score.overallScore}/100 overall score`;\n    } else {\n      const weaknesses = supplier.weaknesses.join(', ');\n      return weaknesses\n        ? `Ranked #${supplier.rank} with areas for improvement: ${weaknesses}`\n        : `Ranked #${supplier.rank} - solid performance across all metrics`;\n    }\n  }\n\n  // Database storage methods\n  private async storeSupplierScore(score: SupplierScore): Promise<void> {\n    try {\n      await query(`\n        INSERT INTO supplier_performance (\n          supplier_id, overall_score, reliability_score, quality_score,\n          communication_score, pricing_score, delivery_score, compliance_score,\n          grade, confidence, data_points, last_updated\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)\n        ON CONFLICT (supplier_id) DO UPDATE SET\n          overall_score = $2, reliability_score = $3, quality_score = $4,\n          communication_score = $5, pricing_score = $6, delivery_score = $7,\n          compliance_score = $8, grade = $9, confidence = $10,\n          data_points = $11, last_updated = $12\n      `, [\n        score.supplierId, score.overallScore, score.scores.reliability,\n        score.scores.quality, score.scores.communication, score.scores.pricing,\n        score.scores.delivery, score.scores.compliance, score.grade,\n        score.confidence, score.dataPoints, score.lastUpdated\n      ]);\n    } catch (error) {\n      console.error('Failed to store supplier score:', error);\n    }\n  }\n\n  private async storeRiskAssessment(assessment: SupplierRiskAssessment): Promise<void> {\n    try {\n      await query(`\n        INSERT INTO ai_insights (\n          analysis_type, input_data, insights, created_at\n        ) VALUES ($1, $2, $3, NOW())\n      `, [\n        'supplier_risk_assessment',\n        JSON.stringify({ supplier_id: assessment.supplierId }),\n        JSON.stringify(assessment)\n      ]);\n    } catch (error) {\n      console.error('Failed to store risk assessment:', error);\n    }\n  }\n\n  private async storePrediction(prediction: SupplierPerformancePrediction): Promise<void> {\n    try {\n      await query(`\n        INSERT INTO ai_predictions (\n          prediction_type, target_id, predictions, confidence, expires_at, created_at\n        ) VALUES ($1, $2, $3, $4, $5, NOW())\n      `, [\n        prediction.predictionType,\n        prediction.supplierId,\n        JSON.stringify(prediction),\n        prediction.confidence,\n        new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 hours\n      ]);\n    } catch (error) {\n      console.error('Failed to store prediction:', error);\n    }\n  }\n\n  // Cache methods\n  private async getCachedScore(supplierId: number): Promise<SupplierScore | null> {\n    try {\n      const result = await query(`\n        SELECT * FROM analytics_metric_cache\n        WHERE metric_key = $1 AND expires_at > NOW()\n      `, [`${this.cachePrefix}:score:${supplierId}`]);\n\n      if (result.rows.length > 0) {\n        return JSON.parse(result.rows[0].metric_value);\n      }\n    } catch (error) {\n      console.error('Cache read error:', error);\n    }\n    return null;\n  }\n\n  private async cacheScore(supplierId: number, score: SupplierScore): Promise<void> {\n    try {\n      await query(`\n        INSERT INTO analytics_metric_cache (metric_key, metric_value, expires_at)\n        VALUES ($1, $2, NOW() + INTERVAL '${this.cacheTTL} seconds')\n        ON CONFLICT (metric_key) DO UPDATE SET\n          metric_value = $2, expires_at = NOW() + INTERVAL '${this.cacheTTL} seconds'\n      `, [`${this.cachePrefix}:score:${supplierId}`, JSON.stringify(score)]);\n    } catch (error) {\n      console.error('Cache write error:', error);\n    }\n  }\n\n  private async getCachedRiskAssessment(supplierId: number): Promise<SupplierRiskAssessment | null> {\n    try {\n      const result = await query(`\n        SELECT * FROM analytics_metric_cache\n        WHERE metric_key = $1 AND expires_at > NOW()\n      `, [`${this.cachePrefix}:risk:${supplierId}`]);\n\n      if (result.rows.length > 0) {\n        return JSON.parse(result.rows[0].metric_value);\n      }\n    } catch (error) {\n      console.error('Cache read error:', error);\n    }\n    return null;\n  }\n\n  private async cacheRiskAssessment(supplierId: number, assessment: SupplierRiskAssessment): Promise<void> {\n    try {\n      await query(`\n        INSERT INTO analytics_metric_cache (metric_key, metric_value, expires_at)\n        VALUES ($1, $2, NOW() + INTERVAL '${this.cacheTTL} seconds')\n        ON CONFLICT (metric_key) DO UPDATE SET\n          metric_value = $2, expires_at = NOW() + INTERVAL '${this.cacheTTL} seconds'\n      `, [`${this.cachePrefix}:risk:${supplierId}`, JSON.stringify(assessment)]);\n    } catch (error) {\n      console.error('Cache write error:', error);\n    }\n  }\n\n  private async getCachedPrediction(supplierId: number, predictionType: string): Promise<SupplierPerformancePrediction | null> {\n    try {\n      const result = await query(`\n        SELECT * FROM analytics_metric_cache\n        WHERE metric_key = $1 AND expires_at > NOW()\n      `, [`${this.cachePrefix}:prediction:${supplierId}:${predictionType}`]);\n\n      if (result.rows.length > 0) {\n        return JSON.parse(result.rows[0].metric_value);\n      }\n    } catch (error) {\n      console.error('Cache read error:', error);\n    }\n    return null;\n  }\n\n  private async cachePrediction(supplierId: number, predictionType: string, prediction: SupplierPerformancePrediction): Promise<void> {\n    try {\n      await query(`\n        INSERT INTO analytics_metric_cache (metric_key, metric_value, expires_at)\n        VALUES ($1, $2, NOW() + INTERVAL '${this.cacheTTL} seconds')\n        ON CONFLICT (metric_key) DO UPDATE SET\n          metric_value = $2, expires_at = NOW() + INTERVAL '${this.cacheTTL} seconds'\n      `, [`${this.cachePrefix}:prediction:${supplierId}:${predictionType}`, JSON.stringify(prediction)]);\n    } catch (error) {\n      console.error('Cache write error:', error);\n    }\n  }\n}\n\n// Export singleton instance\nexport const supplierAIAnalytics = new SupplierAIAnalytics();\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\supplier-discovery\\config.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":110,"column":34,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":110,"endColumn":35,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3191,3192],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3191,3191],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":110,"column":47,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":110,"endColumn":48,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3204,3205],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3204,3204],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":110,"column":58,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":110,"endColumn":59,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3215,3216],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3215,3215],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":110,"column":63,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":110,"endColumn":64,"suggestions":[{"messageId":"removeEscape","fix":{"range":[3220,3221],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[3220,3220],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Configuration for AI Supplier Discovery System\r\n */\r\n\r\nimport { DataSource } from './types';\r\n\r\nexport const DISCOVERY_CONFIG = {\r\n  // Response time requirements\r\n  TIMEOUT_MS: 30000,\r\n  MAX_RETRY_ATTEMPTS: 3,\r\n\r\n  // Cache settings\r\n  CACHE_TTL_HOURS: 24,\r\n  CACHE_MAX_ENTRIES: 1000,\r\n\r\n  // Confidence thresholds\r\n  MIN_CONFIDENCE_THRESHOLD: 0.6,\r\n  HIGH_CONFIDENCE_THRESHOLD: 0.85,\r\n\r\n  // Rate limiting\r\n  MAX_REQUESTS_PER_MINUTE: 60,\r\n  MAX_CONCURRENT_REQUESTS: 5,\r\n\r\n  // Data validation\r\n  REQUIRED_FIELDS: ['supplierName', 'contactInfo'],\r\n  OPTIONAL_FIELDS: ['address', 'businessInfo', 'compliance'],\r\n};\r\n\r\nexport const DATA_SOURCES: DataSource[] = [\r\n  {\r\n    name: 'SA Companies Registry',\r\n    url: 'https://eservices.cipc.co.za',\r\n    priority: 1,\r\n    enabled: true,\r\n    selectors: {\r\n      registrationNumber: '.registration-number',\r\n      legalName: '.company-name',\r\n      address: '.registered-address',\r\n      status: '.company-status'\r\n    }\r\n  },\r\n  {\r\n    name: 'LinkedIn Company Search',\r\n    url: 'https://www.linkedin.com/company',\r\n    priority: 2,\r\n    enabled: true,\r\n    selectors: {\r\n      companyName: 'h1[data-test-id=\"org-name\"]',\r\n      industry: '.org-top-card-summary-info-list__item',\r\n      employees: '.org-about-company-module__company-size-definition',\r\n      website: '.org-about-company-module__company-details a'\r\n    }\r\n  },\r\n  {\r\n    name: 'Google Business',\r\n    url: 'https://www.google.com/maps/search',\r\n    priority: 3,\r\n    enabled: true,\r\n    selectors: {\r\n      address: '[data-value=\"Address\"]',\r\n      phone: '[data-value=\"Phone\"]',\r\n      website: '[data-value=\"Website\"]',\r\n      hours: '[data-value=\"Hours\"]'\r\n    }\r\n  },\r\n  {\r\n    name: 'Yellow Pages SA',\r\n    url: 'https://www.yellowpages.co.za',\r\n    priority: 4,\r\n    enabled: true,\r\n    selectors: {\r\n      name: '.listing-name',\r\n      address: '.listing-address',\r\n      phone: '.listing-phone',\r\n      website: '.listing-website'\r\n    }\r\n  },\r\n  {\r\n    name: 'BEE Directory',\r\n    url: 'https://www.bee-directory.co.za',\r\n    priority: 5,\r\n    enabled: true,\r\n    selectors: {\r\n      beeLevel: '.bee-level',\r\n      beeRating: '.bee-rating',\r\n      certificationDate: '.cert-date'\r\n    }\r\n  }\r\n];\r\n\r\nexport const FIELD_MAPPINGS = {\r\n  // Common field aliases and variations\r\n  companyName: ['name', 'company_name', 'business_name', 'legal_name'],\r\n  registrationNumber: ['reg_number', 'company_reg', 'registration_no', 'company_number'],\r\n  vatNumber: ['vat_no', 'tax_number', 'vat_registration'],\r\n  phone: ['telephone', 'contact_number', 'phone_number'],\r\n  email: ['email_address', 'contact_email', 'business_email'],\r\n  website: ['web_site', 'homepage', 'url'],\r\n  address: ['postal_address', 'physical_address', 'business_address'],\r\n  industry: ['sector', 'business_type', 'category'],\r\n  employees: ['staff_count', 'employee_count', 'workforce_size']\r\n};\r\n\r\nexport const EXTRACTION_PATTERNS = {\r\n  // Regex patterns for data extraction\r\n  email: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g,\r\n  phone: /(\\+27|0)[0-9\\s\\-()]{8,15}/g,\r\n  vatNumber: /4[0-9]{9}/g,\r\n  registrationNumber: /[0-9]{4}\\/[0-9]{6}\\/[0-9]{2}/g,\r\n  website: /(https?:\\/\\/)?([\\da-z\\.-]+)\\.([a-z\\.]{2,6})([\\/\\w \\.-]*)*\\/?/g,\r\n  postalCode: /[0-9]{4}/g\r\n};\r\n\r\nexport const CONFIDENCE_WEIGHTS = {\r\n  // Weights for calculating confidence scores\r\n  officialSource: 0.4,      // Government registries, official databases\r\n  businessDirectory: 0.3,   // Yellow Pages, business directories\r\n  socialMedia: 0.2,         // LinkedIn, Facebook business pages\r\n  websiteContent: 0.1       // Company websites, general web content\r\n};\r\n\r\nexport const USER_AGENTS = [\r\n  'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',\r\n  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',\r\n  'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'\r\n];\r\n\r\nexport const RETRY_CONFIG = {\r\n  retries: 3,\r\n  retryDelay: 1000, // ms\r\n  retryCondition: (error: any) => {\r\n    return error.code === 'ECONNRESET' ||\r\n           error.code === 'ETIMEDOUT' ||\r\n           (error.response && error.response.status >= 500);\r\n  }\r\n};","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\lib\\supplier-discovery\\utils.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":294,"column":42,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":294,"endColumn":43,"suggestions":[{"messageId":"removeEscape","fix":{"range":[9135,9136],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[9135,9135],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Utility functions for Supplier Discovery System\r\n */\r\n\r\nimport { DiscoveredSupplierData, SupplierAddress, SupplierContactInfo } from './types';\r\nimport { DISCOVERY_CONFIG } from './config';\r\n\r\n/**\r\n * Validate discovered supplier data meets minimum requirements\r\n */\r\nexport function validateSupplierData(data: DiscoveredSupplierData): {\r\n  isValid: boolean;\r\n  errors: string[];\r\n  warnings: string[];\r\n} {\r\n  const errors: string[] = [];\r\n  const warnings: string[] = [];\r\n\r\n  // Required field validation\r\n  if (!data.supplierName || data.supplierName.trim().length < 2) {\r\n    errors.push('Supplier name is required and must be at least 2 characters');\r\n  }\r\n\r\n  // Confidence threshold validation\r\n  if (data.confidence.overall < DISCOVERY_CONFIG.MIN_CONFIDENCE_THRESHOLD) {\r\n    errors.push(`Overall confidence (${Math.round(data.confidence.overall * 100)}%) is below minimum threshold (${Math.round(DISCOVERY_CONFIG.MIN_CONFIDENCE_THRESHOLD * 100)}%)`);\r\n  }\r\n\r\n  // Contact information validation\r\n  if (!data.contactInfo.phone && !data.contactInfo.email && !data.contactInfo.website) {\r\n    warnings.push('No contact information found - phone, email, or website recommended');\r\n  }\r\n\r\n  // Email validation\r\n  if (data.contactInfo.email && !isValidEmail(data.contactInfo.email)) {\r\n    warnings.push('Email address format appears invalid');\r\n  }\r\n\r\n  // Phone number validation\r\n  if (data.contactInfo.phone && !isValidSAPhoneNumber(data.contactInfo.phone)) {\r\n    warnings.push('Phone number format appears invalid for South African numbers');\r\n  }\r\n\r\n  // Website validation\r\n  if (data.contactInfo.website && !isValidWebsite(data.contactInfo.website)) {\r\n    warnings.push('Website URL format appears invalid');\r\n  }\r\n\r\n  // Registration number validation\r\n  if (data.registrationNumber && !isValidSARegistrationNumber(data.registrationNumber)) {\r\n    warnings.push('Registration number format does not match South African standard');\r\n  }\r\n\r\n  // VAT number validation\r\n  if (data.compliance.vatNumber && !isValidSAVATNumber(data.compliance.vatNumber)) {\r\n    warnings.push('VAT number format appears invalid for South African VAT numbers');\r\n  }\r\n\r\n  // Address completeness\r\n  if (!data.address.city && !data.address.province) {\r\n    warnings.push('Address information is incomplete - city and province recommended');\r\n  }\r\n\r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors,\r\n    warnings\r\n  };\r\n}\r\n\r\n/**\r\n * Format supplier data for consistent display\r\n */\r\nexport function formatSupplierData(data: DiscoveredSupplierData): DiscoveredSupplierData {\r\n  return {\r\n    ...data,\r\n    supplierName: formatCompanyName(data.supplierName),\r\n    contactInfo: {\r\n      ...data.contactInfo,\r\n      phone: formatPhoneNumber(data.contactInfo.phone),\r\n      email: data.contactInfo.email.toLowerCase().trim(),\r\n      website: formatWebsite(data.contactInfo.website)\r\n    },\r\n    address: formatAddress(data.address),\r\n    registrationNumber: formatRegistrationNumber(data.registrationNumber),\r\n    compliance: {\r\n      ...data.compliance,\r\n      vatNumber: formatVATNumber(data.compliance.vatNumber)\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Merge multiple supplier data sources with conflict resolution\r\n */\r\nexport function mergeSupplierData(\r\n  dataSources: DiscoveredSupplierData[]\r\n): DiscoveredSupplierData | null {\r\n  if (dataSources.length === 0) return null;\r\n  if (dataSources.length === 1) return dataSources[0];\r\n\r\n  // Sort by confidence (highest first)\r\n  const sortedSources = dataSources.sort((a, b) => b.confidence.overall - a.confidence.overall);\r\n  const primary = sortedSources[0];\r\n\r\n  // Merge strategy: use highest confidence value for each field\r\n  const merged: DiscoveredSupplierData = {\r\n    supplierName: selectBestValue(dataSources, 'supplierName'),\r\n    registrationNumber: selectBestValue(dataSources, 'registrationNumber'),\r\n    address: mergeAddresses(dataSources.map(d => d.address)),\r\n    contactInfo: mergeContactInfo(dataSources.map(d => d.contactInfo)),\r\n    businessInfo: {\r\n      industry: selectBestValue(dataSources, 'businessInfo.industry'),\r\n      establishedDate: selectBestValue(dataSources, 'businessInfo.establishedDate'),\r\n      employeeCount: Math.max(...dataSources.map(d => d.businessInfo.employeeCount || 0)),\r\n      annualRevenue: Math.max(...dataSources.map(d => d.businessInfo.annualRevenue || 0))\r\n    },\r\n    compliance: {\r\n      vatNumber: selectBestValue(dataSources, 'compliance.vatNumber'),\r\n      beeRating: selectBestValue(dataSources, 'compliance.beeRating'),\r\n      certifications: mergeArrays(dataSources.map(d => d.compliance.certifications))\r\n    },\r\n    confidence: {\r\n      overall: primary.confidence.overall,\r\n      individual: { ...primary.confidence.individual }\r\n    },\r\n    sources: mergeArrays(dataSources.map(d => d.sources)),\r\n    discoveredAt: primary.discoveredAt\r\n  };\r\n\r\n  return merged;\r\n}\r\n\r\n/**\r\n * Calculate data freshness score based on discovery time\r\n */\r\nexport function calculateFreshnessScore(discoveredAt: Date): number {\r\n  const now = new Date();\r\n  const ageInHours = (now.getTime() - discoveredAt.getTime()) / (1000 * 60 * 60);\r\n\r\n  // Freshness decays over time\r\n  if (ageInHours <= 1) return 1.0;\r\n  if (ageInHours <= 24) return 0.9;\r\n  if (ageInHours <= 168) return 0.7; // 1 week\r\n  if (ageInHours <= 720) return 0.5; // 1 month\r\n  return 0.3;\r\n}\r\n\r\n/**\r\n * Suggest data refresh based on age and confidence\r\n */\r\nexport function shouldRefreshData(data: DiscoveredSupplierData): {\r\n  shouldRefresh: boolean;\r\n  reason: string;\r\n  priority: 'low' | 'medium' | 'high';\r\n} {\r\n  const freshnessScore = calculateFreshnessScore(data.discoveredAt);\r\n  const confidence = data.confidence.overall;\r\n\r\n  // High priority refresh conditions\r\n  if (confidence < 0.7 && freshnessScore < 0.8) {\r\n    return {\r\n      shouldRefresh: true,\r\n      reason: 'Low confidence data that is becoming stale',\r\n      priority: 'high'\r\n    };\r\n  }\r\n\r\n  // Medium priority refresh conditions\r\n  if (freshnessScore < 0.5) {\r\n    return {\r\n      shouldRefresh: true,\r\n      reason: 'Data is over a month old',\r\n      priority: 'medium'\r\n    };\r\n  }\r\n\r\n  if (confidence < 0.6) {\r\n    return {\r\n      shouldRefresh: true,\r\n      reason: 'Low confidence data should be refreshed',\r\n      priority: 'medium'\r\n    };\r\n  }\r\n\r\n  // Low priority refresh conditions\r\n  if (freshnessScore < 0.7 && confidence < 0.8) {\r\n    return {\r\n      shouldRefresh: true,\r\n      reason: 'Moderate age and confidence - refresh recommended',\r\n      priority: 'low'\r\n    };\r\n  }\r\n\r\n  return {\r\n    shouldRefresh: false,\r\n    reason: 'Data is fresh and reliable',\r\n    priority: 'low'\r\n  };\r\n}\r\n\r\n/**\r\n * Helper validation functions\r\n */\r\nfunction isValidEmail(email: string): boolean {\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  return emailRegex.test(email);\r\n}\r\n\r\nfunction isValidSAPhoneNumber(phone: string): boolean {\r\n  // SA phone number patterns\r\n  const patterns = [\r\n    /^\\+27[0-9]{9}$/,  // +27 followed by 9 digits\r\n    /^0[0-9]{9}$/,     // 0 followed by 9 digits\r\n    /^27[0-9]{9}$/     // 27 followed by 9 digits\r\n  ];\r\n\r\n  const cleaned = phone.replace(/[\\s\\-()]/g, '');\r\n  return patterns.some(pattern => pattern.test(cleaned));\r\n}\r\n\r\nfunction isValidWebsite(website: string): boolean {\r\n  try {\r\n    new URL(website);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction isValidSARegistrationNumber(regNumber: string): boolean {\r\n  // SA company registration format: YYYY/NNNNNN/NN\r\n  const pattern = /^[0-9]{4}\\/[0-9]{6}\\/[0-9]{2}$/;\r\n  return pattern.test(regNumber);\r\n}\r\n\r\nfunction isValidSAVATNumber(vatNumber: string): boolean {\r\n  // SA VAT number format: 4XXXXXXXXX (starts with 4, followed by 9 digits)\r\n  const pattern = /^4[0-9]{9}$/;\r\n  const cleaned = vatNumber.replace(/\\D/g, '');\r\n  return pattern.test(cleaned);\r\n}\r\n\r\n/**\r\n * Helper formatting functions\r\n */\r\nfunction formatCompanyName(name: string): string {\r\n  return name\r\n    .trim()\r\n    .replace(/\\s+/g, ' ')\r\n    .replace(/\\b(pty|ltd|inc|corp|llc|limited|proprietary)\\b\\.?/gi, match =>\r\n      match.charAt(0).toUpperCase() + match.slice(1).toLowerCase()\r\n    );\r\n}\r\n\r\nfunction formatPhoneNumber(phone: string): string {\r\n  if (!phone) return '';\r\n\r\n  const digits = phone.replace(/\\D/g, '');\r\n\r\n  if (digits.startsWith('27') && digits.length === 11) {\r\n    return '+' + digits;\r\n  }\r\n  if (digits.startsWith('0') && digits.length === 10) {\r\n    return '+27' + digits.substring(1);\r\n  }\r\n\r\n  return phone;\r\n}\r\n\r\nfunction formatWebsite(website: string): string {\r\n  if (!website) return '';\r\n\r\n  if (!website.startsWith('http')) {\r\n    return 'https://' + website.replace(/^\\/+/, '');\r\n  }\r\n\r\n  return website;\r\n}\r\n\r\nfunction formatAddress(address: SupplierAddress): SupplierAddress {\r\n  return {\r\n    street: address.street.trim(),\r\n    city: address.city.trim(),\r\n    province: address.province.trim(),\r\n    postalCode: address.postalCode.replace(/\\D/g, ''),\r\n    country: address.country.trim() || 'South Africa'\r\n  };\r\n}\r\n\r\nfunction formatRegistrationNumber(regNumber: string): string {\r\n  if (!regNumber) return '';\r\n\r\n  const cleaned = regNumber.replace(/[^\\d\\/]/g, '');\r\n\r\n  // Ensure proper format: YYYY/NNNNNN/NN\r\n  const match = cleaned.match(/^(\\d{4})\\/(\\d{6})\\/(\\d{2})$/);\r\n  if (match) {\r\n    return cleaned;\r\n  }\r\n\r\n  return regNumber;\r\n}\r\n\r\nfunction formatVATNumber(vatNumber: string): string {\r\n  if (!vatNumber) return '';\r\n\r\n  const digits = vatNumber.replace(/\\D/g, '');\r\n\r\n  if (digits.length === 10 && digits.startsWith('4')) {\r\n    return digits;\r\n  }\r\n\r\n  return vatNumber;\r\n}\r\n\r\n/**\r\n * Helper merge functions\r\n */\r\nfunction selectBestValue(dataSources: DiscoveredSupplierData[], path: string): string {\r\n  const values = dataSources\r\n    .map(data => getNestedValue(data, path))\r\n    .filter(value => value && value.trim().length > 0)\r\n    .map(value => ({ value, confidence: Math.random() })) // In real implementation, use actual confidence\r\n    .sort((a, b) => b.confidence - a.confidence);\r\n\r\n  return values.length > 0 ? values[0].value : '';\r\n}\r\n\r\nfunction getNestedValue(obj: any, path: string): string {\r\n  return path.split('.').reduce((current, key) => current?.[key], obj) || '';\r\n}\r\n\r\nfunction mergeAddresses(addresses: SupplierAddress[]): SupplierAddress {\r\n  const nonEmpty = addresses.filter(addr =>\r\n    addr.street || addr.city || addr.province || addr.postalCode\r\n  );\r\n\r\n  if (nonEmpty.length === 0) {\r\n    return { street: '', city: '', province: '', postalCode: '', country: 'South Africa' };\r\n  }\r\n\r\n  // Use the most complete address\r\n  const sorted = nonEmpty.sort((a, b) => {\r\n    const scoreA = [a.street, a.city, a.province, a.postalCode].filter(Boolean).length;\r\n    const scoreB = [b.street, b.city, b.province, b.postalCode].filter(Boolean).length;\r\n    return scoreB - scoreA;\r\n  });\r\n\r\n  return sorted[0];\r\n}\r\n\r\nfunction mergeContactInfo(contacts: SupplierContactInfo[]): SupplierContactInfo {\r\n  const merged: SupplierContactInfo = { phone: '', email: '', website: '' };\r\n\r\n  // Take first non-empty value for each field\r\n  merged.phone = contacts.find(c => c.phone)?.phone || '';\r\n  merged.email = contacts.find(c => c.email)?.email || '';\r\n  merged.website = contacts.find(c => c.website)?.website || '';\r\n\r\n  return merged;\r\n}\r\n\r\nfunction mergeArrays(arrays: string[][]): string[] {\r\n  const combined = arrays.flat();\r\n  return [...new Set(combined)]; // Remove duplicates\r\n}","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\services\\ai\\AIDataExtractionService.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":1086,"column":24,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":1086,"endColumn":25,"suggestions":[{"messageId":"removeEscape","fix":{"range":[44198,44199],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[44198,44198],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":1086,"column":49,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":1086,"endColumn":50,"suggestions":[{"messageId":"removeEscape","fix":{"range":[44223,44224],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[44223,44223],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":1086,"column":67,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":1086,"endColumn":68,"suggestions":[{"messageId":"removeEscape","fix":{"range":[44241,44242],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[44241,44241],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * AI-Powered Data Extraction Service\n * Uses Claude/OpenAI to intelligently extract structured supplier information from web content\n */\n\nimport { getAIConfig } from '@/lib/ai/config';\nimport { createAnthropic } from '@ai-sdk/anthropic';\nimport { createOpenAI } from '@ai-sdk/openai';\nimport { generateObject, generateText } from 'ai';\nimport { z } from 'zod';\n\nexport interface ExtractedSupplierData {\n  companyName?: string;\n  description?: string;\n  industry?: string;\n  location?: string;\n  contactEmail?: string;\n  contactPhone?: string;\n  contactPerson?: string;\n  website?: string;\n  employees?: string;\n  founded?: string;\n  socialMedia?: {\n    linkedin?: string;\n    twitter?: string;\n    facebook?: string;\n  };\n  certifications?: string[];\n  services?: string[];\n  products?: string[];\n  brands?: string[]; // Supplier brands - brands they carry/distribute\n  categories?: string[];\n  brandLinks?: {\n    name: string;\n    url?: string;\n  }[];\n  addresses?: {\n    type?: string;\n    street?: string;\n    city?: string;\n    country?: string;\n    postalCode?: string;\n    state?: string;\n  }[];\n  revenue?: string;\n  businessType?: string;\n  tags?: string[];\n  // Additional fields for comprehensive supplier data\n  taxId?: string;\n  registrationNumber?: string;\n  vatNumber?: string;\n  currency?: string;\n  paymentTerms?: string;\n  leadTime?: string;\n  minimumOrderValue?: string;\n}\n\n// Zod schema for structured data extraction - lenient to handle AI variations\n// Preprocess null values to undefined for optional fields\nconst SupplierDataSchema = z.object({\n  companyName: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  description: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  industry: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  location: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  contactEmail: z.preprocess((val) => val === null ? undefined : val, z.string().email().optional().or(z.literal(''))),\n  contactPhone: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  website: z.preprocess((val) => val === null ? undefined : val, z.string().optional().or(z.literal(''))),\n  employees: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  founded: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  socialMedia: z.preprocess(\n    (val) => {\n      if (val === null || val === undefined) return undefined;\n      if (typeof val === 'object' && !Array.isArray(val)) {\n        const record = val as Record<string, unknown>;\n        const normalizeLink = (input: unknown) => {\n          if (input === null || input === undefined) return undefined;\n          if (typeof input === 'string') return input;\n          return undefined;\n        };\n\n        return {\n          linkedin: normalizeLink(record.linkedin),\n          twitter: normalizeLink(record.twitter),\n          facebook: normalizeLink(record.facebook),\n        };\n      }\n      return val;\n    },\n    z.object({\n      linkedin: z.string().url().optional().or(z.literal('')),\n      twitter: z.string().url().optional().or(z.literal('')),\n      facebook: z.string().url().optional().or(z.literal('')),\n    }).optional()\n  ),\n  certifications: z\n    .preprocess(\n      (val) => {\n        if (val === undefined || val === null) return undefined;\n        if (typeof val === 'string') {\n          return val === '' ? [] : [val];\n        }\n        return val;\n      },\n      z.array(z.string()).optional()\n    ),\n  services: z.array(z.string()).optional(),\n  products: z.array(z.string()).optional(),\n  brands: z.array(z.string()).optional(),\n  categories: z.array(z.string()).optional(),\n  brandLinks: z\n    .array(\n      z.object({\n        name: z.string(),\n        url: z.string().optional(),\n      })\n    )\n    .optional(),\n  addresses: z\n    .array(\n      z.object({\n        type: z.string().optional().default('headquarters'),\n        street: z.string().optional(),\n        city: z.string().optional(),\n        country: z.string().optional(),\n        postalCode: z.string().optional(),\n        state: z.string().optional(),\n      })\n    )\n    .optional(),\n  revenue: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  businessType: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  tags: z.array(z.string()).optional(),\n  taxId: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  registrationNumber: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  vatNumber: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  currency: z.string().optional(),\n  paymentTerms: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  leadTime: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n  minimumOrderValue: z.preprocess((val) => val === null ? undefined : val, z.string().optional()),\n});\n\nexport class AIDataExtractionService {\n  private anthropicApiKey?: string;\n  private anthropicBaseUrl?: string;\n  private openaiApiKey?: string;\n  private openaiBaseUrl?: string;\n  private openaiModel?: string;\n  private provider: 'anthropic' | 'openai' = 'anthropic';\n\n  constructor(config?: { \n    anthropicApiKey?: string; \n    anthropicBaseUrl?: string;\n    openaiApiKey?: string;\n    openaiBaseUrl?: string;\n    openaiModel?: string;\n  }) {\n    // Initialize with provided config or environment variables\n    this.anthropicApiKey = config?.anthropicApiKey || process.env.ANTHROPIC_API_KEY;\n    this.anthropicBaseUrl = config?.anthropicBaseUrl;\n    this.openaiApiKey = config?.openaiApiKey || process.env.OPENAI_API_KEY;\n    this.openaiBaseUrl = config?.openaiBaseUrl;\n    // Trim model name to prevent \"model not found\" errors from whitespace\n    this.openaiModel = config?.openaiModel ? String(config.openaiModel).trim() : undefined;\n\n    // Determine which provider to use\n    if (this.anthropicApiKey) {\n      this.provider = 'anthropic';\n    } else if (this.openaiApiKey) {\n      this.provider = 'openai';\n    } else {\n      console.warn('⚠️ No AI API keys found. AI extraction will use fallback methods.');\n    }\n\n    console.log(`🤖 AIDataExtractionService initialized with provider: ${this.provider}${this.openaiBaseUrl ? ` (baseUrl: ${this.openaiBaseUrl})` : ''}`);\n  }\n\n  /**\n   * Extract supplier data from web content using AI\n   */\n  async extractSupplierData(content: {\n    url: string;\n    title: string;\n    description: string;\n    content?: string;\n    rawHtml?: string;\n  }): Promise<ExtractedSupplierData | null> {\n    try {\n      console.log(`🤖 Extracting supplier data using AI from: ${content.url}`);\n\n      // Prepare content for AI analysis\n      const textContent = this.prepareContentForAI(content);\n\n      // Use AI to extract structured data\n      if (this.provider === 'anthropic' && this.anthropicApiKey) {\n        return await this.extractWithAnthropic(textContent, content.url);\n      } else if (this.provider === 'openai' && this.openaiApiKey) {\n        return await this.extractWithOpenAI(textContent, content.url);\n      } else {\n        // Fallback to rule-based extraction if no AI available\n        console.log('⚠️ Using fallback extraction (no AI available)');\n        return this.extractWithFallback(content);\n      }\n    } catch (error) {\n      console.error('❌ AI extraction failed:', error);\n      // Return null on error - let the caller handle fallback logic\n      // This allows proper error tracking and prevents masking failures as successes\n      return null;\n    }\n  }\n\n  /**\n   * Extract using Anthropic Claude\n   */\n  private async extractWithAnthropic(\n    textContent: string,\n    url: string\n  ): Promise<ExtractedSupplierData | null> {\n    if (!this.anthropicApiKey) {\n      throw new Error('ANTHROPIC_API_KEY not configured');\n    }\n\n    const anthropic = createAnthropic({\n      apiKey: this.anthropicApiKey,\n    });\n\n    const model = anthropic('claude-3-5-sonnet-20241022');\n\n    const prompt = `You are an expert data extraction specialist. Extract structured supplier/company information from the following web content.\n\nURL: ${url}\n\nContent:\n${textContent.substring(0, 8000)} ${textContent.length > 8000 ? '...' : ''}\n\nExtract the following information if available:\n\nREQUIRED FIELDS (if found):\n- Company name (official business name)\n- Description (what the company does)\n- Industry (primary industry sector)\n- Location (city, country, or region)\n- Contact email (business email address - must be valid email format)\n- Contact phone (business phone number)\n- Website URL (must include full URL with https:// protocol)\n\nOPTIONAL FIELDS:\n- Employee count (number of employees as string, e.g., \"50-200\" or \"500\")\n- Founded year (year the company was established, as string)\n- Social media links (LinkedIn, Twitter, Facebook - must be full URLs)\n- Certifications (ISO, SOC, etc. - array of strings)\n- Services (list of services offered - array of strings)\n- Products (list of PRODUCTS/SERVICES offered - array of strings)\n  * Examples: \"Digital Distribution Platform\", \"Music Marketing Services\", \"CD Manufacturing\"\n  * These are WHAT the company sells/provides, not brand names\n\n- Brands (CRITICAL - EXTRACT ALL BRAND NAMES):\n  * Brand names are MANUFACTURER/DISTRIBUTOR names that the supplier carries\n  * Look for sections titled \"Brands\", \"Our Brands\", \"Brands We Carry\", \"Featured Brands\", or similar\n  * If you see a \"BRANDS PAGE CONTENT\" section, extract EVERY brand name listed there\n  * Brand names are typically capitalized manufacturer names (e.g., \"Yamaha\", \"Shure\", \"Pioneer DJ\", \"Gibson\", \"Epiphone\", \"audio-technica\", \"KRK SYSTEMS\", \"TANNOY\", \"MIDAS\", \"AEROBAND\", \"AlphaTheta\", \"Blackstar AMPLIFICATION\", \"dBTechnologies\", \"HK AUDIO\", \"KLARK TEKNIK\", \"Turbosound\", etc.)\n  * Extract brand names from logos, lists, grids, or any brand mentions\n  * This is DIFFERENT from products - brands are the manufacturer/distributor names, NOT the products/services\n  * DO NOT confuse products/services with brands - if it says \"Digital Distribution Platform\", that's a PRODUCT, not a brand\n  * Return as an array of strings, one brand name per string\n  * Example: [\"Yamaha\", \"Shure\", \"Pioneer DJ\", \"Gibson\", \"Epiphone\", \"audio-technica\", \"KRK SYSTEMS\", \"TANNOY\", \"Turbosound\", \"MIDAS\", \"AEROBAND\", \"AlphaTheta\"]\n- Addresses (CRITICAL - EXTRACT ALL PHYSICAL ADDRESSES):\n  * Look for \"Contact\", \"Address\", \"Location\", \"Find Us\", \"Visit Us\", \"Headquarters\", \"Office\", or footer sections\n  * Extract complete physical addresses including street address, city, state/province, postal code, and country\n  * Address type should be one of: \"headquarters\", \"billing\", \"shipping\", \"warehouse\", \"manufacturing\"\n  * If type is not specified, use \"headquarters\" for the first address\n  * Return as an array of objects with: type, street, city, country, postalCode, state\n  * Example: [{\"type\": \"headquarters\", \"street\": \"123 Main St\", \"city\": \"Cape Town\", \"state\": \"Western Cape\", \"postalCode\": \"8001\", \"country\": \"South Africa\"}]\n  * Extract ALL addresses found - headquarters, warehouses, offices, etc.\n- Revenue (if mentioned - as string)\n- Business type (LLC, Inc, Pty Ltd, etc.)\n- Tax ID / Registration Number / VAT Number (if mentioned)\n- Payment terms (if mentioned)\n- Currency (3-letter code like USD, ZAR, EUR)\n- Tags (relevant keywords/tags - array of strings)\n\nIMPORTANT FORMATTING RULES:\n1. Website URLs: Always include full URL with https:// (e.g., \"https://www.example.com\" not \"www.example.com\")\n2. Addresses: Each address MUST include a \"type\" field. Use \"headquarters\" if not specified.\n3. Email: Must be valid email format (user@domain.com)\n4. Social media: Must be full URLs (https://linkedin.com/...)\n5. Only extract information that is clearly present in the content. Do not infer or make up data.\n\nReturn ONLY the information that can be clearly identified in the content.`;\n\n    try {\n      // Try generateObject first (Claude models generally support JSON schema)\n      try {\n        // Reasoning models don't support temperature\n        const generateOptions: any = {\n          model,\n          schema: SupplierDataSchema,\n          prompt,\n        }\n        if (!this.isReasoningModel('claude-3-5-sonnet-20241022')) {\n          generateOptions.temperature = 0.1\n        }\n        \n        const result = await generateObject(generateOptions);\n\n        console.log('✅ AI extraction completed successfully');\n\n        // Post-process and normalize the extracted data\n        return this.postProcessExtractedData(result.object, url);\n      } catch (schemaError: any) {\n        // Fallback to generateText with JSON mode if JSON schema fails\n        // (defensive programming - Claude models should support JSON schema, but handle edge cases)\n        if (\n          schemaError?.message?.includes('json_schema') ||\n          schemaError?.message?.includes('structured') ||\n          schemaError?.responseBody?.includes('json_schema')\n        ) {\n          console.warn(`⚠️ Anthropic model doesn't support JSON schema, using JSON mode fallback`);\n          \n          // Use generateText with JSON mode\n          const jsonPrompt = `${prompt}\n\nIMPORTANT: You must respond with ONLY valid JSON matching this exact schema:\n{\n  \"companyName\": \"string or omit\",\n  \"description\": \"string or omit\",\n  \"industry\": \"string or omit\",\n  \"location\": \"string or omit\",\n  \"contactEmail\": \"valid email or omit\",\n  \"contactPhone\": \"string or omit\",\n  \"website\": \"full URL with https:// or omit\",\n  \"employees\": \"string or omit\",\n  \"founded\": \"string or omit\",\n  \"socialMedia\": {\n    \"linkedin\": \"full URL or omit\",\n    \"twitter\": \"full URL or omit\",\n    \"facebook\": \"full URL or omit\"\n  } or omit,\n  \"certifications\": [\"string\"] or omit,\n  \"services\": [\"string\"] or omit,\n  \"products\": [\"string\"] or omit,\n  \"brands\": [\"string\"] or omit,\n  \"categories\": [\"string\"] or omit,\n  \"brandLinks\": [{\"name\": \"string\", \"url\": \"string or omit\"}] or omit,\n  \"addresses\": [{\"type\": \"string\", \"street\": \"string\", \"city\": \"string\", \"country\": \"string\", \"postalCode\": \"string\", \"state\": \"string\"}] or omit,\n  \"revenue\": \"string or omit\",\n  \"businessType\": \"string or omit\",\n  \"tags\": [\"string\"] or omit,\n  \"taxId\": \"string or omit\",\n  \"registrationNumber\": \"string or omit\",\n  \"vatNumber\": \"string or omit\",\n  \"currency\": \"string or omit\",\n  \"paymentTerms\": \"string or omit\",\n  \"leadTime\": \"string or omit\",\n  \"minimumOrderValue\": \"string or omit\"\n}\n\nReturn ONLY the JSON object, no other text.`;\n\n            const textOptions: any = {\n              model,\n              prompt: jsonPrompt,\n            }\n            if (!this.isReasoningModel('claude-3-5-sonnet-20241022')) {\n              textOptions.temperature = 0.1\n            }\n            \n            const textResult = await generateText(textOptions);\n\n          // Parse the JSON response\n          const jsonMatch = textResult.text.match(/\\{[\\s\\S]*\\}/);\n          if (!jsonMatch) {\n            throw new Error('No JSON found in AI response');\n          }\n\n          const parsedData = JSON.parse(jsonMatch[0]);\n          \n          // Validate against schema\n          const validatedData = SupplierDataSchema.parse(parsedData);\n\n          console.log('✅ AI extraction completed successfully (JSON mode fallback)');\n\n          // Post-process and normalize the extracted data\n          return this.postProcessExtractedData(validatedData, url);\n        }\n        \n        // Re-throw if it's a different error\n        throw schemaError;\n      }\n    } catch (error) {\n      console.error('❌ Anthropic extraction error:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Check if a model is a reasoning model (doesn't support temperature)\n   */\n  private isReasoningModel(modelName: string): boolean {\n    if (!modelName) return false\n    const normalized = modelName.trim().toLowerCase()\n    return /^o1(-|$)/i.test(normalized) || /^o3(-|$)/i.test(normalized)\n  }\n\n  /**\n   * Check if a model supports JSON schema (structured outputs)\n   */\n  private supportsJsonSchema(modelName: string): boolean {\n    if (!modelName) return false;\n    \n    // Models that don't support JSON schema format\n    // These are \"responses\" models that only support specific output formats\n    // Note: gpt-5-nano DOES support JSON schema, so it's not included here\n    const unsupportedPatterns = [\n      /gpt-5-mini/i,  // gpt-5-mini doesn't support JSON schema\n      /gpt-5-chat/i,   // gpt-5-chat variants don't support JSON schema\n      /^o1(-|$)/i,     // o1, o1-mini, o1-preview, etc. (reasoning models)\n      /^o3(-|$)/i,     // o3, o3-mini, etc. (reasoning models)\n    ];\n    \n    // Check if model name matches any unsupported pattern\n    const normalizedModel = modelName.trim();\n    return !unsupportedPatterns.some(pattern => pattern.test(normalizedModel));\n  }\n\n  /**\n   * Get a fallback model that supports JSON schema\n   */\n  private getCompatibleModel(requestedModel?: string): string {\n    if (!requestedModel) {\n      return 'gpt-4o-mini';\n    }\n    \n    const trimmedModel = requestedModel.trim();\n    \n    // If requested model supports JSON schema, use it\n    if (this.supportsJsonSchema(trimmedModel)) {\n      return trimmedModel;\n    }\n    \n    // Fallback to models that definitely support JSON schema\n    return 'gpt-4o-mini';\n  }\n\n  /**\n   * Extract using OpenAI GPT (or OpenAI-compatible API like OpenRouter)\n   */\n  private async extractWithOpenAI(\n    textContent: string,\n    url: string\n  ): Promise<ExtractedSupplierData | null> {\n    if (!this.openaiApiKey) {\n      throw new Error('OPENAI_API_KEY not configured');\n    }\n\n    const openai = createOpenAI({\n      apiKey: this.openaiApiKey,\n      ...(this.openaiBaseUrl ? { baseURL: this.openaiBaseUrl } : {}),\n    });\n\n    const requestedModel = this.openaiModel || 'gpt-4o-mini';\n    const modelName = this.getCompatibleModel(requestedModel);\n    \n    // Log if we're using a fallback model\n    if (requestedModel !== modelName) {\n      console.warn(`⚠️ Model ${requestedModel} doesn't support JSON schema, falling back to ${modelName}`);\n    }\n    \n    // Model name is already trimmed in constructor and getCompatibleModel, but double-check\n    const model = openai(modelName.trim());\n\n    const prompt = `You are an expert data extraction specialist. Extract structured supplier/company information from the following web content.\n\nURL: ${url}\n\nContent:\n${textContent.substring(0, 8000)} ${textContent.length > 8000 ? '...' : ''}\n\nExtract the following information if available:\n\nREQUIRED FIELDS (if found):\n- Company name (official business name)\n- Description (what the company does)\n- Industry (primary industry sector)\n- Location (city, country, or region)\n- Contact email (business email address - must be valid email format)\n- Contact phone (business phone number)\n- Website URL (must include full URL with https:// protocol)\n\nOPTIONAL FIELDS:\n- Employee count (number of employees as string, e.g., \"50-200\" or \"500\")\n- Founded year (year the company was established, as string)\n- Social media links (LinkedIn, Twitter, Facebook - must be full URLs)\n- Certifications (ISO, SOC, etc. - array of strings)\n- Services (list of services offered - array of strings)\n- Products (list of PRODUCTS/SERVICES offered - array of strings)\n  * Examples: \"Digital Distribution Platform\", \"Music Marketing Services\", \"CD Manufacturing\"\n  * These are WHAT the company sells/provides, not brand names\n\n- Brands (CRITICAL - EXTRACT ALL BRAND NAMES):\n  * Brand names are MANUFACTURER/DISTRIBUTOR names that the supplier carries\n  * Look for sections titled \"Brands\", \"Our Brands\", \"Brands We Carry\", \"Featured Brands\", or similar\n  * If you see a \"BRANDS PAGE CONTENT\" section, extract EVERY brand name listed there\n  * Brand names are typically capitalized manufacturer names (e.g., \"Yamaha\", \"Shure\", \"Pioneer DJ\", \"Gibson\", \"Epiphone\", \"audio-technica\", \"KRK SYSTEMS\", \"TANNOY\", \"MIDAS\", \"AEROBAND\", \"AlphaTheta\", \"Blackstar AMPLIFICATION\", \"dBTechnologies\", \"HK AUDIO\", \"KLARK TEKNIK\", \"Turbosound\", etc.)\n  * Extract brand names from logos, lists, grids, or any brand mentions\n  * This is DIFFERENT from products - brands are the manufacturer/distributor names, NOT the products/services\n  * DO NOT confuse products/services with brands - if it says \"Digital Distribution Platform\", that's a PRODUCT, not a brand\n  * Return as an array of strings, one brand name per string\n  * Example: [\"Yamaha\", \"Shure\", \"Pioneer DJ\", \"Gibson\", \"Epiphone\", \"audio-technica\", \"KRK SYSTEMS\", \"TANNOY\", \"Turbosound\", \"MIDAS\", \"AEROBAND\", \"AlphaTheta\"]\n- Addresses (CRITICAL - EXTRACT ALL PHYSICAL ADDRESSES):\n  * Look for \"Contact\", \"Address\", \"Location\", \"Find Us\", \"Visit Us\", \"Headquarters\", \"Office\", or footer sections\n  * Extract complete physical addresses including street address, city, state/province, postal code, and country\n  * Address type should be one of: \"headquarters\", \"billing\", \"shipping\", \"warehouse\", \"manufacturing\"\n  * If type is not specified, use \"headquarters\" for the first address\n  * Return as an array of objects with: type, street, city, country, postalCode, state\n  * Example: [{\"type\": \"headquarters\", \"street\": \"123 Main St\", \"city\": \"Cape Town\", \"state\": \"Western Cape\", \"postalCode\": \"8001\", \"country\": \"South Africa\"}]\n  * Extract ALL addresses found - headquarters, warehouses, offices, etc.\n- Revenue (if mentioned - as string)\n- Business type (LLC, Inc, Pty Ltd, etc.)\n- Tax ID / Registration Number / VAT Number (if mentioned)\n- Payment terms (if mentioned)\n- Currency (3-letter code like USD, ZAR, EUR)\n- Tags (relevant keywords/tags - array of strings)\n\nIMPORTANT FORMATTING RULES:\n1. Website URLs: Always include full URL with https:// (e.g., \"https://www.example.com\" not \"www.example.com\")\n2. Addresses: Each address MUST include a \"type\" field. Use \"headquarters\" if not specified.\n3. Email: Must be valid email format (user@domain.com)\n4. Social media: Must be full URLs (https://linkedin.com/...)\n5. Only extract information that is clearly present in the content. Do not infer or make up data.\n\nReturn ONLY the information that can be clearly identified in the content.`;\n\n    try {\n      // Try generateObject first (requires JSON schema support)\n      try {\n        // Reasoning models don't support temperature\n        const generateOptions: any = {\n          model,\n          schema: SupplierDataSchema,\n          prompt,\n        }\n        if (!this.isReasoningModel(modelName)) {\n          generateOptions.temperature = 0.1\n        }\n        \n        const result = await generateObject(generateOptions);\n\n        console.log('✅ AI extraction completed successfully');\n\n        // Post-process and normalize the extracted data\n        return this.postProcessExtractedData(result.object, url);\n      } catch (schemaError: any) {\n        // Check if it's a rate limit error - don't retry, return null so other provider can try\n        // Handle both direct rate limit errors and retry errors that contain rate limit errors\n        const isRateLimitError = \n          schemaError?.statusCode === 429 ||\n          schemaError?.lastError?.statusCode === 429 ||\n          schemaError?.message?.includes('Rate limit') ||\n          schemaError?.message?.includes('rate limit') ||\n          schemaError?.lastError?.message?.includes('Rate limit') ||\n          schemaError?.lastError?.message?.includes('rate limit') ||\n          schemaError?.responseBody?.includes('Rate limit') ||\n          schemaError?.responseBody?.includes('rate limit') ||\n          schemaError?.lastError?.responseBody?.includes('Rate limit') ||\n          schemaError?.lastError?.responseBody?.includes('rate limit');\n        \n        if (isRateLimitError) {\n          const errorSource = schemaError?.lastError || schemaError;\n          const resetTime = errorSource?.responseHeaders?.['x-ratelimit-reset'];\n          const resetDate = resetTime ? new Date(parseInt(resetTime)).toISOString() : 'unknown';\n          console.warn(`⚠️ Rate limit exceeded for model ${modelName}. Reset at: ${resetDate}. Skipping this provider.`);\n          // Return null to allow other provider to handle the request\n          return null;\n        }\n        \n        // Check if it's a model not found error - fallback to compatible model\n        if (\n          schemaError?.message?.includes('model_not_found') ||\n          schemaError?.message?.includes('does not exist') ||\n          schemaError?.responseBody?.includes('model_not_found')\n        ) {\n          console.warn(`⚠️ Model ${modelName} not found, falling back to gpt-4o-mini`);\n          \n          // Try with fallback model\n          const fallbackModel = openai('gpt-4o-mini');\n          try {\n            const fallbackOptions: any = {\n              model: fallbackModel,\n              schema: SupplierDataSchema,\n              prompt,\n            }\n            if (!this.isReasoningModel('gpt-4o-mini')) {\n              fallbackOptions.temperature = 0.1\n            }\n            \n            const result = await generateObject(fallbackOptions);\n            \n            console.log('✅ AI extraction completed successfully (fallback model)');\n            return this.postProcessExtractedData(result.object, url);\n          } catch (fallbackError) {\n            // If fallback also fails, try JSON mode\n            console.warn(`⚠️ Fallback model also failed, using JSON mode`);\n            throw schemaError; // Re-throw to trigger JSON mode fallback\n          }\n        }\n        \n        // If JSON schema is not supported, fall back to generateText with JSON mode\n        if (\n          schemaError?.message?.includes('json_schema') ||\n          schemaError?.message?.includes('text.format') ||\n          schemaError?.responseBody?.includes('json_schema')\n        ) {\n          console.warn(`⚠️ Model ${modelName} doesn't support JSON schema, using JSON mode fallback`);\n          \n          // Use generateText with JSON mode\n          const jsonPrompt = `${prompt}\n\nIMPORTANT: You must respond with ONLY valid JSON matching this exact schema:\n{\n  \"companyName\": \"string or omit\",\n  \"description\": \"string or omit\",\n  \"industry\": \"string or omit\",\n  \"location\": \"string or omit\",\n  \"contactEmail\": \"valid email or omit\",\n  \"contactPhone\": \"string or omit\",\n  \"website\": \"full URL with https:// or omit\",\n  \"employees\": \"string or omit\",\n  \"founded\": \"string or omit\",\n  \"socialMedia\": {\n    \"linkedin\": \"full URL or omit\",\n    \"twitter\": \"full URL or omit\",\n    \"facebook\": \"full URL or omit\"\n  } or omit,\n  \"certifications\": [\"string\"] or omit,\n  \"services\": [\"string\"] or omit,\n  \"products\": [\"string\"] or omit,\n  \"brands\": [\"string\"] or omit,\n  \"categories\": [\"string\"] or omit,\n  \"brandLinks\": [{\"name\": \"string\", \"url\": \"string or omit\"}] or omit,\n  \"addresses\": [{\"type\": \"string\", \"street\": \"string\", \"city\": \"string\", \"country\": \"string\", \"postalCode\": \"string\", \"state\": \"string\"}] or omit,\n  \"revenue\": \"string or omit\",\n  \"businessType\": \"string or omit\",\n  \"tags\": [\"string\"] or omit,\n  \"taxId\": \"string or omit\",\n  \"registrationNumber\": \"string or omit\",\n  \"vatNumber\": \"string or omit\",\n  \"currency\": \"string or omit\",\n  \"paymentTerms\": \"string or omit\",\n  \"leadTime\": \"string or omit\",\n  \"minimumOrderValue\": \"string or omit\"\n}\n\nReturn ONLY the JSON object, no other text.`;\n\n          // Try with fallback model if original failed\n          const textModel = modelName.includes('gpt-5-nano') || modelName.includes('gpt-5-mini') \n            ? openai('gpt-4o-mini') \n            : model;\n          \n          const textOptions: any = {\n            model: textModel,\n            prompt: jsonPrompt,\n          }\n          if (!this.isReasoningModel(modelName)) {\n            textOptions.temperature = 0.1\n          }\n          \n          const textResult = await generateText(textOptions);\n\n          // Parse the JSON response\n          const jsonMatch = textResult.text.match(/\\{[\\s\\S]*\\}/);\n          if (!jsonMatch) {\n            throw new Error('No JSON found in AI response');\n          }\n\n          const parsedData = JSON.parse(jsonMatch[0]);\n          \n          // Validate against schema\n          const validatedData = SupplierDataSchema.parse(parsedData);\n\n          console.log('✅ AI extraction completed successfully (JSON mode fallback)');\n\n          // Post-process and normalize the extracted data\n          return this.postProcessExtractedData(validatedData, url);\n        }\n        \n        // Re-throw if it's a different error\n        throw schemaError;\n      }\n    } catch (error) {\n      console.error('❌ OpenAI extraction error:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Post-process extracted data to fix common issues and ensure completeness\n   */\n  private postProcessExtractedData(data: any, sourceUrl: string): ExtractedSupplierData {\n    const processed: ExtractedSupplierData = { ...data };\n\n    // Normalize website URL\n    if (processed.website) {\n      processed.website = this.normalizeUrl(processed.website);\n    } else if (sourceUrl) {\n      // Use source URL if website not provided\n      processed.website = this.normalizeUrl(sourceUrl);\n    }\n\n    // Ensure addresses have required fields and validate they're actual addresses\n    if (processed.addresses && processed.addresses.length > 0) {\n      processed.addresses = processed.addresses\n        .map((addr: any, index: number) => ({\n          type: addr.type || (index === 0 ? 'headquarters' : 'shipping'),\n          street: addr.street || addr.addressLine1 || '',\n          city: addr.city || '',\n          country:\n            addr.country ||\n            processed.location?.split(',')[processed.location.split(',').length - 1]?.trim() ||\n            '',\n          postalCode: addr.postalCode || addr.postal_code || '',\n          state: addr.state || addr.province || '',\n        }))\n        .filter((addr: any) => {\n          // Remove empty addresses\n          if (!addr.street && !addr.city) return false;\n          \n          // Validate that street field contains actual address data, not brand/product info\n          if (addr.street) {\n            // Reject if it contains brand/product keywords (these are NOT addresses)\n            const invalidPatterns = [\n              /^(enova|gibson|db technologies|pioneer|hpw|flx)/i, // Brand names at start\n              /\\b(reliable connection|iconic guitar|loud speakers|sub-woofers|column-array|controllers|view product|check out|explore)\\b/i, // Product descriptions\n              /\\b(product|products|range|brand|brands|systems|applications|technology)\\b/i, // Generic product words\n              />>/g, // HTML/UI elements\n              /\\b(explore|check out|view)\\b/i, // Action words from product pages\n            ];\n            \n            if (invalidPatterns.some(pattern => pattern.test(addr.street))) {\n              console.warn(`⚠️ Rejected invalid address street (contains brand/product info): \"${addr.street.substring(0, 100)}\"`);\n              return false;\n            }\n            \n            // Address should contain at least one of: street number, address keyword, or be a valid city name\n            const hasStreetNumber = /\\d+/.test(addr.street);\n            const hasAddressKeyword = /\\b(street|st|avenue|ave|road|rd|drive|dr|court|ct|boulevard|blvd|way|lane|ln|place|pl|parkway|pkwy)\\b/i.test(addr.street);\n            const isLikelyAddress = hasStreetNumber || hasAddressKeyword || addr.street.length < 50;\n            \n            // If street is very long and doesn't look like an address, reject it\n            if (addr.street.length > 100 && !hasStreetNumber && !hasAddressKeyword) {\n              console.warn(`⚠️ Rejected invalid address street (too long, doesn't look like address): \"${addr.street.substring(0, 100)}\"`);\n              return false;\n            }\n            \n            if (!isLikelyAddress && addr.street.length > 50) {\n              console.warn(`⚠️ Rejected invalid address street (doesn't match address patterns): \"${addr.street.substring(0, 100)}\"`);\n              return false;\n            }\n          }\n          \n          return true;\n        });\n    } else if (processed.location) {\n      // Create address from location if no addresses provided\n      const locationParts = processed.location.split(',').map((p: string) => p.trim());\n      processed.addresses = [\n        {\n          type: 'headquarters',\n          street: '',\n          city: locationParts[0] || '',\n          country: locationParts[locationParts.length - 1] || '',\n          postalCode: '',\n        },\n      ];\n    }\n\n    // Normalize social media URLs\n    if (processed.socialMedia) {\n      Object.keys(processed.socialMedia).forEach(key => {\n        const url = processed.socialMedia![key as keyof typeof processed.socialMedia];\n        if (url && url !== '') {\n          processed.socialMedia![key as keyof typeof processed.socialMedia] = this.normalizeUrl(\n            url\n          ) as any;\n        }\n      });\n    }\n\n    // Ensure email is valid\n    if (processed.contactEmail && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(processed.contactEmail)) {\n      delete processed.contactEmail;\n    }\n\n    // Clean up empty arrays\n    if (processed.services && processed.services.length === 0) delete processed.services;\n    if (processed.products && processed.products.length === 0) delete processed.products;\n    if (processed.certifications && processed.certifications.length === 0)\n      delete processed.certifications;\n    if (processed.tags && processed.tags.length === 0) delete processed.tags;\n\n    // Post-process brands to filter out products/services that were incorrectly extracted\n    if (processed.brands && processed.brands.length > 0) {\n      // Filter out common product/service patterns - these are NOT brands\n      const productServicePatterns = [\n        /platform/i,\n        /service/i,\n        /product/i,\n        /solution/i,\n        /system/i,\n        /software/i,\n        /application/i,\n        /digital distribution/i,\n        /physical.*distribution/i,\n        /marketing.*service/i,\n        /development.*program/i,\n        /management/i,\n        /optimization/i,\n        /publishing/i,\n        /royalty/i,\n        /streaming/i,\n      ];\n      \n      // Filter out UI elements, button names, and image names\n      const uiElementPatterns = [\n        /^(site|page|web|button|link|menu|nav|header|footer|sidebar)/i,\n        /(site|page|web|button|link|menu|nav|header|footer|sidebar)\\s+\\d+/i,\n        /button\\s*\\d+/i,\n        /site\\s+button/i,\n        /page\\s+button/i,\n        /subscribe/i,\n        /newsletter/i,\n        /magazine/i,\n        /image\\s+\\d+/i,\n        /whatsapp\\s+image/i,\n        /logo\\s+\\d+/i,\n        /asset\\s+\\d+/i,\n        /^\\d+\\s*$/,\n        /^[a-z]+\\s+\\d+$/i, // Simple pattern like \"button 01\"\n        /front$/i, // Image descriptions like \"Front\"\n        /back$/i,\n        /top$/i,\n        /side$/i,\n      ];\n\n      // Filter out product model numbers and product descriptions\n      const productModelPatterns = [\n        /\\b(hpw|xdj|grv|at-|lt-|mk\\d+|series|pack|replacement|stylus|groovebox|pedal|bass pack)\\b/i, // Product model prefixes and types\n        /\\b\\d{3,}\\b/, // 3+ digit numbers (model numbers)\n        /[a-z]+\\d{2,}[a-z]*/i, // Alphanumeric model codes like \"hpw1000\", \"xdj az\", \"grv6\"\n        /[a-z]+-\\d+/i, // Model codes like \"AT-VMN40xML\"\n        /\\b(replacement|stylus|pedal|pack|groovebox|track|front|back|top|side)\\b/i, // Product type words\n        /\\b(from|to|the|of|and|or)\\b/i, // Common words in product descriptions\n        /\\b\\d+\\s*(track|channel|series|mk|model)\\b/i, // Number + product type\n        /\\b[A-Z]{2,}-\\w+\\d+\\w*\\b/i, // Model codes like \"AT-VMN40xML\", \"LT-DUAL\"\n      ];\n\n      // Filter out magazine/blog/article names (dates, months, years)\n      const magazinePatterns = [\n        /\\b(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\\s+\\d{4}/i, // Dates like \"apr 2025\"\n        /\\d{4}\\s+(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i, // Dates like \"2025 apr\"\n        /\\b(soundpress|musicgear|magazine|blog|article|musical-instruments)\\b/i,\n        /-\\d{4}$/i, // Ends with year like \"-2025\"\n        /\\b(subscribe|subsribe)\\b/i, // Subscribe typos\n      ];\n\n      const originalCount = processed.brands.length;\n      const filteredBrands = processed.brands.filter(brand => {\n        const brandTrimmed = brand.trim();\n        const brandLower = brandTrimmed.toLowerCase();\n        \n        // Basic validation\n        if (brandTrimmed.length < 2 || brandTrimmed.length > 40) {\n          console.log(`🚫 Filtered out brand (length): \"${brand}\"`);\n          return false;\n        }\n        \n        if (!brandTrimmed.match(/[a-z]/i)) {\n          console.log(`🚫 Filtered out brand (no letters): \"${brand}\"`);\n          return false;\n        }\n        \n        if (/^\\d+$/.test(brandTrimmed)) {\n          console.log(`🚫 Filtered out brand (only numbers): \"${brand}\"`);\n          return false;\n        }\n\n        // Check product/service patterns\n        const isProduct = productServicePatterns.some(pattern => pattern.test(brandLower));\n        if (isProduct) {\n          console.log(`🚫 Filtered out product/service from brands: \"${brand}\"`);\n          return false;\n        }\n\n        // Check UI element patterns\n        const isUIElement = uiElementPatterns.some(pattern => pattern.test(brandLower));\n        if (isUIElement) {\n          console.log(`🚫 Filtered out UI element from brands: \"${brand}\"`);\n          return false;\n        }\n\n        // Check product model patterns\n        const isProductModel = productModelPatterns.some(pattern => pattern.test(brandTrimmed));\n        if (isProductModel) {\n          console.log(`🚫 Filtered out product model from brands: \"${brand}\"`);\n          return false;\n        }\n\n        // Check magazine/blog patterns\n        const isMagazine = magazinePatterns.some(pattern => pattern.test(brandLower));\n        if (isMagazine) {\n          console.log(`🚫 Filtered out magazine/blog from brands: \"${brand}\"`);\n          return false;\n        }\n\n        // Filter out items that look like product descriptions (too many words, contains dashes with model numbers)\n        const wordCount = brandTrimmed.split(/\\s+/).length;\n        if (wordCount > 3) { // Reduced from 4 to catch more product descriptions\n          console.log(`🚫 Filtered out brand (too many words): \"${brand}\"`);\n          return false;\n        }\n\n        // Filter out items with model-number-like patterns (e.g., \"Audio-Technica AT-VMN40xML\")\n        if (/\\b[A-Z]{2,}-\\w+\\d+\\w*\\b/i.test(brandTrimmed)) {\n          console.log(`🚫 Filtered out brand (contains model number): \"${brand}\"`);\n          return false;\n        }\n\n        // Filter out items that contain product model numbers anywhere\n        if (/[a-z]+\\d{3,}/i.test(brandTrimmed) || /\\d{3,}[a-z]*/i.test(brandTrimmed)) {\n          console.log(`🚫 Filtered out brand (contains model number): \"${brand}\"`);\n          return false;\n        }\n\n        // Filter out items that start with lowercase (likely product names or descriptions)\n        if (brandTrimmed.match(/^[a-z]/) && wordCount > 1) {\n          // Allow single-word lowercase brands, but filter multi-word lowercase items\n          console.log(`🚫 Filtered out brand (lowercase multi-word): \"${brand}\"`);\n          return false;\n        }\n\n        return true;\n      });\n\n      // Deduplicate and normalize brands\n      const brandMap = new Map<string, string>();\n      filteredBrands.forEach(brand => {\n        // Normalize: lowercase, remove extra spaces, remove special chars for comparison\n        const normalized = brand\n          .toLowerCase()\n          .replace(/[\\s\\u00A0\\u200B-\\u200D\\uFEFF\\-_™®©]+/g, '')\n          .trim();\n        \n        // Check if we already have this brand (case-insensitive, ignoring special chars and spaces)\n        const existing = brandMap.get(normalized);\n\n        if (!existing) {\n          // First time seeing this brand\n          brandMap.set(normalized, brand);\n        } else {\n          // Prefer the version with proper capitalization and hyphens\n          const currentNormalized = brand.toLowerCase().replace(/[\\s\\-_]/g, '');\n          const existingNormalized = existing.toLowerCase().replace(/[\\s\\-_]/g, '');\n          if (currentNormalized === existingNormalized) {\n            // Prefer version with proper capitalization (starts with capital)\n            if (brand.match(/^[A-Z]/) && !existing.match(/^[A-Z]/)) {\n              brandMap.set(normalized, brand);\n            }\n            // Prefer version with hyphens over spaces (e.g., \"Audio-Technica\" over \"Audio Technica\")\n            else if (brand.includes('-') && !existing.includes('-') && brand.match(/^[A-Z]/)) {\n              brandMap.set(normalized, brand);\n            }\n            // Prefer version without spaces if both have same capitalization (e.g., \"KlarkTeknik\" over \"Klark Teknik\")\n            else if (!brand.includes(' ') && existing.includes(' ') && brand.match(/^[A-Z]/)) {\n              brandMap.set(normalized, brand);\n            }\n          }\n        }\n      });\n\n      processed.brands = Array.from(brandMap.values()).sort();\n\n      if (originalCount !== processed.brands.length) {\n        console.log(\n          `🔍 Filtered brands: ${originalCount} → ${processed.brands.length} (removed ${originalCount - processed.brands.length} products/services/duplicates)`\n        );\n      }\n    }\n\n    if (processed.categories && processed.categories.length > 0) {\n      const normalizedCategories = new Map<string, string>();\n      processed.categories.forEach(category => {\n        const cleaned = category.replace(/[\\s\\u00A0\\u200B-\\u200D\\uFEFF]+/g, ' ').trim();\n        if (!cleaned) return;\n        const key = cleaned.toLowerCase();\n        if (!normalizedCategories.has(key)) {\n          normalizedCategories.set(key, cleaned.charAt(0).toUpperCase() + cleaned.slice(1));\n        }\n      });\n      processed.categories = Array.from(normalizedCategories.values()).slice(0, 50);\n    }\n\n    // Generate tags if not provided\n    if (!processed.tags || processed.tags.length === 0) {\n      processed.tags = this.generateTags(processed);\n    }\n\n    return processed;\n  }\n\n  /**\n   * Normalize URL to ensure it has protocol\n   */\n  private normalizeUrl(url: string): string {\n    if (!url || url === '') return '';\n\n    // Remove whitespace\n    url = url.trim();\n\n    // If it's already a full URL, return as is\n    if (url.startsWith('http://') || url.startsWith('https://')) {\n      return url;\n    }\n\n    // If it starts with www., add https://\n    if (url.startsWith('www.')) {\n      return `https://${url}`;\n    }\n\n    // If it looks like a domain, add https://\n    if (url.includes('.') && !url.includes(' ')) {\n      return `https://${url}`;\n    }\n\n    return url;\n  }\n\n  /**\n   * Generate tags from extracted data\n   */\n  private generateTags(data: ExtractedSupplierData): string[] {\n    const tags: string[] = [];\n\n    if (data.industry) {\n      tags.push(data.industry.toLowerCase());\n    }\n\n    if (data.services) {\n      tags.push(...data.services.slice(0, 3).map(s => s.toLowerCase().substring(0, 20)));\n    }\n\n    if (data.location) {\n      const locationParts = data.location.split(',').map(p => p.trim().toLowerCase());\n      tags.push(...locationParts.slice(0, 2));\n    }\n\n    return [...new Set(tags)].slice(0, 10);\n  }\n\n  /**\n   * Fallback extraction using rule-based methods\n   */\n  private extractWithFallback(content: {\n    url: string;\n    title: string;\n    description: string;\n    content?: string;\n    rawHtml?: string;\n  }): ExtractedSupplierData {\n    const fullText =\n      `${content.title} ${content.description} ${content.content || ''}`.toLowerCase();\n\n    const data: ExtractedSupplierData = {\n      companyName: this.extractCompanyName(content.title),\n      description: content.description,\n      website: content.url,\n    };\n\n    // Extract email\n    const emailMatch = fullText.match(/\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b/i);\n    if (emailMatch) {\n      data.contactEmail = emailMatch[0];\n    }\n\n    // Extract phone\n    const phoneMatch = fullText.match(\n      /(\\+?\\d{1,4}[\\s\\-\\.]?)?(\\(?\\d{2,4}\\)?[\\s\\-\\.]?)?\\d{3,4}[\\s\\-\\.]?\\d{4}/\n    );\n    if (phoneMatch) {\n      data.contactPhone = phoneMatch[0];\n    }\n\n    // Extract industry keywords\n    const industries = [\n      'technology',\n      'manufacturing',\n      'healthcare',\n      'finance',\n      'music',\n      'entertainment',\n    ];\n    for (const industry of industries) {\n      if (fullText.includes(industry)) {\n        data.industry = industry.charAt(0).toUpperCase() + industry.slice(1);\n        break;\n      }\n    }\n\n    return data;\n  }\n\n  /**\n   * Prepare content for AI analysis\n   */\n  private prepareContentForAI(content: {\n    url: string;\n    title: string;\n    description: string;\n    content?: string;\n    rawHtml?: string;\n  }): string {\n    let textContent = `Title: ${content.title}\\n\\n`;\n    textContent += `Description: ${content.description}\\n\\n`;\n\n    // PRIORITY: Extract brands section from HTML first\n    if (content.rawHtml) {\n      // Look for brands page links and extract brands from there\n      const brandsLinkPattern = /href=[\"']([^\"']*\\/brands?[^\"']*)[\"']/gi;\n      const brandsLinks = [...content.rawHtml.matchAll(brandsLinkPattern)].map(m => m[1]);\n\n      // Also look for brands sections directly in HTML\n      const brandsPattern =\n        /(?:<section[^>]*>|<div[^>]*>|<ul[^>]*>|<ol[^>]*>|<nav[^>]*>).*?(?:brands?|Brands?|BRANDS?|our brands|Our Brands|brands we carry|Brands We Carry|featured brands|Featured Brands)[^<]*(?:<\\/section>|<\\/div>|<\\/ul>|<\\/ol>|<\\/nav>)/gis;\n      const brandsMatches = content.rawHtml.match(brandsPattern);\n\n      if (brandsMatches && brandsMatches.length > 0) {\n        const brandsText = this.extractTextFromHtml(brandsMatches.join('\\n'));\n        textContent += `\\n=== BRANDS SECTION (HIGH PRIORITY - EXTRACT ALL BRAND NAMES FROM HERE) ===\\n${brandsText}\\n=== END BRANDS SECTION ===\\n\\n`;\n      }\n\n      // Extract brand names directly from HTML (look for common brand name patterns)\n      // Match capitalized words that look like brand names\n      const brandNamePattern =\n        /\\b([A-Z][A-Z0-9\\s&-]+(?:DJ|SYSTEMS|AMPLIFICATION|AUDIO|SOUND|WORKS|BEYOND|TEKNIK)?)\\b/g;\n      const potentialBrands = [...content.rawHtml.matchAll(brandNamePattern)]\n        .map(m => m[1].trim())\n        .filter(b => {\n          const len = b.length;\n          return (\n            len > 2 &&\n            len < 50 &&\n            !b.match(\n              /^(HTML|HEAD|BODY|DIV|SPAN|SECTION|NAV|HEADER|FOOTER|SCRIPT|STYLE|META|LINK)$/i\n            ) &&\n            !b.match(/^\\d+$/) && // Not just numbers\n            b.split(/\\s+/).length <= 4\n          ); // Not too many words\n        })\n        .slice(0, 50); // Limit to 50 potential brands\n\n      if (potentialBrands.length > 0) {\n        textContent += `\\n=== POTENTIAL BRAND NAMES FOUND IN HTML ===\\n${potentialBrands.join(', ')}\\n=== END POTENTIAL BRANDS ===\\n\\n`;\n      }\n    }\n\n    if (content.content) {\n      // Use cleaned content if available\n      textContent += `Content:\\n${content.content.substring(0, 6000)}\\n`;\n    } else if (content.rawHtml) {\n      // Extract text from HTML if needed\n      const textFromHtml = this.extractTextFromHtml(content.rawHtml);\n      textContent += `Content:\\n${textFromHtml.substring(0, 6000)}\\n`;\n    }\n\n    return textContent;\n  }\n\n  /**\n   * Extract text from HTML (simple implementation)\n   */\n  private extractTextFromHtml(html: string): string {\n    // Remove script and style tags\n    let text = html.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '');\n    text = text.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '');\n\n    // Remove HTML tags\n    text = text.replace(/<[^>]+>/g, ' ');\n\n    // Decode HTML entities\n    text = this.decodeHtmlEntities(text);\n\n    // Clean up whitespace\n    text = text.replace(/\\s+/g, ' ').trim();\n\n    return text;\n  }\n\n  /**\n   * Extract company name from title\n   */\n  private extractCompanyName(title: string): string {\n    // Remove common suffixes and prefixes\n    const cleaned = title\n      .replace(/\\s*[-–—]\\s*.+$/, '') // Remove everything after dash\n      .replace(/\\s*\\(.*?\\)\\s*/g, '') // Remove parentheses\n      .replace(/\\s*\\|.*$/, '') // Remove everything after pipe\n      .trim();\n\n    return cleaned || title;\n  }\n\n  /**\n   * Decode HTML entities\n   */\n  private decodeHtmlEntities(text: string): string {\n    return text\n      .replace(/&amp;/g, '&')\n      .replace(/&lt;/g, '<')\n      .replace(/&gt;/g, '>')\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\")\n      .replace(/&nbsp;/g, ' ')\n      .replace(/&#(\\d+);/g, (_, dec) => String.fromCharCode(parseInt(dec, 10)))\n      .trim();\n  }\n}\n\n// Export singleton instance (uses env vars)\nexport const aiDataExtractionService = new AIDataExtractionService();\n\n// Factory function to create instance with config\nexport function createAIDataExtractionService(config?: {\n  anthropicApiKey?: string;\n  anthropicBaseUrl?: string;\n  openaiApiKey?: string;\n  openaiBaseUrl?: string;\n  openaiModel?: string;\n}): AIDataExtractionService {\n  return new AIDataExtractionService(config);\n}\n","usedDeprecatedRules":[]},{"filePath":"K:\\00Project\\MantisNXT\\src\\types\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":252,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":252,"endColumn":34,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[6079,6133],"text":"type RegisterFormData = RegistrationData"},"desc":"Replace empty interface with a type alias."}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":268,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":268,"endColumn":36,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[6385,6439],"text":"type CreateUserFormData = CreateUserData"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Authentication and User Management Types\r\n\r\nexport interface User {\r\n  id: string;\r\n  email: string;\r\n  name: string;\r\n  role: 'super_admin' | 'admin' | 'manager' | 'user' | 'viewer';\r\n  org_id: string;\r\n  department: string;\r\n  permissions: Permission[];\r\n  created_at: Date;\r\n  last_login: Date;\r\n  is_active: boolean;\r\n  profile_image?: string;\r\n  // South African specific fields\r\n  id_number?: string;\r\n  employment_equity?: 'african' | 'coloured' | 'indian' | 'white' | 'other';\r\n  bee_status?: BeeStatus;\r\n  phone: string;\r\n  mobile?: string;\r\n  address?: Address;\r\n  preferences: UserPreferences;\r\n  two_factor_enabled: boolean;\r\n  email_verified: boolean;\r\n  password_changed_at: Date;\r\n}\r\n\r\nexport interface Permission {\r\n  id: string;\r\n  name: string;\r\n  resource: string;\r\n  action: 'create' | 'read' | 'update' | 'delete' | 'manage';\r\n  conditions?: PermissionCondition[];\r\n}\r\n\r\nexport interface PermissionCondition {\r\n  field: string;\r\n  operator: 'equals' | 'in' | 'contains' | 'starts_with';\r\n  value: any;\r\n}\r\n\r\nexport interface Organization {\r\n  id: string;\r\n  name: string;\r\n  code?: string;\r\n  legal_name?: string;\r\n  registration_number?: string;\r\n  registrationNumber?: string;\r\n  vat_number?: string;\r\n  vatNumber?: string;\r\n  bee_level?: number;\r\n  beeLevel?: string;\r\n  website?: string;\r\n  status?: string;\r\n  province?: SouthAfricanProvince;\r\n  industry?: string;\r\n  created_at?: Date;\r\n  createdAt: Date;\r\n  updatedAt?: Date;\r\n  is_active?: boolean;\r\n  contact_email?: string;\r\n  email?: string;\r\n  phone?: string;\r\n  phoneNumber?: string;\r\n  address: Address;\r\n  logo_url?: string;\r\n  settings?: OrganizationSettings;\r\n  timezone?: string;\r\n  vatRate?: number;\r\n}\r\n\r\nexport interface Address {\r\n  street?: string;\r\n  street1?: string;\r\n  street2?: string;\r\n  suburb: string;\r\n  city: string;\r\n  province: SouthAfricanProvince;\r\n  postal_code?: string;\r\n  postalCode?: string;\r\n  country?: string;\r\n}\r\n\r\nexport interface UserPreferences {\r\n  language: 'en' | 'af' | 'zu' | 'xh';\r\n  timezone: string;\r\n  date_format: 'dd/mm/yyyy' | 'mm/dd/yyyy' | 'yyyy-mm-dd';\r\n  currency: 'ZAR' | 'USD' | 'EUR' | 'GBP';\r\n  notifications: NotificationPreferences;\r\n}\r\n\r\nexport interface NotificationPreferences {\r\n  email_notifications: boolean;\r\n  sms_notifications: boolean;\r\n  push_notifications: boolean;\r\n  digest_frequency: 'daily' | 'weekly' | 'monthly' | 'never';\r\n}\r\n\r\nexport interface OrganizationSettings {\r\n  allow_self_registration: boolean;\r\n  require_email_verification: boolean;\r\n  enforce_two_factor: boolean;\r\n  password_policy: PasswordPolicy;\r\n  session_timeout: number;\r\n  allowed_domains: string[];\r\n}\r\n\r\nexport interface PasswordPolicy {\r\n  min_length: number;\r\n  require_uppercase: boolean;\r\n  require_lowercase: boolean;\r\n  require_numbers: boolean;\r\n  require_symbols: boolean;\r\n  expires_days?: number;\r\n}\r\n\r\nexport type SouthAfricanProvince =\r\n  | 'eastern_cape'\r\n  | 'free_state'\r\n  | 'gauteng'\r\n  | 'kwazulu_natal'\r\n  | 'limpopo'\r\n  | 'mpumalanga'\r\n  | 'northern_cape'\r\n  | 'north_west'\r\n  | 'western_cape';\r\n\r\nexport type BeeStatus =\r\n  | 'level_1'\r\n  | 'level_2'\r\n  | 'level_3'\r\n  | 'level_4'\r\n  | 'level_5'\r\n  | 'level_6'\r\n  | 'level_7'\r\n  | 'level_8'\r\n  | 'non_compliant';\r\n\r\n// Authentication Provider Interface\r\nexport interface AuthProvider {\r\n  // Core authentication methods\r\n  login(credentials: LoginCredentials): Promise<AuthResult>;\r\n  logout(): Promise<void>;\r\n  register(data: RegistrationData): Promise<AuthResult>;\r\n  resetPassword(email: string): Promise<void>;\r\n  verifyEmail(token: string): Promise<boolean>;\r\n\r\n  // Two-factor authentication\r\n  setupTwoFactor(): Promise<TwoFactorSetup>;\r\n  verifyTwoFactor(token: string, code: string): Promise<boolean>;\r\n  disableTwoFactor(password: string): Promise<boolean>;\r\n\r\n  // Session management\r\n  getCurrentUser(): Promise<User | null>;\r\n  refreshToken(): Promise<string>;\r\n  changePassword(oldPassword: string, newPassword: string): Promise<void>;\r\n  updateProfile(data: Partial<User>): Promise<User>;\r\n\r\n  // Administrative methods\r\n  createUser(data: CreateUserData): Promise<User>;\r\n  updateUser(id: string, data: Partial<User>): Promise<User>;\r\n  deleteUser(id: string): Promise<void>;\r\n  getUsersByOrganization(orgId: string): Promise<User[]>;\r\n  bulkImportUsers(csvData: string): Promise<BulkImportResult>;\r\n}\r\n\r\nexport interface LoginCredentials {\r\n  email: string;\r\n  password: string;\r\n  remember_me?: boolean;\r\n  two_factor_code?: string;\r\n}\r\n\r\nexport interface RegistrationData {\r\n  // Organization details\r\n  organization_name: string;\r\n  organization_legal_name: string;\r\n  registration_number: string;\r\n  vat_number?: string;\r\n  bee_level: number;\r\n  province: SouthAfricanProvince;\r\n  industry: string;\r\n\r\n  // Admin user details\r\n  name: string;\r\n  email: string;\r\n  password: string;\r\n  confirm_password: string;\r\n  phone: string;\r\n  id_number?: string;\r\n\r\n  // Address\r\n  address: Address;\r\n\r\n  // Legal agreements\r\n  terms_accepted: boolean;\r\n  privacy_accepted: boolean;\r\n  marketing_consent: boolean;\r\n}\r\n\r\nexport interface CreateUserData {\r\n  name: string;\r\n  email: string;\r\n  role: User['role'];\r\n  department: string;\r\n  phone: string;\r\n  password?: string;\r\n  send_invitation?: boolean;\r\n  permissions?: string[];\r\n  id_number?: string;\r\n  employment_equity?: User['employment_equity'];\r\n}\r\n\r\nexport interface AuthResult {\r\n  success: boolean;\r\n  user?: User;\r\n  token?: string;\r\n  refresh_token?: string;\r\n  requires_two_factor?: boolean;\r\n  two_factor_token?: string;\r\n  message?: string;\r\n  errors?: string[];\r\n}\r\n\r\nexport interface TwoFactorSetup {\r\n  secret: string;\r\n  qr_code: string;\r\n  backup_codes: string[];\r\n}\r\n\r\nexport interface BulkImportResult {\r\n  total_processed: number;\r\n  successful_imports: number;\r\n  failed_imports: number;\r\n  errors: BulkImportError[];\r\n  created_users: User[];\r\n}\r\n\r\nexport interface BulkImportError {\r\n  row: number;\r\n  email?: string;\r\n  errors: string[];\r\n}\r\n\r\n// Form validation types\r\nexport interface LoginFormData {\r\n  email: string;\r\n  password: string;\r\n  remember_me: boolean;\r\n}\r\n\r\nexport interface RegisterFormData extends RegistrationData {}\r\n\r\nexport interface ForgotPasswordFormData {\r\n  email: string;\r\n}\r\n\r\nexport interface ResetPasswordFormData {\r\n  token: string;\r\n  password: string;\r\n  confirm_password: string;\r\n}\r\n\r\nexport interface TwoFactorFormData {\r\n  code: string;\r\n}\r\n\r\nexport interface CreateUserFormData extends CreateUserData {}\r\n\r\nexport interface UpdateUserFormData {\r\n  name: string;\r\n  email: string;\r\n  role: User['role'];\r\n  department: string;\r\n  phone: string;\r\n  is_active: boolean;\r\n  permissions: string[];\r\n  id_number?: string;\r\n  employment_equity?: User['employment_equity'];\r\n}\r\n\r\nexport interface ChangePasswordFormData {\r\n  current_password: string;\r\n  new_password: string;\r\n  confirm_password: string;\r\n}\r\n\r\nexport interface UserFilters {\r\n  search?: string;\r\n  role?: User['role'];\r\n  department?: string;\r\n  is_active?: boolean;\r\n  created_after?: Date;\r\n  created_before?: Date;\r\n}\r\n\r\nexport interface UserTableSort {\r\n  field: keyof User;\r\n  direction: 'asc' | 'desc';\r\n}\r\n\r\n// Constants\r\nexport const SOUTH_AFRICAN_PROVINCES = [\r\n  { value: 'eastern_cape', label: 'Eastern Cape' },\r\n  { value: 'free_state', label: 'Free State' },\r\n  { value: 'gauteng', label: 'Gauteng' },\r\n  { value: 'kwazulu_natal', label: 'KwaZulu-Natal' },\r\n  { value: 'limpopo', label: 'Limpopo' },\r\n  { value: 'mpumalanga', label: 'Mpumalanga' },\r\n  { value: 'northern_cape', label: 'Northern Cape' },\r\n  { value: 'north_west', label: 'North West' },\r\n  { value: 'western_cape', label: 'Western Cape' },\r\n] as const;\r\n\r\nexport const BEE_LEVELS = [\r\n  { value: 'level_1', label: 'Level 1', points: '≥100' },\r\n  { value: 'level_2', label: 'Level 2', points: '95-99' },\r\n  { value: 'level_3', label: 'Level 3', points: '90-94' },\r\n  { value: 'level_4', label: 'Level 4', points: '80-89' },\r\n  { value: 'level_5', label: 'Level 5', points: '75-79' },\r\n  { value: 'level_6', label: 'Level 6', points: '70-74' },\r\n  { value: 'level_7', label: 'Level 7', points: '55-69' },\r\n  { value: 'level_8', label: 'Level 8', points: '40-54' },\r\n  { value: 'non_compliant', label: 'Non-Compliant', points: '<40' },\r\n] as const;\r\n\r\nexport const USER_ROLES = [\r\n  {\r\n    value: 'super_admin',\r\n    label: 'Super Administrator',\r\n    description: 'Full system access across all organizations',\r\n  },\r\n  { value: 'admin', label: 'Administrator', description: 'Full access within organization' },\r\n  { value: 'manager', label: 'Manager', description: 'Manage team and department resources' },\r\n  { value: 'user', label: 'User', description: 'Standard user access' },\r\n  { value: 'viewer', label: 'Viewer', description: 'Read-only access' },\r\n] as const;\r\n\r\nexport const EMPLOYMENT_EQUITY_OPTIONS = [\r\n  { value: 'african', label: 'African' },\r\n  { value: 'coloured', label: 'Coloured' },\r\n  { value: 'indian', label: 'Indian' },\r\n  { value: 'white', label: 'White' },\r\n  { value: 'other', label: 'Other' },\r\n] as const;\r\n","usedDeprecatedRules":[]}]
